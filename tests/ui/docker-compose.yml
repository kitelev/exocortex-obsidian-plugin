version: '3.8'

services:
  obsidian-test:
    build:
      context: ../..
      dockerfile: tests/ui/Dockerfile
    volumes:
      # Mount the built plugin
      - ../../main.js:/test-vault/.obsidian/plugins/exocortex/main.js:ro
      - ../../manifest.json:/test-vault/.obsidian/plugins/exocortex/manifest.json:ro
      - ../../styles.css:/test-vault/.obsidian/plugins/exocortex/styles.css:ro
      # Mount test specs
      - ./specs:/app/tests/ui/specs:ro
      - ./pageobjects:/app/tests/ui/pageobjects:ro
      # Mount wdio config
      - ./wdio.conf.ts:/app/tests/ui/wdio.conf.ts:ro
      # Output directory for screenshots and reports
      - ./test-results:/app/test-results
    environment:
      - DISPLAY=:99
      - NODE_ENV=test
      - HEADLESS=true
    command: >
      sh -c "
        echo '=== Starting Docker UI Test ===' &&
        echo 'Setting up display...' &&
        Xvfb :99 -screen 0 1920x1080x24 &
        sleep 2 &&
        echo 'Starting Obsidian...' &&
        cd /test-vault &&
        obsidian . &
        OBSIDIAN_PID=$$! &&
        sleep 5 &&
        echo 'Obsidian started, waiting for it to fully load...' &&
        sleep 10 &&
        echo 'Running WebdriverIO tests...' &&
        cd /app &&
        npm run wdio -- --spec create-asset-modal-real.spec.ts &&
        TEST_RESULT=$$? &&
        echo 'Test completed with exit code:' $$TEST_RESULT &&
        kill $$OBSIDIAN_PID 2>/dev/null || true &&
        exit $$TEST_RESULT
      "
    networks:
      - test-network

networks:
  test-network:
    driver: bridge