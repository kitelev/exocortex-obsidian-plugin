/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var ft=Object.defineProperty;var Sr=Object.getOwnPropertyDescriptor;var Br=Object.getOwnPropertyNames;var Lr=Object.prototype.hasOwnProperty;var f=(d,e)=>()=>(d&&(e=d(d=0)),e);var Lt=(d,e)=>{for(var t in e)ft(d,t,{get:e[t],enumerable:!0})},Dr=(d,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of Br(e))!Lr.call(d,s)&&s!==t&&ft(d,s,{get:()=>e[s],enumerable:!(r=Sr(e,s))||r.enumerable});return d};var Vr=d=>Dr(ft({},"__esModule",{value:!0}),d);var B,Dt=f(()=>{B=class{constructor(){this.services=new Map;this.factories=new Map}static getInstance(){return B.instance||(B.instance=new B),B.instance}register(e,t){this.factories.set(e,t)}registerSingleton(e,t){this.services.set(e,t)}resolve(e){if(this.services.has(e))return this.services.get(e);if(this.factories.has(e)){let t=this.factories.get(e);if(t)return t()}throw new Error(`Service not found: ${e}`)}has(e){return this.services.has(e)||this.factories.has(e)}clear(){this.services.clear(),this.factories.clear()}static reset(){B.instance&&(B.instance.clear(),B.instance=null)}}});var xe,Se,Vt=f(()=>{xe=require("obsidian"),Se=class{showNotice(e,t){new xe.Notice(e,t)}showError(e,t){new xe.Notice(`Error: ${e}`,t||5e3)}showSuccess(e,t){new xe.Notice(`\u2713 ${e}`,t)}showWarning(e,t){new xe.Notice(`\u26A0 ${e}`,t||4e3)}}});var n,x=f(()=>{n=class{constructor(e,t,r){if(e&&t)throw new Error("InvalidOperation: A result cannot be successful and contain an error");if(!e&&!t)throw new Error("InvalidOperation: A failing result needs to contain an error message");this.isSuccess=e,this.isFailure=!e,this.error=t,this.e=r,Object.freeze(this)}getValue(){if(!this.isSuccess)throw new Error("Can't get the value of an error result. Use 'errorValue' instead.");return this.e}errorValue(){return this.error}getErrorMessage(){return this.error}getError(){return this.error}static ok(e){return new n(!0,void 0,e)}static fail(e){return new n(!1,e)}static combine(e){for(let t of e)if(t.isFailure)return t;return n.ok()}}});var Be,Le,Mt=f(()=>{Be=require("obsidian");x();Le=class{constructor(e){this.app=e}async readFile(e){try{let t=this.app.vault.getAbstractFileByPath(e);if(!t||!(t instanceof Be.TFile))return n.fail(`File not found: ${e}`);let r=await this.app.vault.read(t);return n.ok(r)}catch(t){return n.fail(`Failed to read file ${e}: ${t.message}`)}}async writeFile(e,t){try{let r=this.app.vault.getAbstractFileByPath(e);return r instanceof Be.TFile?await this.app.vault.modify(r,t):await this.app.vault.create(e,t),n.ok(void 0)}catch(r){return n.fail(`Failed to write file ${e}: ${r.message}`)}}async fileExists(e){return this.app.vault.getAbstractFileByPath(e)instanceof Be.TFile}async listFiles(e,t){try{let r=this.app.vault.getFiles();return e&&(r=r.filter(s=>s.path.startsWith(e))),t&&(r=r.filter(s=>s.extension===t)),n.ok(r)}catch(r){return n.fail(`Failed to list files: ${r.message}`)}}generateFileName(e,t){let r=new Date().toISOString().replace(/[:.]/g,"-"),s=e||`export-${r}`;return t?`${s}.${t}`:s}detectFormatFromExtension(e){var s;let t=(s=e.split(".").pop())==null?void 0:s.toLowerCase();return{ttl:"turtle",nt:"n-triples",jsonld:"json-ld",rdf:"rdf-xml",xml:"rdf-xml"}[t||""]||"turtle"}async ensureDirectory(e){try{return await this.app.vault.adapter.exists(e)||await this.app.vault.adapter.mkdir(e),n.ok(void 0)}catch(t){return n.fail(`Failed to create directory ${e}: ${t.message}`)}}}});var oe,gt=f(()=>{oe=class{constructor(e){this.app=e}getDisplayLabel(e){var r;let t=(r=this.app.metadataCache.getFileCache(e))==null?void 0:r.frontmatter;return(t==null?void 0:t.exo__Asset_title)||(t==null?void 0:t.title)||e.basename}extractFrontmatterData(e,t){var s;let r=this.app.metadataCache.getFileCache(e);return(s=r==null?void 0:r.frontmatter)==null?void 0:s[t]}createInternalLink(e,t,r){e.createEl("a",{text:t,cls:"internal-link",href:"#"}).addEventListener("click",i=>{i.preventDefault(),this.app.workspace.openLinkText(r,"",!1)})}createElement(e,t,r){return e.createEl(t,{cls:r==null?void 0:r.cls,text:r==null?void 0:r.text,attr:r==null?void 0:r.attrs})}cleanClassName(e){if(!e)return"";let t=String(e);return t.includes("#")&&(t=t.split("#").pop()||t),t=t.replace(/_/g," "),t=t.replace(/\b\w/g,r=>r.toUpperCase()),t}groupFilesByClass(e){let t=new Map;return e.forEach(r=>{let s=this.extractFrontmatterData(r,"exo__Instance_class")||"Unclassified",i=this.cleanClassName(s);t.has(i)||t.set(i,[]),t.get(i).push(r)}),t}filterFilesByClass(e,t){return t?e.filter(r=>{let s=this.extractFrontmatterData(r,"exo__Instance_class");return this.cleanClassName(s)===t}):e}applyResultLimit(e,t){return t?e.slice(0,t):e}}});var Ce,ae,ht=f(()=>{Ce=require("obsidian"),ae=class{constructor(e,t){this.vault=e;this.metadataCache=t}async create(e,t){await this.vault.create(e,t)}async read(e){let t=this.vault.getAbstractFileByPath(e);if(!t||!(t instanceof Ce.TFile))throw new Error(`File not found: ${e}`);return await this.vault.read(t)}async update(e,t){let r=this.vault.getAbstractFileByPath(e);if(!r||!(r instanceof Ce.TFile))throw new Error(`File not found: ${e}`);await this.vault.modify(r,t)}async delete(e){let t=this.vault.getAbstractFileByPath(e);if(!t)throw new Error(`File not found: ${e}`);await this.vault.delete(t)}async exists(e){return this.vault.getAbstractFileByPath(e)!==null}async list(e){let t=this.vault.getFiles();if(!e)return t.map(s=>s.path);let r=new RegExp(e);return t.filter(s=>r.test(s.path)).map(s=>s.path)}async getMetadata(e){let t=this.vault.getAbstractFileByPath(e);if(!t||!(t instanceof Ce.TFile))return null;let r=this.metadataCache.getFileCache(t);return(r==null?void 0:r.frontmatter)||null}async getFiles(){return this.vault.getFiles()}async getFileMetadata(e){return e instanceof Ce.TFile&&this.metadataCache.getFileCache(e)||null}}});var y,U=f(()=>{x();y=class{constructor(e){this.value=e}static create(e){return!e||e.trim().length===0?n.fail("AssetId cannot be empty"):/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e.trim())?n.ok(new y(e.trim())):n.fail("AssetId must be a valid UUID format")}static generate(){let e="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{let r=Math.random()*16|0;return(t==="x"?r:r&3|8).toString(16)});return new y(e)}toString(){return this.value}equals(e){return!e||!(e instanceof y)?!1:this.value===e.value}getValue(){return this.value}isValid(){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(this.value)}}});var b,G=f(()=>{x();b=class{constructor(e){this.value=e}static create(e){if(!e||e.trim().length===0)return n.fail("ClassName cannot be empty");let t=e.replace(/\[\[|\]\]/g,"");return/^[a-zA-Z_][a-zA-Z0-9_]*(?:__[a-zA-Z][a-zA-Z0-9_]*)?$/.test(t)?n.ok(new b(t)):n.fail(`Invalid class name format: ${e}`)}toString(){return this.value}toWikiLink(){return`[[${this.value}]]`}getPrefix(){let e=this.value.split("__");return e.length>1?e[0]:""}getName(){let e=this.value.split("__");return e.length>1?e[1]:e[0]}equals(e){return this.value===e.value}}});var I,be=f(()=>{x();I=class{constructor(e){this.value=e}static create(e){return!e||e.trim().length===0?n.fail("OntologyPrefix cannot be empty"):/^[a-z][a-z0-9]*$/.test(e)?n.ok(new I(e)):n.fail(`Invalid ontology prefix format: ${e}. Must be lowercase alphanumeric starting with a letter`)}toString(){return this.value}toFileName(){return`!${this.value}`}equals(e){return this.value===e.value}}});var T,Nt=f(()=>{x();T=class{constructor(e,t,r={}){this.e=e,this.t=t,this.a=r}static create(e,t={}){if(e==null)return n.fail("Property value cannot be null or undefined");let r=T.detectType(e),s=T.validateValue(e,r,t);return s.isValid?n.ok(new T(e,r,t)):n.fail(s.error)}static createTyped(e,t,r={}){let s=T.validateValue(e,t,r);if(!s.isValid)return n.fail(s.error);let i=T.convertValue(e,t);return n.ok(new T(i,t,r))}static detectType(e){return typeof e=="string"?/^\[\[.*\]\]$/.test(e)?"reference":/^https?:\/\/|^[a-z][a-z0-9+.-]*:/i.test(e)?"iri":/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(e)?"date":"string":typeof e=="number"?"number":typeof e=="boolean"?"boolean":e instanceof Date?"date":Array.isArray(e)?"array":"object"}static convertValue(e,t){switch(t){case"string":return String(e);case"number":return Number(e);case"boolean":return Boolean(e);case"date":return e instanceof Date?e:new Date(e);case"array":return Array.isArray(e)?[...e]:[e];case"reference":case"iri":return String(e);default:return e}}static validateValue(e,t,r){switch(t){case"string":case"reference":case"iri":if(typeof e!="string")return{isValid:!1,error:`Expected string, got ${typeof e}`};if(r.minLength&&e.length<r.minLength)return{isValid:!1,error:`String too short, minimum ${r.minLength}`};if(r.maxLength&&e.length>r.maxLength)return{isValid:!1,error:`String too long, maximum ${r.maxLength}`};if(r.pattern&&!r.pattern.test(e))return{isValid:!1,error:"String does not match required pattern"};break;case"number":{let s=Number(e);if(isNaN(s))return{isValid:!1,error:"Invalid number"};if(r.min!==void 0&&s<r.min)return{isValid:!1,error:`Number too small, minimum ${r.min}`};if(r.max!==void 0&&s>r.max)return{isValid:!1,error:`Number too large, maximum ${r.max}`};break}case"date":{let s=e instanceof Date?e:new Date(e);if(isNaN(s.getTime()))return{isValid:!1,error:"Invalid date"};break}case"array":if(!Array.isArray(e))return{isValid:!1,error:"Expected array"};if(r.minItems&&e.length<r.minItems)return{isValid:!1,error:`Array too short, minimum ${r.minItems} items`};if(r.maxItems&&e.length>r.maxItems)return{isValid:!1,error:`Array too long, maximum ${r.maxItems} items`};break}return{isValid:!0,error:""}}getValue(){return this.t==="array"?[...this.e]:this.t==="object"?{...this.e}:this.e}getType(){return this.t}getConstraints(){return{...this.a}}isReference(){return this.t==="reference"}isIRI(){return this.t==="iri"}getReferenceTarget(){if(!this.isReference())return null;let e=this.e.match(/^\[\[(.*?)\]\]$/);return e?e[1]:null}toString(){return this.t==="date"&&this.e instanceof Date?this.e.toISOString().replace(/\.\d{3}Z$/,""):String(this.e)}equals(e){return this.t!==e.t?!1:this.t==="array"||this.t==="object"?JSON.stringify(this.e)===JSON.stringify(e.e):this.e===e.e}withConstraints(e){return T.createTyped(this.e,this.t,{...this.a,...e})}}});var P,X=f(()=>{P=class{constructor(e,t){this.i=[];this.r=t!=null?t:this.generateId(),this.props=e}generateId(){return Math.random().toString(36).substring(2,15)}get id(){return this.r}equals(e){return e==null?!1:this===e?!0:!this.isEntity(e)||e.constructor!==this.constructor?!1:this.r===e.r}isEntity(e){return e instanceof P}addDomainEvent(e){this.i.push(e)}createDomainEvent(e,t={}){return{eventType:e,aggregateId:this.r.toString(),occurredOn:new Date,eventData:t}}clearEvents(){this.i=[]}get domainEvents(){return[...this.i]}getDomainEvents(){return this.i}clearDomainEvents(){this.i=[]}validate(){}isValid(){try{return this.validate(),!0}catch(e){return!1}}}});var A,De=f(()=>{U();G();be();Nt();X();x();A=class extends P{constructor(e,t){super(e,e.id.toString())}generateId(){return this.props.id.toString()}validate(){if(!this.props.id)throw new Error("Asset must have a valid ID");if(!this.props.title||this.props.title.trim().length===0)throw new Error("Asset must have a non-empty title");if(this.props.title.length>200)throw new Error("Asset title cannot exceed 200 characters");if(!this.props.className)throw new Error("Asset must have a valid class name");if(!this.props.ontology)throw new Error("Asset must belong to a valid ontology");for(let[e,t]of this.props.properties)if(!(t instanceof T))throw new Error(`Property '${e}' must be a PropertyValue instance`)}static create(e){var s;if(!e.label||e.label.trim().length===0)return n.fail("Asset label cannot be empty");if(e.label.length>200)return n.fail("Asset label cannot exceed 200 characters");let t=new Map;if(e.properties)for(let[i,o]of Object.entries(e.properties)){let a=T.create(o);if(!a.isSuccess)return n.fail(`Invalid property '${i}': ${a.getError()}`);t.set(i,a.getValue())}let r={id:e.id,title:e.label.trim(),className:e.className,ontology:e.ontology,label:e.label.trim(),description:(s=e.description)==null?void 0:s.trim(),properties:t,createdAt:new Date,updatedAt:new Date,version:1};try{let i=new A(r);return i.validate(),i.addDomainEvent(i.createDomainEvent("AssetCreated",{assetId:e.id.toString(),className:e.className.toString(),ontology:e.ontology.toString()})),n.ok(i)}catch(i){return n.fail(`Asset creation failed: ${i}`)}}getId(){return this.props.id}getTitle(){return this.props.title}getClassName(){return this.props.className}getOntologyPrefix(){return this.props.ontology}getProperties(){return new Map(this.props.properties)}getProperty(e){return this.props.properties.get(e)}getPropertyValue(e){let t=this.props.properties.get(e);return t?t.getValue():void 0}hasProperty(e){return this.props.properties.has(e)}getVersion(){return this.props.version}getCreatedAt(){return this.props.createdAt}getUpdatedAt(){return this.props.updatedAt}updateTitle(e){if(!e||e.trim().length===0)return n.fail("Asset title cannot be empty");if(e.length>200)return n.fail("Asset title cannot exceed 200 characters");let t=this.props.title;return this.props.title=e.trim(),this.props.label=e.trim(),this.props.updatedAt=new Date,this.props.version+=1,this.addDomainEvent(this.createDomainEvent("AssetTitleUpdated",{assetId:this.props.id.toString(),oldTitle:t,newTitle:e.trim()})),n.ok()}setProperty(e,t){if(!e||e.trim().length===0)return n.fail("Property key cannot be empty");let r=T.create(t);if(!r.isSuccess)return n.fail(`Invalid property value: ${r.getError()}`);let s=this.props.properties.get(e);return this.props.properties.set(e,r.getValue()),this.props.updatedAt=new Date,this.props.version+=1,this.addDomainEvent(this.createDomainEvent("AssetPropertyUpdated",{assetId:this.props.id.toString(),propertyKey:e,oldValue:s==null?void 0:s.getValue(),newValue:t})),n.ok()}removeProperty(e){if(!this.props.properties.has(e))return n.fail(`Property '${e}' does not exist`);let t=this.props.properties.get(e);return this.props.properties.delete(e),this.props.updatedAt=new Date,this.props.version+=1,this.addDomainEvent(this.createDomainEvent("AssetPropertyRemoved",{assetId:this.props.id.toString(),propertyKey:e,removedValue:t==null?void 0:t.getValue()})),n.ok()}changeClass(e){if(!e)return n.fail("Class name cannot be null");let t=this.props.className;return this.props.className=e,this.props.updatedAt=new Date,this.props.version+=1,this.addDomainEvent(this.createDomainEvent("AssetClassChanged",{assetId:this.props.id.toString(),oldClassName:t.toString(),newClassName:e.toString()})),n.ok()}updateDescription(e){if(e&&e.length>2e3)return n.fail("Description cannot exceed 2000 characters");let t=this.props.description;return this.props.description=e==null?void 0:e.trim(),this.props.updatedAt=new Date,this.props.version+=1,this.addDomainEvent(this.createDomainEvent("AssetDescriptionUpdated",{assetId:this.props.id.toString(),oldDescription:t,newDescription:e==null?void 0:e.trim()})),n.ok()}updateProperties(e){let t=new Map;for(let[r,s]of Object.entries(e)){if(!r||r.trim().length===0)return n.fail("Property key cannot be empty");let i=T.create(s);if(!i.isSuccess)return n.fail(`Invalid property '${r}': ${i.getError()}`);t.set(r,i.getValue())}for(let[r,s]of t)this.props.properties.set(r,s);return this.props.updatedAt=new Date,this.props.version+=1,this.addDomainEvent(this.createDomainEvent("AssetPropertiesUpdated",{assetId:this.props.id.toString(),updatedProperties:Object.keys(e),changeCount:t.size})),n.ok()}canDelete(){let e=[];return{canDelete:e.length===0,reasons:e}}markAsDeleted(){let e=this.canDelete();return e.canDelete?(this.addDomainEvent(this.createDomainEvent("AssetDeleted",{assetId:this.props.id.toString(),className:this.props.className.toString(),title:this.props.title})),n.ok()):n.fail(`Cannot delete asset: ${e.reasons.join(", ")}`)}toFrontmatter(){let e={exo__Asset_uid:this.props.id.toString(),exo__Asset_label:this.props.title,exo__Asset_isDefinedBy:`[[!${this.props.ontology.toString()}]]`,exo__Asset_createdAt:this.props.createdAt.toISOString().replace(/\.\d{3}Z$/,""),exo__Asset_updatedAt:this.props.updatedAt.toISOString().replace(/\.\d{3}Z$/,""),exo__Asset_version:this.props.version,exo__Instance_class:[this.props.className.toWikiLink()]};this.props.description&&(e.exo__Asset_description=this.props.description);for(let[t,r]of this.props.properties)e[t]||(e[t]=r.getValue());return e}static validateMandatoryProperties(e){let t=[],r=e.exo__Asset_uid;r?/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(r.toString())||t.push("exo__Asset_uid must be a valid UUID format"):t.push("Missing mandatory field: exo__Asset_uid");let s=e.exo__Asset_isDefinedBy;s?/^\[\[(!?[a-zA-Z][a-zA-Z0-9_\- ]*)\]\]$/.test(s.toString())||t.push("exo__Asset_isDefinedBy must be in format [[Ontology Name]] or [[!prefix]]"):t.push("Missing mandatory field: exo__Asset_isDefinedBy");let i=e.exo__Asset_createdAt;return i?/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{3})?(Z|[+-]\d{2}:\d{2})?$/.test(i.toString())||t.push("exo__Asset_createdAt must be in ISO timestamp format (YYYY-MM-DDTHH:mm:ss)"):t.push("Missing mandatory field: exo__Asset_createdAt"),{isValid:t.length===0,errors:t}}static fromFrontmatter(e,t){var s;if(!A.validateMandatoryProperties(e).isValid)return null;try{let i=y.create(e.exo__Asset_uid);if(!i.isSuccess)return null;let o=i.getValue(),a=e.exo__Asset_label||t.replace(".md",""),l=Array.isArray(e.exo__Instance_class)?e.exo__Instance_class[0]:e.exo__Instance_class,c=b.create(l||"exo__Asset"),u=c.isSuccess?c.getValue():b.create("exo__Asset").getValue(),p=((s=e.exo__Asset_isDefinedBy)==null?void 0:s.replace(/\[\[!?|\]\]/g,""))||"exo",m=I.create(p),g=m.isSuccess?m.getValue():I.create("exo").getValue(),h=new Date(e.exo__Asset_createdAt);if(isNaN(h.getTime()))return null;let V={};for(let[M,_e]of Object.entries(e))!M.startsWith("exo__Asset_")&&!M.startsWith("exo__Instance_")&&(V[M]=_e);let Ie=A.create({id:o,label:a,className:u,ontology:g,properties:V});if(Ie.isSuccess){let M=Ie.getValue();M.props.createdAt=h,M.props.version=e.exo__Asset_version||1;let _e=e.exo__Asset_updatedAt;if(_e){let Bt=new Date(_e);isNaN(Bt.getTime())||(M.props.updatedAt=Bt)}return M}return null}catch(i){return null}}}});var yt,H,$t=f(()=>{yt=require("obsidian"),H=class{static buildYamlFrontmatter(e){let t=["---"];for(let[r,s]of Object.entries(e))if(s!=null)if(Array.isArray(s)){t.push(`${r}:`);for(let i of s){let o=String(i);this.needsQuotes(o)?t.push(`  - "${this.escapeQuotes(o)}"`):t.push(`  - ${o}`)}}else if(typeof s=="object"&&s!==null)t.push(`${r}: ${JSON.stringify(s)}`);else if(typeof s=="boolean"||typeof s=="number")t.push(`${r}: ${s}`);else{let i=String(s);this.needsQuotes(i)?t.push(`${r}: "${this.escapeQuotes(i)}"`):t.push(`${r}: ${i}`)}return t.push("---"),t}static needsQuotes(e){return e.includes("[[")&&e.includes("]]")||e.includes(":")||e.includes("#")||e.includes("[")||e.includes("]")||e.includes("{")||e.includes("}")||e.includes("|")||e.includes(">")||e.includes("@")||e.includes("`")||e.includes('"')||e.includes("'")||e.startsWith(" ")||e.endsWith(" ")}static escapeQuotes(e){return e.replace(/"/g,'\\"')}static extractBodyContent(e){if(e.startsWith(`---
`)){let t=e.indexOf(`
---
`,4);return t!==-1?e.substring(t+5):e}else return e}static findFileWithFallback(e,t){var r;if(t.storedPath){let s=e.vault.getAbstractFileByPath(t.storedPath);if(s instanceof yt.TFile)return s}if(t.uid){let s=e.vault.getMarkdownFiles();for(let i of s){let o=e.metadataCache.getFileCache(i);if(((r=o==null?void 0:o.frontmatter)==null?void 0:r.exo__Asset_uid)===t.uid)return i}}if(t.filename){let s=t.filename.endsWith(".md")?t.filename:`${t.filename}.md`,i=e.vault.getAbstractFileByPath(s);if(i instanceof yt.TFile)return i}return null}static async updateFileWithFrontmatter(e,t,r){let s=await e.vault.read(t),i=this.extractBodyContent(s),a=this.buildYamlFrontmatter(r).join(`
`)+`
`+i;await e.vault.modify(t,a)}static async createFileWithFrontmatter(e,t,r){let i=this.buildYamlFrontmatter(r).join(`
`)+`
`;await e.vault.create(t,i)}static getFilesWithProperty(e,t,r){return e.vault.getMarkdownFiles().filter(i=>{let o=e.metadataCache.getFileCache(i),a=o==null?void 0:o.frontmatter;return!a||!a[t]?!1:r===void 0?!0:a[t]===r})}static mergeFrontmatter(e,t){return{...e,...t}}static isReferencingAsset(e,t){return e?(Array.isArray(e)?e:[e]).some(s=>{if(!s)return!1;let i=String(s),o=i.replace(/\[\[|\]\]/g,"");return o===t||o===`${t}.md`||i.includes(`[[${t}]]`)||i.includes(t)}):!1}}});var Ve,L,Ot=f(()=>{Ve=require("obsidian"),L=class{static handleRepositoryError(e,t,r){let s=`${e} failed: ${t.message}`;new Ve.Notice(`Error: ${s}`,5e3)}static handleRenderingError(e,t,r,s){let i=`${e} rendering failed: ${t.message}`;r&&(r.empty(),r.createEl("div",{text:s||"Content could not be displayed",cls:"exocortex-error-fallback"})),new Ve.Notice(`Rendering error in ${e}`,3e3)}static handleValidationError(e,t,r){let s=r?`Invalid ${e}: "${t}". Expected format: ${r}`:`Invalid ${e}: "${t}"`;new Ve.Notice(s,4e3)}static async safeAsync(e,t,r){try{return await e()}catch(s){return r!==void 0?r:void 0}}static safeSync(e,t,r){try{return e()}catch(s){return r!==void 0?r:void 0}}static createError(e,t,r){let s=new Error(t);return s.code=e,s.context=r,s}static isErrorOfType(e,t){return(e==null?void 0:e.code)===t}static formatErrorForLogging(e,t){return{message:e.message,stack:e.stack,name:e.name,code:e.code,context:t,timestamp:new Date().toISOString()}}}});var Ut,Me,Ht=f(()=>{Ut=require("obsidian");$t();Ot();Me=class{constructor(e){this.app=e}findFileWithFallback(e){return H.findFileWithFallback(this.app,e)}getFilesWithProperty(e,t){return H.getFilesWithProperty(this.app,e,t)}async updateFileFrontmatter(e,t){try{await H.updateFileWithFrontmatter(this.app,e,t)}catch(r){throw L.handleRepositoryError("Update file frontmatter",r,{filePath:e.path,frontmatter:t}),r}}async createFileWithFrontmatter(e,t){try{await H.createFileWithFrontmatter(this.app,e,t)}catch(r){throw L.handleRepositoryError("Create file with frontmatter",r,{filename:e,frontmatter:t}),r}}async updateFrontmatterByPath(e,t){try{let r=this.app.vault.getAbstractFileByPath(e);if(!(r instanceof Ut.TFile))throw L.createError("FILE_NOT_FOUND",`File not found: ${e}`);let s=await this.app.vault.read(r),i=this.app.metadataCache.getFileCache(r),o=(i==null?void 0:i.frontmatter)||{},a=H.mergeFrontmatter(o,t);await this.updateFileFrontmatter(r,a)}catch(r){throw L.handleRepositoryError("Update frontmatter by path",r,{filePath:e,updates:t}),r}}extractEntityFromFrontmatter(e,t,r){try{let s=this.app.metadataCache.getFileCache(e);return s!=null&&s.frontmatter?t(s.frontmatter,e.basename):null}catch(s){return L.handleRepositoryError(`Extract ${r} from frontmatter`,s,{filePath:e.path}),null}}async saveEntityWithFrontmatter(e,t,r,s,i){try{let o=r(e),a=s(e);if(a)await this.updateFileFrontmatter(a,o);else{let l=`${t(e)}.md`;await this.createFileWithFrontmatter(l,o)}}catch(o){throw L.handleRepositoryError(`Save ${i}`,o,{entity:e}),o}}async deleteFileByEntity(e,t,r){try{let s=`${t(e)}.md`,i=this.app.vault.getAbstractFileByPath(s);i&&await this.app.vault.delete(i)}catch(s){throw L.handleRepositoryError(`Delete ${r}`,s,{entity:e}),s}}async entityExists(e,t,r){try{return await t(e)!==null}catch(s){return L.handleRepositoryError(`Check ${r} existence`,s,{entity:e}),!1}}async findAllEntities(e,t,r,s){try{let i=this.getFilesWithProperty(e),o=[];for(let a of i){if(s&&!s(a))continue;let l=this.extractEntityFromFrontmatter(a,t,r);l&&o.push(l)}return o}catch(i){return L.handleRepositoryError(`Find all ${r}s`,i,{propertyKey:e}),[]}}isReferencingAsset(e,t){return H.isReferencingAsset(e,t)}}});var zt,Ne,qt=f(()=>{zt=require("obsidian");De();Ht();Ne=class extends Me{constructor(e){super(e)}async findById(e){var r;let t=this.app.vault.getMarkdownFiles();for(let s of t){let i=this.app.metadataCache.getFileCache(s);if(((r=i==null?void 0:i.frontmatter)==null?void 0:r.exo__Asset_uid)===e.toString()){let o=A.fromFrontmatter(i.frontmatter,s.basename);if(o)return o}}return null}async findByClass(e){let t=this.app.vault.getMarkdownFiles(),r=[];for(let s of t){let i=this.app.metadataCache.getFileCache(s);if(i!=null&&i.frontmatter){let o=i.frontmatter.exo__Instance_class;if((Array.isArray(o)?o:[o]).some(l=>l===e.toWikiLink()||l===e.toString())){let l=A.fromFrontmatter(i.frontmatter,s.basename);l&&r.push(l)}}}return r}async findByOntology(e){let t=this.app.vault.getMarkdownFiles(),r=[];for(let s of t){let i=this.app.metadataCache.getFileCache(s);if(i!=null&&i.frontmatter){let o=i.frontmatter.exo__Asset_isDefinedBy;if((o==null?void 0:o.replace(/\[\[!?|\]\]/g,""))===e.toString()){let l=A.fromFrontmatter(i.frontmatter,s.basename);l&&r.push(l)}}}return r}async save(e){await this.saveEntityWithFrontmatter(e,t=>t.getTitle(),t=>t.toFrontmatter(),t=>this.findExistingAssetFile(t),"Asset")}findExistingAssetFile(e){var o;let t=e.toFrontmatter(),r=(o=e.props)==null?void 0:o.filePath,s=t.exo__Asset_uid,i=e.getTitle();return this.findFileWithFallback({uid:s,storedPath:r,filename:i})}async delete(e){let t=await this.findById(e);t&&await this.deleteFileByEntity(t,r=>r.getTitle(),"Asset")}async exists(e){try{return await this.findById(e)!==null}catch(t){return!1}}async findAll(){var r;let e=this.app.vault.getMarkdownFiles(),t=[];for(let s of e){let i=this.app.metadataCache.getFileCache(s);if((r=i==null?void 0:i.frontmatter)!=null&&r.exo__Asset_uid){let o=A.fromFrontmatter(i.frontmatter,s.basename);o&&t.push(o)}}return t}async findByFilename(e){let t=e;t.endsWith(".md")||(t=`${t}.md`);let r=this.app.vault.getAbstractFileByPath(t);if(r||(r=this.app.vault.getMarkdownFiles().find(i=>i.path===t||i.name===t)||null),r instanceof zt.TFile){let s=this.app.metadataCache.getFileCache(r);if(s!=null&&s.frontmatter){let i=A.fromFrontmatter(s.frontmatter,r.basename);if(i)return i.props.filePath=r.path,i}}return null}async updateFrontmatterByPath(e,t){await super.updateFrontmatterByPath(e,t)}}});var Z,Wt=f(()=>{be();Z=class{constructor(e){this.prefix=e.prefix,this.label=e.label,this.fileName=e.fileName,this.namespace=e.namespace,this.description=e.description}getPrefix(){return this.prefix}getLabel(){return this.label}getFileName(){return this.fileName}getNamespace(){return this.namespace}getDescription(){return this.description}getDisplayName(){return`${this.prefix.toString()} - ${this.label}`}isInternal(){return this.fileName.startsWith("!")}equals(e){return this.prefix.equals(e.prefix)}toFrontmatter(){return{exo__Ontology_prefix:this.prefix.toString(),exo__Ontology_label:this.label,exo__Ontology_namespace:this.namespace||"",exo__Ontology_description:this.description||""}}static fromFrontmatter(e){let t=I.create(e.exo__Ontology_prefix||"exo"),r=t.isSuccess?t.getValue():I.create("exo").getValue();return new Z({prefix:r,label:e.exo__Ontology_label||r.toString(),fileName:`!${r.toString()}.md`,namespace:e.exo__Ontology_namespace,description:e.exo__Ontology_description})}}});var $e,Oe,jt=f(()=>{$e=require("obsidian");Wt();Oe=class{constructor(e){this.app=e}async findByPrefix(e){let t=`!${e.toString()}.md`,r=this.app.vault.getAbstractFileByPath(t);if(r instanceof $e.TFile){let s=this.app.metadataCache.getFileCache(r);if(s!=null&&s.frontmatter)return Z.fromFrontmatter(s.frontmatter)}return null}async findAll(){var r;let e=this.app.vault.getMarkdownFiles(),t=[];for(let s of e)if(s.name.startsWith("!")){let i=this.app.metadataCache.getFileCache(s);(r=i==null?void 0:i.frontmatter)!=null&&r.exo__Ontology_prefix&&t.push(Z.fromFrontmatter(i.frontmatter))}return t}async save(e){let t=`!${e.getPrefix().toString()}.md`,r=e.toFrontmatter(),s=["---"];for(let[a,l]of Object.entries(r))if(Array.isArray(l)){s.push(`${a}:`);for(let c of l)s.push(`  - ${c}`)}else s.push(`${a}: ${l}`);s.push("---","");let i=s.join(`
`),o=this.app.vault.getAbstractFileByPath(t);o instanceof $e.TFile?await this.app.vault.modify(o,i):await this.app.vault.create(t,i)}async exists(e){let t=`!${e.toString()}.md`;return this.app.vault.getAbstractFileByPath(t)instanceof $e.TFile}}});var Ue,Gt=f(()=>{X();Ue=class extends P{constructor(e){super(e)}getUncommittedEvents(){return this.getDomainEvents()}markDomainEventForDispatch(e){let t={...e,dateTimeOccurred:new Date,aggregateId:this.r}}markEventsAsCommitted(){this.clearDomainEvents()}}});var ee,Ee,Kt=f(()=>{Gt();x();ee=class extends Ue{constructor(e){super(e)}static create(e){if(!e.className)return n.fail("Class view must be associated with a class");if(e.buttons.length>ee.MAX_BUTTONS_PER_VIEW)return n.fail(`Class view cannot have more than ${ee.MAX_BUTTONS_PER_VIEW} buttons`);let t=e.buttons.map(i=>i.order);if(new Set(t).size!==t.length)return n.fail("Buttons cannot have duplicate order values");let s={showProperties:!0,showRelations:!0,showBacklinks:!0,showButtons:!0,buttonPosition:"top"};return n.ok(new ee({...e,displayOptions:e.displayOptions||s}))}get id(){return this.props.id}get className(){return this.props.className}get buttons(){return[...this.props.buttons].sort((e,t)=>e.order-t.order)}get displayOptions(){return this.props.displayOptions||{showProperties:!0,showRelations:!0,showBacklinks:!0,showButtons:!0,buttonPosition:"top"}}addButton(e){return this.props.buttons.length>=ee.MAX_BUTTONS_PER_VIEW?n.fail(`Cannot add more buttons. Maximum of ${ee.MAX_BUTTONS_PER_VIEW} reached`):this.props.buttons.some(t=>t.id.equals(e.id))?n.fail("Button already exists in this view"):this.props.buttons.some(t=>t.order===e.order)?n.fail(`Button with order ${e.order} already exists`):(this.props.buttons.push(e),this.addDomainEvent({aggregateId:this.id.toString(),eventType:"ButtonAddedToClassView",occurredOn:new Date,eventData:{classViewId:this.id.toString(),className:this.className.value,buttonId:e.id.toString(),buttonLabel:e.label}}),n.ok())}removeButton(e){let t=this.props.buttons.findIndex(s=>s.id.equals(e));if(t===-1)return n.fail("Button not found in this view");let r=this.props.buttons.splice(t,1)[0];return this.addDomainEvent({aggregateId:this.id.toString(),eventType:"ButtonRemovedFromClassView",occurredOn:new Date,eventData:{classViewId:this.id.toString(),className:this.className.value,buttonId:r.id.toString()}}),n.ok()}reorderButtons(e){for(let s of this.props.buttons)if(!e.has(s.id.toString()))return n.fail(`Missing order for button ${s.id.toString()}`);let t=Array.from(e.values());if(new Set(t).size!==t.length)return n.fail("Duplicate order values not allowed");for(let s of this.props.buttons){let i=e.get(s.id.toString());i!==void 0&&Object.defineProperty(s,"order",{value:i})}return this.addDomainEvent({aggregateId:this.id.toString(),eventType:"ButtonsReordered",occurredOn:new Date,eventData:{classViewId:this.id.toString(),className:this.className.value,newOrder:Array.from(e.entries())}}),n.ok()}updateDisplayOptions(e){return this.props.displayOptions={...this.displayOptions,...e},this.addDomainEvent({aggregateId:this.id.toString(),eventType:"DisplayOptionsUpdated",occurredOn:new Date,eventData:{classViewId:this.id.toString(),className:this.className.value,displayOptions:this.props.displayOptions}}),n.ok()}getEnabledButtons(){return this.buttons.filter(e=>e.isEnabled)}hasExecutableButtons(){return this.getEnabledButtons().length>0&&this.displayOptions.showButtons}findButton(e){return this.props.buttons.find(t=>t.id.equals(e))}},Ee=ee;Ee.MAX_BUTTONS_PER_VIEW=20});var K,vt=f(()=>{X();x();K=class extends P{constructor(e){super(e,e.id.toString())}generateId(){return this.props.id.toString()}validate(){if(!this.props.id)throw new Error("UIButton must have a valid ID");if(!this.props.label||this.props.label.trim().length===0)throw new Error("UIButton must have a non-empty label");if(!this.props.commandId)throw new Error("UIButton must have a valid command ID")}static create(e){var t,r;return!e.label||e.label.trim().length===0?n.fail("Button label cannot be empty"):e.label.length>100?n.fail("Button label cannot exceed 100 characters"):e.commandId?n.ok(new K({...e,isEnabled:(t=e.isEnabled)!=null?t:!0,order:(r=e.order)!=null?r:0})):n.fail("Button must have an associated command")}get id(){return this.props.id}get label(){return this.props.label}get commandId(){return this.props.commandId}get order(){var e;return(e=this.props.order)!=null?e:0}get isEnabled(){var e;return(e=this.props.isEnabled)!=null?e:!0}get tooltip(){return this.props.tooltip}canExecute(){return this.isEnabled}click(){return this.canExecute()?(this.addDomainEvent({aggregateId:this.id.toString(),eventType:"ButtonClicked",occurredOn:new Date,eventData:{buttonId:this.id.toString(),commandId:this.commandId.toString(),label:this.label}}),n.ok()):n.fail("Button is disabled and cannot be clicked")}enable(){this.props.isEnabled=!0}disable(){this.props.isEnabled=!1}updateLabel(e){return!e||e.trim().length===0?n.fail("Button label cannot be empty"):e.length>100?n.fail("Button label cannot exceed 100 characters"):(this.props.label=e,n.ok())}}});var we,He,Yt=f(()=>{we=require("obsidian");Kt();G();U();x();vt();He=class{constructor(e){this.app=e}async findByClassName(e){try{let t=this.app.vault.getMarkdownFiles();for(let r of t){let s=this.app.metadataCache.getFileCache(r);if(!(s!=null&&s.frontmatter)||s.frontmatter.exo__Instance_class!=="[[ui__ClassView]]")continue;let o=s.frontmatter.ui__ClassView_targetClass;if(!(!o||this.cleanAssetReference(o)!==e.value))return this.buildClassViewFromFile(r)}return n.ok(null)}catch(t){return n.fail(`Failed to find ClassView: ${t.message}`)}}async findById(e){try{let t=this.app.vault.getAbstractFileByPath(e.toString()+".md");return!t||!(t instanceof we.TFile)?n.ok(null):this.buildClassViewFromFile(t)}catch(t){return n.fail(`Failed to find ClassView by ID: ${t.message}`)}}async save(e){try{let t=`${e.id.toString()}.md`,r=this.serializeClassView(e),s=this.app.vault.getAbstractFileByPath(t);return s instanceof we.TFile?await this.app.vault.modify(s,r):await this.app.vault.create(t,r),n.ok()}catch(t){return n.fail(`Failed to save ClassView: ${t.message}`)}}async delete(e){try{let t=this.app.vault.getAbstractFileByPath(e.toString()+".md");return t instanceof we.TFile&&await this.app.vault.delete(t),n.ok()}catch(t){return n.fail(`Failed to delete ClassView: ${t.message}`)}}async findAll(){try{let e=[],t=this.app.vault.getMarkdownFiles();for(let r of t){let s=this.app.metadataCache.getFileCache(r);if(!(s!=null&&s.frontmatter)||s.frontmatter.exo__Instance_class!=="[[ui__ClassView]]")continue;let o=await this.buildClassViewFromFile(r);o.isSuccess&&o.getValue()&&e.push(o.getValue())}return n.ok(e)}catch(e){return n.fail(`Failed to find all ClassViews: ${e.message}`)}}async exists(e){let t=await this.findByClassName(e);return t.isFailure?n.fail(t.error):n.ok(t.getValue()!==null)}async buildClassViewFromFile(e){try{let t=this.app.metadataCache.getFileCache(e);if(!(t!=null&&t.frontmatter))return n.ok(null);let r=t.frontmatter,s=r.ui__ClassView_targetClass;if(!s)return n.ok(null);let i=b.create(this.cleanAssetReference(s));if(i.isFailure)return n.fail(i.error);let o=r.ui__ClassView_buttons||[],a=[];for(let p of this.ensureArray(o)){let m=await this.loadButton(this.cleanAssetReference(p));m.isSuccess&&m.getValue()&&a.push(m.getValue())}let l={showProperties:r.ui__ClassView_showProperties!==!1,showRelations:r.ui__ClassView_showRelations!==!1,showBacklinks:r.ui__ClassView_showBacklinks!==!1,showButtons:r.ui__ClassView_showButtons!==!1,buttonPosition:r.ui__ClassView_buttonPosition||"top"},c=y.create(e.basename);if(c.isFailure)return n.fail(c.error);let u=Ee.create({id:c.getValue(),className:i.getValue(),buttons:a,layoutTemplate:r.ui__ClassView_template,displayOptions:l});return u.isFailure?n.fail(u.error):n.ok(u.getValue())}catch(t){return n.fail(`Failed to build ClassView: ${t.message}`)}}async loadButton(e){try{let t=this.app.vault.getAbstractFileByPath(e+".md");if(!t||!(t instanceof we.TFile))return n.ok(null);let r=this.app.metadataCache.getFileCache(t);if(!(r!=null&&r.frontmatter))return n.ok(null);let s=r.frontmatter,i=y.create(t.basename),o=y.create(this.cleanAssetReference(s.ui__Button_command||""));if(i.isFailure||o.isFailure)return n.ok(null);let a=K.create({id:i.getValue(),label:s.ui__Button_label||t.basename,commandId:o.getValue(),order:s.ui__Button_order||0,isEnabled:s.ui__Button_enabled!==!1,tooltip:s.ui__Button_tooltip});return a.isFailure?n.fail(a.error):n.ok(a.getValue())}catch(t){return n.fail(`Failed to load button: ${t.message}`)}}serializeClassView(e){let t={exo__Instance_class:"[[ui__ClassView]]",ui__ClassView_targetClass:`[[${e.className.value}]]`,ui__ClassView_buttons:e.buttons.map(s=>`[[${s.id.toString()}]]`),ui__ClassView_showProperties:e.displayOptions.showProperties,ui__ClassView_showRelations:e.displayOptions.showRelations,ui__ClassView_showBacklinks:e.displayOptions.showBacklinks,ui__ClassView_showButtons:e.displayOptions.showButtons,ui__ClassView_buttonPosition:e.displayOptions.buttonPosition};return`---
${this.toYaml(t)}---

# ClassView: ${e.className.value}
`}cleanAssetReference(e){return typeof e!="string"?"":e.replace(/\[\[|\]\]/g,"").trim()}ensureArray(e){return Array.isArray(e)?e:e?[e]:[]}toYaml(e){return Object.entries(e).map(([t,r])=>Array.isArray(r)?`${t}:
${r.map(s=>`  - ${s}`).join(`
`)}`:`${t}: ${r}`).join(`
`)+`
`}}});var Re,ne,ze=f(()=>{X();x();Re=(c=>(c.CREATE_ASSET="CREATE_ASSET",c.CREATE_CHILD_TASK="CREATE_CHILD_TASK",c.CREATE_CHILD_AREA="CREATE_CHILD_AREA",c.OPEN_ASSET="OPEN_ASSET",c.DELETE_ASSET="DELETE_ASSET",c.RUN_TEMPLATE="RUN_TEMPLATE",c.EXECUTE_SEARCH="EXECUTE_SEARCH",c.TRIGGER_WORKFLOW="TRIGGER_WORKFLOW",c.CUSTOM="CUSTOM",c))(Re||{}),ne=class extends P{constructor(e){super(e,e.id.toString())}generateId(){return this.props.id.toString()}validate(){if(!this.props.id)throw new Error("ButtonCommand must have a valid ID");if(!this.props.name||this.props.name.trim().length===0)throw new Error("ButtonCommand must have a non-empty name");if(!this.props.type)throw new Error("ButtonCommand must have a valid type")}static create(e){if(!e.name||e.name.trim().length===0)return n.fail("Command name cannot be empty");if(e.requiresInput&&(!e.parameters||e.parameters.length===0))return n.fail("Commands requiring input must define parameters");for(let t of e.parameters){if(!t.name||t.name.trim().length===0)return n.fail("Parameter name cannot be empty");if(t.validation)try{new RegExp(t.validation)}catch(r){return n.fail(`Invalid validation regex for parameter ${t.name}`)}}return e.type==="RUN_TEMPLATE"&&!e.template?n.fail("Template commands must specify a template"):e.type==="CUSTOM"&&!e.script?n.fail("Custom commands must specify a script"):n.ok(new ne(e))}get id(){return this.props.id}get type(){return this.props.type}get name(){return this.props.name}get description(){return this.props.description}get requiresInput(){return this.props.requiresInput}get parameters(){return this.props.parameters}get targetClass(){return this.props.targetClass}get template(){return this.props.template}get script(){return this.props.script}validateInput(e){let t={},r=[];for(let s of this.parameters){let i=e[s.name];if(s.required&&(i==null||i==="")){r.push(`Required parameter '${s.name}' is missing`);continue}if(!s.required&&i==null){s.defaultValue!==void 0&&(t[s.name]=s.defaultValue);continue}if(!this.validateParameterType(i,s.type)){r.push(`Parameter '${s.name}' must be of type ${s.type}`);continue}if(s.validation&&!new RegExp(s.validation).test(String(i))){r.push(`Parameter '${s.name}' does not match validation pattern`);continue}t[s.name]=i}return r.length>0?n.fail(r.join("; ")):n.ok(t)}canExecute(e){return!(this.targetClass&&e.currentClass!==this.targetClass||this.type==="DELETE_ASSET"&&!e.hasSelection)}buildExecutionContext(e){let t=this.validateInput(e);if(t.isFailure)return n.fail(t.error);let r={commandId:this.id.toString(),commandType:this.type,parameters:t.getValue(),timestamp:new Date,template:this.props.template,script:this.props.script,targetClass:this.props.targetClass};return n.ok(r)}validateParameterType(e,t){switch(t){case"string":return typeof e=="string";case"number":return typeof e=="number"||!isNaN(Number(e));case"boolean":return typeof e=="boolean"||e==="true"||e==="false";case"date":return!isNaN(Date.parse(String(e)));case"asset":return typeof e=="string"&&e.startsWith("[[")&&e.endsWith("]]");case"array":return Array.isArray(e)||typeof e=="string";default:return!0}}}});var te,qe,Qt=f(()=>{te=require("obsidian");vt();ze();U();x();qe=class{constructor(e){this.app=e}async findButtonById(e){try{let t=this.app.vault.getAbstractFileByPath(e.toString()+".md");return!t||!(t instanceof te.TFile)?n.ok(null):this.buildButtonFromFile(t)}catch(t){return n.fail(`Failed to find button: ${t.message}`)}}async findCommandById(e){try{let t=this.app.vault.getAbstractFileByPath(e.toString()+".md");return!t||!(t instanceof te.TFile)?n.ok(null):this.buildCommandFromFile(t)}catch(t){return n.fail(`Failed to find command: ${t.message}`)}}async findAllButtons(){try{let e=[],t=this.app.vault.getMarkdownFiles();for(let r of t){let s=this.app.metadataCache.getFileCache(r);if(!(s!=null&&s.frontmatter)||s.frontmatter.exo__Instance_class!=="[[ui__Button]]")continue;let o=await this.buildButtonFromFile(r);o.isSuccess&&o.getValue()&&e.push(o.getValue())}return n.ok(e)}catch(e){return n.fail(`Failed to find buttons: ${e.message}`)}}async findAllCommands(){try{let e=[],t=this.app.vault.getMarkdownFiles();for(let r of t){let s=this.app.metadataCache.getFileCache(r);if(!(s!=null&&s.frontmatter)||s.frontmatter.exo__Instance_class!=="[[ui__ButtonCommand]]")continue;let o=await this.buildCommandFromFile(r);o.isSuccess&&o.getValue()&&e.push(o.getValue())}return n.ok(e)}catch(e){return n.fail(`Failed to find commands: ${e.message}`)}}async findButtonsByCommandId(e){try{let t=[],r=await this.findAllButtons();if(r.isFailure)return n.fail(r.error);let s=r.getValue();for(let i of s)i.commandId.equals(e)&&t.push(i);return n.ok(t)}catch(t){return n.fail(`Failed to find buttons by command: ${t.message}`)}}async saveButton(e){try{let t=`${e.id.toString()}.md`,r=this.serializeButton(e),s=this.app.vault.getAbstractFileByPath(t);return s instanceof te.TFile?await this.app.vault.modify(s,r):await this.app.vault.create(t,r),n.ok()}catch(t){return n.fail(`Failed to save button: ${t.message}`)}}async saveCommand(e){try{let t=`${e.id.toString()}.md`,r=this.serializeCommand(e),s=this.app.vault.getAbstractFileByPath(t);return s instanceof te.TFile?await this.app.vault.modify(s,r):await this.app.vault.create(t,r),n.ok()}catch(t){return n.fail(`Failed to save command: ${t.message}`)}}async deleteButton(e){try{let t=this.app.vault.getAbstractFileByPath(e.toString()+".md");return t instanceof te.TFile&&await this.app.vault.delete(t),n.ok()}catch(t){return n.fail(`Failed to delete button: ${t.message}`)}}async deleteCommand(e){try{let t=this.app.vault.getAbstractFileByPath(e.toString()+".md");return t instanceof te.TFile&&await this.app.vault.delete(t),n.ok()}catch(t){return n.fail(`Failed to delete command: ${t.message}`)}}async buildButtonFromFile(e){try{let t=this.app.metadataCache.getFileCache(e);if(!(t!=null&&t.frontmatter))return n.ok(null);let r=t.frontmatter,s=y.create(e.basename),i=y.create(this.cleanAssetReference(r.ui__Button_command||""));if(s.isFailure||i.isFailure)return n.ok(null);let o=K.create({id:s.getValue(),label:r.ui__Button_label||e.basename,commandId:i.getValue(),order:r.ui__Button_order||0,isEnabled:r.ui__Button_enabled!==!1,tooltip:r.ui__Button_tooltip});return o.isFailure?n.fail(o.error):n.ok(o.getValue())}catch(t){return n.fail(`Failed to build button: ${t.message}`)}}async buildCommandFromFile(e){try{let t=this.app.metadataCache.getFileCache(e);if(!(t!=null&&t.frontmatter))return n.ok(null);let r=t.frontmatter,s=y.create(e.basename);if(s.isFailure)return n.ok(null);let i=r.ui__Command_type||"CUSTOM",o=this.parseCommandType(i),a=this.parseParameters(r.ui__Command_parameters),l=ne.create({id:s.getValue(),type:o,name:r.ui__Command_name||e.basename,description:r.ui__Command_description,requiresInput:r.ui__Command_requiresInput===!0,parameters:a,targetClass:this.cleanAssetReference(r.ui__Command_targetClass),template:r.ui__Command_template,script:r.ui__Command_script});return l.isFailure?n.fail(l.error):n.ok(l.getValue())}catch(t){return n.fail(`Failed to build command: ${t.message}`)}}parseCommandType(e){let t=e.toUpperCase();return Re[t]||"CUSTOM"}parseParameters(e){if(!e)return[];let t=[],r=this.ensureArray(e);for(let s of r)typeof s=="object"&&s.name&&t.push({name:s.name,type:s.type||"string",required:s.required===!0,defaultValue:s.defaultValue,label:s.label,description:s.description,validation:s.validation});return t}serializeButton(e){let t={exo__Instance_class:"[[ui__Button]]",ui__Button_label:e.label,ui__Button_command:`[[${e.commandId.toString()}]]`,ui__Button_order:e.order,ui__Button_enabled:e.isEnabled,ui__Button_tooltip:e.tooltip};return`---
${this.toYaml(t)}---

# Button: ${e.label}
`}serializeCommand(e){let t={exo__Instance_class:"[[ui__ButtonCommand]]",ui__Command_type:e.type,ui__Command_name:e.name,ui__Command_description:e.description,ui__Command_requiresInput:e.requiresInput,ui__Command_parameters:e.parameters,ui__Command_targetClass:e.targetClass?`[[${e.targetClass}]]`:null,ui__Command_template:e.template,ui__Command_script:e.script};return`---
${this.toYaml(t)}---

# Command: ${e.name}
`}cleanAssetReference(e){return typeof e!="string"?"":e.replace(/\[\[|\]\]/g,"").trim()}ensureArray(e){return Array.isArray(e)?e:e?[e]:[]}toYaml(e){return Object.entries(e).filter(([t,r])=>r!=null).map(([t,r])=>Array.isArray(r)?r.length===0?`${t}: []`:`${t}:
${r.map(s=>`  - ${JSON.stringify(s)}`).join(`
`)}`:typeof r=="object"?`${t}: ${JSON.stringify(r)}`:`${t}: ${r}`).join(`
`)+`
`}}});var z,Pe,Jt=f(()=>{X();x();z=class extends P{constructor(e){super(e,e.id.toString())}generateId(){return this.props.id.toString()}validate(){if(!this.props.id)throw new Error("ClassLayout must have a valid ID");if(!this.props.targetClass)throw new Error("ClassLayout must have a valid target class");if(this.props.blocks.length>z.MAX_BLOCKS)throw new Error(`ClassLayout cannot have more than ${z.MAX_BLOCKS} blocks`)}static create(e){if(!e.targetClass)return n.fail("Target class is required");if(e.blocks.length>z.MAX_BLOCKS)return n.fail(`Cannot have more than ${z.MAX_BLOCKS} blocks`);let t=e.blocks.map(s=>s.order);return new Set(t).size!==t.length?n.fail("Blocks cannot have duplicate order values"):n.ok(new z(e))}get id(){return this.props.id}get targetClass(){return this.props.targetClass}get blocks(){return[...this.props.blocks].sort((e,t)=>e.order-t.order)}get isEnabled(){return this.props.isEnabled}get priority(){return this.props.priority}addBlock(e){return this.props.blocks.length>=z.MAX_BLOCKS?n.fail(`Cannot add more blocks. Maximum of ${z.MAX_BLOCKS} reached`):this.props.blocks.some(t=>t.id===e.id)?n.fail("Block with this ID already exists"):this.props.blocks.some(t=>t.order===e.order)?n.fail(`Block with order ${e.order} already exists`):(this.props.blocks.push(e),n.ok())}removeBlock(e){let t=this.props.blocks.findIndex(r=>r.id===e);return t===-1?n.fail("Block not found"):(this.props.blocks.splice(t,1),n.ok())}updateBlock(e,t){let r=this.props.blocks.find(s=>s.id===e);return r?t.order!==void 0&&t.order!==r.order&&this.props.blocks.some(s=>s.id!==e&&s.order===t.order)?n.fail(`Block with order ${t.order} already exists`):(Object.assign(r,t),n.ok()):n.fail("Block not found")}getVisibleBlocks(){return this.blocks.filter(e=>e.isVisible)}enable(){this.props.isEnabled=!0}disable(){this.props.isEnabled=!1}},Pe=z;Pe.MAX_BLOCKS=20});var We,Xt=f(()=>{Jt();G();U();We=class{constructor(e,t="layouts"){this.app=e;this.layoutsFolderPath=t;this.cache=new Map;this.lastCacheUpdate=0;this.CACHE_TTL=3e4;this.hasManuallyAddedLayouts=!1;this.cache=new Map}async findByClass(e){return await this.refreshCacheIfNeeded(),Array.from(this.cache.values()).flat().filter(s=>s.targetClass.equals(e)&&s.isEnabled).sort((s,i)=>i.priority-s.priority)}async findById(e){return await this.refreshCacheIfNeeded(),Array.from(this.cache.values()).flat().find(r=>r.id.equals(e))||null}async findAll(){return await this.refreshCacheIfNeeded(),Array.from(this.cache.values()).flat()}async findEnabledByClass(e){return(await this.findByClass(e)).filter(r=>r.isEnabled)}async save(e){let t=e.targetClass.value,r=this.cache.get(t)||[],s=r.findIndex(i=>i.id.equals(e.id));s>=0?r[s]=e:r.push(e),this.cache.set(t,r),this.hasManuallyAddedLayouts=!0}async delete(e){for(let[t,r]of this.cache.entries()){let s=r.filter(i=>!i.id.equals(e));s.length!==r.length&&this.cache.set(t,s)}}async refreshCacheIfNeeded(){let e=Date.now();e-this.lastCacheUpdate<this.CACHE_TTL||(this.hasManuallyAddedLayouts||await this.loadLayoutsFromFiles(),this.lastCacheUpdate=e)}async loadLayoutsFromFiles(){if(this.hasManuallyAddedLayouts||this.cache.clear(),!this.app||!this.app.vault)return;let e=this.app.vault.getFiles();if(!Array.isArray(e))return;let t=e.filter(r=>r.path.startsWith(this.layoutsFolderPath+"/")||this.isLayoutFile(r));for(let r of t){let s=await this.parseLayoutFile(r);if(s){let i=s.targetClass.value,o=this.cache.get(i)||[];o.push(s),this.cache.set(i,o)}}}isLayoutFile(e){if(!this.app||!this.app.metadataCache||!e)return!1;let t=this.app.metadataCache.getFileCache(e);if(!(t!=null&&t.frontmatter))return!1;let r=t.frontmatter.exo__Instance_class;return this.cleanClassName(r)==="ui__ClassLayout"}async parseLayoutFile(e){if(!this.app||!this.app.metadataCache||!e)return null;let t=this.app.metadataCache.getFileCache(e);if(!(t!=null&&t.frontmatter))return null;let r=t.frontmatter,s=r.exo__Instance_class;if(this.cleanClassName(s)!=="ui__ClassLayout")return null;let i=r.ui__ClassLayout_targetClass;if(!i)return null;let o=this.cleanClassName(i),a=b.create(o);if(a.isFailure)return null;let l=this.parseBlocks(r.ui__ClassLayout_blocks||[]),c=r.ui__ClassLayout_priority||0,u=r.ui__ClassLayout_enabled!==!1,p=y.create(r.exo__Asset_uid||e.path);if(p.isFailure)return null;let m=Pe.create({id:p.getValue(),targetClass:a.getValue(),blocks:l,isEnabled:u,priority:c});return m!=null&&m.isSuccess?m.getValue():null}parseBlocks(e){return Array.isArray(e)?e.map((t,r)=>{var i;return t?{id:t.id||`block-${r}`,type:t.type||"properties",title:t.title||"Untitled Block",order:(i=t.order)!=null?i:r,config:this.parseBlockConfig(t.type||"properties",t.config||{}),isVisible:t.isVisible!==!1}:null}).filter(t=>t!==null):[]}parseBlockConfig(e,t){let r={type:e,...t};switch(e){case"query":return{type:"query",query:t.query||"",className:t.className,propertyFilters:this.parsePropertyFilters(t.propertyFilters),relationProperty:t.relationProperty,maxResults:t.maxResults||50,sortBy:t.sortBy,sortOrder:t.sortOrder||"asc",displayAs:t.displayAs||"list"};case"properties":return{type:"properties",includedProperties:t.includedProperties||[],excludedProperties:t.excludedProperties||[],editableProperties:t.editableProperties||[],groupBy:t.groupBy};case"relations":return{type:"relations",relationProperty:t.relationProperty||"",showBacklinks:t.showBacklinks!==!1,showForwardLinks:t.showForwardLinks!==!1,maxDepth:t.maxDepth||1};case"backlinks":return{type:"backlinks",filterByClass:t.filterByClass,groupByClass:t.groupByClass||!1,maxResults:t.maxResults||50};case"buttons":return{type:"buttons",buttons:Array.isArray(t.buttons)?t.buttons.map(s=>({id:s.id||"",label:s.label||"",commandType:s.commandType||"",tooltip:s.tooltip,style:s.style||"default",parameters:s.parameters||{}})):[],position:t.position||"top",style:t.style||"default"};case"narrower":return{type:"narrower",broaderProperty:t.broaderProperty||"ims__Concept_broader",filterByClass:t.filterByClass,displayAs:t.displayAs||"list",maxResults:t.maxResults||50};case"custom":return{type:"custom",templatePath:t.templatePath,dataviewQuery:t.dataviewQuery,queryEngineQuery:t.queryEngineQuery,customScript:t.customScript};default:return r}}parsePropertyFilters(e){return Array.isArray(e)?e.map(t=>({property:t.property||"",operator:t.operator||"equals",value:t.value||""})):[]}cleanClassName(e){if(!e)return"";let t=Array.isArray(e)?e[0]:e;return(t==null?void 0:t.toString().replace(/\[\[|\]\]/g,""))||""}}});var je,Zt=f(()=>{De();U();G();be();x();je=class{constructor(e,t,r){this.assetRepository=e;this.ontologyRepository=t;this.ontologyProvisioningService=r}async execute(e){try{let t=this.validateRequest(e);if(!t.isSuccess)return{success:!1,assetId:"",message:t.getError(),error:t.getError()};await this.ontologyProvisioningService.ensureOntologyExists(e.ontologyPrefix);let r=I.create(e.ontologyPrefix);if(r.isFailure)return{success:!1,assetId:"",message:`Invalid ontology prefix: ${r.error}`,error:r.error};let s=r.getValue(),i=b.create(e.className);if(!i.isSuccess)return{success:!1,assetId:"",message:`Invalid class name: ${i.getError()}`,error:i.getError()};let o=i.getValue(),a=A.create({id:y.generate(),label:e.title,className:o,ontology:s,properties:e.properties||{}});if(!a.isSuccess)return{success:!1,assetId:"",message:`Asset creation failed: ${a.getError()}`,error:a.getError()};let l=a.getValue();return await this.assetRepository.save(l),{success:!0,assetId:l.getId().toString(),message:`Created asset: ${l.getTitle()}`}}catch(t){let r=t instanceof Error?t.message:String(t);return{success:!1,assetId:"",message:`Unexpected error: ${r}`,error:r}}}validateRequest(e){return!e.title||e.title.trim().length===0?n.fail("Asset title is required"):e.title.length>200?n.fail("Asset title cannot exceed 200 characters"):e.className?e.ontologyPrefix?e.ontologyPrefix.trim().length===0?n.fail("Ontology prefix cannot be empty"):n.ok():n.fail("Ontology prefix is required"):n.fail("Asset class is required")}}});var Ge,er=f(()=>{x();G();Ge=class{constructor(e,t){this.classViewRepository=e;this.buttonRepository=t}async execute(e){var l;if(!e.className)return n.fail("Class name is required");let t=b.create(e.className);if(t.isFailure)return n.fail(t.error);let r=t.getValue(),s=await this.classViewRepository.findByClassName(r);if(s.isFailure)return n.fail(`Failed to load class view: ${s.error}`);let i=s.getValue();if(!i)return n.ok({buttons:[],displayOptions:{position:"top",showButtons:!1}});if(!i.displayOptions.showButtons)return n.ok({buttons:[],displayOptions:{position:i.displayOptions.buttonPosition,showButtons:!1}});let o=i.getEnabledButtons(),a=[];for(let c of o){let u=await this.buttonRepository.findCommandById(c.commandId);if(u.isFailure)continue;let p=u.getValue();if(!p)continue;p.canExecute({currentClass:e.className,hasSelection:((l=e.context)==null?void 0:l.hasSelection)||!1})&&a.push({buttonId:c.id.toString(),label:c.label,tooltip:c.tooltip,isEnabled:c.isEnabled,order:c.order,command:{id:p.id.toString(),type:p.type,requiresInput:p.requiresInput,parameters:p.parameters}})}return a.sort((c,u)=>c.order-u.order),n.ok({buttons:a,displayOptions:{position:i.displayOptions.buttonPosition,showButtons:!0}})}}});var Ke,tr=f(()=>{x();U();Ke=class{constructor(e,t){this.buttonRepository=e;this.commandExecutor=t}async execute(e){var u,p,m;if(!e.buttonId)return n.fail("Button ID is required");let t=y.create(e.buttonId);if(t.isFailure)return n.fail("Invalid button ID");let r=t.getValue(),s=await this.buttonRepository.findButtonById(r);if(s.isFailure)return n.fail(`Failed to load button: ${s.error}`);let i=s.getValue();if(!i)return n.fail("Button not found");if(!i.canExecute())return n.fail("Button is disabled");let o=await this.buttonRepository.findCommandById(i.commandId);if(o.isFailure)return n.fail(`Failed to load command: ${o.error}`);let a=o.getValue();if(!a)return n.fail("Command not found");if(a.requiresInput&&!e.inputParameters)return n.ok({success:!1,requiresInput:!0,inputSchema:{title:a.name,description:a.description,parameters:a.parameters}});let l=a.buildExecutionContext(e.inputParameters||{});if(l.isFailure)return n.fail(`Invalid parameters: ${l.error}`);let c=l.getValue();try{let g=await this.commandExecutor.execute({command:a,context:{...c,assetId:e.assetId,currentView:(u=e.context)==null?void 0:u.currentView,currentClass:(p=e.context)==null?void 0:p.currentClass,selection:(m=e.context)==null?void 0:m.selection}});if(g.isFailure)return n.fail(`Command execution failed: ${g.error}`);let h=g.getValue();return i.click(),n.ok({success:!0,message:`Command '${a.name}' executed successfully`,result:h})}catch(g){return n.fail(`Unexpected error during command execution: ${g.message}`)}}}});var Ye,rr=f(()=>{x();U();Ye=class{constructor(e,t){this.assetRepository=e;this.plugin=t}async execute(e){if(!e.assetId)return n.fail("Asset ID is required");if(!e.propertyName)return n.fail("Property name is required");let t=this.validatePropertyValue(e.value,e.propertyDefinition);if(t.isFailure)return n.fail(t.error);try{if(e.assetId.includes("/")||e.assetId.endsWith(".md")){let i=this.assetRepository;if(i.updateFrontmatterByPath)return await i.updateFrontmatterByPath(e.assetId,{[e.propertyName]:e.value}),n.ok({success:!0,updatedValue:e.value})}let r=null,s=y.create(e.assetId);return s.isSuccess&&(r=await this.assetRepository.findById(s.getValue())),r||(r=await this.assetRepository.findByFilename(e.assetId)),r?(r.setProperty(e.propertyName,e.value),await this.assetRepository.save(r),n.ok({success:!0,updatedValue:e.value})):n.fail(`Asset not found: ${e.assetId}`)}catch(r){return n.fail(`Failed to update property: ${r}`)}}validatePropertyValue(e,t){var r;if(t.isRequired&&(e==null||e===""))return n.fail(`${t.label} is required`);if(!t.isRequired&&(e==null||e===""))return n.ok();if(t.range==="number"&&isNaN(Number(e)))return n.fail(`${t.label} must be a number`);if(t.range==="date"&&isNaN(Date.parse(e)))return n.fail(`${t.label} must be a valid date`);if(t.range==="boolean"&&typeof e!="boolean")return n.fail(`${t.label} must be true or false`);if((r=t.range)!=null&&r.startsWith("enum:")){let s=t.range.substring(5).split(",").map(i=>i.trim());if(!s.includes(e))return n.fail(`${t.label} must be one of: ${s.join(", ")}`)}if(t.validation)try{if(!new RegExp(t.validation).test(String(e)))return n.fail(`${t.label} format is invalid`)}catch(s){}return n.ok()}async getPropertiesForClass(e){try{let t=await this.plugin.findPropertiesForClass(e);return n.ok(t)}catch(t){return n.fail(`Failed to get properties: ${t.message}`)}}async getAssetsForClass(e){try{let t=await this.plugin.findAssetsByClass(e,!0);return n.ok(t)}catch(t){return n.fail(`Failed to get assets: ${t.message}`)}}}});var w,Qe,xt,sr=f(()=>{w=require("obsidian");x();ze();De();U();G();be();Qe=class{constructor(e,t,r,s){this.app=e;this.assetRepository=t;this.createChildTaskUseCase=r;this.createChildAreaUseCase=s;this.handlers=new Map,this.registerDefaultHandlers()}async execute(e){let t=Date.now();try{let r=this.validate(e);if(r.isFailure)return n.fail(r.error);let s=this.handlers.get(e.command.type);if(!s)return n.fail(`No handler registered for command type: ${e.command.type}`);let i=await s(e),o=Date.now()-t;return i.isFailure?n.ok({commandId:e.context.commandId,status:"failure",error:i.error,executionTime:o}):n.ok({commandId:e.context.commandId,status:"success",output:i.getValue(),executionTime:o})}catch(r){let s=Date.now()-t;return n.ok({commandId:e.context.commandId,status:"failure",error:`Unexpected error: ${r.message}`,executionTime:s})}}registerHandler(e,t){this.handlers.set(e,t)}isSupported(e){return this.handlers.has(e)}validate(e){return e.command?e.context?e.command.requiresInput&&(!e.context.parameters||Object.keys(e.context.parameters).length===0)?n.fail("Command requires input parameters"):n.ok():n.fail("Execution context is required"):n.fail("Command is required")}registerDefaultHandlers(){this.registerHandler("CREATE_ASSET",async e=>{let t=e.context.parameters,r=t.title||"Untitled",s=t.className||e.context.targetClass||"exo__Asset",i=t.ontology||"exo",o=t.properties||{},a=y.create(this.sanitizeFileName(r));if(a.isFailure)return n.fail(a.error);let l=b.create(s);if(l.isFailure)return n.fail(l.error);let c=I.create(i);if(c.isFailure)return n.fail(c.error);let u=A.create({id:a.getValue(),className:l.getValue(),ontology:c.getValue(),label:r,description:t.description||"",properties:o});if(u.isFailure)return n.fail(u.error);await this.assetRepository.save(u.getValue());let p=this.app.vault.getAbstractFileByPath(`${r}.md`);return p instanceof w.TFile&&await this.app.workspace.getLeaf().openFile(p),new w.Notice(`Asset "${r}" created successfully`),n.ok({assetId:a.getValue().toString()})}),this.registerHandler("OPEN_ASSET",async e=>{let t=e.context.assetId||e.context.parameters.assetId;if(!t)return n.fail("Asset ID is required for OPEN_ASSET command");let r=this.app.vault.getAbstractFileByPath(`${t}.md`);return r instanceof w.TFile?(await this.app.workspace.getLeaf(!0).openFile(r),n.ok({opened:t})):n.fail(`Asset not found: ${t}`)}),this.registerHandler("DELETE_ASSET",async e=>{let t=e.context.assetId||e.context.parameters.assetId;if(!t)return n.fail("Asset ID is required for DELETE_ASSET command");let r=this.app.vault.getAbstractFileByPath(`${t}.md`);return r instanceof w.TFile?await this.confirmAction("Delete Asset",`Are you sure you want to delete "${t}"? This cannot be undone.`)?(await this.app.vault.delete(r),new w.Notice(`Asset "${t}" deleted`),n.ok({deleted:t})):n.ok({cancelled:!0}):n.fail(`Asset not found: ${t}`)}),this.registerHandler("RUN_TEMPLATE",async e=>{let t=e.context.template||e.context.parameters.template_name,r=e.context.assetId;if(!t)return n.fail("Template name is required");if(!r)return n.fail("Target asset is required for template application");let s=this.app.vault.getAbstractFileByPath(`templates/${t}.md`);if(!(s instanceof w.TFile))return n.fail(`Template not found: ${t}`);let i=await this.app.vault.read(s),o=this.app.vault.getAbstractFileByPath(`${r}.md`);if(!(o instanceof w.TFile))return n.fail(`Target asset not found: ${r}`);let l=await this.app.vault.read(o)+`

`+this.processTemplate(i,e.context.parameters);return await this.app.vault.modify(o,l),new w.Notice(`Template "${t}" applied successfully`),n.ok({template:t,target:r})}),this.registerHandler("EXECUTE_SEARCH",async e=>{let t=e.context.parameters.query;return t?(this.app.internalPlugins.getPluginById("global-search").instance.openGlobalSearch(t),n.ok({query:t})):n.fail("Search query is required")}),this.registerHandler("TRIGGER_WORKFLOW",async e=>{let t=e.context.parameters.workflow;return t?(new w.Notice(`Workflow "${t}" triggered`),n.ok({workflow:t})):n.fail("Workflow name is required")}),this.registerHandler("CUSTOM",async e=>e.context.script?n.fail("Script execution is disabled for security. Use predefined commands instead."):n.fail("Script is required for custom commands")),this.registerHandler("CREATE_CHILD_TASK",async e=>{var s;let t=e.context.assetId;if(!t)return n.fail("Project asset ID is required for CREATE_CHILD_TASK command");if(!this.createChildTaskUseCase)return n.fail("CreateChildTaskUseCase not initialized");let r=await this.createChildTaskUseCase.execute({projectAssetId:t,context:{activeFile:e.context.currentView,selection:(s=e.context.selection)==null?void 0:s.join(`
`)}});if(!r.success)return n.fail(r.message);if(r.taskFilePath){let i=this.app.vault.getAbstractFileByPath(r.taskFilePath);i instanceof w.TFile&&await this.app.workspace.getLeaf(!0).openFile(i)}return new w.Notice(r.message),n.ok({taskId:r.taskId,taskFilePath:r.taskFilePath})}),this.registerHandler("CREATE_CHILD_AREA",async e=>{var s;let t=e.context.assetId;if(!t)return n.fail("Parent area ID is required for CREATE_CHILD_AREA command");if(!this.createChildAreaUseCase)return n.fail("CreateChildAreaUseCase not initialized");let r=await this.createChildAreaUseCase.execute({parentAreaId:t,context:{activeFile:e.context.currentView,selection:(s=e.context.selection)==null?void 0:s.join(`
`)}});if(!r.success)return n.fail(r.message);if(r.areaFilePath){let i=this.app.vault.getAbstractFileByPath(r.areaFilePath);i instanceof w.TFile&&await this.app.workspace.getLeaf(!0).openFile(i)}return new w.Notice(r.message),n.ok({areaId:r.areaId,areaFilePath:r.areaFilePath})})}sanitizeFileName(e){return e.replace(/[\\/:*?"<>|]/g,"-").trim()}processTemplate(e,t){let r=e;for(let[i,o]of Object.entries(t)){let a=new RegExp(`{{\\s*${i}\\s*}}`,"g");r=r.replace(a,String(o))}let s=new Date;return r=r.replace(/{{date}}/g,s.toISOString().split("T")[0]),r=r.replace(/{{time}}/g,s.toTimeString().split(" ")[0]),r=r.replace(/{{datetime}}/g,s.toISOString()),r}async confirmAction(e,t){return new Promise(r=>{new xt(this.app,e,t,r).open()})}},xt=class extends w.Modal{constructor(t,r,s,i){super(t);this.title=r;this.message=s;this.onConfirm=i}onOpen(){let{contentEl:t}=this;t.createEl("h2",{text:this.title}),t.createEl("p",{text:this.message});let r=t.createDiv({cls:"modal-button-container"});r.createEl("button",{text:"Cancel"}).addEventListener("click",()=>{this.onConfirm(!1),this.close()}),r.createEl("button",{text:"Confirm",cls:"mod-warning"}).addEventListener("click",()=>{this.onConfirm(!0),this.close()})}onClose(){let{contentEl:t}=this;t.empty()}}});var F,Je=f(()=>{F=class{constructor(){this.error={}}static create(){return new F}withId(e){return this.error.id=e,this}withSeverity(e){return this.error.severity=e,this}withCategory(e){return this.error.category=e,this}withTitle(e){return this.error.title=e,this}withMessage(e){return this.error.message=e,this}withContext(e){return this.error.context=e,this}withLocation(e){return this.error.context||(this.error.context={operation:"Unknown",timestamp:new Date}),this.error.context.location=e,this}withTechnicalDetails(e){return this.error.technicalDetails=e,this}withSuggestions(e){return this.error.suggestions=e,this}withRecoverable(e){return this.error.recoverable=e,this}withStackTrace(e){return this.error.stackTrace=e,this}withInnerError(e){return this.error.innerError=e,this}build(){return this.error.id||(this.error.id=`error-${Date.now()}-${Math.random().toString(36).substr(2,9)}`),this.error.severity||(this.error.severity="error"),this.error.category||(this.error.category="system"),this.error.title||(this.error.title="Error"),this.error.message||(this.error.message="An error occurred"),this.error.context||(this.error.context={operation:"Unknown",timestamp:new Date}),this.error}}});var Y,ar=f(()=>{Je();Y=class{static analyze(e){let t=typeof e=="string"?e:e.message,r=e instanceof Error?e.stack:void 0;for(let s of this.patterns){let i=t.match(s.pattern);if(i)return F.create().withSeverity(s.severity).withCategory(s.category).withTitle(s.title).withMessage(s.getUserMessage(i)).withContext({operation:"Error Analysis",timestamp:new Date}).withTechnicalDetails(t).withSuggestions(s.getSuggestions(i)).withRecoverable(s.recoverable).withStackTrace(r||"").build()}return F.create().withSeverity("error").withCategory("system").withTitle("Unknown Error").withMessage("An unexpected error occurred. Please check the technical details for more information.").withContext({operation:"Error Analysis",timestamp:new Date}).withTechnicalDetails(t).withRecoverable(!1).withStackTrace(r||"").build()}static getSPARQLErrorLocation(e,t){if(!t||t<0)return;let r=e.split(`
`),s=0;for(let i=0;i<r.length;i++){let o=r[i].length;if(s+o>=t)return{line:i+1,column:t-s+1};s+=o+1}}static addPattern(e){this.patterns.push(e)}static clearPatterns(){this.patterns=[]}};Y.patterns=[{pattern:/Unexpected token '([^']+)' at position (\d+)/i,severity:"error",category:"syntax",title:"SPARQL Syntax Error",getUserMessage:e=>`Unexpected '${e[1]}' at position ${e[2]}. Check for missing brackets or incorrect syntax.`,getSuggestions:e=>[{title:"Check Syntax",description:`The character '${e[1]}' was not expected at this position.`,confidence:.9},{title:"Common Fixes",description:"Ensure all brackets are closed and keywords are spelled correctly.",confidence:.7,learnMore:{url:"https://www.w3.org/TR/sparql11-query/",title:"SPARQL Syntax Guide"}}],recoverable:!0},{pattern:/Unknown prefix: ([^\s]+)/i,severity:"error",category:"semantic",title:"Unknown Prefix",getUserMessage:e=>`The prefix '${e[1]}' is not defined. Add a PREFIX declaration at the beginning of your query.`,getSuggestions:e=>[{title:"Add PREFIX Declaration",description:`Add: PREFIX ${e[1]} <http://example.org/${e[1].replace(":","")}#> at the beginning`,confidence:.95,action:{label:"Add PREFIX",handler:()=>{}}}],recoverable:!0},{pattern:/Query timeout after (\d+)ms/i,severity:"warning",category:"system",title:"Query Timeout",getUserMessage:e=>`Your query took longer than ${e[1]}ms and was cancelled. Try simplifying the query or adding limits.`,getSuggestions:()=>[{title:"Add LIMIT Clause",description:"Restrict the number of results with LIMIT 100",confidence:.8,action:{label:"Add LIMIT",handler:()=>{}}},{title:"Optimize Query",description:"Simplify triple patterns or reduce the scope",confidence:.7,learnMore:{url:"https://docs.exocortex.com/query-optimization",title:"Query Optimization Guide"}}],recoverable:!0},{pattern:/Invalid IRI: ([^\s]+)/i,severity:"error",category:"validation",title:"Invalid IRI",getUserMessage:e=>`'${e[1]}' is not a valid IRI. IRIs must be absolute URIs enclosed in angle brackets.`,getSuggestions:e=>{let t=[];return(!e[1].startsWith("<")||!e[1].endsWith(">"))&&t.push({title:"Add Angle Brackets",description:`Enclose the IRI in angle brackets: <${e[1]}>`,confidence:.9}),e[1].includes("://")||t.push({title:"Use Absolute IRI",description:"IRIs must be absolute URLs, e.g., <http://example.org/resource>",confidence:.85}),t},recoverable:!0},{pattern:/Empty result set/i,severity:"info",category:"semantic",title:"No Results Found",getUserMessage:()=>"Your query executed successfully but returned no results. This might be expected, or you may need to adjust your query criteria.",getSuggestions:()=>[{title:"Check Triple Patterns",description:"Ensure your triple patterns match existing data",confidence:.6},{title:"Broaden Search Criteria",description:"Try using more general patterns or OPTIONAL clauses",confidence:.5}],recoverable:!0},{pattern:/Circular reference detected/i,severity:"warning",category:"semantic",title:"Circular Reference",getUserMessage:()=>"A circular reference was detected in your ontology. This may cause infinite loops in reasoning.",getSuggestions:()=>[{title:"Review Ontology Structure",description:"Check for classes that reference themselves directly or indirectly",confidence:.7},{title:"Use Reasoning Limits",description:"Set maximum inference depth to prevent infinite loops",confidence:.8}],recoverable:!0}]});var S,nr=f(()=>{x();Je();S=class{constructor(e,t){this.s=e,this.o=t}get isSuccess(){return this.s.isSuccess}get isFailure(){return this.s.isFailure}get error(){return this.s.error}getValue(){return this.s.getValue()}errorValue(){return this.s.errorValue()}getErrorDetails(){return this.o}static okEnhanced(e){let t=n.ok(e);return new S(t)}static failEnhanced(e){let t,r;typeof e=="string"?(t=e,r=F.create().withTitle("Operation Failed").withMessage(e).withSeverity("error").withCategory("system").withContext({operation:"Unknown",timestamp:new Date}).build()):(t=e.message,r=e);let s=n.fail(t);return new S(s,r)}mapError(e){if(this.isSuccess)return this;let t=this.o||F.create().withMessage(this.error).withSeverity("error").withCategory("system").withContext({operation:"Unknown",timestamp:new Date}).build(),r=e(t);return S.failEnhanced(r)}chain(e){return this.isFailure?S.failEnhanced(this.o||this.error):e(this.getValue())}static combineEnhanced(e){let t=[];for(let r of e)if(r.isFailure){let s=r.getErrorDetails();s&&t.push(s)}if(t.length>0){let r=F.create().withTitle("Multiple Errors Occurred").withMessage(`${t.length} error(s) occurred during operation`).withSeverity("error").withCategory("system").withContext({operation:"Combined Operation",timestamp:new Date,metadata:{errorCount:t.length,errors:t.map(s=>({id:s.id,title:s.title}))}}).withInnerError(t[0]).build();return S.failEnhanced(r)}return S.okEnhanced()}withContext(e){if(this.isSuccess)return this;let t=this.o;if(!t)return this;let r={...t,context:{...t.context,...e}};return S.failEnhanced(r)}}});var Xe,Ct=f(()=>{Xe=(s=>(s[s.DEBUG=0]="DEBUG",s[s.INFO=1]="INFO",s[s.WARN=2]="WARN",s[s.ERROR=3]="ERROR",s))(Xe||{})});var le,bt=f(()=>{Ct();le=class{static createDefault(){return{level:this.getEnvironmentLogLevel(),enabledInProduction:!1,enabledInDevelopment:!0,formatJson:this.isProduction(),includeStackTrace:!this.isProduction(),maxLogSize:1e6,performanceThreshold:100,sensitiveKeys:["password","token","secret","key","auth","credential","private","sensitive"]}}static getEnvironmentLogLevel(){return this.isProduction()?3:this.isTesting()?2:0}static isProduction(){return!0}static isTesting(){return global.jest!==void 0}}});function lr(d,e=0){return(R[d[e+0]]+R[d[e+1]]+R[d[e+2]]+R[d[e+3]]+"-"+R[d[e+4]]+R[d[e+5]]+"-"+R[d[e+6]]+R[d[e+7]]+"-"+R[d[e+8]]+R[d[e+9]]+"-"+R[d[e+10]]+R[d[e+11]]+R[d[e+12]]+R[d[e+13]]+R[d[e+14]]+R[d[e+15]]).toLowerCase()}var R,cr=f(()=>{R=[];for(let d=0;d<256;++d)R.push((d+256).toString(16).slice(1))});function wt(){if(!Et){if(typeof crypto=="undefined"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Et=crypto.getRandomValues.bind(crypto)}return Et(Mr)}var Et,Mr,ur=f(()=>{Mr=new Uint8Array(16)});var Nr,Rt,pr=f(()=>{Nr=typeof crypto!="undefined"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Rt={randomUUID:Nr}});function $r(d,e,t){var s,i,o;if(Rt.randomUUID&&!e&&!d)return Rt.randomUUID();d=d||{};let r=(o=(i=d.random)!=null?i:(s=d.rng)==null?void 0:s.call(d))!=null?o:wt();if(r.length<16)throw new Error("Random bytes length must be >= 16");if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){if(t=t||0,t<0||t+16>e.length)throw new RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let a=0;a<16;++a)e[t+a]=r[a];return e}return lr(r)}var Pt,dr=f(()=>{pr();ur();cr();Pt=$r});var mr=f(()=>{dr()});var re,fr=f(()=>{Ct();bt();mr();re=class{constructor(e=le.createDefault(),t){this.config=e;this.name=t;this.timers=new Map;this.persistentContext={}}debug(e,t){this.shouldLog(0)&&this.log(0,e,t)}info(e,t){this.shouldLog(1)&&this.log(1,e,t)}warn(e,t){this.shouldLog(2)&&this.log(2,e,t)}error(e,t,r){this.shouldLog(3)&&this.log(3,e,t,r)}startTiming(e){this.timers.set(e,performance.now()),this.debug(`Timer started: ${e}`)}endTiming(e,t){let r=this.timers.get(e);if(r===void 0){this.warn(`Timer not found: ${e}`);return}let s=performance.now()-r;this.timers.delete(e);let i={...t,label:e,duration:`${s.toFixed(2)}ms`,durationMs:s};s>this.config.performanceThreshold?this.warn(`Slow operation: ${e}`,i):this.debug(`Timer ended: ${e}`,i)}setCorrelationId(e){this.correlationId=e}getCorrelationId(){return this.correlationId||(this.correlationId=this.generateCorrelationId()),this.correlationId}setLevel(e){this.config.level=e}getLevel(){return this.config.level}createChildLogger(e){let t=new re(this.config,this.name);return t.correlationId=this.correlationId,t.persistentContext={...this.persistentContext,...e},t}shouldLog(e){return this.isLoggingEnabled()?e>=this.config.level:!1}isLoggingEnabled(){return this.config.enabledInProduction}log(e,t,r,s){let i=this.createLogEntry(e,t,r,s);this.config.formatJson?this.outputJson(i):this.outputPretty(i)}createLogEntry(e,t,r,s){let i=this.sanitizeContext({...this.persistentContext,...r,logger:this.name});return{level:e,message:t,timestamp:new Date().toISOString(),context:i,correlationId:this.correlationId||this.generateCorrelationId(),error:s?this.sanitizeError(s):void 0}}sanitizeContext(e){let t={};for(let[r,s]of Object.entries(e))this.isSensitiveKey(r)?t[r]="[REDACTED]":typeof s=="object"&&s!==null?t[r]=this.sanitizeNestedObject(s):t[r]=s;return t}sanitizeNestedObject(e){if(Array.isArray(e))return e.map(r=>typeof r=="object"?this.sanitizeNestedObject(r):r);let t={};for(let[r,s]of Object.entries(e))this.isSensitiveKey(r)?t[r]="[REDACTED]":typeof s=="object"&&s!==null?t[r]=this.sanitizeNestedObject(s):t[r]=s;return t}isSensitiveKey(e){let t=e.toLowerCase();return this.config.sensitiveKeys.some(r=>t.includes(r.toLowerCase()))}sanitizeError(e){return{name:e.name,message:e.message,stack:this.config.includeStackTrace?e.stack:void 0}}generateCorrelationId(){return this.correlationId||(this.correlationId=Pt()),this.correlationId}outputJson(e){if(JSON.stringify(e).length>this.config.maxLogSize){let r={...e,message:e.message.substring(0,this.config.maxLogSize-200),truncated:!0}}}outputPretty(e){var a;let t=new Date(e.timestamp).toLocaleTimeString(),r=Xe[e.level].padEnd(5),s=((a=e.correlationId)==null?void 0:a.substring(0,8))||"unknown",i=`[${t}] ${r} [${s}]`;this.name&&(i+=` [${this.name}]`),i+=` ${e.message}`,e.context&&Object.keys(e.context).length>0&&(i+=` ${JSON.stringify(e.context)}`),this.getConsoleFunction(e.level)(i),e.error&&this.config.includeStackTrace}getConsoleFunction(e){switch(e){case 0:return console.debug;case 1:return console.info;case 2:return console.warn;case 3:return console.error;default:return console.log}}}});var E,Q=f(()=>{fr();bt();E=class{static setConfig(e){this.config=e,this.loggers.clear()}static getConfig(){return this.config}static create(e){if(!e)return new re(this.config);let t=this.loggers.get(e);if(t)return t;let r=new re(this.config,e);return this.loggers.set(e,r),r}static createForClass(e){return this.create(e.name)}static createWithContext(e,t){return this.create(e).createChildLogger(t)}static getLogger(e){return this.loggers.get(e)}static getAllLoggers(){return new Map(this.loggers)}static clearAll(){this.loggers.clear()}};E.config=le.createDefault(),E.loggers=new Map});var ce,gr=f(()=>{Je();ar();nr();Q();ce=class{constructor(e={},t){this.options=e;this.notificationService=t;this.errorHistory=[];this.errorMetrics={totalErrors:0,errorsBySeverity:{["critical"]:0,["error"]:0,["warning"]:0,["info"]:0},errorsByCategory:{["syntax"]:0,["semantic"]:0,["validation"]:0,["system"]:0,["network"]:0,["permission"]:0},averageResolutionTime:0};this.resolutionTimes=[];this.maxHistorySize=100;this.errorStartTimes=new Map;this.logger=E.createForClass(ce),this.options={showUserNotification:!0,logToConsole:!0,trackMetrics:!0,autoRecover:!1,...e}}async handleError(e,t){let r=Date.now();try{let s;return typeof e=="string"?s=Y.analyze(e):e instanceof Error?s=Y.analyze(e):s=e,t&&(s={...s,context:{...s.context,...t}}),this.errorStartTimes.set(s.id,r),this.options.trackMetrics&&this.updateMetrics(s),this.options.logToConsole&&this.logError(s),this.options.showUserNotification&&this.showUserNotification(s),this.addToHistory(s),this.options.autoRecover&&s.recoverable&&await this.attemptRecovery(s),S.okEnhanced()}catch(s){return this.logger.error("Error in error handler",{stage:"handling"},s),S.failEnhanced(F.create().withTitle("Error Handler Failed").withMessage("Failed to handle the error properly").withSeverity("critical").withCategory("system").withContext({operation:"Error Handling",timestamp:new Date}).withTechnicalDetails(s instanceof Error?s.message:String(s)).build())}}markErrorResolved(e){let t=this.errorStartTimes.get(e);if(t){let r=Date.now()-t;this.resolutionTimes.push(r),this.resolutionTimes.length>100&&this.resolutionTimes.shift(),this.errorMetrics.averageResolutionTime=this.resolutionTimes.reduce((s,i)=>s+i,0)/this.resolutionTimes.length,this.errorStartTimes.delete(e)}}updateMetrics(e){this.errorMetrics.totalErrors++,this.errorMetrics.errorsBySeverity[e.severity]++,this.errorMetrics.errorsByCategory[e.category]++,this.errorMetrics.lastError=e}logError(e){var s,i;let t=this.getLogLevel(e.severity),r={errorId:e.id,category:e.category,severity:e.severity,operation:(s=e.context)==null?void 0:s.operation,recoverable:e.recoverable,technicalDetails:e.technicalDetails,suggestions:((i=e.suggestions)==null?void 0:i.length)||0};switch(t){case"error":this.logger.error(e.title+": "+e.message,r,e.technicalDetails?new Error(e.technicalDetails):void 0);break;case"warn":this.logger.warn(e.title+": "+e.message,r);break;case"info":this.logger.info(e.title+": "+e.message,r);break;default:this.logger.debug(e.title+": "+e.message,r)}}getLogLevel(e){switch(e){case"critical":case"error":return"error";case"warning":return"warn";case"info":return"info";default:return"log"}}formatErrorForConsole(e){let t=[`[${e.severity.toUpperCase()}]`,`[${e.category}]`,e.title,"-",e.message];return e.context.location&&typeof e.context.location=="object"&&"line"in e.context.location&&t.push(`(Line ${e.context.location.line}:${e.context.location.column})`),t.join(" ")}showUserNotification(e){var s;let t=this.getNotificationDuration(e.severity),r=this.formatErrorForUser(e);(s=this.notificationService)==null||s.showError(r,t)}getNotificationDuration(e){switch(e){case"critical":return 1e4;case"error":return 7e3;case"warning":return 5e3;case"info":return 3e3;default:return 5e3}}formatErrorForUser(e){let t=`${e.title}: ${e.message}`;if(e.suggestions&&e.suggestions.length>0){let r=e.suggestions[0];t+=`

\u{1F4A1} ${r.title}`}return t}addToHistory(e){this.errorHistory.unshift(e),this.errorHistory.length>this.maxHistorySize&&this.errorHistory.pop()}async attemptRecovery(e){var r;if(!e.suggestions||e.suggestions.length===0)return;let t=e.suggestions.find(s=>s.confidence&&s.confidence>.9&&s.action);if(t&&t.action)try{await t.action.handler(),(r=this.notificationService)==null||r.showSuccess(`Auto-recovery: ${t.title}`,3e3)}catch(s){this.logger.error("Auto-recovery failed",{errorId:e.id,suggestionTitle:t.title,confidence:t.confidence},s)}}getMetrics(){return{...this.errorMetrics}}getErrorHistory(){return[...this.errorHistory]}clearHistory(){this.errorHistory=[],this.errorStartTimes.clear()}getSuggestions(e){return Y.analyze(e).suggestions||[]}analyzeError(e){return Y.analyze(e)}}});var Ze,hr=f(()=>{Ze=class{constructor(){}async provisionOntology(e){}async ensureOntologyExists(e){await this.checkOntologyExists(e)||await this.provisionOntology(e)}async checkOntologyExists(e){return!1}async getOntologyMetadata(e){return{prefix:e,uri:`http://example.org/${e}#`,label:`${e} Ontology`,description:`Ontology for ${e} domain`}}}});var q,yr=f(()=>{q=class{constructor(){this.cache=new Map}static getInstance(){return q.instance||(q.instance=new q),q.instance}get(e){return this.cache.get(e)}set(e,t){this.cache.set(e,t)}has(e){return this.cache.has(e)}clear(){this.cache.clear()}invalidate(e){Array.from(this.cache.keys()).forEach(r=>{r.includes(e)&&this.cache.delete(r)})}getSize(){return this.cache.size}}});var W,vr=f(()=>{W=class{constructor(){this.failures=new Map;this.lastFailureTime=new Map;this.circuitOpen=new Map;this.threshold=5;this.timeout=6e4}static getInstance(){return W.instance||(W.instance=new W),W.instance}async execute(e,t){if(this.isOpen(e))throw new Error(`Circuit breaker is open for ${e}`);try{let r=await t();return this.onSuccess(e),r}catch(r){throw this.onFailure(e),r}}isOpen(e){if(!this.circuitOpen.get(e))return!1;let t=this.lastFailureTime.get(e)||0;return Date.now()-t>this.timeout?(this.reset(e),!1):!0}onSuccess(e){this.failures.delete(e),this.circuitOpen.set(e,!1)}onFailure(e){let t=(this.failures.get(e)||0)+1;this.failures.set(e,t),this.lastFailureTime.set(e,Date.now()),t>=this.threshold&&this.circuitOpen.set(e,!0)}reset(e){this.failures.delete(e),this.lastFailureTime.delete(e),this.circuitOpen.set(e,!1)}getStatus(e){return{isOpen:this.circuitOpen.get(e)||!1,failures:this.failures.get(e)||0}}}});var N,et,At,xr=f(()=>{N=require("obsidian"),et=class{constructor(e,t,r){this.app=e;this.renderButtonsUseCase=t;this.executeCommandUseCase=r}async render(e,t,r,s){let i=await this.renderButtonsUseCase.execute({className:t,assetId:r,context:s});if(i.isFailure)return;let o=i.getValue();if(!o.displayOptions.showButtons||o.buttons.length===0)return;let a=e.createDiv({cls:`exocortex-button-container exocortex-buttons-${o.displayOptions.position}`});for(let l of o.buttons)this.renderButton(a,l,r,s)}renderButton(e,t,r,s){let i=new N.ButtonComponent(e).setButtonText(t.label).onClick(async()=>{await this.handleButtonClick(t,r,s)});t.tooltip&&i.setTooltip(t.tooltip),t.isEnabled||i.setDisabled(!0),i.buttonEl.addClass("exocortex-ui-button"),i.buttonEl.setAttribute("data-button-id",t.buttonId),i.buttonEl.setAttribute("data-order",t.order.toString())}async handleButtonClick(e,t,r){let s=await this.executeCommandUseCase.execute({buttonId:e.buttonId,assetId:t,context:r});if(s.isFailure){this.showNotification(`Error: ${s.error}`,"error");return}let i=s.getValue();i.requiresInput&&i.inputSchema?new At(this.app,i.inputSchema,async a=>{let l=await this.executeCommandUseCase.execute({buttonId:e.buttonId,assetId:t,inputParameters:a,context:r});if(l.isFailure)this.showNotification(`Error: ${l.error}`,"error");else{let c=l.getValue();c.success&&this.showNotification(c.message||"Command executed successfully","success")}}).open():i.success&&this.showNotification(i.message||"Command executed successfully","success")}showNotification(e,t){new N.Notice(e,t==="error"?5e3:3e3)}},At=class extends N.Modal{constructor(t,r,s){super(t);this.schema=r;this.onSubmit=s;this.inputValues={}}onOpen(){let{contentEl:t}=this;t.createEl("h2",{text:this.schema.title}),this.schema.description&&t.createEl("p",{text:this.schema.description,cls:"exocortex-modal-description"});let r=t.createDiv({cls:"exocortex-command-form"});for(let i of this.schema.parameters)this.createParameterInput(r,i);let s=t.createDiv({cls:"modal-button-container"});new N.Setting(s).addButton(i=>i.setButtonText("Cancel").onClick(()=>this.close())).addButton(i=>i.setButtonText("Execute").setCta().onClick(()=>{let o=this.validateInputs();if(o.length>0){this.showErrors(o);return}this.onSubmit(this.inputValues),this.close()}))}createParameterInput(t,r){let s=new N.Setting(t).setName(r.label||r.name).setDesc(r.description||"");switch(r.required&&s.nameEl.createSpan({text:" *",cls:"required-indicator"}),r.type){case"string":s.addText(i=>{i.setPlaceholder(r.label||r.name),r.defaultValue&&(i.setValue(r.defaultValue),this.inputValues[r.name]=r.defaultValue),i.onChange(o=>{this.inputValues[r.name]=o})});break;case"number":s.addText(i=>{i.inputEl.type="number",r.defaultValue!==void 0&&(i.setValue(String(r.defaultValue)),this.inputValues[r.name]=r.defaultValue),i.onChange(o=>{this.inputValues[r.name]=Number(o)})});break;case"boolean":s.addToggle(i=>{r.defaultValue!==void 0&&(i.setValue(r.defaultValue),this.inputValues[r.name]=r.defaultValue),i.onChange(o=>{this.inputValues[r.name]=o})});break;case"date":s.addText(i=>{i.inputEl.type="date",r.defaultValue&&(i.setValue(r.defaultValue),this.inputValues[r.name]=r.defaultValue),i.onChange(o=>{this.inputValues[r.name]=o})});break;case"asset":s.addText(i=>{i.setPlaceholder("[[Asset Name]]"),r.defaultValue&&(i.setValue(r.defaultValue),this.inputValues[r.name]=r.defaultValue),i.onChange(o=>{o&&!o.startsWith("[[")&&(o=`[[${o}]]`),this.inputValues[r.name]=o})});break;case"array":s.addTextArea(i=>{if(i.setPlaceholder("One item per line"),r.defaultValue){let o=Array.isArray(r.defaultValue)?r.defaultValue.join(`
`):r.defaultValue;i.setValue(o),this.inputValues[r.name]=r.defaultValue}i.onChange(o=>{this.inputValues[r.name]=o.split(`
`).filter(a=>a.trim())})});break;default:s.addText(i=>{i.onChange(o=>{this.inputValues[r.name]=o})})}}validateInputs(){let t=[];for(let r of this.schema.parameters){if(r.required){let s=this.inputValues[r.name];(s==null||s==="")&&t.push(`${r.label||r.name} is required`)}if(r.validation&&this.inputValues[r.name])try{new RegExp(r.validation).test(String(this.inputValues[r.name]))||t.push(`${r.label||r.name} format is invalid`)}catch(s){}}return t}showErrors(t){let r=`Please fix the following errors:
`+t.join(`
`);new N.Notice(r,5e3)}onClose(){let{contentEl:t}=this;t.empty()}}});var C,ue,Tt=f(()=>{C=require("obsidian"),ue=class{constructor(e,t){this.app=e;this.propertyEditingUseCase=t;this.editingProperty=null;this.originalValues=new Map;this.propertyInputs=new Map}async renderPropertiesBlock(e,t,r,s){let i=await this.propertyEditingUseCase.getPropertiesForClass(r);if(i.isFailure){e.createEl("div",{text:"Failed to load properties",cls:"exocortex-error-message"});return}let o=i.getValue(),a=e.createDiv({cls:"exocortex-properties-editable"});for(let c of o)this.renderProperty(a,t,c,s[c.propertyName]);let l=new Set(o.map(c=>c.propertyName));for(let[c,u]of Object.entries(s))!l.has(c)&&!c.startsWith("exo__")&&this.renderCustomProperty(a,t,c,u)}renderProperty(e,t,r,s){let i=e.createDiv({cls:"exocortex-property-item"}),o=i.createDiv({cls:"exocortex-property-label"});o.createSpan({text:r.label||r.propertyName}),r.isRequired&&o.createSpan({text:" *",cls:"required-indicator"});let a=i.createDiv({cls:"exocortex-property-value"});this.editingProperty===r.propertyName?this.renderEditControl(a,t,r,s):this.renderReadOnlyValue(a,t,r,s),r.description&&i.createDiv({text:r.description,cls:"exocortex-property-description"})}renderReadOnlyValue(e,t,r,s){let i=e.createDiv({cls:"exocortex-property-value-readonly"}),o=this.formatDisplayValue(s,r.type||r.range);i.createSpan({text:o||"(empty)"});let a=i.createSpan({cls:"exocortex-edit-icon",text:"\u270F\uFE0F"});i.addEventListener("click",()=>{this.enterEditMode(e,t,r,s)}),i.tabIndex=0,i.addEventListener("keydown",l=>{(l.key==="Enter"||l.key===" ")&&(l.preventDefault(),this.enterEditMode(e,t,r,s))})}enterEditMode(e,t,r,s){this.originalValues.set(r.propertyName,s),this.editingProperty=r.propertyName,e.empty(),this.renderEditControl(e,t,r,s)}renderEditControl(e,t,r,s){var o;let i=e.createDiv({cls:"exocortex-edit-control"});r.isObjectProperty?this.renderObjectPropertyDropdown(i,t,r,s):(o=r.range)!=null&&o.startsWith("enum:")?this.renderEnumDropdown(i,t,r,s):r.range==="boolean"?this.renderBooleanToggle(i,t,r,s):r.range==="date"?this.renderDateInput(i,t,r,s):r.range==="number"?this.renderNumberInput(i,t,r,s):r.range==="text"||r.range==="description"?this.renderTextArea(i,t,r,s):r.range==="array"?this.renderArrayInput(i,t,r,s):this.renderTextInput(i,t,r,s),this.renderEditActions(i,t,r)}async renderObjectPropertyDropdown(e,t,r,s){var a;let i=new C.DropdownComponent(e),o=(a=r.range)==null?void 0:a.replace(/\[\[|\]\]/g,"");if(o){let l=await this.propertyEditingUseCase.getAssetsForClass(o);if(l.isSuccess){let c=l.getValue();i.addOption("","-- Select --");for(let u of c){let p=`[[${u.fileName}]]`,m=u.label!==u.fileName?`${u.label} (${u.fileName})`:u.fileName;i.addOption(p,m)}}}s&&i.setValue(s),this.propertyInputs.set(r.propertyName,i),i.selectEl.focus()}renderEnumDropdown(e,t,r,s){let i=new C.DropdownComponent(e),o=r.range.substring(5).split(",");i.addOption("","-- Select --");for(let a of o)i.addOption(a.trim(),a.trim());s&&i.setValue(s),this.propertyInputs.set(r.propertyName,i),i.selectEl.focus()}renderTextInput(e,t,r,s){let i=new C.TextComponent(e);i.setValue(s||""),this.propertyInputs.set(r.propertyName,i),i.inputEl.focus(),i.inputEl.select(),i.inputEl.addEventListener("keydown",o=>{o.key==="Enter"?(o.preventDefault(),this.saveProperty(t,r)):o.key==="Escape"&&(o.preventDefault(),this.cancelEdit(e,t,r))})}renderEditActions(e,t,r){let s=e.createDiv({cls:"exocortex-edit-actions"});new C.ButtonComponent(s).setIcon("check").setTooltip("Save (Enter)").onClick(()=>this.saveProperty(t,r)),new C.ButtonComponent(s).setIcon("x").setTooltip("Cancel (Escape)").onClick(()=>this.cancelEdit(e,t,r))}async saveProperty(e,t){let r=this.propertyInputs.get(t.propertyName);if(!r)return;let s;(r instanceof C.TextComponent||r instanceof C.DropdownComponent||r instanceof C.ToggleComponent)&&(s=r.getValue());let i=await this.propertyEditingUseCase.execute({assetId:e,propertyName:t.propertyName,value:s,propertyDefinition:t});i.isSuccess?(this.editingProperty=null,this.propertyInputs.delete(t.propertyName),this.originalValues.delete(t.propertyName),new C.Notice("Property updated",1e3)):new C.Notice(`Error: ${i.error}`,3e3)}cancelEdit(e,t,r){let s=this.originalValues.get(r.propertyName);this.editingProperty=null,this.propertyInputs.delete(r.propertyName),this.originalValues.delete(r.propertyName),e.empty(),this.renderReadOnlyValue(e,t,r,s)}formatDisplayValue(e,t){return e==null?"":Array.isArray(e)?e.join(", "):typeof e=="boolean"?e?"\u2713":"\u2717":String(e)}renderCustomProperty(e,t,r,s){let i={propertyName:r,label:r,range:"string",isRequired:!1,description:"Custom property"};this.renderProperty(e,t,i,s)}renderBooleanToggle(e,t,r,s){let i=new C.ToggleComponent(e);i.setValue(s||!1),this.propertyInputs.set(r.propertyName,i)}renderDateInput(e,t,r,s){let i=new C.TextComponent(e);i.inputEl.type="date",i.setValue(s||""),this.propertyInputs.set(r.propertyName,i),i.inputEl.focus()}renderNumberInput(e,t,r,s){let i=new C.TextComponent(e);i.inputEl.type="number",i.setValue(String(s||"")),this.propertyInputs.set(r.propertyName,i),i.inputEl.focus()}renderTextArea(e,t,r,s){let i=new C.TextAreaComponent(e);i.setValue(s||""),this.propertyInputs.set(r.propertyName,i),i.inputEl.focus()}renderArrayInput(e,t,r,s){let i=e.createDiv({cls:"exocortex-array-input"}),o=Array.isArray(s)?s:[];o.forEach((a,l)=>{let c=i.createDiv({cls:"array-item"});new C.TextComponent(c).setValue(a),new C.ButtonComponent(c).setIcon("x").onClick(()=>{o.splice(l,1),this.renderArrayInput(e,t,r,o)})}),new C.ButtonComponent(i).setButtonText("Add item").onClick(()=>{o.push(""),this.renderArrayInput(e,t,r,o)}),this.propertyInputs.set(r.propertyName,{values:o})}}});var se,Cr=f(()=>{X();x();se=class extends P{get targetClass(){return this.props.targetClass}get displayProperties(){return this.props.displayProperties}get priority(){return this.props.priority}get enabled(){return this.props.enabled}static create(e,t){if(!e.targetClass||e.targetClass.trim().length===0)return n.fail("Target class is required");if(!e.displayProperties||e.displayProperties.length===0)return n.fail("At least one display property is required");for(let s of e.displayProperties)if(!this.isValidPropertyReference(s))return n.fail(`Invalid property reference format: ${s}. Use [[property_name]] format`);let r=new se(e,t);return n.ok(r)}static isValidPropertyReference(e){return/^\[\[[\w_]+\]\]$/.test(e)}extractPropertyName(e){return e.replace(/\[\[|\]\]/g,"")}getPropertyNames(){return this.displayProperties.map(e=>this.extractPropertyName(e))}addProperty(e){return se.isValidPropertyReference(e)?this.props.displayProperties.includes(e)?n.fail("Property already exists in display list"):(this.props.displayProperties.push(e),n.ok()):n.fail("Invalid property reference format")}removeProperty(e){let t=this.props.displayProperties.indexOf(e);return t===-1?n.fail("Property not found in display list"):(this.props.displayProperties.splice(t,1),n.ok())}reorderProperties(e){if(e.length!==this.props.displayProperties.length)return n.fail("New order must contain all existing properties");for(let t of e)if(!this.props.displayProperties.includes(t))return n.fail(`Property ${t} not found in current list`);return this.props.displayProperties=e,n.ok()}setPriority(e){return e<0?n.fail("Priority must be non-negative"):(this.props.priority=e,n.ok())}setEnabled(e){this.props.enabled=e}inferFormatType(e){let t=e.toLowerCase();return t.includes("status")||t.includes("state")?"status-badge":t.includes("date")||t.includes("time")?"date":t.includes("assignee")||t.includes("owner")||t.includes("user")?"link":"raw"}}});var tt,br=f(()=>{x();tt=class{constructor(e,t){this.vaultAdapter=e;this.uiAdapter=t}async discoverPropertyBasedBacklinks(e,t={}){var r;try{let s=new Map,i=await this.vaultAdapter.getFiles();for(let a of i){if(a.path===e.path)continue;let l=await this.vaultAdapter.getFileMetadata(a);if(l&&!(t.filterByClass&&this.uiAdapter.cleanClassName(l.exo__Instance_class)!==t.filterByClass))for(let[c,u]of Object.entries(l))(r=t.excludeProperties)!=null&&r.includes(c)||await this.isReferencingTarget(u,e)&&(s.has(c)||s.set(c,[]),s.get(c).push(a))}let o=[];for(let[a,l]of s.entries()){let c=t.maxResultsPerProperty?l.slice(0,t.maxResultsPerProperty):l;o.push({propertyName:a,referencingFiles:c})}return o.sort((a,l)=>a.propertyName.localeCompare(l.propertyName)),n.ok(o)}catch(s){return n.fail(`Failed to discover backlinks: ${s}`)}}async isReferencingTarget(e,t){var a;if(!e)return!1;if(Array.isArray(e)){for(let l of e)if(await this.isReferencingTarget(l,t))return!0;return!1}let r=e.toString(),s=t.basename||((a=t.name)==null?void 0:a.replace(/\.[^/.]+$/,""))||"",i=await this.vaultAdapter.getFileMetadata(t),o=(i==null?void 0:i.exo__Asset_uid)||null;if(r===s||r.includes(`[[${s}]]`)||r.includes(`[[${s}|`))return!0;if(r.startsWith("[[")&&r.endsWith("]]")){let l=r.slice(2,-2).split("|")[0];if(this.vaultAdapter.resolveLinkToFile)try{let c=await this.vaultAdapter.resolveLinkToFile(l);if(c&&c.path===t.path)return!0}catch(c){}if(l===s||s.includes(l)||l.includes(s))return!0}return!!(o&&r.includes(o)||r.includes(s))}cleanClassName(e){if(!e)return"";let t=Array.isArray(e)?e[0]:e;return(t==null?void 0:t.toString().replace(/\[\[|\]\]/g,""))||""}}});var rt,Er=f(()=>{br();ht();gt();rt=class{constructor(e){this.app=e;let t=new ae(this.app.vault,this.app.metadataCache),r=new oe(this.app);this.dynamicBacklinksService=new tt(t,r)}async render(e,t,r,s){let i=await this.dynamicBacklinksService.discoverPropertyBasedBacklinks(r,{excludeProperties:t.excludeProperties||["exo__Asset_id","exo__Instance_class"],maxResultsPerProperty:t.maxResultsPerProperty,filterByClass:t.filterByClass});if(i.isFailure){e.createEl("p",{text:`Error discovering backlinks: ${i.getError()}`,cls:"exocortex-error"});return}let o=i.getValue();if(o.length===0){e.createEl("p",{text:"No property-based backlinks found",cls:"exocortex-empty"});return}for(let a of o)!t.showEmptyProperties&&a.referencingFiles.length===0||await this.renderPropertyGroup(e,a,t)}async renderPropertyGroup(e,t,r){let s=e.createDiv({cls:"exocortex-dynamic-backlinks-group"}),i=s.createEl("h4",{text:`${this.formatPropertyName(t.propertyName)} (${t.referencingFiles.length})`,cls:"exocortex-property-backlinks-header"});if(t.referencingFiles.length===0){s.createEl("p",{text:"No files reference this asset via this property",cls:"exocortex-empty"});return}let o=s.createEl("ul",{cls:"exocortex-property-backlinks-list"});for(let a of t.referencingFiles)await this.renderBacklinkItem(o,a)}async renderBacklinkItem(e,t){let r=this.app.metadataCache.getFileCache(t),s=(r==null?void 0:r.frontmatter)||{},i=e.createEl("li",{cls:"exocortex-backlink-item"}),o=i.createEl("a",{text:s.exo__Asset_label||t.basename,href:t.path,cls:"internal-link"}),a=s.exo__Instance_class;if(a){let l=i.createEl("span",{text:` (${this.cleanClassName(a)})`,cls:"exocortex-class-info"})}if(t.path!==`${t.basename}.md`){let l=i.createEl("span",{text:` - ${t.path}`,cls:"exocortex-path-info"})}}formatPropertyName(e){return e.replace(/^ems__/,"").replace(/^exo__/,"").replace(/_/g," ").replace(/\b\w/g,t=>t.toUpperCase())}cleanClassName(e){if(!e)return"";let t=Array.isArray(e)?e[0]:e;return(t==null?void 0:t.toString().replace(/\[\[|\]\]/g,""))||""}}});var st,wr=f(()=>{st=class{constructor(e){this.app=e}async render(e,t,r,s){try{let i=await this.getRelatedAssets(r,t);if(i.length===0){e.createEl("p",{text:"No related assets found",cls:"exocortex-empty"});return}let o=this.filterByClass(i,t.targetClass),a=this.sortAssets(o,t),l=t.maxResults?a.slice(0,t.maxResults):a;t.groupByProperty?await this.renderGroupedProperties(e,l,t):t.tableFormat?await this.renderPropertyTable(e,l,t):await this.renderPropertyList(e,l,t),t.maxResults&&a.length>t.maxResults&&e.createEl("p",{text:`Showing ${t.maxResults} of ${a.length} results`,cls:"exocortex-results-info"})}catch(i){e.createEl("p",{text:"Error rendering relation properties",cls:"exocortex-error"})}}async getRelatedAssets(e,t){let r=this.app.metadataCache.getBacklinksForFile(e),s=[];if(!(r!=null&&r.data))return s;for(let[i]of r.data){let o=this.app.vault.getAbstractFileByPath(i);if(o!=null&&o.path){let a=this.app.metadataCache.getFileCache(o);if(a!=null&&a.frontmatter){let l=this.findReferencingProperty(a.frontmatter,e);s.push({file:o,frontmatter:a.frontmatter,referencingProperty:l})}}}return s}findReferencingProperty(e,t){let r=t.basename,s=t.path;for(let[i,o]of Object.entries(e)){if(!o)continue;let a=Array.isArray(o)?o.join(" "):String(o);if(a.includes(`[[${r}]]`)||a.includes(`[[${s}]]`)||a.includes(`[[${s.replace(".md","")}]]`)||a.includes(`[[${r}|`)||a.includes(`[[${s}|`)||a.includes(`[[${s.replace(".md","")}|`))return i}}filterByClass(e,t){return t?e.filter(r=>{let s=r.frontmatter.exo__Instance_class;return this.cleanClassName(s)===this.cleanClassName(t)}):e}sortAssets(e,t){return t.sortBy?[...e].sort((r,s)=>{let i=r.frontmatter[t.sortBy.property],o=s.frontmatter[t.sortBy.property];if(i===void 0&&o===void 0)return 0;if(i===void 0)return 1;if(o===void 0)return-1;let a=String(i).localeCompare(String(o));return t.sortBy.direction==="desc"?-a:a}):e}async renderPropertyTable(e,t,r){let s=e.createEl("table",{cls:"exocortex-relation-properties-table"}),o=s.createEl("thead").createEl("tr");r.showAssetName!==!1&&o.createEl("th",{text:"Asset",cls:"exocortex-table-header-asset"});let a=r.displayProperties.filter(c=>c.isVisible);a.forEach(c=>{let u=o.createEl("th",{text:c.displayLabel||this.formatPropertyName(c.propertyName),cls:"exocortex-table-header-property"});c.columnWidth&&(u.style.width=c.columnWidth),c.alignment&&(u.style.textAlign=c.alignment)});let l=s.createEl("tbody");t.forEach(c=>{let u=l.createEl("tr",{cls:"exocortex-property-row"});if(r.showAssetName!==!1){let p=u.createEl("td",{cls:"exocortex-table-cell-asset"}),m=c.frontmatter.exo__Asset_label||c.file.basename;if(p.createEl("a",{text:m,href:c.file.path,cls:"internal-link"}).addEventListener("click",h=>{h.preventDefault(),this.app.workspace.openLinkText(c.file.path,"",!1)}),r.showAssetClass){let h=c.frontmatter.exo__Instance_class;h&&p.createEl("div",{text:this.cleanClassName(h),cls:"exocortex-class-info-subtitle"})}}a.forEach(p=>{let m=u.createEl("td",{cls:"exocortex-table-cell-property"});p.alignment&&(m.style.textAlign=p.alignment);let g=c.frontmatter[p.propertyName];this.renderPropertyValue(m,g,p)})})}async renderPropertyList(e,t,r){let s=e.createEl("div",{cls:"exocortex-relation-properties-list"});t.forEach(i=>{let o=s.createEl("div",{cls:"exocortex-property-list-item"});if(r.showAssetName!==!1){let c=i.frontmatter.exo__Asset_label||i.file.basename;if(o.createEl("a",{text:c,href:i.file.path,cls:"internal-link exocortex-property-list-asset"}).addEventListener("click",p=>{p.preventDefault(),this.app.workspace.openLinkText(i.file.path,"",!1)}),r.showAssetClass){let p=i.frontmatter.exo__Instance_class;p&&o.createEl("span",{text:` (${this.cleanClassName(p)})`,cls:"exocortex-class-info-inline"})}}let a=o.createEl("div",{cls:"exocortex-property-list-properties"});r.displayProperties.filter(c=>c.isVisible).forEach(c=>{let u=a.createEl("div",{cls:"exocortex-property-list-property"});u.createEl("span",{text:`${c.displayLabel||this.formatPropertyName(c.propertyName)}: `,cls:"exocortex-property-label"});let p=u.createEl("span",{cls:"exocortex-property-value"}),m=i.frontmatter[c.propertyName];this.renderPropertyValue(p,m,c)})})}async renderGroupedProperties(e,t,r){if(!r.groupByProperty)return;let s=new Map;t.forEach(o=>{let a=o.frontmatter[r.groupByProperty]||"Ungrouped",l=this.cleanClassName(a);s.has(l)||s.set(l,[]),s.get(l).push(o)});let i=Array.from(s.entries()).sort(([o],[a])=>o.localeCompare(a));for(let[o,a]of i){let l=e.createEl("div",{cls:"exocortex-property-group"});l.createEl("h4",{text:o,cls:"exocortex-property-group-header"}),r.tableFormat?await this.renderPropertyTable(l,a,r):await this.renderPropertyList(l,a,r)}}renderPropertyValue(e,t,r){if(!t){e.createEl("span",{text:"-",cls:"exocortex-property-empty"});return}let s=Array.isArray(t)?t[0]:t;if(!s){e.createEl("span",{text:"-",cls:"exocortex-property-empty"});return}switch(r.formatType){case"status-badge":this.renderStatusBadge(e,s);break;case"date":this.renderDate(e,s);break;case"link":this.renderLink(e,s);break;case"custom":if(r.customFormatter)try{let i=new Function("value",r.customFormatter)(s);e.createEl("span",{text:String(i),cls:"exocortex-property-custom"})}catch(i){this.renderRaw(e,s)}else this.renderRaw(e,s);break;case"raw":default:this.renderRaw(e,s);break}}renderStatusBadge(e,t){let r=this.cleanClassName(t),s=r.toLowerCase().replace(/\s+/g,"-");e.createEl("span",{text:r||"Unknown",cls:`exocortex-status-badge exocortex-status-${s}`})}renderDate(e,t){try{let r=new Date(t);isNaN(r.getTime())?this.renderRaw(e,t):e.createEl("span",{text:r.toLocaleDateString(),cls:"exocortex-property-date"})}catch(r){this.renderRaw(e,t)}}renderLink(e,t){let r=this.cleanClassName(t);e.createEl("a",{text:r,href:r,cls:"internal-link exocortex-property-link"}).addEventListener("click",i=>{i.preventDefault(),this.app.workspace.openLinkText(r,"",!1)})}renderRaw(e,t){e.createEl("span",{text:String(t),cls:"exocortex-property-raw"})}cleanClassName(e){if(!e)return"";let t=Array.isArray(e)?e[0]:e;return(t==null?void 0:t.toString().replace(/\[\[|\]\]/g,""))||""}formatPropertyName(e){return e.replace(/_/g," ").replace(/^[a-z]+\s+/,"").split(" ").map(t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()).join(" ")}}});var it,Rr=f(()=>{it=class{constructor(e){this.app=e}async render(e,t,r){try{let s=await this.getRelatedAssets(r,t.targetClass);if(s.length===0){e.createEl("p",{text:"No related assets found",cls:"exocortex-empty"});return}this.renderTable(e,s,t)}catch(s){e.createEl("p",{text:"Error displaying properties",cls:"exocortex-error"})}}async getRelatedAssets(e,t){let r=this.app.metadataCache.getBacklinksForFile(e),s=[];if(!(r!=null&&r.data))return s;for(let[i]of r.data){let o=this.app.vault.getAbstractFileByPath(i);if(o!=null&&o.path){let a=this.app.metadataCache.getFileCache(o);if(a!=null&&a.frontmatter){if(t){let l=a.frontmatter.exo__Instance_class;if(this.cleanValue(l)!==this.cleanValue(t))continue}s.push({file:o,frontmatter:a.frontmatter})}}}return s}renderTable(e,t,r){let s=e.createEl("table",{cls:"exocortex-simplified-table"}),o=s.createEl("thead").createEl("tr");o.createEl("th",{text:"Asset",cls:"exocortex-table-header"});let a=r.getPropertyNames();a.forEach(c=>{o.createEl("th",{text:this.formatPropertyLabel(c),cls:"exocortex-table-header"})});let l=s.createEl("tbody");t.forEach(c=>{let u=l.createEl("tr",{cls:"exocortex-table-row"}),p=u.createEl("td",{cls:"exocortex-table-cell-asset"}),m=c.frontmatter.exo__Asset_label||c.file.basename;p.createEl("a",{text:m,href:c.file.path,cls:"internal-link"}).addEventListener("click",h=>{h.preventDefault(),this.app.workspace.openLinkText(c.file.path,"",!1)}),a.forEach(h=>{let V=u.createEl("td",{cls:"exocortex-table-cell"}),Ie=c.frontmatter[h],M=r.inferFormatType(h);this.renderPropertyValue(V,Ie,M)})})}renderPropertyValue(e,t,r){if(!t){e.createEl("span",{text:"-",cls:"exocortex-empty-value"});return}let s=Array.isArray(t)?t[0]:t;switch(r){case"status-badge":{let i=this.cleanValue(s),o=this.getStatusClass(i);e.createEl("span",{text:i,cls:`exocortex-status-badge ${o}`});break}case"date":{try{let i=new Date(s);isNaN(i.getTime())?e.createEl("span",{text:String(s)}):e.createEl("span",{text:i.toLocaleDateString(),cls:"exocortex-date-value"})}catch(i){e.createEl("span",{text:String(s)})}break}case"link":{let i=this.cleanValue(s);e.createEl("a",{text:i,href:i,cls:"internal-link"}).addEventListener("click",a=>{a.preventDefault(),this.app.workspace.openLinkText(i,"",!1)});break}default:e.createEl("span",{text:this.cleanValue(s)});break}}cleanValue(e){if(!e)return"";let t=Array.isArray(e)?e[0]:e;return(t==null?void 0:t.toString().replace(/\[\[|\]\]/g,""))||""}formatPropertyLabel(e){return e.replace(/^[a-z]+__/,"").replace(/_/g," ").split(" ").map(t=>t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()).join(" ")}getStatusClass(e){let t=e.toLowerCase();return["completed","done","success"].includes(t)?"exocortex-status-green":["in-progress","active","running"].includes(t)?"exocortex-status-yellow":["blocked","failed","error"].includes(t)?"exocortex-status-red":["pending","waiting","todo"].includes(t)?"exocortex-status-blue":"exocortex-status-default"}}});var ot,Pr=f(()=>{G();x();ot=class{constructor(e){this.layoutRepository=e}async execute(e){try{let t=b.create(e.className);if(t.isFailure)return n.fail(`Invalid class name: ${t.error}`);let r=t.getValue(),s=e.includeDisabled?await this.layoutRepository.findByClass(r):await this.layoutRepository.findEnabledByClass(r);if(s.length>0)return n.ok({layout:s[0],fallbackUsed:!1});let i=await this.findParentClassLayout(r);return i?n.ok({layout:i,fallbackUsed:!0}):n.ok({layout:null,fallbackUsed:!0})}catch(t){return n.fail(`Failed to get layout for class: ${t}`)}}async findParentClassLayout(e){let t=this.getParentClasses(e.value);for(let r of t){let s=b.create(r);if(s.isFailure)continue;let i=await this.layoutRepository.findEnabledByClass(s.getValue());if(i.length>0)return i[0]}return null}getParentClasses(e){return{ems__Project:["ems__Effort","exo__Asset"],ems__Task:["ems__Effort","exo__Asset"],ems__Area:["exo__Asset"],ems__Goal:["exo__Asset"],ems__Effort:["exo__Asset"]}[e]||["exo__Asset"]}}});var pe,It=f(()=>{Cr();Er();wr();Rr();Pr();pe=class{constructor(e,t){this.app=e;this.getLayoutUseCase=new ot(t),this.dynamicBacklinksRenderer=new rt(e),this.relationPropertiesRenderer=new st(e),this.simplifiedPropertiesRenderer=new it(e)}async renderLayout(e,t,r,s){if((e===null||e&&typeof e=="object"&&!("path"in e))&&t&&"appendChild"in t){let g=e,h=t;if(!g)return;this.renderLayoutDirect(g,h);return}let i=e,o=t;if(!i)return;if(!r||!r.frontmatter){let g=document.createElement("p");g.textContent="No metadata available for this file",g.className="exocortex-error",i.appendChild(g);return}let l=r.frontmatter.exo__Instance_class;if(!l){this.renderError(i,"No instance class defined");return}let c=this.cleanClassName(l),u=await this.getLayoutUseCase.execute({className:c});if(u.isFailure){this.renderError(i,u.error);return}let{layout:p,fallbackUsed:m}=u.getValue();if(!p){await this.renderDefaultLayout(i,o,r,s);return}await this.renderCustomLayout(i,o,r,p,s)}async renderCustomLayout(e,t,r,s,i){let o=r.frontmatter,a=o.ui__LayoutBlock_display_properties;if(a&&Array.isArray(a)&&a.length>0){await this.renderSimplifiedLayout(e,t,o);return}let l=e.createDiv({cls:"exocortex-layout-info"});l.style.display="none",l.setAttribute("data-layout-id",s.id.toString()),l.setAttribute("data-layout-class",s.targetClass.value);let c=s.getVisibleBlocks();for(let u of c){let p=e.createDiv({cls:`exocortex-block exocortex-block-${u.type}`});if(p.setAttribute("data-block-id",u.id),u.title){let g=p.createEl("h3",{text:u.title,cls:"exocortex-block-header"});u.isCollapsible&&(g.addClass("is-collapsible"),g.addEventListener("click",()=>{p.toggleClass("is-collapsed",!p.hasClass("is-collapsed"))}))}let m=p.createDiv({cls:"exocortex-block-content"});try{switch(u.type){case"dynamic-backlinks":await this.dynamicBacklinksRenderer.render(m,u.config,t,i);break;case"relation-properties":await this.relationPropertiesRenderer.render(m,u.config,t,i);break;default:m.createEl("p",{text:`Unsupported block type: ${u.type}`,cls:"exocortex-error"})}}catch(g){m.createEl("p",{text:`Error rendering block: ${g}`,cls:"exocortex-error"})}}}async renderSimplifiedLayout(e,t,r){try{let s=r.ui__LayoutBlock_display_properties,i=r.ui__LayoutBlock_target_class||r.exo__Instance_class,o=se.create({targetClass:this.cleanClassName(i),displayProperties:s,enabled:r.ui__LayoutBlock_enabled!==!1,priority:r.ui__LayoutBlock_priority||100});if(o.isFailure){e.createEl("p",{text:`Invalid simplified layout configuration: ${o.getError()}`,cls:"exocortex-error"});return}let a=o.getValue(),l=e.createDiv({cls:"exocortex-block exocortex-simplified-layout"});l.createEl("h3",{text:"Related Assets",cls:"exocortex-block-header"});let c=l.createDiv({cls:"exocortex-block-content"});await this.simplifiedPropertiesRenderer.render(c,a,t)}catch(s){e.createEl("p",{text:"Error rendering simplified layout",cls:"exocortex-error"})}}async renderDefaultLayout(e,t,r,s){let i=r.frontmatter,o=i.ui__LayoutBlock_display_properties;if(o&&Array.isArray(o)&&o.length>0){await this.renderSimplifiedLayout(e,t,i);return}let l=e.createDiv({cls:"exocortex-block exocortex-block-dynamic-backlinks"}).createDiv({cls:"exocortex-block-content"});await this.dynamicBacklinksRenderer.render(l,{type:"dynamic-backlinks",excludeProperties:["exo__Asset_id","exo__Instance_class"],showEmptyProperties:!1},t,s)}renderError(e,t){e.createEl("div",{text:`Layout Error: ${t}`,cls:"exocortex-error notice-error"})}cleanClassName(e){if(!e)return"";let t=Array.isArray(e)?e[0]:e;return(t==null?void 0:t.toString().replace(/\[\[|\]\]/g,""))||""}renderLayoutDirect(e,t){if(!t||!e||typeof e!="object"||(e.config&&e.config.cssClass&&t.classList.add(e.config.cssClass),!e.getVisibleBlocks||typeof e.getVisibleBlocks!="function"))return;let r=e.getVisibleBlocks();for(let s of r){let i=document.createElement("div");if(i.className=`exocortex-block exocortex-block-${s.type}`,i.setAttribute("data-block-id",s.id),t.appendChild(i),s.title){let a=document.createElement("h3");a.textContent=s.title,a.className="exocortex-block-header",i.appendChild(a),s.isCollapsible&&(a.classList.add("is-collapsible"),a.addEventListener("click",()=>{i.classList.toggle("is-collapsed")}))}let o=document.createElement("div");o.className="exocortex-block-content",i.appendChild(o)}}}});var v,at=f(()=>{Dt();Vt();Mt();gt();ht();qt();jt();Yt();Qt();Xt();Zt();er();tr();rr();sr();gr();hr();yr();vr();xr();Tt();It();Q();v=class{constructor(e){this.app=e;this.container=B.getInstance(),this.registerDependencies()}static initialize(e,t){return v.instance?(v.instance.app=e,t&&(v.instance.plugin=t),v.instance.container.clear(),v.instance.registerDependencies()):v.instance=new v(e),t&&!v.instance.plugin&&(v.instance.plugin=t),v.instance}static getInstance(){if(!v.instance)throw new Error("DIContainer not initialized. Call initialize(app) first.");return v.instance}async initialize(e){return Promise.resolve()}static reset(){v.instance=null}registerDependencies(){this.container.register("App",()=>this.app),this.container.register("ILogger",()=>E.create("DIContainer")),this.container.register("LoggerFactory",()=>E),this.container.register("INotificationService",()=>new Se),this.container.register("IFileSystemAdapter",()=>new Le(this.app)),this.container.register("IUIAdapter",()=>new oe(this.app)),this.container.register("IVaultAdapter",()=>new ae(this.app.vault,this.app.metadataCache)),this.container.register("IAssetRepository",()=>new Ne(this.app)),this.container.register("IOntologyRepository",()=>new Oe(this.app)),this.container.register("IClassViewRepository",()=>new He(this.app)),this.container.register("IButtonRepository",()=>new qe(this.app)),this.container.register("IClassLayoutRepository",()=>{var e,t;return new We(this.app,((t=(e=this.plugin)==null?void 0:e.settings)==null?void 0:t.layoutsFolderPath)||"layouts")}),this.container.register("ICommandExecutor",()=>new Qe(this.app,this.container.resolve("IAssetRepository"),null)),this.container.register("ErrorHandlerService",()=>new ce({showUserNotification:!0,logToConsole:!0,trackMetrics:!0,autoRecover:!1},this.container.resolve("INotificationService"))),this.container.register("OntologyProvisioningService",()=>new Ze),this.container.register("PropertyCacheService",()=>q.getInstance()),this.container.register("CircuitBreakerService",()=>W.getInstance()),this.container.register("CreateAssetUseCase",()=>new je(this.container.resolve("IAssetRepository"),this.container.resolve("IOntologyRepository"),this.container.resolve("OntologyProvisioningService"))),this.container.register("RenderClassButtonsUseCase",()=>new Ge(this.container.resolve("IClassViewRepository"),this.container.resolve("IButtonRepository"))),this.container.register("ExecuteButtonCommandUseCase",()=>new Ke(this.container.resolve("IButtonRepository"),this.container.resolve("ICommandExecutor"))),this.container.register("PropertyEditingUseCase",()=>new Ye(this.container.resolve("IAssetRepository"),this.plugin||this.app)),this.container.register("ButtonRenderer",()=>new et(this.app,this.container.resolve("RenderClassButtonsUseCase"),this.container.resolve("ExecuteButtonCommandUseCase"))),this.container.register("PropertyRenderer",()=>new ue(this.app,this.container.resolve("PropertyEditingUseCase"))),this.container.register("LayoutRenderer",()=>new pe(this.app,this.container.resolve("IClassLayoutRepository")))}resolve(e){return this.container.resolve(e)}getCreateAssetUseCase(){return this.resolve("CreateAssetUseCase")}getRenderButtonsUseCase(){return this.resolve("RenderClassButtonsUseCase")}getExecuteButtonCommandUseCase(){return this.resolve("ExecuteButtonCommandUseCase")}getButtonRenderer(){return this.resolve("ButtonRenderer")}getPropertyRenderer(){return this.resolve("PropertyRenderer")}getLayoutRenderer(){return this.resolve("LayoutRenderer")}getPropertyEditingUseCase(){return this.resolve("PropertyEditingUseCase")}dispose(){this.container.clear()}}});var _t,j,Tr=f(()=>{_t=class{constructor(e={}){this.thresholds=e;this.metrics=[];this.maxMetricsHistory=100;this.defaultThresholds={maxDuration:200,maxMemoryIncrease:25,maxVaultScanSize:1e3,cacheHitRateTarget:80};this.thresholds={...this.defaultThresholds,...e}}startOperation(e,t){let r=this.generateOperationId(),s=Date.now(),i=0;typeof performance!="undefined"&&performance.memory&&(i=performance.memory.usedJSHeapSize);let o={operationId:r,className:e,startTime:s,vaultFilesScanned:t,memoryUsage:{before:i,after:0,delta:0}};return this.n=this.n||new Map,this.n.set(r,o),r}completeOperation(e,t,r,s=[]){var p,m;let i=this.n||new Map,o=i.get(e);if(!o)return this.createFallbackMetrics(e,t,r,s);let a=Date.now(),l=a-o.startTime,c=0;typeof performance!="undefined"&&performance.memory&&(c=performance.memory.usedJSHeapSize);let u={...o,endTime:a,duration:l,propertiesFound:t,cacheHit:r,errors:s,memoryUsage:{before:((p=o.memoryUsage)==null?void 0:p.before)||0,after:c,delta:(c-(((m=o.memoryUsage)==null?void 0:m.before)||0))/(1024*1024)}};return i.delete(e),this.recordMetrics(u),this.checkPerformanceThresholds(u),u}recordMetrics(e){this.metrics.push(e),this.metrics.length>this.maxMetricsHistory&&(this.metrics=this.metrics.slice(-this.maxMetricsHistory))}checkPerformanceThresholds(e){let t=[];e.duration>this.thresholds.maxDuration&&t.push(`Property loading took ${e.duration}ms, exceeding ${this.thresholds.maxDuration}ms threshold`),e.memoryUsage&&e.memoryUsage.delta>this.thresholds.maxMemoryIncrease&&t.push(`Memory usage increased by ${e.memoryUsage.delta.toFixed(2)}MB, exceeding ${this.thresholds.maxMemoryIncrease}MB threshold`),e.vaultFilesScanned>this.thresholds.maxVaultScanSize&&t.push(`Scanned ${e.vaultFilesScanned} vault files, exceeding ${this.thresholds.maxVaultScanSize} efficient threshold`),t.forEach(r=>{})}getPerformanceStats(){if(this.metrics.length===0)return{totalOperations:0,averageDuration:0,averagePropertiesFound:0,cacheHitRate:0,performanceViolations:0,recentOperations:[]};let e=this.metrics.length,t=this.metrics.reduce((a,l)=>a+l.duration,0)/e,r=this.metrics.reduce((a,l)=>a+l.propertiesFound,0)/e,i=this.metrics.filter(a=>a.cacheHit).length/e*100,o=this.metrics.filter(a=>a.duration>this.thresholds.maxDuration||a.memoryUsage&&a.memoryUsage.delta>this.thresholds.maxMemoryIncrease||a.vaultFilesScanned>this.thresholds.maxVaultScanSize).length;return{totalOperations:e,averageDuration:Math.round(t),averagePropertiesFound:Math.round(r),cacheHitRate:Math.round(i),performanceViolations:o,recentOperations:this.metrics.slice(-10)}}getPerformanceRecommendations(){let e=this.getPerformanceStats(),t=[];e.cacheHitRate<this.thresholds.cacheHitRateTarget&&t.push(`Cache hit rate is ${e.cacheHitRate}%, consider improving caching strategy (target: ${this.thresholds.cacheHitRateTarget}%)`),e.averageDuration>this.thresholds.maxDuration&&t.push(`Average operation duration is ${e.averageDuration}ms, consider optimization (target: <${this.thresholds.maxDuration}ms)`),e.performanceViolations>e.totalOperations*.1&&t.push(`${e.performanceViolations} performance violations detected, consider vault optimization or caching improvements`);let r=this.metrics.filter(s=>s.vaultFilesScanned>this.thresholds.maxVaultScanSize).length;return r>0&&t.push(`${r} operations scanned large vault sizes, consider implementing property indexing`),t}exportMetrics(){return[...this.metrics]}clearMetrics(){this.metrics=[]}generateOperationId(){return`prop-discovery-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}createFallbackMetrics(e,t,r,s){let i=Date.now();return{operationId:e,className:"unknown",startTime:i,endTime:i,duration:0,propertiesFound:t,vaultFilesScanned:0,cacheHit:r,errors:s}}},j=new _t});var de,kt=f(()=>{x();Tr();de=class{constructor(e){this.app=e;this.cache=new Map;this.cacheTimestamps=new Map;this.cacheMaxAge=5*60*1e3}async discoverPropertiesForClass(e){let t=this.app.vault.getMarkdownFiles(),r=j.startOperation(e,t.length),s=[];try{let i=`properties_${e}`,o=this.getFromCache(i);if(o)return j.completeOperation(r,o.length,!0),n.ok(o);let a=await this.getClassHierarchy(e),l=[],c=new Set,u=this.filterPropertyFiles(t);for(let p of u)try{let m=this.app.metadataCache.getFileCache(p);if(!(m!=null&&m.frontmatter))continue;let g=this.extractDomain(m.frontmatter);if(!this.domainMatchesClassHierarchy(g,a))continue;let h=p.basename;if(c.has(h))continue;c.add(h);let V=this.extractPropertyMetadata(p,m.frontmatter);l.push(V)}catch(m){let g=`Error processing property file ${p.basename}: ${m instanceof Error?m.message:String(m)}`;s.push(g)}return l.sort((p,m)=>p.isRequired!==m.isRequired?p.isRequired?-1:1:p.label.localeCompare(m.label)),this.setCache(i,l),j.completeOperation(r,l.length,!1,s),n.ok(l)}catch(i){let o=`Failed to discover properties: ${i instanceof Error?i.message:String(i)}`;return s.push(o),j.completeOperation(r,0,!1,s),n.fail(o)}}filterPropertyFiles(e){let t=[];for(let r of e){let s=this.app.metadataCache.getFileCache(r);s!=null&&s.frontmatter&&this.isPropertyDefinition(s.frontmatter)&&t.push(r)}return t}async getClassHierarchy(e){let t=[e],r=new Set([e]),s=e;for(;s;){let i=this.findClassFile(s);if(!i)break;let o=this.app.metadataCache.getFileCache(i);if(!(o!=null&&o.frontmatter))break;let a=o.frontmatter.exo__Class_superClass||o.frontmatter.rdfs__subClassOf;Array.isArray(a)&&(a=a[0]);let l=this.extractValue(a);if(!l||r.has(l))break;t.push(l),r.add(l),s=l}return t}async getInstancesOfClass(e){let t=this.app.vault.getMarkdownFiles(),r=j.startOperation(`instances_${e}`,t.length);try{let s=`instances_${e}`,i=this.getFromCache(s);if(i)return j.completeOperation(r,i.length,!0),n.ok(i);let o=[];for(let a of t){let l=this.app.metadataCache.getFileCache(a);if(!(l!=null&&l.frontmatter)||this.extractValue(l.frontmatter.exo__Instance_class)!==e)continue;let u=l.frontmatter.rdfs__label||l.frontmatter.exo__Asset_label||a.basename,p=`[[${a.basename}]]`;o.push({label:u,value:p,file:a})}return o.sort((a,l)=>a.label.localeCompare(l.label)),this.setCache(s,o),j.completeOperation(r,o.length,!1),n.ok(o)}catch(s){let i=`Failed to get instances: ${s instanceof Error?s.message:String(s)}`;return j.completeOperation(r,0,!1,[i]),n.fail(i)}}isPropertyDefinition(e){let t=this.extractValue(e.exo__Instance_class),r=this.extractValue(e.rdf__type);return t==="exo__Property"||r==="exo__ObjectProperty"||r==="exo__DatatypeProperty"||r==="rdf__Property"}extractPropertyMetadata(e,t){let r=e.basename,s=this.determinePropertyType(t);return{name:r,label:t.rdfs__label||this.humanizePropertyName(r),description:t.rdfs__comment,type:s,domain:this.extractDomain(t),range:this.extractValue(t.rdfs__range||t.exo__Property_range||"string"),isRequired:t.exo__Property_isRequired===!0,options:t.exo__Property_options,defaultValue:t.exo__Property_defaultValue}}determinePropertyType(e){let t=this.extractValue(e.rdf__type);if(t==="exo__ObjectProperty"||t==="owl__ObjectProperty")return"ObjectProperty";if(t==="exo__DatatypeProperty"||t==="owl__DatatypeProperty")return"DatatypeProperty";let r=this.extractValue(e.rdfs__range);return r&&this.looksLikeClassName(r)?"ObjectProperty":"DatatypeProperty"}looksLikeClassName(e){let t=this.extractValue(e);return/^[A-Z]/.test(t)||t.includes("__")||t.includes("::")}extractDomain(e){let t=e.exo__Property_domain||e.rdfs__domain||e.domain;return Array.isArray(t)?t.map(r=>this.extractValue(r)):this.extractValue(t)||""}domainMatchesClassHierarchy(e,t){let r=Array.isArray(e)?e:[e];for(let s of r){let i=this.extractValue(s);if(t.includes(i))return!0}return!1}extractValue(e){return e?String(e).replace(/^\[\[|\]\]$/g,""):""}findClassFile(e){return this.app.vault.getMarkdownFiles().find(r=>r.basename===e)||null}addCorePropertiesDocumentation(){}humanizePropertyName(e){return(e.split("_").pop()||e).replace(/([A-Z])/g," $1").replace(/_/g," ").replace(/\b\w/g,r=>r.toUpperCase()).trim()}getFromCache(e){let t=this.cacheTimestamps.get(e);return!t||Date.now()-t>this.cacheMaxAge?(this.cache.delete(e),this.cacheTimestamps.delete(e),null):this.cache.get(e)||null}setCache(e,t){this.cache.set(e,t),this.cacheTimestamps.set(e,Date.now()),this.cache.size>100&&this.cleanupCache()}cleanupCache(){let e=Date.now();for(let[t,r]of this.cacheTimestamps.entries())e-r>this.cacheMaxAge&&(this.cache.delete(t),this.cacheTimestamps.delete(t))}clearCache(){this.cache.clear(),this.cacheTimestamps.clear()}getCacheStats(){let t=Date.now();for(let r of this.cacheTimestamps.values())r<t&&(t=r);return{size:this.cache.size,hitRate:0,oldestEntry:t}}}});var Ir={};Lt(Ir,{EnhancedCreateAssetModal:()=>me});var k,me,Ft=f(()=>{k=require("obsidian");at();kt();me=class extends k.Modal{constructor(t,r){super(t);this.assetTitle="";this.assetOntology="";this.propertyValues=new Map;this.propertiesContainer=null;this.properties=[];this.assetClass=r,this.container=v.getInstance(),this.createAssetUseCase=this.container.getCreateAssetUseCase(),this.propertyDiscovery=new de(t),this.circuitBreaker=this.container.resolve("CircuitBreakerService")}open(){try{super.open()}catch(t){this.onOpen()}}async onOpen(){var i,o;let{contentEl:t}=this,r=this.app.vault.getMarkdownFiles().find(a=>a.basename===this.assetClass),s="Create Asset";if(r){let a=this.app.metadataCache.getFileCache(r),l=((i=a==null?void 0:a.frontmatter)==null?void 0:i.rdfs__label)||((o=a==null?void 0:a.frontmatter)==null?void 0:o.exo__Asset_label)||this.assetClass;s=`Create ${this.humanizeClassName(l)}`}t.createEl("h2",{text:s}),await this.setupTitleField(t),await this.setupOntologyField(t),await this.setupPropertiesSection(t),this.setupActionButtons(t)}async setupTitleField(t){new k.Setting(t).setName("Title").setDesc("Asset title (will be used as the filename)").addText(r=>r.setPlaceholder("Enter asset title").setValue(this.assetTitle).onChange(s=>this.assetTitle=s))}async setupOntologyField(t){let r=this.app.vault.getMarkdownFiles(),s=[];for(let a of r)if(a.name.startsWith("!")){let l=this.app.metadataCache.getFileCache(a);if(l!=null&&l.frontmatter){let c=l.frontmatter.exo__Ontology_prefix||a.basename.substring(1),u=l.frontmatter.rdfs__label||c;s.push({prefix:c,displayName:u})}}s.length===0&&s.push({prefix:"exo",displayName:"Exocortex Core"},{prefix:"ui",displayName:"User Interface"},{prefix:"rdfs",displayName:"RDF Schema"});let i="exo",o=this.assetClass.split("__")[0];s.some(a=>a.prefix===o)&&(i=o),this.assetOntology=i,new k.Setting(t).setName("Ontology").setDesc("Select which knowledge graph this asset belongs to").addDropdown(a=>{for(let l of s)a.addOption(l.prefix,l.displayName);a.setValue(this.assetOntology),a.onChange(l=>{this.assetOntology=l})})}async setupPropertiesSection(t){t.createEl("h3",{text:"Properties",cls:"exocortex-properties-header"}),this.propertiesContainer=t.createDiv({cls:"exocortex-properties-container"}),this.propertiesContainer.createEl("p",{text:"Discovering properties...",cls:"exocortex-loading"});let r=await this.propertyDiscovery.discoverPropertiesForClass(this.assetClass);if(this.propertiesContainer.empty(),r.isSuccess)if(this.properties=r.getValue()||[],this.properties.length===0)this.propertiesContainer.createEl("p",{text:"No specific properties for this class",cls:"exocortex-no-properties"});else for(let s of this.properties)await this.createPropertyField(s);else this.propertiesContainer.createEl("p",{text:`Error discovering properties: ${r.getError()}`,cls:"exocortex-error-message"})}async createPropertyField(t){if(!this.propertiesContainer)return;let r=new k.Setting(this.propertiesContainer).setName(t.label+(t.isRequired?" *":"")).setDesc(t.description||"");t.type==="ObjectProperty"?await this.createObjectPropertyField(r,t):this.createDatatypePropertyField(r,t)}async createObjectPropertyField(t,r){let s=this.extractValue(r.range),i=await this.propertyDiscovery.getInstancesOfClass(s);t.addDropdown(o=>{if(o.addOption("","-- Select --"),i.isSuccess){let a=i.getValue()||[];for(let l of a)o.addOption(l.value,l.label)}o.onChange(a=>{a?this.propertyValues.set(r.name,a):this.propertyValues.delete(r.name)}),r.defaultValue&&(o.setValue(r.defaultValue),this.propertyValues.set(r.name,r.defaultValue))})}createDatatypePropertyField(t,r){let s=this.extractValue(r.range).toLowerCase();r.options&&r.options.length>0?this.createEnumField(t,r):s.includes("boolean")||s==="bool"?this.createBooleanField(t,r):s.includes("date")?this.createDateField(t,r):s.includes("integer")||s.includes("number")||s.includes("decimal")||s.includes("float")?this.createNumberField(t,r):s.includes("text")||s==="longtext"?this.createTextAreaField(t,r):this.createTextField(t,r)}createEnumField(t,r){t.addDropdown(s=>{s.addOption("","-- Select --");for(let i of r.options||[])s.addOption(i,i);s.onChange(i=>{i?this.propertyValues.set(r.name,i):this.propertyValues.delete(r.name)}),r.defaultValue&&(s.setValue(r.defaultValue),this.propertyValues.set(r.name,r.defaultValue))})}createBooleanField(t,r){t.addToggle(s=>{s.onChange(i=>{this.propertyValues.set(r.name,i)}),r.defaultValue!==void 0&&(s.setValue(r.defaultValue),this.propertyValues.set(r.name,r.defaultValue))})}createDateField(t,r){t.addText(s=>{s.setPlaceholder("YYYY-MM-DD").onChange(i=>{i?this.propertyValues.set(r.name,i):this.propertyValues.delete(r.name)}),s.inputEl.type="date",r.defaultValue&&(s.setValue(r.defaultValue),this.propertyValues.set(r.name,r.defaultValue))})}createNumberField(t,r){t.addText(s=>{s.setPlaceholder("Enter number").onChange(i=>{if(i){let o=parseFloat(i);isNaN(o)||this.propertyValues.set(r.name,o)}else this.propertyValues.delete(r.name)}),r.defaultValue!==void 0&&(s.setValue(String(r.defaultValue)),this.propertyValues.set(r.name,r.defaultValue))})}createTextAreaField(t,r){t.addTextArea(s=>{s.setPlaceholder("Enter "+r.label.toLowerCase()).onChange(i=>{i?this.propertyValues.set(r.name,i):this.propertyValues.delete(r.name)}),r.defaultValue&&(s.setValue(r.defaultValue),this.propertyValues.set(r.name,r.defaultValue))})}createTextField(t,r){t.addText(s=>{s.setPlaceholder("Enter "+r.label.toLowerCase()).onChange(i=>{i?this.propertyValues.set(r.name,i):this.propertyValues.delete(r.name)}),r.defaultValue&&(s.setValue(r.defaultValue),this.propertyValues.set(r.name,r.defaultValue))})}setupActionButtons(t){new k.Setting(t).addButton(r=>r.setButtonText("Create").setCta().onClick(async()=>{await this.createAsset()}))}async createAsset(){let t=this.validateRequiredFields();if(t){new k.Notice(t,5e3);return}try{let r=await this.circuitBreaker.execute("asset-creation",async()=>{let s={};for(let[o,a]of this.propertyValues)s[o]=a;s.exo__Instance_class=`[[${this.assetClass}]]`;let i=await this.createAssetUseCase.execute({title:this.assetTitle,className:this.assetClass,ontologyPrefix:this.assetOntology,properties:s});if(!i.success)throw new Error(i.error||"Asset creation failed");return i});new k.Notice(r.message),this.close()}catch(r){let s=r instanceof Error?r.message:String(r);s.includes("Circuit")?new k.Notice("Asset creation is temporarily unavailable. Please try again in a moment.",5e3):s.includes("ontology")?new k.Notice(`Ontology issue: ${s}`,8e3):s.includes("validation")||s.includes("Invalid")?new k.Notice(`Validation error: ${s}`,6e3):new k.Notice(`Error: ${s}`,5e3)}}validateRequiredFields(){if(!this.assetTitle)return"Title is required";for(let t of this.properties)if(t.isRequired&&!this.propertyValues.has(t.name)){if(t.name==="exo__Asset_uid"||t.name==="exo__Instance_class"||t.name==="exo__Asset_isDefinedBy")continue;return`${t.label} is required`}return null}extractValue(t){return t?String(t).replace(/^\[\[|\]\]$/g,""):""}humanizeClassName(t){return(t.split("__").pop()||t).replace(/([A-Z])/g," $1").replace(/_/g," ").trim()}onClose(){let{contentEl:t}=this;t.empty()}}});var Or={};Lt(Or,{default:()=>ie});module.exports=Vr(Or);var Fr=require("obsidian");var ke=class{constructor(e){this.plugin=e;this.managers=[]}registerManager(e){this.managers.push(e)}async initializeAll(){for(let e of this.managers)try{await e.initialize()}catch(t){}}async cleanupAll(){for(let e=this.managers.length-1;e>=0;e--){let t=this.managers[e];try{await t.cleanup()}catch(r){}}}getManager(e){return this.managers.find(t=>t instanceof e)||null}getManagers(){return this.managers}};var Fe=class{constructor(e){this.plugin=e;this.controllers=[]}registerController(e){this.controllers.push(e)}async initializeAll(){for(let e of this.controllers)try{await e.registerCommands()}catch(t){}}async cleanupAll(){for(let e of this.controllers)try{await e.cleanup()}catch(t){}}getControllers(){return this.controllers}};at();It();Tt();var nt=class{constructor(e,t){this.plugin=e;this.settings=t;this.services=new Map}async initializeServices(){v.initialize(this.plugin.app,this.plugin),this.container=v.getInstance();let e=this.container.resolve("IAssetRepository");this.services.set("IAssetRepository",e);let t=this.container.resolve("IClassLayoutRepository"),r=new pe(this.plugin.app,t);this.services.set("LayoutRenderer",r);let s=this.container.getPropertyEditingUseCase(),i=new ue(this.plugin.app,s);this.services.set("PropertyRenderer",i)}getService(e){let t=this.services.get(e);if(!t)throw new Error(`Service ${e} not found`);return t}hasService(e){return this.services.has(e)}async cleanup(){this.services.clear()}updateServices(e){try{v.initialize(this.plugin.app,this.plugin),this.container=v.getInstance()}catch(t){}}};var Ar=require("obsidian");x();var Ae={layoutsFolderPath:"layouts",templatesFolderPath:".exocortex/templates",templateUsageDataPath:".exocortex/template-usage.json",preferredQueryEngine:"dataview",fallbackQueryEngine:"datacore",enableQueryEngineAutoDetect:!0,enableQueryCache:!0,queryCacheMaxSize:500,queryCacheTTLMinutes:5,queryCacheTimeout:30,defaultRDFFormat:"turtle",includeInferredTriples:!1,exportNamespaces:!0,maxGraphSize:1e4,batchProcessingSize:50,enableLazyLoading:!0,enableMobileOptimizations:!0,mobileBatchSize:10,enableTouchControls:!0,enableDebugMode:!1,enableVerboseLogging:!1,logQueries:!1,enablePerformanceMetrics:!1},$=class{constructor(e={}){this.data={...Ae,...e}}static create(e={}){try{let t=new $(e),r=t.validate();return r.isFailure?n.fail(r.getError()):n.ok(t)}catch(t){return n.fail(`Failed to create settings: ${t.message}`)}}validate(){return!this.data.layoutsFolderPath||this.data.layoutsFolderPath.trim().length===0?n.fail("Layouts folder path cannot be empty"):!this.data.templatesFolderPath||this.data.templatesFolderPath.trim().length===0?n.fail("Templates folder path cannot be empty"):this.data.queryCacheMaxSize<1?n.fail("SPARQL cache max size must be at least 1"):this.data.queryCacheTTLMinutes<1?n.fail("SPARQL cache TTL must be at least 1 minute"):this.data.queryCacheMaxSize<1?n.fail("Query cache max size must be at least 1"):this.data.queryCacheTimeout<1?n.fail("Query cache timeout must be at least 1 minute"):this.data.maxGraphSize<100?n.fail("Max graph size must be at least 100"):this.data.batchProcessingSize<1?n.fail("Batch processing size must be at least 1"):this.data.mobileBatchSize<1?n.fail("Mobile batch size must be at least 1"):n.ok()}getData(){return{...this.data}}update(e){let t={...this.data,...e},s=new $(t).validate();return s.isFailure?n.fail(s.getError()):(this.data=t,n.ok())}get(e){return this.data[e]}set(e,t){let r={[e]:t};return this.update(r)}resetToDefaults(){this.data={...Ae}}toJSON(){return this.getData()}static fromJSON(e){try{let t=JSON.parse(e);return $.create(t)}catch(t){return n.fail(`Failed to parse settings JSON: ${t.message}`)}}};var O=require("obsidian"),lt=class extends O.PluginSettingTab{constructor(t,r){super(t,r);this.plugin=r,this.settings=r.settings}display(){let{containerEl:t}=this;t.empty(),t.createEl("h1",{text:"Exocortex Settings"}),t.createEl("p",{text:"Essential settings for the Exocortex plugin.",cls:"setting-item-description"}),this.addDebugSection(t),this.addResetSection(t)}addDebugSection(t){t.createEl("h2",{text:"Debug Settings"}),t.createEl("p",{text:"Debug options for troubleshooting plugin issues.",cls:"setting-item-description"}),new O.Setting(t).setName("Enable debug mode").setDesc("Enable extended logging and debug features").addToggle(r=>r.setValue(this.settings.get("enableDebugMode")).onChange(async s=>{await this.updateSetting("enableDebugMode",s)})),new O.Setting(t).setName("Enable performance tracking").setDesc("Track and log performance metrics").addToggle(r=>r.setValue(this.settings.get("enablePerformanceMetrics")).onChange(async s=>{await this.updateSetting("enablePerformanceMetrics",s)})),new O.Setting(t).setName("Show console logs").setDesc("Display detailed logs in the developer console").addToggle(r=>r.setValue(this.settings.get("enableVerboseLogging")).onChange(async s=>{await this.updateSetting("enableVerboseLogging",s)}))}addResetSection(t){t.createEl("h2",{text:"Reset Settings"});let r=t.createEl("p",{text:"\u26A0\uFE0F Warning: Resetting will restore all settings to their default values. This action cannot be undone.",cls:"setting-item-description mod-warning"});r.style.color="var(--text-error)",new O.Setting(t).setName("Reset to defaults").setDesc("Reset all plugin settings to their default values").addButton(s=>s.setButtonText("Reset to Defaults").setWarning().onClick(async()=>{await this.confirmReset()&&await this.resetAllSettings()}))}async updateSetting(t,r){let s=this.settings.set(t,r);if(s.isFailure){new O.Notice(`Settings error: ${s.getError()}`);return}await this.plugin.saveSettings(),this.plugin.updateContainer&&this.plugin.updateContainer()}async confirmReset(){return new Promise(t=>{let r=document.createElement("div");r.className="modal",r.innerHTML=`
                <div class="modal-bg"></div>
                <div class="modal-content">
                    <div class="modal-title">Reset Settings</div>
                    <div class="modal-text">
                        Are you sure you want to reset all settings to their default values?
                        <br><br>
                        This will restore:
                        <ul>
                            <li>Debug mode (disabled)</li>
                            <li>Performance tracking (disabled)</li>
                            <li>Console logging (disabled)</li>
                        </ul>
                        <br>
                        This action cannot be undone.
                    </div>
                    <div class="modal-button-container">
                        <button class="mod-warning" id="confirm-reset">Reset to Defaults</button>
                        <button id="cancel-reset">Cancel</button>
                    </div>
                </div>
            `,document.body.appendChild(r);let s=r.querySelector("#confirm-reset"),i=r.querySelector("#cancel-reset"),o=r.querySelector(".modal-bg"),a=()=>{document.body.removeChild(r)};s.onclick=()=>{a(),t(!0)},i.onclick=()=>{a(),t(!1)},o.onclick=()=>{a(),t(!1)}})}async resetAllSettings(){this.settings.resetToDefaults(),await this.plugin.saveSettings(),this.plugin.updateContainer&&this.plugin.updateContainer(),this.display(),new O.Notice("\u2705 All settings have been reset to defaults")}};var ct=class{constructor(e){this.plugin=e}async initialize(){await this.loadSettings(),this.plugin.addSettingTab(new lt(this.plugin.app,this.plugin))}async cleanup(){}getManagerId(){return"SettingsLifecycleManager"}getSettings(){return this.settings}async loadSettings(){try{let e=await this.plugin.loadData(),t=$.create(e||{});t.isFailure?this.settings=new $(Ae):this.settings=t.getValue()}catch(e){this.settings=new $(Ae)}}async saveSettings(){try{await this.plugin.saveData(this.settings.toJSON())}catch(e){new Ar.Notice("Failed to save settings")}}};var _=require("obsidian");at();kt();var Te=class extends _.Modal{constructor(t){super(t);this.assetTitle="";this.assetClass="exo__Asset";this.assetOntology="";this.propertyValues=new Map;this.propertiesContainer=null;this.properties=[];this.updateDebounceTimer=null;this.isUpdatingProperties=!1;this.container=v.getInstance(),this.createAssetUseCase=this.container.getCreateAssetUseCase(),this.ontologyRepository=this.container.resolve("IOntologyRepository"),this.classViewRepository=this.container.resolve("IClassViewRepository"),this.propertyCache=this.container.resolve("PropertyCacheService"),this.propertyDiscoveryService=new de(t),this.circuitBreaker=this.container.resolve("CircuitBreakerService")}async onOpen(){let{contentEl:t}=this;t.setAttribute("data-test","create-asset-modal"),t.createEl("h2",{text:"Create ExoAsset"}),await this.setupTitleField(t),await this.setupClassField(t),await this.setupOntologyField(t),await this.setupPropertiesSection(t),this.setupActionButtons(t)}async setupTitleField(t){let r=new _.Setting(t).setName("Title").setDesc("Asset title").addText(s=>{s.inputEl.setAttribute("data-test","asset-title-input"),s.setPlaceholder("Enter asset title").setValue(this.assetTitle).onChange(i=>this.assetTitle=i)})}async setupClassField(t){let r=this.app.vault.getMarkdownFiles(),s=[];for(let o of r){let a=this.app.metadataCache.getFileCache(o);if(a!=null&&a.frontmatter){let l=a.frontmatter.exo__Instance_class;if(l==="[[exo__Class]]"||l==="exo__Class"){let c=o.basename,u=a.frontmatter.rdfs__label||c;s.push({className:c,displayName:u})}}}s.length===0&&s.push({className:"exo__Asset",displayName:"Asset"},{className:"exo__Class",displayName:"Class"},{className:"exo__Property",displayName:"Property"});let i=new _.Setting(t).setName("Class").setDesc("Select the type of asset").addDropdown(o=>{o.selectEl.setAttribute("data-test","asset-class-dropdown");for(let a of s)o.addOption(a.className,a.displayName);o.setValue(this.assetClass),o.onChange(async a=>{this.assetClass=a,this.updateDebounceTimer!==null&&window.clearTimeout(this.updateDebounceTimer),this.updateDebounceTimer=window.setTimeout(async()=>{this.updateDebounceTimer=null,await this.updatePropertiesForClass(a)},50)})})}async setupOntologyField(t){let r=this.app.vault.getMarkdownFiles(),s=[];for(let o of r)if(o.name.startsWith("!")){let a=this.app.metadataCache.getFileCache(o);if(a!=null&&a.frontmatter){let l=a.frontmatter.exo__Ontology_prefix||o.basename.substring(1),c=a.frontmatter.rdfs__label||l;s.push({prefix:l,displayName:c})}}s.length===0&&s.push({prefix:"exo",displayName:"Exocortex Core"},{prefix:"ui",displayName:"User Interface"},{prefix:"rdfs",displayName:"RDF Schema"});let i="exo";s.length>0&&!this.assetOntology&&(this.assetOntology=i),new _.Setting(t).setName("Ontology").setDesc("Select which knowledge graph this asset belongs to").addDropdown(o=>{for(let a of s)o.addOption(a.prefix,a.displayName);i&&s.some(a=>a.prefix===i)?(this.assetOntology=i,o.setValue(i)):s.length>0&&(this.assetOntology=s[0].prefix,o.setValue(s[0].prefix)),o.onChange(a=>{this.assetOntology=a})})}async setupPropertiesSection(t){t.createEl("h3",{text:"Properties",cls:"exocortex-properties-header"}),this.propertiesContainer=t.createDiv({cls:"exocortex-properties-container"}),this.propertiesContainer.setAttribute("data-test","properties-container"),await this.updatePropertiesForClass(this.assetClass)}async updatePropertiesForClass(t){if(!this.propertiesContainer||this.isUpdatingProperties)return;this.isUpdatingProperties=!0;let r=Date.now();try{this.propertyDiscoveryService.clearCache(),this.propertyValues.clear(),this.properties=[],"empty"in this.propertiesContainer&&typeof this.propertiesContainer.empty=="function"?this.propertiesContainer.empty():this.propertiesContainer.innerHTML="",await new Promise(u=>setTimeout(u,0));let s=await this.propertyDiscoveryService.discoverPropertiesForClass(t);if(!s.isSuccess){let u=this.propertiesContainer.createEl("div",{cls:"exocortex-property-error"});u.createEl("p",{text:"Failed to load properties for this class",cls:"exocortex-error-message"}),u.createEl("p",{text:s.getError(),cls:"exocortex-error-details"}),this.addFallbackProperties();return}let i=s.getValue()||[],o=new Set(["exo__Asset_uid","exo__Asset_isDefinedBy","exo__Instance_class","exo__Asset_createdAt","exo__Asset_updatedAt","exo__Asset_version","exo__Asset_label"]),a=new Set(["Unique ID","Defined By","Instance Class","Created At","Updated At","Version","Label"]),l=i.filter(u=>!o.has(u.name)&&!a.has(u.label));if(this.properties=l.map(u=>({name:u.name,label:u.label,description:u.description||"",type:this.mapSemanticPropertyTypeToUIType(u),isRequired:u.isRequired,range:u.range,options:u.options,semanticType:u.type})),this.properties.length===0)this.propertiesContainer.createEl("p",{text:"No specific properties for this class",cls:"exocortex-no-properties"});else for(let u of this.properties)this.createPropertyField(u);Date.now()-r>200}catch(s){let i=s instanceof Error?s.message:String(s),o=this.propertiesContainer.createEl("div",{cls:"exocortex-property-error"});o.createEl("p",{text:"Unable to load class properties",cls:"exocortex-error-message"}),o.createEl("p",{text:`Error: ${i}`,cls:"exocortex-error-details"}),this.addFallbackProperties()}finally{this.isUpdatingProperties=!1}}mapSemanticPropertyTypeToUIType(t){return t.type==="ObjectProperty"?"object":t.options&&Array.isArray(t.options)?"enum":this.mapRangeToType(t.range)}addFallbackProperties(){this.properties=[{name:"description",label:"Description",description:"A brief description of the asset",type:"text",isRequired:!1},{name:"tags",label:"Tags",description:"Tags for categorization",type:"array",isRequired:!1}];for(let t of this.properties)this.createPropertyField(t)}mapRangeToType(t){return t==="select"?"enum":t.includes("boolean")?"boolean":t.includes("date")||t.includes("Date")?"date":t.includes("integer")||t.includes("decimal")||t.includes("float")?"number":t.includes("string")&&t.includes("[]")?"array":t.includes("text")||t.includes("Text")?"text":"string"}createPropertyField(t){if(!this.propertiesContainer)return;let r=new _.Setting(this.propertiesContainer).setName(t.label+(t.isRequired?" *":"")).setDesc(t.description),s=r.settingEl;switch(s&&(s.setAttribute("data-test",`property-${t.name}`),s.setAttribute("data-property-type",t.type),s.setAttribute("data-required",t.isRequired.toString())),t.type){case"enum":this.createEnumField(r,t);break;case"boolean":this.createBooleanField(r,t);break;case"date":this.createDateField(r,t);break;case"number":this.createNumberField(r,t);break;case"text":this.createTextAreaField(r,t);break;case"array":this.createArrayField(r,t);break;case"object":this.createObjectPropertyField(r,t);break;default:this.createTextField(r,t)}}createObjectPropertyField(t,r){let s=r.range.replace(/^\[\[|\]\]$/g,"");t.addDropdown(i=>{i.addOption("","Loading..."),i.onChange(o=>{o&&o!==""?this.propertyValues.set(r.name,o):this.propertyValues.delete(r.name)}),this.propertyDiscoveryService.getInstancesOfClass(s).then(o=>{if(!o.isSuccess){i.selectEl.innerHTML="",i.addOption("","-- Error loading options --");return}let a=o.getValue()||[];i.selectEl.innerHTML="",i.addOption("","-- Select --");for(let l of a)i.addOption(l.value,l.label)})})}createEnumField(t,r){t.addDropdown(s=>{s.addOption("","-- Select --");for(let i of r.options)s.addOption(i,i);s.onChange(i=>{i?this.propertyValues.set(r.name,i):this.propertyValues.delete(r.name)})})}createBooleanField(t,r){t.addToggle(s=>{s.onChange(i=>{this.propertyValues.set(r.name,i)})})}createDateField(t,r){t.addText(s=>{s.setPlaceholder("YYYY-MM-DD").onChange(i=>{i?this.propertyValues.set(r.name,i):this.propertyValues.delete(r.name)}),s.inputEl.type="date"})}createNumberField(t,r){t.addText(s=>{s.setPlaceholder("Enter number").onChange(i=>{if(i){let o=parseFloat(i);isNaN(o)||this.propertyValues.set(r.name,o)}else this.propertyValues.delete(r.name)})})}createTextAreaField(t,r){t.addTextArea(s=>{s.setPlaceholder("Enter "+r.label.toLowerCase()).onChange(i=>{i?this.propertyValues.set(r.name,i):this.propertyValues.delete(r.name)})})}createArrayField(t,r){t.addText(s=>{s.setPlaceholder("Comma-separated values or [[links]]").onChange(i=>{if(i)if(i.includes("[[")){let o=i.match(/\[\[([^\]]+)\]\]/g)||[];this.propertyValues.set(r.name,o)}else{let o=i.split(",").map(a=>a.trim()).filter(a=>a);this.propertyValues.set(r.name,o)}else this.propertyValues.delete(r.name)})})}createTextField(t,r){t.addText(s=>{s.setPlaceholder("Enter "+r.label.toLowerCase()).onChange(i=>{i?this.propertyValues.set(r.name,i):this.propertyValues.delete(r.name)})})}setupActionButtons(t){new _.Setting(t).addButton(r=>{r.buttonEl.setAttribute("data-test","create-asset-button"),r.setButtonText("Create").setCta().onClick(async()=>{await this.createAsset()})})}async createAsset(){try{let t=await this.circuitBreaker.execute("asset-creation",async()=>{let r={};for(let[i,o]of this.propertyValues)r[i]=o;let s=await this.createAssetUseCase.execute({title:this.assetTitle,className:this.assetClass,ontologyPrefix:this.assetOntology,properties:r});if(!s.success)throw new Error(s.error||"Asset creation failed");return s});new _.Notice(t.message),this.close()}catch(t){let r=t instanceof Error?t.message:String(t);r.includes("Circuit")?new _.Notice("Asset creation is temporarily unavailable. Please try again in a moment.",5e3):r.includes("ontology")?new _.Notice(`Ontology issue: ${r}`,8e3):r.includes("validation")||r.includes("Invalid")?new _.Notice(`Validation error: ${r}`,6e3):new _.Notice(`Error: ${r}`,5e3)}}onClose(){if(this.updateDebounceTimer!==null&&(window.clearTimeout(this.updateDebounceTimer),this.updateDebounceTimer=null),this.propertyValues.clear(),this.properties=[],this.propertiesContainer=null,this.isUpdatingProperties=!1,this.propertyDiscoveryService.clearCache(),"empty"in this.contentEl&&typeof this.contentEl.empty=="function")this.contentEl.empty();else for(this.contentEl.innerHTML="";this.contentEl.firstChild;)this.contentEl.removeChild(this.contentEl.firstChild)}};Ft();var ut=class{constructor(e){this.plugin=e}async registerCommands(){this.plugin.addCommand({id:"create-exo-asset",name:"Exocortex: Create Asset",hotkeys:[{modifiers:["Mod","Shift"],key:"n"}],callback:()=>{new Te(this.plugin.app).open()}}),this.plugin.addCommand({id:"create-asset-enhanced",name:"Exocortex: Create Asset (Enhanced)",callback:async()=>{var i;let t=this.plugin.app.workspace.getActiveFile(),r=null;if(t){let o=this.plugin.app.metadataCache.getFileCache(t);((i=o==null?void 0:o.frontmatter)==null?void 0:i.exo__Instance_class)==="exo__Class"&&(r=t.basename)}new me(this.plugin.app,r||"exo__Asset").open()}});let e=["ems__Area","ems__Task","ems__Project","ems__Goal"];for(let t of e)this.plugin.addCommand({id:`create-${t.toLowerCase().replace("__","-")}`,name:`Exocortex: Create ${t.replace("__"," ")}`,callback:async()=>{new me(this.plugin.app,t).open()}});this.plugin.addRibbonIcon("plus-circle","Create ExoAsset",()=>{new Te(this.plugin.app).open()})}async cleanup(){}getControllerId(){return"AssetCommandController"}};var _r=require("obsidian");Q();var fe=class{constructor(e){this.serviceProvider=e;this.views=new Map;this.activeElements=new Map;this.logger=E.createForClass(fe),this.loadViews()}loadViews(){this.logger.info("Code block processor initialized")}registerView(e,t){this.views.set(e,t),this.logger.info(`Registered view: ${e}`)}async processCodeBlock(e,t,r){let s=Date.now();try{let i=this.parseConfig(e),o=this.views.get(i.type);if(!o){this.renderError(t,`Unknown view type: ${i.type}`);return}t.empty();let a=t.createDiv({cls:"exocortex-view-container"});a.setAttribute("data-view-type",i.type),this.activeElements.set(a,i),await o.render(e,a,r);let l=this;r.addChild(new class extends _r.MarkdownRenderChild{constructor(){super(a)}onunload(){l.activeElements.delete(a)}}),this.logger.info(`Rendered view ${i.type}`,{duration:Date.now()-s,sourcePath:r.sourcePath})}catch(i){this.logger.error("Failed to process code block",{error:i}),this.renderError(t,`Error: ${i.message}`)}}parseConfig(e){var i;let t=e.trim().split(`
`),s={type:((i=t[0])==null?void 0:i.trim())||"UniversalLayout"};for(let o=1;o<t.length;o++){let a=t[o].trim();if(!a||a.startsWith("#"))continue;let l=a.match(/^(\w+):\s*(.+)$/);if(l){let[,c,u]=l;try{s[c]=JSON.parse(u)}catch(p){s[c]=u}}}return s}renderError(e,t){e.empty(),e.createDiv({cls:"exocortex-error"}).createEl("span",{text:"\u26A0\uFE0F "+t,cls:"exocortex-error-message"})}async refreshViews(){for(let[e,t]of this.activeElements){let r=this.views.get(t.type);r!=null&&r.refresh&&await r.refresh(e)}}};var pt=require("obsidian");var D=class{static isAssetArchived(e){let t=e==null?void 0:e.archived;if(t==null)return!1;if(typeof t=="boolean")return t;if(typeof t=="string"){let r=t.toLowerCase().trim();return r==="true"||r==="yes"||r==="1"}return typeof t=="number"?t!==0:!1}static findReferencingProperty(e,t,r){for(let[s,i]of Object.entries(e)){if(!i)continue;let o=String(i);if(o.includes(`[[${t}]]`)||o.includes(`[[${r}]]`)||o.includes(`[[${r.replace(".md","")}]]`)||o.includes(`[[${t}|`)||o.includes(`[[${r}|`)||o.includes(`[[${r.replace(".md","")}|`))return s;if(Array.isArray(i))for(let a of i){let l=String(a);if(l.includes(`[[${t}]]`)||l.includes(`[[${r}]]`)||l.includes(`[[${r.replace(".md","")}]]`)||l.includes(`[[${t}|`)||l.includes(`[[${r}|`)||l.includes(`[[${r.replace(".md","")}|`))return s}}}static getPropertyValue(e,t){if(e.metadata&&e.metadata[t]!==void 0)return e.metadata[t];if(e[t]!==void 0)return e[t];let r=t.split("."),s=e;for(let i of r)if(s=s==null?void 0:s[i],s===void 0)break;return s}static sortRelations(e,t,r){return[...e].sort((s,i)=>{var l,c,u,p;let o,a;if(t==="Name")o=String(s.title||"").toLowerCase(),a=String(i.title||"").toLowerCase();else if(t==="exo__Instance_class"){let m=((l=s.metadata)==null?void 0:l.exo__Instance_class)||((c=s.metadata)==null?void 0:c.exo__Instance_class)||"",g=((u=i.metadata)==null?void 0:u.exo__Instance_class)||((p=i.metadata)==null?void 0:p.exo__Instance_class)||"";o=String(Array.isArray(m)?m[0]||"":m).toLowerCase(),a=String(Array.isArray(g)?g[0]||"":g).toLowerCase()}else{let m=D.getPropertyValue(s,t),g=D.getPropertyValue(i,t);m!=null&&(o=String(Array.isArray(m)?m[0]||"":m).toLowerCase()),g!=null&&(a=String(Array.isArray(g)?g[0]||"":g).toLowerCase())}return o==null||o===""?1:a==null||a===""?-1:o<a?r==="asc"?-1:1:o>a?r==="asc"?1:-1:0})}};var ge=class{constructor(e){this.sortState=new Map;this.app=e}async collectAllRelations(e){let t=[],r=this.app.metadataCache,s=r.resolvedLinks;for(let i in s){let o=s[i];if(o&&o[e.path]){let a=this.app.vault.getAbstractFileByPath(i);if(a instanceof pt.TFile){let l=r.getFileCache(a),c=(l==null?void 0:l.frontmatter)||{};if(D.isAssetArchived(c))continue;let u=D.findReferencingProperty(c,e.basename,e.path),p={file:a,path:i,title:a.basename,metadata:c,propertyName:u,isBodyLink:!u,created:a.stat.ctime,modified:a.stat.mtime};t.push(p)}}}return t.sort((i,o)=>o.modified-i.modified)}groupRelationsByProperty(e){let t=new Map;for(let r of e){let s=r.propertyName||"Untyped Relations";t.has(s)||t.set(s,[]),t.get(s).push(r)}return t}renderGroupedRelations(e,t){if(t.size===0){this.renderNoRelations(e);return}let r=e.createDiv({cls:"exocortex-asset-relations"}),s=t.get("Untyped Relations"),i=new Map(t);i.delete("Untyped Relations");let o=Array.from(i.keys()).sort();for(let a of o){let l=i.get(a);l&&this.renderRelationGroup(r,a,l)}s&&this.renderRelationGroup(r,"Untyped Relations",s)}renderRelationGroup(e,t,r){let s=e.createDiv({cls:"exocortex-relation-group"});s.createEl("h2",{text:t,cls:"exocortex-relation-group-header"});let i=s.createEl("table",{cls:"exocortex-relation-table"}),o=`group_${t}`;this.sortState.has(o)||this.sortState.set(o,{column:"Name",order:"asc"});let a=this.sortState.get(o),c=i.createEl("thead").createEl("tr"),u=c.createEl("th",{text:"Name",cls:`exocortex-table-header sortable ${a.column==="Name"?`sorted-${a.order}`:""}`});a.column==="Name"&&u.createSpan({text:a.order==="asc"?" \u25B2":" \u25BC",cls:"sort-indicator"});let p=c.createEl("th",{text:"exo__Instance_class",cls:`exocortex-table-header sortable ${a.column==="exo__Instance_class"?`sorted-${a.order}`:""}`});a.column==="exo__Instance_class"&&p.createSpan({text:a.order==="asc"?" \u25B2":" \u25BC",cls:"sort-indicator"}),u.addEventListener("click",()=>{this.handleSort("Name",o);let h=D.sortRelations(r,"Name",this.sortState.get(o).order);this.updateTableBody(g,h),this.updateSortIndicators(c,this.sortState.get(o))}),p.addEventListener("click",()=>{this.handleSort("exo__Instance_class",o);let h=D.sortRelations(r,"exo__Instance_class",this.sortState.get(o).order);this.updateTableBody(g,h),this.updateSortIndicators(c,this.sortState.get(o))});let m=D.sortRelations(r,a.column,a.order),g=i.createEl("tbody");for(let h of m)this.renderRelationRow(g,h)}renderRelationRow(e,t){let r=e.createEl("tr",{cls:"exocortex-relation-row"}),i=r.createEl("td",{cls:"exocortex-relation-name-cell"}).createEl("a",{text:t.title,cls:"exocortex-relation-link internal-link",href:t.path}),o=r.createEl("td",{cls:"exocortex-instance-class-cell"});this.renderInstanceClassLinks(o,t.metadata),i.addEventListener("click",a=>{if(a.metaKey||a.ctrlKey){a.preventDefault(),a.stopPropagation(),this.app.workspace.openLinkText(t.path,"",!0);return}if(a.shiftKey){a.preventDefault(),a.stopPropagation();let l=this.app.workspace.getLeaf("split");l&&l.openFile(this.app.vault.getAbstractFileByPath(t.path));return}a.altKey||(a.preventDefault(),this.app.workspace.openLinkText(t.path,"",!1))}),i.addEventListener("auxclick",a=>{a.button===1&&(a.preventDefault(),a.stopPropagation(),this.app.workspace.openLinkText(t.path,"",!0))})}renderRelationItem(e,t){let s=e.createDiv({cls:"exocortex-relation-item"}).createEl("a",{text:t.title,cls:"exocortex-relation-link internal-link",href:t.path});s.addEventListener("click",i=>{if(i.metaKey||i.ctrlKey){i.preventDefault(),i.stopPropagation(),this.app.workspace.openLinkText(t.path,"",!0);return}if(i.shiftKey){i.preventDefault(),i.stopPropagation();let o=this.app.workspace.getLeaf("split");o&&o.openFile(this.app.vault.getAbstractFileByPath(t.path));return}i.altKey||(i.preventDefault(),this.app.workspace.openLinkText(t.path,"",!1))}),s.addEventListener("auxclick",i=>{i.button===1&&(i.preventDefault(),i.stopPropagation(),this.app.workspace.openLinkText(t.path,"",!0))})}renderInstanceClassLinks(e,t){let r=(t==null?void 0:t.exo__Instance_class)||(t==null?void 0:t.exo__Instance_class);if(!r){e.createSpan({text:"-",cls:"no-instance-class"});return}let s=Array.isArray(r)?r:[r];if(s.length===0){e.createSpan({text:"-",cls:"no-instance-class"});return}s.forEach((i,o)=>{o>0&&e.createSpan({text:", ",cls:"separator"});let a=String(i),l,c;if(a.startsWith("[[")&&a.endsWith("]]")){let p=a.slice(2,-2),m=p.indexOf("|");m!==-1?(l=p.substring(0,m),c=p.substring(m+1)):(l=p,c=p)}else l=a,c=a;let u=e.createEl("a",{text:c,cls:"instance-class-link internal-link",href:l.endsWith(".md")?l:`${l}.md`});u.addEventListener("click",p=>{if(p.preventDefault(),p.stopPropagation(),p.metaKey||p.ctrlKey)this.app.workspace.openLinkText(l,"",!0);else if(p.shiftKey){let m=this.app.workspace.getLeaf("split");if(m){let g=this.app.vault.getAbstractFileByPath(l.endsWith(".md")?l:`${l}.md`);g instanceof pt.TFile&&m.openFile(g)}}else this.app.workspace.openLinkText(l,"",!1)}),u.addEventListener("auxclick",p=>{p.button===1&&(p.preventDefault(),p.stopPropagation(),this.app.workspace.openLinkText(l,"",!0))})})}extractBasename(e){return e.replace(/^\[\[/,"").replace(/\]\]$/,"").split("/").pop()||e}formatDate(e){let r=new Date().getTime()-e.getTime(),s=Math.floor(r/(1e3*60*60*24));return s===0?"Today":s===1?"Yesterday":s<7?`${s} days ago`:e.toLocaleDateString()}renderNoRelations(e){e.createDiv({cls:"exocortex-no-relations"}).createEl("p",{text:"No relations found",cls:"exocortex-message"})}renderError(e,t,r){let s=e.createDiv({cls:"exocortex-error"});s.createEl("h3",{text:"\u26A0\uFE0F Error",cls:"exocortex-error-title"}),s.createEl("p",{text:t,cls:"exocortex-error-message"}),r&&s.createEl("p",{text:typeof r=="string"?r:String(r),cls:"exocortex-error-details"})}renderMessage(e,t){e.createDiv({cls:"exocortex-message-container"}).createEl("p",{text:t,cls:"exocortex-info-message"})}getCurrentFile(e){let t=this.app.metadataCache.getFirstLinkpathDest(e.sourcePath,"");return t instanceof pt.TFile?t:null}getFileMetadata(e){let t=this.app.metadataCache.getFileCache(e);return(t==null?void 0:t.frontmatter)||{}}updateTableBody(e,t){e.empty();for(let r of t)this.renderRelationRow(e,r)}updateSortIndicators(e,t){e.querySelectorAll(".sort-indicator").forEach(s=>s.remove()),e.querySelectorAll("th").forEach(s=>{s.classList.remove("sorted-asc","sorted-desc")}),e.querySelectorAll("th").forEach(s=>{var o;let i=(o=s.textContent)==null?void 0:o.replace(" \u25B2","").replace(" \u25BC","").trim();(i===t.column||i==="Name"&&t.column==="Name"||i==="exo__Instance_class"&&t.column==="exo__Instance_class")&&(s.classList.add(`sorted-${t.order}`),s.createSpan({text:t.order==="asc"?" \u25B2":" \u25BC",cls:"sort-indicator"}))})}handleSort(e,t){let r=this.sortState.get(t);r.column===e?r.order=r.order==="asc"?"desc":"asc":(r.column=e,r.order="asc"),this.sortState.set(t,r)}};Q();var he=class extends ge{constructor(t,r){super(t);this.logger=E.createForClass(he),this.assetRepository=r.getService("IAssetRepository")}async render(t,r,s){try{let i=this.parseConfig(t),o=this.getCurrentFile(s);if(!o){this.renderMessage(r,"No active file");return}let a=await this.collectAllRelations(o);if(a.length===0){this.renderMessage(r,"No related assets found");return}if(i.groupByProperty!==!1){let l=this.groupRelationsByProperty(a);this.renderGroupedRelations(r,l)}else await this.renderByLayout(r,a,i);this.logger.info(`Rendered UniversalLayout with ${a.length} asset relations`)}catch(i){this.logger.error("Failed to render UniversalLayout",{error:i}),this.renderError(r,`Error: ${i.message}`)}}parseConfig(t){let r=t.trim().split(`
`),s={groupByProperty:!0};for(let i of r){let o=i.trim();if(!o||o==="UniversalLayout")continue;let a=o.match(/^(\w+):\s*(.+)$/);if(a){let[,l,c]=a;try{s[l]=JSON.parse(c)}catch(u){s[l]=c}}}return s}async renderByLayout(t,r,s){switch(s.layout){case"table":this.renderTable(t,r,s);break;case"cards":this.renderCards(t,r,s);break;case"graph":this.renderGraph(t,r,s);break;default:this.renderList(t,r,s)}}renderList(t,r,s){let i=t.createEl("ul",{cls:"exocortex-relations-list"});for(let o of r)i.createEl("li").createEl("a",{text:o.title,cls:"internal-link",href:o.path}).addEventListener("click",c=>{c.preventDefault(),this.app.workspace.openLinkText(o.path,"",!1)})}renderTable(t,r,s){let i=t.createEl("table",{cls:"exocortex-relations-table"}),a=i.createEl("thead").createEl("tr");if(a.createEl("th",{text:"Name",cls:"sortable"}),a.createEl("th",{text:"exo__Instance_class",cls:"sortable"}),s.showProperties)for(let c of s.showProperties)c!=="exo__Instance_class"&&a.createEl("th",{text:c});a.createEl("th",{text:"Relation Type"}),a.createEl("th",{text:"Modified"});let l=i.createEl("tbody");for(let c of r){let u=l.createEl("tr");u.createEl("td").createEl("a",{text:c.title,cls:"internal-link",href:c.path}).addEventListener("click",h=>{h.preventDefault(),this.app.workspace.openLinkText(c.path,"",!1)});let g=u.createEl("td",{cls:"instance-class"});if(this.renderInstanceClassLinks(g,c.metadata),s.showProperties){for(let h of s.showProperties)if(h!=="exo__Instance_class"){let V=this.getPropertyValue(c,h);u.createEl("td",{text:(V==null?void 0:V.toString())||""})}}u.createEl("td",{text:c.propertyName||"body",cls:"relation-type"}),u.createEl("td",{text:new Date(c.modified).toLocaleDateString()})}}renderCards(t,r,s){let i=t.createDiv({cls:"exocortex-relations-cards"});for(let o of r){let a=i.createDiv({cls:"exocortex-relation-card"});a.createEl("a",{text:o.title,cls:"internal-link card-title",href:o.path}).addEventListener("click",c=>{c.preventDefault(),this.app.workspace.openLinkText(o.path,"",!1)}),o.propertyName&&a.createDiv({text:`Via: ${o.propertyName}`,cls:"card-property"}),a.createDiv({text:new Date(o.modified).toLocaleDateString(),cls:"card-date"})}}renderGraph(t,r,s){t.createDiv({text:"Graph view not yet implemented",cls:"exocortex-placeholder"})}getPropertyValue(t,r){return t.metadata[r]}};var kr=require("obsidian");Q();var ye=class{constructor(e){this.serviceProvider=e;this.logger=E.createForClass(ye),this.assetRepository=e.getService("IAssetRepository"),this.app=window.app}async render(e,t,r){try{let s=this.parseConfig(e),i=await this.getFilteredAssets(s),o=t.createDiv({cls:"exocortex-asset-list"}),a=o.createDiv({cls:"exocortex-asset-header"});a.createEl("h3",{text:`Assets ${s.class?`(${s.class})`:""}: ${i.length}`}),s.showCreateButton&&a.createEl("button",{text:"\u2795 Create Asset",cls:"exocortex-create-button"}).addEventListener("click",()=>this.createNewAsset(s)),i.length===0?o.createDiv({text:"No assets found matching criteria",cls:"exocortex-message"}):await this.renderAssetList(o,i,s),this.logger.info(`Rendered AssetList with ${i.length} assets`)}catch(s){this.logger.error("Failed to render AssetList",{error:s}),this.renderError(t,s.message)}}async getFilteredAssets(e){let t=[],r=this.app.vault.getMarkdownFiles();for(let s of r){if(e.folder&&!s.path.startsWith(e.folder))continue;let i=this.app.metadataCache.getFileCache(s);if(i!=null&&i.frontmatter&&!(e.class&&i.frontmatter.class!==e.class)){if(e.tags&&e.tags.length>0){let o=i.frontmatter.tags||[];if(!e.tags.some(l=>o.includes(l)))continue}t.push({file:s,title:s.basename,path:s.path,metadata:i.frontmatter,created:s.stat.ctime,modified:s.stat.mtime})}}return e.sortBy&&t.sort((s,i)=>{let o=this.getPropertyValue(s,e.sortBy),a=this.getPropertyValue(i,e.sortBy),l=e.sortOrder==="desc"?-1:1;return o>a?l:-l}),e.limit&&e.limit>0?t.slice(0,e.limit):t}async renderAssetList(e,t,r){let s=e.createEl("div",{cls:"exocortex-asset-items"});for(let i of t){let o=s.createDiv({cls:"exocortex-asset-item"});if(o.createDiv({cls:"exocortex-asset-title"}).createEl("a",{text:i.title,cls:"internal-link",href:i.path}).addEventListener("click",u=>{u.preventDefault(),this.app.workspace.openLinkText(i.path,"",!1)}),r.properties&&r.properties.length>0){let u=o.createDiv({cls:"exocortex-asset-properties"});for(let p of r.properties){let m=this.getPropertyValue(i,p);if(m!=null&&m!==""){let g=u.createDiv({cls:"exocortex-asset-property"});g.createSpan({text:`${p}: `,cls:"property-label"}),g.createSpan({text:this.formatPropertyValue(m),cls:"property-value"})}}}o.createDiv({cls:"exocortex-asset-meta"}).createSpan({text:`Modified: ${new Date(i.modified).toLocaleDateString()}`,cls:"asset-date"})}}async createNewAsset(e){try{let r=`New Asset ${Date.now()}`,s=e.folder||"",i=s?`${s}/${r}.md`:`${r}.md`,o={created:new Date().toISOString(),class:e.class||"Asset"};e.tags&&e.tags.length>0&&(o.tags=e.tags);let a=this.generateFileContent(o,r);await this.app.vault.create(i,a),this.app.vault.getAbstractFileByPath(i)instanceof kr.TFile&&await this.app.workspace.openLinkText(i,"",!1),this.logger.info("Created new asset",{path:i,class:e.class})}catch(t){this.logger.error("Failed to create asset",{error:t}),window.app.notices.show(`Failed to create asset: ${t.message}`)}}generateFileContent(e,t){let r=["---"];for(let[s,i]of Object.entries(e))Array.isArray(i)?(r.push(`${s}:`),i.forEach(o=>r.push(`  - ${o}`))):r.push(`${s}: ${i}`);return r.push("---"),r.push(""),r.push(`# ${t}`),r.push(""),r.join(`
`)}parseConfig(e){let t=e.trim().split(`
`),r={type:"AssetList"};for(let s of t){if(!s||s==="AssetList")continue;let i=s.match(/^(\w+):\s*(.+)$/);if(i){let[,o,a]=i;o==="tags"||o==="properties"?r[o]=a.split(",").map(l=>l.trim()):o==="showCreateButton"?r[o]=a==="true":o==="limit"?r[o]=parseInt(a,10):r[o]=a}}return r}getPropertyValue(e,t){return e.metadata&&e.metadata[t]!==void 0?e.metadata[t]:e[t]}formatPropertyValue(e){return e==null?"":Array.isArray(e)?e.join(", "):typeof e=="object"?JSON.stringify(e):String(e)}renderError(e,t){e.createDiv({text:`Error: ${t}`,cls:"exocortex-error-message"})}async refresh(e){let t=e.getAttribute("data-source")||"";e.empty(),await this.render(t,e,{})}};var St=require("obsidian");var dt=class extends ge{async render(e,t,r){try{let s=this.getCurrentFile(r);if(!s){this.renderError(t,"Unable to determine current file");return}let i=this.getFileMetadata(s),o=this.getAssetClass(i);if(!o){this.renderError(t,"Unable to determine asset class. Please ensure exo__Instance_class is defined.");return}let a=i;if(o!=="exo__Class"){let c=await this.findClassFile(o);c?a=this.getFileMetadata(c):a={}}let l=await this.findLayoutConfiguration(o,a);if(!l){let c=`There is no specific Layout for class [[${o}]] - UniversalLayout will be used`;this.renderMessage(t,c),await this.renderAllRelations(s,t);return}if(!l.relationsToShow||l.relationsToShow.length===0){this.renderMessage(t,"No relations configured to display");return}if(l.relationsToShow.includes("*")||l.relationsToShow.includes("all")){await this.renderAllRelations(s,t);return}await this.renderFilteredRelations(s,t,l)}catch(s){this.renderError(t,"Failed to render DynamicLayout",s)}}getAssetClass(e){let t=e==null?void 0:e.exo__Instance_class;return t?Array.isArray(t)?this.extractBasename(t[0]):typeof t=="string"?this.extractBasename(t):null:null}async findLayoutConfiguration(e,t){try{if(t){let i=this.extractDefaultLayout(t);if(i){let o=await this.findLayoutByUUID(i);if(o)return o}}let s=this.app.vault.getMarkdownFiles();for(let i of s){let o=this.getFileMetadata(i);if(!o)continue;let a=o.exo__Instance_class;if(!this.isLayoutClass(a))continue;let l=o.ui__ClassLayout||o.ui__ClassLayout_for;if(!l){let c=i.basename;if(c.startsWith("ClassLayout - "))l=c.replace("ClassLayout - ","");else if(c.startsWith("Layout - "))l=c.replace("Layout - ","");else if(c.includes(" - ")){let u=c.split(" - ");u.length===2&&(l=u[1])}}if(l&&(l=this.extractBasename(l)),l===e)return{relationsToShow:this.parseRelationsToShow(o.ui__ClassLayout_relationsToShow)}}return null}catch(r){return null}}isLayoutClass(e){return e?(Array.isArray(e)?e:[e]).some(r=>this.extractBasename(r)==="ui__ClassLayout"):!1}parseRelationsToShow(e){return e?Array.isArray(e)?e.map(t=>this.extractBasename(String(t))):typeof e=="string"?e.split(",").map(t=>this.extractBasename(t.trim())).filter(t=>t):[]:[]}async renderAllRelations(e,t){let r=await this.collectAllRelations(e),s=this.groupRelationsByProperty(r);this.renderGroupedRelations(t,s)}async renderFilteredRelations(e,t,r){let s=await this.collectAllRelations(e),i=this.filterRelations(s,r.relationsToShow),o=this.groupRelationsByProperty(i),a=this.orderGroupsByConfig(o,r.relationsToShow);this.renderGroupedRelations(t,a)}filterRelations(e,t){let r=t.map(i=>i.toLowerCase()),s=r.includes("body")||r.includes("untyped")||r.includes("untyped relations");return e.filter(i=>i.isBodyLink?s:i.propertyName?t.some(o=>o===i.propertyName||this.extractBasename(o)===i.propertyName):!1)}orderGroupsByConfig(e,t){let r=new Map;for(let s of t){let i=this.extractBasename(s);i==="body"||i==="untyped"||i==="untyped relations"?e.has("Untyped Relations")&&r.set("Untyped Relations",e.get("Untyped Relations")):e.has(i)?r.set(i,e.get(i)):e.has(s)&&r.set(s,e.get(s))}for(let[s,i]of e)r.has(s)||r.set(s,i);return r}async findClassFile(e){var i;let t=this.app.vault.getAbstractFileByPath(`${e}.md`);if(t)return t;let r=[`02 Ontology/1 Exo/exo/Class/${e}.md`,`02 Ontology/2 Custom/ems/${e}.md`,`02 Ontology/${e}.md`];for(let o of r)if(t=this.app.vault.getAbstractFileByPath(o),t)return t;let s=this.app.vault.getMarkdownFiles();for(let o of s)if(o.basename===e){let a=this.app.metadataCache.getFileCache(o);if(((i=a==null?void 0:a.frontmatter)==null?void 0:i.exo__Instance_class)==="exo__Class")return o}return null}extractDefaultLayout(e){let t=["exo__Class_defaultLayout","defaultLayout","ui__defaultLayout"];for(let s of t)if(e[s])return this.extractBasename(e[s]);let r=e.exo__Instance_class;if(r){let i=`${this.extractBasename(r)}_defaultLayout`;if(e[i])return this.extractBasename(e[i])}return null}async findLayoutByUUID(e){try{let t=this.app.vault,r=t.getAbstractFileByPath(`${e}.md`);if(r&&r instanceof St.TFile){let o=this.getFileMetadata(r);if(o&&this.isLayoutClass(o.exo__Instance_class))return{relationsToShow:this.parseRelationsToShow(o.ui__ClassLayout_relationsToShow)}}let s=t.getAbstractFileByPath(`01 Inbox/${e}.md`);if(s&&s instanceof St.TFile){let o=this.getFileMetadata(s);if(o&&this.isLayoutClass(o.exo__Instance_class))return{relationsToShow:this.parseRelationsToShow(o.ui__ClassLayout_relationsToShow)}}let i=t.getMarkdownFiles();for(let o of i){let a=this.getFileMetadata(o);if(a&&this.isLayoutClass(a.exo__Instance_class)&&(a.exo__Asset_uid===e||a.uid===e||o.basename===e))return{relationsToShow:this.parseRelationsToShow(a.ui__ClassLayout_relationsToShow)}}return null}catch(t){return null}}};var J=require("obsidian");ze();var mt=class{constructor(e){this.app=e}async render(e,t,r,s){let i=t;if(!i.buttons||i.buttons.length===0)return;let o=e.createDiv({cls:`exocortex-buttons-block exocortex-buttons-${i.position||"top"}`});for(let a of i.buttons)this.renderButton(o,a,r,s)}renderButton(e,t,r,s){let i=new J.ButtonComponent(e).setButtonText(t.label).onClick(async()=>{await this.handleButtonClick(t,r,s)});t.tooltip&&i.setTooltip(t.tooltip),i.buttonEl.addClass("exocortex-layout-button"),t.style&&t.style!=="default"&&i.buttonEl.addClass(`exocortex-button-${t.style}`)}async handleButtonClick(e,t,r){let s=e.commandType;s==="CREATE_CHILD_TASK"||s==="CREATE_CHILD_TASK"?await this.handleCreateChildTask(t,r):s==="CREATE_CHILD_AREA"||s==="CREATE_CHILD_AREA"?await this.handleCreateChildArea(t,r):s==="CREATE_ASSET"?await this.handleCreateAsset(e,t,r):new J.Notice(`Command ${e.commandType} not yet implemented`)}async handleCreateChildTask(e,t){new J.Notice("Create Child Task functionality has been removed")}async handleCreateChildArea(e,t){new J.Notice("Create Child Area functionality has been removed")}async handleCreateAsset(e,t,r){var s;try{let i=(s=e.commandArgs)==null?void 0:s.className;if(!i){new J.Notice("No class specified for asset creation");return}let{EnhancedCreateAssetModal:o}=await Promise.resolve().then(()=>(Ft(),Ir));new o(this.app,i).open()}catch(i){new J.Notice(`Failed to create asset: ${i}`)}}};Q();var ve=class{constructor(e){this.app=e;this.logger=E.createForClass(ve),this.buttonsRenderer=new mt(e)}async render(e,t,r){var s;try{let i=this.getCurrentFile(r),o=this.getFrontmatter(i);if(!i){t.createDiv({text:"Buttons require a file context to work properly.",cls:"exocortex-warning"});return}let a=this.isButtonReferencesFormat(e),l;a?l=await this.loadButtonReferences(e):l=this.parseButtonsConfig(e),await this.buttonsRenderer.render(t,l,i,o),this.logger.info("Buttons view rendered successfully",{buttonCount:((s=l==null?void 0:l.buttons)==null?void 0:s.length)||0,file:i==null?void 0:i.path})}catch(i){throw this.logger.error("Failed to render Buttons view",{error:i}),i}}async refresh(e){this.logger.info("Buttons view refresh requested")}isButtonReferencesFormat(e){var r;let t=e.trim().split(`
`);if(((r=t[0])==null?void 0:r.trim().toLowerCase())==="buttons")for(let s=1;s<t.length;s++){let i=t[s].trim();if(i.startsWith("- [[")&&i.endsWith("]]"))return!0}return!1}async loadButtonReferences(e){let t=e.trim().split(`
`),r=[];for(let s=1;s<t.length;s++){let o=t[s].trim().match(/^-\s*\[\[([^\]]+)\]\]$/);if(o){let a=o[1],l=await this.loadButtonFromReference(a);l&&r.push(l)}}return{buttons:r}}async loadButtonFromReference(e){try{let t=`${e}.md`,r=this.app.vault.getAbstractFileByPath(t);if(!r){let o=[`02 Ontology/2 Custom/ems/${e}.md`,`02 Ontology/1 Exo/${e}.md`,`ui/${e}.md`];for(let a of o)if(r=this.app.vault.getAbstractFileByPath(a),r)break}if(!r)return this.logger.warn(`Button reference not found: ${e}`),null;let s=this.app.metadataCache.getFileCache(r),i=s==null?void 0:s.frontmatter;return i?{label:i.ui__Button_label||i.exo__Asset_label||e,commandType:this.mapCommandToType(i.ui__Button_command),tooltip:i.ui__Button_tooltip||"",style:i.ui__Button_style||"default",commandArgs:i.ui__Button_commandArgs||{}}:(this.logger.warn(`No frontmatter found for button: ${e}`),null)}catch(t){return this.logger.error(`Failed to load button reference: ${e}`,{error:t}),null}}mapCommandToType(e){return{"exocortex:create-asset":"CREATE_ASSET","exocortex:create-child-task":"CREATE_CHILD_TASK","exocortex:create-child-area":"CREATE_CHILD_AREA","exocortex:open-asset":"OPEN_ASSET","exocortex:delete-asset":"DELETE_ASSET"}[e]||"CUSTOM"}parseButtonsConfig(e){let t=e.trim().split(`
`),r={},s="",i=!1,o={},a=[];for(let l=0;l<t.length;l++){let c=t[l],u=c.trim();if(!(!u||u.startsWith("#"))&&!u.startsWith("view:")){if(u==="config:"){s="config";continue}if(u==="buttons:"){i=!0,a=[];continue}if(u.startsWith("buttons:")){if(u.match(/^buttons:\s*\[\s*\]$/))return r.buttons=[],r;i=!0,a=[];continue}if(i&&u.startsWith("- ")){Object.keys(o).length>0&&a.push(o),o={};let p=u.match(/^-\s+(\w+):\s*(.+)$/);if(p){let[,m,g]=p;o[m]=this.parseValue(g)}continue}if(i&&c.match(/^\s+\w+:/)&&!u.startsWith("- ")){let p=u.match(/^(\w+):\s*(.+)$/);if(p){let[,m,g]=p;o[m]=this.parseValue(g)}continue}if(s==="config"&&!i){let p=u.match(/^(\w+):\s*(.+)$/);if(p){let[,m,g]=p;r[m]=this.parseValue(g)}}}}return Object.keys(o).length>0&&a.push(o),i&&(r.buttons=a),r}parseValue(e){let t=e.trim();return t.startsWith('"')&&t.endsWith('"')||t.startsWith("'")&&t.endsWith("'")?t.slice(1,-1):t==="true"?!0:t==="false"?!1:/^\d+$/.test(t)?parseInt(t,10):t}getCurrentFile(e){return e.sourcePath?this.app.vault.getAbstractFileByPath(e.sourcePath):null}getFrontmatter(e){if(!e)return{};let t=this.app.metadataCache.getFileCache(e);return(t==null?void 0:t.frontmatter)||{}}};Q();var ie=class extends Fr.Plugin{async onload(){var t;try{this.logger=E.createForClass(ie),this.logger.startTiming("plugin-onload"),this.lifecycleRegistry=new ke(this),this.commandRegistry=new Fe(this),await this.initializeLifecycleManagers(),await this.initializeServiceProvider(),await this.initializeCommandControllers(),await this.lifecycleRegistry.initializeAll(),this.setupCacheInvalidation(),await this.commandRegistry.initializeAll(),await this.initializeCodeBlockProcessor(),this.logger.endTiming("plugin-onload"),this.logger.info("Exocortex Plugin initialized successfully",{managers:["lifecycle","settings"],controllers:["asset"],processors:["codeBlock"]})}catch(r){throw(t=this.logger)==null||t.error("Failed to initialize Exocortex Plugin",{stage:"onload"},r),r}}async onunload(){var t,r,s,i,o,a,l;try{(t=this.logger)==null||t.startTiming("plugin-onunload"),await((r=this.commandRegistry)==null?void 0:r.cleanupAll()),await((s=this.serviceProvider)==null?void 0:s.cleanup()),await((i=this.lifecycleRegistry)==null?void 0:i.cleanupAll()),(o=this.logger)==null||o.endTiming("plugin-onunload"),(a=this.logger)==null||a.info("Exocortex Plugin cleaned up successfully",{cleanedUp:["commands","services","lifecycle"]})}catch(c){(l=this.logger)==null||l.error("Error during plugin cleanup",{stage:"onunload"},c)}}get settings(){var t;return(t=this.settingsManager)==null?void 0:t.getSettings()}async saveSettings(){var t,r;await((t=this.settingsManager)==null?void 0:t.saveSettings()),(r=this.serviceProvider)==null||r.updateServices(this.settings)}updateContainer(){var t;(t=this.serviceProvider)==null||t.updateServices(this.settings)}async initializeLifecycleManagers(){this.settingsManager=new ct(this),this.lifecycleRegistry.registerManager(this.settingsManager),await this.settingsManager.loadSettings()}async initializeServiceProvider(){this.serviceProvider=new nt(this,this.settingsManager.getSettings()),await this.serviceProvider.initializeServices()}async initializeCommandControllers(){let t=new ut(this);this.commandRegistry.registerController(t)}setupCacheInvalidation(){}async initializeCodeBlockProcessor(){try{this.codeBlockProcessor=new fe(this.serviceProvider);let t=new he(this.app,this.serviceProvider),r=new ye(this.serviceProvider),s=new dt(this.app),i=new ve(this.app);this.codeBlockProcessor.registerView("UniversalLayout",t),this.codeBlockProcessor.registerView("AssetList",r),this.codeBlockProcessor.registerView("DynamicLayout",s),this.codeBlockProcessor.registerView("Buttons",i),this.registerMarkdownCodeBlockProcessor("exocortex",async(o,a,l)=>{await this.codeBlockProcessor.processCodeBlock(o,a,l)}),this.registerEvent(this.app.vault.on("modify",async()=>{await this.codeBlockProcessor.refreshViews()})),this.registerEvent(this.app.metadataCache.on("changed",async()=>{await this.codeBlockProcessor.refreshViews()})),this.logger.info("Code block processor initialized with views",{views:["UniversalLayout","AssetList","DynamicLayout","Buttons"],updateListeners:["vault.modify","metadataCache.changed"]})}catch(t){throw this.logger.error("Failed to initialize code block processor",{error:t}),t}}};
