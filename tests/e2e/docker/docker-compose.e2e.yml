version: '3.8'

services:
  obsidian-e2e:
    image: ghcr.io/sytone/obsidian-remote:latest
    platform: linux/amd64
    container_name: obsidian-e2e-test
    ports:
      - "8084:8080"  # Use 8084 to match existing test URLs
    volumes:
      # Mount test vault with plugin files
      - ./test-vault:/vaults/test-vault:ro
      # Mount Obsidian config with plugin installation
      - ./obsidian-config:/config
      # Mount built plugin files directly into plugins directory
      - ../../../main.js:/config/plugins/exocortex/main.js:ro
      - ../../../manifest.json:/config/plugins/exocortex/manifest.json:ro
      - ../../../styles.css:/config/plugins/exocortex/styles.css:ro
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=UTC
      - CUSTOM_PORT=8080
      - WEBPAGE_TITLE=Exocortex Plugin E2E Tests
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 45s
    restart: unless-stopped
    networks:
      - e2e-network


volumes:
  obsidian-config:
    driver: local

networks:
  e2e-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16