b850b8b22922e863ac1447d2fff13b64
"use strict";
/**
 * Global Test Cleanup System
 * Prevents memory leaks and ensures proper test isolation
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.globalTestState = exports.MemoryTracker = exports.forceCleanupTestResources = exports.MemorySafeMockFactory = void 0;
const globalTestState = {
    timers: new Set(),
    intervals: new Set(),
    eventListeners: new Map(),
    domNodes: new Set(),
    mockInstances: new Set()
};
exports.globalTestState = globalTestState;
// Override setTimeout to track timers
const originalSetTimeout = global.setTimeout;
global.setTimeout = ((...args) => {
    const timer = originalSetTimeout.apply(global, args);
    globalTestState.timers.add(timer);
    return timer;
});
// Override setInterval to track intervals
const originalSetInterval = global.setInterval;
global.setInterval = ((...args) => {
    const interval = originalSetInterval.apply(global, args);
    globalTestState.intervals.add(interval);
    return interval;
});
// Override clearTimeout
const originalClearTimeout = global.clearTimeout;
global.clearTimeout = ((timer) => {
    globalTestState.timers.delete(timer);
    return originalClearTimeout(timer);
});
// Override clearInterval
const originalClearInterval = global.clearInterval;
global.clearInterval = ((interval) => {
    globalTestState.intervals.delete(interval);
    return originalClearInterval(interval);
});
// Track DOM event listeners
if (typeof EventTarget !== 'undefined' && EventTarget.prototype.addEventListener) {
    const originalAddEventListener = EventTarget.prototype.addEventListener;
    EventTarget.prototype.addEventListener = function (type, listener, options) {
        if (!globalTestState.eventListeners.has(this)) {
            globalTestState.eventListeners.set(this, []);
        }
        globalTestState.eventListeners.get(this).push({ type, listener });
        return originalAddEventListener.call(this, type, listener, options);
    };
}
// Track DOM nodes created during tests
if (typeof document !== 'undefined' && document.createElement) {
    const originalCreateElement = document.createElement;
    document.createElement = function (tagName, options) {
        const element = originalCreateElement.call(this, tagName, options);
        globalTestState.domNodes.add(element);
        return element;
    };
}
/**
 * Memory-safe mock factory
 */
class MemorySafeMockFactory {
    static createMock(identifier, mockImplementation) {
        if (this.instances.has(identifier)) {
            return this.instances.get(identifier);
        }
        const mock = mockImplementation();
        this.instances.set(identifier, mock);
        globalTestState.mockInstances.add(mock);
        return mock;
    }
    static clearMock(identifier) {
        if (this.instances.has(identifier)) {
            const mock = this.instances.get(identifier);
            globalTestState.mockInstances.delete(mock);
            this.instances.delete(identifier);
        }
    }
    static clearAllMocks() {
        this.instances.clear();
        globalTestState.mockInstances.clear();
    }
}
exports.MemorySafeMockFactory = MemorySafeMockFactory;
MemorySafeMockFactory.instances = new Map();
/**
 * Force cleanup of all test resources
 */
function forceCleanupTestResources() {
    // Clear all timers
    globalTestState.timers.forEach(timer => {
        try {
            clearTimeout(timer);
        }
        catch (e) {
            // Ignore cleanup errors
        }
    });
    globalTestState.timers.clear();
    // Clear all intervals
    globalTestState.intervals.forEach(interval => {
        try {
            clearInterval(interval);
        }
        catch (e) {
            // Ignore cleanup errors
        }
    });
    globalTestState.intervals.clear();
    // Remove all event listeners
    globalTestState.eventListeners.forEach((listeners, target) => {
        listeners.forEach(({ type, listener }) => {
            try {
                target.removeEventListener(type, listener);
            }
            catch (e) {
                // Ignore cleanup errors
            }
        });
    });
    globalTestState.eventListeners.clear();
    // Clean up DOM nodes
    if (typeof document !== 'undefined') {
        globalTestState.domNodes.forEach(node => {
            try {
                if (node.parentNode) {
                    node.parentNode.removeChild(node);
                }
            }
            catch (e) {
                // Ignore cleanup errors
            }
        });
        globalTestState.domNodes.clear();
        // Clear document body
        if (document.body) {
            document.body.innerHTML = '';
        }
    }
    // Clear mock instances
    MemorySafeMockFactory.clearAllMocks();
    // Force garbage collection if available
    if (typeof global.gc === 'function') {
        try {
            global.gc();
        }
        catch (e) {
            // Ignore GC errors
        }
    }
}
exports.forceCleanupTestResources = forceCleanupTestResources;
/**
 * Memory usage tracker for tests
 */
class MemoryTracker {
    static takeSnapshot(testName) {
        const memory = process.memoryUsage();
        this.snapshots.push({
            test: testName,
            memory,
            timestamp: Date.now()
        });
        // Keep only last 10 snapshots to prevent memory buildup
        if (this.snapshots.length > 10) {
            this.snapshots.shift();
        }
        return memory;
    }
    static getMemoryIncrease(from, to) {
        const fromSnapshot = this.snapshots.find(s => s.test === from);
        const toSnapshot = this.snapshots.find(s => s.test === to);
        if (!fromSnapshot || !toSnapshot) {
            return 0;
        }
        return toSnapshot.memory.heapUsed - fromSnapshot.memory.heapUsed;
    }
    static reportMemoryUsage() {
        if (process.env.JEST_VERBOSE || process.env.MEMORY_DEBUG) {
            console.log('Memory Usage Report:');
            this.snapshots.forEach(snapshot => {
                const mb = (snapshot.memory.heapUsed / 1024 / 1024).toFixed(2);
                console.log(`  ${snapshot.test}: ${mb}MB`);
            });
        }
    }
    static clearSnapshots() {
        this.snapshots.length = 0;
    }
}
exports.MemoryTracker = MemoryTracker;
MemoryTracker.snapshots = [];
// Global setup and teardown
beforeEach(() => {
    // Clear any hanging resources before each test
    forceCleanupTestResources();
    // Take memory snapshot
    const testName = expect.getState()?.currentTestName || 'unknown';
    MemoryTracker.takeSnapshot(`before-${testName}`);
});
afterEach(() => {
    // Clear all resources after each test
    forceCleanupTestResources();
    // Take memory snapshot
    const testName = expect.getState()?.currentTestName || 'unknown';
    MemoryTracker.takeSnapshot(`after-${testName}`);
    // Report excessive memory usage
    const increase = MemoryTracker.getMemoryIncrease(`before-${testName}`, `after-${testName}`);
    const warningThreshold = process.env.CI ? 10 * 1024 * 1024 : 50 * 1024 * 1024; // 10MB in CI, 50MB locally
    if (increase > warningThreshold) {
        console.warn(`Warning: Test "${testName}" used ${(increase / 1024 / 1024).toFixed(2)}MB of memory`);
    }
});
afterAll(() => {
    // Final cleanup and memory report
    forceCleanupTestResources();
    MemoryTracker.reportMemoryUsage();
    MemoryTracker.clearSnapshots();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vdGVzdHMvdGVzdC1jbGVhbnVwLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7OztBQVdILE1BQU0sZUFBZSxHQUFvQjtJQUNyQyxNQUFNLEVBQUUsSUFBSSxHQUFHLEVBQUU7SUFDakIsU0FBUyxFQUFFLElBQUksR0FBRyxFQUFFO0lBQ3BCLGNBQWMsRUFBRSxJQUFJLEdBQUcsRUFBRTtJQUN6QixRQUFRLEVBQUUsSUFBSSxHQUFHLEVBQUU7SUFDbkIsYUFBYSxFQUFFLElBQUksR0FBRyxFQUFFO0NBQzNCLENBQUM7QUE0T08sMENBQWU7QUExT3hCLHNDQUFzQztBQUN0QyxNQUFNLGtCQUFrQixHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUM7QUFDN0MsTUFBTSxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsR0FBRyxJQUFXLEVBQUUsRUFBRTtJQUNwQyxNQUFNLEtBQUssR0FBRyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLElBQTBCLENBQUMsQ0FBQztJQUMzRSxlQUFlLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNsQyxPQUFPLEtBQUssQ0FBQztBQUNqQixDQUFDLENBQXNCLENBQUM7QUFFeEIsMENBQTBDO0FBQzFDLE1BQU0sbUJBQW1CLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQztBQUMvQyxNQUFNLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQVcsRUFBRSxFQUFFO0lBQ3JDLE1BQU0sUUFBUSxHQUFHLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsSUFBMEIsQ0FBQyxDQUFDO0lBQy9FLGVBQWUsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3hDLE9BQU8sUUFBUSxDQUFDO0FBQ3BCLENBQUMsQ0FBdUIsQ0FBQztBQUV6Qix3QkFBd0I7QUFDeEIsTUFBTSxvQkFBb0IsR0FBRyxNQUFN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QUFDLENBQUMsMkJBQTJCO0lBRTFHLElBQUksUUFBUSxHQUFHLGdCQUFnQixFQUFFO1FBQzdCLE9BQU8sQ0FBQyxJQUFJLENBQUMsa0JBQWtCLFFBQVEsVUFBVSxDQUFDLFFBQVEsR0FBRyxJQUFJLEdBQUcsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQztLQUN2RztBQUNMLENBQUMsQ0FBQyxDQUFDO0FBRUgsUUFBUSxDQUFDLEdBQUcsRUFBRTtJQUNWLGtDQUFrQztJQUNsQyx5QkFBeUIsRUFBRSxDQUFDO0lBQzVCLGFBQWEsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO0lBQ2xDLGFBQWEsQ0FBQyxjQUFjLEVBQUUsQ0FBQztBQUNuQyxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva2l0ZWxldi9Eb2N1bWVudHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi90ZXN0cy90ZXN0LWNsZWFudXAudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBHbG9iYWwgVGVzdCBDbGVhbnVwIFN5c3RlbVxuICogUHJldmVudHMgbWVtb3J5IGxlYWtzIGFuZCBlbnN1cmVzIHByb3BlciB0ZXN0IGlzb2xhdGlvblxuICovXG5cbi8vIFRyYWNrIGdsb2JhbCBzdGF0ZSBmb3IgY2xlYW51cFxuaW50ZXJmYWNlIEdsb2JhbFRlc3RTdGF0ZSB7XG4gICAgdGltZXJzOiBTZXQ8Tm9kZUpTLlRpbWVvdXQ+O1xuICAgIGludGVydmFsczogU2V0PE5vZGVKUy5UaW1lb3V0PjtcbiAgICBldmVudExpc3RlbmVyczogTWFwPEV2ZW50VGFyZ2V0LCBBcnJheTx7IHR5cGU6IHN0cmluZzsgbGlzdGVuZXI6IEV2ZW50TGlzdGVuZXIgfT4+O1xuICAgIGRvbU5vZGVzOiBTZXQ8RWxlbWVudD47XG4gICAgbW9ja0luc3RhbmNlczogU2V0PGFueT47XG59XG5cbmNvbnN0IGdsb2JhbFRlc3RTdGF0ZTogR2xvYmFsVGVzdFN0YXRlID0ge1xuICAgIHRpbWVyczogbmV3IFNldCgpLFxuICAgIGludGVydmFsczogbmV3IFNldCgpLFxuICAgIGV2ZW50TGlzdGVuZXJzOiBuZXcgTWFwKCksXG4gICAgZG9tTm9kZXM6IG5ldyBTZXQoKSxcbiAgICBtb2NrSW5zdGFuY2VzOiBuZXcgU2V0KClcbn07XG5cbi8vIE92ZXJyaWRlIHNldFRpbWVvdXQgdG8gdHJhY2sgdGltZXJzXG5jb25zdCBvcmlnaW5hbFNldFRpbWVvdXQgPSBnbG9iYWwuc2V0VGltZW91dDtcbmdsb2JhbC5zZXRUaW1lb3V0ID0gKCguLi5hcmdzOiBhbnlbXSkgPT4ge1xuICAgIGNvbnN0IHRpbWVyID0gb3JpZ2luYWxTZXRUaW1lb3V0LmFwcGx5KGdsb2JhbCwgYXJncyBhcyBbRnVuY3Rpb24sIG51bWJlcl0pO1xuICAgIGdsb2JhbFRlc3RTdGF0ZS50aW1lcnMuYWRkKHRpbWVyKTtcbiAgICByZXR1cm4gdGltZXI7XG59KSBhcyB0eXBlb2Ygc2V0VGltZW91dDtcblxuLy8gT3ZlcnJpZGUgc2V0SW50ZXJ2YWwgdG8gdHJhY2sgaW50ZXJ2YWxzXG5jb25zdCBvcmlnaW5hbFNldEludGVydmFsID0gZ2xvYmFsLnNldEludGVydmFsO1xuZ2xvYmFsLnNldEludGVydmFsID0gKCguLi5hcmdzOiBhbnlbXSkgPT4ge1xuICAgIGNvbnN0IGludGVydmFsID0gb3JpZ2luYWxTZXRJbnRlcnZhbC5hcHBseShnbG9iYWwsIGFyZ3MgYXMgW0Z1bmN0aW9uLCBudW1iZXJdKTtcbiAgICBnbG9iYWxUZXN0U3RhdGUuaW50ZXJ2YWxzLmFkZChpbnRlcnZhbCk7XG4gICAgcmV0dXJuIGludGVydmFsO1xufSkgYXMgdHlwZW9mIHNldEludGVydmFsO1xuXG4vLyBPdmVycmlkZSBjbGVhclRpbWVvdXRcbmNvbnN0IG9yaWdpbmFsQ2xlYXJUaW1lb3V0ID0gZ2xvYmFsLmNsZWFyVGltZW91dDtcbmdsb2JhbC5jbGVhclRpbWVvdXQgPSAoKHRpbWVyOiBOb2RlSlMuVGltZW91dCkgPT4ge1xuICAgIGdsb2JhbFRlc3RTdGF0ZS50aW1lcnMuZGVsZXRlKHRpbWVyKTtcbiAgICByZXR1cm4gb3JpZ2luYWxDbGVhclRpbWVvdXQodGltZXIpO1xufSkgYXMgdHlwZW9mIGNsZWFyVGltZW91dDtcblxuLy8gT3ZlcnJpZGUgY2xlYXJJbnRlcnZhbFxuY29uc3Qgb3JpZ2luYWxDbGVhckludGVydmFsID0gZ2xvYmFsLmNsZWFySW50ZXJ2YWw7XG5nbG9iYWwuY2xlYXJJbnRlcnZhbCA9ICgoaW50ZXJ2YWw6IE5vZGVKUy5UaW1lb3V0KSA9PiB7XG4gICAgZ2xvYmFsVGVzdFN0YXRlLmludGVydmFscy5kZWxldGUoaW50ZXJ2YWwpO1xuICAgIHJldHVybiBvcmlnaW5hbENsZWFySW50ZXJ2YWwoaW50ZXJ2YWwpO1xufSkgYXMgdHlwZW9mIGNsZWFySW50ZXJ2YWw7XG5cbi8vIFRyYWNrIERPTSBldmVudCBsaXN0ZW5lcnNcbmlmICh0eXBlb2YgRXZlbnRUYXJnZXQgIT09ICd1bmRlZmluZWQnICYmIEV2ZW50VGFyZ2V0LnByb3RvdHlwZS5hZGRFdmVudExpc3RlbmVyKSB7XG4gICAgY29uc3Qgb3JpZ2luYWxBZGRFdmVudExpc3RlbmVyID0gRXZlbnRUYXJnZXQucHJvdG90eXBlLmFkZEV2ZW50TGlzdGVuZXI7XG4gICAgRXZlbnRUYXJnZXQucHJvdG90eXBlLmFkZEV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbih0eXBlOiBzdHJpbmcsIGxpc3RlbmVyOiBFdmVudExpc3RlbmVyLCBvcHRpb25zPzogYm9vbGVhbiB8IEFkZEV2ZW50TGlzdGVuZXJPcHRpb25zKSB7XG4gICAgICAgIGlmICghZ2xvYmFsVGVzdFN0YXRlLmV2ZW50TGlzdGVuZXJzLmhhcyh0aGlzKSkge1xuICAgICAgICAgICAgZ2xvYmFsVGVzdFN0YXRlLmV2ZW50TGlzdGVuZXJzLnNldCh0aGlzLCBbXSk7XG4gICAgICAgIH1cbiAgICAgICAgZ2xvYmFsVGVzdFN0YXRlLmV2ZW50TGlzdGVuZXJzLmdldCh0aGlzKSEucHVzaCh7IHR5cGUsIGxpc3RlbmVyIH0pO1xuICAgICAgICByZXR1cm4gb3JpZ2luYWxBZGRFdmVudExpc3RlbmVyLmNhbGwodGhpcywgdHlwZSwgbGlzdGVuZXIsIG9wdGlvbnMpO1xuICAgIH07XG59XG5cbi8vIFRyYWNrIERPTSBub2RlcyBjcmVhdGVkIGR1cmluZyB0ZXN0c1xuaWYgKHR5cGVvZiBkb2N1bWVudCAhPT0gJ3VuZGVmaW5lZCcgJiYgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCkge1xuICAgIGNvbnN0IG9yaWdpbmFsQ3JlYXRlRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQ7XG4gICAgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCA9IGZ1bmN0aW9uPEsgZXh0ZW5kcyBrZXlvZiBIVE1MRWxlbWVudFRhZ05hbWVNYXA+KHRhZ05hbWU6IEssIG9wdGlvbnM/OiBFbGVtZW50Q3JlYXRpb25PcHRpb25zKTogSFRNTEVsZW1lbnRUYWdOYW1lTWFwW0tdIHtcbiAgICAgICAgY29uc3QgZWxlbWVudCA9IG9yaWdpbmFsQ3JlYXRlRWxlbWVudC5jYWxsKHRoaXMsIHRhZ05hbWUsIG9wdGlvbnMpO1xuICAgICAgICBnbG9iYWxUZXN0U3RhdGUuZG9tTm9kZXMuYWRkKGVsZW1lbnQpO1xuICAgICAgICByZXR1cm4gZWxlbWVudDtcbiAgICB9O1xufVxuXG4vKipcbiAqIE1lbW9yeS1zYWZlIG1vY2sgZmFjdG9yeVxuICovXG5leHBvcnQgY2xhc3MgTWVtb3J5U2FmZU1vY2tGYWN0b3J5IHtcbiAgICBwcml2YXRlIHN0YXRpYyBpbnN0YW5jZXMgPSBuZXcgTWFwPHN0cmluZywgYW55PigpO1xuICAgIFxuICAgIHN0YXRpYyBjcmVhdGVNb2NrPFQ+KGlkZW50aWZpZXI6IHN0cmluZywgbW9ja0ltcGxlbWVudGF0aW9uOiAoKSA9PiBUKTogVCB7XG4gICAgICAgIGlmICh0aGlzLmluc3RhbmNlcy5oYXMoaWRlbnRpZmllcikpIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmluc3RhbmNlcy5nZXQoaWRlbnRpZmllcik7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGNvbnN0IG1vY2sgPSBtb2NrSW1wbGVtZW50YXRpb24oKTtcbiAgICAgICAgdGhpcy5pbnN0YW5jZXMuc2V0KGlkZW50aWZpZXIsIG1vY2spO1xuICAgICAgICBnbG9iYWxUZXN0U3RhdGUubW9ja0luc3RhbmNlcy5hZGQobW9jayk7XG4gICAgICAgIHJldHVybiBtb2NrO1xuICAgIH1cbiAgICBcbiAgICBzdGF0aWMgY2xlYXJNb2NrKGlkZW50aWZpZXI6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5pbnN0YW5jZXMuaGFzKGlkZW50aWZpZXIpKSB7XG4gICAgICAgICAgICBjb25zdCBtb2NrID0gdGhpcy5pbnN0YW5jZXMuZ2V0KGlkZW50aWZpZXIpO1xuICAgICAgICAgICAgZ2xvYmFsVGVzdFN0YXRlLm1vY2tJbnN0YW5jZXMuZGVsZXRlKG1vY2spO1xuICAgICAgICAgICAgdGhpcy5pbnN0YW5jZXMuZGVsZXRlKGlkZW50aWZpZXIpO1xuICAgICAgICB9XG4gICAgfVxuICAgIFxuICAgIHN0YXRpYyBjbGVhckFsbE1vY2tzKCk6IHZvaWQge1xuICAgICAgICB0aGlzLmluc3RhbmNlcy5jbGVhcigpO1xuICAgICAgICBnbG9iYWxUZXN0U3RhdGUubW9ja0luc3RhbmNlcy5jbGVhcigpO1xuICAgIH1cbn1cblxuLyoqXG4gKiBGb3JjZSBjbGVhbnVwIG9mIGFsbCB0ZXN0IHJlc291cmNlc1xuICovXG5leHBvcnQgZnVuY3Rpb24gZm9yY2VDbGVhbnVwVGVzdFJlc291cmNlcygpOiB2b2lkIHtcbiAgICAvLyBDbGVhciBhbGwgdGltZXJzXG4gICAgZ2xvYmFsVGVzdFN0YXRlLnRpbWVycy5mb3JFYWNoKHRpbWVyID0+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIC8vIElnbm9yZSBjbGVhbnVwIGVycm9yc1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgZ2xvYmFsVGVzdFN0YXRlLnRpbWVycy5jbGVhcigpO1xuICAgIFxuICAgIC8vIENsZWFyIGFsbCBpbnRlcnZhbHNcbiAgICBnbG9iYWxUZXN0U3RhdGUuaW50ZXJ2YWxzLmZvckVhY2goaW50ZXJ2YWwgPT4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY2xlYXJJbnRlcnZhbChpbnRlcnZhbCk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIC8vIElnbm9yZSBjbGVhbnVwIGVycm9yc1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgZ2xvYmFsVGVzdFN0YXRlLmludGVydmFscy5jbGVhcigpO1xuICAgIFxuICAgIC8vIFJlbW92ZSBhbGwgZXZlbnQgbGlzdGVuZXJzXG4gICAgZ2xvYmFsVGVzdFN0YXRlLmV2ZW50TGlzdGVuZXJzLmZvckVhY2goKGxpc3RlbmVycywgdGFyZ2V0KSA9PiB7XG4gICAgICAgIGxpc3RlbmVycy5mb3JFYWNoKCh7IHR5cGUsIGxpc3RlbmVyIH0pID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgdGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgbGlzdGVuZXIpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIC8vIElnbm9yZSBjbGVhbnVwIGVycm9yc1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcbiAgICBnbG9iYWxUZXN0U3RhdGUuZXZlbnRMaXN0ZW5lcnMuY2xlYXIoKTtcbiAgICBcbiAgICAvLyBDbGVhbiB1cCBET00gbm9kZXNcbiAgICBpZiAodHlwZW9mIGRvY3VtZW50ICE9PSAndW5kZWZpbmVkJykge1xuICAgICAgICBnbG9iYWxUZXN0U3RhdGUuZG9tTm9kZXMuZm9yRWFjaChub2RlID0+IHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgaWYgKG5vZGUucGFyZW50Tm9kZSkge1xuICAgICAgICAgICAgICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIC8vIElnbm9yZSBjbGVhbnVwIGVycm9yc1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgZ2xvYmFsVGVzdFN0YXRlLmRvbU5vZGVzLmNsZWFyKCk7XG4gICAgICAgIFxuICAgICAgICAvLyBDbGVhciBkb2N1bWVudCBib2R5XG4gICAgICAgIGlmIChkb2N1bWVudC5ib2R5KSB7XG4gICAgICAgICAgICBkb2N1bWVudC5ib2R5LmlubmVySFRNTCA9ICcnO1xuICAgICAgICB9XG4gICAgfVxuICAgIFxuICAgIC8vIENsZWFyIG1vY2sgaW5zdGFuY2VzXG4gICAgTWVtb3J5U2FmZU1vY2tGYWN0b3J5LmNsZWFyQWxsTW9ja3MoKTtcbiAgICBcbiAgICAvLyBGb3JjZSBnYXJiYWdlIGNvbGxlY3Rpb24gaWYgYXZhaWxhYmxlXG4gICAgaWYgKHR5cGVvZiBnbG9iYWwuZ2MgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGdsb2JhbC5nYygpO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAvLyBJZ25vcmUgR0MgZXJyb3JzXG4gICAgICAgIH1cbiAgICB9XG59XG5cbi8qKlxuICogTWVtb3J5IHVzYWdlIHRyYWNrZXIgZm9yIHRlc3RzXG4gKi9cbmV4cG9ydCBjbGFzcyBNZW1vcnlUcmFja2VyIHtcbiAgICBwcml2YXRlIHN0YXRpYyBzbmFwc2hvdHM6IEFycmF5PHsgdGVzdDogc3RyaW5nOyBtZW1vcnk6IE5vZGVKUy5NZW1vcnlVc2FnZTsgdGltZXN0YW1wOiBudW1iZXIgfT4gPSBbXTtcbiAgICBcbiAgICBzdGF0aWMgdGFrZVNuYXBzaG90KHRlc3ROYW1lOiBzdHJpbmcpOiBOb2RlSlMuTWVtb3J5VXNhZ2Uge1xuICAgICAgICBjb25zdCBtZW1vcnkgPSBwcm9jZXNzLm1lbW9yeVVzYWdlKCk7XG4gICAgICAgIHRoaXMuc25hcHNob3RzLnB1c2goe1xuICAgICAgICAgICAgdGVzdDogdGVzdE5hbWUsXG4gICAgICAgICAgICBtZW1vcnksXG4gICAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KClcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICAvLyBLZWVwIG9ubHkgbGFzdCAxMCBzbmFwc2hvdHMgdG8gcHJldmVudCBtZW1vcnkgYnVpbGR1cFxuICAgICAgICBpZiAodGhpcy5zbmFwc2hvdHMubGVuZ3RoID4gMTApIHtcbiAgICAgICAgICAgIHRoaXMuc25hcHNob3RzLnNoaWZ0KCk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHJldHVybiBtZW1vcnk7XG4gICAgfVxuICAgIFxuICAgIHN0YXRpYyBnZXRNZW1vcnlJbmNyZWFzZShmcm9tOiBzdHJpbmcsIHRvOiBzdHJpbmcpOiBudW1iZXIge1xuICAgICAgICBjb25zdCBmcm9tU25hcHNob3QgPSB0aGlzLnNuYXBzaG90cy5maW5kKHMgPT4gcy50ZXN0ID09PSBmcm9tKTtcbiAgICAgICAgY29uc3QgdG9TbmFwc2hvdCA9IHRoaXMuc25hcHNob3RzLmZpbmQocyA9PiBzLnRlc3QgPT09IHRvKTtcbiAgICAgICAgXG4gICAgICAgIGlmICghZnJvbVNuYXBzaG90IHx8ICF0b1NuYXBzaG90KSB7XG4gICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHRvU25hcHNob3QubWVtb3J5LmhlYXBVc2VkIC0gZnJvbVNuYXBzaG90Lm1lbW9yeS5oZWFwVXNlZDtcbiAgICB9XG4gICAgXG4gICAgc3RhdGljIHJlcG9ydE1lbW9yeVVzYWdlKCk6IHZvaWQge1xuICAgICAgICBpZiAocHJvY2Vzcy5lbnYuSkVTVF9WRVJCT1NFIHx8IHByb2Nlc3MuZW52Lk1FTU9SWV9ERUJVRykge1xuICAgICAgICAgICAgY29uc29sZS5sb2coJ01lbW9yeSBVc2FnZSBSZXBvcnQ6Jyk7XG4gICAgICAgICAgICB0aGlzLnNuYXBzaG90cy5mb3JFYWNoKHNuYXBzaG90ID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBtYiA9IChzbmFwc2hvdC5tZW1vcnkuaGVhcFVzZWQgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgICAke3NuYXBzaG90LnRlc3R9OiAke21ifU1CYCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBcbiAgICBzdGF0aWMgY2xlYXJTbmFwc2hvdHMoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuc25hcHNob3RzLmxlbmd0aCA9IDA7XG4gICAgfVxufVxuXG4vLyBHbG9iYWwgc2V0dXAgYW5kIHRlYXJkb3duXG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgICAvLyBDbGVhciBhbnkgaGFuZ2luZyByZXNvdXJjZXMgYmVmb3JlIGVhY2ggdGVzdFxuICAgIGZvcmNlQ2xlYW51cFRlc3RSZXNvdXJjZXMoKTtcbiAgICBcbiAgICAvLyBUYWtlIG1lbW9yeSBzbmFwc2hvdFxuICAgIGNvbnN0IHRlc3ROYW1lID0gZXhwZWN0LmdldFN0YXRlKCk/LmN1cnJlbnRUZXN0TmFtZSB8fCAndW5rbm93bic7XG4gICAgTWVtb3J5VHJhY2tlci50YWtlU25hcHNob3QoYGJlZm9yZS0ke3Rlc3ROYW1lfWApO1xufSk7XG5cbmFmdGVyRWFjaCgoKSA9PiB7XG4gICAgLy8gQ2xlYXIgYWxsIHJlc291cmNlcyBhZnRlciBlYWNoIHRlc3RcbiAgICBmb3JjZUNsZWFudXBUZXN0UmVzb3VyY2VzKCk7XG4gICAgXG4gICAgLy8gVGFrZSBtZW1vcnkgc25hcHNob3RcbiAgICBjb25zdCB0ZXN0TmFtZSA9IGV4cGVjdC5nZXRTdGF0ZSgpPy5jdXJyZW50VGVzdE5hbWUgfHwgJ3Vua25vd24nO1xuICAgIE1lbW9yeVRyYWNrZXIudGFrZVNuYXBzaG90KGBhZnRlci0ke3Rlc3ROYW1lfWApO1xuICAgIFxuICAgIC8vIFJlcG9ydCBleGNlc3NpdmUgbWVtb3J5IHVzYWdlXG4gICAgY29uc3QgaW5jcmVhc2UgPSBNZW1vcnlUcmFja2VyLmdldE1lbW9yeUluY3JlYXNlKGBiZWZvcmUtJHt0ZXN0TmFtZX1gLCBgYWZ0ZXItJHt0ZXN0TmFtZX1gKTtcbiAgICBjb25zdCB3YXJuaW5nVGhyZXNob2xkID0gcHJvY2Vzcy5lbnYuQ0kgPyAxMCAqIDEwMjQgKiAxMDI0IDogNTAgKiAxMDI0ICogMTAyNDsgLy8gMTBNQiBpbiBDSSwgNTBNQiBsb2NhbGx5XG4gICAgXG4gICAgaWYgKGluY3JlYXNlID4gd2FybmluZ1RocmVzaG9sZCkge1xuICAgICAgICBjb25zb2xlLndhcm4oYFdhcm5pbmc6IFRlc3QgXCIke3Rlc3ROYW1lfVwiIHVzZWQgJHsoaW5jcmVhc2UgLyAxMDI0IC8gMTAyNCkudG9GaXhlZCgyKX1NQiBvZiBtZW1vcnlgKTtcbiAgICB9XG59KTtcblxuYWZ0ZXJBbGwoKCkgPT4ge1xuICAgIC8vIEZpbmFsIGNsZWFudXAgYW5kIG1lbW9yeSByZXBvcnRcbiAgICBmb3JjZUNsZWFudXBUZXN0UmVzb3VyY2VzKCk7XG4gICAgTWVtb3J5VHJhY2tlci5yZXBvcnRNZW1vcnlVc2FnZSgpO1xuICAgIE1lbW9yeVRyYWNrZXIuY2xlYXJTbmFwc2hvdHMoKTtcbn0pO1xuXG4vLyBFeHBvcnQgdXRpbGl0aWVzIGZvciB1c2UgaW4gdGVzdHNcbmV4cG9ydCB7IGdsb2JhbFRlc3RTdGF0ZSwgZm9yY2VDbGVhbnVwVGVzdFJlc291cmNlcyB9OyJdLCJ2ZXJzaW9uIjozfQ==