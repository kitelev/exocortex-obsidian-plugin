import * as fs from 'fs-extra';
import * as path from 'path';
import * as glob from 'glob';
import * as yaml from 'js-yaml';
import { FileNotFoundError, FileAlreadyExistsError } from '@exocortex/core';
export class NodeFsAdapter {
    constructor(rootPath) {
        this.rootPath = rootPath;
    }
    async readFile(filePath) {
        const fullPath = this.resolvePath(filePath);
        if (!await fs.pathExists(fullPath)) {
            throw new FileNotFoundError(filePath);
        }
        return fs.readFile(fullPath, 'utf-8');
    }
    async fileExists(filePath) {
        const fullPath = this.resolvePath(filePath);
        return fs.pathExists(fullPath);
    }
    async getFileMetadata(filePath) {
        const content = await this.readFile(filePath);
        return this.extractFrontmatter(content);
    }
    async createFile(filePath, content) {
        const fullPath = this.resolvePath(filePath);
        if (await fs.pathExists(fullPath)) {
            throw new FileAlreadyExistsError(filePath);
        }
        await fs.ensureDir(path.dirname(fullPath));
        await fs.writeFile(fullPath, content, 'utf-8');
        return filePath;
    }
    async updateFile(filePath, content) {
        const fullPath = this.resolvePath(filePath);
        if (!await fs.pathExists(fullPath)) {
            throw new FileNotFoundError(filePath);
        }
        await fs.writeFile(fullPath, content, 'utf-8');
    }
    async writeFile(filePath, content) {
        const fullPath = this.resolvePath(filePath);
        await fs.ensureDir(path.dirname(fullPath));
        await fs.writeFile(fullPath, content, 'utf-8');
    }
    async deleteFile(filePath) {
        const fullPath = this.resolvePath(filePath);
        if (!await fs.pathExists(fullPath)) {
            throw new FileNotFoundError(filePath);
        }
        await fs.remove(fullPath);
    }
    async renameFile(oldPath, newPath) {
        const fullOldPath = this.resolvePath(oldPath);
        const fullNewPath = this.resolvePath(newPath);
        if (!await fs.pathExists(fullOldPath)) {
            throw new FileNotFoundError(oldPath);
        }
        await fs.ensureDir(path.dirname(fullNewPath));
        await fs.move(fullOldPath, fullNewPath);
    }
    async createDirectory(dirPath) {
        const fullPath = this.resolvePath(dirPath);
        await fs.ensureDir(fullPath);
    }
    async directoryExists(dirPath) {
        const fullPath = this.resolvePath(dirPath);
        if (!await fs.pathExists(fullPath))
            return false;
        const stats = await fs.stat(fullPath);
        return stats.isDirectory();
    }
    async getMarkdownFiles(rootPath) {
        const searchPath = rootPath ? this.resolvePath(rootPath) : this.rootPath;
        const pattern = path.join(searchPath, '**/*.md');
        const files = await glob.glob(pattern, { nodir: true });
        const relativePaths = files.map((f) => path.relative(this.rootPath, f));
        return relativePaths;
    }
    async findFilesByMetadata(query) {
        const allFiles = await this.getMarkdownFiles();
        const matches = [];
        for (const file of allFiles) {
            try {
                const metadata = await this.getFileMetadata(file);
                if (this.matchesQuery(metadata, query)) {
                    matches.push(file);
                }
            }
            catch (error) {
                continue;
            }
        }
        return matches;
    }
    async findFileByUID(uid) {
        const files = await this.findFilesByMetadata({ 'exo__Asset_uid': uid });
        return files.length > 0 ? files[0] : null;
    }
    resolvePath(filePath) {
        if (path.isAbsolute(filePath)) {
            return filePath;
        }
        return path.join(this.rootPath, filePath);
    }
    extractFrontmatter(content) {
        const frontmatterRegex = /^---\n([\s\S]*?)\n---/;
        const match = content.match(frontmatterRegex);
        if (!match) {
            return {};
        }
        try {
            const parsed = yaml.load(match[1]);
            return typeof parsed === 'object' && parsed !== null ? parsed : {};
        }
        catch (error) {
            return {};
        }
    }
    matchesQuery(metadata, query) {
        for (const [key, value] of Object.entries(query)) {
            const metaValue = metadata[key];
            if (Array.isArray(metaValue)) {
                if (!metaValue.some(v => this.normalizeValue(v) === this.normalizeValue(value))) {
                    return false;
                }
            }
            else if (this.normalizeValue(metaValue) !== this.normalizeValue(value)) {
                return false;
            }
        }
        return true;
    }
    normalizeValue(value) {
        if (value === null || value === undefined)
            return '';
        return String(value).replace(/["'[\]]/g, '').trim();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTm9kZUZzQWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hZGFwdGVycy9Ob2RlRnNBZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQy9CLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQzdCLE9BQU8sS0FBSyxJQUFJLE1BQU0sTUFBTSxDQUFDO0FBQzdCLE9BQU8sS0FBSyxJQUFJLE1BQU0sU0FBUyxDQUFDO0FBQ2hDLE9BQU8sRUFFTCxpQkFBaUIsRUFDakIsc0JBQXNCLEVBQ3ZCLE1BQU0saUJBQWlCLENBQUM7QUFFekIsTUFBTSxPQUFPLGFBQWE7SUFDeEIsWUFBb0IsUUFBZ0I7UUFBaEIsYUFBUSxHQUFSLFFBQVEsQ0FBUTtJQUFHLENBQUM7SUFFeEMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxRQUFnQjtRQUM3QixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzVDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztZQUNuQyxNQUFNLElBQUksaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDeEMsQ0FBQztRQUNELE9BQU8sRUFBRSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUVELEtBQUssQ0FBQyxVQUFVLENBQUMsUUFBZ0I7UUFDL0IsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM1QyxPQUFPLEVBQUUsQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDakMsQ0FBQztJQUVELEtBQUssQ0FBQyxlQUFlLENBQUMsUUFBZ0I7UUFDcEMsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEs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RUFBRSxDQUFDO0lBQ3RELENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzLWV4dHJhJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgKiBhcyBnbG9iIGZyb20gJ2dsb2InO1xuaW1wb3J0ICogYXMgeWFtbCBmcm9tICdqcy15YW1sJztcbmltcG9ydCB7XG4gIElGaWxlU3lzdGVtQWRhcHRlcixcbiAgRmlsZU5vdEZvdW5kRXJyb3IsXG4gIEZpbGVBbHJlYWR5RXhpc3RzRXJyb3Jcbn0gZnJvbSAnQGV4b2NvcnRleC9jb3JlJztcblxuZXhwb3J0IGNsYXNzIE5vZGVGc0FkYXB0ZXIgaW1wbGVtZW50cyBJRmlsZVN5c3RlbUFkYXB0ZXIge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJvb3RQYXRoOiBzdHJpbmcpIHt9XG5cbiAgYXN5bmMgcmVhZEZpbGUoZmlsZVBhdGg6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgZnVsbFBhdGggPSB0aGlzLnJlc29sdmVQYXRoKGZpbGVQYXRoKTtcbiAgICBpZiAoIWF3YWl0IGZzLnBhdGhFeGlzdHMoZnVsbFBhdGgpKSB7XG4gICAgICB0aHJvdyBuZXcgRmlsZU5vdEZvdW5kRXJyb3IoZmlsZVBhdGgpO1xuICAgIH1cbiAgICByZXR1cm4gZnMucmVhZEZpbGUoZnVsbFBhdGgsICd1dGYtOCcpO1xuICB9XG5cbiAgYXN5bmMgZmlsZUV4aXN0cyhmaWxlUGF0aDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgZnVsbFBhdGggPSB0aGlzLnJlc29sdmVQYXRoKGZpbGVQYXRoKTtcbiAgICByZXR1cm4gZnMucGF0aEV4aXN0cyhmdWxsUGF0aCk7XG4gIH1cblxuICBhc3luYyBnZXRGaWxlTWV0YWRhdGEoZmlsZVBhdGg6IHN0cmluZyk6IFByb21pc2U8UmVjb3JkPHN0cmluZywgYW55Pj4ge1xuICAgIGNvbnN0IGNvbnRlbnQgPSBhd2FpdCB0aGlzLnJlYWRGaWxlKGZpbGVQYXRoKTtcbiAgICByZXR1cm4gdGhpcy5leHRyYWN0RnJvbnRtYXR0ZXIoY29udGVudCk7XG4gIH1cblxuICBhc3luYyBjcmVhdGVGaWxlKGZpbGVQYXRoOiBzdHJpbmcsIGNvbnRlbnQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgZnVsbFBhdGggPSB0aGlzLnJlc29sdmVQYXRoKGZpbGVQYXRoKTtcbiAgICBpZiAoYXdhaXQgZnMucGF0aEV4aXN0cyhmdWxsUGF0aCkpIHtcbiAgICAgIHRocm93IG5ldyBGaWxlQWxyZWFkeUV4aXN0c0Vycm9yKGZpbGVQYXRoKTtcbiAgICB9XG4gICAgYXdhaXQgZnMuZW5zdXJlRGlyKHBhdGguZGlybmFtZShmdWxsUGF0aCkpO1xuICAgIGF3YWl0IGZzLndyaXRlRmlsZShmdWxsUGF0aCwgY29udGVudCwgJ3V0Zi04Jyk7XG4gICAgcmV0dXJuIGZpbGVQYXRoO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlRmlsZShmaWxlUGF0aDogc3RyaW5nLCBjb250ZW50OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBmdWxsUGF0aCA9IHRoaXMucmVzb2x2ZVBhdGgoZmlsZVBhdGgpO1xuICAgIGlmICghYXdhaXQgZnMucGF0aEV4aXN0cyhmdWxsUGF0aCkpIHtcbiAgICAgIHRocm93IG5ldyBGaWxlTm90Rm91bmRFcnJvcihmaWxlUGF0aCk7XG4gICAgfVxuICAgIGF3YWl0IGZzLndyaXRlRmlsZShmdWxsUGF0aCwgY29udGVudCwgJ3V0Zi04Jyk7XG4gIH1cblxuICBhc3luYyB3cml0ZUZpbGUoZmlsZVBhdGg6IHN0cmluZywgY29udGVudDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZnVsbFBhdGggPSB0aGlzLnJlc29sdmVQYXRoKGZpbGVQYXRoKTtcbiAgICBhd2FpdCBmcy5lbnN1cmVEaXIocGF0aC5kaXJuYW1lKGZ1bGxQYXRoKSk7XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKGZ1bGxQYXRoLCBjb250ZW50LCAndXRmLTgnKTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZUZpbGUoZmlsZVBhdGg6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGZ1bGxQYXRoID0gdGhpcy5yZXNvbHZlUGF0aChmaWxlUGF0aCk7XG4gICAgaWYgKCFhd2FpdCBmcy5wYXRoRXhpc3RzKGZ1bGxQYXRoKSkge1xuICAgICAgdGhyb3cgbmV3IEZpbGVOb3RGb3VuZEVycm9yKGZpbGVQYXRoKTtcbiAgICB9XG4gICAgYXdhaXQgZnMucmVtb3ZlKGZ1bGxQYXRoKTtcbiAgfVxuXG4gIGFzeW5jIHJlbmFtZUZpbGUob2xkUGF0aDogc3RyaW5nLCBuZXdQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBmdWxsT2xkUGF0aCA9IHRoaXMucmVzb2x2ZVBhdGgob2xkUGF0aCk7XG4gICAgY29uc3QgZnVsbE5ld1BhdGggPSB0aGlzLnJlc29sdmVQYXRoKG5ld1BhdGgpO1xuICAgIGlmICghYXdhaXQgZnMucGF0aEV4aXN0cyhmdWxsT2xkUGF0aCkpIHtcbiAgICAgIHRocm93IG5ldyBGaWxlTm90Rm91bmRFcnJvcihvbGRQYXRoKTtcbiAgICB9XG4gICAgYXdhaXQgZnMuZW5zdXJlRGlyKHBhdGguZGlybmFtZShmdWxsTmV3UGF0aCkpO1xuICAgIGF3YWl0IGZzLm1vdmUoZnVsbE9sZFBhdGgsIGZ1bGxOZXdQYXRoKTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZURpcmVjdG9yeShkaXJQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBmdWxsUGF0aCA9IHRoaXMucmVzb2x2ZVBhdGgoZGlyUGF0aCk7XG4gICAgYXdhaXQgZnMuZW5zdXJlRGlyKGZ1bGxQYXRoKTtcbiAgfVxuXG4gIGFzeW5jIGRpcmVjdG9yeUV4aXN0cyhkaXJQYXRoOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBmdWxsUGF0aCA9IHRoaXMucmVzb2x2ZVBhdGgoZGlyUGF0aCk7XG4gICAgaWYgKCFhd2FpdCBmcy5wYXRoRXhpc3RzKGZ1bGxQYXRoKSkgcmV0dXJuIGZhbHNlO1xuICAgIGNvbnN0IHN0YXRzID0gYXdhaXQgZnMuc3RhdChmdWxsUGF0aCk7XG4gICAgcmV0dXJuIHN0YXRzLmlzRGlyZWN0b3J5KCk7XG4gIH1cblxuICBhc3luYyBnZXRNYXJrZG93bkZpbGVzKHJvb3RQYXRoPzogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGNvbnN0IHNlYXJjaFBhdGggPSByb290UGF0aCA/IHRoaXMucmVzb2x2ZVBhdGgocm9vdFBhdGgpIDogdGhpcy5yb290UGF0aDtcbiAgICBjb25zdCBwYXR0ZXJuID0gcGF0aC5qb2luKHNlYXJjaFBhdGgsICcqKi8qLm1kJyk7XG5cbiAgICBjb25zdCBmaWxlcyA9IGF3YWl0IGdsb2IuZ2xvYihwYXR0ZXJuLCB7IG5vZGlyOiB0cnVlIH0pO1xuICAgIGNvbnN0IHJlbGF0aXZlUGF0aHMgPSBmaWxlcy5tYXAoKGY6IHN0cmluZykgPT4gcGF0aC5yZWxhdGl2ZSh0aGlzLnJvb3RQYXRoLCBmKSk7XG4gICAgcmV0dXJuIHJlbGF0aXZlUGF0aHM7XG4gIH1cblxuICBhc3luYyBmaW5kRmlsZXNCeU1ldGFkYXRhKHF1ZXJ5OiBSZWNvcmQ8c3RyaW5nLCBhbnk+KTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGNvbnN0IGFsbEZpbGVzID0gYXdhaXQgdGhpcy5nZXRNYXJrZG93bkZpbGVzKCk7XG4gICAgY29uc3QgbWF0Y2hlczogc3RyaW5nW10gPSBbXTtcblxuICAgIGZvciAoY29uc3QgZmlsZSBvZiBhbGxGaWxlcykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgbWV0YWRhdGEgPSBhd2FpdCB0aGlzLmdldEZpbGVNZXRhZGF0YShmaWxlKTtcbiAgICAgICAgaWYgKHRoaXMubWF0Y2hlc1F1ZXJ5KG1ldGFkYXRhLCBxdWVyeSkpIHtcbiAgICAgICAgICBtYXRjaGVzLnB1c2goZmlsZSk7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBtYXRjaGVzO1xuICB9XG5cbiAgYXN5bmMgZmluZEZpbGVCeVVJRCh1aWQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nIHwgbnVsbD4ge1xuICAgIGNvbnN0IGZpbGVzID0gYXdhaXQgdGhpcy5maW5kRmlsZXNCeU1ldGFkYXRhKHsgJ2V4b19fQXNzZXRfdWlkJzogdWlkIH0pO1xuICAgIHJldHVybiBmaWxlcy5sZW5ndGggPiAwID8gZmlsZXNbMF0gOiBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSByZXNvbHZlUGF0aChmaWxlUGF0aDogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAocGF0aC5pc0Fic29sdXRlKGZpbGVQYXRoKSkge1xuICAgICAgcmV0dXJuIGZpbGVQYXRoO1xuICAgIH1cbiAgICByZXR1cm4gcGF0aC5qb2luKHRoaXMucm9vdFBhdGgsIGZpbGVQYXRoKTtcbiAgfVxuXG4gIHByaXZhdGUgZXh0cmFjdEZyb250bWF0dGVyKGNvbnRlbnQ6IHN0cmluZyk6IFJlY29yZDxzdHJpbmcsIGFueT4ge1xuICAgIGNvbnN0IGZyb250bWF0dGVyUmVnZXggPSAvXi0tLVxcbihbXFxzXFxTXSo/KVxcbi0tLS87XG4gICAgY29uc3QgbWF0Y2ggPSBjb250ZW50Lm1hdGNoKGZyb250bWF0dGVyUmVnZXgpO1xuXG4gICAgaWYgKCFtYXRjaCkge1xuICAgICAgcmV0dXJuIHt9O1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBjb25zdCBwYXJzZWQgPSB5YW1sLmxvYWQobWF0Y2hbMV0pO1xuICAgICAgcmV0dXJuIHR5cGVvZiBwYXJzZWQgPT09ICdvYmplY3QnICYmIHBhcnNlZCAhPT0gbnVsbCA/IHBhcnNlZCBhcyBSZWNvcmQ8c3RyaW5nLCBhbnk+IDoge307XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG1hdGNoZXNRdWVyeShtZXRhZGF0YTogUmVjb3JkPHN0cmluZywgYW55PiwgcXVlcnk6IFJlY29yZDxzdHJpbmcsIGFueT4pOiBib29sZWFuIHtcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhxdWVyeSkpIHtcbiAgICAgIGNvbnN0IG1ldGFWYWx1ZSA9IG1ldGFkYXRhW2tleV07XG5cbiAgICAgIGlmIChBcnJheS5pc0FycmF5KG1ldGFWYWx1ZSkpIHtcbiAgICAgICAgaWYgKCFtZXRhVmFsdWUuc29tZSh2ID0+IHRoaXMubm9ybWFsaXplVmFsdWUodikgPT09IHRoaXMubm9ybWFsaXplVmFsdWUodmFsdWUpKSkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmICh0aGlzLm5vcm1hbGl6ZVZhbHVlKG1ldGFWYWx1ZSkgIT09IHRoaXMubm9ybWFsaXplVmFsdWUodmFsdWUpKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwcml2YXRlIG5vcm1hbGl6ZVZhbHVlKHZhbHVlOiBhbnkpOiBzdHJpbmcge1xuICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gJyc7XG4gICAgcmV0dXJuIFN0cmluZyh2YWx1ZSkucmVwbGFjZSgvW1wiJ1tcXF1dL2csICcnKS50cmltKCk7XG4gIH1cbn1cbiJdfQ==