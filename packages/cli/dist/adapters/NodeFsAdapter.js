import fs from "fs-extra";
import path from "path";
import * as glob from "glob";
import yaml from "js-yaml";
import { FileNotFoundError, FileAlreadyExistsError, } from "@exocortex/core";
export class NodeFsAdapter {
    constructor(rootPath) {
        this.rootPath = rootPath;
    }
    async readFile(filePath) {
        const fullPath = this.resolvePath(filePath);
        if (!(await fs.pathExists(fullPath))) {
            throw new FileNotFoundError(filePath);
        }
        return fs.readFile(fullPath, "utf-8");
    }
    async fileExists(filePath) {
        const fullPath = this.resolvePath(filePath);
        return fs.pathExists(fullPath);
    }
    async getFileMetadata(filePath) {
        const content = await this.readFile(filePath);
        return this.extractFrontmatter(content);
    }
    async createFile(filePath, content) {
        const fullPath = this.resolvePath(filePath);
        if (await fs.pathExists(fullPath)) {
            throw new FileAlreadyExistsError(filePath);
        }
        await fs.ensureDir(path.dirname(fullPath));
        await fs.writeFile(fullPath, content, "utf-8");
        return filePath;
    }
    async updateFile(filePath, content) {
        const fullPath = this.resolvePath(filePath);
        if (!(await fs.pathExists(fullPath))) {
            throw new FileNotFoundError(filePath);
        }
        await fs.writeFile(fullPath, content, "utf-8");
    }
    async writeFile(filePath, content) {
        const fullPath = this.resolvePath(filePath);
        await fs.ensureDir(path.dirname(fullPath));
        await fs.writeFile(fullPath, content, "utf-8");
    }
    async deleteFile(filePath) {
        const fullPath = this.resolvePath(filePath);
        if (!(await fs.pathExists(fullPath))) {
            throw new FileNotFoundError(filePath);
        }
        await fs.remove(fullPath);
    }
    async renameFile(oldPath, newPath) {
        const fullOldPath = this.resolvePath(oldPath);
        const fullNewPath = this.resolvePath(newPath);
        if (!(await fs.pathExists(fullOldPath))) {
            throw new FileNotFoundError(oldPath);
        }
        await fs.ensureDir(path.dirname(fullNewPath));
        await fs.move(fullOldPath, fullNewPath);
    }
    async createDirectory(dirPath) {
        const fullPath = this.resolvePath(dirPath);
        await fs.ensureDir(fullPath);
    }
    async directoryExists(dirPath) {
        const fullPath = this.resolvePath(dirPath);
        if (!(await fs.pathExists(fullPath)))
            return false;
        const stats = await fs.stat(fullPath);
        return stats.isDirectory();
    }
    async getMarkdownFiles(rootPath) {
        const searchPath = rootPath ? this.resolvePath(rootPath) : this.rootPath;
        const pattern = path.join(searchPath, "**/*.md");
        const files = await glob.glob(pattern, { nodir: true });
        const relativePaths = files.map((f) => path.relative(this.rootPath, f));
        return relativePaths;
    }
    async findFilesByMetadata(query) {
        const allFiles = await this.getMarkdownFiles();
        const matches = [];
        for (const file of allFiles) {
            try {
                const metadata = await this.getFileMetadata(file);
                if (this.matchesQuery(metadata, query)) {
                    matches.push(file);
                }
            }
            catch (error) {
                continue;
            }
        }
        return matches;
    }
    async findFileByUID(uid) {
        const files = await this.findFilesByMetadata({ exo__Asset_uid: uid });
        return files.length > 0 ? files[0] : null;
    }
    resolvePath(filePath) {
        if (path.isAbsolute(filePath)) {
            return filePath;
        }
        return path.join(this.rootPath, filePath);
    }
    extractFrontmatter(content) {
        const frontmatterRegex = /^---\n([\s\S]*?)\n---/;
        const match = content.match(frontmatterRegex);
        if (!match) {
            return {};
        }
        try {
            const parsed = yaml.load(match[1]);
            return typeof parsed === "object" && parsed !== null
                ? parsed
                : {};
        }
        catch (error) {
            return {};
        }
    }
    matchesQuery(metadata, query) {
        for (const [key, value] of Object.entries(query)) {
            const metaValue = metadata[key];
            if (Array.isArray(metaValue)) {
                if (!metaValue.some((v) => this.normalizeValue(v) === this.normalizeValue(value))) {
                    return false;
                }
            }
            else if (this.normalizeValue(metaValue) !== this.normalizeValue(value)) {
                return false;
            }
        }
        return true;
    }
    normalizeValue(value) {
        if (value === null || value === undefined)
            return "";
        return String(value)
            .replace(/["'[\]]/g, "")
            .trim();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTm9kZUZzQWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9hZGFwdGVycy9Ob2RlRnNBZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUMxQixPQUFPLElBQUksTUFBTSxNQUFNLENBQUM7QUFDeEIsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFDN0IsT0FBTyxJQUFJLE1BQU0sU0FBUyxDQUFDO0FBQzNCLE9BQU8sRUFFTCxpQkFBaUIsRUFDakIsc0JBQXNCLEdBQ3ZCLE1BQU0saUJBQWlCLENBQUM7QUFFekIsTUFBTSxPQUFPLGFBQWE7SUFDeEIsWUFBb0IsUUFBZ0I7UUFBaEIsYUFBUSxHQUFSLFFBQVEsQ0FBUTtJQUFHLENBQUM7SUFFeEMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxRQUFnQjtRQUM3QixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQzVDLElBQUksQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDckMsTUFBTSxJQUFJLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3hDLENBQUM7UUFDRCxPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFFRCxLQUFLLENBQUMsVUFBVSxDQUFDLFFBQWdCO1FBQy9CLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDNUMsT0FBTyxFQUFFLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFFRCxLQUFLLENBQUMsZUFBZSxDQUFDLFFBQWdCO1FBQ3BDLE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMs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QUNqQixPQUFPLENBQUMsVUFBVSxFQUFFLEVBQUUsQ0FBQzthQUN2QixJQUFJLEVBQUUsQ0FBQztJQUNaLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tIFwiZnMtZXh0cmFcIjtcbmltcG9ydCBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgKiBhcyBnbG9iIGZyb20gXCJnbG9iXCI7XG5pbXBvcnQgeWFtbCBmcm9tIFwianMteWFtbFwiO1xuaW1wb3J0IHtcbiAgSUZpbGVTeXN0ZW1BZGFwdGVyLFxuICBGaWxlTm90Rm91bmRFcnJvcixcbiAgRmlsZUFscmVhZHlFeGlzdHNFcnJvcixcbn0gZnJvbSBcIkBleG9jb3J0ZXgvY29yZVwiO1xuXG5leHBvcnQgY2xhc3MgTm9kZUZzQWRhcHRlciBpbXBsZW1lbnRzIElGaWxlU3lzdGVtQWRhcHRlciB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgcm9vdFBhdGg6IHN0cmluZykge31cblxuICBhc3luYyByZWFkRmlsZShmaWxlUGF0aDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCBmdWxsUGF0aCA9IHRoaXMucmVzb2x2ZVBhdGgoZmlsZVBhdGgpO1xuICAgIGlmICghKGF3YWl0IGZzLnBhdGhFeGlzdHMoZnVsbFBhdGgpKSkge1xuICAgICAgdGhyb3cgbmV3IEZpbGVOb3RGb3VuZEVycm9yKGZpbGVQYXRoKTtcbiAgICB9XG4gICAgcmV0dXJuIGZzLnJlYWRGaWxlKGZ1bGxQYXRoLCBcInV0Zi04XCIpO1xuICB9XG5cbiAgYXN5bmMgZmlsZUV4aXN0cyhmaWxlUGF0aDogc3RyaW5nKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgZnVsbFBhdGggPSB0aGlzLnJlc29sdmVQYXRoKGZpbGVQYXRoKTtcbiAgICByZXR1cm4gZnMucGF0aEV4aXN0cyhmdWxsUGF0aCk7XG4gIH1cblxuICBhc3luYyBnZXRGaWxlTWV0YWRhdGEoZmlsZVBhdGg6IHN0cmluZyk6IFByb21pc2U8UmVjb3JkPHN0cmluZywgYW55Pj4ge1xuICAgIGNvbnN0IGNvbnRlbnQgPSBhd2FpdCB0aGlzLnJlYWRGaWxlKGZpbGVQYXRoKTtcbiAgICByZXR1cm4gdGhpcy5leHRyYWN0RnJvbnRtYXR0ZXIoY29udGVudCk7XG4gIH1cblxuICBhc3luYyBjcmVhdGVGaWxlKGZpbGVQYXRoOiBzdHJpbmcsIGNvbnRlbnQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgZnVsbFBhdGggPSB0aGlzLnJlc29sdmVQYXRoKGZpbGVQYXRoKTtcbiAgICBpZiAoYXdhaXQgZnMucGF0aEV4aXN0cyhmdWxsUGF0aCkpIHtcbiAgICAgIHRocm93IG5ldyBGaWxlQWxyZWFkeUV4aXN0c0Vycm9yKGZpbGVQYXRoKTtcbiAgICB9XG4gICAgYXdhaXQgZnMuZW5zdXJlRGlyKHBhdGguZGlybmFtZShmdWxsUGF0aCkpO1xuICAgIGF3YWl0IGZzLndyaXRlRmlsZShmdWxsUGF0aCwgY29udGVudCwgXCJ1dGYtOFwiKTtcbiAgICByZXR1cm4gZmlsZVBhdGg7XG4gIH1cblxuICBhc3luYyB1cGRhdGVGaWxlKGZpbGVQYXRoOiBzdHJpbmcsIGNvbnRlbnQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGZ1bGxQYXRoID0gdGhpcy5yZXNvbHZlUGF0aChmaWxlUGF0aCk7XG4gICAgaWYgKCEoYXdhaXQgZnMucGF0aEV4aXN0cyhmdWxsUGF0aCkpKSB7XG4gICAgICB0aHJvdyBuZXcgRmlsZU5vdEZvdW5kRXJyb3IoZmlsZVBhdGgpO1xuICAgIH1cbiAgICBhd2FpdCBmcy53cml0ZUZpbGUoZnVsbFBhdGgsIGNvbnRlbnQsIFwidXRmLThcIik7XG4gIH1cblxuICBhc3luYyB3cml0ZUZpbGUoZmlsZVBhdGg6IHN0cmluZywgY29udGVudDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZnVsbFBhdGggPSB0aGlzLnJlc29sdmVQYXRoKGZpbGVQYXRoKTtcbiAgICBhd2FpdCBmcy5lbnN1cmVEaXIocGF0aC5kaXJuYW1lKGZ1bGxQYXRoKSk7XG4gICAgYXdhaXQgZnMud3JpdGVGaWxlKGZ1bGxQYXRoLCBjb250ZW50LCBcInV0Zi04XCIpO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlRmlsZShmaWxlUGF0aDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZnVsbFBhdGggPSB0aGlzLnJlc29sdmVQYXRoKGZpbGVQYXRoKTtcbiAgICBpZiAoIShhd2FpdCBmcy5wYXRoRXhpc3RzKGZ1bGxQYXRoKSkpIHtcbiAgICAgIHRocm93IG5ldyBGaWxlTm90Rm91bmRFcnJvcihmaWxlUGF0aCk7XG4gICAgfVxuICAgIGF3YWl0IGZzLnJlbW92ZShmdWxsUGF0aCk7XG4gIH1cblxuICBhc3luYyByZW5hbWVGaWxlKG9sZFBhdGg6IHN0cmluZywgbmV3UGF0aDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZnVsbE9sZFBhdGggPSB0aGlzLnJlc29sdmVQYXRoKG9sZFBhdGgpO1xuICAgIGNvbnN0IGZ1bGxOZXdQYXRoID0gdGhpcy5yZXNvbHZlUGF0aChuZXdQYXRoKTtcbiAgICBpZiAoIShhd2FpdCBmcy5wYXRoRXhpc3RzKGZ1bGxPbGRQYXRoKSkpIHtcbiAgICAgIHRocm93IG5ldyBGaWxlTm90Rm91bmRFcnJvcihvbGRQYXRoKTtcbiAgICB9XG4gICAgYXdhaXQgZnMuZW5zdXJlRGlyKHBhdGguZGlybmFtZShmdWxsTmV3UGF0aCkpO1xuICAgIGF3YWl0IGZzLm1vdmUoZnVsbE9sZFBhdGgsIGZ1bGxOZXdQYXRoKTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZURpcmVjdG9yeShkaXJQYXRoOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBmdWxsUGF0aCA9IHRoaXMucmVzb2x2ZVBhdGgoZGlyUGF0aCk7XG4gICAgYXdhaXQgZnMuZW5zdXJlRGlyKGZ1bGxQYXRoKTtcbiAgfVxuXG4gIGFzeW5jIGRpcmVjdG9yeUV4aXN0cyhkaXJQYXRoOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBmdWxsUGF0aCA9IHRoaXMucmVzb2x2ZVBhdGgoZGlyUGF0aCk7XG4gICAgaWYgKCEoYXdhaXQgZnMucGF0aEV4aXN0cyhmdWxsUGF0aCkpKSByZXR1cm4gZmFsc2U7XG4gICAgY29uc3Qgc3RhdHMgPSBhd2FpdCBmcy5zdGF0KGZ1bGxQYXRoKTtcbiAgICByZXR1cm4gc3RhdHMuaXNEaXJlY3RvcnkoKTtcbiAgfVxuXG4gIGFzeW5jIGdldE1hcmtkb3duRmlsZXMocm9vdFBhdGg/OiBzdHJpbmcpOiBQcm9taXNlPHN0cmluZ1tdPiB7XG4gICAgY29uc3Qgc2VhcmNoUGF0aCA9IHJvb3RQYXRoID8gdGhpcy5yZXNvbHZlUGF0aChyb290UGF0aCkgOiB0aGlzLnJvb3RQYXRoO1xuICAgIGNvbnN0IHBhdHRlcm4gPSBwYXRoLmpvaW4oc2VhcmNoUGF0aCwgXCIqKi8qLm1kXCIpO1xuXG4gICAgY29uc3QgZmlsZXMgPSBhd2FpdCBnbG9iLmdsb2IocGF0dGVybiwgeyBub2RpcjogdHJ1ZSB9KTtcbiAgICBjb25zdCByZWxhdGl2ZVBhdGhzID0gZmlsZXMubWFwKChmOiBzdHJpbmcpID0+XG4gICAgICBwYXRoLnJlbGF0aXZlKHRoaXMucm9vdFBhdGgsIGYpLFxuICAgICk7XG4gICAgcmV0dXJuIHJlbGF0aXZlUGF0aHM7XG4gIH1cblxuICBhc3luYyBmaW5kRmlsZXNCeU1ldGFkYXRhKHF1ZXJ5OiBSZWNvcmQ8c3RyaW5nLCBhbnk+KTogUHJvbWlzZTxzdHJpbmdbXT4ge1xuICAgIGNvbnN0IGFsbEZpbGVzID0gYXdhaXQgdGhpcy5nZXRNYXJrZG93bkZpbGVzKCk7XG4gICAgY29uc3QgbWF0Y2hlczogc3RyaW5nW10gPSBbXTtcblxuICAgIGZvciAoY29uc3QgZmlsZSBvZiBhbGxGaWxlcykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgbWV0YWRhdGEgPSBhd2FpdCB0aGlzLmdldEZpbGVNZXRhZGF0YShmaWxlKTtcbiAgICAgICAgaWYgKHRoaXMubWF0Y2hlc1F1ZXJ5KG1ldGFkYXRhLCBxdWVyeSkpIHtcbiAgICAgICAgICBtYXRjaGVzLnB1c2goZmlsZSk7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBtYXRjaGVzO1xuICB9XG5cbiAgYXN5bmMgZmluZEZpbGVCeVVJRCh1aWQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nIHwgbnVsbD4ge1xuICAgIGNvbnN0IGZpbGVzID0gYXdhaXQgdGhpcy5maW5kRmlsZXNCeU1ldGFkYXRhKHsgZXhvX19Bc3NldF91aWQ6IHVpZCB9KTtcbiAgICByZXR1cm4gZmlsZXMubGVuZ3RoID4gMCA/IGZpbGVzWzBdIDogbnVsbDtcbiAgfVxuXG4gIHByaXZhdGUgcmVzb2x2ZVBhdGgoZmlsZVBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKHBhdGguaXNBYnNvbHV0ZShmaWxlUGF0aCkpIHtcbiAgICAgIHJldHVybiBmaWxlUGF0aDtcbiAgICB9XG4gICAgcmV0dXJuIHBhdGguam9pbih0aGlzLnJvb3RQYXRoLCBmaWxlUGF0aCk7XG4gIH1cblxuICBwcml2YXRlIGV4dHJhY3RGcm9udG1hdHRlcihjb250ZW50OiBzdHJpbmcpOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHtcbiAgICBjb25zdCBmcm9udG1hdHRlclJlZ2V4ID0gL14tLS1cXG4oW1xcc1xcU10qPylcXG4tLS0vO1xuICAgIGNvbnN0IG1hdGNoID0gY29udGVudC5tYXRjaChmcm9udG1hdHRlclJlZ2V4KTtcblxuICAgIGlmICghbWF0Y2gpIHtcbiAgICAgIHJldHVybiB7fTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcGFyc2VkID0geWFtbC5sb2FkKG1hdGNoWzFdKTtcbiAgICAgIHJldHVybiB0eXBlb2YgcGFyc2VkID09PSBcIm9iamVjdFwiICYmIHBhcnNlZCAhPT0gbnVsbFxuICAgICAgICA/IChwYXJzZWQgYXMgUmVjb3JkPHN0cmluZywgYW55PilcbiAgICAgICAgOiB7fTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIHt9O1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgbWF0Y2hlc1F1ZXJ5KFxuICAgIG1ldGFkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+LFxuICAgIHF1ZXJ5OiBSZWNvcmQ8c3RyaW5nLCBhbnk+LFxuICApOiBib29sZWFuIHtcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhxdWVyeSkpIHtcbiAgICAgIGNvbnN0IG1ldGFWYWx1ZSA9IG1ldGFkYXRhW2tleV07XG5cbiAgICAgIGlmIChBcnJheS5pc0FycmF5KG1ldGFWYWx1ZSkpIHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgICFtZXRhVmFsdWUuc29tZShcbiAgICAgICAgICAgICh2KSA9PiB0aGlzLm5vcm1hbGl6ZVZhbHVlKHYpID09PSB0aGlzLm5vcm1hbGl6ZVZhbHVlKHZhbHVlKSxcbiAgICAgICAgICApXG4gICAgICAgICkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgdGhpcy5ub3JtYWxpemVWYWx1ZShtZXRhVmFsdWUpICE9PSB0aGlzLm5vcm1hbGl6ZVZhbHVlKHZhbHVlKVxuICAgICAgKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICBwcml2YXRlIG5vcm1hbGl6ZVZhbHVlKHZhbHVlOiBhbnkpOiBzdHJpbmcge1xuICAgIGlmICh2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkKSByZXR1cm4gXCJcIjtcbiAgICByZXR1cm4gU3RyaW5nKHZhbHVlKVxuICAgICAgLnJlcGxhY2UoL1tcIidbXFxdXS9nLCBcIlwiKVxuICAgICAgLnRyaW0oKTtcbiAgfVxufVxuIl19