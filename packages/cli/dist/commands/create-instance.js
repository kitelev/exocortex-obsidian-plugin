import { Command } from "commander";
import chalk from "chalk";
import ora from "ora";
import * as path from "path";
import { TaskCreationService, AssetClass } from "@exocortex/core";
import { FileSystemVaultAdapter } from "../adapters/FileSystemVaultAdapter.js";
export function createInstanceCommand() {
    const cmd = new Command("instance");
    cmd
        .description("Create an instance from a prototype")
        .requiredOption("-p, --prototype <path>", "Path to prototype file")
        .option("-l, --label <label>", "Instance label")
        .option("--size <size>", "Task size (for task instances)")
        .option("-r, --root <path>", "Root directory of vault", process.cwd())
        .action(async (options) => {
        const spinner = ora("Creating instance from prototype...").start();
        try {
            const adapter = new FileSystemVaultAdapter(options.root);
            const service = new TaskCreationService(adapter);
            const prototypePath = path.relative(options.root, options.prototype);
            const metadata = await adapter.getFileMetadata(prototypePath);
            let sourceClass = AssetClass.TASK_PROTOTYPE;
            if (metadata.exo__Instance_class) {
                const classes = Array.isArray(metadata.exo__Instance_class)
                    ? metadata.exo__Instance_class
                    : [metadata.exo__Instance_class];
                const normalizedClass = classes[0]?.replace(/["'[\]]/g, "").trim();
                if (normalizedClass === AssetClass.MEETING_PROTOTYPE) {
                    sourceClass = AssetClass.MEETING_PROTOTYPE;
                }
            }
            const prototypeFile = adapter.getAbstractFileByPath(prototypePath);
            if (!prototypeFile || !('extension' in prototypeFile)) {
                throw new Error(`Prototype file not found: ${options.prototype}`);
            }
            const createdPath = await service.createTask(prototypeFile, metadata, sourceClass, options.label, options.size || null);
            spinner.succeed(chalk.green(`Instance created: ${createdPath}`));
        }
        catch (error) {
            spinner.fail(chalk.red(`Failed to create instance: ${error.message}`));
            process.exit(1);
        }
    });
    return cmd;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3JlYXRlLWluc3RhbmNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2NvbW1hbmRzL2NyZWF0ZS1pbnN0YW5jZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3BDLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMxQixPQUFPLEdBQUcsTUFBTSxLQUFLLENBQUM7QUFDdEIsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFDN0IsT0FBTyxFQUFFLG1CQUFtQixFQUFFLFVBQVUsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ2xFLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBRS9FLE1BQU0sVUFBVSxxQkFBcUI7SUFDbkMsTUFBTSxHQUFHLEdBQUcsSUFBSSxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7SUFFcEMsR0FBRztTQUNBLFdBQVcsQ0FBQyxxQ0FBcUMsQ0FBQztTQUNsRCxjQUFjLENBQUMsd0JBQXdCLEVBQUUsd0JBQXdCLENBQUM7U0FDbEUsTUFBTSxDQUFDLHFCQUFxQixFQUFFLGdCQUFnQixDQUFDO1NBQy9DLE1BQU0sQ0FBQyxlQUFlLEVBQUUsZ0NBQWdDLENBQUM7U0FDekQsTUFBTSxDQUFDLG1CQUFtQixFQUFFLHlCQUF5QixFQUFFLE9BQU8sQ0FBQyxHQUFHLEVBQUUsQ0FBQztTQUNyRSxNQUFNLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxFQUFFO1FBQ3hCLE1BQU0sT0FBTyxHQUFHLEdBQUcsQ0FBQyxxQ0FBcUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRW5FLElBQUksQ0FBQztZQUNILE1BQU0sT0FBTyxHQUFHLElBQUksc0JBQXNCLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3pELE1BQU0sT0FBTyxHQUFHLElBQUksbUJBQW1CLENBQUMsT0FBTyxDQUFDLENBQUM7WUFFakQsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNyRSxNQUFNLFFBQVEsR0FBRyxNQUFNLE9BQU8sQ0FBQyxlQUFlLENBQUMsYUFBYSxDQUFDLENBQUM7WUFFOUQsSUFBSSxXQUFXLEdBQUcsVUFBVSxDQUFDLGNBQWMsQ0FBQztZQUM1QyxJQUFJLFFBQVEsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO2dCQUNqQyxNQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQztvQkFDekQsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxtQkFBbUI7b0JBQzlCLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO2dCQUVuQyxNQUFNLGVBQWUsR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDbkUsSUFBSSxlQUFlLEtBQUssVUFBVSxDQUFDLGlCQUFpQixFQUFFLENBQUM7b0JBQ3JELFdBQVcsR0FBRyxVQUFVLENBQUMsaUJBQWlCLENBQUM7Z0JBQzdDLENBQUM7WUFDSCxDQUFDO1lBRUQsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLHFCQUFxQixDQUFDLGFBQWEsQ0FBQyxDQUFDO1lBQ25FLElBQUksQ0FBQyxhQUFhLElBQUksQ0FBQyxDQUFDLFdBQVcsSUFBSSxhQUFhLENBQUMsRUFBRSxDQUFDO2dCQUN0RCxNQUFNLElBQUksS0FBSyxDQUFDLDZCQUE2QixPQUFPLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQztZQUNwRSxDQUFDO1lBRUQsTUFBTSxXQUFXLEdBQUcsTUFBTSxPQUFPLENBQUMsVUFBVSxDQUMxQyxhQUFhLEVBQ2IsUUFBUSxFQUNSLFdBQVcsRUFDWCxPQUFPLENBQUMsS0FBSyxFQUNiLE9BQU8sQ0FBQyxJQUFJLElBQUksSUFBSSxDQUNyQixDQUFDO1lBRUYsT0FBTyxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLHFCQUFxQixXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDbkUsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixPQUFPLENBQUMsSUFBSSxDQUNWLEtBQUssQ0FBQyxHQUFHLENBQUMsOEJBQStCLEtBQWUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUNwRSxDQUFDO1lBQ0YsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNsQixDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFFTCxPQUFPLEdBQUcsQ0FBQztBQUNiLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21tYW5kIH0gZnJvbSBcImNvbW1hbmRlclwiO1xuaW1wb3J0IGNoYWxrIGZyb20gXCJjaGFsa1wiO1xuaW1wb3J0IG9yYSBmcm9tIFwib3JhXCI7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgeyBUYXNrQ3JlYXRpb25TZXJ2aWNlLCBBc3NldENsYXNzIH0gZnJvbSBcIkBleG9jb3J0ZXgvY29yZVwiO1xuaW1wb3J0IHsgRmlsZVN5c3RlbVZhdWx0QWRhcHRlciB9IGZyb20gXCIuLi9hZGFwdGVycy9GaWxlU3lzdGVtVmF1bHRBZGFwdGVyLmpzXCI7XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVJbnN0YW5jZUNvbW1hbmQoKTogQ29tbWFuZCB7XG4gIGNvbnN0IGNtZCA9IG5ldyBDb21tYW5kKFwiaW5zdGFuY2VcIik7XG5cbiAgY21kXG4gICAgLmRlc2NyaXB0aW9uKFwiQ3JlYXRlIGFuIGluc3RhbmNlIGZyb20gYSBwcm90b3R5cGVcIilcbiAgICAucmVxdWlyZWRPcHRpb24oXCItcCwgLS1wcm90b3R5cGUgPHBhdGg+XCIsIFwiUGF0aCB0byBwcm90b3R5cGUgZmlsZVwiKVxuICAgIC5vcHRpb24oXCItbCwgLS1sYWJlbCA8bGFiZWw+XCIsIFwiSW5zdGFuY2UgbGFiZWxcIilcbiAgICAub3B0aW9uKFwiLS1zaXplIDxzaXplPlwiLCBcIlRhc2sgc2l6ZSAoZm9yIHRhc2sgaW5zdGFuY2VzKVwiKVxuICAgIC5vcHRpb24oXCItciwgLS1yb290IDxwYXRoPlwiLCBcIlJvb3QgZGlyZWN0b3J5IG9mIHZhdWx0XCIsIHByb2Nlc3MuY3dkKCkpXG4gICAgLmFjdGlvbihhc3luYyAob3B0aW9ucykgPT4ge1xuICAgICAgY29uc3Qgc3Bpbm5lciA9IG9yYShcIkNyZWF0aW5nIGluc3RhbmNlIGZyb20gcHJvdG90eXBlLi4uXCIpLnN0YXJ0KCk7XG5cbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGFkYXB0ZXIgPSBuZXcgRmlsZVN5c3RlbVZhdWx0QWRhcHRlcihvcHRpb25zLnJvb3QpO1xuICAgICAgICBjb25zdCBzZXJ2aWNlID0gbmV3IFRhc2tDcmVhdGlvblNlcnZpY2UoYWRhcHRlcik7XG5cbiAgICAgICAgY29uc3QgcHJvdG90eXBlUGF0aCA9IHBhdGgucmVsYXRpdmUob3B0aW9ucy5yb290LCBvcHRpb25zLnByb3RvdHlwZSk7XG4gICAgICAgIGNvbnN0IG1ldGFkYXRhID0gYXdhaXQgYWRhcHRlci5nZXRGaWxlTWV0YWRhdGEocHJvdG90eXBlUGF0aCk7XG5cbiAgICAgICAgbGV0IHNvdXJjZUNsYXNzID0gQXNzZXRDbGFzcy5UQVNLX1BST1RPVFlQRTtcbiAgICAgICAgaWYgKG1ldGFkYXRhLmV4b19fSW5zdGFuY2VfY2xhc3MpIHtcbiAgICAgICAgICBjb25zdCBjbGFzc2VzID0gQXJyYXkuaXNBcnJheShtZXRhZGF0YS5leG9fX0luc3RhbmNlX2NsYXNzKVxuICAgICAgICAgICAgPyBtZXRhZGF0YS5leG9fX0luc3RhbmNlX2NsYXNzXG4gICAgICAgICAgICA6IFttZXRhZGF0YS5leG9fX0luc3RhbmNlX2NsYXNzXTtcblxuICAgICAgICAgIGNvbnN0IG5vcm1hbGl6ZWRDbGFzcyA9IGNsYXNzZXNbMF0/LnJlcGxhY2UoL1tcIidbXFxdXS9nLCBcIlwiKS50cmltKCk7XG4gICAgICAgICAgaWYgKG5vcm1hbGl6ZWRDbGFzcyA9PT0gQXNzZXRDbGFzcy5NRUVUSU5HX1BST1RPVFlQRSkge1xuICAgICAgICAgICAgc291cmNlQ2xhc3MgPSBBc3NldENsYXNzLk1FRVRJTkdfUFJPVE9UWVBFO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHByb3RvdHlwZUZpbGUgPSBhZGFwdGVyLmdldEFic3RyYWN0RmlsZUJ5UGF0aChwcm90b3R5cGVQYXRoKTtcbiAgICAgICAgaWYgKCFwcm90b3R5cGVGaWxlIHx8ICEoJ2V4dGVuc2lvbicgaW4gcHJvdG90eXBlRmlsZSkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFByb3RvdHlwZSBmaWxlIG5vdCBmb3VuZDogJHtvcHRpb25zLnByb3RvdHlwZX1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNyZWF0ZWRQYXRoID0gYXdhaXQgc2VydmljZS5jcmVhdGVUYXNrKFxuICAgICAgICAgIHByb3RvdHlwZUZpbGUsXG4gICAgICAgICAgbWV0YWRhdGEsXG4gICAgICAgICAgc291cmNlQ2xhc3MsXG4gICAgICAgICAgb3B0aW9ucy5sYWJlbCxcbiAgICAgICAgICBvcHRpb25zLnNpemUgfHwgbnVsbCxcbiAgICAgICAgKTtcblxuICAgICAgICBzcGlubmVyLnN1Y2NlZWQoY2hhbGsuZ3JlZW4oYEluc3RhbmNlIGNyZWF0ZWQ6ICR7Y3JlYXRlZFBhdGh9YCkpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgc3Bpbm5lci5mYWlsKFxuICAgICAgICAgIGNoYWxrLnJlZChgRmFpbGVkIHRvIGNyZWF0ZSBpbnN0YW5jZTogJHsoZXJyb3IgYXMgRXJyb3IpLm1lc3NhZ2V9YCksXG4gICAgICAgICk7XG4gICAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICByZXR1cm4gY21kO1xufVxuIl19