import { v4 as uuidv4 } from "uuid";
import { WikiLinkHelpers } from "../utilities/WikiLinkHelpers";
import { MetadataHelpers } from "../utilities/MetadataHelpers";
import { AssetClass } from '../domain/constants';
import { TaskFrontmatterGenerator } from "./TaskFrontmatterGenerator";
import { AlgorithmExtractor } from "./AlgorithmExtractor";
export class TaskCreationService {
    constructor(vault) {
        this.vault = vault;
        this.frontmatterGenerator = new TaskFrontmatterGenerator();
        this.algorithmExtractor = new AlgorithmExtractor();
    }
    async createTask(sourceFile, sourceMetadata, sourceClass, label, taskSize) {
        const uid = uuidv4();
        const fileName = `${uid}.md`;
        const frontmatter = this.frontmatterGenerator.generateTaskFrontmatter(sourceMetadata, sourceFile.basename, sourceClass, label, uid, taskSize);
        let bodyContent = "";
        const cleanSourceClass = WikiLinkHelpers.normalize(sourceClass);
        if (cleanSourceClass === AssetClass.TASK_PROTOTYPE) {
            const prototypeContent = await this.vault.read(sourceFile);
            const algorithmSection = this.algorithmExtractor.extractH2Section(prototypeContent, "Algorithm");
            if (algorithmSection) {
                bodyContent = `## Algorithm\n\n${algorithmSection}`;
            }
        }
        const fileContent = MetadataHelpers.buildFileContent(frontmatter, bodyContent);
        const folderPath = sourceFile.parent?.path || "";
        const filePath = folderPath ? `${folderPath}/${fileName}` : fileName;
        const createdFile = await this.vault.create(filePath, fileContent);
        return createdFile;
    }
    async createRelatedTask(sourceFile, sourceMetadata, label, taskSize) {
        const uid = uuidv4();
        const fileName = `${uid}.md`;
        const frontmatter = this.frontmatterGenerator.generateRelatedTaskFrontmatter(sourceMetadata, sourceFile.basename, label, uid, taskSize);
        const fileContent = MetadataHelpers.buildFileContent(frontmatter);
        const folderPath = sourceFile.parent?.path || "";
        const filePath = folderPath ? `${folderPath}/${fileName}` : fileName;
        const createdFile = await this.vault.create(filePath, fileContent);
        await this.addRelationToSourceFile(sourceFile, uid);
        return createdFile;
    }
    generateTaskFrontmatter(sourceMetadata, sourceName, sourceClass, label, uid, taskSize) {
        return this.frontmatterGenerator.generateTaskFrontmatter(sourceMetadata, sourceName, sourceClass, label, uid, taskSize);
    }
    // Used only by unit tests via (service as any).generateRelatedTaskFrontmatter
    generateRelatedTaskFrontmatter(sourceMetadata, sourceName, label, uid, taskSize) {
        return this.frontmatterGenerator.generateRelatedTaskFrontmatter(sourceMetadata, sourceName, label, uid, taskSize);
    }
    // Used only by unit tests via (service as any).extractH2Section
    extractH2Section(content, heading) {
        return this.algorithmExtractor.extractH2Section(content, heading);
    }
    async addRelationToSourceFile(sourceFile, newTaskUid) {
        const content = await this.vault.read(sourceFile);
        const updatedContent = this.addRelationToFrontmatter(content, newTaskUid);
        await this.vault.modify(sourceFile, updatedContent);
    }
    addRelationToFrontmatter(content, relatedTaskUid) {
        const frontmatterRegex = /^---\r?\n([\s\S]*?)\r?\n---/;
        const match = content.match(frontmatterRegex);
        const lineEnding = content.includes('\r\n') ? '\r\n' : '\n';
        if (!match) {
            const newFrontmatter = `---${lineEnding}exo__Asset_relates:${lineEnding}  - "[[${relatedTaskUid}]]"${lineEnding}---${lineEnding}${content}`;
            return newFrontmatter;
        }
        const frontmatterContent = match[1];
        let updatedFrontmatter = frontmatterContent;
        if (updatedFrontmatter.includes("exo__Asset_relates:")) {
            const relatesMatch = updatedFrontmatter.match(/exo__Asset_relates:\r?\n((?: {2}- .*\r?\n)*)/);
            if (relatesMatch) {
                const existingItems = relatesMatch[1];
                const newItem = `  - "[[${relatedTaskUid}]]"${lineEnding}`;
                updatedFrontmatter = updatedFrontmatter.replace(/exo__Asset_relates:\r?\n((?: {2}- .*\r?\n)*)/, `exo__Asset_relates:${lineEnding}${existingItems}${newItem}`);
            }
        }
        else {
            updatedFrontmatter += `${lineEnding}exo__Asset_relates:${lineEnding}  - "[[${relatedTaskUid}]]"`;
        }
        return content.replace(frontmatterRegex, `---${lineEnding}${updatedFrontmatter}${lineEnding}---`);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGFza0NyZWF0aW9uU2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIlRhc2tDcmVhdGlvblNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLEVBQUUsSUFBSSxNQUFNLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDcEMsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDhCQUE4QixDQUFDO0FBQy9ELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUMvRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDakQsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDdEUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFMUQsTUFBTSxPQUFPLG1CQUFtQjtJQUk5QixZQUFvQixLQUFZO1FBQVosVUFBSyxHQUFMLEtBQUssQ0FBTztRQUM5QixJQUFJLENBQUMsb0JBQW9CLEdBQUcsSUFBSSx3QkFBd0IsRUFBRSxDQUFDO1FBQzNELElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLGtCQUFrQixFQUFFLENBQUM7SUFDckQsQ0FBQztJQUVELEtBQUssQ0FBQyxVQUFVLENBQ2QsVUFBaUIsRUFDakIsY0FBbUMsRUFDbkMsV0FBbUIsRUFDbkIsS0FBYyxFQUNkLFFBQXdCO1FBRXhCLE1BQU0sR0FBRyxHQUFHLE1BQU0sRUFBRSxDQUFDO1FBQ3JCLE1BQU0sUUFBUSxHQUFHLEdBQUcsR0FBRyxLQUFLLENBQUM7UUFDN0IsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDLHVCQUF1QixDQUNuRSxjQUFjLEVBQ2QsVUFBVSxDQUFDLFFBQVEsRUFDbkIsV0FBVyxFQUNYLEtBQUssRUFDTCxHQUFHLEVBQ0gsUUFBUSxDQUNULENBQUM7UUFFRixJQUFJLFdBQVcsR0FBRyxFQUFFLENBQUM7UUFDckIsTUFBTSxnQkFBZ0Is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Q2pCLE1BQU0sYUFBYSxHQUFHLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDdEMsTUFBTSxPQUFPLEdBQUcsVUFBVSxjQUFjLE1BQU0sVUFBVSxFQUFFLENBQUM7Z0JBQzNELGtCQUFrQixHQUFHLGtCQUFrQixDQUFDLE9BQU8sQ0FDN0MsOENBQThDLEVBQzlDLHNCQUFzQixVQUFVLEdBQUcsYUFBYSxHQUFHLE9BQU8sRUFBRSxDQUM3RCxDQUFDO1lBQ0osQ0FBQztRQUNILENBQUM7YUFBTSxDQUFDO1lBQ04sa0JBQWtCLElBQUksR0FBRyxVQUFVLHNCQUFzQixVQUFVLFVBQVUsY0FBYyxLQUFLLENBQUM7UUFDbkcsQ0FBQztRQUVELE9BQU8sT0FBTyxDQUFDLE9BQU8sQ0FDcEIsZ0JBQWdCLEVBQ2hCLE1BQU0sVUFBVSxHQUFHLGtCQUFrQixHQUFHLFVBQVUsS0FBSyxDQUN4RCxDQUFDO0lBQ0osQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVEZpbGUsIFZhdWx0IH0gZnJvbSBcIm9ic2lkaWFuXCI7XG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tIFwidXVpZFwiO1xuaW1wb3J0IHsgV2lraUxpbmtIZWxwZXJzIH0gZnJvbSBcIi4uL3V0aWxpdGllcy9XaWtpTGlua0hlbHBlcnNcIjtcbmltcG9ydCB7IE1ldGFkYXRhSGVscGVycyB9IGZyb20gXCIuLi91dGlsaXRpZXMvTWV0YWRhdGFIZWxwZXJzXCI7XG5pbXBvcnQgeyBBc3NldENsYXNzIH0gZnJvbSAnLi4vZG9tYWluL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBUYXNrRnJvbnRtYXR0ZXJHZW5lcmF0b3IgfSBmcm9tIFwiLi9UYXNrRnJvbnRtYXR0ZXJHZW5lcmF0b3JcIjtcbmltcG9ydCB7IEFsZ29yaXRobUV4dHJhY3RvciB9IGZyb20gXCIuL0FsZ29yaXRobUV4dHJhY3RvclwiO1xuXG5leHBvcnQgY2xhc3MgVGFza0NyZWF0aW9uU2VydmljZSB7XG4gIHByaXZhdGUgZnJvbnRtYXR0ZXJHZW5lcmF0b3I6IFRhc2tGcm9udG1hdHRlckdlbmVyYXRvcjtcbiAgcHJpdmF0ZSBhbGdvcml0aG1FeHRyYWN0b3I6IEFsZ29yaXRobUV4dHJhY3RvcjtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHZhdWx0OiBWYXVsdCkge1xuICAgIHRoaXMuZnJvbnRtYXR0ZXJHZW5lcmF0b3IgPSBuZXcgVGFza0Zyb250bWF0dGVyR2VuZXJhdG9yKCk7XG4gICAgdGhpcy5hbGdvcml0aG1FeHRyYWN0b3IgPSBuZXcgQWxnb3JpdGhtRXh0cmFjdG9yKCk7XG4gIH1cblxuICBhc3luYyBjcmVhdGVUYXNrKFxuICAgIHNvdXJjZUZpbGU6IFRGaWxlLFxuICAgIHNvdXJjZU1ldGFkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+LFxuICAgIHNvdXJjZUNsYXNzOiBzdHJpbmcsXG4gICAgbGFiZWw/OiBzdHJpbmcsXG4gICAgdGFza1NpemU/OiBzdHJpbmcgfCBudWxsLFxuICApOiBQcm9taXNlPFRGaWxlPiB7XG4gICAgY29uc3QgdWlkID0gdXVpZHY0KCk7XG4gICAgY29uc3QgZmlsZU5hbWUgPSBgJHt1aWR9Lm1kYDtcbiAgICBjb25zdCBmcm9udG1hdHRlciA9IHRoaXMuZnJvbnRtYXR0ZXJHZW5lcmF0b3IuZ2VuZXJhdGVUYXNrRnJvbnRtYXR0ZXIoXG4gICAgICBzb3VyY2VNZXRhZGF0YSxcbiAgICAgIHNvdXJjZUZpbGUuYmFzZW5hbWUsXG4gICAgICBzb3VyY2VDbGFzcyxcbiAgICAgIGxhYmVsLFxuICAgICAgdWlkLFxuICAgICAgdGFza1NpemUsXG4gICAgKTtcblxuICAgIGxldCBib2R5Q29udGVudCA9IFwiXCI7XG4gICAgY29uc3QgY2xlYW5Tb3VyY2VDbGFzcyA9IFdpa2lMaW5rSGVscGVycy5ub3JtYWxpemUoc291cmNlQ2xhc3MpO1xuICAgIGlmIChjbGVhblNvdXJjZUNsYXNzID09PSBBc3NldENsYXNzLlRBU0tfUFJPVE9UWVBFKSB7XG4gICAgICBjb25zdCBwcm90b3R5cGVDb250ZW50ID0gYXdhaXQgdGhpcy52YXVsdC5yZWFkKHNvdXJjZUZpbGUpO1xuICAgICAgY29uc3QgYWxnb3JpdGhtU2VjdGlvbiA9IHRoaXMuYWxnb3JpdGhtRXh0cmFjdG9yLmV4dHJhY3RIMlNlY3Rpb24oXG4gICAgICAgIHByb3RvdHlwZUNvbnRlbnQsXG4gICAgICAgIFwiQWxnb3JpdGhtXCIsXG4gICAgICApO1xuICAgICAgaWYgKGFsZ29yaXRobVNlY3Rpb24pIHtcbiAgICAgICAgYm9keUNvbnRlbnQgPSBgIyMgQWxnb3JpdGhtXFxuXFxuJHthbGdvcml0aG1TZWN0aW9ufWA7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgZmlsZUNvbnRlbnQgPSBNZXRhZGF0YUhlbHBlcnMuYnVpbGRGaWxlQ29udGVudChmcm9udG1hdHRlciwgYm9keUNvbnRlbnQpO1xuXG4gICAgY29uc3QgZm9sZGVyUGF0aCA9IHNvdXJjZUZpbGUucGFyZW50Py5wYXRoIHx8IFwiXCI7XG4gICAgY29uc3QgZmlsZVBhdGggPSBmb2xkZXJQYXRoID8gYCR7Zm9sZGVyUGF0aH0vJHtmaWxlTmFtZX1gIDogZmlsZU5hbWU7XG5cbiAgICBjb25zdCBjcmVhdGVkRmlsZSA9IGF3YWl0IHRoaXMudmF1bHQuY3JlYXRlKGZpbGVQYXRoLCBmaWxlQ29udGVudCk7XG5cbiAgICByZXR1cm4gY3JlYXRlZEZpbGU7XG4gIH1cblxuICBhc3luYyBjcmVhdGVSZWxhdGVkVGFzayhcbiAgICBzb3VyY2VGaWxlOiBURmlsZSxcbiAgICBzb3VyY2VNZXRhZGF0YTogUmVjb3JkPHN0cmluZywgYW55PixcbiAgICBsYWJlbD86IHN0cmluZyxcbiAgICB0YXNrU2l6ZT86IHN0cmluZyB8IG51bGwsXG4gICk6IFByb21pc2U8VEZpbGU+IHtcbiAgICBjb25zdCB1aWQgPSB1dWlkdjQoKTtcbiAgICBjb25zdCBmaWxlTmFtZSA9IGAke3VpZH0ubWRgO1xuXG4gICAgY29uc3QgZnJvbnRtYXR0ZXIgPSB0aGlzLmZyb250bWF0dGVyR2VuZXJhdG9yLmdlbmVyYXRlUmVsYXRlZFRhc2tGcm9udG1hdHRlcihcbiAgICAgIHNvdXJjZU1ldGFkYXRhLFxuICAgICAgc291cmNlRmlsZS5iYXNlbmFtZSxcbiAgICAgIGxhYmVsLFxuICAgICAgdWlkLFxuICAgICAgdGFza1NpemUsXG4gICAgKTtcblxuICAgIGNvbnN0IGZpbGVDb250ZW50ID0gTWV0YWRhdGFIZWxwZXJzLmJ1aWxkRmlsZUNvbnRlbnQoZnJvbnRtYXR0ZXIpO1xuXG4gICAgY29uc3QgZm9sZGVyUGF0aCA9IHNvdXJjZUZpbGUucGFyZW50Py5wYXRoIHx8IFwiXCI7XG4gICAgY29uc3QgZmlsZVBhdGggPSBmb2xkZXJQYXRoID8gYCR7Zm9sZGVyUGF0aH0vJHtmaWxlTmFtZX1gIDogZmlsZU5hbWU7XG5cbiAgICBjb25zdCBjcmVhdGVkRmlsZSA9IGF3YWl0IHRoaXMudmF1bHQuY3JlYXRlKGZpbGVQYXRoLCBmaWxlQ29udGVudCk7XG5cbiAgICBhd2FpdCB0aGlzLmFkZFJlbGF0aW9uVG9Tb3VyY2VGaWxlKHNvdXJjZUZpbGUsIHVpZCk7XG5cbiAgICByZXR1cm4gY3JlYXRlZEZpbGU7XG4gIH1cblxuICBnZW5lcmF0ZVRhc2tGcm9udG1hdHRlcihcbiAgICBzb3VyY2VNZXRhZGF0YTogUmVjb3JkPHN0cmluZywgYW55PixcbiAgICBzb3VyY2VOYW1lOiBzdHJpbmcsXG4gICAgc291cmNlQ2xhc3M6IHN0cmluZyxcbiAgICBsYWJlbD86IHN0cmluZyxcbiAgICB1aWQ/OiBzdHJpbmcsXG4gICAgdGFza1NpemU/OiBzdHJpbmcgfCBudWxsLFxuICApOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5mcm9udG1hdHRlckdlbmVyYXRvci5nZW5lcmF0ZVRhc2tGcm9udG1hdHRlcihcbiAgICAgIHNvdXJjZU1ldGFkYXRhLFxuICAgICAgc291cmNlTmFtZSxcbiAgICAgIHNvdXJjZUNsYXNzLFxuICAgICAgbGFiZWwsXG4gICAgICB1aWQsXG4gICAgICB0YXNrU2l6ZSxcbiAgICApO1xuICB9XG5cbiAgLy8gVXNlZCBvbmx5IGJ5IHVuaXQgdGVzdHMgdmlhIChzZXJ2aWNlIGFzIGFueSkuZ2VuZXJhdGVSZWxhdGVkVGFza0Zyb250bWF0dGVyXG4gIHByaXZhdGUgZ2VuZXJhdGVSZWxhdGVkVGFza0Zyb250bWF0dGVyKFxuICAgIHNvdXJjZU1ldGFkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+LFxuICAgIHNvdXJjZU5hbWU6IHN0cmluZyxcbiAgICBsYWJlbD86IHN0cmluZyxcbiAgICB1aWQ/OiBzdHJpbmcsXG4gICAgdGFza1NpemU/OiBzdHJpbmcgfCBudWxsLFxuICApOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHtcbiAgICByZXR1cm4gdGhpcy5mcm9udG1hdHRlckdlbmVyYXRvci5nZW5lcmF0ZVJlbGF0ZWRUYXNrRnJvbnRtYXR0ZXIoXG4gICAgICBzb3VyY2VNZXRhZGF0YSxcbiAgICAgIHNvdXJjZU5hbWUsXG4gICAgICBsYWJlbCxcbiAgICAgIHVpZCxcbiAgICAgIHRhc2tTaXplLFxuICAgICk7XG4gIH1cblxuICAvLyBVc2VkIG9ubHkgYnkgdW5pdCB0ZXN0cyB2aWEgKHNlcnZpY2UgYXMgYW55KS5leHRyYWN0SDJTZWN0aW9uXG4gIHByaXZhdGUgZXh0cmFjdEgyU2VjdGlvbihjb250ZW50OiBzdHJpbmcsIGhlYWRpbmc6IHN0cmluZyk6IHN0cmluZyB8IG51bGwge1xuICAgIHJldHVybiB0aGlzLmFsZ29yaXRobUV4dHJhY3Rvci5leHRyYWN0SDJTZWN0aW9uKGNvbnRlbnQsIGhlYWRpbmcpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBhZGRSZWxhdGlvblRvU291cmNlRmlsZShcbiAgICBzb3VyY2VGaWxlOiBURmlsZSxcbiAgICBuZXdUYXNrVWlkOiBzdHJpbmcsXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGNvbnRlbnQgPSBhd2FpdCB0aGlzLnZhdWx0LnJlYWQoc291cmNlRmlsZSk7XG4gICAgY29uc3QgdXBkYXRlZENvbnRlbnQgPSB0aGlzLmFkZFJlbGF0aW9uVG9Gcm9udG1hdHRlcihjb250ZW50LCBuZXdUYXNrVWlkKTtcbiAgICBhd2FpdCB0aGlzLnZhdWx0Lm1vZGlmeShzb3VyY2VGaWxlLCB1cGRhdGVkQ29udGVudCk7XG4gIH1cblxuICBwcml2YXRlIGFkZFJlbGF0aW9uVG9Gcm9udG1hdHRlcihcbiAgICBjb250ZW50OiBzdHJpbmcsXG4gICAgcmVsYXRlZFRhc2tVaWQ6IHN0cmluZyxcbiAgKTogc3RyaW5nIHtcbiAgICBjb25zdCBmcm9udG1hdHRlclJlZ2V4ID0gL14tLS1cXHI/XFxuKFtcXHNcXFNdKj8pXFxyP1xcbi0tLS87XG4gICAgY29uc3QgbWF0Y2ggPSBjb250ZW50Lm1hdGNoKGZyb250bWF0dGVyUmVnZXgpO1xuXG4gICAgY29uc3QgbGluZUVuZGluZyA9IGNvbnRlbnQuaW5jbHVkZXMoJ1xcclxcbicpID8gJ1xcclxcbicgOiAnXFxuJztcblxuICAgIGlmICghbWF0Y2gpIHtcbiAgICAgIGNvbnN0IG5ld0Zyb250bWF0dGVyID0gYC0tLSR7bGluZUVuZGluZ31leG9fX0Fzc2V0X3JlbGF0ZXM6JHtsaW5lRW5kaW5nfSAgLSBcIltbJHtyZWxhdGVkVGFza1VpZH1dXVwiJHtsaW5lRW5kaW5nfS0tLSR7bGluZUVuZGluZ30ke2NvbnRlbnR9YDtcbiAgICAgIHJldHVybiBuZXdGcm9udG1hdHRlcjtcbiAgICB9XG5cbiAgICBjb25zdCBmcm9udG1hdHRlckNvbnRlbnQgPSBtYXRjaFsxXTtcbiAgICBsZXQgdXBkYXRlZEZyb250bWF0dGVyID0gZnJvbnRtYXR0ZXJDb250ZW50O1xuXG4gICAgaWYgKHVwZGF0ZWRGcm9udG1hdHRlci5pbmNsdWRlcyhcImV4b19fQXNzZXRfcmVsYXRlczpcIikpIHtcbiAgICAgIGNvbnN0IHJlbGF0ZXNNYXRjaCA9IHVwZGF0ZWRGcm9udG1hdHRlci5tYXRjaCgvZXhvX19Bc3NldF9yZWxhdGVzOlxccj9cXG4oKD86IHsyfS0gLipcXHI/XFxuKSopLyk7XG4gICAgICBpZiAocmVsYXRlc01hdGNoKSB7XG4gICAgICAgIGNvbnN0IGV4aXN0aW5nSXRlbXMgPSByZWxhdGVzTWF0Y2hbMV07XG4gICAgICAgIGNvbnN0IG5ld0l0ZW0gPSBgICAtIFwiW1ske3JlbGF0ZWRUYXNrVWlkfV1dXCIke2xpbmVFbmRpbmd9YDtcbiAgICAgICAgdXBkYXRlZEZyb250bWF0dGVyID0gdXBkYXRlZEZyb250bWF0dGVyLnJlcGxhY2UoXG4gICAgICAgICAgL2V4b19fQXNzZXRfcmVsYXRlczpcXHI/XFxuKCg/OiB7Mn0tIC4qXFxyP1xcbikqKS8sXG4gICAgICAgICAgYGV4b19fQXNzZXRfcmVsYXRlczoke2xpbmVFbmRpbmd9JHtleGlzdGluZ0l0ZW1zfSR7bmV3SXRlbX1gLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB1cGRhdGVkRnJvbnRtYXR0ZXIgKz0gYCR7bGluZUVuZGluZ31leG9fX0Fzc2V0X3JlbGF0ZXM6JHtsaW5lRW5kaW5nfSAgLSBcIltbJHtyZWxhdGVkVGFza1VpZH1dXVwiYDtcbiAgICB9XG5cbiAgICByZXR1cm4gY29udGVudC5yZXBsYWNlKFxuICAgICAgZnJvbnRtYXR0ZXJSZWdleCxcbiAgICAgIGAtLS0ke2xpbmVFbmRpbmd9JHt1cGRhdGVkRnJvbnRtYXR0ZXJ9JHtsaW5lRW5kaW5nfS0tLWAsXG4gICAgKTtcbiAgfVxufVxuIl19