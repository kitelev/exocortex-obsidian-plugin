import { TFile } from "obsidian";
import { AssetClass } from '../domain/constants';
export class AreaHierarchyBuilder {
    constructor(vault, metadataCache) {
        this.vault = vault;
        this.metadataCache = metadataCache;
    }
    buildHierarchy(currentAreaPath, _relations) {
        const currentFile = this.vault.getAbstractFileByPath(currentAreaPath);
        if (!this.isFile(currentFile)) {
            return null;
        }
        // eslint-disable-next-line obsidianmd/no-tfile-tfolder-cast
        const cache = this.metadataCache.getFileCache(currentFile);
        const metadata = cache?.frontmatter || {};
        const instanceClass = this.extractInstanceClass(metadata);
        if (instanceClass !== AssetClass.AREA) {
            return null;
        }
        const allAreas = this.collectAllAreasFromVault();
        const visited = new Set();
        return this.buildTree(currentAreaPath, allAreas, visited, 0);
    }
    isFile(file) {
        if (file instanceof TFile) {
            return true;
        }
        return (file &&
            typeof file === "object" &&
            "basename" in file &&
            "path" in file &&
            "stat" in file);
    }
    extractInstanceClass(metadata) {
        const instanceClass = metadata.exo__Instance_class || "";
        if (Array.isArray(instanceClass)) {
            return this.cleanWikiLink(instanceClass[0] || "");
        }
        return this.cleanWikiLink(instanceClass);
    }
    cleanWikiLink(value) {
        if (typeof value !== "string")
            return "";
        return value.replace(/^\[\[|\]\]$/g, "").trim();
    }
    collectAllAreasFromVault() {
        const areas = new Map();
        const pathByBasename = new Map();
        const allFiles = this.vault.getMarkdownFiles();
        for (const file of allFiles) {
            const cache = this.metadataCache.getFileCache(file);
            const metadata = cache?.frontmatter || {};
            const instanceClass = this.extractInstanceClass(metadata);
            if (instanceClass === AssetClass.AREA) {
                const parentPath = this.extractParentPath(metadata);
                areas.set(file.path, {
                    path: file.path,
                    title: file.basename,
                    label: metadata.exo__Asset_label || undefined,
                    isArchived: this.isArchived(metadata),
                    depth: 0,
                    parentPath: parentPath || undefined,
                });
                pathByBasename.set(file.basename, file.path);
            }
        }
        for (const [, area] of areas.entries()) {
            if (area.parentPath && pathByBasename.has(area.parentPath)) {
                area.parentPath = pathByBasename.get(area.parentPath);
            }
        }
        return areas;
    }
    extractParentPath(metadata) {
        const parentProperty = metadata.ems__Area_parent;
        if (!parentProperty) {
            return null;
        }
        if (Array.isArray(parentProperty)) {
            const firstParent = parentProperty[0] || "";
            return this.cleanWikiLink(firstParent);
        }
        return this.cleanWikiLink(parentProperty);
    }
    isArchived(metadata) {
        const archivedProp = metadata.exo__Asset_archived;
        if (archivedProp === true || archivedProp === "true") {
            return true;
        }
        if (Array.isArray(archivedProp) && archivedProp.length > 0) {
            const first = archivedProp[0];
            return first === true || first === "true";
        }
        return false;
    }
    buildTree(path, areas, visited, depth) {
        if (visited.has(path)) {
            return null;
        }
        visited.add(path);
        const area = areas.get(path);
        if (!area) {
            return null;
        }
        const children = [];
        for (const [childPath, childData] of areas.entries()) {
            if (childData.parentPath === path) {
                const childNode = this.buildTree(childPath, areas, visited, depth + 1);
                if (childNode) {
                    children.push(childNode);
                }
            }
        }
        children.sort((a, b) => {
            const aLabel = a.label || a.title;
            const bLabel = b.label || b.title;
            return aLabel.localeCompare(bLabel);
        });
        return {
            path: area.path,
            title: area.title,
            label: area.label,
            isArchived: area.isArchived,
            depth,
            parentPath: area.parentPath,
            children,
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXJlYUhpZXJhcmNoeUJ1aWxkZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJBcmVhSGllcmFyY2h5QnVpbGRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsS0FBSyxFQUF3QixNQUFNLFVBQVUsQ0FBQztBQUV2RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFVakQsTUFBTSxPQUFPLG9CQUFvQjtJQUMvQixZQUNVLEtBQVksRUFDWixhQUE0QjtRQUQ1QixVQUFLLEdBQUwsS0FBSyxDQUFPO1FBQ1osa0JBQWEsR0FBYixhQUFhLENBQWU7SUFDbkMsQ0FBQztJQUVKLGNBQWMsQ0FDWixlQUF1QixFQUN2QixVQUEyQjtRQUUzQixNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQ3RFLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUM7WUFDOUIsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBRUQsNERBQTREO1FBQzVELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLFdBQW9CLENBQUMsQ0FBQztRQUNwRSxNQUFNLFFBQVEsR0FBRyxLQUFLLEVBQUUsV0FBVyxJQUFJLEVBQUUsQ0FBQztRQUMxQyxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsUUFBUSxDQUFDLENBQUM7UUFFMUQsSUFBSSxhQUFhLEtBQUssVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ3RDLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUVELE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxDQUFDO1FBQ2pELE1BQU0sT0FBTyxHQUFHLElBQUksR0FBRyxFQUFVLENBQUM7UUFDbEMsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLGVBQWUsRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQy9ELENBQUM7SUFFTyxNQUFNLENBQUMsSUFBUztRQUN0QixJQUFJLElBQUksWUFBWSxLQUFLLEVBQUUsQ0FBQztZQUMxQixPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFDRCxPQUFPLENBQ0wsSUFBSTtZQUNKLE9BQU8sSUFBSSxLQUFLLFFBQVE7WUFDeEIsVUFBVSxJQUFJLElBQUk7WUFDbEIsTUFBTSxJQUFJLElBQUk7WUFDZCxNQUFNLElBQUksSUFBSSxDQUNmLENBQUM7SUFDSixDQUFDO0lBRU8sb0JBQW9CLENBQUMsUUFBNkI7UUFDeEQsTUFBTSxhQUFhLEdBQUcsUUFBUSxDQUFDLG1CQUFtQixJQUFJLEVBQUUsQ0FBQztRQUN6RCxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQztZQUNqQyxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ3BELENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUVPLGFBQWEsQ0FBQyxLQUFhO1FBQ2pDLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUTtZQUFFLE9BQU8sRUFBRSxDQUFDO1FBQ3pDLE9BQU8sS0FBSyxDQUFDLE9BQU8sQ0FBQyxjQUFjLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDbEQsQ0FBQztJQUVPLHdCQUF3QjtRQUM5QixNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsRUFBd0IsQ0FBQztRQUM5QyxNQUFNLGNBQWMsR0FBRyxJQUFJLEdBQUcsRUFBa0IsQ0FBQztRQUVqRCxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFFL0MsS0FBSyxNQUFNLElBQUksSUFBSSxRQUFRLEVBQUUsQ0FBQztZQUM1QixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNwRCxNQUFNLFFBQVEsR0FBRyxLQUFLLEVBQUUsV0FBVyxJQUFJLEVBQUUsQ0FBQztZQUMxQyxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUMsUUFBUSxDQUFDLENBQUM7WUFFMUQsSUFBSSxhQUFhLEtBQUssVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUN0QyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQ3BELEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRTtvQkFDbkIsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJO29CQUNmLEtBQUssRUFBRSxJQUFJLENBQUMsUUFBUTtvQkFDcEIsS0FBSyxFQUFFLFFBQVEsQ0FBQyxnQkFBZ0IsSUFBSSxTQUFTO29CQUM3QyxVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUM7b0JBQ3JDLEtBQUssRUFBRSxDQUFDO29CQUNSLFVBQVUsRUFBRSxVQUFVLElBQUksU0FBUztpQkFDcEMsQ0FBQyxDQUFDO2dCQUNILGNBQWMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDL0MsQ0FBQztRQUNILENBQUM7UUFFRCxLQUFLLE1BQU0sQ0FBQyxFQUFFLElBQUksQ0FBQyxJQUFJLEtBQUssQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDO1lBQ3ZDLElBQUksSUFBSSxDQUFDLFVBQVUsSUFBSSxjQUFjLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO2dCQUMzRCxJQUFJLENBQUMsVUFBVSxHQUFHLGNBQWMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3hELENBQUM7UUFDSCxDQUFDO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0lBRU8saUJBQWlCLENBQUMsUUFBNkI7UUFDckQsTUFBTSxjQUFjLEdBQUcsUUFBUSxDQUFDLGdCQUFnQixDQUFDO1FBQ2pELElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUNwQixPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFFRCxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQztZQUNsQyxNQUFNLFdBQVcsR0FBRyxjQUFjLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1lBQzVDLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN6QyxDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFFTyxVQUFVLENBQUMsUUFBNkI7UUFDOUMsTUFBTSxZQUFZLEdBQUcsUUFBUSxDQUFDLG1CQUFtQixDQUFDO1FBQ2xELElBQUksWUFBWSxLQUFLLElBQUksSUFBSSxZQUFZLEtBQUssTUFBTSxFQUFFLENBQUM7WUFDckQsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBQ0QsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxJQUFJLFlBQVksQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDM0QsTUFBTSxLQUFLLEdBQUcsWUFBWSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzlCLE9BQU8sS0FBSyxLQUFLLElBQUksSUFBSSxLQUFLLEtBQUssTUFBTSxDQUFDO1FBQzVDLENBQUM7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7SUFFTyxTQUFTLENBQ2YsSUFBWSxFQUNaLEtBQWdDLEVBQ2hDLE9BQW9CLEVBQ3BCLEtBQWE7UUFFYixJQUFJLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUN0QixPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRWxCLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDN0IsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ1YsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBRUQsTUFBTSxRQUFRLEdBQWUsRUFBRSxDQUFDO1FBQ2hDLEtBQUssTUFBTSxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsSUFBSSxLQUFLLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQztZQUNyRCxJQUFJLFNBQVMsQ0FBQyxVQUFVLEtBQUssSUFBSSxFQUFFLENBQUM7Z0JBQ2xDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUN2RSxJQUFJLFNBQVMsRUFBRSxDQUFDO29CQUNkLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7Z0JBQzNCLENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQztRQUVELFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDckIsTUFBTSxNQUFNLEdBQUcsQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDO1lBQ2xDLE1BQU0sTUFBTSxHQUFHLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQztZQUNsQyxPQUFPLE1BQU0sQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDdEMsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPO1lBQ0wsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJO1lBQ2YsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO1lBQ2pCLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSztZQUNqQixVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVU7WUFDM0IsS0FBSztZQUNMLFVBQVUsRUFBRSxJQUFJLENBQUMsVUFBVTtZQUMzQixRQUFRO1NBQ1QsQ0FBQztJQUNKLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRGaWxlLCBWYXVsdCwgTWV0YWRhdGFDYWNoZSB9IGZyb20gXCJvYnNpZGlhblwiO1xuaW1wb3J0IHsgQXJlYU5vZGUsIEFyZWFOb2RlRGF0YSB9IGZyb20gJy4uL2RvbWFpbi9tb2RlbHMvQXJlYU5vZGUnO1xuaW1wb3J0IHsgQXNzZXRDbGFzcyB9IGZyb20gJy4uL2RvbWFpbi9jb25zdGFudHMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEFzc2V0UmVsYXRpb24ge1xuICBwYXRoOiBzdHJpbmc7XG4gIHRpdGxlOiBzdHJpbmc7XG4gIHByb3BlcnR5TmFtZT86IHN0cmluZztcbiAgaXNBcmNoaXZlZD86IGJvb2xlYW47XG4gIG1ldGFkYXRhOiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xufVxuXG5leHBvcnQgY2xhc3MgQXJlYUhpZXJhcmNoeUJ1aWxkZXIge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHZhdWx0OiBWYXVsdCxcbiAgICBwcml2YXRlIG1ldGFkYXRhQ2FjaGU6IE1ldGFkYXRhQ2FjaGUsXG4gICkge31cblxuICBidWlsZEhpZXJhcmNoeShcbiAgICBjdXJyZW50QXJlYVBhdGg6IHN0cmluZyxcbiAgICBfcmVsYXRpb25zOiBBc3NldFJlbGF0aW9uW10sXG4gICk6IEFyZWFOb2RlIHwgbnVsbCB7XG4gICAgY29uc3QgY3VycmVudEZpbGUgPSB0aGlzLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChjdXJyZW50QXJlYVBhdGgpO1xuICAgIGlmICghdGhpcy5pc0ZpbGUoY3VycmVudEZpbGUpKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgb2JzaWRpYW5tZC9uby10ZmlsZS10Zm9sZGVyLWNhc3RcbiAgICBjb25zdCBjYWNoZSA9IHRoaXMubWV0YWRhdGFDYWNoZS5nZXRGaWxlQ2FjaGUoY3VycmVudEZpbGUgYXMgVEZpbGUpO1xuICAgIGNvbnN0IG1ldGFkYXRhID0gY2FjaGU/LmZyb250bWF0dGVyIHx8IHt9O1xuICAgIGNvbnN0IGluc3RhbmNlQ2xhc3MgPSB0aGlzLmV4dHJhY3RJbnN0YW5jZUNsYXNzKG1ldGFkYXRhKTtcblxuICAgIGlmIChpbnN0YW5jZUNsYXNzICE9PSBBc3NldENsYXNzLkFSRUEpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IGFsbEFyZWFzID0gdGhpcy5jb2xsZWN0QWxsQXJlYXNGcm9tVmF1bHQoKTtcbiAgICBjb25zdCB2aXNpdGVkID0gbmV3IFNldDxzdHJpbmc+KCk7XG4gICAgcmV0dXJuIHRoaXMuYnVpbGRUcmVlKGN1cnJlbnRBcmVhUGF0aCwgYWxsQXJlYXMsIHZpc2l0ZWQsIDApO1xuICB9XG5cbiAgcHJpdmF0ZSBpc0ZpbGUoZmlsZTogYW55KTogYm9vbGVhbiB7XG4gICAgaWYgKGZpbGUgaW5zdGFuY2VvZiBURmlsZSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIHJldHVybiAoXG4gICAgICBmaWxlICYmXG4gICAgICB0eXBlb2YgZmlsZSA9PT0gXCJvYmplY3RcIiAmJlxuICAgICAgXCJiYXNlbmFtZVwiIGluIGZpbGUgJiZcbiAgICAgIFwicGF0aFwiIGluIGZpbGUgJiZcbiAgICAgIFwic3RhdFwiIGluIGZpbGVcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBleHRyYWN0SW5zdGFuY2VDbGFzcyhtZXRhZGF0YTogUmVjb3JkPHN0cmluZywgYW55Pik6IHN0cmluZyB7XG4gICAgY29uc3QgaW5zdGFuY2VDbGFzcyA9IG1ldGFkYXRhLmV4b19fSW5zdGFuY2VfY2xhc3MgfHwgXCJcIjtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShpbnN0YW5jZUNsYXNzKSkge1xuICAgICAgcmV0dXJuIHRoaXMuY2xlYW5XaWtpTGluayhpbnN0YW5jZUNsYXNzWzBdIHx8IFwiXCIpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy5jbGVhbldpa2lMaW5rKGluc3RhbmNlQ2xhc3MpO1xuICB9XG5cbiAgcHJpdmF0ZSBjbGVhbldpa2lMaW5rKHZhbHVlOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGlmICh0eXBlb2YgdmFsdWUgIT09IFwic3RyaW5nXCIpIHJldHVybiBcIlwiO1xuICAgIHJldHVybiB2YWx1ZS5yZXBsYWNlKC9eXFxbXFxbfFxcXVxcXSQvZywgXCJcIikudHJpbSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBjb2xsZWN0QWxsQXJlYXNGcm9tVmF1bHQoKTogTWFwPHN0cmluZywgQXJlYU5vZGVEYXRhPiB7XG4gICAgY29uc3QgYXJlYXMgPSBuZXcgTWFwPHN0cmluZywgQXJlYU5vZGVEYXRhPigpO1xuICAgIGNvbnN0IHBhdGhCeUJhc2VuYW1lID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcblxuICAgIGNvbnN0IGFsbEZpbGVzID0gdGhpcy52YXVsdC5nZXRNYXJrZG93bkZpbGVzKCk7XG5cbiAgICBmb3IgKGNvbnN0IGZpbGUgb2YgYWxsRmlsZXMpIHtcbiAgICAgIGNvbnN0IGNhY2hlID0gdGhpcy5tZXRhZGF0YUNhY2hlLmdldEZpbGVDYWNoZShmaWxlKTtcbiAgICAgIGNvbnN0IG1ldGFkYXRhID0gY2FjaGU/LmZyb250bWF0dGVyIHx8IHt9O1xuICAgICAgY29uc3QgaW5zdGFuY2VDbGFzcyA9IHRoaXMuZXh0cmFjdEluc3RhbmNlQ2xhc3MobWV0YWRhdGEpO1xuXG4gICAgICBpZiAoaW5zdGFuY2VDbGFzcyA9PT0gQXNzZXRDbGFzcy5BUkVBKSB7XG4gICAgICAgIGNvbnN0IHBhcmVudFBhdGggPSB0aGlzLmV4dHJhY3RQYXJlbnRQYXRoKG1ldGFkYXRhKTtcbiAgICAgICAgYXJlYXMuc2V0KGZpbGUucGF0aCwge1xuICAgICAgICAgIHBhdGg6IGZpbGUucGF0aCxcbiAgICAgICAgICB0aXRsZTogZmlsZS5iYXNlbmFtZSxcbiAgICAgICAgICBsYWJlbDogbWV0YWRhdGEuZXhvX19Bc3NldF9sYWJlbCB8fCB1bmRlZmluZWQsXG4gICAgICAgICAgaXNBcmNoaXZlZDogdGhpcy5pc0FyY2hpdmVkKG1ldGFkYXRhKSxcbiAgICAgICAgICBkZXB0aDogMCxcbiAgICAgICAgICBwYXJlbnRQYXRoOiBwYXJlbnRQYXRoIHx8IHVuZGVmaW5lZCxcbiAgICAgICAgfSk7XG4gICAgICAgIHBhdGhCeUJhc2VuYW1lLnNldChmaWxlLmJhc2VuYW1lLCBmaWxlLnBhdGgpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGZvciAoY29uc3QgWywgYXJlYV0gb2YgYXJlYXMuZW50cmllcygpKSB7XG4gICAgICBpZiAoYXJlYS5wYXJlbnRQYXRoICYmIHBhdGhCeUJhc2VuYW1lLmhhcyhhcmVhLnBhcmVudFBhdGgpKSB7XG4gICAgICAgIGFyZWEucGFyZW50UGF0aCA9IHBhdGhCeUJhc2VuYW1lLmdldChhcmVhLnBhcmVudFBhdGgpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBhcmVhcztcbiAgfVxuXG4gIHByaXZhdGUgZXh0cmFjdFBhcmVudFBhdGgobWV0YWRhdGE6IFJlY29yZDxzdHJpbmcsIGFueT4pOiBzdHJpbmcgfCBudWxsIHtcbiAgICBjb25zdCBwYXJlbnRQcm9wZXJ0eSA9IG1ldGFkYXRhLmVtc19fQXJlYV9wYXJlbnQ7XG4gICAgaWYgKCFwYXJlbnRQcm9wZXJ0eSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkocGFyZW50UHJvcGVydHkpKSB7XG4gICAgICBjb25zdCBmaXJzdFBhcmVudCA9IHBhcmVudFByb3BlcnR5WzBdIHx8IFwiXCI7XG4gICAgICByZXR1cm4gdGhpcy5jbGVhbldpa2lMaW5rKGZpcnN0UGFyZW50KTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5jbGVhbldpa2lMaW5rKHBhcmVudFByb3BlcnR5KTtcbiAgfVxuXG4gIHByaXZhdGUgaXNBcmNoaXZlZChtZXRhZGF0YTogUmVjb3JkPHN0cmluZywgYW55Pik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGFyY2hpdmVkUHJvcCA9IG1ldGFkYXRhLmV4b19fQXNzZXRfYXJjaGl2ZWQ7XG4gICAgaWYgKGFyY2hpdmVkUHJvcCA9PT0gdHJ1ZSB8fCBhcmNoaXZlZFByb3AgPT09IFwidHJ1ZVwiKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKEFycmF5LmlzQXJyYXkoYXJjaGl2ZWRQcm9wKSAmJiBhcmNoaXZlZFByb3AubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgZmlyc3QgPSBhcmNoaXZlZFByb3BbMF07XG4gICAgICByZXR1cm4gZmlyc3QgPT09IHRydWUgfHwgZmlyc3QgPT09IFwidHJ1ZVwiO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkVHJlZShcbiAgICBwYXRoOiBzdHJpbmcsXG4gICAgYXJlYXM6IE1hcDxzdHJpbmcsIEFyZWFOb2RlRGF0YT4sXG4gICAgdmlzaXRlZDogU2V0PHN0cmluZz4sXG4gICAgZGVwdGg6IG51bWJlcixcbiAgKTogQXJlYU5vZGUgfCBudWxsIHtcbiAgICBpZiAodmlzaXRlZC5oYXMocGF0aCkpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHZpc2l0ZWQuYWRkKHBhdGgpO1xuXG4gICAgY29uc3QgYXJlYSA9IGFyZWFzLmdldChwYXRoKTtcbiAgICBpZiAoIWFyZWEpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IGNoaWxkcmVuOiBBcmVhTm9kZVtdID0gW107XG4gICAgZm9yIChjb25zdCBbY2hpbGRQYXRoLCBjaGlsZERhdGFdIG9mIGFyZWFzLmVudHJpZXMoKSkge1xuICAgICAgaWYgKGNoaWxkRGF0YS5wYXJlbnRQYXRoID09PSBwYXRoKSB7XG4gICAgICAgIGNvbnN0IGNoaWxkTm9kZSA9IHRoaXMuYnVpbGRUcmVlKGNoaWxkUGF0aCwgYXJlYXMsIHZpc2l0ZWQsIGRlcHRoICsgMSk7XG4gICAgICAgIGlmIChjaGlsZE5vZGUpIHtcbiAgICAgICAgICBjaGlsZHJlbi5wdXNoKGNoaWxkTm9kZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjaGlsZHJlbi5zb3J0KChhLCBiKSA9PiB7XG4gICAgICBjb25zdCBhTGFiZWwgPSBhLmxhYmVsIHx8IGEudGl0bGU7XG4gICAgICBjb25zdCBiTGFiZWwgPSBiLmxhYmVsIHx8IGIudGl0bGU7XG4gICAgICByZXR1cm4gYUxhYmVsLmxvY2FsZUNvbXBhcmUoYkxhYmVsKTtcbiAgICB9KTtcblxuICAgIHJldHVybiB7XG4gICAgICBwYXRoOiBhcmVhLnBhdGgsXG4gICAgICB0aXRsZTogYXJlYS50aXRsZSxcbiAgICAgIGxhYmVsOiBhcmVhLmxhYmVsLFxuICAgICAgaXNBcmNoaXZlZDogYXJlYS5pc0FyY2hpdmVkLFxuICAgICAgZGVwdGgsXG4gICAgICBwYXJlbnRQYXRoOiBhcmVhLnBhcmVudFBhdGgsXG4gICAgICBjaGlsZHJlbixcbiAgICB9O1xuICB9XG59XG4iXX0=