import { FrontmatterService } from "./FrontmatterService";
import { DateFormatter } from "../utilities/DateFormatter";
import { EffortStatusWorkflow } from "./EffortStatusWorkflow";
import { StatusTimestampService } from "./StatusTimestampService";
export class TaskStatusService {
    constructor(vault) {
        this.vault = vault;
        this.frontmatterService = new FrontmatterService();
        this.workflow = new EffortStatusWorkflow();
        this.timestampService = new StatusTimestampService(vault);
    }
    async setDraftStatus(taskFile) {
        await this.updateStatus(taskFile, "ems__EffortStatusDraft");
    }
    async moveToBacklog(taskFile) {
        await this.updateStatus(taskFile, "ems__EffortStatusBacklog");
    }
    async moveToAnalysis(projectFile) {
        await this.updateStatus(projectFile, "ems__EffortStatusAnalysis");
    }
    async moveToToDo(projectFile) {
        await this.updateStatus(projectFile, "ems__EffortStatusToDo");
    }
    async startEffort(taskFile) {
        const content = await this.vault.read(taskFile);
        const timestamp = DateFormatter.toLocalTimestamp(new Date());
        let updated = this.frontmatterService.updateProperty(content, "ems__Effort_status", '"[[ems__EffortStatusDoing]]"');
        updated = this.frontmatterService.updateProperty(updated, "ems__Effort_startTimestamp", timestamp);
        await this.vault.modify(taskFile, updated);
    }
    async markTaskAsDone(taskFile) {
        const content = await this.vault.read(taskFile);
        const timestamp = DateFormatter.toLocalTimestamp(new Date());
        let updated = this.frontmatterService.updateProperty(content, "ems__Effort_status", '"[[ems__EffortStatusDone]]"');
        updated = this.frontmatterService.updateProperty(updated, "ems__Effort_endTimestamp", timestamp);
        updated = this.frontmatterService.updateProperty(updated, "ems__Effort_resolutionTimestamp", timestamp);
        await this.vault.modify(taskFile, updated);
    }
    async syncEffortEndTimestamp(taskFile, date) {
        await this.timestampService.addEndAndResolutionTimestamps(taskFile, date);
    }
    async trashEffort(taskFile) {
        const content = await this.vault.read(taskFile);
        const timestamp = DateFormatter.toLocalTimestamp(new Date());
        let updated = this.frontmatterService.updateProperty(content, "ems__Effort_status", '"[[ems__EffortStatusTrashed]]"');
        updated = this.frontmatterService.updateProperty(updated, "ems__Effort_resolutionTimestamp", timestamp);
        await this.vault.modify(taskFile, updated);
    }
    async archiveTask(taskFile) {
        const content = await this.vault.read(taskFile);
        const updated = this.frontmatterService.updateProperty(content, "archived", "true");
        await this.vault.modify(taskFile, updated);
    }
    async planOnToday(taskFile) {
        const content = await this.vault.read(taskFile);
        const todayWikilink = DateFormatter.getTodayWikilink();
        const updated = this.frontmatterService.updateProperty(content, "ems__Effort_day", todayWikilink);
        await this.vault.modify(taskFile, updated);
    }
    async planForEvening(taskFile) {
        const content = await this.vault.read(taskFile);
        const evening = new Date();
        evening.setHours(19, 0, 0, 0);
        const eveningTimestamp = DateFormatter.toLocalTimestamp(evening);
        const updated = this.frontmatterService.updateProperty(content, "ems__Effort_plannedStartTimestamp", eveningTimestamp);
        await this.vault.modify(taskFile, updated);
    }
    async shiftDayBackward(taskFile) {
        await this.shiftDay(taskFile, -1);
    }
    async shiftDayForward(taskFile) {
        await this.shiftDay(taskFile, 1);
    }
    async rollbackStatus(taskFile) {
        const content = await this.vault.read(taskFile);
        const currentStatus = this.extractCurrentStatus(content);
        const instanceClass = this.extractInstanceClass(content);
        if (!currentStatus) {
            throw new Error("No current status to rollback from");
        }
        const previousStatus = this.workflow.getPreviousStatus(currentStatus, instanceClass);
        if (previousStatus === undefined) {
            throw new Error("Cannot rollback from current status");
        }
        let updated = content;
        if (previousStatus === null) {
            updated = this.frontmatterService.removeProperty(updated, "ems__Effort_status");
        }
        else {
            updated = this.frontmatterService.updateProperty(updated, "ems__Effort_status", previousStatus);
        }
        const normalizedStatus = this.workflow.normalizeStatus(currentStatus);
        if (normalizedStatus === "ems__EffortStatusDone") {
            updated = this.frontmatterService.removeProperty(updated, "ems__Effort_endTimestamp");
            updated = this.frontmatterService.removeProperty(updated, "ems__Effort_resolutionTimestamp");
        }
        else if (normalizedStatus === "ems__EffortStatusDoing") {
            updated = this.frontmatterService.removeProperty(updated, "ems__Effort_startTimestamp");
        }
        await this.vault.modify(taskFile, updated);
    }
    async updateStatus(taskFile, statusValue) {
        const content = await this.vault.read(taskFile);
        const updated = this.frontmatterService.updateProperty(content, "ems__Effort_status", `"[[${statusValue}]]"`);
        await this.vault.modify(taskFile, updated);
    }
    async shiftDay(taskFile, days) {
        const content = await this.vault.read(taskFile);
        const currentEffortDay = this.extractEffortDay(content);
        if (!currentEffortDay) {
            throw new Error("ems__Effort_day property not found");
        }
        const currentDate = this.parseDateFromWikilink(currentEffortDay);
        if (!currentDate) {
            throw new Error("Invalid date format in ems__Effort_day");
        }
        const newDate = DateFormatter.addDays(currentDate, days);
        const newWikilink = DateFormatter.toDateWikilink(newDate);
        const updated = this.frontmatterService.updateProperty(content, "ems__Effort_day", newWikilink);
        await this.vault.modify(taskFile, updated);
    }
    parseDateFromWikilink(wikilink) {
        const cleanValue = wikilink.replace(/["'[\]]/g, "").trim();
        const date = new Date(cleanValue);
        if (isNaN(date.getTime())) {
            return null;
        }
        return date;
    }
    extractEffortDay(content) {
        const parsed = this.frontmatterService.parse(content);
        if (!parsed.exists)
            return null;
        return this.frontmatterService.getPropertyValue(parsed.content, "ems__Effort_day");
    }
    extractCurrentStatus(content) {
        const parsed = this.frontmatterService.parse(content);
        if (!parsed.exists)
            return null;
        return this.frontmatterService.getPropertyValue(parsed.content, "ems__Effort_status");
    }
    extractInstanceClass(content) {
        const parsed = this.frontmatterService.parse(content);
        if (!parsed.exists)
            return null;
        const arrayMatch = parsed.content.match(/exo__Instance_class:\s*\n((?:\s*-\s*.*\n?)+)/);
        if (arrayMatch) {
            const lines = arrayMatch[1].split("\n").filter(l => l.trim());
            return lines.map((line) => line.replace(/^\s*-\s*/, "").trim());
        }
        return this.frontmatterService.getPropertyValue(parsed.content, "exo__Instance_class");
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGFza1N0YXR1c1NlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJUYXNrU3RhdHVzU2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUMxRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sNEJBQTRCLENBQUM7QUFDM0QsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDOUQsT0FBTyxFQUFFLHNCQUFzQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFFbEUsTUFBTSxPQUFPLGlCQUFpQjtJQUs1QixZQUFvQixLQUFZO1FBQVosVUFBSyxHQUFMLEtBQUssQ0FBTztRQUM5QixJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxrQkFBa0IsRUFBRSxDQUFDO1FBQ25ELElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxvQkFBb0IsRUFBRSxDQUFDO1FBQzNDLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLHNCQUFzQixDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzVELENBQUM7SUFFRCxLQUFLLENBQUMsY0FBYyxDQUFDLFFBQWU7UUFDbEMsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSx3QkFBd0IsQ0FBQyxDQUFDO0lBQzlELENBQUM7SUFFRCxLQUFLLENBQUMsYUFBYSxDQUFDLFFBQWU7UUFDakMsTUFBTSxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsRUFBRSwwQkFBMEIsQ0FBQyxDQUFDO0lBQ2hFLENBQUM7SUFFRCxLQUFLLENBQUMsY0FBYyxDQUFDLFdBQWtCO1FBQ3JDLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsMkJBQTJCLENBQUMsQ0FBQztJQUNwRSxDQUFDO0lBRUQsS0FBSyxDQUFDLFVBQVUsQ0FBQyxXQUFrQjtRQUNqQyxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLHVC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dWx0IH0gZnJvbSBcIm9ic2lkaWFuXCI7XG5pbXBvcnQgeyBGcm9udG1hdHRlclNlcnZpY2UgfSBmcm9tIFwiLi9Gcm9udG1hdHRlclNlcnZpY2VcIjtcbmltcG9ydCB7IERhdGVGb3JtYXR0ZXIgfSBmcm9tIFwiLi4vdXRpbGl0aWVzL0RhdGVGb3JtYXR0ZXJcIjtcbmltcG9ydCB7IEVmZm9ydFN0YXR1c1dvcmtmbG93IH0gZnJvbSBcIi4vRWZmb3J0U3RhdHVzV29ya2Zsb3dcIjtcbmltcG9ydCB7IFN0YXR1c1RpbWVzdGFtcFNlcnZpY2UgfSBmcm9tIFwiLi9TdGF0dXNUaW1lc3RhbXBTZXJ2aWNlXCI7XG5cbmV4cG9ydCBjbGFzcyBUYXNrU3RhdHVzU2VydmljZSB7XG4gIHByaXZhdGUgZnJvbnRtYXR0ZXJTZXJ2aWNlOiBGcm9udG1hdHRlclNlcnZpY2U7XG4gIHByaXZhdGUgd29ya2Zsb3c6IEVmZm9ydFN0YXR1c1dvcmtmbG93O1xuICBwcml2YXRlIHRpbWVzdGFtcFNlcnZpY2U6IFN0YXR1c1RpbWVzdGFtcFNlcnZpY2U7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSB2YXVsdDogVmF1bHQpIHtcbiAgICB0aGlzLmZyb250bWF0dGVyU2VydmljZSA9IG5ldyBGcm9udG1hdHRlclNlcnZpY2UoKTtcbiAgICB0aGlzLndvcmtmbG93ID0gbmV3IEVmZm9ydFN0YXR1c1dvcmtmbG93KCk7XG4gICAgdGhpcy50aW1lc3RhbXBTZXJ2aWNlID0gbmV3IFN0YXR1c1RpbWVzdGFtcFNlcnZpY2UodmF1bHQpO1xuICB9XG5cbiAgYXN5bmMgc2V0RHJhZnRTdGF0dXModGFza0ZpbGU6IFRGaWxlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy51cGRhdGVTdGF0dXModGFza0ZpbGUsIFwiZW1zX19FZmZvcnRTdGF0dXNEcmFmdFwiKTtcbiAgfVxuXG4gIGFzeW5jIG1vdmVUb0JhY2tsb2codGFza0ZpbGU6IFRGaWxlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy51cGRhdGVTdGF0dXModGFza0ZpbGUsIFwiZW1zX19FZmZvcnRTdGF0dXNCYWNrbG9nXCIpO1xuICB9XG5cbiAgYXN5bmMgbW92ZVRvQW5hbHlzaXMocHJvamVjdEZpbGU6IFRGaWxlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy51cGRhdGVTdGF0dXMocHJvamVjdEZpbGUsIFwiZW1zX19FZmZvcnRTdGF0dXNBbmFseXNpc1wiKTtcbiAgfVxuXG4gIGFzeW5jIG1vdmVUb1RvRG8ocHJvamVjdEZpbGU6IFRGaWxlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy51cGRhdGVTdGF0dXMocHJvamVjdEZpbGUsIFwiZW1zX19FZmZvcnRTdGF0dXNUb0RvXCIpO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRFZmZvcnQodGFza0ZpbGU6IFRGaWxlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgY29udGVudCA9IGF3YWl0IHRoaXMudmF1bHQucmVhZCh0YXNrRmlsZSk7XG4gICAgY29uc3QgdGltZXN0YW1wID0gRGF0ZUZvcm1hdHRlci50b0xvY2FsVGltZXN0YW1wKG5ldyBEYXRlKCkpO1xuXG4gICAgbGV0IHVwZGF0ZWQgPSB0aGlzLmZyb250bWF0dGVyU2VydmljZS51cGRhdGVQcm9wZXJ0eShcbiAgICAgIGNvbnRlbnQsXG4gICAgICBcImVtc19fRWZmb3J0X3N0YXR1c1wiLFxuICAgICAgJ1wiW1tlbXNfX0VmZm9ydFN0YXR1c0RvaW5nXV1cIicsXG4gICAgKTtcbiAgICB1cGRhdGVkID0gdGhpcy5mcm9udG1hdHRlclNlcnZpY2UudXBkYXRlUHJvcGVydHkoXG4gICAgICB1cGRhdGVkLFxuICAgICAgXCJlbXNfX0VmZm9ydF9zdGFydFRpbWVzdGFtcFwiLFxuICAgICAgdGltZXN0YW1wLFxuICAgICk7XG5cbiAgICBhd2FpdCB0aGlzLnZhdWx0Lm1vZGlmeSh0YXNrRmlsZSwgdXBkYXRlZCk7XG4gIH1cblxuICBhc3luYyBtYXJrVGFza0FzRG9uZSh0YXNrRmlsZTogVEZpbGUpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBjb250ZW50ID0gYXdhaXQgdGhpcy52YXVsdC5yZWFkKHRhc2tGaWxlKTtcbiAgICBjb25zdCB0aW1lc3RhbXAgPSBEYXRlRm9ybWF0dGVyLnRvTG9jYWxUaW1lc3RhbXAobmV3IERhdGUoKSk7XG5cbiAgICBsZXQgdXBkYXRlZCA9IHRoaXMuZnJvbnRtYXR0ZXJTZXJ2aWNlLnVwZGF0ZVByb3BlcnR5KFxuICAgICAgY29udGVudCxcbiAgICAgIFwiZW1zX19FZmZvcnRfc3RhdHVzXCIsXG4gICAgICAnXCJbW2Vtc19fRWZmb3J0U3RhdHVzRG9uZV1dXCInLFxuICAgICk7XG4gICAgdXBkYXRlZCA9IHRoaXMuZnJvbnRtYXR0ZXJTZXJ2aWNlLnVwZGF0ZVByb3BlcnR5KFxuICAgICAgdXBkYXRlZCxcbiAgICAgIFwiZW1zX19FZmZvcnRfZW5kVGltZXN0YW1wXCIsXG4gICAgICB0aW1lc3RhbXAsXG4gICAgKTtcbiAgICB1cGRhdGVkID0gdGhpcy5mcm9udG1hdHRlclNlcnZpY2UudXBkYXRlUHJvcGVydHkoXG4gICAgICB1cGRhdGVkLFxuICAgICAgXCJlbXNfX0VmZm9ydF9yZXNvbHV0aW9uVGltZXN0YW1wXCIsXG4gICAgICB0aW1lc3RhbXAsXG4gICAgKTtcblxuICAgIGF3YWl0IHRoaXMudmF1bHQubW9kaWZ5KHRhc2tGaWxlLCB1cGRhdGVkKTtcbiAgfVxuXG4gIGFzeW5jIHN5bmNFZmZvcnRFbmRUaW1lc3RhbXAoXG4gICAgdGFza0ZpbGU6IFRGaWxlLFxuICAgIGRhdGU/OiBEYXRlLFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLnRpbWVzdGFtcFNlcnZpY2UuYWRkRW5kQW5kUmVzb2x1dGlvblRpbWVzdGFtcHModGFza0ZpbGUsIGRhdGUpO1xuICB9XG5cbiAgYXN5bmMgdHJhc2hFZmZvcnQodGFza0ZpbGU6IFRGaWxlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgY29udGVudCA9IGF3YWl0IHRoaXMudmF1bHQucmVhZCh0YXNrRmlsZSk7XG4gICAgY29uc3QgdGltZXN0YW1wID0gRGF0ZUZvcm1hdHRlci50b0xvY2FsVGltZXN0YW1wKG5ldyBEYXRlKCkpO1xuXG4gICAgbGV0IHVwZGF0ZWQgPSB0aGlzLmZyb250bWF0dGVyU2VydmljZS51cGRhdGVQcm9wZXJ0eShcbiAgICAgIGNvbnRlbnQsXG4gICAgICBcImVtc19fRWZmb3J0X3N0YXR1c1wiLFxuICAgICAgJ1wiW1tlbXNfX0VmZm9ydFN0YXR1c1RyYXNoZWRdXVwiJyxcbiAgICApO1xuICAgIHVwZGF0ZWQgPSB0aGlzLmZyb250bWF0dGVyU2VydmljZS51cGRhdGVQcm9wZXJ0eShcbiAgICAgIHVwZGF0ZWQsXG4gICAgICBcImVtc19fRWZmb3J0X3Jlc29sdXRpb25UaW1lc3RhbXBcIixcbiAgICAgIHRpbWVzdGFtcCxcbiAgICApO1xuXG4gICAgYXdhaXQgdGhpcy52YXVsdC5tb2RpZnkodGFza0ZpbGUsIHVwZGF0ZWQpO1xuICB9XG5cbiAgYXN5bmMgYXJjaGl2ZVRhc2sodGFza0ZpbGU6IFRGaWxlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgY29udGVudCA9IGF3YWl0IHRoaXMudmF1bHQucmVhZCh0YXNrRmlsZSk7XG4gICAgY29uc3QgdXBkYXRlZCA9IHRoaXMuZnJvbnRtYXR0ZXJTZXJ2aWNlLnVwZGF0ZVByb3BlcnR5KFxuICAgICAgY29udGVudCxcbiAgICAgIFwiYXJjaGl2ZWRcIixcbiAgICAgIFwidHJ1ZVwiLFxuICAgICk7XG4gICAgYXdhaXQgdGhpcy52YXVsdC5tb2RpZnkodGFza0ZpbGUsIHVwZGF0ZWQpO1xuICB9XG5cbiAgYXN5bmMgcGxhbk9uVG9kYXkodGFza0ZpbGU6IFRGaWxlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgY29udGVudCA9IGF3YWl0IHRoaXMudmF1bHQucmVhZCh0YXNrRmlsZSk7XG4gICAgY29uc3QgdG9kYXlXaWtpbGluayA9IERhdGVGb3JtYXR0ZXIuZ2V0VG9kYXlXaWtpbGluaygpO1xuICAgIGNvbnN0IHVwZGF0ZWQgPSB0aGlzLmZyb250bWF0dGVyU2VydmljZS51cGRhdGVQcm9wZXJ0eShcbiAgICAgIGNvbnRlbnQsXG4gICAgICBcImVtc19fRWZmb3J0X2RheVwiLFxuICAgICAgdG9kYXlXaWtpbGluayxcbiAgICApO1xuICAgIGF3YWl0IHRoaXMudmF1bHQubW9kaWZ5KHRhc2tGaWxlLCB1cGRhdGVkKTtcbiAgfVxuXG4gIGFzeW5jIHBsYW5Gb3JFdmVuaW5nKHRhc2tGaWxlOiBURmlsZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGNvbnRlbnQgPSBhd2FpdCB0aGlzLnZhdWx0LnJlYWQodGFza0ZpbGUpO1xuICAgIGNvbnN0IGV2ZW5pbmcgPSBuZXcgRGF0ZSgpO1xuICAgIGV2ZW5pbmcuc2V0SG91cnMoMTksIDAsIDAsIDApO1xuICAgIGNvbnN0IGV2ZW5pbmdUaW1lc3RhbXAgPSBEYXRlRm9ybWF0dGVyLnRvTG9jYWxUaW1lc3RhbXAoZXZlbmluZyk7XG5cbiAgICBjb25zdCB1cGRhdGVkID0gdGhpcy5mcm9udG1hdHRlclNlcnZpY2UudXBkYXRlUHJvcGVydHkoXG4gICAgICBjb250ZW50LFxuICAgICAgXCJlbXNfX0VmZm9ydF9wbGFubmVkU3RhcnRUaW1lc3RhbXBcIixcbiAgICAgIGV2ZW5pbmdUaW1lc3RhbXAsXG4gICAgKTtcbiAgICBhd2FpdCB0aGlzLnZhdWx0Lm1vZGlmeSh0YXNrRmlsZSwgdXBkYXRlZCk7XG4gIH1cblxuICBhc3luYyBzaGlmdERheUJhY2t3YXJkKHRhc2tGaWxlOiBURmlsZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHRoaXMuc2hpZnREYXkodGFza0ZpbGUsIC0xKTtcbiAgfVxuXG4gIGFzeW5jIHNoaWZ0RGF5Rm9yd2FyZCh0YXNrRmlsZTogVEZpbGUpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLnNoaWZ0RGF5KHRhc2tGaWxlLCAxKTtcbiAgfVxuXG4gIGFzeW5jIHJvbGxiYWNrU3RhdHVzKHRhc2tGaWxlOiBURmlsZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGNvbnRlbnQgPSBhd2FpdCB0aGlzLnZhdWx0LnJlYWQodGFza0ZpbGUpO1xuICAgIGNvbnN0IGN1cnJlbnRTdGF0dXMgPSB0aGlzLmV4dHJhY3RDdXJyZW50U3RhdHVzKGNvbnRlbnQpO1xuICAgIGNvbnN0IGluc3RhbmNlQ2xhc3MgPSB0aGlzLmV4dHJhY3RJbnN0YW5jZUNsYXNzKGNvbnRlbnQpO1xuXG4gICAgaWYgKCFjdXJyZW50U3RhdHVzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJObyBjdXJyZW50IHN0YXR1cyB0byByb2xsYmFjayBmcm9tXCIpO1xuICAgIH1cblxuICAgIGNvbnN0IHByZXZpb3VzU3RhdHVzID0gdGhpcy53b3JrZmxvdy5nZXRQcmV2aW91c1N0YXR1cyhcbiAgICAgIGN1cnJlbnRTdGF0dXMsXG4gICAgICBpbnN0YW5jZUNsYXNzLFxuICAgICk7XG5cbiAgICBpZiAocHJldmlvdXNTdGF0dXMgPT09IHVuZGVmaW5lZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IHJvbGxiYWNrIGZyb20gY3VycmVudCBzdGF0dXNcIik7XG4gICAgfVxuXG4gICAgbGV0IHVwZGF0ZWQgPSBjb250ZW50O1xuXG4gICAgaWYgKHByZXZpb3VzU3RhdHVzID09PSBudWxsKSB7XG4gICAgICB1cGRhdGVkID0gdGhpcy5mcm9udG1hdHRlclNlcnZpY2UucmVtb3ZlUHJvcGVydHkoXG4gICAgICAgIHVwZGF0ZWQsXG4gICAgICAgIFwiZW1zX19FZmZvcnRfc3RhdHVzXCIsXG4gICAgICApO1xuICAgIH0gZWxzZSB7XG4gICAgICB1cGRhdGVkID0gdGhpcy5mcm9udG1hdHRlclNlcnZpY2UudXBkYXRlUHJvcGVydHkoXG4gICAgICAgIHVwZGF0ZWQsXG4gICAgICAgIFwiZW1zX19FZmZvcnRfc3RhdHVzXCIsXG4gICAgICAgIHByZXZpb3VzU3RhdHVzLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBub3JtYWxpemVkU3RhdHVzID0gdGhpcy53b3JrZmxvdy5ub3JtYWxpemVTdGF0dXMoY3VycmVudFN0YXR1cyk7XG5cbiAgICBpZiAobm9ybWFsaXplZFN0YXR1cyA9PT0gXCJlbXNfX0VmZm9ydFN0YXR1c0RvbmVcIikge1xuICAgICAgdXBkYXRlZCA9IHRoaXMuZnJvbnRtYXR0ZXJTZXJ2aWNlLnJlbW92ZVByb3BlcnR5KFxuICAgICAgICB1cGRhdGVkLFxuICAgICAgICBcImVtc19fRWZmb3J0X2VuZFRpbWVzdGFtcFwiLFxuICAgICAgKTtcbiAgICAgIHVwZGF0ZWQgPSB0aGlzLmZyb250bWF0dGVyU2VydmljZS5yZW1vdmVQcm9wZXJ0eShcbiAgICAgICAgdXBkYXRlZCxcbiAgICAgICAgXCJlbXNfX0VmZm9ydF9yZXNvbHV0aW9uVGltZXN0YW1wXCIsXG4gICAgICApO1xuICAgIH0gZWxzZSBpZiAobm9ybWFsaXplZFN0YXR1cyA9PT0gXCJlbXNfX0VmZm9ydFN0YXR1c0RvaW5nXCIpIHtcbiAgICAgIHVwZGF0ZWQgPSB0aGlzLmZyb250bWF0dGVyU2VydmljZS5yZW1vdmVQcm9wZXJ0eShcbiAgICAgICAgdXBkYXRlZCxcbiAgICAgICAgXCJlbXNfX0VmZm9ydF9zdGFydFRpbWVzdGFtcFwiLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLnZhdWx0Lm1vZGlmeSh0YXNrRmlsZSwgdXBkYXRlZCk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHVwZGF0ZVN0YXR1cyhcbiAgICB0YXNrRmlsZTogVEZpbGUsXG4gICAgc3RhdHVzVmFsdWU6IHN0cmluZyxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgY29udGVudCA9IGF3YWl0IHRoaXMudmF1bHQucmVhZCh0YXNrRmlsZSk7XG4gICAgY29uc3QgdXBkYXRlZCA9IHRoaXMuZnJvbnRtYXR0ZXJTZXJ2aWNlLnVwZGF0ZVByb3BlcnR5KFxuICAgICAgY29udGVudCxcbiAgICAgIFwiZW1zX19FZmZvcnRfc3RhdHVzXCIsXG4gICAgICBgXCJbWyR7c3RhdHVzVmFsdWV9XV1cImAsXG4gICAgKTtcbiAgICBhd2FpdCB0aGlzLnZhdWx0Lm1vZGlmeSh0YXNrRmlsZSwgdXBkYXRlZCk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNoaWZ0RGF5KHRhc2tGaWxlOiBURmlsZSwgZGF5czogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgY29udGVudCA9IGF3YWl0IHRoaXMudmF1bHQucmVhZCh0YXNrRmlsZSk7XG4gICAgY29uc3QgY3VycmVudEVmZm9ydERheSA9IHRoaXMuZXh0cmFjdEVmZm9ydERheShjb250ZW50KTtcblxuICAgIGlmICghY3VycmVudEVmZm9ydERheSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiZW1zX19FZmZvcnRfZGF5IHByb3BlcnR5IG5vdCBmb3VuZFwiKTtcbiAgICB9XG5cbiAgICBjb25zdCBjdXJyZW50RGF0ZSA9IHRoaXMucGFyc2VEYXRlRnJvbVdpa2lsaW5rKGN1cnJlbnRFZmZvcnREYXkpO1xuXG4gICAgaWYgKCFjdXJyZW50RGF0ZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCBkYXRlIGZvcm1hdCBpbiBlbXNfX0VmZm9ydF9kYXlcIik7XG4gICAgfVxuXG4gICAgY29uc3QgbmV3RGF0ZSA9IERhdGVGb3JtYXR0ZXIuYWRkRGF5cyhjdXJyZW50RGF0ZSwgZGF5cyk7XG4gICAgY29uc3QgbmV3V2lraWxpbmsgPSBEYXRlRm9ybWF0dGVyLnRvRGF0ZVdpa2lsaW5rKG5ld0RhdGUpO1xuXG4gICAgY29uc3QgdXBkYXRlZCA9IHRoaXMuZnJvbnRtYXR0ZXJTZXJ2aWNlLnVwZGF0ZVByb3BlcnR5KFxuICAgICAgY29udGVudCxcbiAgICAgIFwiZW1zX19FZmZvcnRfZGF5XCIsXG4gICAgICBuZXdXaWtpbGluayxcbiAgICApO1xuICAgIGF3YWl0IHRoaXMudmF1bHQubW9kaWZ5KHRhc2tGaWxlLCB1cGRhdGVkKTtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VEYXRlRnJvbVdpa2lsaW5rKHdpa2lsaW5rOiBzdHJpbmcpOiBEYXRlIHwgbnVsbCB7XG4gICAgY29uc3QgY2xlYW5WYWx1ZSA9IHdpa2lsaW5rLnJlcGxhY2UoL1tcIidbXFxdXS9nLCBcIlwiKS50cmltKCk7XG4gICAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKGNsZWFuVmFsdWUpO1xuXG4gICAgaWYgKGlzTmFOKGRhdGUuZ2V0VGltZSgpKSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRhdGU7XG4gIH1cblxuICBwcml2YXRlIGV4dHJhY3RFZmZvcnREYXkoY29udGVudDogc3RyaW5nKTogc3RyaW5nIHwgbnVsbCB7XG4gICAgY29uc3QgcGFyc2VkID0gdGhpcy5mcm9udG1hdHRlclNlcnZpY2UucGFyc2UoY29udGVudCk7XG4gICAgaWYgKCFwYXJzZWQuZXhpc3RzKSByZXR1cm4gbnVsbDtcblxuICAgIHJldHVybiB0aGlzLmZyb250bWF0dGVyU2VydmljZS5nZXRQcm9wZXJ0eVZhbHVlKFxuICAgICAgcGFyc2VkLmNvbnRlbnQsXG4gICAgICBcImVtc19fRWZmb3J0X2RheVwiLFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGV4dHJhY3RDdXJyZW50U3RhdHVzKGNvbnRlbnQ6IHN0cmluZyk6IHN0cmluZyB8IG51bGwge1xuICAgIGNvbnN0IHBhcnNlZCA9IHRoaXMuZnJvbnRtYXR0ZXJTZXJ2aWNlLnBhcnNlKGNvbnRlbnQpO1xuICAgIGlmICghcGFyc2VkLmV4aXN0cykgcmV0dXJuIG51bGw7XG5cbiAgICByZXR1cm4gdGhpcy5mcm9udG1hdHRlclNlcnZpY2UuZ2V0UHJvcGVydHlWYWx1ZShcbiAgICAgIHBhcnNlZC5jb250ZW50LFxuICAgICAgXCJlbXNfX0VmZm9ydF9zdGF0dXNcIixcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBleHRyYWN0SW5zdGFuY2VDbGFzcyhjb250ZW50OiBzdHJpbmcpOiBzdHJpbmcgfCBzdHJpbmdbXSB8IG51bGwge1xuICAgIGNvbnN0IHBhcnNlZCA9IHRoaXMuZnJvbnRtYXR0ZXJTZXJ2aWNlLnBhcnNlKGNvbnRlbnQpO1xuICAgIGlmICghcGFyc2VkLmV4aXN0cykgcmV0dXJuIG51bGw7XG5cbiAgICBjb25zdCBhcnJheU1hdGNoID0gcGFyc2VkLmNvbnRlbnQubWF0Y2goXG4gICAgICAvZXhvX19JbnN0YW5jZV9jbGFzczpcXHMqXFxuKCg/OlxccyotXFxzKi4qXFxuPykrKS8sXG4gICAgKTtcblxuICAgIGlmIChhcnJheU1hdGNoKSB7XG4gICAgICBjb25zdCBsaW5lcyA9IGFycmF5TWF0Y2hbMV0uc3BsaXQoXCJcXG5cIikuZmlsdGVyKGwgPT4gbC50cmltKCkpO1xuICAgICAgcmV0dXJuIGxpbmVzLm1hcCgobGluZSkgPT4gbGluZS5yZXBsYWNlKC9eXFxzKi1cXHMqLywgXCJcIikudHJpbSgpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5mcm9udG1hdHRlclNlcnZpY2UuZ2V0UHJvcGVydHlWYWx1ZShcbiAgICAgIHBhcnNlZC5jb250ZW50LFxuICAgICAgXCJleG9fX0luc3RhbmNlX2NsYXNzXCIsXG4gICAgKTtcbiAgfVxufVxuIl19