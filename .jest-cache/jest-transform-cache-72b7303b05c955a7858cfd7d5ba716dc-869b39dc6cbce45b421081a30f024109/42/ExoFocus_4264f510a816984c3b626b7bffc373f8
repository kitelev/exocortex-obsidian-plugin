8b237b9e783dc9b331078cb5c9d95168
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ExoFocus = void 0;
const Entity_1 = require("../core/Entity");
const Result_1 = require("../core/Result");
class ExoFocus extends Entity_1.Entity {
    constructor(props, id) {
        super(props);
        this._focusId = id || this.generateId();
    }
    generateId() {
        return 'focus-' + Date.now() + '-' + Math.random().toString(36).substring(2, 9);
    }
    get id() {
        return this._focusId;
    }
    static create(props, id) {
        if (!props.name || props.name.trim().length === 0) {
            return Result_1.Result.fail('Focus name is required');
        }
        if (props.priority < 0 || props.priority > 100) {
            return Result_1.Result.fail('Priority must be between 0 and 100');
        }
        return Result_1.Result.ok(new ExoFocus(props, id));
    }
    get name() {
        return this.props.name;
    }
    get description() {
        return this.props.description;
    }
    get filters() {
        return this.props.filters;
    }
    get priority() {
        return this.props.priority;
    }
    get active() {
        return this.props.active;
    }
    get createdAt() {
        return this.props.createdAt;
    }
    get updatedAt() {
        return this.props.updatedAt;
    }
    addFilter(filter) {
        if (!this.isValidFilter(filter)) {
            return Result_1.Result.fail('Invalid filter configuration');
        }
        this.props.filters.push(filter);
        this.props.updatedAt = new Date();
        return Result_1.Result.ok();
    }
    removeFilter(index) {
        if (index < 0 || index >= this.props.filters.length) {
            return Result_1.Result.fail('Invalid filter index');
        }
        this.props.filters.splice(index, 1);
        this.props.updatedAt = new Date();
        return Result_1.Result.ok();
    }
    activate() {
        this.props.active = true;
        this.props.updatedAt = new Date();
    }
    deactivate() {
        this.props.active = false;
        this.props.updatedAt = new Date();
    }
    updatePriority(priority) {
        if (priority < 0 || priority > 100) {
            return Result_1.Result.fail('Priority must be between 0 and 100');
        }
        this.props.priority = priority;
        this.props.updatedAt = new Date();
        return Result_1.Result.ok();
    }
    matchesAsset(asset) {
        if (!this.props.active) {
            return true;
        }
        for (const filter of this.props.filters) {
            if (!this.evaluateFilter(filter, asset)) {
                return false;
            }
        }
        return true;
    }
    matchesTriple(triple) {
        if (!this.props.active) {
            return true;
        }
        for (const filter of this.props.filters) {
            if (filter.type === 'property' && filter.property) {
                if (filter.property !== triple.predicate) {
                    continue;
                }
                if (!this.evaluateValue(filter.operator, triple.object, filter.value)) {
                    return false;
                }
            }
        }
        return true;
    }
    isValidFilter(filter) {
        const validTypes = ['class', 'tag', 'property', 'timeframe', 'relation'];
        const validOperators = ['includes', 'excludes', 'equals', 'contains', 'before', 'after', 'between'];
        return validTypes.includes(filter.type) && validOperators.includes(filter.operator);
    }
    evaluateFilter(filter, asset) {
        switch (filter.type) {
            case 'class':
                return this.evaluateClassFilter(filter, asset);
            case 'tag':
                return this.evaluateTagFilter(filter, asset);
            case 'property':
                return this.evaluatePropertyFilter(filter, asset);
            case 'timeframe':
                return this.evaluateTimeframeFilter(filter, asset);
            case 'relation':
                return this.evaluateRelationFilter(filter, asset);
            default:
                return true;
        }
    }
    evaluateClassFilter(filter, asset) {
        const assetClass = asset['exo__Instance_class'] || asset.class;
        if (!assetClass)
            return false;
        const className = assetClass.replace(/\[\[|\]\]/g, '');
        switch (filter.operator) {
            case 'equals':
                return className === filter.value;
            case 'includes':
                return Array.isArray(filter.value) ? filter.value.includes(className) : className === filter.value;
            case 'excludes':
                return Array.isArray(filter.value) ? !filter.value.includes(className) : className !== filter.value;
            case 'contains':
                return className.toLowerCase().includes(String(filter.value).toLowerCase());
            default:
                return true;
        }
    }
    evaluateTagFilter(filter, asset) {
        const tags = asset.tags || asset['exo__Asset_tags'] || [];
        const tagArray = Array.isArray(tags) ? tags : [tags];
        switch (filter.operator) {
            case 'includes':
                return tagArray.some(tag => tag === filter.value ||
                    (Array.isArray(filter.value) && filter.value.includes(tag)));
            case 'excludes':
                return !tagArray.some(tag => tag === filter.value ||
                    (Array.isArray(filter.value) && filter.value.includes(tag)));
            case 'contains':
                return tagArray.some(tag => tag.toLowerCase().includes(String(filter.value).toLowerCase()));
            default:
                return true;
        }
    }
    evaluatePropertyFilter(filter, asset) {
        if (!filter.property)
            return true;
        const value = asset[filter.property];
        if (value === undefined)
            return filter.operator === 'excludes';
        return this.evaluateValue(filter.operator, value, filter.value);
    }
    evaluateTimeframeFilter(filter, asset) {
        const dateProperties = [
            'exo__Asset_createdAt',
            'exo__Asset_updatedAt',
            'ems__Task_dueDate',
            'ems__Event_date'
        ];
        for (const prop of dateProperties) {
            const dateValue = asset[prop];
            if (dateValue) {
                const date = new Date(dateValue);
                if (!isNaN(date.getTime())) {
                    return this.evaluateDateValue(filter.operator, date, filter.value);
                }
            }
        }
        return filter.operator === 'excludes';
    }
    evaluateRelationFilter(filter, asset) {
        // This would need access to the graph to evaluate relations
        // For now, return true
        return true;
    }
    evaluateValue(operator, actualValue, filterValue) {
        switch (operator) {
            case 'equals':
                return actualValue === filterValue;
            case 'includes':
                if (Array.isArray(actualValue)) {
                    return actualValue.includes(filterValue);
                }
                return actualValue === filterValue;
            case 'excludes':
                if (Array.isArray(actualValue)) {
                    return !actualValue.includes(filterValue);
                }
                return actualValue !== filterValue;
            case 'contains':
                return String(actualValue).toLowerCase().includes(String(filterValue).toLowerCase());
            default:
                return true;
        }
    }
    evaluateDateValue(operator, date, filterValue) {
        switch (operator) {
            case 'before':
                return date < new Date(filterValue);
            case 'after':
                return date > new Date(filterValue);
            case 'between':
                if (Array.isArray(filterValue) && filterValue.length === 2) {
                    const start = new Date(filterValue[0]);
                    const end = new Date(filterValue[1]);
                    return date >= start && date <= end;
                }
                return false;
            case 'equals':
                const filterDate = new Date(filterValue);
                return date.toDateString() === filterDate.toDateString();
            default:
                return true;
        }
    }
    toJSON() {
        return {
            id: this.id,
            name: this.props.name,
            description: this.props.description,
            filters: this.props.filters,
            priority: this.props.priority,
            active: this.props.active,
            createdAt: this.props.createdAt.toISOString(),
            updatedAt: this.props.updatedAt.toISOString()
        };
    }
    static fromJSON(json) {
        return ExoFocus.create({
            name: json.name,
            description: json.description,
            filters: json.filters || [],
            priority: json.priority || 50,
            active: json.active !== false,
            createdAt: new Date(json.createdAt || Date.now()),
            updatedAt: new Date(json.updatedAt || Date.now())
        }, json.id);
    }
}
exports.ExoFocus = ExoFocus;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2RvbWFpbi9lbnRpdGllcy9FeG9Gb2N1cy50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSwyQ0FBd0M7QUFDeEMsMkNBQXdDO0FBbUJ4QyxNQUFhLFFBQVMsU0FBUSxlQUFxQjtJQUcvQyxZQUFvQixLQUFvQixFQUFFLEVBQVc7UUFDakQsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2IsSUFBSSxDQUFDLFFBQVEsR0FBRyxFQUFFLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQzVDLENBQUM7SUFFTyxVQUFVO1FBQ2QsT0FBTyxRQUFRLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDcEYsQ0FBQztJQUVELElBQUksRUFBRTtRQUNGLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQztJQUN6QixDQUFDO0lBRU0sTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFvQixFQUFFLEVBQVc7UUFDbEQsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQy9DLE9BQU8sZUFBTSxDQUFDLElBQUksQ0FBVyx3QkFBd0IsQ0FBQyxDQUFDO1NBQzFEO1FBRUQsSUFBSSxLQUFLLENBQUMsUUFBUSxHQUFHLENBQUMsSUFBSSxLQUFLLENBQUMsUUFBUSxHQUFHLEdBQUcsRUFBRTtZQUM1QyxPQUFPLGVBQU0sQ0FBQyxJQUFJLENBQVcsb0NBQW9DLENBQUMsQ0FBQztTQUN0RTtRQUVELE9BQU8sZUFBTSxDQUFDLEVBQUUsQ0FBVyxJQUFJLFFBQVEsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUN4RCxD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QUMsV0FBVyxFQUFFO1lBQzdDLFNBQVMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxXQUFXLEVBQUU7U0FDaEQsQ0FBQztJQUNOLENBQUM7SUFFTSxNQUFNLENBQUMsUUFBUSxDQUFDLElBQVM7UUFDNUIsT0FBTyxRQUFRLENBQUMsTUFBTSxDQUFDO1lBQ25CLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtZQUNmLFdBQVcsRUFBRSxJQUFJLENBQUMsV0FBVztZQUM3QixPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU8sSUFBSSxFQUFFO1lBQzNCLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUSxJQUFJLEVBQUU7WUFDN0IsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLEtBQUssS0FBSztZQUM3QixTQUFTLEVBQUUsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDakQsU0FBUyxFQUFFLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1NBQ3BELEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0lBQ2hCLENBQUM7Q0FDSjtBQXZTRCw0QkF1U0MiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2RvbWFpbi9lbnRpdGllcy9FeG9Gb2N1cy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFbnRpdHkgfSBmcm9tICcuLi9jb3JlL0VudGl0eSc7XG5pbXBvcnQgeyBSZXN1bHQgfSBmcm9tICcuLi9jb3JlL1Jlc3VsdCc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXhvRm9jdXNQcm9wcyB7XG4gICAgbmFtZTogc3RyaW5nO1xuICAgIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuICAgIGZpbHRlcnM6IEZvY3VzRmlsdGVyW107XG4gICAgcHJpb3JpdHk6IG51bWJlcjtcbiAgICBhY3RpdmU6IGJvb2xlYW47XG4gICAgY3JlYXRlZEF0OiBEYXRlO1xuICAgIHVwZGF0ZWRBdDogRGF0ZTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBGb2N1c0ZpbHRlciB7XG4gICAgdHlwZTogJ2NsYXNzJyB8ICd0YWcnIHwgJ3Byb3BlcnR5JyB8ICd0aW1lZnJhbWUnIHwgJ3JlbGF0aW9uJztcbiAgICBvcGVyYXRvcjogJ2luY2x1ZGVzJyB8ICdleGNsdWRlcycgfCAnZXF1YWxzJyB8ICdjb250YWlucycgfCAnYmVmb3JlJyB8ICdhZnRlcicgfCAnYmV0d2Vlbic7XG4gICAgdmFsdWU6IGFueTtcbiAgICBwcm9wZXJ0eT86IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIEV4b0ZvY3VzIGV4dGVuZHMgRW50aXR5PEV4b0ZvY3VzUHJvcHM+IHtcbiAgICBwcml2YXRlIF9mb2N1c0lkOiBzdHJpbmc7XG4gICAgXG4gICAgcHJpdmF0ZSBjb25zdHJ1Y3Rvcihwcm9wczogRXhvRm9jdXNQcm9wcywgaWQ/OiBzdHJpbmcpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuICAgICAgICB0aGlzLl9mb2N1c0lkID0gaWQgfHwgdGhpcy5nZW5lcmF0ZUlkKCk7XG4gICAgfVxuICAgIFxuICAgIHByaXZhdGUgZ2VuZXJhdGVJZCgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gJ2ZvY3VzLScgKyBEYXRlLm5vdygpICsgJy0nICsgTWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyaW5nKDIsIDkpO1xuICAgIH1cbiAgICBcbiAgICBnZXQgaWQoKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2ZvY3VzSWQ7XG4gICAgfVxuICAgIFxuICAgIHB1YmxpYyBzdGF0aWMgY3JlYXRlKHByb3BzOiBFeG9Gb2N1c1Byb3BzLCBpZD86IHN0cmluZyk6IFJlc3VsdDxFeG9Gb2N1cz4ge1xuICAgICAgICBpZiAoIXByb3BzLm5hbWUgfHwgcHJvcHMubmFtZS50cmltKCkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8RXhvRm9jdXM+KCdGb2N1cyBuYW1lIGlzIHJlcXVpcmVkJyk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmIChwcm9wcy5wcmlvcml0eSA8IDAgfHwgcHJvcHMucHJpb3JpdHkgPiAxMDApIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxFeG9Gb2N1cz4oJ1ByaW9yaXR5IG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMDAnKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5vazxFeG9Gb2N1cz4obmV3IEV4b0ZvY3VzKHByb3BzLCBpZCkpO1xuICAgIH1cbiAgICBcbiAgICBnZXQgbmFtZSgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy5uYW1lO1xuICAgIH1cbiAgICBcbiAgICBnZXQgZGVzY3JpcHRpb24oKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvcHMuZGVzY3JpcHRpb247XG4gICAgfVxuICAgIFxuICAgIGdldCBmaWx0ZXJzKCk6IEZvY3VzRmlsdGVyW10ge1xuICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy5maWx0ZXJzO1xuICAgIH1cbiAgICBcbiAgICBnZXQgcHJpb3JpdHkoKTogbnVtYmVyIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvcHMucHJpb3JpdHk7XG4gICAgfVxuICAgIFxuICAgIGdldCBhY3RpdmUoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLnByb3BzLmFjdGl2ZTtcbiAgICB9XG4gICAgXG4gICAgZ2V0IGNyZWF0ZWRBdCgpOiBEYXRlIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvcHMuY3JlYXRlZEF0O1xuICAgIH1cbiAgICBcbiAgICBnZXQgdXBkYXRlZEF0KCk6IERhdGUge1xuICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy51cGRhdGVkQXQ7XG4gICAgfVxuICAgIFxuICAgIHB1YmxpYyBhZGRGaWx0ZXIoZmlsdGVyOiBGb2N1c0ZpbHRlcik6IFJlc3VsdDx2b2lkPiB7XG4gICAgICAgIGlmICghdGhpcy5pc1ZhbGlkRmlsdGVyKGZpbHRlcikpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDx2b2lkPignSW52YWxpZCBmaWx0ZXIgY29uZmlndXJhdGlvbicpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICB0aGlzLnByb3BzLmZpbHRlcnMucHVzaChmaWx0ZXIpO1xuICAgICAgICB0aGlzLnByb3BzLnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCk7XG4gICAgICAgIHJldHVybiBSZXN1bHQub2s8dm9pZD4oKTtcbiAgICB9XG4gICAgXG4gICAgcHVibGljIHJlbW92ZUZpbHRlcihpbmRleDogbnVtYmVyKTogUmVzdWx0PHZvaWQ+IHtcbiAgICAgICAgaWYgKGluZGV4IDwgMCB8fCBpbmRleCA+PSB0aGlzLnByb3BzLmZpbHRlcnMubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8dm9pZD4oJ0ludmFsaWQgZmlsdGVyIGluZGV4Jyk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHRoaXMucHJvcHMuZmlsdGVycy5zcGxpY2UoaW5kZXgsIDEpO1xuICAgICAgICB0aGlzLnByb3BzLnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCk7XG4gICAgICAgIHJldHVybiBSZXN1bHQub2s8dm9pZD4oKTtcbiAgICB9XG4gICAgXG4gICAgcHVibGljIGFjdGl2YXRlKCk6IHZvaWQge1xuICAgICAgICB0aGlzLnByb3BzLmFjdGl2ZSA9IHRydWU7XG4gICAgICAgIHRoaXMucHJvcHMudXBkYXRlZEF0ID0gbmV3IERhdGUoKTtcbiAgICB9XG4gICAgXG4gICAgcHVibGljIGRlYWN0aXZhdGUoKTogdm9pZCB7XG4gICAgICAgIHRoaXMucHJvcHMuYWN0aXZlID0gZmFsc2U7XG4gICAgICAgIHRoaXMucHJvcHMudXBkYXRlZEF0ID0gbmV3IERhdGUoKTtcbiAgICB9XG4gICAgXG4gICAgcHVibGljIHVwZGF0ZVByaW9yaXR5KHByaW9yaXR5OiBudW1iZXIpOiBSZXN1bHQ8dm9pZD4ge1xuICAgICAgICBpZiAocHJpb3JpdHkgPCAwIHx8IHByaW9yaXR5ID4gMTAwKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8dm9pZD4oJ1ByaW9yaXR5IG11c3QgYmUgYmV0d2VlbiAwIGFuZCAxMDAnKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgdGhpcy5wcm9wcy5wcmlvcml0eSA9IHByaW9yaXR5O1xuICAgICAgICB0aGlzLnByb3BzLnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCk7XG4gICAgICAgIHJldHVybiBSZXN1bHQub2s8dm9pZD4oKTtcbiAgICB9XG4gICAgXG4gICAgcHVibGljIG1hdGNoZXNBc3NldChhc3NldDogYW55KTogYm9vbGVhbiB7XG4gICAgICAgIGlmICghdGhpcy5wcm9wcy5hY3RpdmUpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBmb3IgKGNvbnN0IGZpbHRlciBvZiB0aGlzLnByb3BzLmZpbHRlcnMpIHtcbiAgICAgICAgICAgIGlmICghdGhpcy5ldmFsdWF0ZUZpbHRlcihmaWx0ZXIsIGFzc2V0KSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIFxuICAgIHB1YmxpYyBtYXRjaGVzVHJpcGxlKHRyaXBsZTogeyBzdWJqZWN0OiBzdHJpbmc7IHByZWRpY2F0ZTogc3RyaW5nOyBvYmplY3Q6IHN0cmluZyB9KTogYm9vbGVhbiB7XG4gICAgICAgIGlmICghdGhpcy5wcm9wcy5hY3RpdmUpIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBmb3IgKGNvbnN0IGZpbHRlciBvZiB0aGlzLnByb3BzLmZpbHRlcnMpIHtcbiAgICAgICAgICAgIGlmIChmaWx0ZXIudHlwZSA9PT0gJ3Byb3BlcnR5JyAmJiBmaWx0ZXIucHJvcGVydHkpIHtcbiAgICAgICAgICAgICAgICBpZiAoZmlsdGVyLnByb3BlcnR5ICE9PSB0cmlwbGUucHJlZGljYXRlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuZXZhbHVhdGVWYWx1ZShmaWx0ZXIub3BlcmF0b3IsIHRyaXBsZS5vYmplY3QsIGZpbHRlci52YWx1ZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIFxuICAgIHByaXZhdGUgaXNWYWxpZEZpbHRlcihmaWx0ZXI6IEZvY3VzRmlsdGVyKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IHZhbGlkVHlwZXMgPSBbJ2NsYXNzJywgJ3RhZycsICdwcm9wZXJ0eScsICd0aW1lZnJhbWUnLCAncmVsYXRpb24nXTtcbiAgICAgICAgY29uc3QgdmFsaWRPcGVyYXRvcnMgPSBbJ2luY2x1ZGVzJywgJ2V4Y2x1ZGVzJywgJ2VxdWFscycsICdjb250YWlucycsICdiZWZvcmUnLCAnYWZ0ZXInLCAnYmV0d2VlbiddO1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHZhbGlkVHlwZXMuaW5jbHVkZXMoZmlsdGVyLnR5cGUpICYmIHZhbGlkT3BlcmF0b3JzLmluY2x1ZGVzKGZpbHRlci5vcGVyYXRvcik7XG4gICAgfVxuICAgIFxuICAgIHByaXZhdGUgZXZhbHVhdGVGaWx0ZXIoZmlsdGVyOiBGb2N1c0ZpbHRlciwgYXNzZXQ6IGFueSk6IGJvb2xlYW4ge1xuICAgICAgICBzd2l0Y2ggKGZpbHRlci50eXBlKSB7XG4gICAgICAgICAgICBjYXNlICdjbGFzcyc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXZhbHVhdGVDbGFzc0ZpbHRlcihmaWx0ZXIsIGFzc2V0KTtcbiAgICAgICAgICAgIGNhc2UgJ3RhZyc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXZhbHVhdGVUYWdGaWx0ZXIoZmlsdGVyLCBhc3NldCk7XG4gICAgICAgICAgICBjYXNlICdwcm9wZXJ0eSc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXZhbHVhdGVQcm9wZXJ0eUZpbHRlcihmaWx0ZXIsIGFzc2V0KTtcbiAgICAgICAgICAgIGNhc2UgJ3RpbWVmcmFtZSc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXZhbHVhdGVUaW1lZnJhbWVGaWx0ZXIoZmlsdGVyLCBhc3NldCk7XG4gICAgICAgICAgICBjYXNlICdyZWxhdGlvbic6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZXZhbHVhdGVSZWxhdGlvbkZpbHRlcihmaWx0ZXIsIGFzc2V0KTtcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgcHJpdmF0ZSBldmFsdWF0ZUNsYXNzRmlsdGVyKGZpbHRlcjogRm9jdXNGaWx0ZXIsIGFzc2V0OiBhbnkpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgYXNzZXRDbGFzcyA9IGFzc2V0WydleG9fX0luc3RhbmNlX2NsYXNzJ10gfHwgYXNzZXQuY2xhc3M7XG4gICAgICAgIGlmICghYXNzZXRDbGFzcykgcmV0dXJuIGZhbHNlO1xuICAgICAgICBcbiAgICAgICAgY29uc3QgY2xhc3NOYW1lID0gYXNzZXRDbGFzcy5yZXBsYWNlKC9cXFtcXFt8XFxdXFxdL2csICcnKTtcbiAgICAgICAgXG4gICAgICAgIHN3aXRjaCAoZmlsdGVyLm9wZXJhdG9yKSB7XG4gICAgICAgICAgICBjYXNlICdlcXVhbHMnOlxuICAgICAgICAgICAgICAgIHJldHVybiBjbGFzc05hbWUgPT09IGZpbHRlci52YWx1ZTtcbiAgICAgICAgICAgIGNhc2UgJ2luY2x1ZGVzJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheShmaWx0ZXIudmFsdWUpID8gZmlsdGVyLnZhbHVlLmluY2x1ZGVzKGNsYXNzTmFtZSkgOiBjbGFzc05hbWUgPT09IGZpbHRlci52YWx1ZTtcbiAgICAgICAgICAgIGNhc2UgJ2V4Y2x1ZGVzJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheShmaWx0ZXIudmFsdWUpID8gIWZpbHRlci52YWx1ZS5pbmNsdWRlcyhjbGFzc05hbWUpIDogY2xhc3NOYW1lICE9PSBmaWx0ZXIudmFsdWU7XG4gICAgICAgICAgICBjYXNlICdjb250YWlucyc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNsYXNzTmFtZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKFN0cmluZyhmaWx0ZXIudmFsdWUpLnRvTG93ZXJDYXNlKCkpO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBcbiAgICBwcml2YXRlIGV2YWx1YXRlVGFnRmlsdGVyKGZpbHRlcjogRm9jdXNGaWx0ZXIsIGFzc2V0OiBhbnkpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgdGFncyA9IGFzc2V0LnRhZ3MgfHwgYXNzZXRbJ2V4b19fQXNzZXRfdGFncyddIHx8IFtdO1xuICAgICAgICBjb25zdCB0YWdBcnJheSA9IEFycmF5LmlzQXJyYXkodGFncykgPyB0YWdzIDogW3RhZ3NdO1xuICAgICAgICBcbiAgICAgICAgc3dpdGNoIChmaWx0ZXIub3BlcmF0b3IpIHtcbiAgICAgICAgICAgIGNhc2UgJ2luY2x1ZGVzJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gdGFnQXJyYXkuc29tZSh0YWcgPT4gdGFnID09PSBmaWx0ZXIudmFsdWUgfHwgXG4gICAgICAgICAgICAgICAgICAgIChBcnJheS5pc0FycmF5KGZpbHRlci52YWx1ZSkgJiYgZmlsdGVyLnZhbHVlLmluY2x1ZGVzKHRhZykpKTtcbiAgICAgICAgICAgIGNhc2UgJ2V4Y2x1ZGVzJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gIXRhZ0FycmF5LnNvbWUodGFnID0+IHRhZyA9PT0gZmlsdGVyLnZhbHVlIHx8IFxuICAgICAgICAgICAgICAgICAgICAoQXJyYXkuaXNBcnJheShmaWx0ZXIudmFsdWUpICYmIGZpbHRlci52YWx1ZS5pbmNsdWRlcyh0YWcpKSk7XG4gICAgICAgICAgICBjYXNlICdjb250YWlucyc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRhZ0FycmF5LnNvbWUodGFnID0+IFxuICAgICAgICAgICAgICAgICAgICB0YWcudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhTdHJpbmcoZmlsdGVyLnZhbHVlKS50b0xvd2VyQ2FzZSgpKSk7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuICAgIFxuICAgIHByaXZhdGUgZXZhbHVhdGVQcm9wZXJ0eUZpbHRlcihmaWx0ZXI6IEZvY3VzRmlsdGVyLCBhc3NldDogYW55KTogYm9vbGVhbiB7XG4gICAgICAgIGlmICghZmlsdGVyLnByb3BlcnR5KSByZXR1cm4gdHJ1ZTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHZhbHVlID0gYXNzZXRbZmlsdGVyLnByb3BlcnR5XTtcbiAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiBmaWx0ZXIub3BlcmF0b3IgPT09ICdleGNsdWRlcyc7XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gdGhpcy5ldmFsdWF0ZVZhbHVlKGZpbHRlci5vcGVyYXRvciwgdmFsdWUsIGZpbHRlci52YWx1ZSk7XG4gICAgfVxuICAgIFxuICAgIHByaXZhdGUgZXZhbHVhdGVUaW1lZnJhbWVGaWx0ZXIoZmlsdGVyOiBGb2N1c0ZpbHRlciwgYXNzZXQ6IGFueSk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCBkYXRlUHJvcGVydGllcyA9IFtcbiAgICAgICAgICAgICdleG9fX0Fzc2V0X2NyZWF0ZWRBdCcsXG4gICAgICAgICAgICAnZXhvX19Bc3NldF91cGRhdGVkQXQnLFxuICAgICAgICAgICAgJ2Vtc19fVGFza19kdWVEYXRlJyxcbiAgICAgICAgICAgICdlbXNfX0V2ZW50X2RhdGUnXG4gICAgICAgIF07XG4gICAgICAgIFxuICAgICAgICBmb3IgKGNvbnN0IHByb3Agb2YgZGF0ZVByb3BlcnRpZXMpIHtcbiAgICAgICAgICAgIGNvbnN0IGRhdGVWYWx1ZSA9IGFzc2V0W3Byb3BdO1xuICAgICAgICAgICAgaWYgKGRhdGVWYWx1ZSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZShkYXRlVmFsdWUpO1xuICAgICAgICAgICAgICAgIGlmICghaXNOYU4oZGF0ZS5nZXRUaW1lKCkpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmV2YWx1YXRlRGF0ZVZhbHVlKGZpbHRlci5vcGVyYXRvciwgZGF0ZSwgZmlsdGVyLnZhbHVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHJldHVybiBmaWx0ZXIub3BlcmF0b3IgPT09ICdleGNsdWRlcyc7XG4gICAgfVxuICAgIFxuICAgIHByaXZhdGUgZXZhbHVhdGVSZWxhdGlvbkZpbHRlcihmaWx0ZXI6IEZvY3VzRmlsdGVyLCBhc3NldDogYW55KTogYm9vbGVhbiB7XG4gICAgICAgIC8vIFRoaXMgd291bGQgbmVlZCBhY2Nlc3MgdG8gdGhlIGdyYXBoIHRvIGV2YWx1YXRlIHJlbGF0aW9uc1xuICAgICAgICAvLyBGb3Igbm93LCByZXR1cm4gdHJ1ZVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgXG4gICAgcHJpdmF0ZSBldmFsdWF0ZVZhbHVlKG9wZXJhdG9yOiBzdHJpbmcsIGFjdHVhbFZhbHVlOiBhbnksIGZpbHRlclZhbHVlOiBhbnkpOiBib29sZWFuIHtcbiAgICAgICAgc3dpdGNoIChvcGVyYXRvcikge1xuICAgICAgICAgICAgY2FzZSAnZXF1YWxzJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gYWN0dWFsVmFsdWUgPT09IGZpbHRlclZhbHVlO1xuICAgICAgICAgICAgY2FzZSAnaW5jbHVkZXMnOlxuICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGFjdHVhbFZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYWN0dWFsVmFsdWUuaW5jbHVkZXMoZmlsdGVyVmFsdWUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gYWN0dWFsVmFsdWUgPT09IGZpbHRlclZhbHVlO1xuICAgICAgICAgICAgY2FzZSAnZXhjbHVkZXMnOlxuICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGFjdHVhbFZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gIWFjdHVhbFZhbHVlLmluY2x1ZGVzKGZpbHRlclZhbHVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGFjdHVhbFZhbHVlICE9PSBmaWx0ZXJWYWx1ZTtcbiAgICAgICAgICAgIGNhc2UgJ2NvbnRhaW5zJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKGFjdHVhbFZhbHVlKS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKFN0cmluZyhmaWx0ZXJWYWx1ZSkudG9Mb3dlckNhc2UoKSk7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG4gICAgfVxuICAgIFxuICAgIHByaXZhdGUgZXZhbHVhdGVEYXRlVmFsdWUob3BlcmF0b3I6IHN0cmluZywgZGF0ZTogRGF0ZSwgZmlsdGVyVmFsdWU6IGFueSk6IGJvb2xlYW4ge1xuICAgICAgICBzd2l0Y2ggKG9wZXJhdG9yKSB7XG4gICAgICAgICAgICBjYXNlICdiZWZvcmUnOlxuICAgICAgICAgICAgICAgIHJldHVybiBkYXRlIDwgbmV3IERhdGUoZmlsdGVyVmFsdWUpO1xuICAgICAgICAgICAgY2FzZSAnYWZ0ZXInOlxuICAgICAgICAgICAgICAgIHJldHVybiBkYXRlID4gbmV3IERhdGUoZmlsdGVyVmFsdWUpO1xuICAgICAgICAgICAgY2FzZSAnYmV0d2Vlbic6XG4gICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZmlsdGVyVmFsdWUpICYmIGZpbHRlclZhbHVlLmxlbmd0aCA9PT0gMikge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGFydCA9IG5ldyBEYXRlKGZpbHRlclZhbHVlWzBdKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZW5kID0gbmV3IERhdGUoZmlsdGVyVmFsdWVbMV0pO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0ZSA+PSBzdGFydCAmJiBkYXRlIDw9IGVuZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgY2FzZSAnZXF1YWxzJzpcbiAgICAgICAgICAgICAgICBjb25zdCBmaWx0ZXJEYXRlID0gbmV3IERhdGUoZmlsdGVyVmFsdWUpO1xuICAgICAgICAgICAgICAgIHJldHVybiBkYXRlLnRvRGF0ZVN0cmluZygpID09PSBmaWx0ZXJEYXRlLnRvRGF0ZVN0cmluZygpO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBcbiAgICBwdWJsaWMgdG9KU09OKCk6IGFueSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBpZDogdGhpcy5pZCxcbiAgICAgICAgICAgIG5hbWU6IHRoaXMucHJvcHMubmFtZSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uOiB0aGlzLnByb3BzLmRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgZmlsdGVyczogdGhpcy5wcm9wcy5maWx0ZXJzLFxuICAgICAgICAgICAgcHJpb3JpdHk6IHRoaXMucHJvcHMucHJpb3JpdHksXG4gICAgICAgICAgICBhY3RpdmU6IHRoaXMucHJvcHMuYWN0aXZlLFxuICAgICAgICAgICAgY3JlYXRlZEF0OiB0aGlzLnByb3BzLmNyZWF0ZWRBdC50b0lTT1N0cmluZygpLFxuICAgICAgICAgICAgdXBkYXRlZEF0OiB0aGlzLnByb3BzLnVwZGF0ZWRBdC50b0lTT1N0cmluZygpXG4gICAgICAgIH07XG4gICAgfVxuICAgIFxuICAgIHB1YmxpYyBzdGF0aWMgZnJvbUpTT04oanNvbjogYW55KTogUmVzdWx0PEV4b0ZvY3VzPiB7XG4gICAgICAgIHJldHVybiBFeG9Gb2N1cy5jcmVhdGUoe1xuICAgICAgICAgICAgbmFtZToganNvbi5uYW1lLFxuICAgICAgICAgICAgZGVzY3JpcHRpb246IGpzb24uZGVzY3JpcHRpb24sXG4gICAgICAgICAgICBmaWx0ZXJzOiBqc29uLmZpbHRlcnMgfHwgW10sXG4gICAgICAgICAgICBwcmlvcml0eToganNvbi5wcmlvcml0eSB8fCA1MCxcbiAgICAgICAgICAgIGFjdGl2ZToganNvbi5hY3RpdmUgIT09IGZhbHNlLFxuICAgICAgICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZShqc29uLmNyZWF0ZWRBdCB8fCBEYXRlLm5vdygpKSxcbiAgICAgICAgICAgIHVwZGF0ZWRBdDogbmV3IERhdGUoanNvbi51cGRhdGVkQXQgfHwgRGF0ZS5ub3coKSlcbiAgICAgICAgfSwganNvbi5pZCk7XG4gICAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==