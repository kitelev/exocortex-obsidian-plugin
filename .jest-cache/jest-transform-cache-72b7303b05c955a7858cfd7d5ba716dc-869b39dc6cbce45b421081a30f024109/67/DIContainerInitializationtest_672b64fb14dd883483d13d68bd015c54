7060693b958ca28ee2c50be9f3554e6f
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const DIContainer_1 = require("../../src/infrastructure/container/DIContainer");
describe('DIContainer Initialization', () => {
    let mockApp;
    beforeEach(() => {
        // Reset the singleton instance for clean tests
        DIContainer_1.DIContainer.reset();
        // Create mock app
        mockApp = {
            vault: {
                getMarkdownFiles: jest.fn().mockReturnValue([]),
                getFiles: jest.fn().mockReturnValue([]),
                getAbstractFileByPath: jest.fn(),
                read: jest.fn().mockResolvedValue(''),
                modify: jest.fn().mockResolvedValue(undefined),
                create: jest.fn().mockResolvedValue({}),
                delete: jest.fn().mockResolvedValue(undefined),
                rename: jest.fn().mockResolvedValue(undefined)
            },
            workspace: {
                getActiveFile: jest.fn(),
                openLinkText: jest.fn()
            },
            metadataCache: {
                getFileCache: jest.fn()
            }
        };
    });
    afterEach(() => {
        // Clean up singleton
        DIContainer_1.DIContainer.instance = undefined;
    });
    describe('Singleton Pattern', () => {
        it('should throw error when getInstance is called before initialize', () => {
            expect(() => {
                DIContainer_1.DIContainer.getInstance();
            }).toThrow('DIContainer not initialized. Call initialize(app) first.');
        });
        it('should initialize correctly with app parameter', () => {
            const container = DIContainer_1.DIContainer.initialize(mockApp);
            expect(container).toBeDefined();
            expect(container).toBeInstanceOf(DIContainer_1.DIContainer);
        });
        it('should return same instance on multiple initialize calls', () => {
            const container1 = DIContainer_1.DIContainer.initialize(mockApp);
            const container2 = DIContainer_1.DIContainer.initialize(mockApp);
            expect(container1).toBe(container2);
        });
        it('should return same instance via getInstance after initialization', () => {
            const container1 = DIContainer_1.DIContainer.initialize(mockApp);
            const container2 = DIContainer_1.DIContainer.getInstance();
            expect(container1).toBe(container2);
        });
        it('should accept plugin parameter in initialize', () => {
            const mockPlugin = { name: 'test-plugin' };
            const container = DIContainer_1.DIContainer.initialize(mockApp, mockPlugin);
            expect(container).toBeDefined();
            expect(container.plugin).toBe(mockPlugin);
        });
    });
    describe('Dependency Resolution', () => {
        it('should resolve CreateAssetUseCase after initialization', () => {
            const container = DIContainer_1.DIContainer.initialize(mockApp);
            const useCase = container.getCreateAssetUseCase();
            expect(useCase).toBeDefined();
            expect(useCase.constructor.name).toBe('CreateAssetUseCase');
        });
        it('should resolve PropertyEditingUseCase after initialization', () => {
            const container = DIContainer_1.DIContainer.initialize(mockApp);
            const useCase = container.getPropertyEditingUseCase();
            expect(useCase).toBeDefined();
            expect(useCase.constructor.name).toBe('PropertyEditingUseCase');
        });
        it('should resolve repositories after initialization', () => {
            const container = DIContainer_1.DIContainer.initialize(mockApp);
            const assetRepo = container.resolve('IAssetRepository');
            const ontologyRepo = container.resolve('IOntologyRepository');
            expect(assetRepo).toBeDefined();
            expect(ontologyRepo).toBeDefined();
        });
    });
    describe('Async Initialize Method', () => {
        it('should support async initialize for backward compatibility', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const container = DIContainer_1.DIContainer.initialize(mockApp);
            // Should not throw and should resolve
            yield expect(container.initialize(mockApp)).resolves.toBeUndefined();
        }));
    });
    describe('Plugin Integration', () => {
        it('should work correctly in plugin onload lifecycle', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            // Simulate plugin onload
            class TestPlugin {
                constructor() {
                    this.app = mockApp;
                }
                onload() {
                    return tslib_1.__awaiter(this, void 0, void 0, function* () {
                        // This is how it's used in main.ts
                        this.container = DIContainer_1.DIContainer.initialize(this.app, this);
                        // Should be able to get use cases
                        const createAsset = this.container.getCreateAssetUseCase();
                        expect(createAsset).toBeDefined();
                    });
                }
            }
            const plugin = new TestPlugin();
            yield plugin.onload();
            expect(plugin.container).toBeDefined();
        }));
        it('should prevent initialization errors in production usage', () => {
            // Test the exact sequence that happens in the plugin
            const mockPlugin = {
                app: mockApp,
                addCommand: jest.fn(),
                addRibbonIcon: jest.fn()
            };
            // Initialize container as in main.ts
            const container = DIContainer_1.DIContainer.initialize(mockPlugin.app, mockPlugin);
            // Should be able to use getInstance after initialize
            const sameContainer = DIContainer_1.DIContainer.getInstance();
            expect(sameContainer).toBe(container);
            // Should be able to get use cases for modal
            const createAssetUseCase = container.getCreateAssetUseCase();
            expect(createAssetUseCase).toBeDefined();
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vdGVzdHMvaW50ZWdyYXRpb24vRElDb250YWluZXJJbml0aWFsaXphdGlvbi50ZXN0LnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLGdGQUE2RTtBQUc3RSxRQUFRLENBQUMsNEJBQTRCLEVBQUUsR0FBRyxFQUFFO0lBQ3hDLElBQUksT0FBWSxDQUFDO0lBRWpCLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDWiwrQ0FBK0M7UUFDL0MseUJBQVcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUVwQixrQkFBa0I7UUFDbEIsT0FBTyxHQUFHO1lBQ04sS0FBSyxFQUFFO2dCQUNILGdCQUFnQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxlQUFlLENBQUMsRUFBRSxDQUFDO2dCQUMvQyxRQUFRLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQyxFQUFFLENBQUM7Z0JBQ3ZDLHFCQUFxQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7Z0JBQ2hDLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDO2dCQUNyQyxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQztnQkFDOUMsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUM7Z0JBQ3ZDLE1BQU0sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDO2dCQUM5QyxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQzthQUNqRDtZQUNELFNBQVMsRUFBRTtnQkFDUCxhQUFhLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtnQkFDeEIsWUFBWSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7YUFDMUI7WUFD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Q0FBQyxrQkFBa0IsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQzdDLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQyxDQUFDLENBQUM7QUFDUCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva2l0ZWxldi9Eb2N1bWVudHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi90ZXN0cy9pbnRlZ3JhdGlvbi9ESUNvbnRhaW5lckluaXRpYWxpemF0aW9uLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRElDb250YWluZXIgfSBmcm9tICcuLi8uLi9zcmMvaW5mcmFzdHJ1Y3R1cmUvY29udGFpbmVyL0RJQ29udGFpbmVyJztcbmltcG9ydCB7IEFwcCB9IGZyb20gJ29ic2lkaWFuJztcblxuZGVzY3JpYmUoJ0RJQ29udGFpbmVyIEluaXRpYWxpemF0aW9uJywgKCkgPT4ge1xuICAgIGxldCBtb2NrQXBwOiBBcHA7XG4gICAgXG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICAgIC8vIFJlc2V0IHRoZSBzaW5nbGV0b24gaW5zdGFuY2UgZm9yIGNsZWFuIHRlc3RzXG4gICAgICAgIERJQ29udGFpbmVyLnJlc2V0KCk7XG4gICAgICAgIFxuICAgICAgICAvLyBDcmVhdGUgbW9jayBhcHBcbiAgICAgICAgbW9ja0FwcCA9IHtcbiAgICAgICAgICAgIHZhdWx0OiB7XG4gICAgICAgICAgICAgICAgZ2V0TWFya2Rvd25GaWxlczogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZShbXSksXG4gICAgICAgICAgICAgICAgZ2V0RmlsZXM6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoW10pLFxuICAgICAgICAgICAgICAgIGdldEFic3RyYWN0RmlsZUJ5UGF0aDogamVzdC5mbigpLFxuICAgICAgICAgICAgICAgIHJlYWQ6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSgnJyksXG4gICAgICAgICAgICAgICAgbW9kaWZ5OiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKSxcbiAgICAgICAgICAgICAgICBjcmVhdGU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh7fSksXG4gICAgICAgICAgICAgICAgZGVsZXRlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKSxcbiAgICAgICAgICAgICAgICByZW5hbWU6IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgd29ya3NwYWNlOiB7XG4gICAgICAgICAgICAgICAgZ2V0QWN0aXZlRmlsZTogamVzdC5mbigpLFxuICAgICAgICAgICAgICAgIG9wZW5MaW5rVGV4dDogamVzdC5mbigpXG4gICAgICAgICAgICB9LFxuICAgICAgICAgICAgbWV0YWRhdGFDYWNoZToge1xuICAgICAgICAgICAgICAgIGdldEZpbGVDYWNoZTogamVzdC5mbigpXG4gICAgICAgICAgICB9XG4gICAgICAgIH0gYXMgYW55O1xuICAgIH0pO1xuICAgIFxuICAgIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgICAgIC8vIENsZWFuIHVwIHNpbmdsZXRvblxuICAgICAgICAoRElDb250YWluZXIgYXMgYW55KS5pbnN0YW5jZSA9IHVuZGVmaW5lZDtcbiAgICB9KTtcbiAgICBcbiAgICBkZXNjcmliZSgnU2luZ2xldG9uIFBhdHRlcm4nLCAoKSA9PiB7XG4gICAgICAgIGl0KCdzaG91bGQgdGhyb3cgZXJyb3Igd2hlbiBnZXRJbnN0YW5jZSBpcyBjYWxsZWQgYmVmb3JlIGluaXRpYWxpemUnLCAoKSA9PiB7XG4gICAgICAgICAgICBleHBlY3QoKCkgPT4ge1xuICAgICAgICAgICAgICAgIERJQ29udGFpbmVyLmdldEluc3RhbmNlKCk7XG4gICAgICAgICAgICB9KS50b1Rocm93KCdESUNvbnRhaW5lciBub3QgaW5pdGlhbGl6ZWQuIENhbGwgaW5pdGlhbGl6ZShhcHApIGZpcnN0LicpO1xuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSBjb3JyZWN0bHkgd2l0aCBhcHAgcGFyYW1ldGVyJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gRElDb250YWluZXIuaW5pdGlhbGl6ZShtb2NrQXBwKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZXhwZWN0KGNvbnRhaW5lcikudG9CZURlZmluZWQoKTtcbiAgICAgICAgICAgIGV4cGVjdChjb250YWluZXIpLnRvQmVJbnN0YW5jZU9mKERJQ29udGFpbmVyKTtcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICBpdCgnc2hvdWxkIHJldHVybiBzYW1lIGluc3RhbmNlIG9uIG11bHRpcGxlIGluaXRpYWxpemUgY2FsbHMnLCAoKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjb250YWluZXIxID0gRElDb250YWluZXIuaW5pdGlhbGl6ZShtb2NrQXBwKTtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lcjIgPSBESUNvbnRhaW5lci5pbml0aWFsaXplKG1vY2tBcHApO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBleHBlY3QoY29udGFpbmVyMSkudG9CZShjb250YWluZXIyKTtcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICBpdCgnc2hvdWxkIHJldHVybiBzYW1lIGluc3RhbmNlIHZpYSBnZXRJbnN0YW5jZSBhZnRlciBpbml0aWFsaXphdGlvbicsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lcjEgPSBESUNvbnRhaW5lci5pbml0aWFsaXplKG1vY2tBcHApO1xuICAgICAgICAgICAgY29uc3QgY29udGFpbmVyMiA9IERJQ29udGFpbmVyLmdldEluc3RhbmNlKCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGV4cGVjdChjb250YWluZXIxKS50b0JlKGNvbnRhaW5lcjIpO1xuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIGl0KCdzaG91bGQgYWNjZXB0IHBsdWdpbiBwYXJhbWV0ZXIgaW4gaW5pdGlhbGl6ZScsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG1vY2tQbHVnaW4gPSB7IG5hbWU6ICd0ZXN0LXBsdWdpbicgfTtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IERJQ29udGFpbmVyLmluaXRpYWxpemUobW9ja0FwcCwgbW9ja1BsdWdpbik7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGV4cGVjdChjb250YWluZXIpLnRvQmVEZWZpbmVkKCk7XG4gICAgICAgICAgICBleHBlY3QoKGNvbnRhaW5lciBhcyBhbnkpLnBsdWdpbikudG9CZShtb2NrUGx1Z2luKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG4gICAgXG4gICAgZGVzY3JpYmUoJ0RlcGVuZGVuY3kgUmVzb2x1dGlvbicsICgpID0+IHtcbiAgICAgICAgaXQoJ3Nob3VsZCByZXNvbHZlIENyZWF0ZUFzc2V0VXNlQ2FzZSBhZnRlciBpbml0aWFsaXphdGlvbicsICgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IERJQ29udGFpbmVyLmluaXRpYWxpemUobW9ja0FwcCk7XG4gICAgICAgICAgICBjb25zdCB1c2VDYXNlID0gY29udGFpbmVyLmdldENyZWF0ZUFzc2V0VXNlQ2FzZSgpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBleHBlY3QodXNlQ2FzZSkudG9CZURlZmluZWQoKTtcbiAgICAgICAgICAgIGV4cGVjdCh1c2VDYXNlLmNvbnN0cnVjdG9yLm5hbWUpLnRvQmUoJ0NyZWF0ZUFzc2V0VXNlQ2FzZScpO1xuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIGl0KCdzaG91bGQgcmVzb2x2ZSBQcm9wZXJ0eUVkaXRpbmdVc2VDYXNlIGFmdGVyIGluaXRpYWxpemF0aW9uJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gRElDb250YWluZXIuaW5pdGlhbGl6ZShtb2NrQXBwKTtcbiAgICAgICAgICAgIGNvbnN0IHVzZUNhc2UgPSBjb250YWluZXIuZ2V0UHJvcGVydHlFZGl0aW5nVXNlQ2FzZSgpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBleHBlY3QodXNlQ2FzZSkudG9CZURlZmluZWQoKTtcbiAgICAgICAgICAgIGV4cGVjdCh1c2VDYXNlLmNvbnN0cnVjdG9yLm5hbWUpLnRvQmUoJ1Byb3BlcnR5RWRpdGluZ1VzZUNhc2UnKTtcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICBpdCgnc2hvdWxkIHJlc29sdmUgcmVwb3NpdG9yaWVzIGFmdGVyIGluaXRpYWxpemF0aW9uJywgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gRElDb250YWluZXIuaW5pdGlhbGl6ZShtb2NrQXBwKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3QgYXNzZXRSZXBvID0gY29udGFpbmVyLnJlc29sdmUoJ0lBc3NldFJlcG9zaXRvcnknKTtcbiAgICAgICAgICAgIGNvbnN0IG9udG9sb2d5UmVwbyA9IGNvbnRhaW5lci5yZXNvbHZlKCdJT250b2xvZ3lSZXBvc2l0b3J5Jyk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGV4cGVjdChhc3NldFJlcG8pLnRvQmVEZWZpbmVkKCk7XG4gICAgICAgICAgICBleHBlY3Qob250b2xvZ3lSZXBvKS50b0JlRGVmaW5lZCgpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgICBcbiAgICBkZXNjcmliZSgnQXN5bmMgSW5pdGlhbGl6ZSBNZXRob2QnLCAoKSA9PiB7XG4gICAgICAgIGl0KCdzaG91bGQgc3VwcG9ydCBhc3luYyBpbml0aWFsaXplIGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgY29uc3QgY29udGFpbmVyID0gRElDb250YWluZXIuaW5pdGlhbGl6ZShtb2NrQXBwKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gU2hvdWxkIG5vdCB0aHJvdyBhbmQgc2hvdWxkIHJlc29sdmVcbiAgICAgICAgICAgIGF3YWl0IGV4cGVjdChjb250YWluZXIuaW5pdGlhbGl6ZShtb2NrQXBwKSkucmVzb2x2ZXMudG9CZVVuZGVmaW5lZCgpO1xuICAgICAgICB9KTtcbiAgICB9KTtcbiAgICBcbiAgICBkZXNjcmliZSgnUGx1Z2luIEludGVncmF0aW9uJywgKCkgPT4ge1xuICAgICAgICBpdCgnc2hvdWxkIHdvcmsgY29ycmVjdGx5IGluIHBsdWdpbiBvbmxvYWQgbGlmZWN5Y2xlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgLy8gU2ltdWxhdGUgcGx1Z2luIG9ubG9hZFxuICAgICAgICAgICAgY2xhc3MgVGVzdFBsdWdpbiB7XG4gICAgICAgICAgICAgICAgYXBwOiBBcHAgPSBtb2NrQXBwO1xuICAgICAgICAgICAgICAgIGNvbnRhaW5lcj86IERJQ29udGFpbmVyO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGFzeW5jIG9ubG9hZCgpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8gVGhpcyBpcyBob3cgaXQncyB1c2VkIGluIG1haW4udHNcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jb250YWluZXIgPSBESUNvbnRhaW5lci5pbml0aWFsaXplKHRoaXMuYXBwLCB0aGlzKTtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIFNob3VsZCBiZSBhYmxlIHRvIGdldCB1c2UgY2FzZXNcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY3JlYXRlQXNzZXQgPSB0aGlzLmNvbnRhaW5lci5nZXRDcmVhdGVBc3NldFVzZUNhc2UoKTtcbiAgICAgICAgICAgICAgICAgICAgZXhwZWN0KGNyZWF0ZUFzc2V0KS50b0JlRGVmaW5lZCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3QgcGx1Z2luID0gbmV3IFRlc3RQbHVnaW4oKTtcbiAgICAgICAgICAgIGF3YWl0IHBsdWdpbi5vbmxvYWQoKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgZXhwZWN0KHBsdWdpbi5jb250YWluZXIpLnRvQmVEZWZpbmVkKCk7XG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgaXQoJ3Nob3VsZCBwcmV2ZW50IGluaXRpYWxpemF0aW9uIGVycm9ycyBpbiBwcm9kdWN0aW9uIHVzYWdlJywgKCkgPT4ge1xuICAgICAgICAgICAgLy8gVGVzdCB0aGUgZXhhY3Qgc2VxdWVuY2UgdGhhdCBoYXBwZW5zIGluIHRoZSBwbHVnaW5cbiAgICAgICAgICAgIGNvbnN0IG1vY2tQbHVnaW4gPSB7XG4gICAgICAgICAgICAgICAgYXBwOiBtb2NrQXBwLFxuICAgICAgICAgICAgICAgIGFkZENvbW1hbmQ6IGplc3QuZm4oKSxcbiAgICAgICAgICAgICAgICBhZGRSaWJib25JY29uOiBqZXN0LmZuKClcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIEluaXRpYWxpemUgY29udGFpbmVyIGFzIGluIG1haW4udHNcbiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IERJQ29udGFpbmVyLmluaXRpYWxpemUobW9ja1BsdWdpbi5hcHAsIG1vY2tQbHVnaW4pO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBTaG91bGQgYmUgYWJsZSB0byB1c2UgZ2V0SW5zdGFuY2UgYWZ0ZXIgaW5pdGlhbGl6ZVxuICAgICAgICAgICAgY29uc3Qgc2FtZUNvbnRhaW5lciA9IERJQ29udGFpbmVyLmdldEluc3RhbmNlKCk7XG4gICAgICAgICAgICBleHBlY3Qoc2FtZUNvbnRhaW5lcikudG9CZShjb250YWluZXIpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBTaG91bGQgYmUgYWJsZSB0byBnZXQgdXNlIGNhc2VzIGZvciBtb2RhbFxuICAgICAgICAgICAgY29uc3QgY3JlYXRlQXNzZXRVc2VDYXNlID0gY29udGFpbmVyLmdldENyZWF0ZUFzc2V0VXNlQ2FzZSgpO1xuICAgICAgICAgICAgZXhwZWN0KGNyZWF0ZUFzc2V0VXNlQ2FzZSkudG9CZURlZmluZWQoKTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG59KTsiXSwidmVyc2lvbiI6M30=