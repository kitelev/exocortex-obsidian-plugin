6563ced3134749747262b0c1c3d3b1ee
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DataviewQueryEngine = void 0;
const Result_1 = require("../../domain/core/Result");
/**
 * Dataview Query Engine Implementation
 * Adapts the Dataview plugin API to our generic query engine interface
 */
class DataviewQueryEngine {
    constructor(dataviewApi) {
        this.dataviewApi = dataviewApi;
    }
    getType() {
        return "dataview";
    }
    isAvailable() {
        return !!this.dataviewApi && typeof this.dataviewApi.pages === "function";
    }
    async executeQuery(query, context) {
        if (!this.isAvailable()) {
            return Result_1.Result.fail("Dataview is not available");
        }
        try {
            const result = await this.parseAndExecuteQuery(query, context);
            return Result_1.Result.ok(result);
        }
        catch (error) {
            return Result_1.Result.fail(`Dataview query error: ${error}`);
        }
    }
    async renderQuery(container, query, context) {
        if (!this.isAvailable()) {
            return Result_1.Result.fail("Dataview is not available");
        }
        try {
            await this.renderDataviewQuery(container, query, context);
            return Result_1.Result.ok();
        }
        catch (error) {
            return Result_1.Result.fail(`Dataview render error: ${error}`);
        }
    }
    async getPages(source) {
        if (!this.isAvailable()) {
            return Result_1.Result.fail("Dataview is not available");
        }
        try {
            const pages = this.dataviewApi.pages(source);
            return Result_1.Result.ok(pages ? Array.from(pages) : []);
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to get pages: ${error}`);
        }
    }
    async getPageMetadata(path) {
        if (!this.isAvailable()) {
            return Result_1.Result.fail("Dataview is not available");
        }
        try {
            const page = this.dataviewApi.page(path);
            return Result_1.Result.ok(page || {});
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to get page metadata: ${error}`);
        }
    }
    validateQuery(query) {
        if (!query || query.trim().length === 0) {
            return Result_1.Result.fail("Query cannot be empty");
        }
        // Basic validation for Dataview query syntax
        const trimmedQuery = query.trim().toLowerCase();
        const validStartKeywords = ["table", "list", "task", "calendar"];
        const hasValidStart = validStartKeywords.some((keyword) => trimmedQuery.startsWith(keyword));
        if (!hasValidStart && !trimmedQuery.includes("dv.")) {
            return Result_1.Result.fail("Query must start with table, list, task, calendar, or contain dv. calls");
        }
        return Result_1.Result.ok(true);
    }
    async parseAndExecuteQuery(query, context) {
        const queryLines = query.trim().split("\n");
        const firstLine = queryLines[0].toLowerCase();
        if (firstLine.startsWith("table")) {
            return await this.executeTableQuery(query, context);
        }
        else if (firstLine.startsWith("list")) {
            return await this.executeListQuery(query, context);
        }
        else if (firstLine.startsWith("task")) {
            return await this.executeTaskQuery(query, context);
        }
        else if (firstLine.startsWith("calendar")) {
            return await this.executeCalendarQuery(query, context);
        }
        else {
            // Try to execute as raw JavaScript
            return await this.executeRawQuery(query, context);
        }
    }
    async executeTableQuery(query, context) {
        const tableMatch = query.match(/table\s+(.+?)\s+from/s);
        const fromMatch = query.match(/from\s+(.+?)(?:\s+where|$)/s);
        const whereMatch = query.match(/where\s+(.+?)$/s);
        if (!fromMatch) {
            throw new Error("Invalid table query: missing FROM clause");
        }
        const source = fromMatch[1].trim();
        const fields = tableMatch
            ? tableMatch[1].split(",").map((f) => f.trim())
            : [];
        let pages = this.dataviewApi.pages(source);
        if (whereMatch) {
            // Apply where clause (simplified - in real implementation would need proper expression evaluation)
            const whereClause = whereMatch[1];
            pages = pages.where((p) => this.evaluateWhereClause(p, whereClause));
        }
        const data = pages.map((p) => {
            const row = { file: p.file };
            fields.forEach((field) => {
                row[field] = this.getFieldValue(p, field);
            });
            return row;
        });
        return {
            type: "table",
            data: Array.from(data),
            columns: ["file", ...fields],
            metadata: { source, where: whereMatch?.[1] },
        };
    }
    async executeListQuery(query, context) {
        const fromMatch = query.match(/from\s+(.+?)(?:\s+where|$)/s);
        if (!fromMatch) {
            throw new Error("Invalid list query: missing FROM clause");
        }
        const source = fromMatch[1].trim();
        const pages = this.dataviewApi.pages(source);
        return {
            type: "list",
            data: Array.from(pages).map((p) => p.file),
            metadata: { source },
        };
    }
    async executeTaskQuery(query, context) {
        const fromMatch = query.match(/from\s+(.+?)(?:\s+where|$)/s);
        const source = fromMatch ? fromMatch[1].trim() : '""';
        const tasks = this.dataviewApi
            .pages(source)
            .file.tasks.where((t) => !t.completed);
        return {
            type: "task",
            data: Array.from(tasks),
            metadata: { source },
        };
    }
    async executeCalendarQuery(query, context) {
        // Calendar query implementation would be more complex
        // This is a simplified version
        return {
            type: "calendar",
            data: [],
            metadata: { queryType: "calendar" },
        };
    }
    async executeRawQuery(query, context) {
        // Execute as JavaScript with dataview context
        const AsyncFunction = Object.getPrototypeOf(async function () { }).constructor;
        const fn = new AsyncFunction("dv", "context", query);
        const result = await fn(this.dataviewApi, context);
        return {
            type: "raw",
            data: Array.isArray(result) ? result : [result],
            metadata: { queryType: "raw" },
        };
    }
    async renderDataviewQuery(container, query, context) {
        const dvContainer = container.createDiv({
            cls: "exocortex-dataview-container",
        });
        const queryLines = query.trim().split("\n");
        const firstLine = queryLines[0].toLowerCase();
        if (firstLine.startsWith("table")) {
            await this.renderTableQuery(dvContainer, query);
        }
        else if (firstLine.startsWith("list")) {
            await this.renderListQuery(dvContainer, query);
        }
        else if (firstLine.startsWith("task")) {
            await this.renderTaskQuery(dvContainer, query);
        }
        else {
            // Execute as raw JavaScript with container access
            const AsyncFunction = Object.getPrototypeOf(async function () { }).constructor;
            const fn = new AsyncFunction("dv", "container", "context", query);
            await fn(this.dataviewApi, dvContainer, context);
        }
    }
    async renderTableQuery(container, query) {
        const result = await this.executeTableQuery(query);
        if (result.data.length === 0) {
            container.createEl("p", {
                text: "No results found",
                cls: "exocortex-empty",
            });
            return;
        }
        this.dataviewApi.table(result.columns, result.data.map((row) => result.columns.map((col) => row[col] || "")));
    }
    async renderListQuery(container, query) {
        const result = await this.executeListQuery(query);
        if (result.data.length === 0) {
            container.createEl("p", {
                text: "No results found",
                cls: "exocortex-empty",
            });
            return;
        }
        this.dataviewApi.list(result.data);
    }
    async renderTaskQuery(container, query) {
        const result = await this.executeTaskQuery(query);
        if (result.data.length === 0) {
            container.createEl("p", {
                text: "No tasks found",
                cls: "exocortex-empty",
            });
            return;
        }
        this.dataviewApi.taskList(result.data);
    }
    getFieldValue(page, field) {
        // Handle nested field access (e.g., "file.name", "metadata.title")
        const parts = field.split(".");
        let value = page;
        for (const part of parts) {
            value = value?.[part];
            if (value === undefined)
                break;
        }
        return value || "";
    }
    evaluateWhereClause(page, whereClause) {
        // Simplified where clause evaluation
        // In a real implementation, this would need proper expression parsing
        try {
            const AsyncFunction = Object.getPrototypeOf(async function () { }).constructor;
            const fn = new AsyncFunction("page", `return ${whereClause};`);
            return fn(page);
        }
        catch {
            return true; // Default to include if evaluation fails
        }
    }
}
exports.DataviewQueryEngine = DataviewQueryEngine;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2luZnJhc3RydWN0dXJlL3F1ZXJ5LWVuZ2luZXMvRGF0YXZpZXdRdWVyeUVuZ2luZS50cyIsIm1hcHBpbmdzIjoiOzs7QUFNQSxxREFBa0Q7QUFFbEQ7OztHQUdHO0FBQ0gsTUFBYSxtQkFBbUI7SUFDOUIsWUFBb0IsV0FBaUI7UUFBakIsZ0JBQVcsR0FBWCxXQUFXLENBQU07SUFBRyxDQUFDO0lBRWxDLE9BQU87UUFDWixPQUFPLFVBQVUsQ0FBQztJQUNwQixDQUFDO0lBRU0sV0FBVztRQUNoQixPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxJQUFJLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEtBQUssVUFBVSxDQUFDO0lBQzVFLENBQUM7SUFFTSxLQUFLLENBQUMsWUFBWSxDQUN2QixLQUFhLEVBQ2IsT0FBc0I7UUFFdEIsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsRUFBRTtZQUN2QixPQUFPLGVBQU0sQ0FBQyxJQUFJLENBQWMsMkJBQTJCLENBQUMsQ0FBQztTQUM5RDtRQUVELElBQUk7WUFDRixNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDL0QsT0FBTyxlQUFNLENBQUMsRUFBRSxDQUFjLE1BQU0sQ0FBQyxDQUFDO1NBQ3ZDO1FBQUMsT0FBTyxLQUFLLEVBQUU7WUFDZCxPQUFPLGVBQU0sQ0FBQyxJQUFJLENBQWMseUJBQXlCLEtBQUssRUFBRSxDQUFDLENBQUM7U0FDbkU7SUFDSCxDQUFDO0lBRU0sS0FBSyxDQUFDLFdBQVcsQ0FDdEIsU0FBc0IsRUFDdEIsS0FBYSxFQUNiLE9BQXNCO1FBRXRCLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEVBQUU7WUFDdkIsT0FBTyxlQUFNLENBQUMsSUFBSSxDQUFPLDJCQUEyQixDQUFDLENBQUM7U0FDdkQ7UUFFRCxJQUFJ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LE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBRU8sYUFBYSxDQUFDLElBQVMsRUFBRSxLQUFhO1FBQzVDLG1FQUFtRTtRQUNuRSxNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQy9CLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQztRQUVqQixLQUFLLE1BQU0sSUFBSSxJQUFJLEtBQUssRUFBRTtZQUN4QixLQUFLLEdBQUcsS0FBSyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDdEIsSUFBSSxLQUFLLEtBQUssU0FBUztnQkFBRSxNQUFNO1NBQ2hDO1FBRUQsT0FBTyxLQUFLLElBQUksRUFBRSxDQUFDO0lBQ3JCLENBQUM7SUFFTyxtQkFBbUIsQ0FBQyxJQUFTLEVBQUUsV0FBbUI7UUFDeEQscUNBQXFDO1FBQ3JDLHNFQUFzRTtRQUN0RSxJQUFJO1lBQ0YsTUFBTSxhQUFhLEdBQUcsTUFBTSxDQUFDLGNBQWMsQ0FDekMsS0FBSyxlQUFjLENBQUMsQ0FDckIsQ0FBQyxXQUFXLENBQUM7WUFDZCxNQUFNLEVBQUUsR0FBRyxJQUFJLGFBQWEsQ0FBQyxNQUFNLEVBQUUsVUFBVSxXQUFXLEdBQUcsQ0FBQyxDQUFDO1lBQy9ELE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ2pCO1FBQUMsTUFBTTtZQUNOLE9BQU8sSUFBSSxDQUFDLENBQUMseUNBQXlDO1NBQ3ZEO0lBQ0gsQ0FBQztDQUNGO0FBbFZELGtEQWtWQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva2l0ZWxldi9Eb2N1bWVudHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi9zcmMvaW5mcmFzdHJ1Y3R1cmUvcXVlcnktZW5naW5lcy9EYXRhdmlld1F1ZXJ5RW5naW5lLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIElRdWVyeUVuZ2luZSxcbiAgUXVlcnlFbmdpbmVUeXBlLFxuICBRdWVyeVJlc3VsdCxcbiAgUXVlcnlDb250ZXh0LFxufSBmcm9tIFwiLi4vLi4vZG9tYWluL3BvcnRzL0lRdWVyeUVuZ2luZVwiO1xuaW1wb3J0IHsgUmVzdWx0IH0gZnJvbSBcIi4uLy4uL2RvbWFpbi9jb3JlL1Jlc3VsdFwiO1xuXG4vKipcbiAqIERhdGF2aWV3IFF1ZXJ5IEVuZ2luZSBJbXBsZW1lbnRhdGlvblxuICogQWRhcHRzIHRoZSBEYXRhdmlldyBwbHVnaW4gQVBJIHRvIG91ciBnZW5lcmljIHF1ZXJ5IGVuZ2luZSBpbnRlcmZhY2VcbiAqL1xuZXhwb3J0IGNsYXNzIERhdGF2aWV3UXVlcnlFbmdpbmUgaW1wbGVtZW50cyBJUXVlcnlFbmdpbmUge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGRhdGF2aWV3QXBpPzogYW55KSB7fVxuXG4gIHB1YmxpYyBnZXRUeXBlKCk6IFF1ZXJ5RW5naW5lVHlwZSB7XG4gICAgcmV0dXJuIFwiZGF0YXZpZXdcIjtcbiAgfVxuXG4gIHB1YmxpYyBpc0F2YWlsYWJsZSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gISF0aGlzLmRhdGF2aWV3QXBpICYmIHR5cGVvZiB0aGlzLmRhdGF2aWV3QXBpLnBhZ2VzID09PSBcImZ1bmN0aW9uXCI7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZXhlY3V0ZVF1ZXJ5KFxuICAgIHF1ZXJ5OiBzdHJpbmcsXG4gICAgY29udGV4dD86IFF1ZXJ5Q29udGV4dCxcbiAgKTogUHJvbWlzZTxSZXN1bHQ8UXVlcnlSZXN1bHQ+PiB7XG4gICAgaWYgKCF0aGlzLmlzQXZhaWxhYmxlKCkpIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxRdWVyeVJlc3VsdD4oXCJEYXRhdmlldyBpcyBub3QgYXZhaWxhYmxlXCIpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLnBhcnNlQW5kRXhlY3V0ZVF1ZXJ5KHF1ZXJ5LCBjb250ZXh0KTtcbiAgICAgIHJldHVybiBSZXN1bHQub2s8UXVlcnlSZXN1bHQ+KHJlc3VsdCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxRdWVyeVJlc3VsdD4oYERhdGF2aWV3IHF1ZXJ5IGVycm9yOiAke2Vycm9yfWApO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhc3luYyByZW5kZXJRdWVyeShcbiAgICBjb250YWluZXI6IEhUTUxFbGVtZW50LFxuICAgIHF1ZXJ5OiBzdHJpbmcsXG4gICAgY29udGV4dD86IFF1ZXJ5Q29udGV4dCxcbiAgKTogUHJvbWlzZTxSZXN1bHQ8dm9pZD4+IHtcbiAgICBpZiAoIXRoaXMuaXNBdmFpbGFibGUoKSkge1xuICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPHZvaWQ+KFwiRGF0YXZpZXcgaXMgbm90IGF2YWlsYWJsZVwiKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5yZW5kZXJEYXRhdmlld1F1ZXJ5KGNvbnRhaW5lciwgcXVlcnksIGNvbnRleHQpO1xuICAgICAgcmV0dXJuIFJlc3VsdC5vazx2b2lkPigpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8dm9pZD4oYERhdGF2aWV3IHJlbmRlciBlcnJvcjogJHtlcnJvcn1gKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0UGFnZXMoc291cmNlOiBzdHJpbmcpOiBQcm9taXNlPFJlc3VsdDxhbnlbXT4+IHtcbiAgICBpZiAoIXRoaXMuaXNBdmFpbGFibGUoKSkge1xuICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPGFueVtdPihcIkRhdGF2aWV3IGlzIG5vdCBhdmFpbGFibGVcIik7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHBhZ2VzID0gdGhpcy5kYXRhdmlld0FwaS5wYWdlcyhzb3VyY2UpO1xuICAgICAgcmV0dXJuIFJlc3VsdC5vazxhbnlbXT4ocGFnZXMgPyBBcnJheS5mcm9tKHBhZ2VzKSA6IFtdKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPGFueVtdPihgRmFpbGVkIHRvIGdldCBwYWdlczogJHtlcnJvcn1gKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZ2V0UGFnZU1ldGFkYXRhKFxuICAgIHBhdGg6IHN0cmluZyxcbiAgKTogUHJvbWlzZTxSZXN1bHQ8UmVjb3JkPHN0cmluZywgYW55Pj4+IHtcbiAgICBpZiAoIXRoaXMuaXNBdmFpbGFibGUoKSkge1xuICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPFJlY29yZDxzdHJpbmcsIGFueT4+KFwiRGF0YXZpZXcgaXMgbm90IGF2YWlsYWJsZVwiKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcGFnZSA9IHRoaXMuZGF0YXZpZXdBcGkucGFnZShwYXRoKTtcbiAgICAgIHJldHVybiBSZXN1bHQub2s8UmVjb3JkPHN0cmluZywgYW55Pj4ocGFnZSB8fCB7fSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxSZWNvcmQ8c3RyaW5nLCBhbnk+PihcbiAgICAgICAgYEZhaWxlZCB0byBnZXQgcGFnZSBtZXRhZGF0YTogJHtlcnJvcn1gLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgdmFsaWRhdGVRdWVyeShxdWVyeTogc3RyaW5nKTogUmVzdWx0PGJvb2xlYW4+IHtcbiAgICBpZiAoIXF1ZXJ5IHx8IHF1ZXJ5LnRyaW0oKS5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxib29sZWFuPihcIlF1ZXJ5IGNhbm5vdCBiZSBlbXB0eVwiKTtcbiAgICB9XG5cbiAgICAvLyBCYXNpYyB2YWxpZGF0aW9uIGZvciBEYXRhdmlldyBxdWVyeSBzeW50YXhcbiAgICBjb25zdCB0cmltbWVkUXVlcnkgPSBxdWVyeS50cmltKCkudG9Mb3dlckNhc2UoKTtcblxuICAgIGNvbnN0IHZhbGlkU3RhcnRLZXl3b3JkcyA9IFtcInRhYmxlXCIsIFwibGlzdFwiLCBcInRhc2tcIiwgXCJjYWxlbmRhclwiXTtcbiAgICBjb25zdCBoYXNWYWxpZFN0YXJ0ID0gdmFsaWRTdGFydEtleXdvcmRzLnNvbWUoKGtleXdvcmQpID0+XG4gICAgICB0cmltbWVkUXVlcnkuc3RhcnRzV2l0aChrZXl3b3JkKSxcbiAgICApO1xuXG4gICAgaWYgKCFoYXNWYWxpZFN0YXJ0ICYmICF0cmltbWVkUXVlcnkuaW5jbHVkZXMoXCJkdi5cIikpIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxib29sZWFuPihcbiAgICAgICAgXCJRdWVyeSBtdXN0IHN0YXJ0IHdpdGggdGFibGUsIGxpc3QsIHRhc2ssIGNhbGVuZGFyLCBvciBjb250YWluIGR2LiBjYWxsc1wiLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gUmVzdWx0Lm9rPGJvb2xlYW4+KHRydWUpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBwYXJzZUFuZEV4ZWN1dGVRdWVyeShcbiAgICBxdWVyeTogc3RyaW5nLFxuICAgIGNvbnRleHQ/OiBRdWVyeUNvbnRleHQsXG4gICk6IFByb21pc2U8UXVlcnlSZXN1bHQ+IHtcbiAgICBjb25zdCBxdWVyeUxpbmVzID0gcXVlcnkudHJpbSgpLnNwbGl0KFwiXFxuXCIpO1xuICAgIGNvbnN0IGZpcnN0TGluZSA9IHF1ZXJ5TGluZXNbMF0udG9Mb3dlckNhc2UoKTtcblxuICAgIGlmIChmaXJzdExpbmUuc3RhcnRzV2l0aChcInRhYmxlXCIpKSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlVGFibGVRdWVyeShxdWVyeSwgY29udGV4dCk7XG4gICAgfSBlbHNlIGlmIChmaXJzdExpbmUuc3RhcnRzV2l0aChcImxpc3RcIikpIHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVMaXN0UXVlcnkocXVlcnksIGNvbnRleHQpO1xuICAgIH0gZWxzZSBpZiAoZmlyc3RMaW5lLnN0YXJ0c1dpdGgoXCJ0YXNrXCIpKSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlVGFza1F1ZXJ5KHF1ZXJ5LCBjb250ZXh0KTtcbiAgICB9IGVsc2UgaWYgKGZpcnN0TGluZS5zdGFydHNXaXRoKFwiY2FsZW5kYXJcIikpIHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVDYWxlbmRhclF1ZXJ5KHF1ZXJ5LCBjb250ZXh0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gVHJ5IHRvIGV4ZWN1dGUgYXMgcmF3IEphdmFTY3JpcHRcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVSYXdRdWVyeShxdWVyeSwgY29udGV4dCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBleGVjdXRlVGFibGVRdWVyeShcbiAgICBxdWVyeTogc3RyaW5nLFxuICAgIGNvbnRleHQ/OiBRdWVyeUNvbnRleHQsXG4gICk6IFByb21pc2U8UXVlcnlSZXN1bHQ+IHtcbiAgICBjb25zdCB0YWJsZU1hdGNoID0gcXVlcnkubWF0Y2goL3RhYmxlXFxzKyguKz8pXFxzK2Zyb20vcyk7XG4gICAgY29uc3QgZnJvbU1hdGNoID0gcXVlcnkubWF0Y2goL2Zyb21cXHMrKC4rPykoPzpcXHMrd2hlcmV8JCkvcyk7XG4gICAgY29uc3Qgd2hlcmVNYXRjaCA9IHF1ZXJ5Lm1hdGNoKC93aGVyZVxccysoLis/KSQvcyk7XG5cbiAgICBpZiAoIWZyb21NYXRjaCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiSW52YWxpZCB0YWJsZSBxdWVyeTogbWlzc2luZyBGUk9NIGNsYXVzZVwiKTtcbiAgICB9XG5cbiAgICBjb25zdCBzb3VyY2UgPSBmcm9tTWF0Y2hbMV0udHJpbSgpO1xuICAgIGNvbnN0IGZpZWxkcyA9IHRhYmxlTWF0Y2hcbiAgICAgID8gdGFibGVNYXRjaFsxXS5zcGxpdChcIixcIikubWFwKChmKSA9PiBmLnRyaW0oKSlcbiAgICAgIDogW107XG5cbiAgICBsZXQgcGFnZXMgPSB0aGlzLmRhdGF2aWV3QXBpLnBhZ2VzKHNvdXJjZSk7XG5cbiAgICBpZiAod2hlcmVNYXRjaCkge1xuICAgICAgLy8gQXBwbHkgd2hlcmUgY2xhdXNlIChzaW1wbGlmaWVkIC0gaW4gcmVhbCBpbXBsZW1lbnRhdGlvbiB3b3VsZCBuZWVkIHByb3BlciBleHByZXNzaW9uIGV2YWx1YXRpb24pXG4gICAgICBjb25zdCB3aGVyZUNsYXVzZSA9IHdoZXJlTWF0Y2hbMV07XG4gICAgICBwYWdlcyA9IHBhZ2VzLndoZXJlKChwOiBhbnkpID0+IHRoaXMuZXZhbHVhdGVXaGVyZUNsYXVzZShwLCB3aGVyZUNsYXVzZSkpO1xuICAgIH1cblxuICAgIGNvbnN0IGRhdGEgPSBwYWdlcy5tYXAoKHA6IGFueSkgPT4ge1xuICAgICAgY29uc3Qgcm93OiBhbnkgPSB7IGZpbGU6IHAuZmlsZSB9O1xuICAgICAgZmllbGRzLmZvckVhY2goKGZpZWxkKSA9PiB7XG4gICAgICAgIHJvd1tmaWVsZF0gPSB0aGlzLmdldEZpZWxkVmFsdWUocCwgZmllbGQpO1xuICAgICAgfSk7XG4gICAgICByZXR1cm4gcm93O1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6IFwidGFibGVcIixcbiAgICAgIGRhdGE6IEFycmF5LmZyb20oZGF0YSksXG4gICAgICBjb2x1bW5zOiBbXCJmaWxlXCIsIC4uLmZpZWxkc10sXG4gICAgICBtZXRhZGF0YTogeyBzb3VyY2UsIHdoZXJlOiB3aGVyZU1hdGNoPy5bMV0gfSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBleGVjdXRlTGlzdFF1ZXJ5KFxuICAgIHF1ZXJ5OiBzdHJpbmcsXG4gICAgY29udGV4dD86IFF1ZXJ5Q29udGV4dCxcbiAgKTogUHJvbWlzZTxRdWVyeVJlc3VsdD4ge1xuICAgIGNvbnN0IGZyb21NYXRjaCA9IHF1ZXJ5Lm1hdGNoKC9mcm9tXFxzKyguKz8pKD86XFxzK3doZXJlfCQpL3MpO1xuXG4gICAgaWYgKCFmcm9tTWF0Y2gpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgbGlzdCBxdWVyeTogbWlzc2luZyBGUk9NIGNsYXVzZVwiKTtcbiAgICB9XG5cbiAgICBjb25zdCBzb3VyY2UgPSBmcm9tTWF0Y2hbMV0udHJpbSgpO1xuICAgIGNvbnN0IHBhZ2VzID0gdGhpcy5kYXRhdmlld0FwaS5wYWdlcyhzb3VyY2UpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6IFwibGlzdFwiLFxuICAgICAgZGF0YTogQXJyYXkuZnJvbShwYWdlcykubWFwKChwOiBhbnkpID0+IHAuZmlsZSksXG4gICAgICBtZXRhZGF0YTogeyBzb3VyY2UgfSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBleGVjdXRlVGFza1F1ZXJ5KFxuICAgIHF1ZXJ5OiBzdHJpbmcsXG4gICAgY29udGV4dD86IFF1ZXJ5Q29udGV4dCxcbiAgKTogUHJvbWlzZTxRdWVyeVJlc3VsdD4ge1xuICAgIGNvbnN0IGZyb21NYXRjaCA9IHF1ZXJ5Lm1hdGNoKC9mcm9tXFxzKyguKz8pKD86XFxzK3doZXJlfCQpL3MpO1xuXG4gICAgY29uc3Qgc291cmNlID0gZnJvbU1hdGNoID8gZnJvbU1hdGNoWzFdLnRyaW0oKSA6ICdcIlwiJztcbiAgICBjb25zdCB0YXNrcyA9IHRoaXMuZGF0YXZpZXdBcGlcbiAgICAgIC5wYWdlcyhzb3VyY2UpXG4gICAgICAuZmlsZS50YXNrcy53aGVyZSgodDogYW55KSA9PiAhdC5jb21wbGV0ZWQpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6IFwidGFza1wiLFxuICAgICAgZGF0YTogQXJyYXkuZnJvbSh0YXNrcyksXG4gICAgICBtZXRhZGF0YTogeyBzb3VyY2UgfSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBleGVjdXRlQ2FsZW5kYXJRdWVyeShcbiAgICBxdWVyeTogc3RyaW5nLFxuICAgIGNvbnRleHQ/OiBRdWVyeUNvbnRleHQsXG4gICk6IFByb21pc2U8UXVlcnlSZXN1bHQ+IHtcbiAgICAvLyBDYWxlbmRhciBxdWVyeSBpbXBsZW1lbnRhdGlvbiB3b3VsZCBiZSBtb3JlIGNvbXBsZXhcbiAgICAvLyBUaGlzIGlzIGEgc2ltcGxpZmllZCB2ZXJzaW9uXG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6IFwiY2FsZW5kYXJcIixcbiAgICAgIGRhdGE6IFtdLFxuICAgICAgbWV0YWRhdGE6IHsgcXVlcnlUeXBlOiBcImNhbGVuZGFyXCIgfSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBleGVjdXRlUmF3UXVlcnkoXG4gICAgcXVlcnk6IHN0cmluZyxcbiAgICBjb250ZXh0PzogUXVlcnlDb250ZXh0LFxuICApOiBQcm9taXNlPFF1ZXJ5UmVzdWx0PiB7XG4gICAgLy8gRXhlY3V0ZSBhcyBKYXZhU2NyaXB0IHdpdGggZGF0YXZpZXcgY29udGV4dFxuICAgIGNvbnN0IEFzeW5jRnVuY3Rpb24gPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoXG4gICAgICBhc3luYyBmdW5jdGlvbiAoKSB7fSxcbiAgICApLmNvbnN0cnVjdG9yO1xuICAgIGNvbnN0IGZuID0gbmV3IEFzeW5jRnVuY3Rpb24oXCJkdlwiLCBcImNvbnRleHRcIiwgcXVlcnkpO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZm4odGhpcy5kYXRhdmlld0FwaSwgY29udGV4dCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogXCJyYXdcIixcbiAgICAgIGRhdGE6IEFycmF5LmlzQXJyYXkocmVzdWx0KSA/IHJlc3VsdCA6IFtyZXN1bHRdLFxuICAgICAgbWV0YWRhdGE6IHsgcXVlcnlUeXBlOiBcInJhd1wiIH0sXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcmVuZGVyRGF0YXZpZXdRdWVyeShcbiAgICBjb250YWluZXI6IEhUTUxFbGVtZW50LFxuICAgIHF1ZXJ5OiBzdHJpbmcsXG4gICAgY29udGV4dD86IFF1ZXJ5Q29udGV4dCxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZHZDb250YWluZXIgPSBjb250YWluZXIuY3JlYXRlRGl2KHtcbiAgICAgIGNsczogXCJleG9jb3J0ZXgtZGF0YXZpZXctY29udGFpbmVyXCIsXG4gICAgfSk7XG5cbiAgICBjb25zdCBxdWVyeUxpbmVzID0gcXVlcnkudHJpbSgpLnNwbGl0KFwiXFxuXCIpO1xuICAgIGNvbnN0IGZpcnN0TGluZSA9IHF1ZXJ5TGluZXNbMF0udG9Mb3dlckNhc2UoKTtcblxuICAgIGlmIChmaXJzdExpbmUuc3RhcnRzV2l0aChcInRhYmxlXCIpKSB7XG4gICAgICBhd2FpdCB0aGlzLnJlbmRlclRhYmxlUXVlcnkoZHZDb250YWluZXIsIHF1ZXJ5KTtcbiAgICB9IGVsc2UgaWYgKGZpcnN0TGluZS5zdGFydHNXaXRoKFwibGlzdFwiKSkge1xuICAgICAgYXdhaXQgdGhpcy5yZW5kZXJMaXN0UXVlcnkoZHZDb250YWluZXIsIHF1ZXJ5KTtcbiAgICB9IGVsc2UgaWYgKGZpcnN0TGluZS5zdGFydHNXaXRoKFwidGFza1wiKSkge1xuICAgICAgYXdhaXQgdGhpcy5yZW5kZXJUYXNrUXVlcnkoZHZDb250YWluZXIsIHF1ZXJ5KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gRXhlY3V0ZSBhcyByYXcgSmF2YVNjcmlwdCB3aXRoIGNvbnRhaW5lciBhY2Nlc3NcbiAgICAgIGNvbnN0IEFzeW5jRnVuY3Rpb24gPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YoXG4gICAgICAgIGFzeW5jIGZ1bmN0aW9uICgpIHt9LFxuICAgICAgKS5jb25zdHJ1Y3RvcjtcbiAgICAgIGNvbnN0IGZuID0gbmV3IEFzeW5jRnVuY3Rpb24oXCJkdlwiLCBcImNvbnRhaW5lclwiLCBcImNvbnRleHRcIiwgcXVlcnkpO1xuICAgICAgYXdhaXQgZm4odGhpcy5kYXRhdmlld0FwaSwgZHZDb250YWluZXIsIGNvbnRleHQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcmVuZGVyVGFibGVRdWVyeShcbiAgICBjb250YWluZXI6IEhUTUxFbGVtZW50LFxuICAgIHF1ZXJ5OiBzdHJpbmcsXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuZXhlY3V0ZVRhYmxlUXVlcnkocXVlcnkpO1xuXG4gICAgaWYgKHJlc3VsdC5kYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgICAgY29udGFpbmVyLmNyZWF0ZUVsKFwicFwiLCB7XG4gICAgICAgIHRleHQ6IFwiTm8gcmVzdWx0cyBmb3VuZFwiLFxuICAgICAgICBjbHM6IFwiZXhvY29ydGV4LWVtcHR5XCIsXG4gICAgICB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmRhdGF2aWV3QXBpLnRhYmxlKFxuICAgICAgcmVzdWx0LmNvbHVtbnMsXG4gICAgICByZXN1bHQuZGF0YS5tYXAoKHJvdzogYW55KSA9PlxuICAgICAgICByZXN1bHQuY29sdW1ucyEubWFwKChjb2wpID0+IHJvd1tjb2xdIHx8IFwiXCIpLFxuICAgICAgKSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyByZW5kZXJMaXN0UXVlcnkoXG4gICAgY29udGFpbmVyOiBIVE1MRWxlbWVudCxcbiAgICBxdWVyeTogc3RyaW5nLFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmV4ZWN1dGVMaXN0UXVlcnkocXVlcnkpO1xuXG4gICAgaWYgKHJlc3VsdC5kYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgICAgY29udGFpbmVyLmNyZWF0ZUVsKFwicFwiLCB7XG4gICAgICAgIHRleHQ6IFwiTm8gcmVzdWx0cyBmb3VuZFwiLFxuICAgICAgICBjbHM6IFwiZXhvY29ydGV4LWVtcHR5XCIsXG4gICAgICB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmRhdGF2aWV3QXBpLmxpc3QocmVzdWx0LmRhdGEpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyByZW5kZXJUYXNrUXVlcnkoXG4gICAgY29udGFpbmVyOiBIVE1MRWxlbWVudCxcbiAgICBxdWVyeTogc3RyaW5nLFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmV4ZWN1dGVUYXNrUXVlcnkocXVlcnkpO1xuXG4gICAgaWYgKHJlc3VsdC5kYXRhLmxlbmd0aCA9PT0gMCkge1xuICAgICAgY29udGFpbmVyLmNyZWF0ZUVsKFwicFwiLCB7XG4gICAgICAgIHRleHQ6IFwiTm8gdGFza3MgZm91bmRcIixcbiAgICAgICAgY2xzOiBcImV4b2NvcnRleC1lbXB0eVwiLFxuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5kYXRhdmlld0FwaS50YXNrTGlzdChyZXN1bHQuZGF0YSk7XG4gIH1cblxuICBwcml2YXRlIGdldEZpZWxkVmFsdWUocGFnZTogYW55LCBmaWVsZDogc3RyaW5nKTogYW55IHtcbiAgICAvLyBIYW5kbGUgbmVzdGVkIGZpZWxkIGFjY2VzcyAoZS5nLiwgXCJmaWxlLm5hbWVcIiwgXCJtZXRhZGF0YS50aXRsZVwiKVxuICAgIGNvbnN0IHBhcnRzID0gZmllbGQuc3BsaXQoXCIuXCIpO1xuICAgIGxldCB2YWx1ZSA9IHBhZ2U7XG5cbiAgICBmb3IgKGNvbnN0IHBhcnQgb2YgcGFydHMpIHtcbiAgICAgIHZhbHVlID0gdmFsdWU/LltwYXJ0XTtcbiAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSBicmVhaztcbiAgICB9XG5cbiAgICByZXR1cm4gdmFsdWUgfHwgXCJcIjtcbiAgfVxuXG4gIHByaXZhdGUgZXZhbHVhdGVXaGVyZUNsYXVzZShwYWdlOiBhbnksIHdoZXJlQ2xhdXNlOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAvLyBTaW1wbGlmaWVkIHdoZXJlIGNsYXVzZSBldmFsdWF0aW9uXG4gICAgLy8gSW4gYSByZWFsIGltcGxlbWVudGF0aW9uLCB0aGlzIHdvdWxkIG5lZWQgcHJvcGVyIGV4cHJlc3Npb24gcGFyc2luZ1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBBc3luY0Z1bmN0aW9uID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKFxuICAgICAgICBhc3luYyBmdW5jdGlvbiAoKSB7fSxcbiAgICAgICkuY29uc3RydWN0b3I7XG4gICAgICBjb25zdCBmbiA9IG5ldyBBc3luY0Z1bmN0aW9uKFwicGFnZVwiLCBgcmV0dXJuICR7d2hlcmVDbGF1c2V9O2ApO1xuICAgICAgcmV0dXJuIGZuKHBhZ2UpO1xuICAgIH0gY2F0Y2gge1xuICAgICAgcmV0dXJuIHRydWU7IC8vIERlZmF1bHQgdG8gaW5jbHVkZSBpZiBldmFsdWF0aW9uIGZhaWxzXG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=