fb6c06b9af5dab40ad52c21198b8e771
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.QueryBlockRenderer = void 0;
const tslib_1 = require("tslib");
const ExecuteQueryBlockUseCase_1 = require("../../application/use-cases/ExecuteQueryBlockUseCase");
class QueryBlockRenderer {
    constructor(app) {
        this.app = app;
        this.executeQueryUseCase = new ExecuteQueryBlockUseCase_1.ExecuteQueryBlockUseCase(app);
    }
    render(container, config, file, frontmatter, dv) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const queryConfig = config;
            // Execute query
            const result = yield this.executeQueryUseCase.execute({
                blockConfig: queryConfig,
                currentAssetPath: file.path,
                currentAssetFrontmatter: frontmatter
            });
            if (result.isFailure) {
                container.createEl('p', {
                    text: `Query failed: ${result.error}`,
                    cls: 'exocortex-error'
                });
                return;
            }
            const { results, totalCount, executionTime } = result.getValue();
            // Show result count and execution time
            const info = container.createDiv({ cls: 'exocortex-query-info' });
            info.createEl('span', {
                text: `Found ${totalCount} items${results.length < totalCount ? `, showing ${results.length}` : ''} (${executionTime}ms)`,
                cls: 'exocortex-query-count'
            });
            if (results.length === 0) {
                container.createEl('p', {
                    text: 'No items found',
                    cls: 'exocortex-empty'
                });
                return;
            }
            // Render based on display type
            switch (queryConfig.displayAs) {
                case 'table':
                    this.renderTable(container, results, dv);
                    break;
                case 'cards':
                    this.renderCards(container, results);
                    break;
                case 'list':
                default:
                    this.renderList(container, results);
                    break;
            }
        });
    }
    renderList(container, files) {
        const list = container.createEl('ul', { cls: 'exocortex-query-list' });
        files.forEach(file => {
            const metadata = this.app.metadataCache.getFileCache(file);
            const frontmatter = (metadata === null || metadata === void 0 ? void 0 : metadata.frontmatter) || {};
            const item = list.createEl('li');
            const link = item.createEl('a', {
                text: frontmatter['exo__Asset_label'] || file.basename,
                href: file.path,
                cls: 'internal-link'
            });
            // Add status or other info if available
            const status = frontmatter['ems__Effort_status'];
            if (status) {
                const statusSpan = item.createEl('span', {
                    text: ` - ${this.cleanValue(status)}`,
                    cls: 'exocortex-status'
                });
            }
        });
    }
    renderTable(container, files, dv) {
        // Collect all unique properties
        const allProps = new Set();
        files.forEach(file => {
            const metadata = this.app.metadataCache.getFileCache(file);
            if (metadata === null || metadata === void 0 ? void 0 : metadata.frontmatter) {
                Object.keys(metadata.frontmatter).forEach(key => {
                    if (!key.startsWith('exo__Instance')) {
                        allProps.add(key);
                    }
                });
            }
        });
        // Select most relevant properties (max 5)
        const relevantProps = Array.from(allProps)
            .filter(p => !p.startsWith('exo__Asset_uid'))
            .slice(0, 5);
        // Create table
        const table = container.createEl('table', { cls: 'exocortex-query-table' });
        // Header
        const thead = table.createEl('thead');
        const headerRow = thead.createEl('tr');
        headerRow.createEl('th', { text: 'Name' });
        relevantProps.forEach(prop => {
            const displayName = prop.replace(/_/g, ' ').replace(/^\w+__/, '');
            headerRow.createEl('th', { text: displayName });
        });
        // Body
        const tbody = table.createEl('tbody');
        files.forEach(file => {
            const metadata = this.app.metadataCache.getFileCache(file);
            const frontmatter = (metadata === null || metadata === void 0 ? void 0 : metadata.frontmatter) || {};
            const row = tbody.createEl('tr');
            // Name cell with link
            const nameCell = row.createEl('td');
            nameCell.createEl('a', {
                text: frontmatter['exo__Asset_label'] || file.basename,
                href: file.path,
                cls: 'internal-link'
            });
            // Property cells
            relevantProps.forEach(prop => {
                const cell = row.createEl('td');
                const value = frontmatter[prop];
                if (value) {
                    cell.setText(this.formatValue(value));
                }
            });
        });
    }
    renderCards(container, files) {
        const cardsContainer = container.createDiv({ cls: 'exocortex-query-cards' });
        files.forEach(file => {
            const metadata = this.app.metadataCache.getFileCache(file);
            const frontmatter = (metadata === null || metadata === void 0 ? void 0 : metadata.frontmatter) || {};
            const card = cardsContainer.createDiv({ cls: 'exocortex-card' });
            // Card header
            const header = card.createDiv({ cls: 'exocortex-card-header' });
            header.createEl('a', {
                text: frontmatter['exo__Asset_label'] || file.basename,
                href: file.path,
                cls: 'internal-link'
            });
            // Card body with key properties
            const body = card.createDiv({ cls: 'exocortex-card-body' });
            // Show status if available
            const status = frontmatter['ems__Effort_status'];
            if (status) {
                body.createEl('div', {
                    text: `Status: ${this.cleanValue(status)}`,
                    cls: 'exocortex-card-status'
                });
            }
            // Show description if available
            const description = frontmatter['exo__Asset_description'];
            if (description) {
                body.createEl('div', {
                    text: description,
                    cls: 'exocortex-card-description'
                });
            }
        });
    }
    cleanValue(value) {
        if (!value)
            return '';
        const str = Array.isArray(value) ? value[0] : value;
        return (str === null || str === void 0 ? void 0 : str.toString().replace(/\[\[|\]\]/g, '')) || '';
    }
    formatValue(value) {
        if (Array.isArray(value)) {
            return value.map(v => this.cleanValue(v)).join(', ');
        }
        return this.cleanValue(value);
    }
}
exports.QueryBlockRenderer = QueryBlockRenderer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL3ByZXNlbnRhdGlvbi9yZW5kZXJlcnMvUXVlcnlCbG9ja1JlbmRlcmVyLnRzIiwibWFwcGluZ3MiOiI7Ozs7QUFDQSxtR0FBZ0c7QUFHaEcsTUFBYSxrQkFBa0I7SUFHM0IsWUFBb0IsR0FBUTtRQUFSLFFBQUcsR0FBSCxHQUFHLENBQUs7UUFDeEIsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksbURBQXdCLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDakUsQ0FBQztJQUVLLE1BQU0sQ0FDUixTQUFzQixFQUN0QixNQUFXLEVBQ1gsSUFBVyxFQUNYLFdBQWdCLEVBQ2hCLEVBQU87O1lBRVAsTUFBTSxXQUFXLEdBQUcsTUFBMEIsQ0FBQztZQUUvQyxnQkFBZ0I7WUFDaEIsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsbUJBQW1CLENBQUMsT0FBTyxDQUFDO2dCQUNsRCxXQUFXLEVBQUUsV0FBVztnQkFDeEIsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLElBQUk7Z0JBQzNCLHVCQUF1QixFQUFFLFdBQVc7YUFDdkMsQ0FBQyxDQUFDO1lBRUgsSUFBSSxNQUFNLENBQUMsU0FBUyxFQUFFO2dCQUNsQixTQUFTLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBRTtvQkFDcEIsSUFBSSxFQUFFLGlCQUFpQixNQUFNLENBQUMsS0FBSyxFQUFFO29CQUNyQyxHQUFHLEVBQUUsaUJBQWlCO2lCQUN6QixDQUFDLENBQUM7Z0JBQ0gsT0FBTzthQUNWO1lBRUQsTUFBTSxFQUFFLE9BQU8sRUFBRSxVQUFVLEVBQUUsYUFBYSxFQUFFLEdBQUcsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBRWpFLHVDQUF1QztZQUN2QyxNQUFNLElBQUksR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFDLEVBQUUsR0FBRyxFQUFFLHNCQUFzQixFQUFFLENBQUMsQ0FBQztZQUNsRSxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFB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QkFBd0IsQ0FBQyxDQUFDO1lBQzFELElBQUksV0FBVyxFQUFFO2dCQUNiLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFO29CQUNqQixJQUFJLEVBQUUsV0FBVztvQkFDakIsR0FBRyxFQUFFLDRCQUE0QjtpQkFDcEMsQ0FBQyxDQUFDO2FBQ047UUFDTCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFTyxVQUFVLENBQUMsS0FBVTtRQUN6QixJQUFJLENBQUMsS0FBSztZQUFFLE9BQU8sRUFBRSxDQUFDO1FBQ3RCLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO1FBQ3BELE9BQU8sQ0FBQSxHQUFHLGFBQUgsR0FBRyx1QkFBSCxHQUFHLENBQUUsUUFBUSxHQUFHLE9BQU8sQ0FBQyxZQUFZLEVBQUUsRUFBRSxDQUFDLEtBQUksRUFBRSxDQUFDO0lBQzNELENBQUM7SUFFTyxXQUFXLENBQUMsS0FBVTtRQUMxQixJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDdEIsT0FBTyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUN4RDtRQUNELE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNsQyxDQUFDO0NBQ0o7QUF4TUQsZ0RBd01DIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9raXRlbGV2L0RvY3VtZW50cy9leG9jb3J0ZXgtb2JzaWRpYW4tcGx1Z2luL3NyYy9wcmVzZW50YXRpb24vcmVuZGVyZXJzL1F1ZXJ5QmxvY2tSZW5kZXJlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHAsIFRGaWxlIH0gZnJvbSAnb2JzaWRpYW4nO1xuaW1wb3J0IHsgRXhlY3V0ZVF1ZXJ5QmxvY2tVc2VDYXNlIH0gZnJvbSAnLi4vLi4vYXBwbGljYXRpb24vdXNlLWNhc2VzL0V4ZWN1dGVRdWVyeUJsb2NrVXNlQ2FzZSc7XG5pbXBvcnQgeyBRdWVyeUJsb2NrQ29uZmlnIH0gZnJvbSAnLi4vLi4vZG9tYWluL2VudGl0aWVzL0xheW91dEJsb2NrJztcblxuZXhwb3J0IGNsYXNzIFF1ZXJ5QmxvY2tSZW5kZXJlciB7XG4gICAgcHJpdmF0ZSBleGVjdXRlUXVlcnlVc2VDYXNlOiBFeGVjdXRlUXVlcnlCbG9ja1VzZUNhc2U7XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwcDogQXBwKSB7XG4gICAgICAgIHRoaXMuZXhlY3V0ZVF1ZXJ5VXNlQ2FzZSA9IG5ldyBFeGVjdXRlUXVlcnlCbG9ja1VzZUNhc2UoYXBwKTtcbiAgICB9XG5cbiAgICBhc3luYyByZW5kZXIoXG4gICAgICAgIGNvbnRhaW5lcjogSFRNTEVsZW1lbnQsXG4gICAgICAgIGNvbmZpZzogYW55LFxuICAgICAgICBmaWxlOiBURmlsZSxcbiAgICAgICAgZnJvbnRtYXR0ZXI6IGFueSxcbiAgICAgICAgZHY6IGFueVxuICAgICk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zdCBxdWVyeUNvbmZpZyA9IGNvbmZpZyBhcyBRdWVyeUJsb2NrQ29uZmlnO1xuICAgICAgICBcbiAgICAgICAgLy8gRXhlY3V0ZSBxdWVyeVxuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmV4ZWN1dGVRdWVyeVVzZUNhc2UuZXhlY3V0ZSh7XG4gICAgICAgICAgICBibG9ja0NvbmZpZzogcXVlcnlDb25maWcsXG4gICAgICAgICAgICBjdXJyZW50QXNzZXRQYXRoOiBmaWxlLnBhdGgsXG4gICAgICAgICAgICBjdXJyZW50QXNzZXRGcm9udG1hdHRlcjogZnJvbnRtYXR0ZXJcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKHJlc3VsdC5pc0ZhaWx1cmUpIHtcbiAgICAgICAgICAgIGNvbnRhaW5lci5jcmVhdGVFbCgncCcsIHsgXG4gICAgICAgICAgICAgICAgdGV4dDogYFF1ZXJ5IGZhaWxlZDogJHtyZXN1bHQuZXJyb3J9YCxcbiAgICAgICAgICAgICAgICBjbHM6ICdleG9jb3J0ZXgtZXJyb3InXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHsgcmVzdWx0cywgdG90YWxDb3VudCwgZXhlY3V0aW9uVGltZSB9ID0gcmVzdWx0LmdldFZhbHVlKCk7XG5cbiAgICAgICAgLy8gU2hvdyByZXN1bHQgY291bnQgYW5kIGV4ZWN1dGlvbiB0aW1lXG4gICAgICAgIGNvbnN0IGluZm8gPSBjb250YWluZXIuY3JlYXRlRGl2KHsgY2xzOiAnZXhvY29ydGV4LXF1ZXJ5LWluZm8nIH0pO1xuICAgICAgICBpbmZvLmNyZWF0ZUVsKCdzcGFuJywgeyBcbiAgICAgICAgICAgIHRleHQ6IGBGb3VuZCAke3RvdGFsQ291bnR9IGl0ZW1zJHtyZXN1bHRzLmxlbmd0aCA8IHRvdGFsQ291bnQgPyBgLCBzaG93aW5nICR7cmVzdWx0cy5sZW5ndGh9YCA6ICcnfSAoJHtleGVjdXRpb25UaW1lfW1zKWAsXG4gICAgICAgICAgICBjbHM6ICdleG9jb3J0ZXgtcXVlcnktY291bnQnXG4gICAgICAgIH0pO1xuXG4gICAgICAgIGlmIChyZXN1bHRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgY29udGFpbmVyLmNyZWF0ZUVsKCdwJywgeyBcbiAgICAgICAgICAgICAgICB0ZXh0OiAnTm8gaXRlbXMgZm91bmQnLFxuICAgICAgICAgICAgICAgIGNsczogJ2V4b2NvcnRleC1lbXB0eSdcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gUmVuZGVyIGJhc2VkIG9uIGRpc3BsYXkgdHlwZVxuICAgICAgICBzd2l0Y2ggKHF1ZXJ5Q29uZmlnLmRpc3BsYXlBcykge1xuICAgICAgICAgICAgY2FzZSAndGFibGUnOlxuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyVGFibGUoY29udGFpbmVyLCByZXN1bHRzLCBkdik7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICBjYXNlICdjYXJkcyc6XG4gICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJDYXJkcyhjb250YWluZXIsIHJlc3VsdHMpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgY2FzZSAnbGlzdCc6XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyTGlzdChjb250YWluZXIsIHJlc3VsdHMpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZW5kZXJMaXN0KGNvbnRhaW5lcjogSFRNTEVsZW1lbnQsIGZpbGVzOiBURmlsZVtdKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGxpc3QgPSBjb250YWluZXIuY3JlYXRlRWwoJ3VsJywgeyBjbHM6ICdleG9jb3J0ZXgtcXVlcnktbGlzdCcgfSk7XG4gICAgICAgIFxuICAgICAgICBmaWxlcy5mb3JFYWNoKGZpbGUgPT4ge1xuICAgICAgICAgICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLmFwcC5tZXRhZGF0YUNhY2hlLmdldEZpbGVDYWNoZShmaWxlKTtcbiAgICAgICAgICAgIGNvbnN0IGZyb250bWF0dGVyID0gbWV0YWRhdGE/LmZyb250bWF0dGVyIHx8IHt9O1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCBpdGVtID0gbGlzdC5jcmVhdGVFbCgnbGknKTtcbiAgICAgICAgICAgIGNvbnN0IGxpbmsgPSBpdGVtLmNyZWF0ZUVsKCdhJywge1xuICAgICAgICAgICAgICAgIHRleHQ6IGZyb250bWF0dGVyWydleG9fX0Fzc2V0X2xhYmVsJ10gfHwgZmlsZS5iYXNlbmFtZSxcbiAgICAgICAgICAgICAgICBocmVmOiBmaWxlLnBhdGgsXG4gICAgICAgICAgICAgICAgY2xzOiAnaW50ZXJuYWwtbGluaydcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBBZGQgc3RhdHVzIG9yIG90aGVyIGluZm8gaWYgYXZhaWxhYmxlXG4gICAgICAgICAgICBjb25zdCBzdGF0dXMgPSBmcm9udG1hdHRlclsnZW1zX19FZmZvcnRfc3RhdHVzJ107XG4gICAgICAgICAgICBpZiAoc3RhdHVzKSB7XG4gICAgICAgICAgICAgICAgY29uc3Qgc3RhdHVzU3BhbiA9IGl0ZW0uY3JlYXRlRWwoJ3NwYW4nLCB7XG4gICAgICAgICAgICAgICAgICAgIHRleHQ6IGAgLSAke3RoaXMuY2xlYW5WYWx1ZShzdGF0dXMpfWAsXG4gICAgICAgICAgICAgICAgICAgIGNsczogJ2V4b2NvcnRleC1zdGF0dXMnXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgcmVuZGVyVGFibGUoY29udGFpbmVyOiBIVE1MRWxlbWVudCwgZmlsZXM6IFRGaWxlW10sIGR2OiBhbnkpOiB2b2lkIHtcbiAgICAgICAgLy8gQ29sbGVjdCBhbGwgdW5pcXVlIHByb3BlcnRpZXNcbiAgICAgICAgY29uc3QgYWxsUHJvcHMgPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgICAgICAgZmlsZXMuZm9yRWFjaChmaWxlID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG1ldGFkYXRhID0gdGhpcy5hcHAubWV0YWRhdGFDYWNoZS5nZXRGaWxlQ2FjaGUoZmlsZSk7XG4gICAgICAgICAgICBpZiAobWV0YWRhdGE/LmZyb250bWF0dGVyKSB7XG4gICAgICAgICAgICAgICAgT2JqZWN0LmtleXMobWV0YWRhdGEuZnJvbnRtYXR0ZXIpLmZvckVhY2goa2V5ID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFrZXkuc3RhcnRzV2l0aCgnZXhvX19JbnN0YW5jZScpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBhbGxQcm9wcy5hZGQoa2V5KTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICAvLyBTZWxlY3QgbW9zdCByZWxldmFudCBwcm9wZXJ0aWVzIChtYXggNSlcbiAgICAgICAgY29uc3QgcmVsZXZhbnRQcm9wcyA9IEFycmF5LmZyb20oYWxsUHJvcHMpXG4gICAgICAgICAgICAuZmlsdGVyKHAgPT4gIXAuc3RhcnRzV2l0aCgnZXhvX19Bc3NldF91aWQnKSlcbiAgICAgICAgICAgIC5zbGljZSgwLCA1KTtcblxuICAgICAgICAvLyBDcmVhdGUgdGFibGVcbiAgICAgICAgY29uc3QgdGFibGUgPSBjb250YWluZXIuY3JlYXRlRWwoJ3RhYmxlJywgeyBjbHM6ICdleG9jb3J0ZXgtcXVlcnktdGFibGUnIH0pO1xuICAgICAgICBcbiAgICAgICAgLy8gSGVhZGVyXG4gICAgICAgIGNvbnN0IHRoZWFkID0gdGFibGUuY3JlYXRlRWwoJ3RoZWFkJyk7XG4gICAgICAgIGNvbnN0IGhlYWRlclJvdyA9IHRoZWFkLmNyZWF0ZUVsKCd0cicpO1xuICAgICAgICBoZWFkZXJSb3cuY3JlYXRlRWwoJ3RoJywgeyB0ZXh0OiAnTmFtZScgfSk7XG4gICAgICAgIHJlbGV2YW50UHJvcHMuZm9yRWFjaChwcm9wID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGRpc3BsYXlOYW1lID0gcHJvcC5yZXBsYWNlKC9fL2csICcgJykucmVwbGFjZSgvXlxcdytfXy8sICcnKTtcbiAgICAgICAgICAgIGhlYWRlclJvdy5jcmVhdGVFbCgndGgnLCB7IHRleHQ6IGRpc3BsYXlOYW1lIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBCb2R5XG4gICAgICAgIGNvbnN0IHRib2R5ID0gdGFibGUuY3JlYXRlRWwoJ3Rib2R5Jyk7XG4gICAgICAgIGZpbGVzLmZvckVhY2goZmlsZSA9PiB7XG4gICAgICAgICAgICBjb25zdCBtZXRhZGF0YSA9IHRoaXMuYXBwLm1ldGFkYXRhQ2FjaGUuZ2V0RmlsZUNhY2hlKGZpbGUpO1xuICAgICAgICAgICAgY29uc3QgZnJvbnRtYXR0ZXIgPSBtZXRhZGF0YT8uZnJvbnRtYXR0ZXIgfHwge307XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IHJvdyA9IHRib2R5LmNyZWF0ZUVsKCd0cicpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBOYW1lIGNlbGwgd2l0aCBsaW5rXG4gICAgICAgICAgICBjb25zdCBuYW1lQ2VsbCA9IHJvdy5jcmVhdGVFbCgndGQnKTtcbiAgICAgICAgICAgIG5hbWVDZWxsLmNyZWF0ZUVsKCdhJywge1xuICAgICAgICAgICAgICAgIHRleHQ6IGZyb250bWF0dGVyWydleG9fX0Fzc2V0X2xhYmVsJ10gfHwgZmlsZS5iYXNlbmFtZSxcbiAgICAgICAgICAgICAgICBocmVmOiBmaWxlLnBhdGgsXG4gICAgICAgICAgICAgICAgY2xzOiAnaW50ZXJuYWwtbGluaydcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBQcm9wZXJ0eSBjZWxsc1xuICAgICAgICAgICAgcmVsZXZhbnRQcm9wcy5mb3JFYWNoKHByb3AgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IGNlbGwgPSByb3cuY3JlYXRlRWwoJ3RkJyk7XG4gICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBmcm9udG1hdHRlcltwcm9wXTtcbiAgICAgICAgICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgICAgICAgICAgY2VsbC5zZXRUZXh0KHRoaXMuZm9ybWF0VmFsdWUodmFsdWUpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSByZW5kZXJDYXJkcyhjb250YWluZXI6IEhUTUxFbGVtZW50LCBmaWxlczogVEZpbGVbXSk6IHZvaWQge1xuICAgICAgICBjb25zdCBjYXJkc0NvbnRhaW5lciA9IGNvbnRhaW5lci5jcmVhdGVEaXYoeyBjbHM6ICdleG9jb3J0ZXgtcXVlcnktY2FyZHMnIH0pO1xuICAgICAgICBcbiAgICAgICAgZmlsZXMuZm9yRWFjaChmaWxlID0+IHtcbiAgICAgICAgICAgIGNvbnN0IG1ldGFkYXRhID0gdGhpcy5hcHAubWV0YWRhdGFDYWNoZS5nZXRGaWxlQ2FjaGUoZmlsZSk7XG4gICAgICAgICAgICBjb25zdCBmcm9udG1hdHRlciA9IG1ldGFkYXRhPy5mcm9udG1hdHRlciB8fCB7fTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3QgY2FyZCA9IGNhcmRzQ29udGFpbmVyLmNyZWF0ZURpdih7IGNsczogJ2V4b2NvcnRleC1jYXJkJyB9KTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gQ2FyZCBoZWFkZXJcbiAgICAgICAgICAgIGNvbnN0IGhlYWRlciA9IGNhcmQuY3JlYXRlRGl2KHsgY2xzOiAnZXhvY29ydGV4LWNhcmQtaGVhZGVyJyB9KTtcbiAgICAgICAgICAgIGhlYWRlci5jcmVhdGVFbCgnYScsIHtcbiAgICAgICAgICAgICAgICB0ZXh0OiBmcm9udG1hdHRlclsnZXhvX19Bc3NldF9sYWJlbCddIHx8IGZpbGUuYmFzZW5hbWUsXG4gICAgICAgICAgICAgICAgaHJlZjogZmlsZS5wYXRoLFxuICAgICAgICAgICAgICAgIGNsczogJ2ludGVybmFsLWxpbmsnXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gQ2FyZCBib2R5IHdpdGgga2V5IHByb3BlcnRpZXNcbiAgICAgICAgICAgIGNvbnN0IGJvZHkgPSBjYXJkLmNyZWF0ZURpdih7IGNsczogJ2V4b2NvcnRleC1jYXJkLWJvZHknIH0pO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBTaG93IHN0YXR1cyBpZiBhdmFpbGFibGVcbiAgICAgICAgICAgIGNvbnN0IHN0YXR1cyA9IGZyb250bWF0dGVyWydlbXNfX0VmZm9ydF9zdGF0dXMnXTtcbiAgICAgICAgICAgIGlmIChzdGF0dXMpIHtcbiAgICAgICAgICAgICAgICBib2R5LmNyZWF0ZUVsKCdkaXYnLCB7XG4gICAgICAgICAgICAgICAgICAgIHRleHQ6IGBTdGF0dXM6ICR7dGhpcy5jbGVhblZhbHVlKHN0YXR1cyl9YCxcbiAgICAgICAgICAgICAgICAgICAgY2xzOiAnZXhvY29ydGV4LWNhcmQtc3RhdHVzJ1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBTaG93IGRlc2NyaXB0aW9uIGlmIGF2YWlsYWJsZVxuICAgICAgICAgICAgY29uc3QgZGVzY3JpcHRpb24gPSBmcm9udG1hdHRlclsnZXhvX19Bc3NldF9kZXNjcmlwdGlvbiddO1xuICAgICAgICAgICAgaWYgKGRlc2NyaXB0aW9uKSB7XG4gICAgICAgICAgICAgICAgYm9keS5jcmVhdGVFbCgnZGl2Jywge1xuICAgICAgICAgICAgICAgICAgICB0ZXh0OiBkZXNjcmlwdGlvbixcbiAgICAgICAgICAgICAgICAgICAgY2xzOiAnZXhvY29ydGV4LWNhcmQtZGVzY3JpcHRpb24nXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2xlYW5WYWx1ZSh2YWx1ZTogYW55KTogc3RyaW5nIHtcbiAgICAgICAgaWYgKCF2YWx1ZSkgcmV0dXJuICcnO1xuICAgICAgICBjb25zdCBzdHIgPSBBcnJheS5pc0FycmF5KHZhbHVlKSA/IHZhbHVlWzBdIDogdmFsdWU7XG4gICAgICAgIHJldHVybiBzdHI/LnRvU3RyaW5nKCkucmVwbGFjZSgvXFxbXFxbfFxcXVxcXS9nLCAnJykgfHwgJyc7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBmb3JtYXRWYWx1ZSh2YWx1ZTogYW55KTogc3RyaW5nIHtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gdmFsdWUubWFwKHYgPT4gdGhpcy5jbGVhblZhbHVlKHYpKS5qb2luKCcsICcpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLmNsZWFuVmFsdWUodmFsdWUpO1xuICAgIH1cbn0iXSwidmVyc2lvbiI6M30=