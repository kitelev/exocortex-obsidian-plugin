5369ce4588447cde736105f9cbdd2eb8
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GetCurrentProjectUseCase = void 0;
const tslib_1 = require("tslib");
const ClassName_1 = require("../../domain/value-objects/ClassName");
/**
 * Use case for getting current project context
 * Implements intelligent project detection based on user context
 * Following TOGAF principles for business capability
 */
class GetCurrentProjectUseCase {
    constructor(assetRepository, focusService, graph) {
        this.assetRepository = assetRepository;
        this.focusService = focusService;
        this.graph = graph;
    }
    execute(request) {
        var _a, _b, _c, _d;
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                // Get all available projects
                const availableProjects = yield this.getAvailableProjects((_b = (_a = request.preferences) === null || _a === void 0 ? void 0 : _a.includeCompleted) !== null && _b !== void 0 ? _b : false, (_d = (_c = request.preferences) === null || _c === void 0 ? void 0 : _c.maxResults) !== null && _d !== void 0 ? _d : 10);
                // Detect current project based on context
                const currentProject = yield this.detectCurrentProject(request, availableProjects);
                // Determine detection strategy and confidence
                const context = this.buildContextInfo(request, currentProject);
                return {
                    success: true,
                    currentProject,
                    availableProjects,
                    context
                };
            }
            catch (error) {
                return {
                    success: false,
                    availableProjects: [],
                    context: {
                        strategy: 'error',
                        confidence: 0,
                        reasoning: `Failed to get project context: ${error.message}`
                    },
                    message: error.message
                };
            }
        });
    }
    /**
     * Get all available projects from the system
     */
    getAvailableProjects(includeCompleted, maxResults) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                // Find assets with Project class
                const projectClassName = ClassName_1.ClassName.create('ems__Project');
                if (projectClassName.isFailure) {
                    return [];
                }
                const projectAssets = yield this.assetRepository.findByClass(projectClassName.getValue());
                // Convert to response format and filter
                const projects = projectAssets
                    .filter(asset => {
                    if (!includeCompleted) {
                        const status = asset.getProperty('status');
                        return status !== 'completed' && status !== 'cancelled';
                    }
                    return true;
                })
                    .map(asset => ({
                    id: asset.getId().toString(),
                    title: asset.getTitle(),
                    status: asset.getProperty('status') || 'active',
                    priority: asset.getProperty('priority') || 'medium',
                    description: asset.getProperty('description'),
                    isActive: asset.getProperty('status') === 'active',
                    lastUpdated: asset.getProperty('updatedAt') || new Date().toISOString()
                }))
                    .sort((a, b) => {
                    // Sort by active status first, then by last updated
                    if (a.isActive && !b.isActive)
                        return -1;
                    if (!a.isActive && b.isActive)
                        return 1;
                    return new Date(b.lastUpdated).getTime() - new Date(a.lastUpdated).getTime();
                })
                    .slice(0, maxResults);
                return projects;
            }
            catch (error) {
                console.warn('Failed to get available projects:', error);
                return [];
            }
        });
    }
    /**
     * Detect current project based on context clues
     */
    detectCurrentProject(request, availableProjects) {
        var _a;
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const strategy = ((_a = request.preferences) === null || _a === void 0 ? void 0 : _a.selectionStrategy) || 'context';
            switch (strategy) {
                case 'context':
                    return this.detectByContext(request, availableProjects);
                case 'recent':
                    return this.detectByRecentActivity(availableProjects);
                case 'active':
                    return this.detectByActiveStatus(availableProjects);
                case 'priority':
                    return this.detectByPriority(availableProjects);
                default:
                    return this.detectByContext(request, availableProjects);
            }
        });
    }
    /**
     * Detect project by analyzing current file context
     */
    detectByContext(request, availableProjects) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (!request.activeFile) {
                return this.detectByRecentActivity(availableProjects);
            }
            try {
                // Check if current file is a project file
                const currentAsset = yield this.assetRepository.findByFilename(request.activeFile);
                if (currentAsset) {
                    const className = currentAsset.getClassName().toString();
                    if (className === 'ems__Project') {
                        return this.assetToProjectResponse(currentAsset);
                    }
                    // Check if current asset has project relationship
                    const projectId = currentAsset.getProperty('projectId') ||
                        currentAsset.getProperty('exo__Effort_parent');
                    if (projectId) {
                        const cleanProjectId = projectId.toString().replace(/\[\[|\]\]/g, '');
                        const project = availableProjects.find(p => p.id === cleanProjectId);
                        if (project) {
                            return project;
                        }
                    }
                }
                // Use RDF graph to find project relationships
                const projectFromGraph = yield this.findProjectFromGraph(request.activeFile, availableProjects);
                if (projectFromGraph) {
                    return projectFromGraph;
                }
                // Fallback to recent activity
                return this.detectByRecentActivity(availableProjects);
            }
            catch (error) {
                console.warn('Context-based project detection failed:', error);
                return this.detectByRecentActivity(availableProjects);
            }
        });
    }
    /**
     * Detect project using RDF graph relationships
     */
    findProjectFromGraph(activeFile, availableProjects) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                // Clean file path for IRI
                const fileIRI = activeFile.replace(/\.md$/, '').replace(/\s+/g, '_');
                // Query for project relationships
                const projectTriples = this.graph.query(fileIRI, 'exo__Effort_parent');
                if (projectTriples.length > 0) {
                    const projectIRI = projectTriples[0].getObject().toString();
                    const project = availableProjects.find(p => p.id === projectIRI || p.title.replace(/\s+/g, '_') === projectIRI);
                    if (project) {
                        return project;
                    }
                }
                // Check reverse relationships (project -> task)
                const taskTriples = this.graph.query(undefined, 'exo__Effort_parent', fileIRI);
                for (const triple of taskTriples) {
                    const potentialProject = triple.getSubject().toString();
                    const project = availableProjects.find(p => p.id === potentialProject || p.title.replace(/\s+/g, '_') === potentialProject);
                    if (project) {
                        return project;
                    }
                }
                return undefined;
            }
            catch (error) {
                console.warn('Graph-based project detection failed:', error);
                return undefined;
            }
        });
    }
    /**
     * Detect project by recent activity
     */
    detectByRecentActivity(availableProjects) {
        const recentProjects = availableProjects
            .filter(p => p.isActive)
            .sort((a, b) => new Date(b.lastUpdated).getTime() - new Date(a.lastUpdated).getTime());
        return recentProjects[0];
    }
    /**
     * Detect project by active status
     */
    detectByActiveStatus(availableProjects) {
        return availableProjects.find(p => p.isActive);
    }
    /**
     * Detect project by priority
     */
    detectByPriority(availableProjects) {
        const priorityOrder = { urgent: 4, high: 3, medium: 2, low: 1 };
        return availableProjects
            .filter(p => p.isActive)
            .sort((a, b) => (priorityOrder[b.priority] || 2) - (priorityOrder[a.priority] || 2))[0];
    }
    /**
     * Build context information for response
     */
    buildContextInfo(request, currentProject) {
        var _a;
        const strategy = ((_a = request.preferences) === null || _a === void 0 ? void 0 : _a.selectionStrategy) || 'context';
        let confidence = 0;
        let reasoning = '';
        if (currentProject) {
            switch (strategy) {
                case 'context':
                    confidence = request.activeFile ? 0.8 : 0.3;
                    reasoning = request.activeFile
                        ? `Detected from current file context: ${request.activeFile}`
                        : 'Used most recent active project';
                    break;
                case 'recent':
                    confidence = 0.6;
                    reasoning = 'Selected most recently updated active project';
                    break;
                case 'active':
                    confidence = 0.5;
                    reasoning = 'Selected first active project';
                    break;
                case 'priority':
                    confidence = 0.7;
                    reasoning = 'Selected highest priority active project';
                    break;
            }
        }
        else {
            reasoning = 'No suitable project found';
        }
        return {
            strategy,
            confidence,
            reasoning
        };
    }
    /**
     * Convert Asset to project response format
     */
    assetToProjectResponse(asset) {
        return {
            id: asset.getId().toString(),
            title: asset.getTitle(),
            status: asset.getProperty('status') || 'active',
            priority: asset.getProperty('priority') || 'medium',
            description: asset.getProperty('description')
        };
    }
}
exports.GetCurrentProjectUseCase = GetCurrentProjectUseCase;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2FwcGxpY2F0aW9uL3VzZS1jYXNlcy9HZXRDdXJyZW50UHJvamVjdFVzZUNhc2UudHMiLCJtYXBwaW5ncyI6Ijs7OztBQUVBLG9FQUFpRTtBQU9qRTs7OztHQUlHO0FBQ0gsTUFBYSx3QkFBd0I7SUFDbkMsWUFDbUIsZUFBaUMsRUFDakMsWUFBNkIsRUFDN0IsS0FBbUI7UUFGbkIsb0JBQWUsR0FBZixlQUFlLENBQWtCO1FBQ2pDLGlCQUFZLEdBQVosWUFBWSxDQUFpQjtRQUM3QixVQUFLLEdBQUwsS0FBSyxDQUFjO0lBQ25DLENBQUM7SUFFRSxPQUFPLENBQUMsT0FBaUM7OztZQUM3QyxJQUFJO2dCQUNGLDZCQUE2QjtnQkFDN0IsTUFBTSxpQkFBaUIsR0FBRyxNQUFNLElBQUksQ0FBQyxvQkFBb0IsQ0FDdkQsTUFBQSxNQUFBLE9BQU8sQ0FBQyxXQUFXLDBDQUFFLGdCQUFnQixtQ0FBSSxLQUFLLEVBQzlDLE1BQUEsTUFBQSxPQUFPLENBQUMsV0FBVywwQ0FBRSxVQUFVLG1DQUFJLEVBQUUsQ0FDdEMsQ0FBQztnQkFFRiwwQ0FBMEM7Z0JBQzFDLE1BQU0sY0FBYyxHQUFHLE1BQU0sSUFBSSxDQUFDLG9CQUFvQixDQUNwRCxPQUFPLEVBQ1AsaUJBQWlCLENBQ2xCLENBQUM7Z0JBRUYsOENBQThDO2dCQUM5QyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxFQUFFLGNBQWMsQ0FBQyxDQUFDO2dCQUUvRCxPQUFPO29CQUNMLE9BQU8sRUFBRSxJQUFJO29CQUNiLGNBQWM7b0JBQ2QsaUJBQWlCO29CQUNqQixPQUFPO2lCQUNSLENBQUM7YUFDSDtZQUFDLE9BQU8sS0FBSyxFQUFFO2dCQUNkLE9BQU87b0JBQ0wsT0FBTyxFQUFFLEtBQUs7b0JBQ2QsaUJBQWlCLEVBQUUsRUFBRTtvQkFDckIsT0FBTyxFQUFFO3dCQUNQLFFBQVEsRUFBRSxPQUFPO3dCQUNqQixV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LENBQUMsUUFBUSxDQUFDLElBQUksUUFBUTtZQUMvQyxRQUFRLEVBQUUsS0FBSyxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsSUFBSSxRQUFRO1lBQ25ELFdBQVcsRUFBRSxLQUFLLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQztTQUM5QyxDQUFDO0lBQ0osQ0FBQztDQUNGO0FBblRELDREQW1UQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva2l0ZWxldi9Eb2N1bWVudHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi9zcmMvYXBwbGljYXRpb24vdXNlLWNhc2VzL0dldEN1cnJlbnRQcm9qZWN0VXNlQ2FzZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBc3NldCB9IGZyb20gJy4uLy4uL2RvbWFpbi9lbnRpdGllcy9Bc3NldCc7XG5pbXBvcnQgeyBBc3NldElkIH0gZnJvbSAnLi4vLi4vZG9tYWluL3ZhbHVlLW9iamVjdHMvQXNzZXRJZCc7XG5pbXBvcnQgeyBDbGFzc05hbWUgfSBmcm9tICcuLi8uLi9kb21haW4vdmFsdWUtb2JqZWN0cy9DbGFzc05hbWUnO1xuaW1wb3J0IHsgSUFzc2V0UmVwb3NpdG9yeSB9IGZyb20gJy4uLy4uL2RvbWFpbi9yZXBvc2l0b3JpZXMvSUFzc2V0UmVwb3NpdG9yeSc7XG5pbXBvcnQgeyBFeG9Gb2N1c1NlcnZpY2UgfSBmcm9tICcuLi9zZXJ2aWNlcy9FeG9Gb2N1c1NlcnZpY2UnO1xuaW1wb3J0IHsgSW5kZXhlZEdyYXBoIH0gZnJvbSAnLi4vLi4vZG9tYWluL3NlbWFudGljL2NvcmUvSW5kZXhlZEdyYXBoJztcbmltcG9ydCB7IElSSSB9IGZyb20gJy4uLy4uL2RvbWFpbi9zZW1hbnRpYy9jb3JlL1RyaXBsZSc7XG5pbXBvcnQgeyBHZXRDdXJyZW50UHJvamVjdFJlcXVlc3QsIEdldEN1cnJlbnRQcm9qZWN0UmVzcG9uc2UgfSBmcm9tICcuLi9kdG9zL0NyZWF0ZVRhc2tSZXF1ZXN0JztcblxuLyoqXG4gKiBVc2UgY2FzZSBmb3IgZ2V0dGluZyBjdXJyZW50IHByb2plY3QgY29udGV4dFxuICogSW1wbGVtZW50cyBpbnRlbGxpZ2VudCBwcm9qZWN0IGRldGVjdGlvbiBiYXNlZCBvbiB1c2VyIGNvbnRleHRcbiAqIEZvbGxvd2luZyBUT0dBRiBwcmluY2lwbGVzIGZvciBidXNpbmVzcyBjYXBhYmlsaXR5XG4gKi9cbmV4cG9ydCBjbGFzcyBHZXRDdXJyZW50UHJvamVjdFVzZUNhc2Uge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGFzc2V0UmVwb3NpdG9yeTogSUFzc2V0UmVwb3NpdG9yeSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGZvY3VzU2VydmljZTogRXhvRm9jdXNTZXJ2aWNlLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgZ3JhcGg6IEluZGV4ZWRHcmFwaFxuICApIHt9XG5cbiAgYXN5bmMgZXhlY3V0ZShyZXF1ZXN0OiBHZXRDdXJyZW50UHJvamVjdFJlcXVlc3QpOiBQcm9taXNlPEdldEN1cnJlbnRQcm9qZWN0UmVzcG9uc2U+IHtcbiAgICB0cnkge1xuICAgICAgLy8gR2V0IGFsbCBhdmFpbGFibGUgcHJvamVjdHNcbiAgICAgIGNvbnN0IGF2YWlsYWJsZVByb2plY3RzID0gYXdhaXQgdGhpcy5nZXRBdmFpbGFibGVQcm9qZWN0cyhcbiAgICAgICAgcmVxdWVzdC5wcmVmZXJlbmNlcz8uaW5jbHVkZUNvbXBsZXRlZCA/PyBmYWxzZSxcbiAgICAgICAgcmVxdWVzdC5wcmVmZXJlbmNlcz8ubWF4UmVzdWx0cyA/PyAxMFxuICAgICAgKTtcblxuICAgICAgLy8gRGV0ZWN0IGN1cnJlbnQgcHJvamVjdCBiYXNlZCBvbiBjb250ZXh0XG4gICAgICBjb25zdCBjdXJyZW50UHJvamVjdCA9IGF3YWl0IHRoaXMuZGV0ZWN0Q3VycmVudFByb2plY3QoXG4gICAgICAgIHJlcXVlc3QsXG4gICAgICAgIGF2YWlsYWJsZVByb2plY3RzXG4gICAgICApO1xuXG4gICAgICAvLyBEZXRlcm1pbmUgZGV0ZWN0aW9uIHN0cmF0ZWd5IGFuZCBjb25maWRlbmNlXG4gICAgICBjb25zdCBjb250ZXh0ID0gdGhpcy5idWlsZENvbnRleHRJbmZvKHJlcXVlc3QsIGN1cnJlbnRQcm9qZWN0KTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgY3VycmVudFByb2plY3QsXG4gICAgICAgIGF2YWlsYWJsZVByb2plY3RzLFxuICAgICAgICBjb250ZXh0XG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgYXZhaWxhYmxlUHJvamVjdHM6IFtdLFxuICAgICAgICBjb250ZXh0OiB7XG4gICAgICAgICAgc3RyYXRlZ3k6ICdlcnJvcicsXG4gICAgICAgICAgY29uZmlkZW5jZTogMCxcbiAgICAgICAgICByZWFzb25pbmc6IGBGYWlsZWQgdG8gZ2V0IHByb2plY3QgY29udGV4dDogJHtlcnJvci5tZXNzYWdlfWBcbiAgICAgICAgfSxcbiAgICAgICAgbWVzc2FnZTogZXJyb3IubWVzc2FnZVxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IGFsbCBhdmFpbGFibGUgcHJvamVjdHMgZnJvbSB0aGUgc3lzdGVtXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGdldEF2YWlsYWJsZVByb2plY3RzKFxuICAgIGluY2x1ZGVDb21wbGV0ZWQ6IGJvb2xlYW4sXG4gICAgbWF4UmVzdWx0czogbnVtYmVyXG4gICk6IFByb21pc2U8R2V0Q3VycmVudFByb2plY3RSZXNwb25zZVsnYXZhaWxhYmxlUHJvamVjdHMnXT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBGaW5kIGFzc2V0cyB3aXRoIFByb2plY3QgY2xhc3NcbiAgICAgIGNvbnN0IHByb2plY3RDbGFzc05hbWUgPSBDbGFzc05hbWUuY3JlYXRlKCdlbXNfX1Byb2plY3QnKTtcbiAgICAgIGlmIChwcm9qZWN0Q2xhc3NOYW1lLmlzRmFpbHVyZSkge1xuICAgICAgICByZXR1cm4gW107XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHByb2plY3RBc3NldHMgPSBhd2FpdCB0aGlzLmFzc2V0UmVwb3NpdG9yeS5maW5kQnlDbGFzcyhcbiAgICAgICAgcHJvamVjdENsYXNzTmFtZS5nZXRWYWx1ZSgpXG4gICAgICApO1xuXG4gICAgICAvLyBDb252ZXJ0IHRvIHJlc3BvbnNlIGZvcm1hdCBhbmQgZmlsdGVyXG4gICAgICBjb25zdCBwcm9qZWN0cyA9IHByb2plY3RBc3NldHNcbiAgICAgICAgLmZpbHRlcihhc3NldCA9PiB7XG4gICAgICAgICAgaWYgKCFpbmNsdWRlQ29tcGxldGVkKSB7XG4gICAgICAgICAgICBjb25zdCBzdGF0dXMgPSBhc3NldC5nZXRQcm9wZXJ0eSgnc3RhdHVzJyk7XG4gICAgICAgICAgICByZXR1cm4gc3RhdHVzICE9PSAnY29tcGxldGVkJyAmJiBzdGF0dXMgIT09ICdjYW5jZWxsZWQnO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSlcbiAgICAgICAgLm1hcChhc3NldCA9PiAoe1xuICAgICAgICAgIGlkOiBhc3NldC5nZXRJZCgpLnRvU3RyaW5nKCksXG4gICAgICAgICAgdGl0bGU6IGFzc2V0LmdldFRpdGxlKCksXG4gICAgICAgICAgc3RhdHVzOiBhc3NldC5nZXRQcm9wZXJ0eSgnc3RhdHVzJykgfHwgJ2FjdGl2ZScsXG4gICAgICAgICAgcHJpb3JpdHk6IGFzc2V0LmdldFByb3BlcnR5KCdwcmlvcml0eScpIHx8ICdtZWRpdW0nLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiBhc3NldC5nZXRQcm9wZXJ0eSgnZGVzY3JpcHRpb24nKSxcbiAgICAgICAgICBpc0FjdGl2ZTogYXNzZXQuZ2V0UHJvcGVydHkoJ3N0YXR1cycpID09PSAnYWN0aXZlJyxcbiAgICAgICAgICBsYXN0VXBkYXRlZDogYXNzZXQuZ2V0UHJvcGVydHkoJ3VwZGF0ZWRBdCcpIHx8IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICAgICAgICB9KSlcbiAgICAgICAgLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgICAgICAvLyBTb3J0IGJ5IGFjdGl2ZSBzdGF0dXMgZmlyc3QsIHRoZW4gYnkgbGFzdCB1cGRhdGVkXG4gICAgICAgICAgaWYgKGEuaXNBY3RpdmUgJiYgIWIuaXNBY3RpdmUpIHJldHVybiAtMTtcbiAgICAgICAgICBpZiAoIWEuaXNBY3RpdmUgJiYgYi5pc0FjdGl2ZSkgcmV0dXJuIDE7XG4gICAgICAgICAgcmV0dXJuIG5ldyBEYXRlKGIubGFzdFVwZGF0ZWQpLmdldFRpbWUoKSAtIG5ldyBEYXRlKGEubGFzdFVwZGF0ZWQpLmdldFRpbWUoKTtcbiAgICAgICAgfSlcbiAgICAgICAgLnNsaWNlKDAsIG1heFJlc3VsdHMpO1xuXG4gICAgICByZXR1cm4gcHJvamVjdHM7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUud2FybignRmFpbGVkIHRvIGdldCBhdmFpbGFibGUgcHJvamVjdHM6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBEZXRlY3QgY3VycmVudCBwcm9qZWN0IGJhc2VkIG9uIGNvbnRleHQgY2x1ZXNcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZGV0ZWN0Q3VycmVudFByb2plY3QoXG4gICAgcmVxdWVzdDogR2V0Q3VycmVudFByb2plY3RSZXF1ZXN0LFxuICAgIGF2YWlsYWJsZVByb2plY3RzOiBHZXRDdXJyZW50UHJvamVjdFJlc3BvbnNlWydhdmFpbGFibGVQcm9qZWN0cyddXG4gICk6IFByb21pc2U8R2V0Q3VycmVudFByb2plY3RSZXNwb25zZVsnY3VycmVudFByb2plY3QnXSB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IHN0cmF0ZWd5ID0gcmVxdWVzdC5wcmVmZXJlbmNlcz8uc2VsZWN0aW9uU3RyYXRlZ3kgfHwgJ2NvbnRleHQnO1xuXG4gICAgc3dpdGNoIChzdHJhdGVneSkge1xuICAgICAgY2FzZSAnY29udGV4dCc6XG4gICAgICAgIHJldHVybiB0aGlzLmRldGVjdEJ5Q29udGV4dChyZXF1ZXN0LCBhdmFpbGFibGVQcm9qZWN0cyk7XG4gICAgICBjYXNlICdyZWNlbnQnOlxuICAgICAgICByZXR1cm4gdGhpcy5kZXRlY3RCeVJlY2VudEFjdGl2aXR5KGF2YWlsYWJsZVByb2plY3RzKTtcbiAgICAgIGNhc2UgJ2FjdGl2ZSc6XG4gICAgICAgIHJldHVybiB0aGlzLmRldGVjdEJ5QWN0aXZlU3RhdHVzKGF2YWlsYWJsZVByb2plY3RzKTtcbiAgICAgIGNhc2UgJ3ByaW9yaXR5JzpcbiAgICAgICAgcmV0dXJuIHRoaXMuZGV0ZWN0QnlQcmlvcml0eShhdmFpbGFibGVQcm9qZWN0cyk7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gdGhpcy5kZXRlY3RCeUNvbnRleHQocmVxdWVzdCwgYXZhaWxhYmxlUHJvamVjdHMpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBEZXRlY3QgcHJvamVjdCBieSBhbmFseXppbmcgY3VycmVudCBmaWxlIGNvbnRleHRcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZGV0ZWN0QnlDb250ZXh0KFxuICAgIHJlcXVlc3Q6IEdldEN1cnJlbnRQcm9qZWN0UmVxdWVzdCxcbiAgICBhdmFpbGFibGVQcm9qZWN0czogR2V0Q3VycmVudFByb2plY3RSZXNwb25zZVsnYXZhaWxhYmxlUHJvamVjdHMnXVxuICApOiBQcm9taXNlPEdldEN1cnJlbnRQcm9qZWN0UmVzcG9uc2VbJ2N1cnJlbnRQcm9qZWN0J10gfCB1bmRlZmluZWQ+IHtcbiAgICBpZiAoIXJlcXVlc3QuYWN0aXZlRmlsZSkge1xuICAgICAgcmV0dXJuIHRoaXMuZGV0ZWN0QnlSZWNlbnRBY3Rpdml0eShhdmFpbGFibGVQcm9qZWN0cyk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIC8vIENoZWNrIGlmIGN1cnJlbnQgZmlsZSBpcyBhIHByb2plY3QgZmlsZVxuICAgICAgY29uc3QgY3VycmVudEFzc2V0ID0gYXdhaXQgdGhpcy5hc3NldFJlcG9zaXRvcnkuZmluZEJ5RmlsZW5hbWUocmVxdWVzdC5hY3RpdmVGaWxlKTtcbiAgICAgIGlmIChjdXJyZW50QXNzZXQpIHtcbiAgICAgICAgY29uc3QgY2xhc3NOYW1lID0gY3VycmVudEFzc2V0LmdldENsYXNzTmFtZSgpLnRvU3RyaW5nKCk7XG4gICAgICAgIGlmIChjbGFzc05hbWUgPT09ICdlbXNfX1Byb2plY3QnKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuYXNzZXRUb1Byb2plY3RSZXNwb25zZShjdXJyZW50QXNzZXQpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ2hlY2sgaWYgY3VycmVudCBhc3NldCBoYXMgcHJvamVjdCByZWxhdGlvbnNoaXBcbiAgICAgICAgY29uc3QgcHJvamVjdElkID0gY3VycmVudEFzc2V0LmdldFByb3BlcnR5KCdwcm9qZWN0SWQnKSB8fCBcbiAgICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50QXNzZXQuZ2V0UHJvcGVydHkoJ2V4b19fRWZmb3J0X3BhcmVudCcpO1xuICAgICAgICBpZiAocHJvamVjdElkKSB7XG4gICAgICAgICAgY29uc3QgY2xlYW5Qcm9qZWN0SWQgPSBwcm9qZWN0SWQudG9TdHJpbmcoKS5yZXBsYWNlKC9cXFtcXFt8XFxdXFxdL2csICcnKTtcbiAgICAgICAgICBjb25zdCBwcm9qZWN0ID0gYXZhaWxhYmxlUHJvamVjdHMuZmluZChwID0+IHAuaWQgPT09IGNsZWFuUHJvamVjdElkKTtcbiAgICAgICAgICBpZiAocHJvamVjdCkge1xuICAgICAgICAgICAgcmV0dXJuIHByb2plY3Q7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFVzZSBSREYgZ3JhcGggdG8gZmluZCBwcm9qZWN0IHJlbGF0aW9uc2hpcHNcbiAgICAgIGNvbnN0IHByb2plY3RGcm9tR3JhcGggPSBhd2FpdCB0aGlzLmZpbmRQcm9qZWN0RnJvbUdyYXBoKHJlcXVlc3QuYWN0aXZlRmlsZSwgYXZhaWxhYmxlUHJvamVjdHMpO1xuICAgICAgaWYgKHByb2plY3RGcm9tR3JhcGgpIHtcbiAgICAgICAgcmV0dXJuIHByb2plY3RGcm9tR3JhcGg7XG4gICAgICB9XG5cbiAgICAgIC8vIEZhbGxiYWNrIHRvIHJlY2VudCBhY3Rpdml0eVxuICAgICAgcmV0dXJuIHRoaXMuZGV0ZWN0QnlSZWNlbnRBY3Rpdml0eShhdmFpbGFibGVQcm9qZWN0cyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUud2FybignQ29udGV4dC1iYXNlZCBwcm9qZWN0IGRldGVjdGlvbiBmYWlsZWQ6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIHRoaXMuZGV0ZWN0QnlSZWNlbnRBY3Rpdml0eShhdmFpbGFibGVQcm9qZWN0cyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIERldGVjdCBwcm9qZWN0IHVzaW5nIFJERiBncmFwaCByZWxhdGlvbnNoaXBzXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGZpbmRQcm9qZWN0RnJvbUdyYXBoKFxuICAgIGFjdGl2ZUZpbGU6IHN0cmluZyxcbiAgICBhdmFpbGFibGVQcm9qZWN0czogR2V0Q3VycmVudFByb2plY3RSZXNwb25zZVsnYXZhaWxhYmxlUHJvamVjdHMnXVxuICApOiBQcm9taXNlPEdldEN1cnJlbnRQcm9qZWN0UmVzcG9uc2VbJ2N1cnJlbnRQcm9qZWN0J10gfCB1bmRlZmluZWQ+IHtcbiAgICB0cnkge1xuICAgICAgLy8gQ2xlYW4gZmlsZSBwYXRoIGZvciBJUklcbiAgICAgIGNvbnN0IGZpbGVJUkkgPSBhY3RpdmVGaWxlLnJlcGxhY2UoL1xcLm1kJC8sICcnKS5yZXBsYWNlKC9cXHMrL2csICdfJyk7XG5cbiAgICAgIC8vIFF1ZXJ5IGZvciBwcm9qZWN0IHJlbGF0aW9uc2hpcHNcbiAgICAgIGNvbnN0IHByb2plY3RUcmlwbGVzID0gdGhpcy5ncmFwaC5xdWVyeShcbiAgICAgICAgZmlsZUlSSSxcbiAgICAgICAgJ2V4b19fRWZmb3J0X3BhcmVudCdcbiAgICAgICk7XG5cbiAgICAgIGlmIChwcm9qZWN0VHJpcGxlcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGNvbnN0IHByb2plY3RJUkkgPSBwcm9qZWN0VHJpcGxlc1swXS5nZXRPYmplY3QoKS50b1N0cmluZygpO1xuICAgICAgICBjb25zdCBwcm9qZWN0ID0gYXZhaWxhYmxlUHJvamVjdHMuZmluZChwID0+IFxuICAgICAgICAgIHAuaWQgPT09IHByb2plY3RJUkkgfHwgcC50aXRsZS5yZXBsYWNlKC9cXHMrL2csICdfJykgPT09IHByb2plY3RJUklcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKHByb2plY3QpIHtcbiAgICAgICAgICByZXR1cm4gcHJvamVjdDtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayByZXZlcnNlIHJlbGF0aW9uc2hpcHMgKHByb2plY3QgLT4gdGFzaylcbiAgICAgIGNvbnN0IHRhc2tUcmlwbGVzID0gdGhpcy5ncmFwaC5xdWVyeShcbiAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICAnZXhvX19FZmZvcnRfcGFyZW50JyxcbiAgICAgICAgZmlsZUlSSVxuICAgICAgKTtcblxuICAgICAgZm9yIChjb25zdCB0cmlwbGUgb2YgdGFza1RyaXBsZXMpIHtcbiAgICAgICAgY29uc3QgcG90ZW50aWFsUHJvamVjdCA9IHRyaXBsZS5nZXRTdWJqZWN0KCkudG9TdHJpbmcoKTtcbiAgICAgICAgY29uc3QgcHJvamVjdCA9IGF2YWlsYWJsZVByb2plY3RzLmZpbmQocCA9PiBcbiAgICAgICAgICBwLmlkID09PSBwb3RlbnRpYWxQcm9qZWN0IHx8IHAudGl0bGUucmVwbGFjZSgvXFxzKy9nLCAnXycpID09PSBwb3RlbnRpYWxQcm9qZWN0XG4gICAgICAgICk7XG4gICAgICAgIGlmIChwcm9qZWN0KSB7XG4gICAgICAgICAgcmV0dXJuIHByb2plY3Q7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKCdHcmFwaC1iYXNlZCBwcm9qZWN0IGRldGVjdGlvbiBmYWlsZWQ6JywgZXJyb3IpO1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuXG4gIC8qKlxuICAgKiBEZXRlY3QgcHJvamVjdCBieSByZWNlbnQgYWN0aXZpdHlcbiAgICovXG4gIHByaXZhdGUgZGV0ZWN0QnlSZWNlbnRBY3Rpdml0eShcbiAgICBhdmFpbGFibGVQcm9qZWN0czogR2V0Q3VycmVudFByb2plY3RSZXNwb25zZVsnYXZhaWxhYmxlUHJvamVjdHMnXVxuICApOiBHZXRDdXJyZW50UHJvamVjdFJlc3BvbnNlWydjdXJyZW50UHJvamVjdCddIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCByZWNlbnRQcm9qZWN0cyA9IGF2YWlsYWJsZVByb2plY3RzXG4gICAgICAuZmlsdGVyKHAgPT4gcC5pc0FjdGl2ZSlcbiAgICAgIC5zb3J0KChhLCBiKSA9PiBuZXcgRGF0ZShiLmxhc3RVcGRhdGVkKS5nZXRUaW1lKCkgLSBuZXcgRGF0ZShhLmxhc3RVcGRhdGVkKS5nZXRUaW1lKCkpO1xuXG4gICAgcmV0dXJuIHJlY2VudFByb2plY3RzWzBdO1xuICB9XG5cbiAgLyoqXG4gICAqIERldGVjdCBwcm9qZWN0IGJ5IGFjdGl2ZSBzdGF0dXNcbiAgICovXG4gIHByaXZhdGUgZGV0ZWN0QnlBY3RpdmVTdGF0dXMoXG4gICAgYXZhaWxhYmxlUHJvamVjdHM6IEdldEN1cnJlbnRQcm9qZWN0UmVzcG9uc2VbJ2F2YWlsYWJsZVByb2plY3RzJ11cbiAgKTogR2V0Q3VycmVudFByb2plY3RSZXNwb25zZVsnY3VycmVudFByb2plY3QnXSB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIGF2YWlsYWJsZVByb2plY3RzLmZpbmQocCA9PiBwLmlzQWN0aXZlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZXRlY3QgcHJvamVjdCBieSBwcmlvcml0eVxuICAgKi9cbiAgcHJpdmF0ZSBkZXRlY3RCeVByaW9yaXR5KFxuICAgIGF2YWlsYWJsZVByb2plY3RzOiBHZXRDdXJyZW50UHJvamVjdFJlc3BvbnNlWydhdmFpbGFibGVQcm9qZWN0cyddXG4gICk6IEdldEN1cnJlbnRQcm9qZWN0UmVzcG9uc2VbJ2N1cnJlbnRQcm9qZWN0J10gfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHByaW9yaXR5T3JkZXI6IFJlY29yZDxzdHJpbmcsIG51bWJlcj4gPSB7IHVyZ2VudDogNCwgaGlnaDogMywgbWVkaXVtOiAyLCBsb3c6IDEgfTtcbiAgICBcbiAgICByZXR1cm4gYXZhaWxhYmxlUHJvamVjdHNcbiAgICAgIC5maWx0ZXIocCA9PiBwLmlzQWN0aXZlKVxuICAgICAgLnNvcnQoKGEsIGIpID0+IChwcmlvcml0eU9yZGVyW2IucHJpb3JpdHldIHx8IDIpIC0gKHByaW9yaXR5T3JkZXJbYS5wcmlvcml0eV0gfHwgMikpWzBdO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1aWxkIGNvbnRleHQgaW5mb3JtYXRpb24gZm9yIHJlc3BvbnNlXG4gICAqL1xuICBwcml2YXRlIGJ1aWxkQ29udGV4dEluZm8oXG4gICAgcmVxdWVzdDogR2V0Q3VycmVudFByb2plY3RSZXF1ZXN0LFxuICAgIGN1cnJlbnRQcm9qZWN0PzogR2V0Q3VycmVudFByb2plY3RSZXNwb25zZVsnY3VycmVudFByb2plY3QnXVxuICApOiBHZXRDdXJyZW50UHJvamVjdFJlc3BvbnNlWydjb250ZXh0J10ge1xuICAgIGNvbnN0IHN0cmF0ZWd5ID0gcmVxdWVzdC5wcmVmZXJlbmNlcz8uc2VsZWN0aW9uU3RyYXRlZ3kgfHwgJ2NvbnRleHQnO1xuICAgIFxuICAgIGxldCBjb25maWRlbmNlID0gMDtcbiAgICBsZXQgcmVhc29uaW5nID0gJyc7XG5cbiAgICBpZiAoY3VycmVudFByb2plY3QpIHtcbiAgICAgIHN3aXRjaCAoc3RyYXRlZ3kpIHtcbiAgICAgICAgY2FzZSAnY29udGV4dCc6XG4gICAgICAgICAgY29uZmlkZW5jZSA9IHJlcXVlc3QuYWN0aXZlRmlsZSA/IDAuOCA6IDAuMztcbiAgICAgICAgICByZWFzb25pbmcgPSByZXF1ZXN0LmFjdGl2ZUZpbGUgXG4gICAgICAgICAgICA/IGBEZXRlY3RlZCBmcm9tIGN1cnJlbnQgZmlsZSBjb250ZXh0OiAke3JlcXVlc3QuYWN0aXZlRmlsZX1gXG4gICAgICAgICAgICA6ICdVc2VkIG1vc3QgcmVjZW50IGFjdGl2ZSBwcm9qZWN0JztcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAncmVjZW50JzpcbiAgICAgICAgICBjb25maWRlbmNlID0gMC42O1xuICAgICAgICAgIHJlYXNvbmluZyA9ICdTZWxlY3RlZCBtb3N0IHJlY2VudGx5IHVwZGF0ZWQgYWN0aXZlIHByb2plY3QnO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdhY3RpdmUnOlxuICAgICAgICAgIGNvbmZpZGVuY2UgPSAwLjU7XG4gICAgICAgICAgcmVhc29uaW5nID0gJ1NlbGVjdGVkIGZpcnN0IGFjdGl2ZSBwcm9qZWN0JztcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAncHJpb3JpdHknOlxuICAgICAgICAgIGNvbmZpZGVuY2UgPSAwLjc7XG4gICAgICAgICAgcmVhc29uaW5nID0gJ1NlbGVjdGVkIGhpZ2hlc3QgcHJpb3JpdHkgYWN0aXZlIHByb2plY3QnO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZWFzb25pbmcgPSAnTm8gc3VpdGFibGUgcHJvamVjdCBmb3VuZCc7XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0cmF0ZWd5LFxuICAgICAgY29uZmlkZW5jZSxcbiAgICAgIHJlYXNvbmluZ1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQ29udmVydCBBc3NldCB0byBwcm9qZWN0IHJlc3BvbnNlIGZvcm1hdFxuICAgKi9cbiAgcHJpdmF0ZSBhc3NldFRvUHJvamVjdFJlc3BvbnNlKGFzc2V0OiBBc3NldCk6IEdldEN1cnJlbnRQcm9qZWN0UmVzcG9uc2VbJ2N1cnJlbnRQcm9qZWN0J10ge1xuICAgIHJldHVybiB7XG4gICAgICBpZDogYXNzZXQuZ2V0SWQoKS50b1N0cmluZygpLFxuICAgICAgdGl0bGU6IGFzc2V0LmdldFRpdGxlKCksXG4gICAgICBzdGF0dXM6IGFzc2V0LmdldFByb3BlcnR5KCdzdGF0dXMnKSB8fCAnYWN0aXZlJyxcbiAgICAgIHByaW9yaXR5OiBhc3NldC5nZXRQcm9wZXJ0eSgncHJpb3JpdHknKSB8fCAnbWVkaXVtJyxcbiAgICAgIGRlc2NyaXB0aW9uOiBhc3NldC5nZXRQcm9wZXJ0eSgnZGVzY3JpcHRpb24nKVxuICAgIH07XG4gIH1cbn0iXSwidmVyc2lvbiI6M30=