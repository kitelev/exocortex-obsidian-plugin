f8e3b295dcb59b7bd7f8c42691c5227c
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ObsidianClassViewRepository = void 0;
const obsidian_1 = require("obsidian");
const ClassView_1 = require("../../domain/aggregates/ClassView");
const ClassName_1 = require("../../domain/value-objects/ClassName");
const AssetId_1 = require("../../domain/value-objects/AssetId");
const Result_1 = require("../../domain/core/Result");
const UIButton_1 = require("../../domain/entities/UIButton");
/**
 * Obsidian implementation of ClassView repository
 * Maps between domain entities and Obsidian vault files
 */
class ObsidianClassViewRepository {
    constructor(app) {
        this.app = app;
    }
    async findByClassName(className) {
        try {
            const files = this.app.vault.getMarkdownFiles();
            for (const file of files) {
                const metadata = this.app.metadataCache.getFileCache(file);
                if (!metadata?.frontmatter)
                    continue;
                const instanceClass = metadata.frontmatter["exo__Instance_class"];
                if (instanceClass !== "[[ui__ClassView]]")
                    continue;
                const targetClass = metadata.frontmatter["ui__ClassView_targetClass"];
                if (!targetClass)
                    continue;
                const cleanTargetClass = this.cleanAssetReference(targetClass);
                if (cleanTargetClass !== className.value)
                    continue;
                // Found the ClassView for this class
                return this.buildClassViewFromFile(file);
            }
            return Result_1.Result.ok(null);
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to find ClassView: ${error.message}`);
        }
    }
    async findById(id) {
        try {
            const file = this.app.vault.getAbstractFileByPath(id.toString() + ".md");
            if (!file || !(file instanceof obsidian_1.TFile)) {
                return Result_1.Result.ok(null);
            }
            return this.buildClassViewFromFile(file);
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to find ClassView by ID: ${error.message}`);
        }
    }
    async save(classView) {
        try {
            const filePath = `${classView.id.toString()}.md`;
            const content = this.serializeClassView(classView);
            const existingFile = this.app.vault.getAbstractFileByPath(filePath);
            if (existingFile instanceof obsidian_1.TFile) {
                await this.app.vault.modify(existingFile, content);
            }
            else {
                await this.app.vault.create(filePath, content);
            }
            return Result_1.Result.ok();
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to save ClassView: ${error.message}`);
        }
    }
    async delete(id) {
        try {
            const file = this.app.vault.getAbstractFileByPath(id.toString() + ".md");
            if (file instanceof obsidian_1.TFile) {
                await this.app.vault.delete(file);
            }
            return Result_1.Result.ok();
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to delete ClassView: ${error.message}`);
        }
    }
    async findAll() {
        try {
            const classViews = [];
            const files = this.app.vault.getMarkdownFiles();
            for (const file of files) {
                const metadata = this.app.metadataCache.getFileCache(file);
                if (!metadata?.frontmatter)
                    continue;
                const instanceClass = metadata.frontmatter["exo__Instance_class"];
                if (instanceClass !== "[[ui__ClassView]]")
                    continue;
                const result = await this.buildClassViewFromFile(file);
                if (result.isSuccess && result.getValue()) {
                    classViews.push(result.getValue());
                }
            }
            return Result_1.Result.ok(classViews);
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to find all ClassViews: ${error.message}`);
        }
    }
    async exists(className) {
        const result = await this.findByClassName(className);
        if (result.isFailure) {
            return Result_1.Result.fail(result.error);
        }
        return Result_1.Result.ok(result.getValue() !== null);
    }
    async buildClassViewFromFile(file) {
        try {
            const metadata = this.app.metadataCache.getFileCache(file);
            if (!metadata?.frontmatter) {
                return Result_1.Result.ok(null);
            }
            const fm = metadata.frontmatter;
            // Parse target class
            const targetClass = fm["ui__ClassView_targetClass"];
            if (!targetClass) {
                return Result_1.Result.ok(null);
            }
            const classNameResult = ClassName_1.ClassName.create(this.cleanAssetReference(targetClass));
            if (classNameResult.isFailure) {
                return Result_1.Result.fail(classNameResult.error);
            }
            // Parse buttons
            const buttonRefs = fm["ui__ClassView_buttons"] || [];
            const buttons = [];
            for (const buttonRef of this.ensureArray(buttonRefs)) {
                const buttonResult = await this.loadButton(this.cleanAssetReference(buttonRef));
                if (buttonResult.isSuccess && buttonResult.getValue()) {
                    buttons.push(buttonResult.getValue());
                }
            }
            // Parse display options
            const displayOptions = {
                showProperties: fm["ui__ClassView_showProperties"] !== false,
                showRelations: fm["ui__ClassView_showRelations"] !== false,
                showBacklinks: fm["ui__ClassView_showBacklinks"] !== false,
                showButtons: fm["ui__ClassView_showButtons"] !== false,
                buttonPosition: fm["ui__ClassView_buttonPosition"] || "top",
            };
            // Create ClassView
            const idResult = AssetId_1.AssetId.create(file.basename);
            if (idResult.isFailure) {
                return Result_1.Result.fail(idResult.error);
            }
            const classViewResult = ClassView_1.ClassView.create({
                id: idResult.getValue(),
                className: classNameResult.getValue(),
                buttons: buttons,
                layoutTemplate: fm["ui__ClassView_template"],
                displayOptions: displayOptions,
            });
            if (classViewResult.isFailure) {
                return Result_1.Result.fail(classViewResult.error);
            }
            return Result_1.Result.ok(classViewResult.getValue());
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to build ClassView: ${error.message}`);
        }
    }
    async loadButton(buttonName) {
        try {
            const file = this.app.vault.getAbstractFileByPath(buttonName + ".md");
            if (!file || !(file instanceof obsidian_1.TFile)) {
                return Result_1.Result.ok(null);
            }
            const metadata = this.app.metadataCache.getFileCache(file);
            if (!metadata?.frontmatter) {
                return Result_1.Result.ok(null);
            }
            const fm = metadata.frontmatter;
            const idResult = AssetId_1.AssetId.create(file.basename);
            const commandIdResult = AssetId_1.AssetId.create(this.cleanAssetReference(fm["ui__Button_command"] || ""));
            if (idResult.isFailure || commandIdResult.isFailure) {
                return Result_1.Result.ok(null);
            }
            const buttonResult = UIButton_1.UIButton.create({
                id: idResult.getValue(),
                label: fm["ui__Button_label"] || file.basename,
                commandId: commandIdResult.getValue(),
                order: fm["ui__Button_order"] || 0,
                isEnabled: fm["ui__Button_enabled"] !== false,
                tooltip: fm["ui__Button_tooltip"],
            });
            if (buttonResult.isFailure) {
                return Result_1.Result.fail(buttonResult.error);
            }
            return Result_1.Result.ok(buttonResult.getValue());
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to load button: ${error.message}`);
        }
    }
    serializeClassView(classView) {
        const frontmatter = {
            exo__Instance_class: "[[ui__ClassView]]",
            ui__ClassView_targetClass: `[[${classView.className.value}]]`,
            ui__ClassView_buttons: classView.buttons.map((b) => `[[${b.id.toString()}]]`),
            ui__ClassView_showProperties: classView.displayOptions.showProperties,
            ui__ClassView_showRelations: classView.displayOptions.showRelations,
            ui__ClassView_showBacklinks: classView.displayOptions.showBacklinks,
            ui__ClassView_showButtons: classView.displayOptions.showButtons,
            ui__ClassView_buttonPosition: classView.displayOptions.buttonPosition,
        };
        const yamlContent = this.toYaml(frontmatter);
        return `---\n${yamlContent}---\n\n# ClassView: ${classView.className.value}\n`;
    }
    cleanAssetReference(ref) {
        if (typeof ref !== "string")
            return "";
        return ref.replace(/\[\[|\]\]/g, "").trim();
    }
    ensureArray(value) {
        if (Array.isArray(value))
            return value;
        if (value)
            return [value];
        return [];
    }
    toYaml(obj) {
        // Simple YAML serialization
        return (Object.entries(obj)
            .map(([key, value]) => {
            if (Array.isArray(value)) {
                return `${key}:\n${value.map((v) => `  - ${v}`).join("\n")}`;
            }
            return `${key}: ${value}`;
        })
            .join("\n") + "\n");
    }
}
exports.ObsidianClassViewRepository = ObsidianClassViewRepository;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2luZnJhc3RydWN0dXJlL3JlcG9zaXRvcmllcy9PYnNpZGlhbkNsYXNzVmlld1JlcG9zaXRvcnkudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQUEsdUNBQXNDO0FBRXRDLGlFQUE4RTtBQUM5RSxvRUFBaUU7QUFDakUsZ0VBQTZEO0FBQzdELHFEQUFrRDtBQUNsRCw2REFBMEQ7QUFFMUQ7OztHQUdHO0FBQ0gsTUFBYSwyQkFBMkI7SUFDdEMsWUFBb0IsR0FBUTtRQUFSLFFBQUcsR0FBSCxHQUFHLENBQUs7SUFBRyxDQUFDO0lBRWhDLEtBQUssQ0FBQyxlQUFlLENBQ25CLFNBQW9CO1FBRXBCLElBQUk7WUFDRixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBRWhELEtBQUssTUFBTSxJQUFJLElBQUksS0FBSyxFQUFFO2dCQUN4QixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQzNELElBQUksQ0FBQyxRQUFRLEVBQUUsV0FBVztvQkFBRSxTQUFTO2dCQUVyQyxNQUFNLGFBQWEsR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDLHFCQUFxQixDQUFDLENBQUM7Z0JBQ2xFLElBQUksYUFBYSxLQUFLLG1CQUFtQjtvQkFBRSxTQUFTO2dCQUVwRCxNQUFNLFdBQVcsR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDLDJCQUEyQixDQUFDLENBQUM7Z0JBQ3RFLElBQUksQ0FBQyxXQUFXO29CQUFFLFNBQVM7Z0JBRTNCLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFdBQVcsQ0FBQyxDQUFDO2dCQUMvRCxJQUFJLGdCQUFnQixLQUFLLFNBQVMsQ0FBQyxLQUFLO29CQUFFLFNBQVM7Z0JBRW5ELHFDQUFxQztnQkFDckMsT0FBTyxJQUFJLENB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dHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi9zcmMvaW5mcmFzdHJ1Y3R1cmUvcmVwb3NpdG9yaWVzL09ic2lkaWFuQ2xhc3NWaWV3UmVwb3NpdG9yeS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHAsIFRGaWxlIH0gZnJvbSBcIm9ic2lkaWFuXCI7XG5pbXBvcnQgeyBJQ2xhc3NWaWV3UmVwb3NpdG9yeSB9IGZyb20gXCIuLi8uLi9kb21haW4vcmVwb3NpdG9yaWVzL0lDbGFzc1ZpZXdSZXBvc2l0b3J5XCI7XG5pbXBvcnQgeyBDbGFzc1ZpZXcsIERpc3BsYXlPcHRpb25zIH0gZnJvbSBcIi4uLy4uL2RvbWFpbi9hZ2dyZWdhdGVzL0NsYXNzVmlld1wiO1xuaW1wb3J0IHsgQ2xhc3NOYW1lIH0gZnJvbSBcIi4uLy4uL2RvbWFpbi92YWx1ZS1vYmplY3RzL0NsYXNzTmFtZVwiO1xuaW1wb3J0IHsgQXNzZXRJZCB9IGZyb20gXCIuLi8uLi9kb21haW4vdmFsdWUtb2JqZWN0cy9Bc3NldElkXCI7XG5pbXBvcnQgeyBSZXN1bHQgfSBmcm9tIFwiLi4vLi4vZG9tYWluL2NvcmUvUmVzdWx0XCI7XG5pbXBvcnQgeyBVSUJ1dHRvbiB9IGZyb20gXCIuLi8uLi9kb21haW4vZW50aXRpZXMvVUlCdXR0b25cIjtcblxuLyoqXG4gKiBPYnNpZGlhbiBpbXBsZW1lbnRhdGlvbiBvZiBDbGFzc1ZpZXcgcmVwb3NpdG9yeVxuICogTWFwcyBiZXR3ZWVuIGRvbWFpbiBlbnRpdGllcyBhbmQgT2JzaWRpYW4gdmF1bHQgZmlsZXNcbiAqL1xuZXhwb3J0IGNsYXNzIE9ic2lkaWFuQ2xhc3NWaWV3UmVwb3NpdG9yeSBpbXBsZW1lbnRzIElDbGFzc1ZpZXdSZXBvc2l0b3J5IHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBhcHA6IEFwcCkge31cblxuICBhc3luYyBmaW5kQnlDbGFzc05hbWUoXG4gICAgY2xhc3NOYW1lOiBDbGFzc05hbWUsXG4gICk6IFByb21pc2U8UmVzdWx0PENsYXNzVmlldyB8IG51bGw+PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZpbGVzID0gdGhpcy5hcHAudmF1bHQuZ2V0TWFya2Rvd25GaWxlcygpO1xuXG4gICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZXMpIHtcbiAgICAgICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLmFwcC5tZXRhZGF0YUNhY2hlLmdldEZpbGVDYWNoZShmaWxlKTtcbiAgICAgICAgaWYgKCFtZXRhZGF0YT8uZnJvbnRtYXR0ZXIpIGNvbnRpbnVlO1xuXG4gICAgICAgIGNvbnN0IGluc3RhbmNlQ2xhc3MgPSBtZXRhZGF0YS5mcm9udG1hdHRlcltcImV4b19fSW5zdGFuY2VfY2xhc3NcIl07XG4gICAgICAgIGlmIChpbnN0YW5jZUNsYXNzICE9PSBcIltbdWlfX0NsYXNzVmlld11dXCIpIGNvbnRpbnVlO1xuXG4gICAgICAgIGNvbnN0IHRhcmdldENsYXNzID0gbWV0YWRhdGEuZnJvbnRtYXR0ZXJbXCJ1aV9fQ2xhc3NWaWV3X3RhcmdldENsYXNzXCJdO1xuICAgICAgICBpZiAoIXRhcmdldENsYXNzKSBjb250aW51ZTtcblxuICAgICAgICBjb25zdCBjbGVhblRhcmdldENsYXNzID0gdGhpcy5jbGVhbkFzc2V0UmVmZXJlbmNlKHRhcmdldENsYXNzKTtcbiAgICAgICAgaWYgKGNsZWFuVGFyZ2V0Q2xhc3MgIT09IGNsYXNzTmFtZS52YWx1ZSkgY29udGludWU7XG5cbiAgICAgICAgLy8gRm91bmQgdGhlIENsYXNzVmlldyBmb3IgdGhpcyBjbGFzc1xuICAgICAgICByZXR1cm4gdGhpcy5idWlsZENsYXNzVmlld0Zyb21GaWxlKGZpbGUpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gUmVzdWx0Lm9rPENsYXNzVmlldyB8IG51bGw+KG51bGwpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8Q2xhc3NWaWV3IHwgbnVsbD4oXG4gICAgICAgIGBGYWlsZWQgdG8gZmluZCBDbGFzc1ZpZXc6ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBmaW5kQnlJZChpZDogQXNzZXRJZCk6IFByb21pc2U8UmVzdWx0PENsYXNzVmlldyB8IG51bGw+PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZpbGUgPSB0aGlzLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoaWQudG9TdHJpbmcoKSArIFwiLm1kXCIpO1xuICAgICAgaWYgKCFmaWxlIHx8ICEoZmlsZSBpbnN0YW5jZW9mIFRGaWxlKSkge1xuICAgICAgICByZXR1cm4gUmVzdWx0Lm9rPENsYXNzVmlldyB8IG51bGw+KG51bGwpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcy5idWlsZENsYXNzVmlld0Zyb21GaWxlKGZpbGUpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8Q2xhc3NWaWV3IHwgbnVsbD4oXG4gICAgICAgIGBGYWlsZWQgdG8gZmluZCBDbGFzc1ZpZXcgYnkgSUQ6ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBzYXZlKGNsYXNzVmlldzogQ2xhc3NWaWV3KTogUHJvbWlzZTxSZXN1bHQ8dm9pZD4+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZmlsZVBhdGggPSBgJHtjbGFzc1ZpZXcuaWQudG9TdHJpbmcoKX0ubWRgO1xuICAgICAgY29uc3QgY29udGVudCA9IHRoaXMuc2VyaWFsaXplQ2xhc3NWaWV3KGNsYXNzVmlldyk7XG5cbiAgICAgIGNvbnN0IGV4aXN0aW5nRmlsZSA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChmaWxlUGF0aCk7XG4gICAgICBpZiAoZXhpc3RpbmdGaWxlIGluc3RhbmNlb2YgVEZpbGUpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5hcHAudmF1bHQubW9kaWZ5KGV4aXN0aW5nRmlsZSwgY29udGVudCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhd2FpdCB0aGlzLmFwcC52YXVsdC5jcmVhdGUoZmlsZVBhdGgsIGNvbnRlbnQpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gUmVzdWx0Lm9rPHZvaWQ+KCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDx2b2lkPihgRmFpbGVkIHRvIHNhdmUgQ2xhc3NWaWV3OiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZGVsZXRlKGlkOiBBc3NldElkKTogUHJvbWlzZTxSZXN1bHQ8dm9pZD4+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZmlsZSA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChpZC50b1N0cmluZygpICsgXCIubWRcIik7XG4gICAgICBpZiAoZmlsZSBpbnN0YW5jZW9mIFRGaWxlKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuYXBwLnZhdWx0LmRlbGV0ZShmaWxlKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBSZXN1bHQub2s8dm9pZD4oKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPHZvaWQ+KGBGYWlsZWQgdG8gZGVsZXRlIENsYXNzVmlldzogJHtlcnJvci5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZpbmRBbGwoKTogUHJvbWlzZTxSZXN1bHQ8Q2xhc3NWaWV3W10+PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGNsYXNzVmlld3M6IENsYXNzVmlld1tdID0gW107XG4gICAgICBjb25zdCBmaWxlcyA9IHRoaXMuYXBwLnZhdWx0LmdldE1hcmtkb3duRmlsZXMoKTtcblxuICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICAgIGNvbnN0IG1ldGFkYXRhID0gdGhpcy5hcHAubWV0YWRhdGFDYWNoZS5nZXRGaWxlQ2FjaGUoZmlsZSk7XG4gICAgICAgIGlmICghbWV0YWRhdGE/LmZyb250bWF0dGVyKSBjb250aW51ZTtcblxuICAgICAgICBjb25zdCBpbnN0YW5jZUNsYXNzID0gbWV0YWRhdGEuZnJvbnRtYXR0ZXJbXCJleG9fX0luc3RhbmNlX2NsYXNzXCJdO1xuICAgICAgICBpZiAoaW5zdGFuY2VDbGFzcyAhPT0gXCJbW3VpX19DbGFzc1ZpZXddXVwiKSBjb250aW51ZTtcblxuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmJ1aWxkQ2xhc3NWaWV3RnJvbUZpbGUoZmlsZSk7XG4gICAgICAgIGlmIChyZXN1bHQuaXNTdWNjZXNzICYmIHJlc3VsdC5nZXRWYWx1ZSgpKSB7XG4gICAgICAgICAgY2xhc3NWaWV3cy5wdXNoKHJlc3VsdC5nZXRWYWx1ZSgpISk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIFJlc3VsdC5vazxDbGFzc1ZpZXdbXT4oY2xhc3NWaWV3cyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxDbGFzc1ZpZXdbXT4oXG4gICAgICAgIGBGYWlsZWQgdG8gZmluZCBhbGwgQ2xhc3NWaWV3czogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGV4aXN0cyhjbGFzc05hbWU6IENsYXNzTmFtZSk6IFByb21pc2U8UmVzdWx0PGJvb2xlYW4+PiB7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5maW5kQnlDbGFzc05hbWUoY2xhc3NOYW1lKTtcbiAgICBpZiAocmVzdWx0LmlzRmFpbHVyZSkge1xuICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPGJvb2xlYW4+KHJlc3VsdC5lcnJvcik7XG4gICAgfVxuICAgIHJldHVybiBSZXN1bHQub2s8Ym9vbGVhbj4ocmVzdWx0LmdldFZhbHVlKCkgIT09IG51bGwpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBidWlsZENsYXNzVmlld0Zyb21GaWxlKFxuICAgIGZpbGU6IFRGaWxlLFxuICApOiBQcm9taXNlPFJlc3VsdDxDbGFzc1ZpZXcgfCBudWxsPj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBtZXRhZGF0YSA9IHRoaXMuYXBwLm1ldGFkYXRhQ2FjaGUuZ2V0RmlsZUNhY2hlKGZpbGUpO1xuICAgICAgaWYgKCFtZXRhZGF0YT8uZnJvbnRtYXR0ZXIpIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5vazxDbGFzc1ZpZXcgfCBudWxsPihudWxsKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZm0gPSBtZXRhZGF0YS5mcm9udG1hdHRlcjtcblxuICAgICAgLy8gUGFyc2UgdGFyZ2V0IGNsYXNzXG4gICAgICBjb25zdCB0YXJnZXRDbGFzcyA9IGZtW1widWlfX0NsYXNzVmlld190YXJnZXRDbGFzc1wiXTtcbiAgICAgIGlmICghdGFyZ2V0Q2xhc3MpIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5vazxDbGFzc1ZpZXcgfCBudWxsPihudWxsKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgY2xhc3NOYW1lUmVzdWx0ID0gQ2xhc3NOYW1lLmNyZWF0ZShcbiAgICAgICAgdGhpcy5jbGVhbkFzc2V0UmVmZXJlbmNlKHRhcmdldENsYXNzKSxcbiAgICAgICk7XG4gICAgICBpZiAoY2xhc3NOYW1lUmVzdWx0LmlzRmFpbHVyZSkge1xuICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8Q2xhc3NWaWV3IHwgbnVsbD4oY2xhc3NOYW1lUmVzdWx0LmVycm9yKTtcbiAgICAgIH1cblxuICAgICAgLy8gUGFyc2UgYnV0dG9uc1xuICAgICAgY29uc3QgYnV0dG9uUmVmcyA9IGZtW1widWlfX0NsYXNzVmlld19idXR0b25zXCJdIHx8IFtdO1xuICAgICAgY29uc3QgYnV0dG9uczogVUlCdXR0b25bXSA9IFtdO1xuXG4gICAgICBmb3IgKGNvbnN0IGJ1dHRvblJlZiBvZiB0aGlzLmVuc3VyZUFycmF5KGJ1dHRvblJlZnMpKSB7XG4gICAgICAgIGNvbnN0IGJ1dHRvblJlc3VsdCA9IGF3YWl0IHRoaXMubG9hZEJ1dHRvbihcbiAgICAgICAgICB0aGlzLmNsZWFuQXNzZXRSZWZlcmVuY2UoYnV0dG9uUmVmKSxcbiAgICAgICAgKTtcbiAgICAgICAgaWYgKGJ1dHRvblJlc3VsdC5pc1N1Y2Nlc3MgJiYgYnV0dG9uUmVzdWx0LmdldFZhbHVlKCkpIHtcbiAgICAgICAgICBidXR0b25zLnB1c2goYnV0dG9uUmVzdWx0LmdldFZhbHVlKCkhKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBQYXJzZSBkaXNwbGF5IG9wdGlvbnNcbiAgICAgIGNvbnN0IGRpc3BsYXlPcHRpb25zOiBEaXNwbGF5T3B0aW9ucyA9IHtcbiAgICAgICAgc2hvd1Byb3BlcnRpZXM6IGZtW1widWlfX0NsYXNzVmlld19zaG93UHJvcGVydGllc1wiXSAhPT0gZmFsc2UsXG4gICAgICAgIHNob3dSZWxhdGlvbnM6IGZtW1widWlfX0NsYXNzVmlld19zaG93UmVsYXRpb25zXCJdICE9PSBmYWxzZSxcbiAgICAgICAgc2hvd0JhY2tsaW5rczogZm1bXCJ1aV9fQ2xhc3NWaWV3X3Nob3dCYWNrbGlua3NcIl0gIT09IGZhbHNlLFxuICAgICAgICBzaG93QnV0dG9uczogZm1bXCJ1aV9fQ2xhc3NWaWV3X3Nob3dCdXR0b25zXCJdICE9PSBmYWxzZSxcbiAgICAgICAgYnV0dG9uUG9zaXRpb246IGZtW1widWlfX0NsYXNzVmlld19idXR0b25Qb3NpdGlvblwiXSB8fCBcInRvcFwiLFxuICAgICAgfTtcblxuICAgICAgLy8gQ3JlYXRlIENsYXNzVmlld1xuICAgICAgY29uc3QgaWRSZXN1bHQgPSBBc3NldElkLmNyZWF0ZShmaWxlLmJhc2VuYW1lKTtcbiAgICAgIGlmIChpZFJlc3VsdC5pc0ZhaWx1cmUpIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPENsYXNzVmlldyB8IG51bGw+KGlkUmVzdWx0LmVycm9yKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgY2xhc3NWaWV3UmVzdWx0ID0gQ2xhc3NWaWV3LmNyZWF0ZSh7XG4gICAgICAgIGlkOiBpZFJlc3VsdC5nZXRWYWx1ZSgpLFxuICAgICAgICBjbGFzc05hbWU6IGNsYXNzTmFtZVJlc3VsdC5nZXRWYWx1ZSgpLFxuICAgICAgICBidXR0b25zOiBidXR0b25zLFxuICAgICAgICBsYXlvdXRUZW1wbGF0ZTogZm1bXCJ1aV9fQ2xhc3NWaWV3X3RlbXBsYXRlXCJdLFxuICAgICAgICBkaXNwbGF5T3B0aW9uczogZGlzcGxheU9wdGlvbnMsXG4gICAgICB9KTtcblxuICAgICAgaWYgKGNsYXNzVmlld1Jlc3VsdC5pc0ZhaWx1cmUpIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPENsYXNzVmlldyB8IG51bGw+KGNsYXNzVmlld1Jlc3VsdC5lcnJvcik7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBSZXN1bHQub2s8Q2xhc3NWaWV3IHwgbnVsbD4oY2xhc3NWaWV3UmVzdWx0LmdldFZhbHVlKCkpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8Q2xhc3NWaWV3IHwgbnVsbD4oXG4gICAgICAgIGBGYWlsZWQgdG8gYnVpbGQgQ2xhc3NWaWV3OiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBsb2FkQnV0dG9uKFxuICAgIGJ1dHRvbk5hbWU6IHN0cmluZyxcbiAgKTogUHJvbWlzZTxSZXN1bHQ8VUlCdXR0b24gfCBudWxsPj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBmaWxlID0gdGhpcy5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKGJ1dHRvbk5hbWUgKyBcIi5tZFwiKTtcbiAgICAgIGlmICghZmlsZSB8fCAhKGZpbGUgaW5zdGFuY2VvZiBURmlsZSkpIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5vazxVSUJ1dHRvbiB8IG51bGw+KG51bGwpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBtZXRhZGF0YSA9IHRoaXMuYXBwLm1ldGFkYXRhQ2FjaGUuZ2V0RmlsZUNhY2hlKGZpbGUpO1xuICAgICAgaWYgKCFtZXRhZGF0YT8uZnJvbnRtYXR0ZXIpIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5vazxVSUJ1dHRvbiB8IG51bGw+KG51bGwpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBmbSA9IG1ldGFkYXRhLmZyb250bWF0dGVyO1xuXG4gICAgICBjb25zdCBpZFJlc3VsdCA9IEFzc2V0SWQuY3JlYXRlKGZpbGUuYmFzZW5hbWUpO1xuICAgICAgY29uc3QgY29tbWFuZElkUmVzdWx0ID0gQXNzZXRJZC5jcmVhdGUoXG4gICAgICAgIHRoaXMuY2xlYW5Bc3NldFJlZmVyZW5jZShmbVtcInVpX19CdXR0b25fY29tbWFuZFwiXSB8fCBcIlwiKSxcbiAgICAgICk7XG5cbiAgICAgIGlmIChpZFJlc3VsdC5pc0ZhaWx1cmUgfHwgY29tbWFuZElkUmVzdWx0LmlzRmFpbHVyZSkge1xuICAgICAgICByZXR1cm4gUmVzdWx0Lm9rPFVJQnV0dG9uIHwgbnVsbD4obnVsbCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGJ1dHRvblJlc3VsdCA9IFVJQnV0dG9uLmNyZWF0ZSh7XG4gICAgICAgIGlkOiBpZFJlc3VsdC5nZXRWYWx1ZSgpLFxuICAgICAgICBsYWJlbDogZm1bXCJ1aV9fQnV0dG9uX2xhYmVsXCJdIHx8IGZpbGUuYmFzZW5hbWUsXG4gICAgICAgIGNvbW1hbmRJZDogY29tbWFuZElkUmVzdWx0LmdldFZhbHVlKCksXG4gICAgICAgIG9yZGVyOiBmbVtcInVpX19CdXR0b25fb3JkZXJcIl0gfHwgMCxcbiAgICAgICAgaXNFbmFibGVkOiBmbVtcInVpX19CdXR0b25fZW5hYmxlZFwiXSAhPT0gZmFsc2UsXG4gICAgICAgIHRvb2x0aXA6IGZtW1widWlfX0J1dHRvbl90b29sdGlwXCJdLFxuICAgICAgfSk7XG5cbiAgICAgIGlmIChidXR0b25SZXN1bHQuaXNGYWlsdXJlKSB7XG4gICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxVSUJ1dHRvbiB8IG51bGw+KGJ1dHRvblJlc3VsdC5lcnJvcik7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBSZXN1bHQub2s8VUlCdXR0b24gfCBudWxsPihidXR0b25SZXN1bHQuZ2V0VmFsdWUoKSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxVSUJ1dHRvbiB8IG51bGw+KFxuICAgICAgICBgRmFpbGVkIHRvIGxvYWQgYnV0dG9uOiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXJpYWxpemVDbGFzc1ZpZXcoY2xhc3NWaWV3OiBDbGFzc1ZpZXcpOiBzdHJpbmcge1xuICAgIGNvbnN0IGZyb250bWF0dGVyID0ge1xuICAgICAgZXhvX19JbnN0YW5jZV9jbGFzczogXCJbW3VpX19DbGFzc1ZpZXddXVwiLFxuICAgICAgdWlfX0NsYXNzVmlld190YXJnZXRDbGFzczogYFtbJHtjbGFzc1ZpZXcuY2xhc3NOYW1lLnZhbHVlfV1dYCxcbiAgICAgIHVpX19DbGFzc1ZpZXdfYnV0dG9uczogY2xhc3NWaWV3LmJ1dHRvbnMubWFwKFxuICAgICAgICAoYikgPT4gYFtbJHtiLmlkLnRvU3RyaW5nKCl9XV1gLFxuICAgICAgKSxcbiAgICAgIHVpX19DbGFzc1ZpZXdfc2hvd1Byb3BlcnRpZXM6IGNsYXNzVmlldy5kaXNwbGF5T3B0aW9ucy5zaG93UHJvcGVydGllcyxcbiAgICAgIHVpX19DbGFzc1ZpZXdfc2hvd1JlbGF0aW9uczogY2xhc3NWaWV3LmRpc3BsYXlPcHRpb25zLnNob3dSZWxhdGlvbnMsXG4gICAgICB1aV9fQ2xhc3NWaWV3X3Nob3dCYWNrbGlua3M6IGNsYXNzVmlldy5kaXNwbGF5T3B0aW9ucy5zaG93QmFja2xpbmtzLFxuICAgICAgdWlfX0NsYXNzVmlld19zaG93QnV0dG9uczogY2xhc3NWaWV3LmRpc3BsYXlPcHRpb25zLnNob3dCdXR0b25zLFxuICAgICAgdWlfX0NsYXNzVmlld19idXR0b25Qb3NpdGlvbjogY2xhc3NWaWV3LmRpc3BsYXlPcHRpb25zLmJ1dHRvblBvc2l0aW9uLFxuICAgIH07XG5cbiAgICBjb25zdCB5YW1sQ29udGVudCA9IHRoaXMudG9ZYW1sKGZyb250bWF0dGVyKTtcbiAgICByZXR1cm4gYC0tLVxcbiR7eWFtbENvbnRlbnR9LS0tXFxuXFxuIyBDbGFzc1ZpZXc6ICR7Y2xhc3NWaWV3LmNsYXNzTmFtZS52YWx1ZX1cXG5gO1xuICB9XG5cbiAgcHJpdmF0ZSBjbGVhbkFzc2V0UmVmZXJlbmNlKHJlZjogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAodHlwZW9mIHJlZiAhPT0gXCJzdHJpbmdcIikgcmV0dXJuIFwiXCI7XG4gICAgcmV0dXJuIHJlZi5yZXBsYWNlKC9cXFtcXFt8XFxdXFxdL2csIFwiXCIpLnRyaW0oKTtcbiAgfVxuXG4gIHByaXZhdGUgZW5zdXJlQXJyYXkodmFsdWU6IGFueSk6IGFueVtdIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHJldHVybiB2YWx1ZTtcbiAgICBpZiAodmFsdWUpIHJldHVybiBbdmFsdWVdO1xuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIHByaXZhdGUgdG9ZYW1sKG9iajogYW55KTogc3RyaW5nIHtcbiAgICAvLyBTaW1wbGUgWUFNTCBzZXJpYWxpemF0aW9uXG4gICAgcmV0dXJuIChcbiAgICAgIE9iamVjdC5lbnRyaWVzKG9iailcbiAgICAgICAgLm1hcCgoW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gYCR7a2V5fTpcXG4ke3ZhbHVlLm1hcCgodikgPT4gYCAgLSAke3Z9YCkuam9pbihcIlxcblwiKX1gO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gYCR7a2V5fTogJHt2YWx1ZX1gO1xuICAgICAgICB9KVxuICAgICAgICAuam9pbihcIlxcblwiKSArIFwiXFxuXCJcbiAgICApO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=