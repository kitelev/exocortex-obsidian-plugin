14d2ef4ca5fe3c279a7ace80ed73ec25
"use strict";
/**
 * Global Test Cleanup System
 * Prevents memory leaks and ensures proper test isolation
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.globalTestState = exports.MemoryTracker = exports.forceCleanupTestResources = exports.MemorySafeMockFactory = void 0;
const globalTestState = {
    timers: new Set(),
    intervals: new Set(),
    eventListeners: new Map(),
    domNodes: new Set(),
    mockInstances: new Set(),
};
exports.globalTestState = globalTestState;
// Override setTimeout to track timers
const originalSetTimeout = global.setTimeout;
global.setTimeout = ((...args) => {
    const timer = originalSetTimeout.apply(global, args);
    globalTestState.timers.add(timer);
    return timer;
});
// Override setInterval to track intervals
const originalSetInterval = global.setInterval;
global.setInterval = ((...args) => {
    const interval = originalSetInterval.apply(global, args);
    globalTestState.intervals.add(interval);
    return interval;
});
// Override clearTimeout
const originalClearTimeout = global.clearTimeout;
global.clearTimeout = ((timer) => {
    globalTestState.timers.delete(timer);
    return originalClearTimeout(timer);
});
// Override clearInterval
const originalClearInterval = global.clearInterval;
global.clearInterval = ((interval) => {
    globalTestState.intervals.delete(interval);
    return originalClearInterval(interval);
});
// Track DOM event listeners
if (typeof EventTarget !== "undefined" &&
    EventTarget.prototype.addEventListener) {
    const originalAddEventListener = EventTarget.prototype.addEventListener;
    EventTarget.prototype.addEventListener = function (type, listener, options) {
        if (!globalTestState.eventListeners.has(this)) {
            globalTestState.eventListeners.set(this, []);
        }
        globalTestState.eventListeners.get(this).push({ type, listener });
        return originalAddEventListener.call(this, type, listener, options);
    };
}
// Track DOM nodes created during tests
if (typeof document !== "undefined" && document.createElement) {
    const originalCreateElement = document.createElement;
    document.createElement = function (tagName, options) {
        const element = originalCreateElement.call(this, tagName, options);
        globalTestState.domNodes.add(element);
        return element;
    };
}
/**
 * Memory-safe mock factory
 */
class MemorySafeMockFactory {
    static createMock(identifier, mockImplementation) {
        if (this.instances.has(identifier)) {
            return this.instances.get(identifier);
        }
        const mock = mockImplementation();
        this.instances.set(identifier, mock);
        globalTestState.mockInstances.add(mock);
        return mock;
    }
    static clearMock(identifier) {
        if (this.instances.has(identifier)) {
            const mock = this.instances.get(identifier);
            globalTestState.mockInstances.delete(mock);
            this.instances.delete(identifier);
        }
    }
    static clearAllMocks() {
        this.instances.clear();
        globalTestState.mockInstances.clear();
    }
}
exports.MemorySafeMockFactory = MemorySafeMockFactory;
MemorySafeMockFactory.instances = new Map();
/**
 * Force cleanup of all test resources
 */
function forceCleanupTestResources() {
    // Clear all timers
    globalTestState.timers.forEach((timer) => {
        try {
            clearTimeout(timer);
        }
        catch (e) {
            // Ignore cleanup errors
        }
    });
    globalTestState.timers.clear();
    // Clear all intervals
    globalTestState.intervals.forEach((interval) => {
        try {
            clearInterval(interval);
        }
        catch (e) {
            // Ignore cleanup errors
        }
    });
    globalTestState.intervals.clear();
    // Remove all event listeners
    globalTestState.eventListeners.forEach((listeners, target) => {
        listeners.forEach(({ type, listener }) => {
            try {
                target.removeEventListener(type, listener);
            }
            catch (e) {
                // Ignore cleanup errors
            }
        });
    });
    globalTestState.eventListeners.clear();
    // Clean up DOM nodes
    if (typeof document !== "undefined") {
        globalTestState.domNodes.forEach((node) => {
            try {
                if (node.parentNode) {
                    node.parentNode.removeChild(node);
                }
            }
            catch (e) {
                // Ignore cleanup errors
            }
        });
        globalTestState.domNodes.clear();
        // Clear document body
        if (document.body) {
            document.body.innerHTML = "";
        }
    }
    // Clear mock instances
    MemorySafeMockFactory.clearAllMocks();
    // Force garbage collection if available
    if (typeof global.gc === "function") {
        try {
            global.gc();
        }
        catch (e) {
            // Ignore GC errors
        }
    }
}
exports.forceCleanupTestResources = forceCleanupTestResources;
/**
 * Memory usage tracker for tests
 */
class MemoryTracker {
    static takeSnapshot(testName) {
        const memory = process.memoryUsage();
        this.snapshots.push({
            test: testName,
            memory,
            timestamp: Date.now(),
        });
        // Keep only last 10 snapshots to prevent memory buildup
        if (this.snapshots.length > 10) {
            this.snapshots.shift();
        }
        return memory;
    }
    static getMemoryIncrease(from, to) {
        const fromSnapshot = this.snapshots.find((s) => s.test === from);
        const toSnapshot = this.snapshots.find((s) => s.test === to);
        if (!fromSnapshot || !toSnapshot) {
            return 0;
        }
        return toSnapshot.memory.heapUsed - fromSnapshot.memory.heapUsed;
    }
    static reportMemoryUsage() {
        if (process.env.JEST_VERBOSE || process.env.MEMORY_DEBUG) {
            console.log("Memory Usage Report:");
            this.snapshots.forEach((snapshot) => {
                const mb = (snapshot.memory.heapUsed / 1024 / 1024).toFixed(2);
                console.log(`  ${snapshot.test}: ${mb}MB`);
            });
        }
    }
    static clearSnapshots() {
        this.snapshots.length = 0;
    }
}
exports.MemoryTracker = MemoryTracker;
MemoryTracker.snapshots = [];
// Global setup and teardown
beforeEach(() => {
    // Clear any hanging resources before each test
    forceCleanupTestResources();
    // Take memory snapshot
    const testName = expect.getState()?.currentTestName || "unknown";
    MemoryTracker.takeSnapshot(`before-${testName}`);
});
afterEach(() => {
    // Clear all resources after each test
    forceCleanupTestResources();
    // Take memory snapshot
    const testName = expect.getState()?.currentTestName || "unknown";
    MemoryTracker.takeSnapshot(`after-${testName}`);
    // Report excessive memory usage
    const increase = MemoryTracker.getMemoryIncrease(`before-${testName}`, `after-${testName}`);
    const warningThreshold = process.env.CI ? 10 * 1024 * 1024 : 50 * 1024 * 1024; // 10MB in CI, 50MB locally
    if (increase > warningThreshold) {
        console.warn(`Warning: Test "${testName}" used ${(increase / 1024 / 1024).toFixed(2)}MB of memory`);
    }
});
afterAll(() => {
    // Final cleanup and memory report
    forceCleanupTestResources();
    MemoryTracker.reportMemoryUsage();
    MemoryTracker.clearSnapshots();
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vdGVzdHMvdGVzdC1jbGVhbnVwLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7OztBQWNILE1BQU0sZUFBZSxHQUFvQjtJQUN2QyxNQUFNLEVBQUUsSUFBSSxHQUFHLEVBQUU7SUFDakIsU0FBUyxFQUFFLElBQUksR0FBRyxFQUFFO0lBQ3BCLGNBQWMsRUFBRSxJQUFJLEdBQUcsRUFBRTtJQUN6QixRQUFRLEVBQUUsSUFBSSxHQUFHLEVBQUU7SUFDbkIsYUFBYSxFQUFFLElBQUksR0FBRyxFQUFFO0NBQ3pCLENBQUM7QUFrUU8sMENBQWU7QUFoUXhCLHNDQUFzQztBQUN0QyxNQUFNLGtCQUFrQixHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUM7QUFDN0MsTUFBTSxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsR0FBRyxJQUFXLEVBQUUsRUFBRTtJQUN0QyxNQUFNLEtBQUssR0FBRyxrQkFBa0IsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLElBQTBCLENBQUMsQ0FBQztJQUMzRSxlQUFlLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNsQyxPQUFPLEtBQUssQ0FBQztBQUNmLENBQUMsQ0FBc0IsQ0FBQztBQUV4QiwwQ0FBMEM7QUFDMUMsTUFBTSxtQkFBbUIsR0FBRyxNQUFNLENBQUMsV0FBVyxDQUFDO0FBQy9DLE1BQU0sQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBVyxFQUFFLEVBQUU7SUFDdkMsTUFBTSxRQUFRLEdBQUcsbUJBQW1CLENBQUMsS0FBSyxDQUN4QyxNQUFNLEVBQ04sSUFBMEIsQ0FDM0IsQ0FBQztJQUNGLGVBQWUsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ3hDLE9BQU8sUUFBUSxDQUFDO0FBQ2xCLENBQUMsQ0FBdUIsQ0FBQztBQUV6Qix3QkFBd0I7QUFDeEIsTUFBTSxvQkFBb0IsR0FBRyxNQUFN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QUMsQ0FBQyxFQUFFLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLDJCQUEyQjtJQUUxRyxJQUFJLFFBQVEsR0FBRyxnQkFBZ0IsRUFBRTtRQUMvQixPQUFPLENBQUMsSUFBSSxDQUNWLGtCQUFrQixRQUFRLFVBQVUsQ0FBQyxRQUFRLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsY0FBYyxDQUN0RixDQUFDO0tBQ0g7QUFDSCxDQUFDLENBQUMsQ0FBQztBQUVILFFBQVEsQ0FBQyxHQUFHLEVBQUU7SUFDWixrQ0FBa0M7SUFDbEMseUJBQXlCLEVBQUUsQ0FBQztJQUM1QixhQUFhLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztJQUNsQyxhQUFhLENBQUMsY0FBYyxFQUFFLENBQUM7QUFDakMsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vdGVzdHMvdGVzdC1jbGVhbnVwLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogR2xvYmFsIFRlc3QgQ2xlYW51cCBTeXN0ZW1cbiAqIFByZXZlbnRzIG1lbW9yeSBsZWFrcyBhbmQgZW5zdXJlcyBwcm9wZXIgdGVzdCBpc29sYXRpb25cbiAqL1xuXG4vLyBUcmFjayBnbG9iYWwgc3RhdGUgZm9yIGNsZWFudXBcbmludGVyZmFjZSBHbG9iYWxUZXN0U3RhdGUge1xuICB0aW1lcnM6IFNldDxOb2RlSlMuVGltZW91dD47XG4gIGludGVydmFsczogU2V0PE5vZGVKUy5UaW1lb3V0PjtcbiAgZXZlbnRMaXN0ZW5lcnM6IE1hcDxcbiAgICBFdmVudFRhcmdldCxcbiAgICBBcnJheTx7IHR5cGU6IHN0cmluZzsgbGlzdGVuZXI6IEV2ZW50TGlzdGVuZXIgfT5cbiAgPjtcbiAgZG9tTm9kZXM6IFNldDxFbGVtZW50PjtcbiAgbW9ja0luc3RhbmNlczogU2V0PGFueT47XG59XG5cbmNvbnN0IGdsb2JhbFRlc3RTdGF0ZTogR2xvYmFsVGVzdFN0YXRlID0ge1xuICB0aW1lcnM6IG5ldyBTZXQoKSxcbiAgaW50ZXJ2YWxzOiBuZXcgU2V0KCksXG4gIGV2ZW50TGlzdGVuZXJzOiBuZXcgTWFwKCksXG4gIGRvbU5vZGVzOiBuZXcgU2V0KCksXG4gIG1vY2tJbnN0YW5jZXM6IG5ldyBTZXQoKSxcbn07XG5cbi8vIE92ZXJyaWRlIHNldFRpbWVvdXQgdG8gdHJhY2sgdGltZXJzXG5jb25zdCBvcmlnaW5hbFNldFRpbWVvdXQgPSBnbG9iYWwuc2V0VGltZW91dDtcbmdsb2JhbC5zZXRUaW1lb3V0ID0gKCguLi5hcmdzOiBhbnlbXSkgPT4ge1xuICBjb25zdCB0aW1lciA9IG9yaWdpbmFsU2V0VGltZW91dC5hcHBseShnbG9iYWwsIGFyZ3MgYXMgW0Z1bmN0aW9uLCBudW1iZXJdKTtcbiAgZ2xvYmFsVGVzdFN0YXRlLnRpbWVycy5hZGQodGltZXIpO1xuICByZXR1cm4gdGltZXI7XG59KSBhcyB0eXBlb2Ygc2V0VGltZW91dDtcblxuLy8gT3ZlcnJpZGUgc2V0SW50ZXJ2YWwgdG8gdHJhY2sgaW50ZXJ2YWxzXG5jb25zdCBvcmlnaW5hbFNldEludGVydmFsID0gZ2xvYmFsLnNldEludGVydmFsO1xuZ2xvYmFsLnNldEludGVydmFsID0gKCguLi5hcmdzOiBhbnlbXSkgPT4ge1xuICBjb25zdCBpbnRlcnZhbCA9IG9yaWdpbmFsU2V0SW50ZXJ2YWwuYXBwbHkoXG4gICAgZ2xvYmFsLFxuICAgIGFyZ3MgYXMgW0Z1bmN0aW9uLCBudW1iZXJdLFxuICApO1xuICBnbG9iYWxUZXN0U3RhdGUuaW50ZXJ2YWxzLmFkZChpbnRlcnZhbCk7XG4gIHJldHVybiBpbnRlcnZhbDtcbn0pIGFzIHR5cGVvZiBzZXRJbnRlcnZhbDtcblxuLy8gT3ZlcnJpZGUgY2xlYXJUaW1lb3V0XG5jb25zdCBvcmlnaW5hbENsZWFyVGltZW91dCA9IGdsb2JhbC5jbGVhclRpbWVvdXQ7XG5nbG9iYWwuY2xlYXJUaW1lb3V0ID0gKCh0aW1lcjogTm9kZUpTLlRpbWVvdXQpID0+IHtcbiAgZ2xvYmFsVGVzdFN0YXRlLnRpbWVycy5kZWxldGUodGltZXIpO1xuICByZXR1cm4gb3JpZ2luYWxDbGVhclRpbWVvdXQodGltZXIpO1xufSkgYXMgdHlwZW9mIGNsZWFyVGltZW91dDtcblxuLy8gT3ZlcnJpZGUgY2xlYXJJbnRlcnZhbFxuY29uc3Qgb3JpZ2luYWxDbGVhckludGVydmFsID0gZ2xvYmFsLmNsZWFySW50ZXJ2YWw7XG5nbG9iYWwuY2xlYXJJbnRlcnZhbCA9ICgoaW50ZXJ2YWw6IE5vZGVKUy5UaW1lb3V0KSA9PiB7XG4gIGdsb2JhbFRlc3RTdGF0ZS5pbnRlcnZhbHMuZGVsZXRlKGludGVydmFsKTtcbiAgcmV0dXJuIG9yaWdpbmFsQ2xlYXJJbnRlcnZhbChpbnRlcnZhbCk7XG59KSBhcyB0eXBlb2YgY2xlYXJJbnRlcnZhbDtcblxuLy8gVHJhY2sgRE9NIGV2ZW50IGxpc3RlbmVyc1xuaWYgKFxuICB0eXBlb2YgRXZlbnRUYXJnZXQgIT09IFwidW5kZWZpbmVkXCIgJiZcbiAgRXZlbnRUYXJnZXQucHJvdG90eXBlLmFkZEV2ZW50TGlzdGVuZXJcbikge1xuICBjb25zdCBvcmlnaW5hbEFkZEV2ZW50TGlzdGVuZXIgPSBFdmVudFRhcmdldC5wcm90b3R5cGUuYWRkRXZlbnRMaXN0ZW5lcjtcbiAgRXZlbnRUYXJnZXQucHJvdG90eXBlLmFkZEV2ZW50TGlzdGVuZXIgPSBmdW5jdGlvbiAoXG4gICAgdHlwZTogc3RyaW5nLFxuICAgIGxpc3RlbmVyOiBFdmVudExpc3RlbmVyLFxuICAgIG9wdGlvbnM/OiBib29sZWFuIHwgQWRkRXZlbnRMaXN0ZW5lck9wdGlvbnMsXG4gICkge1xuICAgIGlmICghZ2xvYmFsVGVzdFN0YXRlLmV2ZW50TGlzdGVuZXJzLmhhcyh0aGlzKSkge1xuICAgICAgZ2xvYmFsVGVzdFN0YXRlLmV2ZW50TGlzdGVuZXJzLnNldCh0aGlzLCBbXSk7XG4gICAgfVxuICAgIGdsb2JhbFRlc3RTdGF0ZS5ldmVudExpc3RlbmVycy5nZXQodGhpcykhLnB1c2goeyB0eXBlLCBsaXN0ZW5lciB9KTtcbiAgICByZXR1cm4gb3JpZ2luYWxBZGRFdmVudExpc3RlbmVyLmNhbGwodGhpcywgdHlwZSwgbGlzdGVuZXIsIG9wdGlvbnMpO1xuICB9O1xufVxuXG4vLyBUcmFjayBET00gbm9kZXMgY3JlYXRlZCBkdXJpbmcgdGVzdHNcbmlmICh0eXBlb2YgZG9jdW1lbnQgIT09IFwidW5kZWZpbmVkXCIgJiYgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCkge1xuICBjb25zdCBvcmlnaW5hbENyZWF0ZUVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50O1xuICBkb2N1bWVudC5jcmVhdGVFbGVtZW50ID0gZnVuY3Rpb24gPEsgZXh0ZW5kcyBrZXlvZiBIVE1MRWxlbWVudFRhZ05hbWVNYXA+KFxuICAgIHRhZ05hbWU6IEssXG4gICAgb3B0aW9ucz86IEVsZW1lbnRDcmVhdGlvbk9wdGlvbnMsXG4gICk6IEhUTUxFbGVtZW50VGFnTmFtZU1hcFtLXSB7XG4gICAgY29uc3QgZWxlbWVudCA9IG9yaWdpbmFsQ3JlYXRlRWxlbWVudC5jYWxsKHRoaXMsIHRhZ05hbWUsIG9wdGlvbnMpO1xuICAgIGdsb2JhbFRlc3RTdGF0ZS5kb21Ob2Rlcy5hZGQoZWxlbWVudCk7XG4gICAgcmV0dXJuIGVsZW1lbnQ7XG4gIH07XG59XG5cbi8qKlxuICogTWVtb3J5LXNhZmUgbW9jayBmYWN0b3J5XG4gKi9cbmV4cG9ydCBjbGFzcyBNZW1vcnlTYWZlTW9ja0ZhY3Rvcnkge1xuICBwcml2YXRlIHN0YXRpYyBpbnN0YW5jZXMgPSBuZXcgTWFwPHN0cmluZywgYW55PigpO1xuXG4gIHN0YXRpYyBjcmVhdGVNb2NrPFQ+KGlkZW50aWZpZXI6IHN0cmluZywgbW9ja0ltcGxlbWVudGF0aW9uOiAoKSA9PiBUKTogVCB7XG4gICAgaWYgKHRoaXMuaW5zdGFuY2VzLmhhcyhpZGVudGlmaWVyKSkge1xuICAgICAgcmV0dXJuIHRoaXMuaW5zdGFuY2VzLmdldChpZGVudGlmaWVyKTtcbiAgICB9XG5cbiAgICBjb25zdCBtb2NrID0gbW9ja0ltcGxlbWVudGF0aW9uKCk7XG4gICAgdGhpcy5pbnN0YW5jZXMuc2V0KGlkZW50aWZpZXIsIG1vY2spO1xuICAgIGdsb2JhbFRlc3RTdGF0ZS5tb2NrSW5zdGFuY2VzLmFkZChtb2NrKTtcbiAgICByZXR1cm4gbW9jaztcbiAgfVxuXG4gIHN0YXRpYyBjbGVhck1vY2soaWRlbnRpZmllcjogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaW5zdGFuY2VzLmhhcyhpZGVudGlmaWVyKSkge1xuICAgICAgY29uc3QgbW9jayA9IHRoaXMuaW5zdGFuY2VzLmdldChpZGVudGlmaWVyKTtcbiAgICAgIGdsb2JhbFRlc3RTdGF0ZS5tb2NrSW5zdGFuY2VzLmRlbGV0ZShtb2NrKTtcbiAgICAgIHRoaXMuaW5zdGFuY2VzLmRlbGV0ZShpZGVudGlmaWVyKTtcbiAgICB9XG4gIH1cblxuICBzdGF0aWMgY2xlYXJBbGxNb2NrcygpOiB2b2lkIHtcbiAgICB0aGlzLmluc3RhbmNlcy5jbGVhcigpO1xuICAgIGdsb2JhbFRlc3RTdGF0ZS5tb2NrSW5zdGFuY2VzLmNsZWFyKCk7XG4gIH1cbn1cblxuLyoqXG4gKiBGb3JjZSBjbGVhbnVwIG9mIGFsbCB0ZXN0IHJlc291cmNlc1xuICovXG5leHBvcnQgZnVuY3Rpb24gZm9yY2VDbGVhbnVwVGVzdFJlc291cmNlcygpOiB2b2lkIHtcbiAgLy8gQ2xlYXIgYWxsIHRpbWVyc1xuICBnbG9iYWxUZXN0U3RhdGUudGltZXJzLmZvckVhY2goKHRpbWVyKSA9PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgLy8gSWdub3JlIGNsZWFudXAgZXJyb3JzXG4gICAgfVxuICB9KTtcbiAgZ2xvYmFsVGVzdFN0YXRlLnRpbWVycy5jbGVhcigpO1xuXG4gIC8vIENsZWFyIGFsbCBpbnRlcnZhbHNcbiAgZ2xvYmFsVGVzdFN0YXRlLmludGVydmFscy5mb3JFYWNoKChpbnRlcnZhbCkgPT4ge1xuICAgIHRyeSB7XG4gICAgICBjbGVhckludGVydmFsKGludGVydmFsKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAvLyBJZ25vcmUgY2xlYW51cCBlcnJvcnNcbiAgICB9XG4gIH0pO1xuICBnbG9iYWxUZXN0U3RhdGUuaW50ZXJ2YWxzLmNsZWFyKCk7XG5cbiAgLy8gUmVtb3ZlIGFsbCBldmVudCBsaXN0ZW5lcnNcbiAgZ2xvYmFsVGVzdFN0YXRlLmV2ZW50TGlzdGVuZXJzLmZvckVhY2goKGxpc3RlbmVycywgdGFyZ2V0KSA9PiB7XG4gICAgbGlzdGVuZXJzLmZvckVhY2goKHsgdHlwZSwgbGlzdGVuZXIgfSkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgdGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgbGlzdGVuZXIpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAvLyBJZ25vcmUgY2xlYW51cCBlcnJvcnNcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG4gIGdsb2JhbFRlc3RTdGF0ZS5ldmVudExpc3RlbmVycy5jbGVhcigpO1xuXG4gIC8vIENsZWFuIHVwIERPTSBub2Rlc1xuICBpZiAodHlwZW9mIGRvY3VtZW50ICE9PSBcInVuZGVmaW5lZFwiKSB7XG4gICAgZ2xvYmFsVGVzdFN0YXRlLmRvbU5vZGVzLmZvckVhY2goKG5vZGUpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGlmIChub2RlLnBhcmVudE5vZGUpIHtcbiAgICAgICAgICBub2RlLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobm9kZSk7XG4gICAgICAgIH1cbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgLy8gSWdub3JlIGNsZWFudXAgZXJyb3JzXG4gICAgICB9XG4gICAgfSk7XG4gICAgZ2xvYmFsVGVzdFN0YXRlLmRvbU5vZGVzLmNsZWFyKCk7XG5cbiAgICAvLyBDbGVhciBkb2N1bWVudCBib2R5XG4gICAgaWYgKGRvY3VtZW50LmJvZHkpIHtcbiAgICAgIGRvY3VtZW50LmJvZHkuaW5uZXJIVE1MID0gXCJcIjtcbiAgICB9XG4gIH1cblxuICAvLyBDbGVhciBtb2NrIGluc3RhbmNlc1xuICBNZW1vcnlTYWZlTW9ja0ZhY3RvcnkuY2xlYXJBbGxNb2NrcygpO1xuXG4gIC8vIEZvcmNlIGdhcmJhZ2UgY29sbGVjdGlvbiBpZiBhdmFpbGFibGVcbiAgaWYgKHR5cGVvZiBnbG9iYWwuZ2MgPT09IFwiZnVuY3Rpb25cIikge1xuICAgIHRyeSB7XG4gICAgICBnbG9iYWwuZ2MoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAvLyBJZ25vcmUgR0MgZXJyb3JzXG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogTWVtb3J5IHVzYWdlIHRyYWNrZXIgZm9yIHRlc3RzXG4gKi9cbmV4cG9ydCBjbGFzcyBNZW1vcnlUcmFja2VyIHtcbiAgcHJpdmF0ZSBzdGF0aWMgc25hcHNob3RzOiBBcnJheTx7XG4gICAgdGVzdDogc3RyaW5nO1xuICAgIG1lbW9yeTogTm9kZUpTLk1lbW9yeVVzYWdlO1xuICAgIHRpbWVzdGFtcDogbnVtYmVyO1xuICB9PiA9IFtdO1xuXG4gIHN0YXRpYyB0YWtlU25hcHNob3QodGVzdE5hbWU6IHN0cmluZyk6IE5vZGVKUy5NZW1vcnlVc2FnZSB7XG4gICAgY29uc3QgbWVtb3J5ID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpO1xuICAgIHRoaXMuc25hcHNob3RzLnB1c2goe1xuICAgICAgdGVzdDogdGVzdE5hbWUsXG4gICAgICBtZW1vcnksXG4gICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgfSk7XG5cbiAgICAvLyBLZWVwIG9ubHkgbGFzdCAxMCBzbmFwc2hvdHMgdG8gcHJldmVudCBtZW1vcnkgYnVpbGR1cFxuICAgIGlmICh0aGlzLnNuYXBzaG90cy5sZW5ndGggPiAxMCkge1xuICAgICAgdGhpcy5zbmFwc2hvdHMuc2hpZnQoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gbWVtb3J5O1xuICB9XG5cbiAgc3RhdGljIGdldE1lbW9yeUluY3JlYXNlKGZyb206IHN0cmluZywgdG86IHN0cmluZyk6IG51bWJlciB7XG4gICAgY29uc3QgZnJvbVNuYXBzaG90ID0gdGhpcy5zbmFwc2hvdHMuZmluZCgocykgPT4gcy50ZXN0ID09PSBmcm9tKTtcbiAgICBjb25zdCB0b1NuYXBzaG90ID0gdGhpcy5zbmFwc2hvdHMuZmluZCgocykgPT4gcy50ZXN0ID09PSB0byk7XG5cbiAgICBpZiAoIWZyb21TbmFwc2hvdCB8fCAhdG9TbmFwc2hvdCkge1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRvU25hcHNob3QubWVtb3J5LmhlYXBVc2VkIC0gZnJvbVNuYXBzaG90Lm1lbW9yeS5oZWFwVXNlZDtcbiAgfVxuXG4gIHN0YXRpYyByZXBvcnRNZW1vcnlVc2FnZSgpOiB2b2lkIHtcbiAgICBpZiAocHJvY2Vzcy5lbnYuSkVTVF9WRVJCT1NFIHx8IHByb2Nlc3MuZW52Lk1FTU9SWV9ERUJVRykge1xuICAgICAgY29uc29sZS5sb2coXCJNZW1vcnkgVXNhZ2UgUmVwb3J0OlwiKTtcbiAgICAgIHRoaXMuc25hcHNob3RzLmZvckVhY2goKHNuYXBzaG90KSA9PiB7XG4gICAgICAgIGNvbnN0IG1iID0gKHNuYXBzaG90Lm1lbW9yeS5oZWFwVXNlZCAvIDEwMjQgLyAxMDI0KS50b0ZpeGVkKDIpO1xuICAgICAgICBjb25zb2xlLmxvZyhgICAke3NuYXBzaG90LnRlc3R9OiAke21ifU1CYCk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBzdGF0aWMgY2xlYXJTbmFwc2hvdHMoKTogdm9pZCB7XG4gICAgdGhpcy5zbmFwc2hvdHMubGVuZ3RoID0gMDtcbiAgfVxufVxuXG4vLyBHbG9iYWwgc2V0dXAgYW5kIHRlYXJkb3duXG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgLy8gQ2xlYXIgYW55IGhhbmdpbmcgcmVzb3VyY2VzIGJlZm9yZSBlYWNoIHRlc3RcbiAgZm9yY2VDbGVhbnVwVGVzdFJlc291cmNlcygpO1xuXG4gIC8vIFRha2UgbWVtb3J5IHNuYXBzaG90XG4gIGNvbnN0IHRlc3ROYW1lID0gZXhwZWN0LmdldFN0YXRlKCk/LmN1cnJlbnRUZXN0TmFtZSB8fCBcInVua25vd25cIjtcbiAgTWVtb3J5VHJhY2tlci50YWtlU25hcHNob3QoYGJlZm9yZS0ke3Rlc3ROYW1lfWApO1xufSk7XG5cbmFmdGVyRWFjaCgoKSA9PiB7XG4gIC8vIENsZWFyIGFsbCByZXNvdXJjZXMgYWZ0ZXIgZWFjaCB0ZXN0XG4gIGZvcmNlQ2xlYW51cFRlc3RSZXNvdXJjZXMoKTtcblxuICAvLyBUYWtlIG1lbW9yeSBzbmFwc2hvdFxuICBjb25zdCB0ZXN0TmFtZSA9IGV4cGVjdC5nZXRTdGF0ZSgpPy5jdXJyZW50VGVzdE5hbWUgfHwgXCJ1bmtub3duXCI7XG4gIE1lbW9yeVRyYWNrZXIudGFrZVNuYXBzaG90KGBhZnRlci0ke3Rlc3ROYW1lfWApO1xuXG4gIC8vIFJlcG9ydCBleGNlc3NpdmUgbWVtb3J5IHVzYWdlXG4gIGNvbnN0IGluY3JlYXNlID0gTWVtb3J5VHJhY2tlci5nZXRNZW1vcnlJbmNyZWFzZShcbiAgICBgYmVmb3JlLSR7dGVzdE5hbWV9YCxcbiAgICBgYWZ0ZXItJHt0ZXN0TmFtZX1gLFxuICApO1xuICBjb25zdCB3YXJuaW5nVGhyZXNob2xkID0gcHJvY2Vzcy5lbnYuQ0kgPyAxMCAqIDEwMjQgKiAxMDI0IDogNTAgKiAxMDI0ICogMTAyNDsgLy8gMTBNQiBpbiBDSSwgNTBNQiBsb2NhbGx5XG5cbiAgaWYgKGluY3JlYXNlID4gd2FybmluZ1RocmVzaG9sZCkge1xuICAgIGNvbnNvbGUud2FybihcbiAgICAgIGBXYXJuaW5nOiBUZXN0IFwiJHt0ZXN0TmFtZX1cIiB1c2VkICR7KGluY3JlYXNlIC8gMTAyNCAvIDEwMjQpLnRvRml4ZWQoMil9TUIgb2YgbWVtb3J5YCxcbiAgICApO1xuICB9XG59KTtcblxuYWZ0ZXJBbGwoKCkgPT4ge1xuICAvLyBGaW5hbCBjbGVhbnVwIGFuZCBtZW1vcnkgcmVwb3J0XG4gIGZvcmNlQ2xlYW51cFRlc3RSZXNvdXJjZXMoKTtcbiAgTWVtb3J5VHJhY2tlci5yZXBvcnRNZW1vcnlVc2FnZSgpO1xuICBNZW1vcnlUcmFja2VyLmNsZWFyU25hcHNob3RzKCk7XG59KTtcblxuLy8gRXhwb3J0IHV0aWxpdGllcyBmb3IgdXNlIGluIHRlc3RzXG5leHBvcnQgeyBnbG9iYWxUZXN0U3RhdGUsIGZvcmNlQ2xlYW51cFRlc3RSZXNvdXJjZXMgfTtcbiJdLCJ2ZXJzaW9uIjozfQ==