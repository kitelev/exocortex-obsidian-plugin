52fe5c136fe662c784dc8773364bce00
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ObsidianClassViewRepository = void 0;
const tslib_1 = require("tslib");
const obsidian_1 = require("obsidian");
const ClassView_1 = require("../../domain/aggregates/ClassView");
const ClassName_1 = require("../../domain/value-objects/ClassName");
const AssetId_1 = require("../../domain/value-objects/AssetId");
const Result_1 = require("../../domain/core/Result");
const UIButton_1 = require("../../domain/entities/UIButton");
/**
 * Obsidian implementation of ClassView repository
 * Maps between domain entities and Obsidian vault files
 */
class ObsidianClassViewRepository {
    constructor(app) {
        this.app = app;
    }
    findByClassName(className) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const files = this.app.vault.getMarkdownFiles();
                for (const file of files) {
                    const metadata = this.app.metadataCache.getFileCache(file);
                    if (!(metadata === null || metadata === void 0 ? void 0 : metadata.frontmatter))
                        continue;
                    const instanceClass = metadata.frontmatter['exo__Instance_class'];
                    if (instanceClass !== '[[ui__ClassView]]')
                        continue;
                    const targetClass = metadata.frontmatter['ui__ClassView_targetClass'];
                    if (!targetClass)
                        continue;
                    const cleanTargetClass = this.cleanAssetReference(targetClass);
                    if (cleanTargetClass !== className.value)
                        continue;
                    // Found the ClassView for this class
                    return this.buildClassViewFromFile(file);
                }
                return Result_1.Result.ok(null);
            }
            catch (error) {
                return Result_1.Result.fail(`Failed to find ClassView: ${error.message}`);
            }
        });
    }
    findById(id) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const file = this.app.vault.getAbstractFileByPath(id.toString() + '.md');
                if (!file || !(file instanceof obsidian_1.TFile)) {
                    return Result_1.Result.ok(null);
                }
                return this.buildClassViewFromFile(file);
            }
            catch (error) {
                return Result_1.Result.fail(`Failed to find ClassView by ID: ${error.message}`);
            }
        });
    }
    save(classView) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const filePath = `${classView.id.toString()}.md`;
                const content = this.serializeClassView(classView);
                const existingFile = this.app.vault.getAbstractFileByPath(filePath);
                if (existingFile instanceof obsidian_1.TFile) {
                    yield this.app.vault.modify(existingFile, content);
                }
                else {
                    yield this.app.vault.create(filePath, content);
                }
                return Result_1.Result.ok();
            }
            catch (error) {
                return Result_1.Result.fail(`Failed to save ClassView: ${error.message}`);
            }
        });
    }
    delete(id) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const file = this.app.vault.getAbstractFileByPath(id.toString() + '.md');
                if (file instanceof obsidian_1.TFile) {
                    yield this.app.vault.delete(file);
                }
                return Result_1.Result.ok();
            }
            catch (error) {
                return Result_1.Result.fail(`Failed to delete ClassView: ${error.message}`);
            }
        });
    }
    findAll() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const classViews = [];
                const files = this.app.vault.getMarkdownFiles();
                for (const file of files) {
                    const metadata = this.app.metadataCache.getFileCache(file);
                    if (!(metadata === null || metadata === void 0 ? void 0 : metadata.frontmatter))
                        continue;
                    const instanceClass = metadata.frontmatter['exo__Instance_class'];
                    if (instanceClass !== '[[ui__ClassView]]')
                        continue;
                    const result = yield this.buildClassViewFromFile(file);
                    if (result.isSuccess && result.getValue()) {
                        classViews.push(result.getValue());
                    }
                }
                return Result_1.Result.ok(classViews);
            }
            catch (error) {
                return Result_1.Result.fail(`Failed to find all ClassViews: ${error.message}`);
            }
        });
    }
    exists(className) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const result = yield this.findByClassName(className);
            if (result.isFailure) {
                return Result_1.Result.fail(result.error);
            }
            return Result_1.Result.ok(result.getValue() !== null);
        });
    }
    buildClassViewFromFile(file) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const metadata = this.app.metadataCache.getFileCache(file);
                if (!(metadata === null || metadata === void 0 ? void 0 : metadata.frontmatter)) {
                    return Result_1.Result.ok(null);
                }
                const fm = metadata.frontmatter;
                // Parse target class
                const targetClass = fm['ui__ClassView_targetClass'];
                if (!targetClass) {
                    return Result_1.Result.ok(null);
                }
                const classNameResult = ClassName_1.ClassName.create(this.cleanAssetReference(targetClass));
                if (classNameResult.isFailure) {
                    return Result_1.Result.fail(classNameResult.error);
                }
                // Parse buttons
                const buttonRefs = fm['ui__ClassView_buttons'] || [];
                const buttons = [];
                for (const buttonRef of this.ensureArray(buttonRefs)) {
                    const buttonResult = yield this.loadButton(this.cleanAssetReference(buttonRef));
                    if (buttonResult.isSuccess && buttonResult.getValue()) {
                        buttons.push(buttonResult.getValue());
                    }
                }
                // Parse display options
                const displayOptions = {
                    showProperties: fm['ui__ClassView_showProperties'] !== false,
                    showRelations: fm['ui__ClassView_showRelations'] !== false,
                    showBacklinks: fm['ui__ClassView_showBacklinks'] !== false,
                    showButtons: fm['ui__ClassView_showButtons'] !== false,
                    buttonPosition: fm['ui__ClassView_buttonPosition'] || 'top'
                };
                // Create ClassView
                const idResult = AssetId_1.AssetId.create(file.basename);
                if (idResult.isFailure) {
                    return Result_1.Result.fail(idResult.error);
                }
                const classViewResult = ClassView_1.ClassView.create({
                    id: idResult.getValue(),
                    className: classNameResult.getValue(),
                    buttons: buttons,
                    layoutTemplate: fm['ui__ClassView_template'],
                    displayOptions: displayOptions
                });
                if (classViewResult.isFailure) {
                    return Result_1.Result.fail(classViewResult.error);
                }
                return Result_1.Result.ok(classViewResult.getValue());
            }
            catch (error) {
                return Result_1.Result.fail(`Failed to build ClassView: ${error.message}`);
            }
        });
    }
    loadButton(buttonName) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const file = this.app.vault.getAbstractFileByPath(buttonName + '.md');
                if (!file || !(file instanceof obsidian_1.TFile)) {
                    return Result_1.Result.ok(null);
                }
                const metadata = this.app.metadataCache.getFileCache(file);
                if (!(metadata === null || metadata === void 0 ? void 0 : metadata.frontmatter)) {
                    return Result_1.Result.ok(null);
                }
                const fm = metadata.frontmatter;
                const idResult = AssetId_1.AssetId.create(file.basename);
                const commandIdResult = AssetId_1.AssetId.create(this.cleanAssetReference(fm['ui__Button_command'] || ''));
                if (idResult.isFailure || commandIdResult.isFailure) {
                    return Result_1.Result.ok(null);
                }
                const buttonResult = UIButton_1.UIButton.create({
                    id: idResult.getValue(),
                    label: fm['ui__Button_label'] || file.basename,
                    commandId: commandIdResult.getValue(),
                    order: fm['ui__Button_order'] || 0,
                    isEnabled: fm['ui__Button_enabled'] !== false,
                    tooltip: fm['ui__Button_tooltip']
                });
                if (buttonResult.isFailure) {
                    return Result_1.Result.fail(buttonResult.error);
                }
                return Result_1.Result.ok(buttonResult.getValue());
            }
            catch (error) {
                return Result_1.Result.fail(`Failed to load button: ${error.message}`);
            }
        });
    }
    serializeClassView(classView) {
        const frontmatter = {
            'exo__Instance_class': '[[ui__ClassView]]',
            'ui__ClassView_targetClass': `[[${classView.className.value}]]`,
            'ui__ClassView_buttons': classView.buttons.map(b => `[[${b.id.toString()}]]`),
            'ui__ClassView_showProperties': classView.displayOptions.showProperties,
            'ui__ClassView_showRelations': classView.displayOptions.showRelations,
            'ui__ClassView_showBacklinks': classView.displayOptions.showBacklinks,
            'ui__ClassView_showButtons': classView.displayOptions.showButtons,
            'ui__ClassView_buttonPosition': classView.displayOptions.buttonPosition
        };
        const yamlContent = this.toYaml(frontmatter);
        return `---\n${yamlContent}---\n\n# ClassView: ${classView.className.value}\n`;
    }
    cleanAssetReference(ref) {
        if (typeof ref !== 'string')
            return '';
        return ref.replace(/\[\[|\]\]/g, '').trim();
    }
    ensureArray(value) {
        if (Array.isArray(value))
            return value;
        if (value)
            return [value];
        return [];
    }
    toYaml(obj) {
        // Simple YAML serialization
        return Object.entries(obj)
            .map(([key, value]) => {
            if (Array.isArray(value)) {
                return `${key}:\n${value.map(v => `  - ${v}`).join('\n')}`;
            }
            return `${key}: ${value}`;
        })
            .join('\n') + '\n';
    }
}
exports.ObsidianClassViewRepository = ObsidianClassViewRepository;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2luZnJhc3RydWN0dXJlL3JlcG9zaXRvcmllcy9PYnNpZGlhbkNsYXNzVmlld1JlcG9zaXRvcnkudHMiLCJtYXBwaW5ncyI6Ijs7OztBQUFBLHVDQUFzQztBQUV0QyxpRUFBOEU7QUFDOUUsb0VBQWlFO0FBQ2pFLGdFQUE2RDtBQUM3RCxxREFBa0Q7QUFDbEQsNkRBQTBEO0FBRTFEOzs7R0FHRztBQUNILE1BQWEsMkJBQTJCO0lBQ3BDLFlBQW9CLEdBQVE7UUFBUixRQUFHLEdBQUgsR0FBRyxDQUFLO0lBQUcsQ0FBQztJQUUxQixlQUFlLENBQUMsU0FBb0I7O1lBQ3RDLElBQUk7Z0JBQ0EsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztnQkFFaEQsS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLEVBQUU7b0JBQ3RCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDM0QsSUFBSSxDQUFDLENBQUEsUUFBUSxhQUFSLFFBQVEsdUJBQVIsUUFBUSxDQUFFLFdBQVcsQ0FBQTt3QkFBRSxTQUFTO29CQUVyQyxNQUFNLGFBQWEsR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDLHFCQUFxQixDQUFDLENBQUM7b0JBQ2xFLElBQUksYUFBYSxLQUFLLG1CQUFtQjt3QkFBRSxTQUFTO29CQUVwRCxNQUFNLFdBQVcsR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDLDJCQUEyQixDQUFDLENBQUM7b0JBQ3RFLElBQUksQ0FBQyxXQUFXO3dCQUFFLFNBQVM7b0JBRTNCLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFdBQVcsQ0FBQyxDQUFDO29CQUMvRCxJQUFJLGdCQUFnQixLQUFLLFNBQVMsQ0FBQyxLQUFLO3dCQUFFLFNBQVM7b0JBRW5ELHFD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LEVBQUUsQ0FBQztRQUM5QixDQUFDLENBQUM7YUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDO0lBQzNCLENBQUM7Q0FDSjtBQXpQRCxrRUF5UEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2luZnJhc3RydWN0dXJlL3JlcG9zaXRvcmllcy9PYnNpZGlhbkNsYXNzVmlld1JlcG9zaXRvcnkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwLCBURmlsZSB9IGZyb20gJ29ic2lkaWFuJztcbmltcG9ydCB7IElDbGFzc1ZpZXdSZXBvc2l0b3J5IH0gZnJvbSAnLi4vLi4vZG9tYWluL3JlcG9zaXRvcmllcy9JQ2xhc3NWaWV3UmVwb3NpdG9yeSc7XG5pbXBvcnQgeyBDbGFzc1ZpZXcsIERpc3BsYXlPcHRpb25zIH0gZnJvbSAnLi4vLi4vZG9tYWluL2FnZ3JlZ2F0ZXMvQ2xhc3NWaWV3JztcbmltcG9ydCB7IENsYXNzTmFtZSB9IGZyb20gJy4uLy4uL2RvbWFpbi92YWx1ZS1vYmplY3RzL0NsYXNzTmFtZSc7XG5pbXBvcnQgeyBBc3NldElkIH0gZnJvbSAnLi4vLi4vZG9tYWluL3ZhbHVlLW9iamVjdHMvQXNzZXRJZCc7XG5pbXBvcnQgeyBSZXN1bHQgfSBmcm9tICcuLi8uLi9kb21haW4vY29yZS9SZXN1bHQnO1xuaW1wb3J0IHsgVUlCdXR0b24gfSBmcm9tICcuLi8uLi9kb21haW4vZW50aXRpZXMvVUlCdXR0b24nO1xuXG4vKipcbiAqIE9ic2lkaWFuIGltcGxlbWVudGF0aW9uIG9mIENsYXNzVmlldyByZXBvc2l0b3J5XG4gKiBNYXBzIGJldHdlZW4gZG9tYWluIGVudGl0aWVzIGFuZCBPYnNpZGlhbiB2YXVsdCBmaWxlc1xuICovXG5leHBvcnQgY2xhc3MgT2JzaWRpYW5DbGFzc1ZpZXdSZXBvc2l0b3J5IGltcGxlbWVudHMgSUNsYXNzVmlld1JlcG9zaXRvcnkge1xuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgYXBwOiBBcHApIHt9XG5cbiAgICBhc3luYyBmaW5kQnlDbGFzc05hbWUoY2xhc3NOYW1lOiBDbGFzc05hbWUpOiBQcm9taXNlPFJlc3VsdDxDbGFzc1ZpZXcgfCBudWxsPj4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgZmlsZXMgPSB0aGlzLmFwcC52YXVsdC5nZXRNYXJrZG93bkZpbGVzKCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1ldGFkYXRhID0gdGhpcy5hcHAubWV0YWRhdGFDYWNoZS5nZXRGaWxlQ2FjaGUoZmlsZSk7XG4gICAgICAgICAgICAgICAgaWYgKCFtZXRhZGF0YT8uZnJvbnRtYXR0ZXIpIGNvbnRpbnVlO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgaW5zdGFuY2VDbGFzcyA9IG1ldGFkYXRhLmZyb250bWF0dGVyWydleG9fX0luc3RhbmNlX2NsYXNzJ107XG4gICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlQ2xhc3MgIT09ICdbW3VpX19DbGFzc1ZpZXddXScpIGNvbnRpbnVlO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgdGFyZ2V0Q2xhc3MgPSBtZXRhZGF0YS5mcm9udG1hdHRlclsndWlfX0NsYXNzVmlld190YXJnZXRDbGFzcyddO1xuICAgICAgICAgICAgICAgIGlmICghdGFyZ2V0Q2xhc3MpIGNvbnRpbnVlO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgY2xlYW5UYXJnZXRDbGFzcyA9IHRoaXMuY2xlYW5Bc3NldFJlZmVyZW5jZSh0YXJnZXRDbGFzcyk7XG4gICAgICAgICAgICAgICAgaWYgKGNsZWFuVGFyZ2V0Q2xhc3MgIT09IGNsYXNzTmFtZS52YWx1ZSkgY29udGludWU7XG5cbiAgICAgICAgICAgICAgICAvLyBGb3VuZCB0aGUgQ2xhc3NWaWV3IGZvciB0aGlzIGNsYXNzXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYnVpbGRDbGFzc1ZpZXdGcm9tRmlsZShmaWxlKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5vazxDbGFzc1ZpZXcgfCBudWxsPihudWxsKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxDbGFzc1ZpZXcgfCBudWxsPihgRmFpbGVkIHRvIGZpbmQgQ2xhc3NWaWV3OiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBmaW5kQnlJZChpZDogQXNzZXRJZCk6IFByb21pc2U8UmVzdWx0PENsYXNzVmlldyB8IG51bGw+PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBmaWxlID0gdGhpcy5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKGlkLnRvU3RyaW5nKCkgKyAnLm1kJyk7XG4gICAgICAgICAgICBpZiAoIWZpbGUgfHwgIShmaWxlIGluc3RhbmNlb2YgVEZpbGUpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5vazxDbGFzc1ZpZXcgfCBudWxsPihudWxsKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYnVpbGRDbGFzc1ZpZXdGcm9tRmlsZShmaWxlKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxDbGFzc1ZpZXcgfCBudWxsPihgRmFpbGVkIHRvIGZpbmQgQ2xhc3NWaWV3IGJ5IElEOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBzYXZlKGNsYXNzVmlldzogQ2xhc3NWaWV3KTogUHJvbWlzZTxSZXN1bHQ8dm9pZD4+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGZpbGVQYXRoID0gYCR7Y2xhc3NWaWV3LmlkLnRvU3RyaW5nKCl9Lm1kYDtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSB0aGlzLnNlcmlhbGl6ZUNsYXNzVmlldyhjbGFzc1ZpZXcpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCBleGlzdGluZ0ZpbGUgPSB0aGlzLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoZmlsZVBhdGgpO1xuICAgICAgICAgICAgaWYgKGV4aXN0aW5nRmlsZSBpbnN0YW5jZW9mIFRGaWxlKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5hcHAudmF1bHQubW9kaWZ5KGV4aXN0aW5nRmlsZSwgY29udGVudCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuYXBwLnZhdWx0LmNyZWF0ZShmaWxlUGF0aCwgY29udGVudCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQub2s8dm9pZD4oKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDx2b2lkPihgRmFpbGVkIHRvIHNhdmUgQ2xhc3NWaWV3OiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBkZWxldGUoaWQ6IEFzc2V0SWQpOiBQcm9taXNlPFJlc3VsdDx2b2lkPj4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgZmlsZSA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChpZC50b1N0cmluZygpICsgJy5tZCcpO1xuICAgICAgICAgICAgaWYgKGZpbGUgaW5zdGFuY2VvZiBURmlsZSkge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuYXBwLnZhdWx0LmRlbGV0ZShmaWxlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQub2s8dm9pZD4oKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDx2b2lkPihgRmFpbGVkIHRvIGRlbGV0ZSBDbGFzc1ZpZXc6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIGZpbmRBbGwoKTogUHJvbWlzZTxSZXN1bHQ8Q2xhc3NWaWV3W10+PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBjbGFzc1ZpZXdzOiBDbGFzc1ZpZXdbXSA9IFtdO1xuICAgICAgICAgICAgY29uc3QgZmlsZXMgPSB0aGlzLmFwcC52YXVsdC5nZXRNYXJrZG93bkZpbGVzKCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1ldGFkYXRhID0gdGhpcy5hcHAubWV0YWRhdGFDYWNoZS5nZXRGaWxlQ2FjaGUoZmlsZSk7XG4gICAgICAgICAgICAgICAgaWYgKCFtZXRhZGF0YT8uZnJvbnRtYXR0ZXIpIGNvbnRpbnVlO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgaW5zdGFuY2VDbGFzcyA9IG1ldGFkYXRhLmZyb250bWF0dGVyWydleG9fX0luc3RhbmNlX2NsYXNzJ107XG4gICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlQ2xhc3MgIT09ICdbW3VpX19DbGFzc1ZpZXddXScpIGNvbnRpbnVlO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5idWlsZENsYXNzVmlld0Zyb21GaWxlKGZpbGUpO1xuICAgICAgICAgICAgICAgIGlmIChyZXN1bHQuaXNTdWNjZXNzICYmIHJlc3VsdC5nZXRWYWx1ZSgpKSB7XG4gICAgICAgICAgICAgICAgICAgIGNsYXNzVmlld3MucHVzaChyZXN1bHQuZ2V0VmFsdWUoKSEpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5vazxDbGFzc1ZpZXdbXT4oY2xhc3NWaWV3cyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8Q2xhc3NWaWV3W10+KGBGYWlsZWQgdG8gZmluZCBhbGwgQ2xhc3NWaWV3czogJHtlcnJvci5tZXNzYWdlfWApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgZXhpc3RzKGNsYXNzTmFtZTogQ2xhc3NOYW1lKTogUHJvbWlzZTxSZXN1bHQ8Ym9vbGVhbj4+IHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5maW5kQnlDbGFzc05hbWUoY2xhc3NOYW1lKTtcbiAgICAgICAgaWYgKHJlc3VsdC5pc0ZhaWx1cmUpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxib29sZWFuPihyZXN1bHQuZXJyb3IpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBSZXN1bHQub2s8Ym9vbGVhbj4ocmVzdWx0LmdldFZhbHVlKCkgIT09IG51bGwpO1xuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgYnVpbGRDbGFzc1ZpZXdGcm9tRmlsZShmaWxlOiBURmlsZSk6IFByb21pc2U8UmVzdWx0PENsYXNzVmlldyB8IG51bGw+PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBtZXRhZGF0YSA9IHRoaXMuYXBwLm1ldGFkYXRhQ2FjaGUuZ2V0RmlsZUNhY2hlKGZpbGUpO1xuICAgICAgICAgICAgaWYgKCFtZXRhZGF0YT8uZnJvbnRtYXR0ZXIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUmVzdWx0Lm9rPENsYXNzVmlldyB8IG51bGw+KG51bGwpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBmbSA9IG1ldGFkYXRhLmZyb250bWF0dGVyO1xuXG4gICAgICAgICAgICAvLyBQYXJzZSB0YXJnZXQgY2xhc3NcbiAgICAgICAgICAgIGNvbnN0IHRhcmdldENsYXNzID0gZm1bJ3VpX19DbGFzc1ZpZXdfdGFyZ2V0Q2xhc3MnXTtcbiAgICAgICAgICAgIGlmICghdGFyZ2V0Q2xhc3MpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUmVzdWx0Lm9rPENsYXNzVmlldyB8IG51bGw+KG51bGwpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBjbGFzc05hbWVSZXN1bHQgPSBDbGFzc05hbWUuY3JlYXRlKHRoaXMuY2xlYW5Bc3NldFJlZmVyZW5jZSh0YXJnZXRDbGFzcykpO1xuICAgICAgICAgICAgaWYgKGNsYXNzTmFtZVJlc3VsdC5pc0ZhaWx1cmUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8Q2xhc3NWaWV3IHwgbnVsbD4oY2xhc3NOYW1lUmVzdWx0LmVycm9yKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gUGFyc2UgYnV0dG9uc1xuICAgICAgICAgICAgY29uc3QgYnV0dG9uUmVmcyA9IGZtWyd1aV9fQ2xhc3NWaWV3X2J1dHRvbnMnXSB8fCBbXTtcbiAgICAgICAgICAgIGNvbnN0IGJ1dHRvbnM6IFVJQnV0dG9uW10gPSBbXTtcblxuICAgICAgICAgICAgZm9yIChjb25zdCBidXR0b25SZWYgb2YgdGhpcy5lbnN1cmVBcnJheShidXR0b25SZWZzKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGJ1dHRvblJlc3VsdCA9IGF3YWl0IHRoaXMubG9hZEJ1dHRvbih0aGlzLmNsZWFuQXNzZXRSZWZlcmVuY2UoYnV0dG9uUmVmKSk7XG4gICAgICAgICAgICAgICAgaWYgKGJ1dHRvblJlc3VsdC5pc1N1Y2Nlc3MgJiYgYnV0dG9uUmVzdWx0LmdldFZhbHVlKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgYnV0dG9ucy5wdXNoKGJ1dHRvblJlc3VsdC5nZXRWYWx1ZSgpISk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBQYXJzZSBkaXNwbGF5IG9wdGlvbnNcbiAgICAgICAgICAgIGNvbnN0IGRpc3BsYXlPcHRpb25zOiBEaXNwbGF5T3B0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICBzaG93UHJvcGVydGllczogZm1bJ3VpX19DbGFzc1ZpZXdfc2hvd1Byb3BlcnRpZXMnXSAhPT0gZmFsc2UsXG4gICAgICAgICAgICAgICAgc2hvd1JlbGF0aW9uczogZm1bJ3VpX19DbGFzc1ZpZXdfc2hvd1JlbGF0aW9ucyddICE9PSBmYWxzZSxcbiAgICAgICAgICAgICAgICBzaG93QmFja2xpbmtzOiBmbVsndWlfX0NsYXNzVmlld19zaG93QmFja2xpbmtzJ10gIT09IGZhbHNlLFxuICAgICAgICAgICAgICAgIHNob3dCdXR0b25zOiBmbVsndWlfX0NsYXNzVmlld19zaG93QnV0dG9ucyddICE9PSBmYWxzZSxcbiAgICAgICAgICAgICAgICBidXR0b25Qb3NpdGlvbjogZm1bJ3VpX19DbGFzc1ZpZXdfYnV0dG9uUG9zaXRpb24nXSB8fCAndG9wJ1xuICAgICAgICAgICAgfTtcblxuICAgICAgICAgICAgLy8gQ3JlYXRlIENsYXNzVmlld1xuICAgICAgICAgICAgY29uc3QgaWRSZXN1bHQgPSBBc3NldElkLmNyZWF0ZShmaWxlLmJhc2VuYW1lKTtcbiAgICAgICAgICAgIGlmIChpZFJlc3VsdC5pc0ZhaWx1cmUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8Q2xhc3NWaWV3IHwgbnVsbD4oaWRSZXN1bHQuZXJyb3IpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBjbGFzc1ZpZXdSZXN1bHQgPSBDbGFzc1ZpZXcuY3JlYXRlKHtcbiAgICAgICAgICAgICAgICBpZDogaWRSZXN1bHQuZ2V0VmFsdWUoKSxcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU6IGNsYXNzTmFtZVJlc3VsdC5nZXRWYWx1ZSgpLFxuICAgICAgICAgICAgICAgIGJ1dHRvbnM6IGJ1dHRvbnMsXG4gICAgICAgICAgICAgICAgbGF5b3V0VGVtcGxhdGU6IGZtWyd1aV9fQ2xhc3NWaWV3X3RlbXBsYXRlJ10sXG4gICAgICAgICAgICAgICAgZGlzcGxheU9wdGlvbnM6IGRpc3BsYXlPcHRpb25zXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKGNsYXNzVmlld1Jlc3VsdC5pc0ZhaWx1cmUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8Q2xhc3NWaWV3IHwgbnVsbD4oY2xhc3NWaWV3UmVzdWx0LmVycm9yKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5vazxDbGFzc1ZpZXcgfCBudWxsPihjbGFzc1ZpZXdSZXN1bHQuZ2V0VmFsdWUoKSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8Q2xhc3NWaWV3IHwgbnVsbD4oYEZhaWxlZCB0byBidWlsZCBDbGFzc1ZpZXc6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgbG9hZEJ1dHRvbihidXR0b25OYW1lOiBzdHJpbmcpOiBQcm9taXNlPFJlc3VsdDxVSUJ1dHRvbiB8IG51bGw+PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBmaWxlID0gdGhpcy5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKGJ1dHRvbk5hbWUgKyAnLm1kJyk7XG4gICAgICAgICAgICBpZiAoIWZpbGUgfHwgIShmaWxlIGluc3RhbmNlb2YgVEZpbGUpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5vazxVSUJ1dHRvbiB8IG51bGw+KG51bGwpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBtZXRhZGF0YSA9IHRoaXMuYXBwLm1ldGFkYXRhQ2FjaGUuZ2V0RmlsZUNhY2hlKGZpbGUpO1xuICAgICAgICAgICAgaWYgKCFtZXRhZGF0YT8uZnJvbnRtYXR0ZXIpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUmVzdWx0Lm9rPFVJQnV0dG9uIHwgbnVsbD4obnVsbCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGZtID0gbWV0YWRhdGEuZnJvbnRtYXR0ZXI7XG5cbiAgICAgICAgICAgIGNvbnN0IGlkUmVzdWx0ID0gQXNzZXRJZC5jcmVhdGUoZmlsZS5iYXNlbmFtZSk7XG4gICAgICAgICAgICBjb25zdCBjb21tYW5kSWRSZXN1bHQgPSBBc3NldElkLmNyZWF0ZShcbiAgICAgICAgICAgICAgICB0aGlzLmNsZWFuQXNzZXRSZWZlcmVuY2UoZm1bJ3VpX19CdXR0b25fY29tbWFuZCddIHx8ICcnKVxuICAgICAgICAgICAgKTtcblxuICAgICAgICAgICAgaWYgKGlkUmVzdWx0LmlzRmFpbHVyZSB8fCBjb21tYW5kSWRSZXN1bHQuaXNGYWlsdXJlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5vazxVSUJ1dHRvbiB8IG51bGw+KG51bGwpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBidXR0b25SZXN1bHQgPSBVSUJ1dHRvbi5jcmVhdGUoe1xuICAgICAgICAgICAgICAgIGlkOiBpZFJlc3VsdC5nZXRWYWx1ZSgpLFxuICAgICAgICAgICAgICAgIGxhYmVsOiBmbVsndWlfX0J1dHRvbl9sYWJlbCddIHx8IGZpbGUuYmFzZW5hbWUsXG4gICAgICAgICAgICAgICAgY29tbWFuZElkOiBjb21tYW5kSWRSZXN1bHQuZ2V0VmFsdWUoKSxcbiAgICAgICAgICAgICAgICBvcmRlcjogZm1bJ3VpX19CdXR0b25fb3JkZXInXSB8fCAwLFxuICAgICAgICAgICAgICAgIGlzRW5hYmxlZDogZm1bJ3VpX19CdXR0b25fZW5hYmxlZCddICE9PSBmYWxzZSxcbiAgICAgICAgICAgICAgICB0b29sdGlwOiBmbVsndWlfX0J1dHRvbl90b29sdGlwJ11cbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICBpZiAoYnV0dG9uUmVzdWx0LmlzRmFpbHVyZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxVSUJ1dHRvbiB8IG51bGw+KGJ1dHRvblJlc3VsdC5lcnJvcik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQub2s8VUlCdXR0b24gfCBudWxsPihidXR0b25SZXN1bHQuZ2V0VmFsdWUoKSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8VUlCdXR0b24gfCBudWxsPihgRmFpbGVkIHRvIGxvYWQgYnV0dG9uOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHNlcmlhbGl6ZUNsYXNzVmlldyhjbGFzc1ZpZXc6IENsYXNzVmlldyk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IGZyb250bWF0dGVyID0ge1xuICAgICAgICAgICAgJ2V4b19fSW5zdGFuY2VfY2xhc3MnOiAnW1t1aV9fQ2xhc3NWaWV3XV0nLFxuICAgICAgICAgICAgJ3VpX19DbGFzc1ZpZXdfdGFyZ2V0Q2xhc3MnOiBgW1ske2NsYXNzVmlldy5jbGFzc05hbWUudmFsdWV9XV1gLFxuICAgICAgICAgICAgJ3VpX19DbGFzc1ZpZXdfYnV0dG9ucyc6IGNsYXNzVmlldy5idXR0b25zLm1hcChiID0+IGBbWyR7Yi5pZC50b1N0cmluZygpfV1dYCksXG4gICAgICAgICAgICAndWlfX0NsYXNzVmlld19zaG93UHJvcGVydGllcyc6IGNsYXNzVmlldy5kaXNwbGF5T3B0aW9ucy5zaG93UHJvcGVydGllcyxcbiAgICAgICAgICAgICd1aV9fQ2xhc3NWaWV3X3Nob3dSZWxhdGlvbnMnOiBjbGFzc1ZpZXcuZGlzcGxheU9wdGlvbnMuc2hvd1JlbGF0aW9ucyxcbiAgICAgICAgICAgICd1aV9fQ2xhc3NWaWV3X3Nob3dCYWNrbGlua3MnOiBjbGFzc1ZpZXcuZGlzcGxheU9wdGlvbnMuc2hvd0JhY2tsaW5rcyxcbiAgICAgICAgICAgICd1aV9fQ2xhc3NWaWV3X3Nob3dCdXR0b25zJzogY2xhc3NWaWV3LmRpc3BsYXlPcHRpb25zLnNob3dCdXR0b25zLFxuICAgICAgICAgICAgJ3VpX19DbGFzc1ZpZXdfYnV0dG9uUG9zaXRpb24nOiBjbGFzc1ZpZXcuZGlzcGxheU9wdGlvbnMuYnV0dG9uUG9zaXRpb25cbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCB5YW1sQ29udGVudCA9IHRoaXMudG9ZYW1sKGZyb250bWF0dGVyKTtcbiAgICAgICAgcmV0dXJuIGAtLS1cXG4ke3lhbWxDb250ZW50fS0tLVxcblxcbiMgQ2xhc3NWaWV3OiAke2NsYXNzVmlldy5jbGFzc05hbWUudmFsdWV9XFxuYDtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNsZWFuQXNzZXRSZWZlcmVuY2UocmVmOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICBpZiAodHlwZW9mIHJlZiAhPT0gJ3N0cmluZycpIHJldHVybiAnJztcbiAgICAgICAgcmV0dXJuIHJlZi5yZXBsYWNlKC9cXFtcXFt8XFxdXFxdL2csICcnKS50cmltKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBlbnN1cmVBcnJheSh2YWx1ZTogYW55KTogYW55W10ge1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHJldHVybiB2YWx1ZTtcbiAgICAgICAgaWYgKHZhbHVlKSByZXR1cm4gW3ZhbHVlXTtcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgIH1cblxuICAgIHByaXZhdGUgdG9ZYW1sKG9iajogYW55KTogc3RyaW5nIHtcbiAgICAgICAgLy8gU2ltcGxlIFlBTUwgc2VyaWFsaXphdGlvblxuICAgICAgICByZXR1cm4gT2JqZWN0LmVudHJpZXMob2JqKVxuICAgICAgICAgICAgLm1hcCgoW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBgJHtrZXl9OlxcbiR7dmFsdWUubWFwKHYgPT4gYCAgLSAke3Z9YCkuam9pbignXFxuJyl9YDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmV0dXJuIGAke2tleX06ICR7dmFsdWV9YDtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuam9pbignXFxuJykgKyAnXFxuJztcbiAgICB9XG59Il0sInZlcnNpb24iOjN9