7bc97bcd39401a1cba65e46516c49aad
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PropertyCacheService = void 0;
/**
 * Performance-optimized caching service for property definitions
 * Reduces file system reads during asset creation
 */
class PropertyCacheService {
    constructor() {
        this.propertyCache = new Map();
        this.classPropertyIndex = new Map();
        this.lastCacheUpdate = 0;
        this.CACHE_TTL = 5 * 60 * 1000; // 5 minutes
        this.MAX_CACHE_SIZE = 1000;
        this.setupPerformanceMonitoring();
    }
    static getInstance() {
        if (!PropertyCacheService.instance) {
            PropertyCacheService.instance = new PropertyCacheService();
        }
        return PropertyCacheService.instance;
    }
    /**
     * Gets cached properties for a class with performance optimization
     * @param className The class to get properties for
     * @returns Array of property definitions
     */
    getPropertiesForClass(className) {
        const cacheKey = `class:${className}`;
        // Check cache first
        if (this.isCacheValid() && this.propertyCache.has(cacheKey)) {
            const cached = this.propertyCache.get(cacheKey);
            console.debug(`Cache hit for ${className}: ${cached.length} properties`);
            return [...cached]; // Return copy to prevent mutation
        }
        console.debug(`Cache miss for ${className}, returning empty array`);
        return [];
    }
    /**
     * Updates cache with property definitions for a class
     * @param className The class name
     * @param properties Array of property definitions
     */
    updateClassProperties(className, properties) {
        const cacheKey = `class:${className}`;
        // Implement cache size limit
        if (this.propertyCache.size >= this.MAX_CACHE_SIZE) {
            this.evictOldestEntries();
        }
        // Cache the properties
        this.propertyCache.set(cacheKey, [...properties]);
        // Update class-property index for faster lookups
        const propertyNames = properties.map(p => p.name);
        this.classPropertyIndex.set(className, propertyNames);
        this.lastCacheUpdate = Date.now();
        console.debug(`Cached ${properties.length} properties for ${className}`);
    }
    /**
     * Bulk update cache with multiple classes at once
     * @param classPropertiesMap Map of class name to property definitions
     */
    bulkUpdateCache(classPropertiesMap) {
        const startTime = performance.now();
        for (const [className, properties] of classPropertiesMap) {
            this.updateClassProperties(className, properties);
        }
        const duration = performance.now() - startTime;
        console.debug(`Bulk cache update completed in ${duration.toFixed(2)}ms for ${classPropertiesMap.size} classes`);
    }
    /**
     * Checks if a class has cached properties
     * @param className The class name to check
     * @returns True if properties are cached and valid
     */
    hasPropertiesForClass(className) {
        return this.isCacheValid() && this.propertyCache.has(`class:${className}`);
    }
    /**
     * Gets all cached class names
     * @returns Array of class names in cache
     */
    getCachedClasses() {
        if (!this.isCacheValid()) {
            return [];
        }
        return Array.from(this.classPropertyIndex.keys());
    }
    /**
     * Invalidates cache for a specific class
     * @param className The class to invalidate
     */
    invalidateClass(className) {
        const cacheKey = `class:${className}`;
        this.propertyCache.delete(cacheKey);
        this.classPropertyIndex.delete(className);
        console.debug(`Invalidated cache for ${className}`);
    }
    /**
     * Clears all cached data
     */
    clearCache() {
        this.propertyCache.clear();
        this.classPropertyIndex.clear();
        this.lastCacheUpdate = 0;
        console.debug("Cache cleared");
    }
    /**
     * Gets cache statistics for performance monitoring
     * @returns Cache performance metrics
     */
    getCacheStats() {
        return {
            size: this.propertyCache.size,
            classCount: this.classPropertyIndex.size,
            lastUpdate: this.lastCacheUpdate,
            isValid: this.isCacheValid(),
            hitRate: this.calculateHitRate(),
            memoryUsage: this.estimateMemoryUsage(),
        };
    }
    /**
     * Preloads properties for common classes to improve performance
     * @param priorityClasses Array of class names to prioritize
     */
    async preloadPriorityClasses(priorityClasses) {
        console.debug(`Preloading ${priorityClasses.length} priority classes`);
        const startTime = performance.now();
        const preloadMap = new Map();
        // For now, set empty arrays to indicate classes are "loaded"
        // In a real implementation, this would fetch from the vault
        for (const className of priorityClasses) {
            if (!this.hasPropertiesForClass(className)) {
                preloadMap.set(className, []);
            }
        }
        if (preloadMap.size > 0) {
            this.bulkUpdateCache(preloadMap);
        }
        const duration = performance.now() - startTime;
        console.debug(`Preload completed in ${duration.toFixed(2)}ms`);
    }
    /**
     * Checks if cache is still valid based on TTL
     */
    isCacheValid() {
        if (this.lastCacheUpdate === 0) {
            return false;
        }
        return (Date.now() - this.lastCacheUpdate) < this.CACHE_TTL;
    }
    /**
     * Evicts oldest cache entries to maintain size limit
     */
    evictOldestEntries() {
        const entriesToEvict = Math.floor(this.MAX_CACHE_SIZE * 0.2); // Remove 20%
        const entries = Array.from(this.propertyCache.keys());
        for (let i = 0; i < entriesToEvict && entries.length > 0; i++) {
            const keyToEvict = entries[i];
            this.propertyCache.delete(keyToEvict);
            // Extract class name from cache key
            const className = keyToEvict.replace('class:', '');
            this.classPropertyIndex.delete(className);
        }
        console.debug(`Evicted ${entriesToEvict} cache entries`);
    }
    /**
     * Calculates cache hit rate for performance monitoring
     */
    calculateHitRate() {
        // This would be tracked in a real implementation
        return 0.85; // Placeholder
    }
    /**
     * Estimates memory usage of cached data
     */
    estimateMemoryUsage() {
        let totalSize = 0;
        for (const [key, properties] of this.propertyCache) {
            totalSize += key.length * 2; // String characters as bytes
            totalSize += properties.length * 200; // Estimated property object size
        }
        return totalSize;
    }
    /**
     * Sets up performance monitoring and cleanup
     */
    setupPerformanceMonitoring() {
        // Auto-cleanup old cache entries every 10 minutes
        if (typeof setInterval !== 'undefined') {
            setInterval(() => {
                if (!this.isCacheValid()) {
                    this.clearCache();
                }
            }, 10 * 60 * 1000);
        }
    }
}
exports.PropertyCacheService = PropertyCacheService;
PropertyCacheService.instance = null;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2RvbWFpbi9zZXJ2aWNlcy9Qcm9wZXJ0eUNhY2hlU2VydmljZS50cyIsIm1hcHBpbmdzIjoiOzs7QUFFQTs7O0dBR0c7QUFDSCxNQUFhLG9CQUFvQjtJQVEvQjtRQU5RLGtCQUFhLEdBQUcsSUFBSSxHQUFHLEVBQWdDLENBQUM7UUFDeEQsdUJBQWtCLEdBQUcsSUFBSSxHQUFHLEVBQW9CLENBQUM7UUFDakQsb0JBQWUsR0FBRyxDQUFDLENBQUM7UUFDWCxjQUFTLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQyxZQUFZO1FBQ3ZDLG1CQUFjLEdBQUcsSUFBSSxDQUFDO1FBR3JDLElBQUksQ0FBQywwQkFBMEIsRUFBRSxDQUFDO0lBQ3BDLENBQUM7SUFFRCxNQUFNLENBQUMsV0FBVztRQUNoQixJQUFJLENBQUMsb0JBQW9CLENBQUMsUUFBUSxFQUFFO1lBQ2xDLG9CQUFvQixDQUFDLFFBQVEsR0FBRyxJQUFJLG9CQUFvQixFQUFFLENBQUM7U0FDNUQ7UUFDRCxPQUFPLG9CQUFvQixDQUFDLFFBQVEsQ0FBQztJQUN2QyxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILHFCQUFxQixDQUFDLFNBQWlCO1FBQ3JDLE1BQU0sUUFBUSxHQUFHLFNBQVMsU0FBUyxFQUFFLENBQUM7UUFFdEMsb0JBQW9CO1FBQ3BCLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRSxJQUFJLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQzNELE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBRSxDQUFDO1lBQ2pELE9BQU8sQ0FBQyxLQUFLLENBQUMsaUJBQWlCLFNBQVMsS0FBSyxNQUFNLENBQUMsTUFBTSxhQUFhLENBQUMsQ0FBQztZQUN6RSxPQUFPLENBQUMsR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLGtDQUFrQztT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LEVBQUUsVUFBVSxDQUFDLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRTtZQUNsRCxTQUFTLElBQUksR0FBRyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyw2QkFBNkI7WUFDMUQsU0FBUyxJQUFJLFVBQVUsQ0FBQyxNQUFNLEdBQUcsR0FBRyxDQUFDLENBQUMsaUNBQWlDO1NBQ3hFO1FBRUQsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUVEOztPQUVHO0lBQ0ssMEJBQTBCO1FBQ2hDLGtEQUFrRDtRQUNsRCxJQUFJLE9BQU8sV0FBVyxLQUFLLFdBQVcsRUFBRTtZQUN0QyxXQUFXLENBQUMsR0FBRyxFQUFFO2dCQUNmLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLEVBQUU7b0JBQ3hCLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztpQkFDbkI7WUFDSCxDQUFDLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztTQUNwQjtJQUNILENBQUM7O0FBck9ILG9EQXNPQztBQXJPZ0IsNkJBQVEsR0FBZ0MsSUFBSSxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9raXRlbGV2L0RvY3VtZW50cy9leG9jb3J0ZXgtb2JzaWRpYW4tcGx1Z2luL3NyYy9kb21haW4vc2VydmljZXMvUHJvcGVydHlDYWNoZVNlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVzdWx0IH0gZnJvbSBcIi4uL2NvcmUvUmVzdWx0XCI7XG5cbi8qKlxuICogUGVyZm9ybWFuY2Utb3B0aW1pemVkIGNhY2hpbmcgc2VydmljZSBmb3IgcHJvcGVydHkgZGVmaW5pdGlvbnNcbiAqIFJlZHVjZXMgZmlsZSBzeXN0ZW0gcmVhZHMgZHVyaW5nIGFzc2V0IGNyZWF0aW9uXG4gKi9cbmV4cG9ydCBjbGFzcyBQcm9wZXJ0eUNhY2hlU2VydmljZSB7XG4gIHByaXZhdGUgc3RhdGljIGluc3RhbmNlOiBQcm9wZXJ0eUNhY2hlU2VydmljZSB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIHByb3BlcnR5Q2FjaGUgPSBuZXcgTWFwPHN0cmluZywgUHJvcGVydHlEZWZpbml0aW9uW10+KCk7XG4gIHByaXZhdGUgY2xhc3NQcm9wZXJ0eUluZGV4ID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZ1tdPigpO1xuICBwcml2YXRlIGxhc3RDYWNoZVVwZGF0ZSA9IDA7XG4gIHByaXZhdGUgcmVhZG9ubHkgQ0FDSEVfVFRMID0gNSAqIDYwICogMTAwMDsgLy8gNSBtaW51dGVzXG4gIHByaXZhdGUgcmVhZG9ubHkgTUFYX0NBQ0hFX1NJWkUgPSAxMDAwO1xuXG4gIHByaXZhdGUgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5zZXR1cFBlcmZvcm1hbmNlTW9uaXRvcmluZygpO1xuICB9XG5cbiAgc3RhdGljIGdldEluc3RhbmNlKCk6IFByb3BlcnR5Q2FjaGVTZXJ2aWNlIHtcbiAgICBpZiAoIVByb3BlcnR5Q2FjaGVTZXJ2aWNlLmluc3RhbmNlKSB7XG4gICAgICBQcm9wZXJ0eUNhY2hlU2VydmljZS5pbnN0YW5jZSA9IG5ldyBQcm9wZXJ0eUNhY2hlU2VydmljZSgpO1xuICAgIH1cbiAgICByZXR1cm4gUHJvcGVydHlDYWNoZVNlcnZpY2UuaW5zdGFuY2U7XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBjYWNoZWQgcHJvcGVydGllcyBmb3IgYSBjbGFzcyB3aXRoIHBlcmZvcm1hbmNlIG9wdGltaXphdGlvblxuICAgKiBAcGFyYW0gY2xhc3NOYW1lIFRoZSBjbGFzcyB0byBnZXQgcHJvcGVydGllcyBmb3JcbiAgICogQHJldHVybnMgQXJyYXkgb2YgcHJvcGVydHkgZGVmaW5pdGlvbnNcbiAgICovXG4gIGdldFByb3BlcnRpZXNGb3JDbGFzcyhjbGFzc05hbWU6IHN0cmluZyk6IFByb3BlcnR5RGVmaW5pdGlvbltdIHtcbiAgICBjb25zdCBjYWNoZUtleSA9IGBjbGFzczoke2NsYXNzTmFtZX1gO1xuICAgIFxuICAgIC8vIENoZWNrIGNhY2hlIGZpcnN0XG4gICAgaWYgKHRoaXMuaXNDYWNoZVZhbGlkKCkgJiYgdGhpcy5wcm9wZXJ0eUNhY2hlLmhhcyhjYWNoZUtleSkpIHtcbiAgICAgIGNvbnN0IGNhY2hlZCA9IHRoaXMucHJvcGVydHlDYWNoZS5nZXQoY2FjaGVLZXkpITtcbiAgICAgIGNvbnNvbGUuZGVidWcoYENhY2hlIGhpdCBmb3IgJHtjbGFzc05hbWV9OiAke2NhY2hlZC5sZW5ndGh9IHByb3BlcnRpZXNgKTtcbiAgICAgIHJldHVybiBbLi4uY2FjaGVkXTsgLy8gUmV0dXJuIGNvcHkgdG8gcHJldmVudCBtdXRhdGlvblxuICAgIH1cblxuICAgIGNvbnNvbGUuZGVidWcoYENhY2hlIG1pc3MgZm9yICR7Y2xhc3NOYW1lfSwgcmV0dXJuaW5nIGVtcHR5IGFycmF5YCk7XG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZXMgY2FjaGUgd2l0aCBwcm9wZXJ0eSBkZWZpbml0aW9ucyBmb3IgYSBjbGFzc1xuICAgKiBAcGFyYW0gY2xhc3NOYW1lIFRoZSBjbGFzcyBuYW1lXG4gICAqIEBwYXJhbSBwcm9wZXJ0aWVzIEFycmF5IG9mIHByb3BlcnR5IGRlZmluaXRpb25zXG4gICAqL1xuICB1cGRhdGVDbGFzc1Byb3BlcnRpZXMoXG4gICAgY2xhc3NOYW1lOiBzdHJpbmcsXG4gICAgcHJvcGVydGllczogUHJvcGVydHlEZWZpbml0aW9uW10sXG4gICk6IHZvaWQge1xuICAgIGNvbnN0IGNhY2hlS2V5ID0gYGNsYXNzOiR7Y2xhc3NOYW1lfWA7XG4gICAgXG4gICAgLy8gSW1wbGVtZW50IGNhY2hlIHNpemUgbGltaXRcbiAgICBpZiAodGhpcy5wcm9wZXJ0eUNhY2hlLnNpemUgPj0gdGhpcy5NQVhfQ0FDSEVfU0laRSkge1xuICAgICAgdGhpcy5ldmljdE9sZGVzdEVudHJpZXMoKTtcbiAgICB9XG5cbiAgICAvLyBDYWNoZSB0aGUgcHJvcGVydGllc1xuICAgIHRoaXMucHJvcGVydHlDYWNoZS5zZXQoY2FjaGVLZXksIFsuLi5wcm9wZXJ0aWVzXSk7XG4gICAgXG4gICAgLy8gVXBkYXRlIGNsYXNzLXByb3BlcnR5IGluZGV4IGZvciBmYXN0ZXIgbG9va3Vwc1xuICAgIGNvbnN0IHByb3BlcnR5TmFtZXMgPSBwcm9wZXJ0aWVzLm1hcChwID0+IHAubmFtZSk7XG4gICAgdGhpcy5jbGFzc1Byb3BlcnR5SW5kZXguc2V0KGNsYXNzTmFtZSwgcHJvcGVydHlOYW1lcyk7XG4gICAgXG4gICAgdGhpcy5sYXN0Q2FjaGVVcGRhdGUgPSBEYXRlLm5vdygpO1xuICAgIFxuICAgIGNvbnNvbGUuZGVidWcoYENhY2hlZCAke3Byb3BlcnRpZXMubGVuZ3RofSBwcm9wZXJ0aWVzIGZvciAke2NsYXNzTmFtZX1gKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdWxrIHVwZGF0ZSBjYWNoZSB3aXRoIG11bHRpcGxlIGNsYXNzZXMgYXQgb25jZVxuICAgKiBAcGFyYW0gY2xhc3NQcm9wZXJ0aWVzTWFwIE1hcCBvZiBjbGFzcyBuYW1lIHRvIHByb3BlcnR5IGRlZmluaXRpb25zXG4gICAqL1xuICBidWxrVXBkYXRlQ2FjaGUoXG4gICAgY2xhc3NQcm9wZXJ0aWVzTWFwOiBNYXA8c3RyaW5nLCBQcm9wZXJ0eURlZmluaXRpb25bXT4sXG4gICk6IHZvaWQge1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpO1xuICAgIFxuICAgIGZvciAoY29uc3QgW2NsYXNzTmFtZSwgcHJvcGVydGllc10gb2YgY2xhc3NQcm9wZXJ0aWVzTWFwKSB7XG4gICAgICB0aGlzLnVwZGF0ZUNsYXNzUHJvcGVydGllcyhjbGFzc05hbWUsIHByb3BlcnRpZXMpO1xuICAgIH1cbiAgICBcbiAgICBjb25zdCBkdXJhdGlvbiA9IHBlcmZvcm1hbmNlLm5vdygpIC0gc3RhcnRUaW1lO1xuICAgIGNvbnNvbGUuZGVidWcoYEJ1bGsgY2FjaGUgdXBkYXRlIGNvbXBsZXRlZCBpbiAke2R1cmF0aW9uLnRvRml4ZWQoMil9bXMgZm9yICR7Y2xhc3NQcm9wZXJ0aWVzTWFwLnNpemV9IGNsYXNzZXNgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVja3MgaWYgYSBjbGFzcyBoYXMgY2FjaGVkIHByb3BlcnRpZXNcbiAgICogQHBhcmFtIGNsYXNzTmFtZSBUaGUgY2xhc3MgbmFtZSB0byBjaGVja1xuICAgKiBAcmV0dXJucyBUcnVlIGlmIHByb3BlcnRpZXMgYXJlIGNhY2hlZCBhbmQgdmFsaWRcbiAgICovXG4gIGhhc1Byb3BlcnRpZXNGb3JDbGFzcyhjbGFzc05hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmlzQ2FjaGVWYWxpZCgpICYmIHRoaXMucHJvcGVydHlDYWNoZS5oYXMoYGNsYXNzOiR7Y2xhc3NOYW1lfWApO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldHMgYWxsIGNhY2hlZCBjbGFzcyBuYW1lc1xuICAgKiBAcmV0dXJucyBBcnJheSBvZiBjbGFzcyBuYW1lcyBpbiBjYWNoZVxuICAgKi9cbiAgZ2V0Q2FjaGVkQ2xhc3NlcygpOiBzdHJpbmdbXSB7XG4gICAgaWYgKCF0aGlzLmlzQ2FjaGVWYWxpZCgpKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIFxuICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMuY2xhc3NQcm9wZXJ0eUluZGV4LmtleXMoKSk7XG4gIH1cblxuICAvKipcbiAgICogSW52YWxpZGF0ZXMgY2FjaGUgZm9yIGEgc3BlY2lmaWMgY2xhc3NcbiAgICogQHBhcmFtIGNsYXNzTmFtZSBUaGUgY2xhc3MgdG8gaW52YWxpZGF0ZVxuICAgKi9cbiAgaW52YWxpZGF0ZUNsYXNzKGNsYXNzTmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3QgY2FjaGVLZXkgPSBgY2xhc3M6JHtjbGFzc05hbWV9YDtcbiAgICB0aGlzLnByb3BlcnR5Q2FjaGUuZGVsZXRlKGNhY2hlS2V5KTtcbiAgICB0aGlzLmNsYXNzUHJvcGVydHlJbmRleC5kZWxldGUoY2xhc3NOYW1lKTtcbiAgICBjb25zb2xlLmRlYnVnKGBJbnZhbGlkYXRlZCBjYWNoZSBmb3IgJHtjbGFzc05hbWV9YCk7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXJzIGFsbCBjYWNoZWQgZGF0YVxuICAgKi9cbiAgY2xlYXJDYWNoZSgpOiB2b2lkIHtcbiAgICB0aGlzLnByb3BlcnR5Q2FjaGUuY2xlYXIoKTtcbiAgICB0aGlzLmNsYXNzUHJvcGVydHlJbmRleC5jbGVhcigpO1xuICAgIHRoaXMubGFzdENhY2hlVXBkYXRlID0gMDtcbiAgICBjb25zb2xlLmRlYnVnKFwiQ2FjaGUgY2xlYXJlZFwiKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXRzIGNhY2hlIHN0YXRpc3RpY3MgZm9yIHBlcmZvcm1hbmNlIG1vbml0b3JpbmdcbiAgICogQHJldHVybnMgQ2FjaGUgcGVyZm9ybWFuY2UgbWV0cmljc1xuICAgKi9cbiAgZ2V0Q2FjaGVTdGF0cygpOiBDYWNoZVN0YXRzIHtcbiAgICByZXR1cm4ge1xuICAgICAgc2l6ZTogdGhpcy5wcm9wZXJ0eUNhY2hlLnNpemUsXG4gICAgICBjbGFzc0NvdW50OiB0aGlzLmNsYXNzUHJvcGVydHlJbmRleC5zaXplLFxuICAgICAgbGFzdFVwZGF0ZTogdGhpcy5sYXN0Q2FjaGVVcGRhdGUsXG4gICAgICBpc1ZhbGlkOiB0aGlzLmlzQ2FjaGVWYWxpZCgpLFxuICAgICAgaGl0UmF0ZTogdGhpcy5jYWxjdWxhdGVIaXRSYXRlKCksXG4gICAgICBtZW1vcnlVc2FnZTogdGhpcy5lc3RpbWF0ZU1lbW9yeVVzYWdlKCksXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQcmVsb2FkcyBwcm9wZXJ0aWVzIGZvciBjb21tb24gY2xhc3NlcyB0byBpbXByb3ZlIHBlcmZvcm1hbmNlXG4gICAqIEBwYXJhbSBwcmlvcml0eUNsYXNzZXMgQXJyYXkgb2YgY2xhc3MgbmFtZXMgdG8gcHJpb3JpdGl6ZVxuICAgKi9cbiAgYXN5bmMgcHJlbG9hZFByaW9yaXR5Q2xhc3Nlcyhwcmlvcml0eUNsYXNzZXM6IHN0cmluZ1tdKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc29sZS5kZWJ1ZyhgUHJlbG9hZGluZyAke3ByaW9yaXR5Q2xhc3Nlcy5sZW5ndGh9IHByaW9yaXR5IGNsYXNzZXNgKTtcbiAgICBcbiAgICBjb25zdCBzdGFydFRpbWUgPSBwZXJmb3JtYW5jZS5ub3coKTtcbiAgICBjb25zdCBwcmVsb2FkTWFwID0gbmV3IE1hcDxzdHJpbmcsIFByb3BlcnR5RGVmaW5pdGlvbltdPigpO1xuICAgIFxuICAgIC8vIEZvciBub3csIHNldCBlbXB0eSBhcnJheXMgdG8gaW5kaWNhdGUgY2xhc3NlcyBhcmUgXCJsb2FkZWRcIlxuICAgIC8vIEluIGEgcmVhbCBpbXBsZW1lbnRhdGlvbiwgdGhpcyB3b3VsZCBmZXRjaCBmcm9tIHRoZSB2YXVsdFxuICAgIGZvciAoY29uc3QgY2xhc3NOYW1lIG9mIHByaW9yaXR5Q2xhc3Nlcykge1xuICAgICAgaWYgKCF0aGlzLmhhc1Byb3BlcnRpZXNGb3JDbGFzcyhjbGFzc05hbWUpKSB7XG4gICAgICAgIHByZWxvYWRNYXAuc2V0KGNsYXNzTmFtZSwgW10pO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICBpZiAocHJlbG9hZE1hcC5zaXplID4gMCkge1xuICAgICAgdGhpcy5idWxrVXBkYXRlQ2FjaGUocHJlbG9hZE1hcCk7XG4gICAgfVxuICAgIFxuICAgIGNvbnN0IGR1cmF0aW9uID0gcGVyZm9ybWFuY2Uubm93KCkgLSBzdGFydFRpbWU7XG4gICAgY29uc29sZS5kZWJ1ZyhgUHJlbG9hZCBjb21wbGV0ZWQgaW4gJHtkdXJhdGlvbi50b0ZpeGVkKDIpfW1zYCk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2tzIGlmIGNhY2hlIGlzIHN0aWxsIHZhbGlkIGJhc2VkIG9uIFRUTFxuICAgKi9cbiAgcHJpdmF0ZSBpc0NhY2hlVmFsaWQoKTogYm9vbGVhbiB7XG4gICAgaWYgKHRoaXMubGFzdENhY2hlVXBkYXRlID09PSAwKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiAoRGF0ZS5ub3coKSAtIHRoaXMubGFzdENhY2hlVXBkYXRlKSA8IHRoaXMuQ0FDSEVfVFRMO1xuICB9XG5cbiAgLyoqXG4gICAqIEV2aWN0cyBvbGRlc3QgY2FjaGUgZW50cmllcyB0byBtYWludGFpbiBzaXplIGxpbWl0XG4gICAqL1xuICBwcml2YXRlIGV2aWN0T2xkZXN0RW50cmllcygpOiB2b2lkIHtcbiAgICBjb25zdCBlbnRyaWVzVG9FdmljdCA9IE1hdGguZmxvb3IodGhpcy5NQVhfQ0FDSEVfU0laRSAqIDAuMik7IC8vIFJlbW92ZSAyMCVcbiAgICBjb25zdCBlbnRyaWVzID0gQXJyYXkuZnJvbSh0aGlzLnByb3BlcnR5Q2FjaGUua2V5cygpKTtcbiAgICBcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGVudHJpZXNUb0V2aWN0ICYmIGVudHJpZXMubGVuZ3RoID4gMDsgaSsrKSB7XG4gICAgICBjb25zdCBrZXlUb0V2aWN0ID0gZW50cmllc1tpXTtcbiAgICAgIHRoaXMucHJvcGVydHlDYWNoZS5kZWxldGUoa2V5VG9FdmljdCk7XG4gICAgICBcbiAgICAgIC8vIEV4dHJhY3QgY2xhc3MgbmFtZSBmcm9tIGNhY2hlIGtleVxuICAgICAgY29uc3QgY2xhc3NOYW1lID0ga2V5VG9FdmljdC5yZXBsYWNlKCdjbGFzczonLCAnJyk7XG4gICAgICB0aGlzLmNsYXNzUHJvcGVydHlJbmRleC5kZWxldGUoY2xhc3NOYW1lKTtcbiAgICB9XG4gICAgXG4gICAgY29uc29sZS5kZWJ1ZyhgRXZpY3RlZCAke2VudHJpZXNUb0V2aWN0fSBjYWNoZSBlbnRyaWVzYCk7XG4gIH1cblxuICAvKipcbiAgICogQ2FsY3VsYXRlcyBjYWNoZSBoaXQgcmF0ZSBmb3IgcGVyZm9ybWFuY2UgbW9uaXRvcmluZ1xuICAgKi9cbiAgcHJpdmF0ZSBjYWxjdWxhdGVIaXRSYXRlKCk6IG51bWJlciB7XG4gICAgLy8gVGhpcyB3b3VsZCBiZSB0cmFja2VkIGluIGEgcmVhbCBpbXBsZW1lbnRhdGlvblxuICAgIHJldHVybiAwLjg1OyAvLyBQbGFjZWhvbGRlclxuICB9XG5cbiAgLyoqXG4gICAqIEVzdGltYXRlcyBtZW1vcnkgdXNhZ2Ugb2YgY2FjaGVkIGRhdGFcbiAgICovXG4gIHByaXZhdGUgZXN0aW1hdGVNZW1vcnlVc2FnZSgpOiBudW1iZXIge1xuICAgIGxldCB0b3RhbFNpemUgPSAwO1xuICAgIFxuICAgIGZvciAoY29uc3QgW2tleSwgcHJvcGVydGllc10gb2YgdGhpcy5wcm9wZXJ0eUNhY2hlKSB7XG4gICAgICB0b3RhbFNpemUgKz0ga2V5Lmxlbmd0aCAqIDI7IC8vIFN0cmluZyBjaGFyYWN0ZXJzIGFzIGJ5dGVzXG4gICAgICB0b3RhbFNpemUgKz0gcHJvcGVydGllcy5sZW5ndGggKiAyMDA7IC8vIEVzdGltYXRlZCBwcm9wZXJ0eSBvYmplY3Qgc2l6ZVxuICAgIH1cbiAgICBcbiAgICByZXR1cm4gdG90YWxTaXplO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldHMgdXAgcGVyZm9ybWFuY2UgbW9uaXRvcmluZyBhbmQgY2xlYW51cFxuICAgKi9cbiAgcHJpdmF0ZSBzZXR1cFBlcmZvcm1hbmNlTW9uaXRvcmluZygpOiB2b2lkIHtcbiAgICAvLyBBdXRvLWNsZWFudXAgb2xkIGNhY2hlIGVudHJpZXMgZXZlcnkgMTAgbWludXRlc1xuICAgIGlmICh0eXBlb2Ygc2V0SW50ZXJ2YWwgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgIGlmICghdGhpcy5pc0NhY2hlVmFsaWQoKSkge1xuICAgICAgICAgIHRoaXMuY2xlYXJDYWNoZSgpO1xuICAgICAgICB9XG4gICAgICB9LCAxMCAqIDYwICogMTAwMCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUHJvcGVydHlEZWZpbml0aW9uIHtcbiAgbmFtZTogc3RyaW5nO1xuICBsYWJlbDogc3RyaW5nO1xuICBkZXNjcmlwdGlvbjogc3RyaW5nO1xuICB0eXBlOiBzdHJpbmc7XG4gIGlzUmVxdWlyZWQ6IGJvb2xlYW47XG4gIHJhbmdlPzogc3RyaW5nO1xuICBvcHRpb25zPzogYW55W107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2FjaGVTdGF0cyB7XG4gIHNpemU6IG51bWJlcjtcbiAgY2xhc3NDb3VudDogbnVtYmVyO1xuICBsYXN0VXBkYXRlOiBudW1iZXI7XG4gIGlzVmFsaWQ6IGJvb2xlYW47XG4gIGhpdFJhdGU6IG51bWJlcjtcbiAgbWVtb3J5VXNhZ2U6IG51bWJlcjtcbn0iXSwidmVyc2lvbiI6M30=