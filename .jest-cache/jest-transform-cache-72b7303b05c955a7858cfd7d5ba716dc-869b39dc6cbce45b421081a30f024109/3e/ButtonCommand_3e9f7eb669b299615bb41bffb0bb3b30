f0ee6bed874dec6b407256c975c282c9
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ButtonCommand = exports.CommandType = void 0;
const Entity_1 = require("../core/Entity");
const Result_1 = require("../core/Result");
/**
 * Types of commands that can be executed
 */
var CommandType;
(function (CommandType) {
    CommandType["CREATE_ASSET"] = "CREATE_ASSET";
    CommandType["CREATE_CHILD_TASK"] = "CREATE_CHILD_TASK";
    CommandType["CREATE_CHILD_AREA"] = "CREATE_CHILD_AREA";
    CommandType["OPEN_ASSET"] = "OPEN_ASSET";
    CommandType["DELETE_ASSET"] = "DELETE_ASSET";
    CommandType["RUN_TEMPLATE"] = "RUN_TEMPLATE";
    CommandType["EXECUTE_SEARCH"] = "EXECUTE_SEARCH";
    CommandType["TRIGGER_WORKFLOW"] = "TRIGGER_WORKFLOW";
    CommandType["CUSTOM"] = "CUSTOM";
})(CommandType = exports.CommandType || (exports.CommandType = {}));
class ButtonCommand extends Entity_1.Entity {
    constructor(props) {
        super(props, props.id.toString());
    }
    generateId() {
        return this.props.id.toString();
    }
    validate() {
        if (!this.props.id) {
            throw new Error("ButtonCommand must have a valid ID");
        }
        if (!this.props.name || this.props.name.trim().length === 0) {
            throw new Error("ButtonCommand must have a non-empty name");
        }
        if (!this.props.type) {
            throw new Error("ButtonCommand must have a valid type");
        }
    }
    /**
     * Factory method with validation
     */
    static create(props) {
        // Validate command name
        if (!props.name || props.name.trim().length === 0) {
            return Result_1.Result.fail("Command name cannot be empty");
        }
        // Validate parameters if input is required
        if (props.requiresInput &&
            (!props.parameters || props.parameters.length === 0)) {
            return Result_1.Result.fail("Commands requiring input must define parameters");
        }
        // Validate each parameter
        for (const param of props.parameters) {
            if (!param.name || param.name.trim().length === 0) {
                return Result_1.Result.fail("Parameter name cannot be empty");
            }
            if (param.validation) {
                try {
                    new RegExp(param.validation);
                }
                catch (e) {
                    return Result_1.Result.fail(`Invalid validation regex for parameter ${param.name}`);
                }
            }
        }
        // Validate command-specific requirements
        if (props.type === CommandType.RUN_TEMPLATE && !props.template) {
            return Result_1.Result.fail("Template commands must specify a template");
        }
        if (props.type === CommandType.CUSTOM && !props.script) {
            return Result_1.Result.fail("Custom commands must specify a script");
        }
        return Result_1.Result.ok(new ButtonCommand(props));
    }
    // Getters
    get id() {
        return this.props.id;
    }
    get type() {
        return this.props.type;
    }
    get name() {
        return this.props.name;
    }
    get description() {
        return this.props.description;
    }
    get requiresInput() {
        return this.props.requiresInput;
    }
    get parameters() {
        return this.props.parameters;
    }
    get targetClass() {
        return this.props.targetClass;
    }
    get template() {
        return this.props.template;
    }
    get script() {
        return this.props.script;
    }
    /**
     * Validate input parameters against command definition
     */
    validateInput(input) {
        const validated = {};
        const errors = [];
        for (const param of this.parameters) {
            const value = input[param.name];
            // Check required parameters
            if (param.required &&
                (value === undefined || value === null || value === "")) {
                errors.push(`Required parameter '${param.name}' is missing`);
                continue;
            }
            // Skip optional parameters if not provided
            if (!param.required && (value === undefined || value === null)) {
                if (param.defaultValue !== undefined) {
                    validated[param.name] = param.defaultValue;
                }
                continue;
            }
            // Type validation
            if (!this.validateParameterType(value, param.type)) {
                errors.push(`Parameter '${param.name}' must be of type ${param.type}`);
                continue;
            }
            // Custom validation
            if (param.validation) {
                const regex = new RegExp(param.validation);
                if (!regex.test(String(value))) {
                    errors.push(`Parameter '${param.name}' does not match validation pattern`);
                    continue;
                }
            }
            validated[param.name] = value;
        }
        if (errors.length > 0) {
            return Result_1.Result.fail(errors.join("; "));
        }
        return Result_1.Result.ok(validated);
    }
    /**
     * Check if command can be executed in current context
     */
    canExecute(context) {
        // Check if command is applicable to current class
        if (this.targetClass && context.currentClass !== this.targetClass) {
            return false;
        }
        // Check if command requires selection
        if (this.type === CommandType.DELETE_ASSET && !context.hasSelection) {
            return false;
        }
        return true;
    }
    /**
     * Build execution context for the command
     */
    buildExecutionContext(input) {
        const validationResult = this.validateInput(input);
        if (validationResult.isFailure) {
            return Result_1.Result.fail(validationResult.error);
        }
        const context = {
            commandId: this.id.toString(),
            commandType: this.type,
            parameters: validationResult.getValue(),
            timestamp: new Date(),
            template: this.props.template,
            script: this.props.script,
            targetClass: this.props.targetClass,
        };
        return Result_1.Result.ok(context);
    }
    validateParameterType(value, type) {
        switch (type) {
            case "string":
                return typeof value === "string";
            case "number":
                return typeof value === "number" || !isNaN(Number(value));
            case "boolean":
                return (typeof value === "boolean" || value === "true" || value === "false");
            case "date":
                return !isNaN(Date.parse(String(value)));
            case "asset":
                return (typeof value === "string" &&
                    value.startsWith("[[") &&
                    value.endsWith("]]"));
            case "array":
                return Array.isArray(value) || typeof value === "string";
            default:
                return true;
        }
    }
}
exports.ButtonCommand = ButtonCommand;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2RvbWFpbi9lbnRpdGllcy9CdXR0b25Db21tYW5kLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLDJDQUF3QztBQUV4QywyQ0FBd0M7QUFFeEM7O0dBRUc7QUFDSCxJQUFZLFdBVVg7QUFWRCxXQUFZLFdBQVc7SUFDckIsNENBQTZCLENBQUE7SUFDN0Isc0RBQXVDLENBQUE7SUFDdkMsc0RBQXVDLENBQUE7SUFDdkMsd0NBQXlCLENBQUE7SUFDekIsNENBQTZCLENBQUE7SUFDN0IsNENBQTZCLENBQUE7SUFDN0IsZ0RBQWlDLENBQUE7SUFDakMsb0RBQXFDLENBQUE7SUFDckMsZ0NBQWlCLENBQUE7QUFDbkIsQ0FBQyxFQVZXLFdBQVcsR0FBWCxtQkFBVyxLQUFYLG1CQUFXLFFBVXRCO0FBOEJELE1BQWEsYUFBYyxTQUFRLGVBQTBCO0lBQzNELFlBQW9CLEtBQXlCO1FBQzNDLEtBQUssQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFFUyxVQUFVO1FBQ2xCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDbEMsQ0FBQztJQUVTLFFBQVE7UUFDaEIsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFO1lBQ2xCLE1BQU0sSUFBSSxLQUFLLENBQUMsb0NBQW9DLENBQUMsQ0FBQztTQUN2RDtRQUVELElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQzNELE1BQU0sSUFBSSxLQUFLLENBQUMsMENBQTBDLENBQUMsQ0FBQztTQUM3RDtRQUVELElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRTtZ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LENBQUMsS0FBSyxDQUFDLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxDQUFDO1lBQzNEO2dCQUNFLE9BQU8sSUFBSSxDQUFDO1NBQ2Y7SUFDSCxDQUFDO0NBQ0Y7QUE3T0Qsc0NBNk9DIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9raXRlbGV2L0RvY3VtZW50cy9leG9jb3J0ZXgtb2JzaWRpYW4tcGx1Z2luL3NyYy9kb21haW4vZW50aXRpZXMvQnV0dG9uQ29tbWFuZC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFbnRpdHkgfSBmcm9tIFwiLi4vY29yZS9FbnRpdHlcIjtcbmltcG9ydCB7IEFzc2V0SWQgfSBmcm9tIFwiLi4vdmFsdWUtb2JqZWN0cy9Bc3NldElkXCI7XG5pbXBvcnQgeyBSZXN1bHQgfSBmcm9tIFwiLi4vY29yZS9SZXN1bHRcIjtcblxuLyoqXG4gKiBUeXBlcyBvZiBjb21tYW5kcyB0aGF0IGNhbiBiZSBleGVjdXRlZFxuICovXG5leHBvcnQgZW51bSBDb21tYW5kVHlwZSB7XG4gIENSRUFURV9BU1NFVCA9IFwiQ1JFQVRFX0FTU0VUXCIsXG4gIENSRUFURV9DSElMRF9UQVNLID0gXCJDUkVBVEVfQ0hJTERfVEFTS1wiLFxuICBDUkVBVEVfQ0hJTERfQVJFQSA9IFwiQ1JFQVRFX0NISUxEX0FSRUFcIixcbiAgT1BFTl9BU1NFVCA9IFwiT1BFTl9BU1NFVFwiLFxuICBERUxFVEVfQVNTRVQgPSBcIkRFTEVURV9BU1NFVFwiLFxuICBSVU5fVEVNUExBVEUgPSBcIlJVTl9URU1QTEFURVwiLFxuICBFWEVDVVRFX1NFQVJDSCA9IFwiRVhFQ1VURV9TRUFSQ0hcIixcbiAgVFJJR0dFUl9XT1JLRkxPVyA9IFwiVFJJR0dFUl9XT1JLRkxPV1wiLFxuICBDVVNUT00gPSBcIkNVU1RPTVwiLFxufVxuXG4vKipcbiAqIFBhcmFtZXRlciBkZWZpbml0aW9uIGZvciBjb21tYW5kIGlucHV0c1xuICovXG5leHBvcnQgaW50ZXJmYWNlIENvbW1hbmRQYXJhbWV0ZXIge1xuICBuYW1lOiBzdHJpbmc7XG4gIHR5cGU6IFwic3RyaW5nXCIgfCBcIm51bWJlclwiIHwgXCJib29sZWFuXCIgfCBcImFzc2V0XCIgfCBcImRhdGVcIiB8IFwiYXJyYXlcIjtcbiAgcmVxdWlyZWQ6IGJvb2xlYW47XG4gIGRlZmF1bHRWYWx1ZT86IGFueTtcbiAgbGFiZWw/OiBzdHJpbmc7XG4gIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuICB2YWxpZGF0aW9uPzogc3RyaW5nOyAvLyBSZWdleCBvciB2YWxpZGF0aW9uIHJ1bGVcbn1cblxuLyoqXG4gKiBEb21haW4gRW50aXR5IHJlcHJlc2VudGluZyBhIEJ1dHRvbiBDb21tYW5kXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQnV0dG9uQ29tbWFuZFByb3BzIHtcbiAgaWQ6IEFzc2V0SWQ7XG4gIHR5cGU6IENvbW1hbmRUeXBlO1xuICBuYW1lOiBzdHJpbmc7XG4gIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuICByZXF1aXJlc0lucHV0OiBib29sZWFuO1xuICBwYXJhbWV0ZXJzOiBDb21tYW5kUGFyYW1ldGVyW107XG4gIHRhcmdldENsYXNzPzogc3RyaW5nOyAvLyBGb3IgY29tbWFuZHMgdGhhdCBvcGVyYXRlIG9uIHNwZWNpZmljIGNsYXNzZXNcbiAgdGVtcGxhdGU/OiBzdHJpbmc7IC8vIEZvciB0ZW1wbGF0ZS1iYXNlZCBjb21tYW5kc1xuICBzY3JpcHQ/OiBzdHJpbmc7IC8vIEZvciBjdXN0b20gc2NyaXB0IGNvbW1hbmRzXG59XG5cbmV4cG9ydCBjbGFzcyBCdXR0b25Db21tYW5kIGV4dGVuZHMgRW50aXR5PEJ1dHRvbkNvbW1hbmRQcm9wcz4ge1xuICBwcml2YXRlIGNvbnN0cnVjdG9yKHByb3BzOiBCdXR0b25Db21tYW5kUHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcywgcHJvcHMuaWQudG9TdHJpbmcoKSk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2VuZXJhdGVJZCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnByb3BzLmlkLnRvU3RyaW5nKCk7XG4gIH1cblxuICBwcm90ZWN0ZWQgdmFsaWRhdGUoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLnByb3BzLmlkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJCdXR0b25Db21tYW5kIG11c3QgaGF2ZSBhIHZhbGlkIElEXCIpO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5wcm9wcy5uYW1lIHx8IHRoaXMucHJvcHMubmFtZS50cmltKCkubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJCdXR0b25Db21tYW5kIG11c3QgaGF2ZSBhIG5vbi1lbXB0eSBuYW1lXCIpO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5wcm9wcy50eXBlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJCdXR0b25Db21tYW5kIG11c3QgaGF2ZSBhIHZhbGlkIHR5cGVcIik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEZhY3RvcnkgbWV0aG9kIHdpdGggdmFsaWRhdGlvblxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBjcmVhdGUocHJvcHM6IEJ1dHRvbkNvbW1hbmRQcm9wcyk6IFJlc3VsdDxCdXR0b25Db21tYW5kPiB7XG4gICAgLy8gVmFsaWRhdGUgY29tbWFuZCBuYW1lXG4gICAgaWYgKCFwcm9wcy5uYW1lIHx8IHByb3BzLm5hbWUudHJpbSgpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPEJ1dHRvbkNvbW1hbmQ+KFwiQ29tbWFuZCBuYW1lIGNhbm5vdCBiZSBlbXB0eVwiKTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSBwYXJhbWV0ZXJzIGlmIGlucHV0IGlzIHJlcXVpcmVkXG4gICAgaWYgKFxuICAgICAgcHJvcHMucmVxdWlyZXNJbnB1dCAmJlxuICAgICAgKCFwcm9wcy5wYXJhbWV0ZXJzIHx8IHByb3BzLnBhcmFtZXRlcnMubGVuZ3RoID09PSAwKVxuICAgICkge1xuICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPEJ1dHRvbkNvbW1hbmQ+KFxuICAgICAgICBcIkNvbW1hbmRzIHJlcXVpcmluZyBpbnB1dCBtdXN0IGRlZmluZSBwYXJhbWV0ZXJzXCIsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIGVhY2ggcGFyYW1ldGVyXG4gICAgZm9yIChjb25zdCBwYXJhbSBvZiBwcm9wcy5wYXJhbWV0ZXJzKSB7XG4gICAgICBpZiAoIXBhcmFtLm5hbWUgfHwgcGFyYW0ubmFtZS50cmltKCkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxCdXR0b25Db21tYW5kPihcIlBhcmFtZXRlciBuYW1lIGNhbm5vdCBiZSBlbXB0eVwiKTtcbiAgICAgIH1cblxuICAgICAgaWYgKHBhcmFtLnZhbGlkYXRpb24pIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBuZXcgUmVnRXhwKHBhcmFtLnZhbGlkYXRpb24pO1xuICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPEJ1dHRvbkNvbW1hbmQ+KFxuICAgICAgICAgICAgYEludmFsaWQgdmFsaWRhdGlvbiByZWdleCBmb3IgcGFyYW1ldGVyICR7cGFyYW0ubmFtZX1gLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSBjb21tYW5kLXNwZWNpZmljIHJlcXVpcmVtZW50c1xuICAgIGlmIChwcm9wcy50eXBlID09PSBDb21tYW5kVHlwZS5SVU5fVEVNUExBVEUgJiYgIXByb3BzLnRlbXBsYXRlKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8QnV0dG9uQ29tbWFuZD4oXG4gICAgICAgIFwiVGVtcGxhdGUgY29tbWFuZHMgbXVzdCBzcGVjaWZ5IGEgdGVtcGxhdGVcIixcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKHByb3BzLnR5cGUgPT09IENvbW1hbmRUeXBlLkNVU1RPTSAmJiAhcHJvcHMuc2NyaXB0KSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8QnV0dG9uQ29tbWFuZD4oXG4gICAgICAgIFwiQ3VzdG9tIGNvbW1hbmRzIG11c3Qgc3BlY2lmeSBhIHNjcmlwdFwiLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gUmVzdWx0Lm9rPEJ1dHRvbkNvbW1hbmQ+KG5ldyBCdXR0b25Db21tYW5kKHByb3BzKSk7XG4gIH1cblxuICAvLyBHZXR0ZXJzXG4gIGdldCBpZCgpOiBBc3NldElkIHtcbiAgICByZXR1cm4gdGhpcy5wcm9wcy5pZDtcbiAgfVxuXG4gIGdldCB0eXBlKCk6IENvbW1hbmRUeXBlIHtcbiAgICByZXR1cm4gdGhpcy5wcm9wcy50eXBlO1xuICB9XG5cbiAgZ2V0IG5hbWUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5wcm9wcy5uYW1lO1xuICB9XG5cbiAgZ2V0IGRlc2NyaXB0aW9uKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMucHJvcHMuZGVzY3JpcHRpb247XG4gIH1cblxuICBnZXQgcmVxdWlyZXNJbnB1dCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5wcm9wcy5yZXF1aXJlc0lucHV0O1xuICB9XG5cbiAgZ2V0IHBhcmFtZXRlcnMoKTogQ29tbWFuZFBhcmFtZXRlcltdIHtcbiAgICByZXR1cm4gdGhpcy5wcm9wcy5wYXJhbWV0ZXJzO1xuICB9XG5cbiAgZ2V0IHRhcmdldENsYXNzKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMucHJvcHMudGFyZ2V0Q2xhc3M7XG4gIH1cblxuICBnZXQgdGVtcGxhdGUoKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5wcm9wcy50ZW1wbGF0ZTtcbiAgfVxuXG4gIGdldCBzY3JpcHQoKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5wcm9wcy5zY3JpcHQ7XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGUgaW5wdXQgcGFyYW1ldGVycyBhZ2FpbnN0IGNvbW1hbmQgZGVmaW5pdGlvblxuICAgKi9cbiAgcHVibGljIHZhbGlkYXRlSW5wdXQoXG4gICAgaW5wdXQ6IFJlY29yZDxzdHJpbmcsIGFueT4sXG4gICk6IFJlc3VsdDxSZWNvcmQ8c3RyaW5nLCBhbnk+PiB7XG4gICAgY29uc3QgdmFsaWRhdGVkOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XG4gICAgY29uc3QgZXJyb3JzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgZm9yIChjb25zdCBwYXJhbSBvZiB0aGlzLnBhcmFtZXRlcnMpIHtcbiAgICAgIGNvbnN0IHZhbHVlID0gaW5wdXRbcGFyYW0ubmFtZV07XG5cbiAgICAgIC8vIENoZWNrIHJlcXVpcmVkIHBhcmFtZXRlcnNcbiAgICAgIGlmIChcbiAgICAgICAgcGFyYW0ucmVxdWlyZWQgJiZcbiAgICAgICAgKHZhbHVlID09PSB1bmRlZmluZWQgfHwgdmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IFwiXCIpXG4gICAgICApIHtcbiAgICAgICAgZXJyb3JzLnB1c2goYFJlcXVpcmVkIHBhcmFtZXRlciAnJHtwYXJhbS5uYW1lfScgaXMgbWlzc2luZ2ApO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgLy8gU2tpcCBvcHRpb25hbCBwYXJhbWV0ZXJzIGlmIG5vdCBwcm92aWRlZFxuICAgICAgaWYgKCFwYXJhbS5yZXF1aXJlZCAmJiAodmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbCkpIHtcbiAgICAgICAgaWYgKHBhcmFtLmRlZmF1bHRWYWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgdmFsaWRhdGVkW3BhcmFtLm5hbWVdID0gcGFyYW0uZGVmYXVsdFZhbHVlO1xuICAgICAgICB9XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICAvLyBUeXBlIHZhbGlkYXRpb25cbiAgICAgIGlmICghdGhpcy52YWxpZGF0ZVBhcmFtZXRlclR5cGUodmFsdWUsIHBhcmFtLnR5cGUpKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKGBQYXJhbWV0ZXIgJyR7cGFyYW0ubmFtZX0nIG11c3QgYmUgb2YgdHlwZSAke3BhcmFtLnR5cGV9YCk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICAvLyBDdXN0b20gdmFsaWRhdGlvblxuICAgICAgaWYgKHBhcmFtLnZhbGlkYXRpb24pIHtcbiAgICAgICAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKHBhcmFtLnZhbGlkYXRpb24pO1xuICAgICAgICBpZiAoIXJlZ2V4LnRlc3QoU3RyaW5nKHZhbHVlKSkpIHtcbiAgICAgICAgICBlcnJvcnMucHVzaChcbiAgICAgICAgICAgIGBQYXJhbWV0ZXIgJyR7cGFyYW0ubmFtZX0nIGRvZXMgbm90IG1hdGNoIHZhbGlkYXRpb24gcGF0dGVybmAsXG4gICAgICAgICAgKTtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICB2YWxpZGF0ZWRbcGFyYW0ubmFtZV0gPSB2YWx1ZTtcbiAgICB9XG5cbiAgICBpZiAoZXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxSZWNvcmQ8c3RyaW5nLCBhbnk+PihlcnJvcnMuam9pbihcIjsgXCIpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gUmVzdWx0Lm9rPFJlY29yZDxzdHJpbmcsIGFueT4+KHZhbGlkYXRlZCk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgY29tbWFuZCBjYW4gYmUgZXhlY3V0ZWQgaW4gY3VycmVudCBjb250ZXh0XG4gICAqL1xuICBwdWJsaWMgY2FuRXhlY3V0ZShjb250ZXh0OiB7XG4gICAgY3VycmVudENsYXNzPzogc3RyaW5nO1xuICAgIGhhc1NlbGVjdGlvbj86IGJvb2xlYW47XG4gIH0pOiBib29sZWFuIHtcbiAgICAvLyBDaGVjayBpZiBjb21tYW5kIGlzIGFwcGxpY2FibGUgdG8gY3VycmVudCBjbGFzc1xuICAgIGlmICh0aGlzLnRhcmdldENsYXNzICYmIGNvbnRleHQuY3VycmVudENsYXNzICE9PSB0aGlzLnRhcmdldENsYXNzKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgY29tbWFuZCByZXF1aXJlcyBzZWxlY3Rpb25cbiAgICBpZiAodGhpcy50eXBlID09PSBDb21tYW5kVHlwZS5ERUxFVEVfQVNTRVQgJiYgIWNvbnRleHQuaGFzU2VsZWN0aW9uKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICogQnVpbGQgZXhlY3V0aW9uIGNvbnRleHQgZm9yIHRoZSBjb21tYW5kXG4gICAqL1xuICBwdWJsaWMgYnVpbGRFeGVjdXRpb25Db250ZXh0KFxuICAgIGlucHV0OiBSZWNvcmQ8c3RyaW5nLCBhbnk+LFxuICApOiBSZXN1bHQ8Q29tbWFuZEV4ZWN1dGlvbkNvbnRleHQ+IHtcbiAgICBjb25zdCB2YWxpZGF0aW9uUmVzdWx0ID0gdGhpcy52YWxpZGF0ZUlucHV0KGlucHV0KTtcblxuICAgIGlmICh2YWxpZGF0aW9uUmVzdWx0LmlzRmFpbHVyZSkge1xuICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPENvbW1hbmRFeGVjdXRpb25Db250ZXh0Pih2YWxpZGF0aW9uUmVzdWx0LmVycm9yKTtcbiAgICB9XG5cbiAgICBjb25zdCBjb250ZXh0OiBDb21tYW5kRXhlY3V0aW9uQ29udGV4dCA9IHtcbiAgICAgIGNvbW1hbmRJZDogdGhpcy5pZC50b1N0cmluZygpLFxuICAgICAgY29tbWFuZFR5cGU6IHRoaXMudHlwZSxcbiAgICAgIHBhcmFtZXRlcnM6IHZhbGlkYXRpb25SZXN1bHQuZ2V0VmFsdWUoKSxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgIHRlbXBsYXRlOiB0aGlzLnByb3BzLnRlbXBsYXRlLFxuICAgICAgc2NyaXB0OiB0aGlzLnByb3BzLnNjcmlwdCxcbiAgICAgIHRhcmdldENsYXNzOiB0aGlzLnByb3BzLnRhcmdldENsYXNzLFxuICAgIH07XG5cbiAgICByZXR1cm4gUmVzdWx0Lm9rPENvbW1hbmRFeGVjdXRpb25Db250ZXh0Pihjb250ZXh0KTtcbiAgfVxuXG4gIHByaXZhdGUgdmFsaWRhdGVQYXJhbWV0ZXJUeXBlKHZhbHVlOiBhbnksIHR5cGU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgY2FzZSBcInN0cmluZ1wiOlxuICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSBcInN0cmluZ1wiO1xuICAgICAgY2FzZSBcIm51bWJlclwiOlxuICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSBcIm51bWJlclwiIHx8ICFpc05hTihOdW1iZXIodmFsdWUpKTtcbiAgICAgIGNhc2UgXCJib29sZWFuXCI6XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgdHlwZW9mIHZhbHVlID09PSBcImJvb2xlYW5cIiB8fCB2YWx1ZSA9PT0gXCJ0cnVlXCIgfHwgdmFsdWUgPT09IFwiZmFsc2VcIlxuICAgICAgICApO1xuICAgICAgY2FzZSBcImRhdGVcIjpcbiAgICAgICAgcmV0dXJuICFpc05hTihEYXRlLnBhcnNlKFN0cmluZyh2YWx1ZSkpKTtcbiAgICAgIGNhc2UgXCJhc3NldFwiOlxuICAgICAgICByZXR1cm4gKFxuICAgICAgICAgIHR5cGVvZiB2YWx1ZSA9PT0gXCJzdHJpbmdcIiAmJlxuICAgICAgICAgIHZhbHVlLnN0YXJ0c1dpdGgoXCJbW1wiKSAmJlxuICAgICAgICAgIHZhbHVlLmVuZHNXaXRoKFwiXV1cIilcbiAgICAgICAgKTtcbiAgICAgIGNhc2UgXCJhcnJheVwiOlxuICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheSh2YWx1ZSkgfHwgdHlwZW9mIHZhbHVlID09PSBcInN0cmluZ1wiO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogQ29udGV4dCBmb3IgY29tbWFuZCBleGVjdXRpb25cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDb21tYW5kRXhlY3V0aW9uQ29udGV4dCB7XG4gIGNvbW1hbmRJZDogc3RyaW5nO1xuICBjb21tYW5kVHlwZTogQ29tbWFuZFR5cGU7XG4gIHBhcmFtZXRlcnM6IFJlY29yZDxzdHJpbmcsIGFueT47XG4gIHRpbWVzdGFtcDogRGF0ZTtcbiAgdGVtcGxhdGU/OiBzdHJpbmc7XG4gIHNjcmlwdD86IHN0cmluZztcbiAgdGFyZ2V0Q2xhc3M/OiBzdHJpbmc7XG59XG4iXSwidmVyc2lvbiI6M30=