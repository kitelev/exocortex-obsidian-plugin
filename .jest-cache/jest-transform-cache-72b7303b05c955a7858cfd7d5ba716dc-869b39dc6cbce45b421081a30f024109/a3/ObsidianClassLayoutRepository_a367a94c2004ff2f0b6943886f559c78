e46d6f04d0b3b90ec70a5335f1438ac5
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ObsidianClassLayoutRepository = void 0;
const ClassLayout_1 = require("../../domain/entities/ClassLayout");
const ClassName_1 = require("../../domain/value-objects/ClassName");
const AssetId_1 = require("../../domain/value-objects/AssetId");
class ObsidianClassLayoutRepository {
    constructor(app, layoutsFolderPath = "layouts") {
        this.app = app;
        this.layoutsFolderPath = layoutsFolderPath;
        this.cache = new Map();
        this.lastCacheUpdate = 0;
        this.CACHE_TTL = 30000; // 30 seconds
        this.hasManuallyAddedLayouts = false;
        // Initialize cache to ensure it's never undefined
        this.cache = new Map();
    }
    async findByClass(className) {
        await this.refreshCacheIfNeeded();
        const allLayouts = Array.from(this.cache.values()).flat();
        const matchingLayouts = allLayouts.filter((layout) => layout.targetClass.equals(className) && layout.isEnabled);
        // Sort by priority (higher first)
        return matchingLayouts.sort((a, b) => b.priority - a.priority);
    }
    async findById(id) {
        await this.refreshCacheIfNeeded();
        const allLayouts = Array.from(this.cache.values()).flat();
        return allLayouts.find((layout) => layout.id.equals(id)) || null;
    }
    async findAll() {
        await this.refreshCacheIfNeeded();
        return Array.from(this.cache.values()).flat();
    }
    async findEnabledByClass(className) {
        const layouts = await this.findByClass(className);
        return layouts.filter((l) => l.isEnabled);
    }
    async save(layout) {
        // In Obsidian, we would save this as a file
        // For now, just update cache
        const className = layout.targetClass.value;
        const existing = this.cache.get(className) || [];
        const index = existing.findIndex((l) => l.id.equals(layout.id));
        if (index >= 0) {
            existing[index] = layout;
        }
        else {
            existing.push(layout);
        }
        this.cache.set(className, existing);
        this.hasManuallyAddedLayouts = true; // Mark that we have manually added layouts
    }
    async delete(id) {
        // Remove from cache
        for (const [className, layouts] of this.cache.entries()) {
            const filtered = layouts.filter((l) => !l.id.equals(id));
            if (filtered.length !== layouts.length) {
                this.cache.set(className, filtered);
            }
        }
    }
    async refreshCacheIfNeeded() {
        const now = Date.now();
        if (now - this.lastCacheUpdate < this.CACHE_TTL) {
            return;
        }
        // Only load from files if no layouts were manually added
        // This allows tests to work properly with in-memory layouts
        if (!this.hasManuallyAddedLayouts) {
            await this.loadLayoutsFromFiles();
        }
        this.lastCacheUpdate = now;
    }
    async loadLayoutsFromFiles() {
        // Only clear cache if we're actually loading from files
        // This prevents clearing manually added test layouts
        if (!this.hasManuallyAddedLayouts) {
            this.cache.clear();
        }
        // Handle case where app or vault might be null/undefined
        if (!this.app || !this.app.vault) {
            return;
        }
        const files = this.app.vault.getFiles();
        // Ensure files is an array before filtering
        if (!Array.isArray(files)) {
            return;
        }
        const layoutFiles = files.filter((file) => file.path.startsWith(this.layoutsFolderPath + "/") ||
            this.isLayoutFile(file));
        for (const file of layoutFiles) {
            const layout = await this.parseLayoutFile(file);
            if (layout) {
                const className = layout.targetClass.value;
                const existing = this.cache.get(className) || [];
                existing.push(layout);
                this.cache.set(className, existing);
            }
        }
    }
    isLayoutFile(file) {
        // Handle case where app or metadataCache might be null/undefined
        if (!this.app || !this.app.metadataCache || !file) {
            return false;
        }
        const metadata = this.app.metadataCache.getFileCache(file);
        if (!metadata?.frontmatter)
            return false;
        const instanceClass = metadata.frontmatter["exo__Instance_class"];
        const cleanClass = this.cleanClassName(instanceClass);
        return cleanClass === "ui__ClassLayout";
    }
    async parseLayoutFile(file) {
        // Handle case where app or metadataCache might be null/undefined
        if (!this.app || !this.app.metadataCache || !file) {
            return null;
        }
        const metadata = this.app.metadataCache.getFileCache(file);
        if (!metadata?.frontmatter)
            return null;
        const frontmatter = metadata.frontmatter;
        const instanceClass = frontmatter["exo__Instance_class"];
        if (this.cleanClassName(instanceClass) !== "ui__ClassLayout") {
            return null;
        }
        const targetClass = frontmatter["ui__ClassLayout_targetClass"];
        if (!targetClass)
            return null;
        const cleanTargetClass = this.cleanClassName(targetClass);
        const targetClassName = ClassName_1.ClassName.create(cleanTargetClass);
        if (targetClassName.isFailure)
            return null;
        const blocks = this.parseBlocks(frontmatter["ui__ClassLayout_blocks"] || []);
        const priority = frontmatter["ui__ClassLayout_priority"] || 0;
        const isEnabled = frontmatter["ui__ClassLayout_enabled"] !== false;
        const assetId = AssetId_1.AssetId.create(frontmatter["exo__Asset_uid"] || file.path);
        if (assetId.isFailure)
            return null;
        const layoutResult = ClassLayout_1.ClassLayout.create({
            id: assetId.getValue(),
            targetClass: targetClassName.getValue(),
            blocks,
            isEnabled,
            priority,
        });
        return layoutResult?.isSuccess ? layoutResult.getValue() : null;
    }
    parseBlocks(blocksData) {
        if (!Array.isArray(blocksData))
            return [];
        return blocksData
            .map((blockData, index) => {
            // Handle null/undefined blockData
            if (!blockData) {
                return null;
            }
            const block = {
                id: blockData.id || `block-${index}`,
                type: blockData.type || "properties",
                title: blockData.title || "Untitled Block",
                order: blockData.order ?? index,
                config: this.parseBlockConfig(blockData.type || "properties", blockData.config || {}),
                isVisible: blockData.isVisible !== false,
            };
            return block;
        })
            .filter((b) => b !== null);
    }
    parseBlockConfig(type, config) {
        const baseConfig = { type, ...config };
        switch (type) {
            case "query":
                return {
                    type: "query",
                    query: config.query || "",
                    className: config.className,
                    propertyFilters: this.parsePropertyFilters(config.propertyFilters),
                    relationProperty: config.relationProperty,
                    maxResults: config.maxResults || 50,
                    sortBy: config.sortBy,
                    sortOrder: config.sortOrder || "asc",
                    displayAs: config.displayAs || "list",
                };
            case "properties":
                return {
                    type: "properties",
                    includedProperties: config.includedProperties || [],
                    excludedProperties: config.excludedProperties || [],
                    editableProperties: config.editableProperties || [],
                    groupBy: config.groupBy,
                };
            case "relations":
                return {
                    type: "relations",
                    relationProperty: config.relationProperty || "",
                    showBacklinks: config.showBacklinks !== false,
                    showForwardLinks: config.showForwardLinks !== false,
                    maxDepth: config.maxDepth || 1,
                };
            case "backlinks":
                return {
                    type: "backlinks",
                    filterByClass: config.filterByClass,
                    groupByClass: config.groupByClass || false,
                    maxResults: config.maxResults || 50,
                };
            case "buttons":
                return {
                    type: "buttons",
                    buttons: Array.isArray(config.buttons)
                        ? config.buttons.map((btn) => ({
                            id: btn.id || "",
                            label: btn.label || "",
                            commandType: btn.commandType || "",
                            tooltip: btn.tooltip,
                            style: btn.style || "default",
                            parameters: btn.parameters || {},
                        }))
                        : [],
                    position: config.position || "top",
                    style: config.style || "default",
                };
            case "narrower":
                return {
                    type: "narrower",
                    broaderProperty: config.broaderProperty || "ims__Concept_broader",
                    filterByClass: config.filterByClass,
                    displayAs: config.displayAs || "list",
                    maxResults: config.maxResults || 50,
                };
            case "custom":
                return {
                    type: "custom",
                    templatePath: config.templatePath,
                    dataviewQuery: config.dataviewQuery,
                    queryEngineQuery: config.queryEngineQuery,
                    customScript: config.customScript,
                };
            default:
                return baseConfig;
        }
    }
    parsePropertyFilters(filters) {
        if (!Array.isArray(filters))
            return [];
        return filters.map((filter) => ({
            property: filter.property || "",
            operator: filter.operator || "equals",
            value: filter.value || "",
        }));
    }
    cleanClassName(className) {
        if (!className)
            return "";
        const str = Array.isArray(className) ? className[0] : className;
        return str?.toString().replace(/\[\[|\]\]/g, "") || "";
    }
}
exports.ObsidianClassLayoutRepository = ObsidianClassLayoutRepository;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2luZnJhc3RydWN0dXJlL3JlcG9zaXRvcmllcy9PYnNpZGlhbkNsYXNzTGF5b3V0UmVwb3NpdG9yeS50cyIsIm1hcHBpbmdzIjoiOzs7QUFFQSxtRUFHMkM7QUFDM0Msb0VBQWlFO0FBQ2pFLGdFQUE2RDtBQUc3RCxNQUFhLDZCQUE2QjtJQU14QyxZQUNVLEdBQVEsRUFDUixvQkFBNEIsU0FBUztRQURyQyxRQUFHLEdBQUgsR0FBRyxDQUFLO1FBQ1Isc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFvQjtRQVB2QyxVQUFLLEdBQStCLElBQUksR0FBRyxFQUFFLENBQUM7UUFDOUMsb0JBQWUsR0FBVyxDQUFDLENBQUM7UUFDbkIsY0FBUyxHQUFHLEtBQUssQ0FBQyxDQUFDLGFBQWE7UUFDekMsNEJBQXVCLEdBQVksS0FBSyxDQUFDO1FBTS9DLGtEQUFrRDtRQUNsRCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7SUFDekIsQ0FBQztJQUVELEtBQUssQ0FBQyxXQUFXLENBQUMsU0FBb0I7UUFDcEMsTUFBTSxJQUFJLENBQUMsb0JBQW9CLEVBQUUsQ0FBQztRQUVsQyxNQUFNLFVBQVUsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUMxRCxNQUFNLGVBQWUsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUN2QyxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FDckUsQ0FBQztRQUVGLGtDQUFrQztRQUNsQyxPQUFPLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxRQUFR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LFlBQVk7b0JBQ2pDLGFBQWEsRUFBRSxNQUFNLENBQUMsYUFBYTtvQkFDbkMsZ0JBQWdCLEVBQUUsTUFBTSxDQUFDLGdCQUFnQjtvQkFDekMsWUFBWSxFQUFFLE1BQU0sQ0FBQyxZQUFZO2lCQUNsQyxDQUFDO1lBRUo7Z0JBQ0UsT0FBTyxVQUFVLENBQUM7U0FDckI7SUFDSCxDQUFDO0lBRU8sb0JBQW9CLENBQUMsT0FBWTtRQUN2QyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUM7WUFBRSxPQUFPLEVBQUUsQ0FBQztRQUV2QyxPQUFPLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDOUIsUUFBUSxFQUFFLE1BQU0sQ0FBQyxRQUFRLElBQUksRUFBRTtZQUMvQixRQUFRLEVBQUUsTUFBTSxDQUFDLFFBQVEsSUFBSSxRQUFRO1lBQ3JDLEtBQUssRUFBRSxNQUFNLENBQUMsS0FBSyxJQUFJLEVBQUU7U0FDMUIsQ0FBQyxDQUFDLENBQUM7SUFDTixDQUFDO0lBRU8sY0FBYyxDQUFDLFNBQWM7UUFDbkMsSUFBSSxDQUFDLFNBQVM7WUFBRSxPQUFPLEVBQUUsQ0FBQztRQUMxQixNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQztRQUNoRSxPQUFPLEdBQUcsRUFBRSxRQUFRLEVBQUUsQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUN6RCxDQUFDO0NBQ0Y7QUE3U0Qsc0VBNlNDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9raXRlbGV2L0RvY3VtZW50cy9leG9jb3J0ZXgtb2JzaWRpYW4tcGx1Z2luL3NyYy9pbmZyYXN0cnVjdHVyZS9yZXBvc2l0b3JpZXMvT2JzaWRpYW5DbGFzc0xheW91dFJlcG9zaXRvcnkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwLCBURmlsZSB9IGZyb20gXCJvYnNpZGlhblwiO1xuaW1wb3J0IHsgSUNsYXNzTGF5b3V0UmVwb3NpdG9yeSB9IGZyb20gXCIuLi8uLi9kb21haW4vcmVwb3NpdG9yaWVzL0lDbGFzc0xheW91dFJlcG9zaXRvcnlcIjtcbmltcG9ydCB7XG4gIENsYXNzTGF5b3V0LFxuICBMYXlvdXRCbG9ja0NvbmZpZyxcbn0gZnJvbSBcIi4uLy4uL2RvbWFpbi9lbnRpdGllcy9DbGFzc0xheW91dFwiO1xuaW1wb3J0IHsgQ2xhc3NOYW1lIH0gZnJvbSBcIi4uLy4uL2RvbWFpbi92YWx1ZS1vYmplY3RzL0NsYXNzTmFtZVwiO1xuaW1wb3J0IHsgQXNzZXRJZCB9IGZyb20gXCIuLi8uLi9kb21haW4vdmFsdWUtb2JqZWN0cy9Bc3NldElkXCI7XG5pbXBvcnQgeyBSZXN1bHQgfSBmcm9tIFwiLi4vLi4vZG9tYWluL2NvcmUvUmVzdWx0XCI7XG5cbmV4cG9ydCBjbGFzcyBPYnNpZGlhbkNsYXNzTGF5b3V0UmVwb3NpdG9yeSBpbXBsZW1lbnRzIElDbGFzc0xheW91dFJlcG9zaXRvcnkge1xuICBwcml2YXRlIGNhY2hlOiBNYXA8c3RyaW5nLCBDbGFzc0xheW91dFtdPiA9IG5ldyBNYXAoKTtcbiAgcHJpdmF0ZSBsYXN0Q2FjaGVVcGRhdGU6IG51bWJlciA9IDA7XG4gIHByaXZhdGUgcmVhZG9ubHkgQ0FDSEVfVFRMID0gMzAwMDA7IC8vIDMwIHNlY29uZHNcbiAgcHJpdmF0ZSBoYXNNYW51YWxseUFkZGVkTGF5b3V0czogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYXBwOiBBcHAsXG4gICAgcHJpdmF0ZSBsYXlvdXRzRm9sZGVyUGF0aDogc3RyaW5nID0gXCJsYXlvdXRzXCIsXG4gICkge1xuICAgIC8vIEluaXRpYWxpemUgY2FjaGUgdG8gZW5zdXJlIGl0J3MgbmV2ZXIgdW5kZWZpbmVkXG4gICAgdGhpcy5jYWNoZSA9IG5ldyBNYXAoKTtcbiAgfVxuXG4gIGFzeW5jIGZpbmRCeUNsYXNzKGNsYXNzTmFtZTogQ2xhc3NOYW1lKTogUHJvbWlzZTxDbGFzc0xheW91dFtdPiB7XG4gICAgYXdhaXQgdGhpcy5yZWZyZXNoQ2FjaGVJZk5lZWRlZCgpO1xuXG4gICAgY29uc3QgYWxsTGF5b3V0cyA9IEFycmF5LmZyb20odGhpcy5jYWNoZS52YWx1ZXMoKSkuZmxhdCgpO1xuICAgIGNvbnN0IG1hdGNoaW5nTGF5b3V0cyA9IGFsbExheW91dHMuZmlsdGVyKFxuICAgICAgKGxheW91dCkgPT4gbGF5b3V0LnRhcmdldENsYXNzLmVxdWFscyhjbGFzc05hbWUpICYmIGxheW91dC5pc0VuYWJsZWQsXG4gICAgKTtcblxuICAgIC8vIFNvcnQgYnkgcHJpb3JpdHkgKGhpZ2hlciBmaXJzdClcbiAgICByZXR1cm4gbWF0Y2hpbmdMYXlvdXRzLnNvcnQoKGEsIGIpID0+IGIucHJpb3JpdHkgLSBhLnByaW9yaXR5KTtcbiAgfVxuXG4gIGFzeW5jIGZpbmRCeUlkKGlkOiBBc3NldElkKTogUHJvbWlzZTxDbGFzc0xheW91dCB8IG51bGw+IHtcbiAgICBhd2FpdCB0aGlzLnJlZnJlc2hDYWNoZUlmTmVlZGVkKCk7XG5cbiAgICBjb25zdCBhbGxMYXlvdXRzID0gQXJyYXkuZnJvbSh0aGlzLmNhY2hlLnZhbHVlcygpKS5mbGF0KCk7XG4gICAgcmV0dXJuIGFsbExheW91dHMuZmluZCgobGF5b3V0KSA9PiBsYXlvdXQuaWQuZXF1YWxzKGlkKSkgfHwgbnVsbDtcbiAgfVxuXG4gIGFzeW5jIGZpbmRBbGwoKTogUHJvbWlzZTxDbGFzc0xheW91dFtdPiB7XG4gICAgYXdhaXQgdGhpcy5yZWZyZXNoQ2FjaGVJZk5lZWRlZCgpO1xuICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMuY2FjaGUudmFsdWVzKCkpLmZsYXQoKTtcbiAgfVxuXG4gIGFzeW5jIGZpbmRFbmFibGVkQnlDbGFzcyhjbGFzc05hbWU6IENsYXNzTmFtZSk6IFByb21pc2U8Q2xhc3NMYXlvdXRbXT4ge1xuICAgIGNvbnN0IGxheW91dHMgPSBhd2FpdCB0aGlzLmZpbmRCeUNsYXNzKGNsYXNzTmFtZSk7XG4gICAgcmV0dXJuIGxheW91dHMuZmlsdGVyKChsKSA9PiBsLmlzRW5hYmxlZCk7XG4gIH1cblxuICBhc3luYyBzYXZlKGxheW91dDogQ2xhc3NMYXlvdXQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBJbiBPYnNpZGlhbiwgd2Ugd291bGQgc2F2ZSB0aGlzIGFzIGEgZmlsZVxuICAgIC8vIEZvciBub3csIGp1c3QgdXBkYXRlIGNhY2hlXG4gICAgY29uc3QgY2xhc3NOYW1lID0gbGF5b3V0LnRhcmdldENsYXNzLnZhbHVlO1xuICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5jYWNoZS5nZXQoY2xhc3NOYW1lKSB8fCBbXTtcbiAgICBjb25zdCBpbmRleCA9IGV4aXN0aW5nLmZpbmRJbmRleCgobCkgPT4gbC5pZC5lcXVhbHMobGF5b3V0LmlkKSk7XG5cbiAgICBpZiAoaW5kZXggPj0gMCkge1xuICAgICAgZXhpc3RpbmdbaW5kZXhdID0gbGF5b3V0O1xuICAgIH0gZWxzZSB7XG4gICAgICBleGlzdGluZy5wdXNoKGxheW91dCk7XG4gICAgfVxuXG4gICAgdGhpcy5jYWNoZS5zZXQoY2xhc3NOYW1lLCBleGlzdGluZyk7XG4gICAgdGhpcy5oYXNNYW51YWxseUFkZGVkTGF5b3V0cyA9IHRydWU7IC8vIE1hcmsgdGhhdCB3ZSBoYXZlIG1hbnVhbGx5IGFkZGVkIGxheW91dHNcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZShpZDogQXNzZXRJZCk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIFJlbW92ZSBmcm9tIGNhY2hlXG4gICAgZm9yIChjb25zdCBbY2xhc3NOYW1lLCBsYXlvdXRzXSBvZiB0aGlzLmNhY2hlLmVudHJpZXMoKSkge1xuICAgICAgY29uc3QgZmlsdGVyZWQgPSBsYXlvdXRzLmZpbHRlcigobCkgPT4gIWwuaWQuZXF1YWxzKGlkKSk7XG4gICAgICBpZiAoZmlsdGVyZWQubGVuZ3RoICE9PSBsYXlvdXRzLmxlbmd0aCkge1xuICAgICAgICB0aGlzLmNhY2hlLnNldChjbGFzc05hbWUsIGZpbHRlcmVkKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHJlZnJlc2hDYWNoZUlmTmVlZGVkKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgaWYgKG5vdyAtIHRoaXMubGFzdENhY2hlVXBkYXRlIDwgdGhpcy5DQUNIRV9UVEwpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBPbmx5IGxvYWQgZnJvbSBmaWxlcyBpZiBubyBsYXlvdXRzIHdlcmUgbWFudWFsbHkgYWRkZWRcbiAgICAvLyBUaGlzIGFsbG93cyB0ZXN0cyB0byB3b3JrIHByb3Blcmx5IHdpdGggaW4tbWVtb3J5IGxheW91dHNcbiAgICBpZiAoIXRoaXMuaGFzTWFudWFsbHlBZGRlZExheW91dHMpIHtcbiAgICAgIGF3YWl0IHRoaXMubG9hZExheW91dHNGcm9tRmlsZXMoKTtcbiAgICB9XG4gICAgdGhpcy5sYXN0Q2FjaGVVcGRhdGUgPSBub3c7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGxvYWRMYXlvdXRzRnJvbUZpbGVzKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIE9ubHkgY2xlYXIgY2FjaGUgaWYgd2UncmUgYWN0dWFsbHkgbG9hZGluZyBmcm9tIGZpbGVzXG4gICAgLy8gVGhpcyBwcmV2ZW50cyBjbGVhcmluZyBtYW51YWxseSBhZGRlZCB0ZXN0IGxheW91dHNcbiAgICBpZiAoIXRoaXMuaGFzTWFudWFsbHlBZGRlZExheW91dHMpIHtcbiAgICAgIHRoaXMuY2FjaGUuY2xlYXIoKTtcbiAgICB9XG5cbiAgICAvLyBIYW5kbGUgY2FzZSB3aGVyZSBhcHAgb3IgdmF1bHQgbWlnaHQgYmUgbnVsbC91bmRlZmluZWRcbiAgICBpZiAoIXRoaXMuYXBwIHx8ICF0aGlzLmFwcC52YXVsdCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGZpbGVzID0gdGhpcy5hcHAudmF1bHQuZ2V0RmlsZXMoKTtcbiAgICAvLyBFbnN1cmUgZmlsZXMgaXMgYW4gYXJyYXkgYmVmb3JlIGZpbHRlcmluZ1xuICAgIGlmICghQXJyYXkuaXNBcnJheShmaWxlcykpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBsYXlvdXRGaWxlcyA9IGZpbGVzLmZpbHRlcihcbiAgICAgIChmaWxlKSA9PlxuICAgICAgICBmaWxlLnBhdGguc3RhcnRzV2l0aCh0aGlzLmxheW91dHNGb2xkZXJQYXRoICsgXCIvXCIpIHx8XG4gICAgICAgIHRoaXMuaXNMYXlvdXRGaWxlKGZpbGUpLFxuICAgICk7XG5cbiAgICBmb3IgKGNvbnN0IGZpbGUgb2YgbGF5b3V0RmlsZXMpIHtcbiAgICAgIGNvbnN0IGxheW91dCA9IGF3YWl0IHRoaXMucGFyc2VMYXlvdXRGaWxlKGZpbGUpO1xuICAgICAgaWYgKGxheW91dCkge1xuICAgICAgICBjb25zdCBjbGFzc05hbWUgPSBsYXlvdXQudGFyZ2V0Q2xhc3MudmFsdWU7XG4gICAgICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy5jYWNoZS5nZXQoY2xhc3NOYW1lKSB8fCBbXTtcbiAgICAgICAgZXhpc3RpbmcucHVzaChsYXlvdXQpO1xuICAgICAgICB0aGlzLmNhY2hlLnNldChjbGFzc05hbWUsIGV4aXN0aW5nKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGlzTGF5b3V0RmlsZShmaWxlOiBURmlsZSk6IGJvb2xlYW4ge1xuICAgIC8vIEhhbmRsZSBjYXNlIHdoZXJlIGFwcCBvciBtZXRhZGF0YUNhY2hlIG1pZ2h0IGJlIG51bGwvdW5kZWZpbmVkXG4gICAgaWYgKCF0aGlzLmFwcCB8fCAhdGhpcy5hcHAubWV0YWRhdGFDYWNoZSB8fCAhZmlsZSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGNvbnN0IG1ldGFkYXRhID0gdGhpcy5hcHAubWV0YWRhdGFDYWNoZS5nZXRGaWxlQ2FjaGUoZmlsZSk7XG4gICAgaWYgKCFtZXRhZGF0YT8uZnJvbnRtYXR0ZXIpIHJldHVybiBmYWxzZTtcblxuICAgIGNvbnN0IGluc3RhbmNlQ2xhc3MgPSBtZXRhZGF0YS5mcm9udG1hdHRlcltcImV4b19fSW5zdGFuY2VfY2xhc3NcIl07XG4gICAgY29uc3QgY2xlYW5DbGFzcyA9IHRoaXMuY2xlYW5DbGFzc05hbWUoaW5zdGFuY2VDbGFzcyk7XG5cbiAgICByZXR1cm4gY2xlYW5DbGFzcyA9PT0gXCJ1aV9fQ2xhc3NMYXlvdXRcIjtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcGFyc2VMYXlvdXRGaWxlKGZpbGU6IFRGaWxlKTogUHJvbWlzZTxDbGFzc0xheW91dCB8IG51bGw+IHtcbiAgICAvLyBIYW5kbGUgY2FzZSB3aGVyZSBhcHAgb3IgbWV0YWRhdGFDYWNoZSBtaWdodCBiZSBudWxsL3VuZGVmaW5lZFxuICAgIGlmICghdGhpcy5hcHAgfHwgIXRoaXMuYXBwLm1ldGFkYXRhQ2FjaGUgfHwgIWZpbGUpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IG1ldGFkYXRhID0gdGhpcy5hcHAubWV0YWRhdGFDYWNoZS5nZXRGaWxlQ2FjaGUoZmlsZSk7XG4gICAgaWYgKCFtZXRhZGF0YT8uZnJvbnRtYXR0ZXIpIHJldHVybiBudWxsO1xuXG4gICAgY29uc3QgZnJvbnRtYXR0ZXIgPSBtZXRhZGF0YS5mcm9udG1hdHRlcjtcbiAgICBjb25zdCBpbnN0YW5jZUNsYXNzID0gZnJvbnRtYXR0ZXJbXCJleG9fX0luc3RhbmNlX2NsYXNzXCJdO1xuXG4gICAgaWYgKHRoaXMuY2xlYW5DbGFzc05hbWUoaW5zdGFuY2VDbGFzcykgIT09IFwidWlfX0NsYXNzTGF5b3V0XCIpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGNvbnN0IHRhcmdldENsYXNzID0gZnJvbnRtYXR0ZXJbXCJ1aV9fQ2xhc3NMYXlvdXRfdGFyZ2V0Q2xhc3NcIl07XG4gICAgaWYgKCF0YXJnZXRDbGFzcykgcmV0dXJuIG51bGw7XG5cbiAgICBjb25zdCBjbGVhblRhcmdldENsYXNzID0gdGhpcy5jbGVhbkNsYXNzTmFtZSh0YXJnZXRDbGFzcyk7XG4gICAgY29uc3QgdGFyZ2V0Q2xhc3NOYW1lID0gQ2xhc3NOYW1lLmNyZWF0ZShjbGVhblRhcmdldENsYXNzKTtcbiAgICBpZiAodGFyZ2V0Q2xhc3NOYW1lLmlzRmFpbHVyZSkgcmV0dXJuIG51bGw7XG5cbiAgICBjb25zdCBibG9ja3MgPSB0aGlzLnBhcnNlQmxvY2tzKFxuICAgICAgZnJvbnRtYXR0ZXJbXCJ1aV9fQ2xhc3NMYXlvdXRfYmxvY2tzXCJdIHx8IFtdLFxuICAgICk7XG4gICAgY29uc3QgcHJpb3JpdHkgPSBmcm9udG1hdHRlcltcInVpX19DbGFzc0xheW91dF9wcmlvcml0eVwiXSB8fCAwO1xuICAgIGNvbnN0IGlzRW5hYmxlZCA9IGZyb250bWF0dGVyW1widWlfX0NsYXNzTGF5b3V0X2VuYWJsZWRcIl0gIT09IGZhbHNlO1xuXG4gICAgY29uc3QgYXNzZXRJZCA9IEFzc2V0SWQuY3JlYXRlKGZyb250bWF0dGVyW1wiZXhvX19Bc3NldF91aWRcIl0gfHwgZmlsZS5wYXRoKTtcbiAgICBpZiAoYXNzZXRJZC5pc0ZhaWx1cmUpIHJldHVybiBudWxsO1xuXG4gICAgY29uc3QgbGF5b3V0UmVzdWx0ID0gQ2xhc3NMYXlvdXQuY3JlYXRlKHtcbiAgICAgIGlkOiBhc3NldElkLmdldFZhbHVlKCksXG4gICAgICB0YXJnZXRDbGFzczogdGFyZ2V0Q2xhc3NOYW1lLmdldFZhbHVlKCksXG4gICAgICBibG9ja3MsXG4gICAgICBpc0VuYWJsZWQsXG4gICAgICBwcmlvcml0eSxcbiAgICB9KTtcblxuICAgIHJldHVybiBsYXlvdXRSZXN1bHQ/LmlzU3VjY2VzcyA/IGxheW91dFJlc3VsdC5nZXRWYWx1ZSgpIDogbnVsbDtcbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VCbG9ja3MoYmxvY2tzRGF0YTogYW55W10pOiBMYXlvdXRCbG9ja0NvbmZpZ1tdIHtcbiAgICBpZiAoIUFycmF5LmlzQXJyYXkoYmxvY2tzRGF0YSkpIHJldHVybiBbXTtcblxuICAgIHJldHVybiBibG9ja3NEYXRhXG4gICAgICAubWFwKChibG9ja0RhdGEsIGluZGV4KSA9PiB7XG4gICAgICAgIC8vIEhhbmRsZSBudWxsL3VuZGVmaW5lZCBibG9ja0RhdGFcbiAgICAgICAgaWYgKCFibG9ja0RhdGEpIHtcbiAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGJsb2NrOiBMYXlvdXRCbG9ja0NvbmZpZyA9IHtcbiAgICAgICAgICBpZDogYmxvY2tEYXRhLmlkIHx8IGBibG9jay0ke2luZGV4fWAsXG4gICAgICAgICAgdHlwZTogYmxvY2tEYXRhLnR5cGUgfHwgXCJwcm9wZXJ0aWVzXCIsXG4gICAgICAgICAgdGl0bGU6IGJsb2NrRGF0YS50aXRsZSB8fCBcIlVudGl0bGVkIEJsb2NrXCIsXG4gICAgICAgICAgb3JkZXI6IGJsb2NrRGF0YS5vcmRlciA/PyBpbmRleCxcbiAgICAgICAgICBjb25maWc6IHRoaXMucGFyc2VCbG9ja0NvbmZpZyhcbiAgICAgICAgICAgIGJsb2NrRGF0YS50eXBlIHx8IFwicHJvcGVydGllc1wiLFxuICAgICAgICAgICAgYmxvY2tEYXRhLmNvbmZpZyB8fCB7fSxcbiAgICAgICAgICApLFxuICAgICAgICAgIGlzVmlzaWJsZTogYmxvY2tEYXRhLmlzVmlzaWJsZSAhPT0gZmFsc2UsXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiBibG9jaztcbiAgICAgIH0pXG4gICAgICAuZmlsdGVyKChiKSA9PiBiICE9PSBudWxsKSBhcyBMYXlvdXRCbG9ja0NvbmZpZ1tdO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZUJsb2NrQ29uZmlnKHR5cGU6IHN0cmluZywgY29uZmlnOiBhbnkpOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHtcbiAgICBjb25zdCBiYXNlQ29uZmlnID0geyB0eXBlLCAuLi5jb25maWcgfTtcblxuICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgY2FzZSBcInF1ZXJ5XCI6XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgdHlwZTogXCJxdWVyeVwiLFxuICAgICAgICAgIHF1ZXJ5OiBjb25maWcucXVlcnkgfHwgXCJcIixcbiAgICAgICAgICBjbGFzc05hbWU6IGNvbmZpZy5jbGFzc05hbWUsXG4gICAgICAgICAgcHJvcGVydHlGaWx0ZXJzOiB0aGlzLnBhcnNlUHJvcGVydHlGaWx0ZXJzKGNvbmZpZy5wcm9wZXJ0eUZpbHRlcnMpLFxuICAgICAgICAgIHJlbGF0aW9uUHJvcGVydHk6IGNvbmZpZy5yZWxhdGlvblByb3BlcnR5LFxuICAgICAgICAgIG1heFJlc3VsdHM6IGNvbmZpZy5tYXhSZXN1bHRzIHx8IDUwLFxuICAgICAgICAgIHNvcnRCeTogY29uZmlnLnNvcnRCeSxcbiAgICAgICAgICBzb3J0T3JkZXI6IGNvbmZpZy5zb3J0T3JkZXIgfHwgXCJhc2NcIixcbiAgICAgICAgICBkaXNwbGF5QXM6IGNvbmZpZy5kaXNwbGF5QXMgfHwgXCJsaXN0XCIsXG4gICAgICAgIH07XG5cbiAgICAgIGNhc2UgXCJwcm9wZXJ0aWVzXCI6XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgdHlwZTogXCJwcm9wZXJ0aWVzXCIsXG4gICAgICAgICAgaW5jbHVkZWRQcm9wZXJ0aWVzOiBjb25maWcuaW5jbHVkZWRQcm9wZXJ0aWVzIHx8IFtdLFxuICAgICAgICAgIGV4Y2x1ZGVkUHJvcGVydGllczogY29uZmlnLmV4Y2x1ZGVkUHJvcGVydGllcyB8fCBbXSxcbiAgICAgICAgICBlZGl0YWJsZVByb3BlcnRpZXM6IGNvbmZpZy5lZGl0YWJsZVByb3BlcnRpZXMgfHwgW10sXG4gICAgICAgICAgZ3JvdXBCeTogY29uZmlnLmdyb3VwQnksXG4gICAgICAgIH07XG5cbiAgICAgIGNhc2UgXCJyZWxhdGlvbnNcIjpcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB0eXBlOiBcInJlbGF0aW9uc1wiLFxuICAgICAgICAgIHJlbGF0aW9uUHJvcGVydHk6IGNvbmZpZy5yZWxhdGlvblByb3BlcnR5IHx8IFwiXCIsXG4gICAgICAgICAgc2hvd0JhY2tsaW5rczogY29uZmlnLnNob3dCYWNrbGlua3MgIT09IGZhbHNlLFxuICAgICAgICAgIHNob3dGb3J3YXJkTGlua3M6IGNvbmZpZy5zaG93Rm9yd2FyZExpbmtzICE9PSBmYWxzZSxcbiAgICAgICAgICBtYXhEZXB0aDogY29uZmlnLm1heERlcHRoIHx8IDEsXG4gICAgICAgIH07XG5cbiAgICAgIGNhc2UgXCJiYWNrbGlua3NcIjpcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB0eXBlOiBcImJhY2tsaW5rc1wiLFxuICAgICAgICAgIGZpbHRlckJ5Q2xhc3M6IGNvbmZpZy5maWx0ZXJCeUNsYXNzLFxuICAgICAgICAgIGdyb3VwQnlDbGFzczogY29uZmlnLmdyb3VwQnlDbGFzcyB8fCBmYWxzZSxcbiAgICAgICAgICBtYXhSZXN1bHRzOiBjb25maWcubWF4UmVzdWx0cyB8fCA1MCxcbiAgICAgICAgfTtcblxuICAgICAgY2FzZSBcImJ1dHRvbnNcIjpcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB0eXBlOiBcImJ1dHRvbnNcIixcbiAgICAgICAgICBidXR0b25zOiBBcnJheS5pc0FycmF5KGNvbmZpZy5idXR0b25zKVxuICAgICAgICAgICAgPyBjb25maWcuYnV0dG9ucy5tYXAoKGJ0bjogYW55KSA9PiAoe1xuICAgICAgICAgICAgICAgIGlkOiBidG4uaWQgfHwgXCJcIixcbiAgICAgICAgICAgICAgICBsYWJlbDogYnRuLmxhYmVsIHx8IFwiXCIsXG4gICAgICAgICAgICAgICAgY29tbWFuZFR5cGU6IGJ0bi5jb21tYW5kVHlwZSB8fCBcIlwiLFxuICAgICAgICAgICAgICAgIHRvb2x0aXA6IGJ0bi50b29sdGlwLFxuICAgICAgICAgICAgICAgIHN0eWxlOiBidG4uc3R5bGUgfHwgXCJkZWZhdWx0XCIsXG4gICAgICAgICAgICAgICAgcGFyYW1ldGVyczogYnRuLnBhcmFtZXRlcnMgfHwge30sXG4gICAgICAgICAgICAgIH0pKVxuICAgICAgICAgICAgOiBbXSxcbiAgICAgICAgICBwb3NpdGlvbjogY29uZmlnLnBvc2l0aW9uIHx8IFwidG9wXCIsXG4gICAgICAgICAgc3R5bGU6IGNvbmZpZy5zdHlsZSB8fCBcImRlZmF1bHRcIixcbiAgICAgICAgfTtcblxuICAgICAgY2FzZSBcIm5hcnJvd2VyXCI6XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgdHlwZTogXCJuYXJyb3dlclwiLFxuICAgICAgICAgIGJyb2FkZXJQcm9wZXJ0eTogY29uZmlnLmJyb2FkZXJQcm9wZXJ0eSB8fCBcImltc19fQ29uY2VwdF9icm9hZGVyXCIsXG4gICAgICAgICAgZmlsdGVyQnlDbGFzczogY29uZmlnLmZpbHRlckJ5Q2xhc3MsXG4gICAgICAgICAgZGlzcGxheUFzOiBjb25maWcuZGlzcGxheUFzIHx8IFwibGlzdFwiLFxuICAgICAgICAgIG1heFJlc3VsdHM6IGNvbmZpZy5tYXhSZXN1bHRzIHx8IDUwLFxuICAgICAgICB9O1xuXG4gICAgICBjYXNlIFwiY3VzdG9tXCI6XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgdHlwZTogXCJjdXN0b21cIixcbiAgICAgICAgICB0ZW1wbGF0ZVBhdGg6IGNvbmZpZy50ZW1wbGF0ZVBhdGgsXG4gICAgICAgICAgZGF0YXZpZXdRdWVyeTogY29uZmlnLmRhdGF2aWV3UXVlcnksIC8vIEtlZXAgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHlcbiAgICAgICAgICBxdWVyeUVuZ2luZVF1ZXJ5OiBjb25maWcucXVlcnlFbmdpbmVRdWVyeSwgLy8gTmV3IHF1ZXJ5IGVuZ2luZSBzdXBwb3J0XG4gICAgICAgICAgY3VzdG9tU2NyaXB0OiBjb25maWcuY3VzdG9tU2NyaXB0LFxuICAgICAgICB9O1xuXG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gYmFzZUNvbmZpZztcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHBhcnNlUHJvcGVydHlGaWx0ZXJzKGZpbHRlcnM6IGFueSk6IGFueVtdIHtcbiAgICBpZiAoIUFycmF5LmlzQXJyYXkoZmlsdGVycykpIHJldHVybiBbXTtcblxuICAgIHJldHVybiBmaWx0ZXJzLm1hcCgoZmlsdGVyKSA9PiAoe1xuICAgICAgcHJvcGVydHk6IGZpbHRlci5wcm9wZXJ0eSB8fCBcIlwiLFxuICAgICAgb3BlcmF0b3I6IGZpbHRlci5vcGVyYXRvciB8fCBcImVxdWFsc1wiLFxuICAgICAgdmFsdWU6IGZpbHRlci52YWx1ZSB8fCBcIlwiLFxuICAgIH0pKTtcbiAgfVxuXG4gIHByaXZhdGUgY2xlYW5DbGFzc05hbWUoY2xhc3NOYW1lOiBhbnkpOiBzdHJpbmcge1xuICAgIGlmICghY2xhc3NOYW1lKSByZXR1cm4gXCJcIjtcbiAgICBjb25zdCBzdHIgPSBBcnJheS5pc0FycmF5KGNsYXNzTmFtZSkgPyBjbGFzc05hbWVbMF0gOiBjbGFzc05hbWU7XG4gICAgcmV0dXJuIHN0cj8udG9TdHJpbmcoKS5yZXBsYWNlKC9cXFtcXFt8XFxdXFxdL2csIFwiXCIpIHx8IFwiXCI7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==