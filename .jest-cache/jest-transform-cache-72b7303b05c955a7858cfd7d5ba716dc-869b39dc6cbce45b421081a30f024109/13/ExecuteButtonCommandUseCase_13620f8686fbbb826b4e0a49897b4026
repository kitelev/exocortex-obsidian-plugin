1c61ea79133eae1ccbbd062ed61da1dc
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ExecuteButtonCommandUseCase = void 0;
const tslib_1 = require("tslib");
const Result_1 = require("../../domain/core/Result");
const AssetId_1 = require("../../domain/value-objects/AssetId");
class ExecuteButtonCommandUseCase {
    constructor(buttonRepository, commandExecutor) {
        this.buttonRepository = buttonRepository;
        this.commandExecutor = commandExecutor;
    }
    execute(request) {
        var _a, _b, _c;
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            // Validate request
            if (!request.buttonId) {
                return Result_1.Result.fail('Button ID is required');
            }
            // Parse button ID
            const buttonIdResult = AssetId_1.AssetId.create(request.buttonId);
            if (buttonIdResult.isFailure) {
                return Result_1.Result.fail('Invalid button ID');
            }
            const buttonId = buttonIdResult.getValue();
            // Find the button
            const buttonResult = yield this.buttonRepository.findButtonById(buttonId);
            if (buttonResult.isFailure) {
                return Result_1.Result.fail(`Failed to load button: ${buttonResult.error}`);
            }
            const button = buttonResult.getValue();
            if (!button) {
                return Result_1.Result.fail('Button not found');
            }
            // Check if button can be executed
            if (!button.canExecute()) {
                return Result_1.Result.fail('Button is disabled');
            }
            // Load the command
            const commandResult = yield this.buttonRepository.findCommandById(button.commandId);
            if (commandResult.isFailure) {
                return Result_1.Result.fail(`Failed to load command: ${commandResult.error}`);
            }
            const command = commandResult.getValue();
            if (!command) {
                return Result_1.Result.fail('Command not found');
            }
            // Check if command requires input but none provided
            if (command.requiresInput && !request.inputParameters) {
                // Return schema for input collection
                return Result_1.Result.ok({
                    success: false,
                    requiresInput: true,
                    inputSchema: {
                        title: command.name,
                        description: command.description,
                        parameters: command.parameters
                    }
                });
            }
            // Validate and prepare execution context
            const contextResult = command.buildExecutionContext(request.inputParameters || {});
            if (contextResult.isFailure) {
                return Result_1.Result.fail(`Invalid parameters: ${contextResult.error}`);
            }
            const executionContext = contextResult.getValue();
            // Execute the command through the command executor service
            try {
                const executionResult = yield this.commandExecutor.execute({
                    command: command,
                    context: Object.assign(Object.assign({}, executionContext), { assetId: request.assetId, currentView: (_a = request.context) === null || _a === void 0 ? void 0 : _a.currentView, currentClass: (_b = request.context) === null || _b === void 0 ? void 0 : _b.currentClass, selection: (_c = request.context) === null || _c === void 0 ? void 0 : _c.selection })
                });
                if (executionResult.isFailure) {
                    return Result_1.Result.fail(`Command execution failed: ${executionResult.error}`);
                }
                const result = executionResult.getValue();
                // Record button click event
                button.click();
                return Result_1.Result.ok({
                    success: true,
                    message: `Command '${command.name}' executed successfully`,
                    result: result
                });
            }
            catch (error) {
                return Result_1.Result.fail(`Unexpected error during command execution: ${error.message}`);
            }
        });
    }
}
exports.ExecuteButtonCommandUseCase = ExecuteButtonCommandUseCase;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2FwcGxpY2F0aW9uL3VzZS1jYXNlcy9FeGVjdXRlQnV0dG9uQ29tbWFuZFVzZUNhc2UudHMiLCJtYXBwaW5ncyI6Ijs7OztBQUNBLHFEQUFrRDtBQUdsRCxnRUFBNkQ7QUF5QjdELE1BQWEsMkJBQTJCO0lBR3BDLFlBQ1ksZ0JBQW1DLEVBQ25DLGVBQWlDO1FBRGpDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBbUI7UUFDbkMsb0JBQWUsR0FBZixlQUFlLENBQWtCO0lBQzFDLENBQUM7SUFFRSxPQUFPLENBQUMsT0FBb0M7OztZQUM5QyxtQkFBbUI7WUFDbkIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUU7Z0JBQ25CLE9BQU8sZUFBTSxDQUFDLElBQUksQ0FBK0IsdUJBQXVCLENBQUMsQ0FBQzthQUM3RTtZQUVELGtCQUFrQjtZQUNsQixNQUFNLGNBQWMsR0FBRyxpQkFBTyxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDeEQsSUFBSSxjQUFjLENBQUMsU0FBUyxFQUFFO2dCQUMxQixPQUFPLGVBQU0sQ0FBQyxJQUFJLENBQStCLG1CQUFtQixDQUFDLENBQUM7YUFDekU7WUFDRCxNQUFNLFFBQVEsR0FBRyxjQUFjLENBQUMsUUFBUSxFQUFFLENBQUM7WUFFM0Msa0JBQWtCO1lBQ2xCLE1BQU0sWUFBWSxHQUFHLE1BQU0sSUFBSSxDQUFDLGdCQUFnQixDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUMxRSxJQUFJLFlBQVksQ0FBQyxTQUFTLEVBQUU7Z0JBQ3hCLE9BQU8sZUFBTSxDQUFDLElBQUksQ0FDZCwwQkFBMEIsWUFBWSxDQUFDLEtBQUssRUFBRSxDQUNqRCxDQUFDO2FBQ0w7WUFFRCxNQUFNLE1BQU0sR0FBRyxZQUFZLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDdkMsSUFBSSxDQUFDLE1BQU0sRUFBRTtnQkFDVCxPQUFPLGVBQU0sQ0FB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IjpbXSwic291cmNlcyI6WyIvVXNlcnMva2l0ZWxldi9Eb2N1bWVudHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi9zcmMvYXBwbGljYXRpb24vdXNlLWNhc2VzL0V4ZWN1dGVCdXR0b25Db21tYW5kVXNlQ2FzZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBVc2VDYXNlIH0gZnJvbSAnLi4vY29yZS9Vc2VDYXNlJztcbmltcG9ydCB7IFJlc3VsdCB9IGZyb20gJy4uLy4uL2RvbWFpbi9jb3JlL1Jlc3VsdCc7XG5pbXBvcnQgeyBJQnV0dG9uUmVwb3NpdG9yeSB9IGZyb20gJy4uLy4uL2RvbWFpbi9yZXBvc2l0b3JpZXMvSUJ1dHRvblJlcG9zaXRvcnknO1xuaW1wb3J0IHsgSUNvbW1hbmRFeGVjdXRvciB9IGZyb20gJy4uL3NlcnZpY2VzL0lDb21tYW5kRXhlY3V0b3InO1xuaW1wb3J0IHsgQXNzZXRJZCB9IGZyb20gJy4uLy4uL2RvbWFpbi92YWx1ZS1vYmplY3RzL0Fzc2V0SWQnO1xuaW1wb3J0IHsgQ29tbWFuZFR5cGUgfSBmcm9tICcuLi8uLi9kb21haW4vZW50aXRpZXMvQnV0dG9uQ29tbWFuZCc7XG5cbi8qKlxuICogVXNlIENhc2UgZm9yIGV4ZWN1dGluZyBhIGJ1dHRvbiBjb21tYW5kXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRXhlY3V0ZUJ1dHRvbkNvbW1hbmRSZXF1ZXN0IHtcbiAgICBidXR0b25JZDogc3RyaW5nO1xuICAgIGFzc2V0SWQ/OiBzdHJpbmc7XG4gICAgaW5wdXRQYXJhbWV0ZXJzPzogUmVjb3JkPHN0cmluZywgYW55PjtcbiAgICBjb250ZXh0Pzoge1xuICAgICAgICBjdXJyZW50Vmlldz86IHN0cmluZztcbiAgICAgICAgY3VycmVudENsYXNzPzogc3RyaW5nO1xuICAgICAgICBzZWxlY3Rpb24/OiBzdHJpbmdbXTtcbiAgICB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEV4ZWN1dGVCdXR0b25Db21tYW5kUmVzcG9uc2Uge1xuICAgIHN1Y2Nlc3M6IGJvb2xlYW47XG4gICAgbWVzc2FnZT86IHN0cmluZztcbiAgICByZXN1bHQ/OiBhbnk7XG4gICAgcmVxdWlyZXNJbnB1dD86IGJvb2xlYW47XG4gICAgaW5wdXRTY2hlbWE/OiBhbnk7XG59XG5cbmV4cG9ydCBjbGFzcyBFeGVjdXRlQnV0dG9uQ29tbWFuZFVzZUNhc2UgXG4gICAgaW1wbGVtZW50cyBVc2VDYXNlPEV4ZWN1dGVCdXR0b25Db21tYW5kUmVxdWVzdCwgRXhlY3V0ZUJ1dHRvbkNvbW1hbmRSZXNwb25zZT4ge1xuICAgIFxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIGJ1dHRvblJlcG9zaXRvcnk6IElCdXR0b25SZXBvc2l0b3J5LFxuICAgICAgICBwcml2YXRlIGNvbW1hbmRFeGVjdXRvcjogSUNvbW1hbmRFeGVjdXRvclxuICAgICkge31cblxuICAgIGFzeW5jIGV4ZWN1dGUocmVxdWVzdDogRXhlY3V0ZUJ1dHRvbkNvbW1hbmRSZXF1ZXN0KTogUHJvbWlzZTxSZXN1bHQ8RXhlY3V0ZUJ1dHRvbkNvbW1hbmRSZXNwb25zZT4+IHtcbiAgICAgICAgLy8gVmFsaWRhdGUgcmVxdWVzdFxuICAgICAgICBpZiAoIXJlcXVlc3QuYnV0dG9uSWQpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxFeGVjdXRlQnV0dG9uQ29tbWFuZFJlc3BvbnNlPignQnV0dG9uIElEIGlzIHJlcXVpcmVkJyk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBQYXJzZSBidXR0b24gSURcbiAgICAgICAgY29uc3QgYnV0dG9uSWRSZXN1bHQgPSBBc3NldElkLmNyZWF0ZShyZXF1ZXN0LmJ1dHRvbklkKTtcbiAgICAgICAgaWYgKGJ1dHRvbklkUmVzdWx0LmlzRmFpbHVyZSkge1xuICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPEV4ZWN1dGVCdXR0b25Db21tYW5kUmVzcG9uc2U+KCdJbnZhbGlkIGJ1dHRvbiBJRCcpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGJ1dHRvbklkID0gYnV0dG9uSWRSZXN1bHQuZ2V0VmFsdWUoKTtcblxuICAgICAgICAvLyBGaW5kIHRoZSBidXR0b25cbiAgICAgICAgY29uc3QgYnV0dG9uUmVzdWx0ID0gYXdhaXQgdGhpcy5idXR0b25SZXBvc2l0b3J5LmZpbmRCdXR0b25CeUlkKGJ1dHRvbklkKTtcbiAgICAgICAgaWYgKGJ1dHRvblJlc3VsdC5pc0ZhaWx1cmUpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxFeGVjdXRlQnV0dG9uQ29tbWFuZFJlc3BvbnNlPihcbiAgICAgICAgICAgICAgICBgRmFpbGVkIHRvIGxvYWQgYnV0dG9uOiAke2J1dHRvblJlc3VsdC5lcnJvcn1gXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYnV0dG9uID0gYnV0dG9uUmVzdWx0LmdldFZhbHVlKCk7XG4gICAgICAgIGlmICghYnV0dG9uKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8RXhlY3V0ZUJ1dHRvbkNvbW1hbmRSZXNwb25zZT4oJ0J1dHRvbiBub3QgZm91bmQnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENoZWNrIGlmIGJ1dHRvbiBjYW4gYmUgZXhlY3V0ZWRcbiAgICAgICAgaWYgKCFidXR0b24uY2FuRXhlY3V0ZSgpKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8RXhlY3V0ZUJ1dHRvbkNvbW1hbmRSZXNwb25zZT4oJ0J1dHRvbiBpcyBkaXNhYmxlZCcpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gTG9hZCB0aGUgY29tbWFuZFxuICAgICAgICBjb25zdCBjb21tYW5kUmVzdWx0ID0gYXdhaXQgdGhpcy5idXR0b25SZXBvc2l0b3J5LmZpbmRDb21tYW5kQnlJZChidXR0b24uY29tbWFuZElkKTtcbiAgICAgICAgaWYgKGNvbW1hbmRSZXN1bHQuaXNGYWlsdXJlKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8RXhlY3V0ZUJ1dHRvbkNvbW1hbmRSZXNwb25zZT4oXG4gICAgICAgICAgICAgICAgYEZhaWxlZCB0byBsb2FkIGNvbW1hbmQ6ICR7Y29tbWFuZFJlc3VsdC5lcnJvcn1gXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY29tbWFuZCA9IGNvbW1hbmRSZXN1bHQuZ2V0VmFsdWUoKTtcbiAgICAgICAgaWYgKCFjb21tYW5kKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8RXhlY3V0ZUJ1dHRvbkNvbW1hbmRSZXNwb25zZT4oJ0NvbW1hbmQgbm90IGZvdW5kJyk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDaGVjayBpZiBjb21tYW5kIHJlcXVpcmVzIGlucHV0IGJ1dCBub25lIHByb3ZpZGVkXG4gICAgICAgIGlmIChjb21tYW5kLnJlcXVpcmVzSW5wdXQgJiYgIXJlcXVlc3QuaW5wdXRQYXJhbWV0ZXJzKSB7XG4gICAgICAgICAgICAvLyBSZXR1cm4gc2NoZW1hIGZvciBpbnB1dCBjb2xsZWN0aW9uXG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0Lm9rPEV4ZWN1dGVCdXR0b25Db21tYW5kUmVzcG9uc2U+KHtcbiAgICAgICAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICAgICAgICByZXF1aXJlc0lucHV0OiB0cnVlLFxuICAgICAgICAgICAgICAgIGlucHV0U2NoZW1hOiB7XG4gICAgICAgICAgICAgICAgICAgIHRpdGxlOiBjb21tYW5kLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBjb21tYW5kLmRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgICAgICAgICBwYXJhbWV0ZXJzOiBjb21tYW5kLnBhcmFtZXRlcnNcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFZhbGlkYXRlIGFuZCBwcmVwYXJlIGV4ZWN1dGlvbiBjb250ZXh0XG4gICAgICAgIGNvbnN0IGNvbnRleHRSZXN1bHQgPSBjb21tYW5kLmJ1aWxkRXhlY3V0aW9uQ29udGV4dChcbiAgICAgICAgICAgIHJlcXVlc3QuaW5wdXRQYXJhbWV0ZXJzIHx8IHt9XG4gICAgICAgICk7XG4gICAgICAgIFxuICAgICAgICBpZiAoY29udGV4dFJlc3VsdC5pc0ZhaWx1cmUpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxFeGVjdXRlQnV0dG9uQ29tbWFuZFJlc3BvbnNlPihcbiAgICAgICAgICAgICAgICBgSW52YWxpZCBwYXJhbWV0ZXJzOiAke2NvbnRleHRSZXN1bHQuZXJyb3J9YFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGV4ZWN1dGlvbkNvbnRleHQgPSBjb250ZXh0UmVzdWx0LmdldFZhbHVlKCk7XG5cbiAgICAgICAgLy8gRXhlY3V0ZSB0aGUgY29tbWFuZCB0aHJvdWdoIHRoZSBjb21tYW5kIGV4ZWN1dG9yIHNlcnZpY2VcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGV4ZWN1dGlvblJlc3VsdCA9IGF3YWl0IHRoaXMuY29tbWFuZEV4ZWN1dG9yLmV4ZWN1dGUoe1xuICAgICAgICAgICAgICAgIGNvbW1hbmQ6IGNvbW1hbmQsXG4gICAgICAgICAgICAgICAgY29udGV4dDoge1xuICAgICAgICAgICAgICAgICAgICAuLi5leGVjdXRpb25Db250ZXh0LFxuICAgICAgICAgICAgICAgICAgICBhc3NldElkOiByZXF1ZXN0LmFzc2V0SWQsXG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRWaWV3OiByZXF1ZXN0LmNvbnRleHQ/LmN1cnJlbnRWaWV3LFxuICAgICAgICAgICAgICAgICAgICBjdXJyZW50Q2xhc3M6IHJlcXVlc3QuY29udGV4dD8uY3VycmVudENsYXNzLFxuICAgICAgICAgICAgICAgICAgICBzZWxlY3Rpb246IHJlcXVlc3QuY29udGV4dD8uc2VsZWN0aW9uXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIGlmIChleGVjdXRpb25SZXN1bHQuaXNGYWlsdXJlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPEV4ZWN1dGVCdXR0b25Db21tYW5kUmVzcG9uc2U+KFxuICAgICAgICAgICAgICAgICAgICBgQ29tbWFuZCBleGVjdXRpb24gZmFpbGVkOiAke2V4ZWN1dGlvblJlc3VsdC5lcnJvcn1gXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gZXhlY3V0aW9uUmVzdWx0LmdldFZhbHVlKCk7XG5cbiAgICAgICAgICAgIC8vIFJlY29yZCBidXR0b24gY2xpY2sgZXZlbnRcbiAgICAgICAgICAgIGJ1dHRvbi5jbGljaygpO1xuXG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0Lm9rPEV4ZWN1dGVCdXR0b25Db21tYW5kUmVzcG9uc2U+KHtcbiAgICAgICAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGBDb21tYW5kICcke2NvbW1hbmQubmFtZX0nIGV4ZWN1dGVkIHN1Y2Nlc3NmdWxseWAsXG4gICAgICAgICAgICAgICAgcmVzdWx0OiByZXN1bHRcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8RXhlY3V0ZUJ1dHRvbkNvbW1hbmRSZXNwb25zZT4oXG4gICAgICAgICAgICAgICAgYFVuZXhwZWN0ZWQgZXJyb3IgZHVyaW5nIGNvbW1hbmQgZXhlY3V0aW9uOiAke2Vycm9yLm1lc3NhZ2V9YFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgIH1cbn0iXSwidmVyc2lvbiI6M30=