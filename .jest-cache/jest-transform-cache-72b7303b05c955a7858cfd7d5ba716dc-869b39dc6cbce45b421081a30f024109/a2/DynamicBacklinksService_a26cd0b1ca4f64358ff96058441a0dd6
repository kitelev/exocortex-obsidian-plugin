097e4d09cea292aca7b9f4823556fc4b
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DynamicBacklinksService = void 0;
const Result_1 = require("../../domain/core/Result");
class DynamicBacklinksService {
    constructor(vaultAdapter, uiAdapter) {
        this.vaultAdapter = vaultAdapter;
        this.uiAdapter = uiAdapter;
    }
    async discoverPropertyBasedBacklinks(targetFile, options = {}) {
        try {
            const propertyBacklinks = new Map();
            // Scan all markdown files in the vault
            const allFiles = await this.vaultAdapter.getFiles();
            for (const file of allFiles) {
                if (file.path === targetFile.path)
                    continue; // Skip self-references
                const metadata = await this.vaultAdapter.getFileMetadata(file);
                if (!metadata)
                    continue;
                // Filter by class if specified
                if (options.filterByClass) {
                    const instanceClass = this.uiAdapter.cleanClassName(metadata["exo__Instance_class"]);
                    if (instanceClass !== options.filterByClass)
                        continue;
                }
                // Check each frontmatter property for references to target file
                for (const [propertyName, value] of Object.entries(metadata)) {
                    // Skip excluded properties
                    if (options.excludeProperties?.includes(propertyName))
                        continue;
                    if (await this.isReferencingTarget(value, targetFile)) {
                        if (!propertyBacklinks.has(propertyName)) {
                            propertyBacklinks.set(propertyName, []);
                        }
                        propertyBacklinks.get(propertyName).push(file);
                    }
                }
            }
            // Convert to result format and apply limits
            const results = [];
            for (const [propertyName, files] of propertyBacklinks.entries()) {
                const limitedFiles = options.maxResultsPerProperty
                    ? files.slice(0, options.maxResultsPerProperty)
                    : files;
                results.push({
                    propertyName,
                    referencingFiles: limitedFiles,
                });
            }
            // Sort by property name for consistent ordering
            results.sort((a, b) => a.propertyName.localeCompare(b.propertyName));
            return Result_1.Result.ok(results);
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to discover backlinks: ${error}`);
        }
    }
    async isReferencingTarget(value, targetFile) {
        if (!value)
            return false;
        // Handle arrays
        if (Array.isArray(value)) {
            for (const item of value) {
                if (await this.isReferencingTarget(item, targetFile)) {
                    return true;
                }
            }
            return false;
        }
        // Convert to string and check various reference formats
        const strValue = value.toString();
        const targetFileName = targetFile.basename || targetFile.name?.replace(/\.[^/.]+$/, "") || "";
        const targetPath = targetFile.path || targetFile.name || "";
        // Get target file's UUID for UUID-based matching
        const targetMetadata = await this.vaultAdapter.getFileMetadata(targetFile);
        const targetUuid = targetMetadata?.["exo__Asset_uid"] || null;
        // Direct basename match
        if (strValue === targetFileName)
            return true;
        // Wiki-link format exact match
        if (strValue.includes(`[[${targetFileName}]]`))
            return true;
        // Wiki-link with display text
        if (strValue.includes(`[[${targetFileName}|`))
            return true;
        // Path-based matching for references like [[Area - My]]
        if (strValue.startsWith("[[") && strValue.endsWith("]]")) {
            const linkText = strValue.slice(2, -2).split("|")[0]; // Remove [[ ]] and display text
            // Try to resolve the link to see if it points to our target file
            if (this.vaultAdapter.resolveLinkToFile) {
                try {
                    const resolvedFile = await this.vaultAdapter.resolveLinkToFile(linkText);
                    if (resolvedFile && resolvedFile.path === targetFile.path) {
                        return true;
                    }
                }
                catch (error) {
                    // Ignore resolution errors and fall back to text matching
                }
            }
            if (linkText === targetFileName)
                return true;
            // Also check if the link text partially matches the target filename
            if (targetFileName.includes(linkText) ||
                linkText.includes(targetFileName))
                return true;
        }
        // UUID-based matching
        if (targetUuid && strValue.includes(targetUuid))
            return true;
        // Partial match within string (for composite references)
        if (strValue.includes(targetFileName))
            return true;
        return false;
    }
    cleanClassName(className) {
        if (!className)
            return "";
        const str = Array.isArray(className) ? className[0] : className;
        return str?.toString().replace(/\[\[|\]\]/g, "") || "";
    }
}
exports.DynamicBacklinksService = DynamicBacklinksService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2FwcGxpY2F0aW9uL3NlcnZpY2VzL0R5bmFtaWNCYWNrbGlua3NTZXJ2aWNlLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLHFEQUFrRDtBQWVsRCxNQUFhLHVCQUF1QjtJQUNsQyxZQUNVLFlBQTJCLEVBQzNCLFNBQXFCO1FBRHJCLGlCQUFZLEdBQVosWUFBWSxDQUFlO1FBQzNCLGNBQVMsR0FBVCxTQUFTLENBQVk7SUFDNUIsQ0FBQztJQUVKLEtBQUssQ0FBQyw4QkFBOEIsQ0FDbEMsVUFBZSxFQUNmLFVBQW9DLEVBQUU7UUFFdEMsSUFBSTtZQUNGLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxHQUFHLEVBQWlCLENBQUM7WUFFbkQsdUNBQXVDO1lBQ3ZDLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUVwRCxLQUFLLE1BQU0sSUFBSSxJQUFJLFFBQVEsRUFBRTtnQkFDM0IsSUFBSSxJQUFJLENBQUMsSUFBSSxLQUFLLFVBQVUsQ0FBQyxJQUFJO29CQUFFLFNBQVMsQ0FBQyx1QkFBdUI7Z0JBRXBFLE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLFlBQVksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQy9ELElBQUksQ0FBQyxRQUFRO29CQUFFLFNBQVM7Z0JBRXhCLCtCQUErQjtnQkFDL0IsSUFBSSxPQUFPLENBQUMsYUFBYSxFQUFFO29CQUN6QixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsQ0FDakQsUUFBUSxDQUFDLHFCQUFxQixDQUFDLENBQ2hDLENBQUM7b0JBQ0YsSUFBSSxhQUFhLEtBQUssT0FBTyxDQUFDLGFBQWE7d0JBQUUsU0FBUztpQkFDdkQ7Z0JBRUQsZ0VBQWdFO2dCQUNoRSxLQUFLLE1BQU0sQ0FBQyxZQUFZLEVBQUUsS0FBSyxDQUFDLElBQUksTUFBTSxDQUFDLE9BQU8s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SSxDQUFDO1FBRW5ELE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVPLGNBQWMsQ0FBQyxTQUFjO1FBQ25DLElBQUksQ0FBQyxTQUFTO1lBQUUsT0FBTyxFQUFFLENBQUM7UUFDMUIsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFDaEUsT0FBTyxHQUFHLEVBQUUsUUFBUSxFQUFFLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDekQsQ0FBQztDQUNGO0FBMUlELDBEQTBJQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva2l0ZWxldi9Eb2N1bWVudHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi9zcmMvYXBwbGljYXRpb24vc2VydmljZXMvRHluYW1pY0JhY2tsaW5rc1NlcnZpY2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUmVzdWx0IH0gZnJvbSBcIi4uLy4uL2RvbWFpbi9jb3JlL1Jlc3VsdFwiO1xuaW1wb3J0IHsgSVZhdWx0QWRhcHRlciB9IGZyb20gXCIuLi9wb3J0cy9JVmF1bHRBZGFwdGVyXCI7XG5pbXBvcnQgeyBJVUlBZGFwdGVyIH0gZnJvbSBcIi4uL3BvcnRzL0lVSUFkYXB0ZXJcIjtcblxuZXhwb3J0IGludGVyZmFjZSBQcm9wZXJ0eUJhc2VkQmFja2xpbmsge1xuICBwcm9wZXJ0eU5hbWU6IHN0cmluZztcbiAgcmVmZXJlbmNpbmdGaWxlczogYW55W107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQmFja2xpbmtEaXNjb3ZlcnlPcHRpb25zIHtcbiAgZXhjbHVkZVByb3BlcnRpZXM/OiBzdHJpbmdbXTtcbiAgbWF4UmVzdWx0c1BlclByb3BlcnR5PzogbnVtYmVyO1xuICBmaWx0ZXJCeUNsYXNzPzogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgRHluYW1pY0JhY2tsaW5rc1NlcnZpY2Uge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHZhdWx0QWRhcHRlcjogSVZhdWx0QWRhcHRlcixcbiAgICBwcml2YXRlIHVpQWRhcHRlcjogSVVJQWRhcHRlcixcbiAgKSB7fVxuXG4gIGFzeW5jIGRpc2NvdmVyUHJvcGVydHlCYXNlZEJhY2tsaW5rcyhcbiAgICB0YXJnZXRGaWxlOiBhbnksXG4gICAgb3B0aW9uczogQmFja2xpbmtEaXNjb3ZlcnlPcHRpb25zID0ge30sXG4gICk6IFByb21pc2U8UmVzdWx0PFByb3BlcnR5QmFzZWRCYWNrbGlua1tdPj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBwcm9wZXJ0eUJhY2tsaW5rcyA9IG5ldyBNYXA8c3RyaW5nLCBhbnlbXT4oKTtcblxuICAgICAgLy8gU2NhbiBhbGwgbWFya2Rvd24gZmlsZXMgaW4gdGhlIHZhdWx0XG4gICAgICBjb25zdCBhbGxGaWxlcyA9IGF3YWl0IHRoaXMudmF1bHRBZGFwdGVyLmdldEZpbGVzKCk7XG5cbiAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBhbGxGaWxlcykge1xuICAgICAgICBpZiAoZmlsZS5wYXRoID09PSB0YXJnZXRGaWxlLnBhdGgpIGNvbnRpbnVlOyAvLyBTa2lwIHNlbGYtcmVmZXJlbmNlc1xuXG4gICAgICAgIGNvbnN0IG1ldGFkYXRhID0gYXdhaXQgdGhpcy52YXVsdEFkYXB0ZXIuZ2V0RmlsZU1ldGFkYXRhKGZpbGUpO1xuICAgICAgICBpZiAoIW1ldGFkYXRhKSBjb250aW51ZTtcblxuICAgICAgICAvLyBGaWx0ZXIgYnkgY2xhc3MgaWYgc3BlY2lmaWVkXG4gICAgICAgIGlmIChvcHRpb25zLmZpbHRlckJ5Q2xhc3MpIHtcbiAgICAgICAgICBjb25zdCBpbnN0YW5jZUNsYXNzID0gdGhpcy51aUFkYXB0ZXIuY2xlYW5DbGFzc05hbWUoXG4gICAgICAgICAgICBtZXRhZGF0YVtcImV4b19fSW5zdGFuY2VfY2xhc3NcIl0sXG4gICAgICAgICAgKTtcbiAgICAgICAgICBpZiAoaW5zdGFuY2VDbGFzcyAhPT0gb3B0aW9ucy5maWx0ZXJCeUNsYXNzKSBjb250aW51ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENoZWNrIGVhY2ggZnJvbnRtYXR0ZXIgcHJvcGVydHkgZm9yIHJlZmVyZW5jZXMgdG8gdGFyZ2V0IGZpbGVcbiAgICAgICAgZm9yIChjb25zdCBbcHJvcGVydHlOYW1lLCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMobWV0YWRhdGEpKSB7XG4gICAgICAgICAgLy8gU2tpcCBleGNsdWRlZCBwcm9wZXJ0aWVzXG4gICAgICAgICAgaWYgKG9wdGlvbnMuZXhjbHVkZVByb3BlcnRpZXM/LmluY2x1ZGVzKHByb3BlcnR5TmFtZSkpIGNvbnRpbnVlO1xuXG4gICAgICAgICAgaWYgKGF3YWl0IHRoaXMuaXNSZWZlcmVuY2luZ1RhcmdldCh2YWx1ZSwgdGFyZ2V0RmlsZSkpIHtcbiAgICAgICAgICAgIGlmICghcHJvcGVydHlCYWNrbGlua3MuaGFzKHByb3BlcnR5TmFtZSkpIHtcbiAgICAgICAgICAgICAgcHJvcGVydHlCYWNrbGlua3Muc2V0KHByb3BlcnR5TmFtZSwgW10pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcHJvcGVydHlCYWNrbGlua3MuZ2V0KHByb3BlcnR5TmFtZSkhLnB1c2goZmlsZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIENvbnZlcnQgdG8gcmVzdWx0IGZvcm1hdCBhbmQgYXBwbHkgbGltaXRzXG4gICAgICBjb25zdCByZXN1bHRzOiBQcm9wZXJ0eUJhc2VkQmFja2xpbmtbXSA9IFtdO1xuICAgICAgZm9yIChjb25zdCBbcHJvcGVydHlOYW1lLCBmaWxlc10gb2YgcHJvcGVydHlCYWNrbGlua3MuZW50cmllcygpKSB7XG4gICAgICAgIGNvbnN0IGxpbWl0ZWRGaWxlcyA9IG9wdGlvbnMubWF4UmVzdWx0c1BlclByb3BlcnR5XG4gICAgICAgICAgPyBmaWxlcy5zbGljZSgwLCBvcHRpb25zLm1heFJlc3VsdHNQZXJQcm9wZXJ0eSlcbiAgICAgICAgICA6IGZpbGVzO1xuXG4gICAgICAgIHJlc3VsdHMucHVzaCh7XG4gICAgICAgICAgcHJvcGVydHlOYW1lLFxuICAgICAgICAgIHJlZmVyZW5jaW5nRmlsZXM6IGxpbWl0ZWRGaWxlcyxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIC8vIFNvcnQgYnkgcHJvcGVydHkgbmFtZSBmb3IgY29uc2lzdGVudCBvcmRlcmluZ1xuICAgICAgcmVzdWx0cy5zb3J0KChhLCBiKSA9PiBhLnByb3BlcnR5TmFtZS5sb2NhbGVDb21wYXJlKGIucHJvcGVydHlOYW1lKSk7XG5cbiAgICAgIHJldHVybiBSZXN1bHQub2socmVzdWx0cyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbChgRmFpbGVkIHRvIGRpc2NvdmVyIGJhY2tsaW5rczogJHtlcnJvcn1gKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGlzUmVmZXJlbmNpbmdUYXJnZXQodmFsdWU6IGFueSwgdGFyZ2V0RmlsZTogYW55KTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgaWYgKCF2YWx1ZSkgcmV0dXJuIGZhbHNlO1xuXG4gICAgLy8gSGFuZGxlIGFycmF5c1xuICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHZhbHVlKSB7XG4gICAgICAgIGlmIChhd2FpdCB0aGlzLmlzUmVmZXJlbmNpbmdUYXJnZXQoaXRlbSwgdGFyZ2V0RmlsZSkpIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIENvbnZlcnQgdG8gc3RyaW5nIGFuZCBjaGVjayB2YXJpb3VzIHJlZmVyZW5jZSBmb3JtYXRzXG4gICAgY29uc3Qgc3RyVmFsdWUgPSB2YWx1ZS50b1N0cmluZygpO1xuICAgIGNvbnN0IHRhcmdldEZpbGVOYW1lID1cbiAgICAgIHRhcmdldEZpbGUuYmFzZW5hbWUgfHwgdGFyZ2V0RmlsZS5uYW1lPy5yZXBsYWNlKC9cXC5bXi8uXSskLywgXCJcIikgfHwgXCJcIjtcbiAgICBjb25zdCB0YXJnZXRQYXRoID0gdGFyZ2V0RmlsZS5wYXRoIHx8IHRhcmdldEZpbGUubmFtZSB8fCBcIlwiO1xuXG4gICAgLy8gR2V0IHRhcmdldCBmaWxlJ3MgVVVJRCBmb3IgVVVJRC1iYXNlZCBtYXRjaGluZ1xuICAgIGNvbnN0IHRhcmdldE1ldGFkYXRhID0gYXdhaXQgdGhpcy52YXVsdEFkYXB0ZXIuZ2V0RmlsZU1ldGFkYXRhKHRhcmdldEZpbGUpO1xuICAgIGNvbnN0IHRhcmdldFV1aWQgPSB0YXJnZXRNZXRhZGF0YT8uW1wiZXhvX19Bc3NldF91aWRcIl0gfHwgbnVsbDtcblxuICAgIC8vIERpcmVjdCBiYXNlbmFtZSBtYXRjaFxuICAgIGlmIChzdHJWYWx1ZSA9PT0gdGFyZ2V0RmlsZU5hbWUpIHJldHVybiB0cnVlO1xuXG4gICAgLy8gV2lraS1saW5rIGZvcm1hdCBleGFjdCBtYXRjaFxuICAgIGlmIChzdHJWYWx1ZS5pbmNsdWRlcyhgW1ske3RhcmdldEZpbGVOYW1lfV1dYCkpIHJldHVybiB0cnVlO1xuXG4gICAgLy8gV2lraS1saW5rIHdpdGggZGlzcGxheSB0ZXh0XG4gICAgaWYgKHN0clZhbHVlLmluY2x1ZGVzKGBbWyR7dGFyZ2V0RmlsZU5hbWV9fGApKSByZXR1cm4gdHJ1ZTtcblxuICAgIC8vIFBhdGgtYmFzZWQgbWF0Y2hpbmcgZm9yIHJlZmVyZW5jZXMgbGlrZSBbW0FyZWEgLSBNeV1dXG4gICAgaWYgKHN0clZhbHVlLnN0YXJ0c1dpdGgoXCJbW1wiKSAmJiBzdHJWYWx1ZS5lbmRzV2l0aChcIl1dXCIpKSB7XG4gICAgICBjb25zdCBsaW5rVGV4dCA9IHN0clZhbHVlLnNsaWNlKDIsIC0yKS5zcGxpdChcInxcIilbMF07IC8vIFJlbW92ZSBbWyBdXSBhbmQgZGlzcGxheSB0ZXh0XG5cbiAgICAgIC8vIFRyeSB0byByZXNvbHZlIHRoZSBsaW5rIHRvIHNlZSBpZiBpdCBwb2ludHMgdG8gb3VyIHRhcmdldCBmaWxlXG4gICAgICBpZiAodGhpcy52YXVsdEFkYXB0ZXIucmVzb2x2ZUxpbmtUb0ZpbGUpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBjb25zdCByZXNvbHZlZEZpbGUgPSBhd2FpdCB0aGlzLnZhdWx0QWRhcHRlci5yZXNvbHZlTGlua1RvRmlsZShsaW5rVGV4dCk7XG4gICAgICAgICAgaWYgKHJlc29sdmVkRmlsZSAmJiByZXNvbHZlZEZpbGUucGF0aCA9PT0gdGFyZ2V0RmlsZS5wYXRoKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgLy8gSWdub3JlIHJlc29sdXRpb24gZXJyb3JzIGFuZCBmYWxsIGJhY2sgdG8gdGV4dCBtYXRjaGluZ1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGlmIChsaW5rVGV4dCA9PT0gdGFyZ2V0RmlsZU5hbWUpIHJldHVybiB0cnVlO1xuXG4gICAgICAvLyBBbHNvIGNoZWNrIGlmIHRoZSBsaW5rIHRleHQgcGFydGlhbGx5IG1hdGNoZXMgdGhlIHRhcmdldCBmaWxlbmFtZVxuICAgICAgaWYgKFxuICAgICAgICB0YXJnZXRGaWxlTmFtZS5pbmNsdWRlcyhsaW5rVGV4dCkgfHxcbiAgICAgICAgbGlua1RleHQuaW5jbHVkZXModGFyZ2V0RmlsZU5hbWUpXG4gICAgICApXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8vIFVVSUQtYmFzZWQgbWF0Y2hpbmdcbiAgICBpZiAodGFyZ2V0VXVpZCAmJiBzdHJWYWx1ZS5pbmNsdWRlcyh0YXJnZXRVdWlkKSkgcmV0dXJuIHRydWU7XG5cbiAgICAvLyBQYXJ0aWFsIG1hdGNoIHdpdGhpbiBzdHJpbmcgKGZvciBjb21wb3NpdGUgcmVmZXJlbmNlcylcbiAgICBpZiAoc3RyVmFsdWUuaW5jbHVkZXModGFyZ2V0RmlsZU5hbWUpKSByZXR1cm4gdHJ1ZTtcblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgY2xlYW5DbGFzc05hbWUoY2xhc3NOYW1lOiBhbnkpOiBzdHJpbmcge1xuICAgIGlmICghY2xhc3NOYW1lKSByZXR1cm4gXCJcIjtcbiAgICBjb25zdCBzdHIgPSBBcnJheS5pc0FycmF5KGNsYXNzTmFtZSkgPyBjbGFzc05hbWVbMF0gOiBjbGFzc05hbWU7XG4gICAgcmV0dXJuIHN0cj8udG9TdHJpbmcoKS5yZXBsYWNlKC9cXFtcXFt8XFxdXFxdL2csIFwiXCIpIHx8IFwiXCI7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==