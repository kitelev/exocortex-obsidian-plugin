5b47d77c7b67fa154aa8945260536a22
"use strict";
/**
 * Memory Optimization Setup for Jest Tests
 * Critical fixes for JavaScript heap out of memory errors
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.IndexedGraphOptimizer = exports.MemoryMonitor = exports.DOMOptimizer = exports.PerformanceTestOptimizer = exports.OptimizedMockFactory = void 0;
// Initialize global memory tracking
global.__MEMORY_OPTIMIZATION_ENABLED__ = true;
global.__MOCK_INSTANCES__ = new Map();
global.__PERFORMANCE_MONITORS__ = [];
/**
 * Memory-efficient mock factory to prevent duplicate object creation
 */
class OptimizedMockFactory {
    static createOrReuse(key, factory) {
        if (this.instances.has(key)) {
            return this.instances.get(key);
        }
        const instance = factory();
        this.instances.set(key, instance);
        global.__MOCK_INSTANCES__.set(key, instance);
        return instance;
    }
    static clear() {
        this.instances.clear();
        global.__MOCK_INSTANCES__.clear();
    }
    static clearInstance(key) {
        this.instances.delete(key);
        global.__MOCK_INSTANCES__.delete(key);
    }
}
exports.OptimizedMockFactory = OptimizedMockFactory;
OptimizedMockFactory.instances = new Map();
/**
 * Optimize performance-heavy test patterns
 */
class PerformanceTestOptimizer {
    static optimizePerformanceNow() {
        // Replace performance.now with lighter alternative for most tests
        performance.now = jest.fn(() => {
            this.callCount++;
            // Use simpler timing for most calls to reduce overhead
            if (this.callCount % 100 === 0) {
                return this.originalPerformanceNow.call(performance);
            }
            return Date.now() + Math.random(); // Fake but unique timing
        });
    }
    static restorePerformanceNow() {
        performance.now = this.originalPerformanceNow;
        this.callCount = 0;
    }
}
exports.PerformanceTestOptimizer = PerformanceTestOptimizer;
PerformanceTestOptimizer.originalPerformanceNow = performance.now;
PerformanceTestOptimizer.callCount = 0;
/**
 * Aggressive DOM cleanup to prevent memory leaks
 */
class DOMOptimizer {
    static optimizeDOM() {
        // Track element creation for cleanup
        document.createElement = function (tagName, options) {
            const element = DOMOptimizer.originalCreateElement.call(this, tagName, options);
            DOMOptimizer.createdElements.add(element);
            return element;
        };
    }
    static cleanupDOM() {
        // Aggressive DOM cleanup
        if (document.body) {
            document.body.innerHTML = "";
        }
        // Clear document head of any test-created elements
        const head = document.head;
        if (head) {
            const testElements = head.querySelectorAll("[data-test]");
            testElements.forEach((el) => el.remove());
        }
        // Force cleanup of disconnected nodes
        if (typeof global.gc === "function") {
            try {
                global.gc();
            }
            catch (e) {
                // Ignore GC errors
            }
        }
    }
    static restoreDOM() {
        document.createElement = this.originalCreateElement;
    }
}
exports.DOMOptimizer = DOMOptimizer;
DOMOptimizer.createdElements = new WeakSet();
DOMOptimizer.originalCreateElement = document.createElement;
/**
 * Memory usage monitor for early warning
 */
class MemoryMonitor {
    static checkMemoryUsage(testName) {
        if (typeof process.memoryUsage === "function") {
            const usage = process.memoryUsage();
            const heapUsed = usage.heapUsed;
            if (heapUsed > this.memoryThreshold) {
                console.warn(`âš ï¸  Memory Warning: Test "${testName}" using ${Math.round(heapUsed / 1024 / 1024)}MB`);
                // Force garbage collection if available
                if (typeof global.gc === "function") {
                    global.gc();
                }
            }
            this.lastMemoryCheck = heapUsed;
        }
    }
    static startMonitoring(testName) {
        global.__PERFORMANCE_MONITORS__.push({
            name: testName,
            start: Date.now(),
        });
    }
    static stopMonitoring(testName) {
        const monitor = global.__PERFORMANCE_MONITORS__.find((m) => m.name === testName);
        if (monitor) {
            const duration = Date.now() - monitor.start;
            if (duration > 5000) {
                // Warn about tests taking > 5 seconds
                console.warn(`â° Slow Test Warning: "${testName}" took ${duration}ms`);
            }
            // Remove from monitors
            const index = global.__PERFORMANCE_MONITORS__.indexOf(monitor);
            if (index > -1) {
                global.__PERFORMANCE_MONITORS__.splice(index, 1);
            }
        }
    }
}
exports.MemoryMonitor = MemoryMonitor;
MemoryMonitor.lastMemoryCheck = 0;
MemoryMonitor.memoryThreshold = process.env.CI
    ? 100 * 1024 * 1024 // 100MB in CI
    : 500 * 1024 * 1024; // 500MB locally
/**
 * Optimize IndexedGraph performance tests to use less memory
 */
class IndexedGraphOptimizer {
    static optimizeTestData() {
        // Patch any large data structure creation in IndexedGraph tests
        const originalArray = Array;
        global.Array = function (...args) {
            // Limit array sizes in tests to prevent memory explosion
            if (args.length === 1 && typeof args[0] === "number" && args[0] > 1000) {
                console.warn(`Array size limited from ${args[0]} to 1000 for memory optimization`);
                return new originalArray(1000);
            }
            return new originalArray(...args);
        };
        // Copy static methods
        Object.setPrototypeOf(global.Array, originalArray);
        Object.defineProperty(global.Array, "from", {
            value: originalArray.from,
        });
        Object.defineProperty(global.Array, "isArray", {
            value: originalArray.isArray,
        });
        Object.defineProperty(global.Array, "of", {
            value: originalArray.of,
        });
    }
    static restoreTestData() {
        global.Array = Array;
    }
}
exports.IndexedGraphOptimizer = IndexedGraphOptimizer;
// Apply optimizations during setup
beforeAll(() => {
    if (process.env.CI || process.env.MEMORY_OPTIMIZATION) {
        console.log("ðŸš€ Applying memory optimizations for CI/CD...");
        // Apply all optimizations
        PerformanceTestOptimizer.optimizePerformanceNow();
        DOMOptimizer.optimizeDOM();
        IndexedGraphOptimizer.optimizeTestData();
        // Set more aggressive timeouts for CI
        jest.setTimeout(process.env.CI ? 30000 : 10000);
    }
});
// Monitor memory before each test
beforeEach(() => {
    const testName = expect.getState()?.currentTestName || "unknown";
    MemoryMonitor.startMonitoring(testName);
    MemoryMonitor.checkMemoryUsage(testName);
    // Clear mock instances before each test
    OptimizedMockFactory.clear();
});
// Aggressive cleanup after each test
afterEach(() => {
    const testName = expect.getState()?.currentTestName || "unknown";
    // Stop monitoring
    MemoryMonitor.stopMonitoring(testName);
    // Aggressive cleanup
    DOMOptimizer.cleanupDOM();
    OptimizedMockFactory.clear();
    // Clear Jest mocks aggressively
    jest.clearAllMocks();
    jest.clearAllTimers();
    jest.restoreAllMocks();
    // Force garbage collection in CI
    if (process.env.CI && typeof global.gc === "function") {
        global.gc();
    }
    // Final memory check
    MemoryMonitor.checkMemoryUsage(`${testName}-cleanup`);
});
// Restore optimizations after all tests
afterAll(() => {
    if (process.env.CI || process.env.MEMORY_OPTIMIZATION) {
        console.log("ðŸ§¹ Restoring original implementations...");
        PerformanceTestOptimizer.restorePerformanceNow();
        DOMOptimizer.restoreDOM();
        IndexedGraphOptimizer.restoreTestData();
        // Final cleanup
        OptimizedMockFactory.clear();
        if (typeof global.gc === "function") {
            global.gc();
        }
    }
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vdGVzdHMvbWVtb3J5LW9wdGltaXphdGlvbi1zZXR1cC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7OztHQUdHOzs7QUFTSCxvQ0FBb0M7QUFDcEMsTUFBTSxDQUFDLCtCQUErQixHQUFHLElBQUksQ0FBQztBQUM5QyxNQUFNLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztBQUN0QyxNQUFNLENBQUMsd0JBQXdCLEdBQUcsRUFBRSxDQUFDO0FBRXJDOztHQUVHO0FBQ0gsTUFBTSxvQkFBb0I7SUFHeEIsTUFBTSxDQUFDLGFBQWEsQ0FBSSxHQUFXLEVBQUUsT0FBZ0I7UUFDbkQsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUMzQixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ2hDO1FBRUQsTUFBTSxRQUFRLEdBQUcsT0FBTyxFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ2xDLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzdDLE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFFRCxNQUFNLENBQUMsS0FBSztRQUNWLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDdkIsTUFBTSxDQUFDLGtCQUFrQixDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3BDLENBQUM7SUFFRCxNQUFNLENBQUMsYUFBYSxDQUFDLEdBQVc7UUFDOUIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDM0IsTUFBTSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUN4QyxDQUFDOztB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LENBQUM7UUFFN0IsSUFBSSxPQUFPLE1BQU0sQ0FBQyxFQUFFLEtBQUssVUFBVSxFQUFFO1lBQ25DLE1BQU0sQ0FBQyxFQUFFLEVBQUUsQ0FBQztTQUNiO0tBQ0Y7QUFDSCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva2l0ZWxldi9Eb2N1bWVudHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi90ZXN0cy9tZW1vcnktb3B0aW1pemF0aW9uLXNldHVwLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogTWVtb3J5IE9wdGltaXphdGlvbiBTZXR1cCBmb3IgSmVzdCBUZXN0c1xuICogQ3JpdGljYWwgZml4ZXMgZm9yIEphdmFTY3JpcHQgaGVhcCBvdXQgb2YgbWVtb3J5IGVycm9yc1xuICovXG5cbi8vIEdsb2JhbCBtZW1vcnkgbW9uaXRvcmluZyBhbmQgb3B0aW1pemF0aW9uXG5kZWNsYXJlIGdsb2JhbCB7XG4gIHZhciBfX01FTU9SWV9PUFRJTUlaQVRJT05fRU5BQkxFRF9fOiBib29sZWFuO1xuICB2YXIgX19NT0NLX0lOU1RBTkNFU19fOiBNYXA8c3RyaW5nLCBhbnk+O1xuICB2YXIgX19QRVJGT1JNQU5DRV9NT05JVE9SU19fOiBBcnJheTx7IG5hbWU6IHN0cmluZzsgc3RhcnQ6IG51bWJlciB9Pjtcbn1cblxuLy8gSW5pdGlhbGl6ZSBnbG9iYWwgbWVtb3J5IHRyYWNraW5nXG5nbG9iYWwuX19NRU1PUllfT1BUSU1JWkFUSU9OX0VOQUJMRURfXyA9IHRydWU7XG5nbG9iYWwuX19NT0NLX0lOU1RBTkNFU19fID0gbmV3IE1hcCgpO1xuZ2xvYmFsLl9fUEVSRk9STUFOQ0VfTU9OSVRPUlNfXyA9IFtdO1xuXG4vKipcbiAqIE1lbW9yeS1lZmZpY2llbnQgbW9jayBmYWN0b3J5IHRvIHByZXZlbnQgZHVwbGljYXRlIG9iamVjdCBjcmVhdGlvblxuICovXG5jbGFzcyBPcHRpbWl6ZWRNb2NrRmFjdG9yeSB7XG4gIHByaXZhdGUgc3RhdGljIGluc3RhbmNlcyA9IG5ldyBNYXA8c3RyaW5nLCBhbnk+KCk7XG5cbiAgc3RhdGljIGNyZWF0ZU9yUmV1c2U8VD4oa2V5OiBzdHJpbmcsIGZhY3Rvcnk6ICgpID0+IFQpOiBUIHtcbiAgICBpZiAodGhpcy5pbnN0YW5jZXMuaGFzKGtleSkpIHtcbiAgICAgIHJldHVybiB0aGlzLmluc3RhbmNlcy5nZXQoa2V5KTtcbiAgICB9XG5cbiAgICBjb25zdCBpbnN0YW5jZSA9IGZhY3RvcnkoKTtcbiAgICB0aGlzLmluc3RhbmNlcy5zZXQoa2V5LCBpbnN0YW5jZSk7XG4gICAgZ2xvYmFsLl9fTU9DS19JTlNUQU5DRVNfXy5zZXQoa2V5LCBpbnN0YW5jZSk7XG4gICAgcmV0dXJuIGluc3RhbmNlO1xuICB9XG5cbiAgc3RhdGljIGNsZWFyKCk6IHZvaWQge1xuICAgIHRoaXMuaW5zdGFuY2VzLmNsZWFyKCk7XG4gICAgZ2xvYmFsLl9fTU9DS19JTlNUQU5DRVNfXy5jbGVhcigpO1xuICB9XG5cbiAgc3RhdGljIGNsZWFySW5zdGFuY2Uoa2V5OiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLmluc3RhbmNlcy5kZWxldGUoa2V5KTtcbiAgICBnbG9iYWwuX19NT0NLX0lOU1RBTkNFU19fLmRlbGV0ZShrZXkpO1xuICB9XG59XG5cbi8qKlxuICogT3B0aW1pemUgcGVyZm9ybWFuY2UtaGVhdnkgdGVzdCBwYXR0ZXJuc1xuICovXG5jbGFzcyBQZXJmb3JtYW5jZVRlc3RPcHRpbWl6ZXIge1xuICBwcml2YXRlIHN0YXRpYyBvcmlnaW5hbFBlcmZvcm1hbmNlTm93ID0gcGVyZm9ybWFuY2Uubm93O1xuICBwcml2YXRlIHN0YXRpYyBjYWxsQ291bnQgPSAwO1xuXG4gIHN0YXRpYyBvcHRpbWl6ZVBlcmZvcm1hbmNlTm93KCk6IHZvaWQge1xuICAgIC8vIFJlcGxhY2UgcGVyZm9ybWFuY2Uubm93IHdpdGggbGlnaHRlciBhbHRlcm5hdGl2ZSBmb3IgbW9zdCB0ZXN0c1xuICAgIHBlcmZvcm1hbmNlLm5vdyA9IGplc3QuZm4oKCkgPT4ge1xuICAgICAgdGhpcy5jYWxsQ291bnQrKztcbiAgICAgIC8vIFVzZSBzaW1wbGVyIHRpbWluZyBmb3IgbW9zdCBjYWxscyB0byByZWR1Y2Ugb3ZlcmhlYWRcbiAgICAgIGlmICh0aGlzLmNhbGxDb3VudCAlIDEwMCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gdGhpcy5vcmlnaW5hbFBlcmZvcm1hbmNlTm93LmNhbGwocGVyZm9ybWFuY2UpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIERhdGUubm93KCkgKyBNYXRoLnJhbmRvbSgpOyAvLyBGYWtlIGJ1dCB1bmlxdWUgdGltaW5nXG4gICAgfSkgYXMgYW55O1xuICB9XG5cbiAgc3RhdGljIHJlc3RvcmVQZXJmb3JtYW5jZU5vdygpOiB2b2lkIHtcbiAgICBwZXJmb3JtYW5jZS5ub3cgPSB0aGlzLm9yaWdpbmFsUGVyZm9ybWFuY2VOb3c7XG4gICAgdGhpcy5jYWxsQ291bnQgPSAwO1xuICB9XG59XG5cbi8qKlxuICogQWdncmVzc2l2ZSBET00gY2xlYW51cCB0byBwcmV2ZW50IG1lbW9yeSBsZWFrc1xuICovXG5jbGFzcyBET01PcHRpbWl6ZXIge1xuICBwcml2YXRlIHN0YXRpYyBjcmVhdGVkRWxlbWVudHMgPSBuZXcgV2Vha1NldDxFbGVtZW50PigpO1xuICBwcml2YXRlIHN0YXRpYyBvcmlnaW5hbENyZWF0ZUVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50O1xuXG4gIHN0YXRpYyBvcHRpbWl6ZURPTSgpOiB2b2lkIHtcbiAgICAvLyBUcmFjayBlbGVtZW50IGNyZWF0aW9uIGZvciBjbGVhbnVwXG4gICAgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCA9IGZ1bmN0aW9uIDxLIGV4dGVuZHMga2V5b2YgSFRNTEVsZW1lbnRUYWdOYW1lTWFwPihcbiAgICAgIHRhZ05hbWU6IEssXG4gICAgICBvcHRpb25zPzogRWxlbWVudENyZWF0aW9uT3B0aW9ucyxcbiAgICApOiBIVE1MRWxlbWVudFRhZ05hbWVNYXBbS10ge1xuICAgICAgY29uc3QgZWxlbWVudCA9IERPTU9wdGltaXplci5vcmlnaW5hbENyZWF0ZUVsZW1lbnQuY2FsbChcbiAgICAgICAgdGhpcyxcbiAgICAgICAgdGFnTmFtZSxcbiAgICAgICAgb3B0aW9ucyxcbiAgICAgICk7XG4gICAgICBET01PcHRpbWl6ZXIuY3JlYXRlZEVsZW1lbnRzLmFkZChlbGVtZW50KTtcbiAgICAgIHJldHVybiBlbGVtZW50O1xuICAgIH07XG4gIH1cblxuICBzdGF0aWMgY2xlYW51cERPTSgpOiB2b2lkIHtcbiAgICAvLyBBZ2dyZXNzaXZlIERPTSBjbGVhbnVwXG4gICAgaWYgKGRvY3VtZW50LmJvZHkpIHtcbiAgICAgIGRvY3VtZW50LmJvZHkuaW5uZXJIVE1MID0gXCJcIjtcbiAgICB9XG5cbiAgICAvLyBDbGVhciBkb2N1bWVudCBoZWFkIG9mIGFueSB0ZXN0LWNyZWF0ZWQgZWxlbWVudHNcbiAgICBjb25zdCBoZWFkID0gZG9jdW1lbnQuaGVhZDtcbiAgICBpZiAoaGVhZCkge1xuICAgICAgY29uc3QgdGVzdEVsZW1lbnRzID0gaGVhZC5xdWVyeVNlbGVjdG9yQWxsKFwiW2RhdGEtdGVzdF1cIik7XG4gICAgICB0ZXN0RWxlbWVudHMuZm9yRWFjaCgoZWwpID0+IGVsLnJlbW92ZSgpKTtcbiAgICB9XG5cbiAgICAvLyBGb3JjZSBjbGVhbnVwIG9mIGRpc2Nvbm5lY3RlZCBub2Rlc1xuICAgIGlmICh0eXBlb2YgZ2xvYmFsLmdjID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGdsb2JhbC5nYygpO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAvLyBJZ25vcmUgR0MgZXJyb3JzXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgc3RhdGljIHJlc3RvcmVET00oKTogdm9pZCB7XG4gICAgZG9jdW1lbnQuY3JlYXRlRWxlbWVudCA9IHRoaXMub3JpZ2luYWxDcmVhdGVFbGVtZW50O1xuICB9XG59XG5cbi8qKlxuICogTWVtb3J5IHVzYWdlIG1vbml0b3IgZm9yIGVhcmx5IHdhcm5pbmdcbiAqL1xuY2xhc3MgTWVtb3J5TW9uaXRvciB7XG4gIHByaXZhdGUgc3RhdGljIGxhc3RNZW1vcnlDaGVjayA9IDA7XG4gIHByaXZhdGUgc3RhdGljIG1lbW9yeVRocmVzaG9sZCA9IHByb2Nlc3MuZW52LkNJXG4gICAgPyAxMDAgKiAxMDI0ICogMTAyNCAvLyAxMDBNQiBpbiBDSVxuICAgIDogNTAwICogMTAyNCAqIDEwMjQ7IC8vIDUwME1CIGxvY2FsbHlcblxuICBzdGF0aWMgY2hlY2tNZW1vcnlVc2FnZSh0ZXN0TmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKHR5cGVvZiBwcm9jZXNzLm1lbW9yeVVzYWdlID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgIGNvbnN0IHVzYWdlID0gcHJvY2Vzcy5tZW1vcnlVc2FnZSgpO1xuICAgICAgY29uc3QgaGVhcFVzZWQgPSB1c2FnZS5oZWFwVXNlZDtcblxuICAgICAgaWYgKGhlYXBVc2VkID4gdGhpcy5tZW1vcnlUaHJlc2hvbGQpIHtcbiAgICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICAgIGDimqDvuI8gIE1lbW9yeSBXYXJuaW5nOiBUZXN0IFwiJHt0ZXN0TmFtZX1cIiB1c2luZyAke01hdGgucm91bmQoaGVhcFVzZWQgLyAxMDI0IC8gMTAyNCl9TUJgLFxuICAgICAgICApO1xuXG4gICAgICAgIC8vIEZvcmNlIGdhcmJhZ2UgY29sbGVjdGlvbiBpZiBhdmFpbGFibGVcbiAgICAgICAgaWYgKHR5cGVvZiBnbG9iYWwuZ2MgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgIGdsb2JhbC5nYygpO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHRoaXMubGFzdE1lbW9yeUNoZWNrID0gaGVhcFVzZWQ7XG4gICAgfVxuICB9XG5cbiAgc3RhdGljIHN0YXJ0TW9uaXRvcmluZyh0ZXN0TmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgZ2xvYmFsLl9fUEVSRk9STUFOQ0VfTU9OSVRPUlNfXy5wdXNoKHtcbiAgICAgIG5hbWU6IHRlc3ROYW1lLFxuICAgICAgc3RhcnQ6IERhdGUubm93KCksXG4gICAgfSk7XG4gIH1cblxuICBzdGF0aWMgc3RvcE1vbml0b3JpbmcodGVzdE5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IG1vbml0b3IgPSBnbG9iYWwuX19QRVJGT1JNQU5DRV9NT05JVE9SU19fLmZpbmQoXG4gICAgICAobSkgPT4gbS5uYW1lID09PSB0ZXN0TmFtZSxcbiAgICApO1xuICAgIGlmIChtb25pdG9yKSB7XG4gICAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBtb25pdG9yLnN0YXJ0O1xuICAgICAgaWYgKGR1cmF0aW9uID4gNTAwMCkge1xuICAgICAgICAvLyBXYXJuIGFib3V0IHRlc3RzIHRha2luZyA+IDUgc2Vjb25kc1xuICAgICAgICBjb25zb2xlLndhcm4oYOKPsCBTbG93IFRlc3QgV2FybmluZzogXCIke3Rlc3ROYW1lfVwiIHRvb2sgJHtkdXJhdGlvbn1tc2ApO1xuICAgICAgfVxuXG4gICAgICAvLyBSZW1vdmUgZnJvbSBtb25pdG9yc1xuICAgICAgY29uc3QgaW5kZXggPSBnbG9iYWwuX19QRVJGT1JNQU5DRV9NT05JVE9SU19fLmluZGV4T2YobW9uaXRvcik7XG4gICAgICBpZiAoaW5kZXggPiAtMSkge1xuICAgICAgICBnbG9iYWwuX19QRVJGT1JNQU5DRV9NT05JVE9SU19fLnNwbGljZShpbmRleCwgMSk7XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogT3B0aW1pemUgSW5kZXhlZEdyYXBoIHBlcmZvcm1hbmNlIHRlc3RzIHRvIHVzZSBsZXNzIG1lbW9yeVxuICovXG5jbGFzcyBJbmRleGVkR3JhcGhPcHRpbWl6ZXIge1xuICBzdGF0aWMgb3B0aW1pemVUZXN0RGF0YSgpOiB2b2lkIHtcbiAgICAvLyBQYXRjaCBhbnkgbGFyZ2UgZGF0YSBzdHJ1Y3R1cmUgY3JlYXRpb24gaW4gSW5kZXhlZEdyYXBoIHRlc3RzXG4gICAgY29uc3Qgb3JpZ2luYWxBcnJheSA9IEFycmF5O1xuXG4gICAgKGdsb2JhbCBhcyBhbnkpLkFycmF5ID0gZnVuY3Rpb24gKC4uLmFyZ3M6IGFueVtdKSB7XG4gICAgICAvLyBMaW1pdCBhcnJheSBzaXplcyBpbiB0ZXN0cyB0byBwcmV2ZW50IG1lbW9yeSBleHBsb3Npb25cbiAgICAgIGlmIChhcmdzLmxlbmd0aCA9PT0gMSAmJiB0eXBlb2YgYXJnc1swXSA9PT0gXCJudW1iZXJcIiAmJiBhcmdzWzBdID4gMTAwMCkge1xuICAgICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgYEFycmF5IHNpemUgbGltaXRlZCBmcm9tICR7YXJnc1swXX0gdG8gMTAwMCBmb3IgbWVtb3J5IG9wdGltaXphdGlvbmAsXG4gICAgICAgICk7XG4gICAgICAgIHJldHVybiBuZXcgb3JpZ2luYWxBcnJheSgxMDAwKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBuZXcgb3JpZ2luYWxBcnJheSguLi5hcmdzKTtcbiAgICB9O1xuXG4gICAgLy8gQ29weSBzdGF0aWMgbWV0aG9kc1xuICAgIE9iamVjdC5zZXRQcm90b3R5cGVPZigoZ2xvYmFsIGFzIGFueSkuQXJyYXksIG9yaWdpbmFsQXJyYXkpO1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSgoZ2xvYmFsIGFzIGFueSkuQXJyYXksIFwiZnJvbVwiLCB7XG4gICAgICB2YWx1ZTogb3JpZ2luYWxBcnJheS5mcm9tLFxuICAgIH0pO1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSgoZ2xvYmFsIGFzIGFueSkuQXJyYXksIFwiaXNBcnJheVwiLCB7XG4gICAgICB2YWx1ZTogb3JpZ2luYWxBcnJheS5pc0FycmF5LFxuICAgIH0pO1xuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSgoZ2xvYmFsIGFzIGFueSkuQXJyYXksIFwib2ZcIiwge1xuICAgICAgdmFsdWU6IG9yaWdpbmFsQXJyYXkub2YsXG4gICAgfSk7XG4gIH1cblxuICBzdGF0aWMgcmVzdG9yZVRlc3REYXRhKCk6IHZvaWQge1xuICAgIChnbG9iYWwgYXMgYW55KS5BcnJheSA9IEFycmF5O1xuICB9XG59XG5cbi8vIEFwcGx5IG9wdGltaXphdGlvbnMgZHVyaW5nIHNldHVwXG5iZWZvcmVBbGwoKCkgPT4ge1xuICBpZiAocHJvY2Vzcy5lbnYuQ0kgfHwgcHJvY2Vzcy5lbnYuTUVNT1JZX09QVElNSVpBVElPTikge1xuICAgIGNvbnNvbGUubG9nKFwi8J+agCBBcHBseWluZyBtZW1vcnkgb3B0aW1pemF0aW9ucyBmb3IgQ0kvQ0QuLi5cIik7XG5cbiAgICAvLyBBcHBseSBhbGwgb3B0aW1pemF0aW9uc1xuICAgIFBlcmZvcm1hbmNlVGVzdE9wdGltaXplci5vcHRpbWl6ZVBlcmZvcm1hbmNlTm93KCk7XG4gICAgRE9NT3B0aW1pemVyLm9wdGltaXplRE9NKCk7XG4gICAgSW5kZXhlZEdyYXBoT3B0aW1pemVyLm9wdGltaXplVGVzdERhdGEoKTtcblxuICAgIC8vIFNldCBtb3JlIGFnZ3Jlc3NpdmUgdGltZW91dHMgZm9yIENJXG4gICAgamVzdC5zZXRUaW1lb3V0KHByb2Nlc3MuZW52LkNJID8gMzAwMDAgOiAxMDAwMCk7XG4gIH1cbn0pO1xuXG4vLyBNb25pdG9yIG1lbW9yeSBiZWZvcmUgZWFjaCB0ZXN0XG5iZWZvcmVFYWNoKCgpID0+IHtcbiAgY29uc3QgdGVzdE5hbWUgPSBleHBlY3QuZ2V0U3RhdGUoKT8uY3VycmVudFRlc3ROYW1lIHx8IFwidW5rbm93blwiO1xuICBNZW1vcnlNb25pdG9yLnN0YXJ0TW9uaXRvcmluZyh0ZXN0TmFtZSk7XG4gIE1lbW9yeU1vbml0b3IuY2hlY2tNZW1vcnlVc2FnZSh0ZXN0TmFtZSk7XG5cbiAgLy8gQ2xlYXIgbW9jayBpbnN0YW5jZXMgYmVmb3JlIGVhY2ggdGVzdFxuICBPcHRpbWl6ZWRNb2NrRmFjdG9yeS5jbGVhcigpO1xufSk7XG5cbi8vIEFnZ3Jlc3NpdmUgY2xlYW51cCBhZnRlciBlYWNoIHRlc3RcbmFmdGVyRWFjaCgoKSA9PiB7XG4gIGNvbnN0IHRlc3ROYW1lID0gZXhwZWN0LmdldFN0YXRlKCk/LmN1cnJlbnRUZXN0TmFtZSB8fCBcInVua25vd25cIjtcblxuICAvLyBTdG9wIG1vbml0b3JpbmdcbiAgTWVtb3J5TW9uaXRvci5zdG9wTW9uaXRvcmluZyh0ZXN0TmFtZSk7XG5cbiAgLy8gQWdncmVzc2l2ZSBjbGVhbnVwXG4gIERPTU9wdGltaXplci5jbGVhbnVwRE9NKCk7XG4gIE9wdGltaXplZE1vY2tGYWN0b3J5LmNsZWFyKCk7XG5cbiAgLy8gQ2xlYXIgSmVzdCBtb2NrcyBhZ2dyZXNzaXZlbHlcbiAgamVzdC5jbGVhckFsbE1vY2tzKCk7XG4gIGplc3QuY2xlYXJBbGxUaW1lcnMoKTtcbiAgamVzdC5yZXN0b3JlQWxsTW9ja3MoKTtcblxuICAvLyBGb3JjZSBnYXJiYWdlIGNvbGxlY3Rpb24gaW4gQ0lcbiAgaWYgKHByb2Nlc3MuZW52LkNJICYmIHR5cGVvZiBnbG9iYWwuZ2MgPT09IFwiZnVuY3Rpb25cIikge1xuICAgIGdsb2JhbC5nYygpO1xuICB9XG5cbiAgLy8gRmluYWwgbWVtb3J5IGNoZWNrXG4gIE1lbW9yeU1vbml0b3IuY2hlY2tNZW1vcnlVc2FnZShgJHt0ZXN0TmFtZX0tY2xlYW51cGApO1xufSk7XG5cbi8vIFJlc3RvcmUgb3B0aW1pemF0aW9ucyBhZnRlciBhbGwgdGVzdHNcbmFmdGVyQWxsKCgpID0+IHtcbiAgaWYgKHByb2Nlc3MuZW52LkNJIHx8IHByb2Nlc3MuZW52Lk1FTU9SWV9PUFRJTUlaQVRJT04pIHtcbiAgICBjb25zb2xlLmxvZyhcIvCfp7kgUmVzdG9yaW5nIG9yaWdpbmFsIGltcGxlbWVudGF0aW9ucy4uLlwiKTtcblxuICAgIFBlcmZvcm1hbmNlVGVzdE9wdGltaXplci5yZXN0b3JlUGVyZm9ybWFuY2VOb3coKTtcbiAgICBET01PcHRpbWl6ZXIucmVzdG9yZURPTSgpO1xuICAgIEluZGV4ZWRHcmFwaE9wdGltaXplci5yZXN0b3JlVGVzdERhdGEoKTtcblxuICAgIC8vIEZpbmFsIGNsZWFudXBcbiAgICBPcHRpbWl6ZWRNb2NrRmFjdG9yeS5jbGVhcigpO1xuXG4gICAgaWYgKHR5cGVvZiBnbG9iYWwuZ2MgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgZ2xvYmFsLmdjKCk7XG4gICAgfVxuICB9XG59KTtcblxuLy8gRXhwb3J0IHV0aWxpdGllcyBmb3IgdXNlIGluIHRlc3RzXG5leHBvcnQge1xuICBPcHRpbWl6ZWRNb2NrRmFjdG9yeSxcbiAgUGVyZm9ybWFuY2VUZXN0T3B0aW1pemVyLFxuICBET01PcHRpbWl6ZXIsXG4gIE1lbW9yeU1vbml0b3IsXG4gIEluZGV4ZWRHcmFwaE9wdGltaXplcixcbn07XG4iXSwidmVyc2lvbiI6M30=