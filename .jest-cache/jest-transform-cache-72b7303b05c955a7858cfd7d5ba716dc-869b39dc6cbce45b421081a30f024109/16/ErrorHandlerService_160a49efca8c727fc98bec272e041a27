917b712ff546db75775937fdb8abfdd3
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ErrorHandlerService = void 0;
const ExocortexError_1 = require("../../domain/errors/ExocortexError");
const ErrorAnalyzer_1 = require("../../domain/errors/ErrorAnalyzer");
const EnhancedResult_1 = require("../../domain/core/EnhancedResult");
class ErrorHandlerService {
    constructor(options = {}, notificationService) {
        this.options = options;
        this.notificationService = notificationService;
        this.errorHistory = [];
        this.errorMetrics = {
            totalErrors: 0,
            errorsBySeverity: {
                [ExocortexError_1.ErrorSeverity.CRITICAL]: 0,
                [ExocortexError_1.ErrorSeverity.ERROR]: 0,
                [ExocortexError_1.ErrorSeverity.WARNING]: 0,
                [ExocortexError_1.ErrorSeverity.INFO]: 0,
            },
            errorsByCategory: {
                [ExocortexError_1.ErrorCategory.SYNTAX]: 0,
                [ExocortexError_1.ErrorCategory.SEMANTIC]: 0,
                [ExocortexError_1.ErrorCategory.VALIDATION]: 0,
                [ExocortexError_1.ErrorCategory.SYSTEM]: 0,
                [ExocortexError_1.ErrorCategory.NETWORK]: 0,
                [ExocortexError_1.ErrorCategory.PERMISSION]: 0,
            },
            averageResolutionTime: 0,
        };
        this.resolutionTimes = [];
        this.maxHistorySize = 100;
        this.errorStartTimes = new Map();
        this.options = {
            showUserNotification: true,
            logToConsole: true,
            trackMetrics: true,
            autoRecover: false,
            ...options,
        };
    }
    async handleError(error, context) {
        const startTime = Date.now();
        try {
            let exoError;
            if (typeof error === "string") {
                exoError = ErrorAnalyzer_1.ErrorAnalyzer.analyze(error);
            }
            else if (error instanceof Error) {
                exoError = ErrorAnalyzer_1.ErrorAnalyzer.analyze(error);
            }
            else {
                exoError = error;
            }
            if (context) {
                exoError = {
                    ...exoError,
                    context: {
                        ...exoError.context,
                        ...context,
                    },
                };
            }
            this.errorStartTimes.set(exoError.id, startTime);
            if (this.options.trackMetrics) {
                this.updateMetrics(exoError);
            }
            if (this.options.logToConsole) {
                this.logError(exoError);
            }
            if (this.options.showUserNotification) {
                this.showUserNotification(exoError);
            }
            this.addToHistory(exoError);
            if (this.options.autoRecover && exoError.recoverable) {
                await this.attemptRecovery(exoError);
            }
            return EnhancedResult_1.EnhancedResult.okEnhanced();
        }
        catch (handlingError) {
            console.error("Error in error handler:", handlingError);
            return EnhancedResult_1.EnhancedResult.failEnhanced(ExocortexError_1.ErrorBuilder.create()
                .withTitle("Error Handler Failed")
                .withMessage("Failed to handle the error properly")
                .withSeverity(ExocortexError_1.ErrorSeverity.CRITICAL)
                .withCategory(ExocortexError_1.ErrorCategory.SYSTEM)
                .withContext({
                operation: "Error Handling",
                timestamp: new Date(),
            })
                .withTechnicalDetails(handlingError instanceof Error
                ? handlingError.message
                : String(handlingError))
                .build());
        }
    }
    markErrorResolved(errorId) {
        const startTime = this.errorStartTimes.get(errorId);
        if (startTime) {
            const resolutionTime = Date.now() - startTime;
            this.resolutionTimes.push(resolutionTime);
            if (this.resolutionTimes.length > 100) {
                this.resolutionTimes.shift();
            }
            this.errorMetrics.averageResolutionTime =
                this.resolutionTimes.reduce((a, b) => a + b, 0) /
                    this.resolutionTimes.length;
            this.errorStartTimes.delete(errorId);
        }
    }
    updateMetrics(error) {
        this.errorMetrics.totalErrors++;
        this.errorMetrics.errorsBySeverity[error.severity]++;
        this.errorMetrics.errorsByCategory[error.category]++;
        this.errorMetrics.lastError = error;
    }
    logError(error) {
        const logLevel = this.getLogLevel(error.severity);
        const logMessage = this.formatErrorForConsole(error);
        switch (logLevel) {
            case "error":
                console.error(logMessage, error);
                break;
            case "warn":
                console.warn(logMessage, error);
                break;
            case "info":
                console.info(logMessage, error);
                break;
            default:
                console.log(logMessage, error);
        }
    }
    getLogLevel(severity) {
        switch (severity) {
            case ExocortexError_1.ErrorSeverity.CRITICAL:
            case ExocortexError_1.ErrorSeverity.ERROR:
                return "error";
            case ExocortexError_1.ErrorSeverity.WARNING:
                return "warn";
            case ExocortexError_1.ErrorSeverity.INFO:
                return "info";
            default:
                return "log";
        }
    }
    formatErrorForConsole(error) {
        const parts = [
            `[${error.severity.toUpperCase()}]`,
            `[${error.category}]`,
            error.title,
            "-",
            error.message,
        ];
        if (error.context.location) {
            if (typeof error.context.location === "object" &&
                "line" in error.context.location) {
                parts.push(`(Line ${error.context.location.line}:${error.context.location.column})`);
            }
        }
        return parts.join(" ");
    }
    showUserNotification(error) {
        const duration = this.getNotificationDuration(error.severity);
        const message = this.formatErrorForUser(error);
        this.notificationService?.showError(message, duration);
    }
    getNotificationDuration(severity) {
        switch (severity) {
            case ExocortexError_1.ErrorSeverity.CRITICAL:
                return 10000;
            case ExocortexError_1.ErrorSeverity.ERROR:
                return 7000;
            case ExocortexError_1.ErrorSeverity.WARNING:
                return 5000;
            case ExocortexError_1.ErrorSeverity.INFO:
                return 3000;
            default:
                return 5000;
        }
    }
    formatErrorForUser(error) {
        let message = `${error.title}: ${error.message}`;
        if (error.suggestions && error.suggestions.length > 0) {
            const topSuggestion = error.suggestions[0];
            message += `\n\nðŸ’¡ ${topSuggestion.title}`;
        }
        return message;
    }
    addToHistory(error) {
        this.errorHistory.unshift(error);
        if (this.errorHistory.length > this.maxHistorySize) {
            this.errorHistory.pop();
        }
    }
    async attemptRecovery(error) {
        if (!error.suggestions || error.suggestions.length === 0) {
            return;
        }
        const autoFixSuggestion = error.suggestions.find((s) => s.confidence && s.confidence > 0.9 && s.action);
        if (autoFixSuggestion && autoFixSuggestion.action) {
            try {
                await autoFixSuggestion.action.handler();
                this.notificationService?.showSuccess(`Auto-recovery: ${autoFixSuggestion.title}`, 3000);
            }
            catch (recoveryError) {
                console.error("Auto-recovery failed:", recoveryError);
            }
        }
    }
    getMetrics() {
        return { ...this.errorMetrics };
    }
    getErrorHistory() {
        return [...this.errorHistory];
    }
    clearHistory() {
        this.errorHistory = [];
        this.errorStartTimes.clear();
    }
    getSuggestions(error) {
        const exoError = ErrorAnalyzer_1.ErrorAnalyzer.analyze(error);
        return exoError.suggestions || [];
    }
    analyzeError(error) {
        return ErrorAnalyzer_1.ErrorAnalyzer.analyze(error);
    }
}
exports.ErrorHandlerService = ErrorHandlerService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2FwcGxpY2F0aW9uL3NlcnZpY2VzL0Vycm9ySGFuZGxlclNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQUEsdUVBTTRDO0FBQzVDLHFFQUFrRTtBQUNsRSxxRUFBa0U7QUFrQmxFLE1BQWEsbUJBQW1CO0lBd0I5QixZQUNVLFVBQStCLEVBQUUsRUFDakMsbUJBQTBDO1FBRDFDLFlBQU8sR0FBUCxPQUFPLENBQTBCO1FBQ2pDLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBdUI7UUF6QjVDLGlCQUFZLEdBQXFCLEVBQUUsQ0FBQztRQUNwQyxpQkFBWSxHQUFpQjtZQUNuQyxXQUFXLEVBQUUsQ0FBQztZQUNkLGdCQUFnQixFQUFFO2dCQUNoQixDQUFDLDhCQUFhLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQztnQkFDM0IsQ0FBQyw4QkFBYSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQ3hCLENBQUMsOEJBQWEsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO2dCQUMxQixDQUFDLDhCQUFhLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQzthQUN4QjtZQUNELGdCQUFnQixFQUFFO2dCQUNoQixDQUFDLDhCQUFhLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztnQkFDekIsQ0FBQyw4QkFBYSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUM7Z0JBQzNCLENBQUMsOEJBQWEsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO2dCQUM3QixDQUFDLDhCQUFhLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztnQkFDekIsQ0FBQyw4QkFBYSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7Z0JBQzFCLENBQUMsOEJBQWEsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO2FBQzlCO1lBQ0QscUJBQXFCLEVBQUUsQ0FBQztTQUN6QixDQUFDO1FBQ00sb0JBQWUsR0FBYSxFQUFFLENBQUM7UUFDL0IsbUJBQWMsR0FBRyxHQUFH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LENBQUMsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVELFlBQVk7UUFDVixJQUFJLENBQUMsWUFBWSxHQUFHLEVBQUUsQ0FBQztRQUN2QixJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQy9CLENBQUM7SUFFRCxjQUFjLENBQUMsS0FBcUI7UUFDbEMsTUFBTSxRQUFRLEdBQUcsNkJBQWEsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDOUMsT0FBTyxRQUFRLENBQUMsV0FBVyxJQUFJLEVBQUUsQ0FBQztJQUNwQyxDQUFDO0lBRUQsWUFBWSxDQUFDLEtBQXFCO1FBQ2hDLE9BQU8sNkJBQWEsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDdEMsQ0FBQztDQUNGO0FBbFJELGtEQWtSQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva2l0ZWxldi9Eb2N1bWVudHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi9zcmMvYXBwbGljYXRpb24vc2VydmljZXMvRXJyb3JIYW5kbGVyU2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBFeG9jb3J0ZXhFcnJvcixcbiAgRXJyb3JTZXZlcml0eSxcbiAgRXJyb3JDYXRlZ29yeSxcbiAgRml4U3VnZ2VzdGlvbixcbiAgRXJyb3JCdWlsZGVyLFxufSBmcm9tIFwiLi4vLi4vZG9tYWluL2Vycm9ycy9FeG9jb3J0ZXhFcnJvclwiO1xuaW1wb3J0IHsgRXJyb3JBbmFseXplciB9IGZyb20gXCIuLi8uLi9kb21haW4vZXJyb3JzL0Vycm9yQW5hbHl6ZXJcIjtcbmltcG9ydCB7IEVuaGFuY2VkUmVzdWx0IH0gZnJvbSBcIi4uLy4uL2RvbWFpbi9jb3JlL0VuaGFuY2VkUmVzdWx0XCI7XG5pbXBvcnQgeyBJTm90aWZpY2F0aW9uU2VydmljZSB9IGZyb20gXCIuLi9wb3J0cy9JTm90aWZpY2F0aW9uU2VydmljZVwiO1xuXG5leHBvcnQgaW50ZXJmYWNlIEVycm9ySGFuZGxlck9wdGlvbnMge1xuICBzaG93VXNlck5vdGlmaWNhdGlvbj86IGJvb2xlYW47XG4gIGxvZ1RvQ29uc29sZT86IGJvb2xlYW47XG4gIHRyYWNrTWV0cmljcz86IGJvb2xlYW47XG4gIGF1dG9SZWNvdmVyPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBFcnJvck1ldHJpY3Mge1xuICB0b3RhbEVycm9yczogbnVtYmVyO1xuICBlcnJvcnNCeVNldmVyaXR5OiBSZWNvcmQ8RXJyb3JTZXZlcml0eSwgbnVtYmVyPjtcbiAgZXJyb3JzQnlDYXRlZ29yeTogUmVjb3JkPEVycm9yQ2F0ZWdvcnksIG51bWJlcj47XG4gIGF2ZXJhZ2VSZXNvbHV0aW9uVGltZTogbnVtYmVyO1xuICBsYXN0RXJyb3I/OiBFeG9jb3J0ZXhFcnJvcjtcbn1cblxuZXhwb3J0IGNsYXNzIEVycm9ySGFuZGxlclNlcnZpY2Uge1xuICBwcml2YXRlIGVycm9ySGlzdG9yeTogRXhvY29ydGV4RXJyb3JbXSA9IFtdO1xuICBwcml2YXRlIGVycm9yTWV0cmljczogRXJyb3JNZXRyaWNzID0ge1xuICAgIHRvdGFsRXJyb3JzOiAwLFxuICAgIGVycm9yc0J5U2V2ZXJpdHk6IHtcbiAgICAgIFtFcnJvclNldmVyaXR5LkNSSVRJQ0FMXTogMCxcbiAgICAgIFtFcnJvclNldmVyaXR5LkVSUk9SXTogMCxcbiAgICAgIFtFcnJvclNldmVyaXR5LldBUk5JTkddOiAwLFxuICAgICAgW0Vycm9yU2V2ZXJpdHkuSU5GT106IDAsXG4gICAgfSxcbiAgICBlcnJvcnNCeUNhdGVnb3J5OiB7XG4gICAgICBbRXJyb3JDYXRlZ29yeS5TWU5UQVhdOiAwLFxuICAgICAgW0Vycm9yQ2F0ZWdvcnkuU0VNQU5USUNdOiAwLFxuICAgICAgW0Vycm9yQ2F0ZWdvcnkuVkFMSURBVElPTl06IDAsXG4gICAgICBbRXJyb3JDYXRlZ29yeS5TWVNURU1dOiAwLFxuICAgICAgW0Vycm9yQ2F0ZWdvcnkuTkVUV09SS106IDAsXG4gICAgICBbRXJyb3JDYXRlZ29yeS5QRVJNSVNTSU9OXTogMCxcbiAgICB9LFxuICAgIGF2ZXJhZ2VSZXNvbHV0aW9uVGltZTogMCxcbiAgfTtcbiAgcHJpdmF0ZSByZXNvbHV0aW9uVGltZXM6IG51bWJlcltdID0gW107XG4gIHByaXZhdGUgbWF4SGlzdG9yeVNpemUgPSAxMDA7XG4gIHByaXZhdGUgZXJyb3JTdGFydFRpbWVzID0gbmV3IE1hcDxzdHJpbmcsIG51bWJlcj4oKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIG9wdGlvbnM6IEVycm9ySGFuZGxlck9wdGlvbnMgPSB7fSxcbiAgICBwcml2YXRlIG5vdGlmaWNhdGlvblNlcnZpY2U/OiBJTm90aWZpY2F0aW9uU2VydmljZSxcbiAgKSB7XG4gICAgdGhpcy5vcHRpb25zID0ge1xuICAgICAgc2hvd1VzZXJOb3RpZmljYXRpb246IHRydWUsXG4gICAgICBsb2dUb0NvbnNvbGU6IHRydWUsXG4gICAgICB0cmFja01ldHJpY3M6IHRydWUsXG4gICAgICBhdXRvUmVjb3ZlcjogZmFsc2UsXG4gICAgICAuLi5vcHRpb25zLFxuICAgIH07XG4gIH1cblxuICBhc3luYyBoYW5kbGVFcnJvcihcbiAgICBlcnJvcjogRXJyb3IgfCBFeG9jb3J0ZXhFcnJvciB8IHN0cmluZyxcbiAgICBjb250ZXh0PzogUGFydGlhbDxFeG9jb3J0ZXhFcnJvcltcImNvbnRleHRcIl0+LFxuICApOiBQcm9taXNlPEVuaGFuY2VkUmVzdWx0PHZvaWQ+PiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcblxuICAgIHRyeSB7XG4gICAgICBsZXQgZXhvRXJyb3I6IEV4b2NvcnRleEVycm9yO1xuXG4gICAgICBpZiAodHlwZW9mIGVycm9yID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgIGV4b0Vycm9yID0gRXJyb3JBbmFseXplci5hbmFseXplKGVycm9yKTtcbiAgICAgIH0gZWxzZSBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgICAgICBleG9FcnJvciA9IEVycm9yQW5hbHl6ZXIuYW5hbHl6ZShlcnJvcik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBleG9FcnJvciA9IGVycm9yO1xuICAgICAgfVxuXG4gICAgICBpZiAoY29udGV4dCkge1xuICAgICAgICBleG9FcnJvciA9IHtcbiAgICAgICAgICAuLi5leG9FcnJvcixcbiAgICAgICAgICBjb250ZXh0OiB7XG4gICAgICAgICAgICAuLi5leG9FcnJvci5jb250ZXh0LFxuICAgICAgICAgICAgLi4uY29udGV4dCxcbiAgICAgICAgICB9LFxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICB0aGlzLmVycm9yU3RhcnRUaW1lcy5zZXQoZXhvRXJyb3IuaWQsIHN0YXJ0VGltZSk7XG5cbiAgICAgIGlmICh0aGlzLm9wdGlvbnMudHJhY2tNZXRyaWNzKSB7XG4gICAgICAgIHRoaXMudXBkYXRlTWV0cmljcyhleG9FcnJvcik7XG4gICAgICB9XG5cbiAgICAgIGlmICh0aGlzLm9wdGlvbnMubG9nVG9Db25zb2xlKSB7XG4gICAgICAgIHRoaXMubG9nRXJyb3IoZXhvRXJyb3IpO1xuICAgICAgfVxuXG4gICAgICBpZiAodGhpcy5vcHRpb25zLnNob3dVc2VyTm90aWZpY2F0aW9uKSB7XG4gICAgICAgIHRoaXMuc2hvd1VzZXJOb3RpZmljYXRpb24oZXhvRXJyb3IpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLmFkZFRvSGlzdG9yeShleG9FcnJvcik7XG5cbiAgICAgIGlmICh0aGlzLm9wdGlvbnMuYXV0b1JlY292ZXIgJiYgZXhvRXJyb3IucmVjb3ZlcmFibGUpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5hdHRlbXB0UmVjb3ZlcnkoZXhvRXJyb3IpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gRW5oYW5jZWRSZXN1bHQub2tFbmhhbmNlZCgpO1xuICAgIH0gY2F0Y2ggKGhhbmRsaW5nRXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBpbiBlcnJvciBoYW5kbGVyOlwiLCBoYW5kbGluZ0Vycm9yKTtcbiAgICAgIHJldHVybiBFbmhhbmNlZFJlc3VsdC5mYWlsRW5oYW5jZWQoXG4gICAgICAgIEVycm9yQnVpbGRlci5jcmVhdGUoKVxuICAgICAgICAgIC53aXRoVGl0bGUoXCJFcnJvciBIYW5kbGVyIEZhaWxlZFwiKVxuICAgICAgICAgIC53aXRoTWVzc2FnZShcIkZhaWxlZCB0byBoYW5kbGUgdGhlIGVycm9yIHByb3Blcmx5XCIpXG4gICAgICAgICAgLndpdGhTZXZlcml0eShFcnJvclNldmVyaXR5LkNSSVRJQ0FMKVxuICAgICAgICAgIC53aXRoQ2F0ZWdvcnkoRXJyb3JDYXRlZ29yeS5TWVNURU0pXG4gICAgICAgICAgLndpdGhDb250ZXh0KHtcbiAgICAgICAgICAgIG9wZXJhdGlvbjogXCJFcnJvciBIYW5kbGluZ1wiLFxuICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgIH0pXG4gICAgICAgICAgLndpdGhUZWNobmljYWxEZXRhaWxzKFxuICAgICAgICAgICAgaGFuZGxpbmdFcnJvciBpbnN0YW5jZW9mIEVycm9yXG4gICAgICAgICAgICAgID8gaGFuZGxpbmdFcnJvci5tZXNzYWdlXG4gICAgICAgICAgICAgIDogU3RyaW5nKGhhbmRsaW5nRXJyb3IpLFxuICAgICAgICAgIClcbiAgICAgICAgICAuYnVpbGQoKSxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgbWFya0Vycm9yUmVzb2x2ZWQoZXJyb3JJZDogc3RyaW5nKTogdm9pZCB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gdGhpcy5lcnJvclN0YXJ0VGltZXMuZ2V0KGVycm9ySWQpO1xuICAgIGlmIChzdGFydFRpbWUpIHtcbiAgICAgIGNvbnN0IHJlc29sdXRpb25UaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICAgIHRoaXMucmVzb2x1dGlvblRpbWVzLnB1c2gocmVzb2x1dGlvblRpbWUpO1xuXG4gICAgICBpZiAodGhpcy5yZXNvbHV0aW9uVGltZXMubGVuZ3RoID4gMTAwKSB7XG4gICAgICAgIHRoaXMucmVzb2x1dGlvblRpbWVzLnNoaWZ0KCk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuZXJyb3JNZXRyaWNzLmF2ZXJhZ2VSZXNvbHV0aW9uVGltZSA9XG4gICAgICAgIHRoaXMucmVzb2x1dGlvblRpbWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC9cbiAgICAgICAgdGhpcy5yZXNvbHV0aW9uVGltZXMubGVuZ3RoO1xuXG4gICAgICB0aGlzLmVycm9yU3RhcnRUaW1lcy5kZWxldGUoZXJyb3JJZCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVNZXRyaWNzKGVycm9yOiBFeG9jb3J0ZXhFcnJvcik6IHZvaWQge1xuICAgIHRoaXMuZXJyb3JNZXRyaWNzLnRvdGFsRXJyb3JzKys7XG4gICAgdGhpcy5lcnJvck1ldHJpY3MuZXJyb3JzQnlTZXZlcml0eVtlcnJvci5zZXZlcml0eV0rKztcbiAgICB0aGlzLmVycm9yTWV0cmljcy5lcnJvcnNCeUNhdGVnb3J5W2Vycm9yLmNhdGVnb3J5XSsrO1xuICAgIHRoaXMuZXJyb3JNZXRyaWNzLmxhc3RFcnJvciA9IGVycm9yO1xuICB9XG5cbiAgcHJpdmF0ZSBsb2dFcnJvcihlcnJvcjogRXhvY29ydGV4RXJyb3IpOiB2b2lkIHtcbiAgICBjb25zdCBsb2dMZXZlbCA9IHRoaXMuZ2V0TG9nTGV2ZWwoZXJyb3Iuc2V2ZXJpdHkpO1xuICAgIGNvbnN0IGxvZ01lc3NhZ2UgPSB0aGlzLmZvcm1hdEVycm9yRm9yQ29uc29sZShlcnJvcik7XG5cbiAgICBzd2l0Y2ggKGxvZ0xldmVsKSB7XG4gICAgICBjYXNlIFwiZXJyb3JcIjpcbiAgICAgICAgY29uc29sZS5lcnJvcihsb2dNZXNzYWdlLCBlcnJvcik7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBcIndhcm5cIjpcbiAgICAgICAgY29uc29sZS53YXJuKGxvZ01lc3NhZ2UsIGVycm9yKTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwiaW5mb1wiOlxuICAgICAgICBjb25zb2xlLmluZm8obG9nTWVzc2FnZSwgZXJyb3IpO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIGNvbnNvbGUubG9nKGxvZ01lc3NhZ2UsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldExvZ0xldmVsKFxuICAgIHNldmVyaXR5OiBFcnJvclNldmVyaXR5LFxuICApOiBcImVycm9yXCIgfCBcIndhcm5cIiB8IFwiaW5mb1wiIHwgXCJsb2dcIiB7XG4gICAgc3dpdGNoIChzZXZlcml0eSkge1xuICAgICAgY2FzZSBFcnJvclNldmVyaXR5LkNSSVRJQ0FMOlxuICAgICAgY2FzZSBFcnJvclNldmVyaXR5LkVSUk9SOlxuICAgICAgICByZXR1cm4gXCJlcnJvclwiO1xuICAgICAgY2FzZSBFcnJvclNldmVyaXR5LldBUk5JTkc6XG4gICAgICAgIHJldHVybiBcIndhcm5cIjtcbiAgICAgIGNhc2UgRXJyb3JTZXZlcml0eS5JTkZPOlxuICAgICAgICByZXR1cm4gXCJpbmZvXCI7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gXCJsb2dcIjtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGZvcm1hdEVycm9yRm9yQ29uc29sZShlcnJvcjogRXhvY29ydGV4RXJyb3IpOiBzdHJpbmcge1xuICAgIGNvbnN0IHBhcnRzID0gW1xuICAgICAgYFske2Vycm9yLnNldmVyaXR5LnRvVXBwZXJDYXNlKCl9XWAsXG4gICAgICBgWyR7ZXJyb3IuY2F0ZWdvcnl9XWAsXG4gICAgICBlcnJvci50aXRsZSxcbiAgICAgIFwiLVwiLFxuICAgICAgZXJyb3IubWVzc2FnZSxcbiAgICBdO1xuXG4gICAgaWYgKGVycm9yLmNvbnRleHQubG9jYXRpb24pIHtcbiAgICAgIGlmIChcbiAgICAgICAgdHlwZW9mIGVycm9yLmNvbnRleHQubG9jYXRpb24gPT09IFwib2JqZWN0XCIgJiZcbiAgICAgICAgXCJsaW5lXCIgaW4gZXJyb3IuY29udGV4dC5sb2NhdGlvblxuICAgICAgKSB7XG4gICAgICAgIHBhcnRzLnB1c2goXG4gICAgICAgICAgYChMaW5lICR7ZXJyb3IuY29udGV4dC5sb2NhdGlvbi5saW5lfToke2Vycm9yLmNvbnRleHQubG9jYXRpb24uY29sdW1ufSlgLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBwYXJ0cy5qb2luKFwiIFwiKTtcbiAgfVxuXG4gIHByaXZhdGUgc2hvd1VzZXJOb3RpZmljYXRpb24oZXJyb3I6IEV4b2NvcnRleEVycm9yKTogdm9pZCB7XG4gICAgY29uc3QgZHVyYXRpb24gPSB0aGlzLmdldE5vdGlmaWNhdGlvbkR1cmF0aW9uKGVycm9yLnNldmVyaXR5KTtcbiAgICBjb25zdCBtZXNzYWdlID0gdGhpcy5mb3JtYXRFcnJvckZvclVzZXIoZXJyb3IpO1xuXG4gICAgdGhpcy5ub3RpZmljYXRpb25TZXJ2aWNlPy5zaG93RXJyb3IobWVzc2FnZSwgZHVyYXRpb24pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXROb3RpZmljYXRpb25EdXJhdGlvbihzZXZlcml0eTogRXJyb3JTZXZlcml0eSk6IG51bWJlciB7XG4gICAgc3dpdGNoIChzZXZlcml0eSkge1xuICAgICAgY2FzZSBFcnJvclNldmVyaXR5LkNSSVRJQ0FMOlxuICAgICAgICByZXR1cm4gMTAwMDA7XG4gICAgICBjYXNlIEVycm9yU2V2ZXJpdHkuRVJST1I6XG4gICAgICAgIHJldHVybiA3MDAwO1xuICAgICAgY2FzZSBFcnJvclNldmVyaXR5LldBUk5JTkc6XG4gICAgICAgIHJldHVybiA1MDAwO1xuICAgICAgY2FzZSBFcnJvclNldmVyaXR5LklORk86XG4gICAgICAgIHJldHVybiAzMDAwO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIDUwMDA7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBmb3JtYXRFcnJvckZvclVzZXIoZXJyb3I6IEV4b2NvcnRleEVycm9yKTogc3RyaW5nIHtcbiAgICBsZXQgbWVzc2FnZSA9IGAke2Vycm9yLnRpdGxlfTogJHtlcnJvci5tZXNzYWdlfWA7XG5cbiAgICBpZiAoZXJyb3Iuc3VnZ2VzdGlvbnMgJiYgZXJyb3Iuc3VnZ2VzdGlvbnMubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgdG9wU3VnZ2VzdGlvbiA9IGVycm9yLnN1Z2dlc3Rpb25zWzBdO1xuICAgICAgbWVzc2FnZSArPSBgXFxuXFxu8J+SoSAke3RvcFN1Z2dlc3Rpb24udGl0bGV9YDtcbiAgICB9XG5cbiAgICByZXR1cm4gbWVzc2FnZTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkVG9IaXN0b3J5KGVycm9yOiBFeG9jb3J0ZXhFcnJvcik6IHZvaWQge1xuICAgIHRoaXMuZXJyb3JIaXN0b3J5LnVuc2hpZnQoZXJyb3IpO1xuXG4gICAgaWYgKHRoaXMuZXJyb3JIaXN0b3J5Lmxlbmd0aCA+IHRoaXMubWF4SGlzdG9yeVNpemUpIHtcbiAgICAgIHRoaXMuZXJyb3JIaXN0b3J5LnBvcCgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgYXR0ZW1wdFJlY292ZXJ5KGVycm9yOiBFeG9jb3J0ZXhFcnJvcik6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghZXJyb3Iuc3VnZ2VzdGlvbnMgfHwgZXJyb3Iuc3VnZ2VzdGlvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgYXV0b0ZpeFN1Z2dlc3Rpb24gPSBlcnJvci5zdWdnZXN0aW9ucy5maW5kKFxuICAgICAgKHMpID0+IHMuY29uZmlkZW5jZSAmJiBzLmNvbmZpZGVuY2UgPiAwLjkgJiYgcy5hY3Rpb24sXG4gICAgKTtcblxuICAgIGlmIChhdXRvRml4U3VnZ2VzdGlvbiAmJiBhdXRvRml4U3VnZ2VzdGlvbi5hY3Rpb24pIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IGF1dG9GaXhTdWdnZXN0aW9uLmFjdGlvbi5oYW5kbGVyKCk7XG4gICAgICAgIHRoaXMubm90aWZpY2F0aW9uU2VydmljZT8uc2hvd1N1Y2Nlc3MoXG4gICAgICAgICAgYEF1dG8tcmVjb3Zlcnk6ICR7YXV0b0ZpeFN1Z2dlc3Rpb24udGl0bGV9YCxcbiAgICAgICAgICAzMDAwLFxuICAgICAgICApO1xuICAgICAgfSBjYXRjaCAocmVjb3ZlcnlFcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiQXV0by1yZWNvdmVyeSBmYWlsZWQ6XCIsIHJlY292ZXJ5RXJyb3IpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGdldE1ldHJpY3MoKTogRXJyb3JNZXRyaWNzIHtcbiAgICByZXR1cm4geyAuLi50aGlzLmVycm9yTWV0cmljcyB9O1xuICB9XG5cbiAgZ2V0RXJyb3JIaXN0b3J5KCk6IEV4b2NvcnRleEVycm9yW10ge1xuICAgIHJldHVybiBbLi4udGhpcy5lcnJvckhpc3RvcnldO1xuICB9XG5cbiAgY2xlYXJIaXN0b3J5KCk6IHZvaWQge1xuICAgIHRoaXMuZXJyb3JIaXN0b3J5ID0gW107XG4gICAgdGhpcy5lcnJvclN0YXJ0VGltZXMuY2xlYXIoKTtcbiAgfVxuXG4gIGdldFN1Z2dlc3Rpb25zKGVycm9yOiBFcnJvciB8IHN0cmluZyk6IEZpeFN1Z2dlc3Rpb25bXSB7XG4gICAgY29uc3QgZXhvRXJyb3IgPSBFcnJvckFuYWx5emVyLmFuYWx5emUoZXJyb3IpO1xuICAgIHJldHVybiBleG9FcnJvci5zdWdnZXN0aW9ucyB8fCBbXTtcbiAgfVxuXG4gIGFuYWx5emVFcnJvcihlcnJvcjogRXJyb3IgfCBzdHJpbmcpOiBFeG9jb3J0ZXhFcnJvciB7XG4gICAgcmV0dXJuIEVycm9yQW5hbHl6ZXIuYW5hbHl6ZShlcnJvcik7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==