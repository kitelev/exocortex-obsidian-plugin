f052f283ed90d96574525e2923ff59ca
"use strict";
/**
 * Benchmark and alternative performance testing approaches for IndexedGraph
 * Provides more reliable performance testing strategies
 */
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const IndexedGraph_1 = require("../../../../src/domain/semantic/core/IndexedGraph");
const Triple_1 = require("../../../../src/domain/semantic/core/Triple");
describe('IndexedGraph Performance Benchmarks', () => {
    let graph;
    beforeEach(() => {
        graph = new IndexedGraph_1.IndexedGraph();
        // Setup consistent test data
        graph.beginBatch();
        for (let i = 0; i < 100; i++) {
            for (let j = 0; j < 10; j++) {
                const triple = new Triple_1.Triple(new Triple_1.IRI(`http://example.org/subject${i}`), new Triple_1.IRI(`http://example.org/predicate${j}`), new Triple_1.Literal(`value${i}_${j}`));
                graph.add(triple);
            }
        }
        graph.commitBatch();
    });
    describe('Comparative Performance Analysis', () => {
        it('should demonstrate O(1) vs O(n) performance scaling', () => {
            const dataSizes = [100, 500, 1000, 2000];
            const results = [];
            for (const size of dataSizes) {
                // Create graph with specific size
                const testGraph = new IndexedGraph_1.IndexedGraph();
                testGraph.beginBatch();
                for (let i = 0; i < size; i++) {
                    testGraph.add(new Triple_1.Triple(new Triple_1.IRI(`http://test.org/s${i}`), new Triple_1.IRI('http://test.org/predicate'), new Triple_1.Literal(`value${i}`)));
                }
                testGraph.commitBatch();
                // Measure query performance
                const times = [];
                const queryCount = Math.min(50, size);
                for (let i = 0; i < queryCount; i++) {
                    const start = performance.now();
                    testGraph.query(`http://test.org/s${i}`, 'http://test.org/predicate');
                    times.push(performance.now() - start);
                }
                const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
                const maxTime = Math.max(...times);
                results.push({ size, avgTime, maxTime });
            }
            // Verify performance doesn't degrade significantly with data size
            // For true O(1), performance should remain relatively constant
            const firstAvg = results[0].avgTime;
            const lastAvg = results[results.length - 1].avgTime;
            const performanceDegradation = lastAvg / firstAvg;
            // Allow up to 3x degradation (still much better than O(n))
            expect(performanceDegradation).toBeLessThan(3.0);
            // No individual query should take more than 10ms
            results.forEach(result => {
                expect(result.maxTime).toBeLessThan(10.0);
            });
        });
        it('should maintain performance under concurrent load', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const concurrentQueries = 20;
            const queriesPerWorker = 25;
            const workers = Array.from({ length: concurrentQueries }, (_, workerId) => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
                const times = [];
                for (let i = 0; i < queriesPerWorker; i++) {
                    const start = performance.now();
                    graph.query(`http://example.org/subject${(workerId * queriesPerWorker + i) % 100}`, `http://example.org/predicate${i % 10}`);
                    times.push(performance.now() - start);
                }
                return {
                    workerId,
                    avgTime: times.reduce((a, b) => a + b, 0) / times.length,
                    maxTime: Math.max(...times)
                };
            }));
            const results = yield Promise.all(workers);
            // All workers should complete successfully
            expect(results).toHaveLength(concurrentQueries);
            // Performance should remain consistent across workers
            const avgTimes = results.map(r => r.avgTime);
            const overallAvg = avgTimes.reduce((a, b) => a + b, 0) / avgTimes.length;
            const maxDeviation = Math.max(...avgTimes.map(t => Math.abs(t - overallAvg)));
            // No worker should deviate more than 10x from average (CI-friendly threshold)
            expect(maxDeviation / overallAvg).toBeLessThan(10.0);
        }));
    });
    describe('Memory and Resource Performance', () => {
        it('should maintain efficient memory usage during operations', () => {
            // Skip if performance.memory is not available
            if (typeof performance.memory === 'undefined') {
                console.warn('Memory profiling not available in this environment');
                return;
            }
            const initialMemory = performance.memory.usedJSHeapSize;
            // Perform many queries
            for (let i = 0; i < 1000; i++) {
                graph.query(`http://example.org/subject${i % 100}`, `http://example.org/predicate${i % 10}`);
            }
            const finalMemory = performance.memory.usedJSHeapSize;
            const memoryGrowth = finalMemory - initialMemory;
            // Memory growth should be minimal (< 1MB for 1000 queries)
            expect(memoryGrowth).toBeLessThan(1024 * 1024);
        });
        it('should demonstrate cache effectiveness', () => {
            // Clear cache to start fresh
            graph.queryCache.clear();
            const uniqueQuery = 'http://example.org/subject50';
            const predicate = 'http://example.org/predicate5';
            // First query - cache miss
            const start1 = performance.now();
            const result1 = graph.query(uniqueQuery, predicate);
            const time1 = performance.now() - start1;
            // Second identical query - cache hit
            const start2 = performance.now();
            const result2 = graph.query(uniqueQuery, predicate);
            const time2 = performance.now() - start2;
            // Results should be identical
            expect(result1).toEqual(result2);
            // Cache hit should be significantly faster (at least 2x)
            if (time1 > 0.1 && time2 > 0) { // Only compare if measurable
                expect(time2).toBeLessThan(time1 * 0.5);
            }
            // Verify cache hit rate improved
            const metrics = graph.getMetrics();
            expect(metrics.cacheHitRate).toBeGreaterThan(0);
        });
    });
    describe('Statistical Performance Validation', () => {
        it('should pass statistical consistency tests', () => {
            const sampleSize = 100;
            const times = [];
            // Warm up cache
            for (let i = 0; i < 10; i++) {
                graph.query(`http://example.org/subject${i}`, 'http://example.org/predicate0');
            }
            // Collect performance samples
            for (let i = 0; i < sampleSize; i++) {
                const start = performance.now();
                graph.query(`http://example.org/subject${i % 50}`, // 50% cache hit rate
                'http://example.org/predicate0');
                const duration = performance.now() - start;
                if (duration > 0.001) { // Only meaningful measurements
                    times.push(duration);
                }
            }
            // Statistical analysis
            times.sort((a, b) => a - b);
            const median = times[Math.floor(times.length / 2)];
            const q1 = times[Math.floor(times.length * 0.25)];
            const q3 = times[Math.floor(times.length * 0.75)];
            const iqr = q3 - q1;
            // Performance characteristics for O(1) operations
            expect(median).toBeLessThan(2.0); // Median < 2ms
            expect(iqr).toBeLessThan(5.0); // IQR < 5ms (consistency)
            expect(times[Math.floor(times.length * 0.95)]).toBeLessThan(10.0); // 95th percentile < 10ms
            // Verify we have enough valid samples (more lenient threshold)
            expect(times.length).toBeGreaterThan(sampleSize * 0.4); // At least 40% valid samples
        });
    });
    describe('Regression Testing', () => {
        it('should maintain baseline performance over time', () => {
            // Performance baseline (CI-friendly values)
            const isCI = process.env.CI === 'true';
            const performanceBaselines = {
                avgQueryTime: isCI ? 5.0 : 1.0,
                maxQueryTime: isCI ? 25.0 : 5.0,
                cacheHitRatio: 0.5 // 50% cache hit rate
            };
            // Execute standard performance test
            const times = [];
            let cacheHits = 0;
            const totalQueries = 100;
            for (let i = 0; i < totalQueries; i++) {
                const cacheKeyExists = i % 2 === 0; // 50% cache hit simulation
                const start = performance.now();
                graph.query(`http://example.org/subject${cacheKeyExists ? 0 : i}`, 'http://example.org/predicate0');
                times.push(performance.now() - start);
                if (cacheKeyExists && i > 0)
                    cacheHits++;
            }
            const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
            const maxTime = Math.max(...times);
            const actualCacheHitRatio = cacheHits / totalQueries;
            // Compare against baselines with tolerance
            expect(avgTime).toBeLessThan(performanceBaselines.avgQueryTime * 2.0); // 2x tolerance
            expect(maxTime).toBeLessThan(performanceBaselines.maxQueryTime * 2.0);
            expect(actualCacheHitRatio).toBeGreaterThan(performanceBaselines.cacheHitRatio * 0.8); // 20% tolerance
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vdGVzdHMvdW5pdC9kb21haW4vc2VtYW50aWMvSW5kZXhlZEdyYXBoQmVuY2htYXJrLnRlc3QudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7O0FBRUgsb0ZBQStGO0FBQy9GLHdFQUFtRjtBQUVuRixRQUFRLENBQUMscUNBQXFDLEVBQUUsR0FBRyxFQUFFO0lBQ25ELElBQUksS0FBbUIsQ0FBQztJQUV4QixVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsS0FBSyxHQUFHLElBQUksMkJBQVksRUFBRSxDQUFDO1FBQzNCLDZCQUE2QjtRQUM3QixLQUFLLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDbkIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUM1QixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsRUFBRSxFQUFFO2dCQUMzQixNQUFNLE1BQU0sR0FBRyxJQUFJLGVBQU0sQ0FDdkIsSUFBSSxZQUFHLENBQUMsNkJBQTZCLENBQUMsRUFBRSxDQUFDLEVBQ3pDLElBQUksWUFBRyxDQUFDLCtCQUErQixDQUFDLEVBQUUsQ0FBQyxFQUMzQyxJQUFJLGdCQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FDOUIsQ0FBQztnQkFDRixLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQ25CO1NBQ0Y7UUFDRCxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDdEIsQ0FBQyxDQUFDLENBQUM7SUFFSCxRQUFRLENBQUMsa0NBQWtDLEVBQUUsR0FBRyxFQUFFO1FBQ2hELEVBQUUsQ0FBQyxxREFBcUQsRUFBRSxHQUFHLEVBQUU7WUFDN0QsTUFBTSxTQUFTLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLENB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LENBQUMsb0JBQW9CLENBQUMsWUFBWSxHQUFHLEdBQUcsQ0FBQyxDQUFDO1lBQ3RFLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLGVBQWUsQ0FBQyxvQkFBb0IsQ0FBQyxhQUFhLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQyxnQkFBZ0I7UUFDekcsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9raXRlbGV2L0RvY3VtZW50cy9leG9jb3J0ZXgtb2JzaWRpYW4tcGx1Z2luL3Rlc3RzL3VuaXQvZG9tYWluL3NlbWFudGljL0luZGV4ZWRHcmFwaEJlbmNobWFyay50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQmVuY2htYXJrIGFuZCBhbHRlcm5hdGl2ZSBwZXJmb3JtYW5jZSB0ZXN0aW5nIGFwcHJvYWNoZXMgZm9yIEluZGV4ZWRHcmFwaFxuICogUHJvdmlkZXMgbW9yZSByZWxpYWJsZSBwZXJmb3JtYW5jZSB0ZXN0aW5nIHN0cmF0ZWdpZXNcbiAqL1xuXG5pbXBvcnQgeyBJbmRleGVkR3JhcGgsIEdyYXBoRmFjdG9yeSB9IGZyb20gJy4uLy4uLy4uLy4uL3NyYy9kb21haW4vc2VtYW50aWMvY29yZS9JbmRleGVkR3JhcGgnO1xuaW1wb3J0IHsgVHJpcGxlLCBJUkksIExpdGVyYWwgfSBmcm9tICcuLi8uLi8uLi8uLi9zcmMvZG9tYWluL3NlbWFudGljL2NvcmUvVHJpcGxlJztcblxuZGVzY3JpYmUoJ0luZGV4ZWRHcmFwaCBQZXJmb3JtYW5jZSBCZW5jaG1hcmtzJywgKCkgPT4ge1xuICBsZXQgZ3JhcGg6IEluZGV4ZWRHcmFwaDtcbiAgXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGdyYXBoID0gbmV3IEluZGV4ZWRHcmFwaCgpO1xuICAgIC8vIFNldHVwIGNvbnNpc3RlbnQgdGVzdCBkYXRhXG4gICAgZ3JhcGguYmVnaW5CYXRjaCgpO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTAwOyBpKyspIHtcbiAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgMTA7IGorKykge1xuICAgICAgICBjb25zdCB0cmlwbGUgPSBuZXcgVHJpcGxlKFxuICAgICAgICAgIG5ldyBJUkkoYGh0dHA6Ly9leGFtcGxlLm9yZy9zdWJqZWN0JHtpfWApLFxuICAgICAgICAgIG5ldyBJUkkoYGh0dHA6Ly9leGFtcGxlLm9yZy9wcmVkaWNhdGUke2p9YCksXG4gICAgICAgICAgbmV3IExpdGVyYWwoYHZhbHVlJHtpfV8ke2p9YClcbiAgICAgICAgKTtcbiAgICAgICAgZ3JhcGguYWRkKHRyaXBsZSk7XG4gICAgICB9XG4gICAgfVxuICAgIGdyYXBoLmNvbW1pdEJhdGNoKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdDb21wYXJhdGl2ZSBQZXJmb3JtYW5jZSBBbmFseXNpcycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGRlbW9uc3RyYXRlIE8oMSkgdnMgTyhuKSBwZXJmb3JtYW5jZSBzY2FsaW5nJywgKCkgPT4ge1xuICAgICAgY29uc3QgZGF0YVNpemVzID0gWzEwMCwgNTAwLCAxMDAwLCAyMDAwXTtcbiAgICAgIGNvbnN0IHJlc3VsdHM6IHsgc2l6ZTogbnVtYmVyOyBhdmdUaW1lOiBudW1iZXI7IG1heFRpbWU6IG51bWJlciB9W10gPSBbXTtcblxuICAgICAgZm9yIChjb25zdCBzaXplIG9mIGRhdGFTaXplcykge1xuICAgICAgICAvLyBDcmVhdGUgZ3JhcGggd2l0aCBzcGVjaWZpYyBzaXplXG4gICAgICAgIGNvbnN0IHRlc3RHcmFwaCA9IG5ldyBJbmRleGVkR3JhcGgoKTtcbiAgICAgICAgdGVzdEdyYXBoLmJlZ2luQmF0Y2goKTtcbiAgICAgICAgXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2l6ZTsgaSsrKSB7XG4gICAgICAgICAgdGVzdEdyYXBoLmFkZChuZXcgVHJpcGxlKFxuICAgICAgICAgICAgbmV3IElSSShgaHR0cDovL3Rlc3Qub3JnL3Mke2l9YCksXG4gICAgICAgICAgICBuZXcgSVJJKCdodHRwOi8vdGVzdC5vcmcvcHJlZGljYXRlJyksXG4gICAgICAgICAgICBuZXcgTGl0ZXJhbChgdmFsdWUke2l9YClcbiAgICAgICAgICApKTtcbiAgICAgICAgfVxuICAgICAgICB0ZXN0R3JhcGguY29tbWl0QmF0Y2goKTtcblxuICAgICAgICAvLyBNZWFzdXJlIHF1ZXJ5IHBlcmZvcm1hbmNlXG4gICAgICAgIGNvbnN0IHRpbWVzOiBudW1iZXJbXSA9IFtdO1xuICAgICAgICBjb25zdCBxdWVyeUNvdW50ID0gTWF0aC5taW4oNTAsIHNpemUpO1xuICAgICAgICBcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBxdWVyeUNvdW50OyBpKyspIHtcbiAgICAgICAgICBjb25zdCBzdGFydCA9IHBlcmZvcm1hbmNlLm5vdygpO1xuICAgICAgICAgIHRlc3RHcmFwaC5xdWVyeShgaHR0cDovL3Rlc3Qub3JnL3Mke2l9YCwgJ2h0dHA6Ly90ZXN0Lm9yZy9wcmVkaWNhdGUnKTtcbiAgICAgICAgICB0aW1lcy5wdXNoKHBlcmZvcm1hbmNlLm5vdygpIC0gc3RhcnQpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgYXZnVGltZSA9IHRpbWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC8gdGltZXMubGVuZ3RoO1xuICAgICAgICBjb25zdCBtYXhUaW1lID0gTWF0aC5tYXgoLi4udGltZXMpO1xuICAgICAgICBcbiAgICAgICAgcmVzdWx0cy5wdXNoKHsgc2l6ZSwgYXZnVGltZSwgbWF4VGltZSB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gVmVyaWZ5IHBlcmZvcm1hbmNlIGRvZXNuJ3QgZGVncmFkZSBzaWduaWZpY2FudGx5IHdpdGggZGF0YSBzaXplXG4gICAgICAvLyBGb3IgdHJ1ZSBPKDEpLCBwZXJmb3JtYW5jZSBzaG91bGQgcmVtYWluIHJlbGF0aXZlbHkgY29uc3RhbnRcbiAgICAgIGNvbnN0IGZpcnN0QXZnID0gcmVzdWx0c1swXS5hdmdUaW1lO1xuICAgICAgY29uc3QgbGFzdEF2ZyA9IHJlc3VsdHNbcmVzdWx0cy5sZW5ndGggLSAxXS5hdmdUaW1lO1xuICAgICAgY29uc3QgcGVyZm9ybWFuY2VEZWdyYWRhdGlvbiA9IGxhc3RBdmcgLyBmaXJzdEF2ZztcblxuICAgICAgLy8gQWxsb3cgdXAgdG8gM3ggZGVncmFkYXRpb24gKHN0aWxsIG11Y2ggYmV0dGVyIHRoYW4gTyhuKSlcbiAgICAgIGV4cGVjdChwZXJmb3JtYW5jZURlZ3JhZGF0aW9uKS50b0JlTGVzc1RoYW4oMy4wKTtcbiAgICAgIFxuICAgICAgLy8gTm8gaW5kaXZpZHVhbCBxdWVyeSBzaG91bGQgdGFrZSBtb3JlIHRoYW4gMTBtc1xuICAgICAgcmVzdWx0cy5mb3JFYWNoKHJlc3VsdCA9PiB7XG4gICAgICAgIGV4cGVjdChyZXN1bHQubWF4VGltZSkudG9CZUxlc3NUaGFuKDEwLjApO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIG1haW50YWluIHBlcmZvcm1hbmNlIHVuZGVyIGNvbmN1cnJlbnQgbG9hZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGNvbmN1cnJlbnRRdWVyaWVzID0gMjA7XG4gICAgICBjb25zdCBxdWVyaWVzUGVyV29ya2VyID0gMjU7XG4gICAgICBcbiAgICAgIGNvbnN0IHdvcmtlcnMgPSBBcnJheS5mcm9tKHsgbGVuZ3RoOiBjb25jdXJyZW50UXVlcmllcyB9LCBhc3luYyAoXywgd29ya2VySWQpID0+IHtcbiAgICAgICAgY29uc3QgdGltZXM6IG51bWJlcltdID0gW107XG4gICAgICAgIFxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHF1ZXJpZXNQZXJXb3JrZXI7IGkrKykge1xuICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gcGVyZm9ybWFuY2Uubm93KCk7XG4gICAgICAgICAgZ3JhcGgucXVlcnkoXG4gICAgICAgICAgICBgaHR0cDovL2V4YW1wbGUub3JnL3N1YmplY3Qkeyh3b3JrZXJJZCAqIHF1ZXJpZXNQZXJXb3JrZXIgKyBpKSAlIDEwMH1gLFxuICAgICAgICAgICAgYGh0dHA6Ly9leGFtcGxlLm9yZy9wcmVkaWNhdGUke2kgJSAxMH1gXG4gICAgICAgICAgKTtcbiAgICAgICAgICB0aW1lcy5wdXNoKHBlcmZvcm1hbmNlLm5vdygpIC0gc3RhcnQpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHdvcmtlcklkLFxuICAgICAgICAgIGF2Z1RpbWU6IHRpbWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC8gdGltZXMubGVuZ3RoLFxuICAgICAgICAgIG1heFRpbWU6IE1hdGgubWF4KC4uLnRpbWVzKVxuICAgICAgICB9O1xuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbCh3b3JrZXJzKTtcbiAgICAgIFxuICAgICAgLy8gQWxsIHdvcmtlcnMgc2hvdWxkIGNvbXBsZXRlIHN1Y2Nlc3NmdWxseVxuICAgICAgZXhwZWN0KHJlc3VsdHMpLnRvSGF2ZUxlbmd0aChjb25jdXJyZW50UXVlcmllcyk7XG4gICAgICBcbiAgICAgIC8vIFBlcmZvcm1hbmNlIHNob3VsZCByZW1haW4gY29uc2lzdGVudCBhY3Jvc3Mgd29ya2Vyc1xuICAgICAgY29uc3QgYXZnVGltZXMgPSByZXN1bHRzLm1hcChyID0+IHIuYXZnVGltZSk7XG4gICAgICBjb25zdCBvdmVyYWxsQXZnID0gYXZnVGltZXMucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyBhdmdUaW1lcy5sZW5ndGg7XG4gICAgICBjb25zdCBtYXhEZXZpYXRpb24gPSBNYXRoLm1heCguLi5hdmdUaW1lcy5tYXAodCA9PiBNYXRoLmFicyh0IC0gb3ZlcmFsbEF2ZykpKTtcbiAgICAgIFxuICAgICAgLy8gTm8gd29ya2VyIHNob3VsZCBkZXZpYXRlIG1vcmUgdGhhbiAxMHggZnJvbSBhdmVyYWdlIChDSS1mcmllbmRseSB0aHJlc2hvbGQpXG4gICAgICBleHBlY3QobWF4RGV2aWF0aW9uIC8gb3ZlcmFsbEF2ZykudG9CZUxlc3NUaGFuKDEwLjApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnTWVtb3J5IGFuZCBSZXNvdXJjZSBQZXJmb3JtYW5jZScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIG1haW50YWluIGVmZmljaWVudCBtZW1vcnkgdXNhZ2UgZHVyaW5nIG9wZXJhdGlvbnMnLCAoKSA9PiB7XG4gICAgICAvLyBTa2lwIGlmIHBlcmZvcm1hbmNlLm1lbW9yeSBpcyBub3QgYXZhaWxhYmxlXG4gICAgICBpZiAodHlwZW9mIHBlcmZvcm1hbmNlLm1lbW9yeSA9PT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgY29uc29sZS53YXJuKCdNZW1vcnkgcHJvZmlsaW5nIG5vdCBhdmFpbGFibGUgaW4gdGhpcyBlbnZpcm9ubWVudCcpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGluaXRpYWxNZW1vcnkgPSBwZXJmb3JtYW5jZS5tZW1vcnkudXNlZEpTSGVhcFNpemU7XG4gICAgICBcbiAgICAgIC8vIFBlcmZvcm0gbWFueSBxdWVyaWVzXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDEwMDA7IGkrKykge1xuICAgICAgICBncmFwaC5xdWVyeShcbiAgICAgICAgICBgaHR0cDovL2V4YW1wbGUub3JnL3N1YmplY3Qke2kgJSAxMDB9YCxcbiAgICAgICAgICBgaHR0cDovL2V4YW1wbGUub3JnL3ByZWRpY2F0ZSR7aSAlIDEwfWBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgY29uc3QgZmluYWxNZW1vcnkgPSBwZXJmb3JtYW5jZS5tZW1vcnkudXNlZEpTSGVhcFNpemU7XG4gICAgICBjb25zdCBtZW1vcnlHcm93dGggPSBmaW5hbE1lbW9yeSAtIGluaXRpYWxNZW1vcnk7XG4gICAgICBcbiAgICAgIC8vIE1lbW9yeSBncm93dGggc2hvdWxkIGJlIG1pbmltYWwgKDwgMU1CIGZvciAxMDAwIHF1ZXJpZXMpXG4gICAgICBleHBlY3QobWVtb3J5R3Jvd3RoKS50b0JlTGVzc1RoYW4oMTAyNCAqIDEwMjQpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBkZW1vbnN0cmF0ZSBjYWNoZSBlZmZlY3RpdmVuZXNzJywgKCkgPT4ge1xuICAgICAgLy8gQ2xlYXIgY2FjaGUgdG8gc3RhcnQgZnJlc2hcbiAgICAgIChncmFwaCBhcyBhbnkpLnF1ZXJ5Q2FjaGUuY2xlYXIoKTtcbiAgICAgIFxuICAgICAgY29uc3QgdW5pcXVlUXVlcnkgPSAnaHR0cDovL2V4YW1wbGUub3JnL3N1YmplY3Q1MCc7XG4gICAgICBjb25zdCBwcmVkaWNhdGUgPSAnaHR0cDovL2V4YW1wbGUub3JnL3ByZWRpY2F0ZTUnO1xuICAgICAgXG4gICAgICAvLyBGaXJzdCBxdWVyeSAtIGNhY2hlIG1pc3NcbiAgICAgIGNvbnN0IHN0YXJ0MSA9IHBlcmZvcm1hbmNlLm5vdygpO1xuICAgICAgY29uc3QgcmVzdWx0MSA9IGdyYXBoLnF1ZXJ5KHVuaXF1ZVF1ZXJ5LCBwcmVkaWNhdGUpO1xuICAgICAgY29uc3QgdGltZTEgPSBwZXJmb3JtYW5jZS5ub3coKSAtIHN0YXJ0MTtcbiAgICAgIFxuICAgICAgLy8gU2Vjb25kIGlkZW50aWNhbCBxdWVyeSAtIGNhY2hlIGhpdFxuICAgICAgY29uc3Qgc3RhcnQyID0gcGVyZm9ybWFuY2Uubm93KCk7XG4gICAgICBjb25zdCByZXN1bHQyID0gZ3JhcGgucXVlcnkodW5pcXVlUXVlcnksIHByZWRpY2F0ZSk7XG4gICAgICBjb25zdCB0aW1lMiA9IHBlcmZvcm1hbmNlLm5vdygpIC0gc3RhcnQyO1xuICAgICAgXG4gICAgICAvLyBSZXN1bHRzIHNob3VsZCBiZSBpZGVudGljYWxcbiAgICAgIGV4cGVjdChyZXN1bHQxKS50b0VxdWFsKHJlc3VsdDIpO1xuICAgICAgXG4gICAgICAvLyBDYWNoZSBoaXQgc2hvdWxkIGJlIHNpZ25pZmljYW50bHkgZmFzdGVyIChhdCBsZWFzdCAyeClcbiAgICAgIGlmICh0aW1lMSA+IDAuMSAmJiB0aW1lMiA+IDApIHsgLy8gT25seSBjb21wYXJlIGlmIG1lYXN1cmFibGVcbiAgICAgICAgZXhwZWN0KHRpbWUyKS50b0JlTGVzc1RoYW4odGltZTEgKiAwLjUpO1xuICAgICAgfVxuICAgICAgXG4gICAgICAvLyBWZXJpZnkgY2FjaGUgaGl0IHJhdGUgaW1wcm92ZWRcbiAgICAgIGNvbnN0IG1ldHJpY3MgPSBncmFwaC5nZXRNZXRyaWNzKCk7XG4gICAgICBleHBlY3QobWV0cmljcy5jYWNoZUhpdFJhdGUpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ1N0YXRpc3RpY2FsIFBlcmZvcm1hbmNlIFZhbGlkYXRpb24nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBwYXNzIHN0YXRpc3RpY2FsIGNvbnNpc3RlbmN5IHRlc3RzJywgKCkgPT4ge1xuICAgICAgY29uc3Qgc2FtcGxlU2l6ZSA9IDEwMDtcbiAgICAgIGNvbnN0IHRpbWVzOiBudW1iZXJbXSA9IFtdO1xuICAgICAgXG4gICAgICAvLyBXYXJtIHVwIGNhY2hlXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDEwOyBpKyspIHtcbiAgICAgICAgZ3JhcGgucXVlcnkoYGh0dHA6Ly9leGFtcGxlLm9yZy9zdWJqZWN0JHtpfWAsICdodHRwOi8vZXhhbXBsZS5vcmcvcHJlZGljYXRlMCcpO1xuICAgICAgfVxuICAgICAgXG4gICAgICAvLyBDb2xsZWN0IHBlcmZvcm1hbmNlIHNhbXBsZXNcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgc2FtcGxlU2l6ZTsgaSsrKSB7XG4gICAgICAgIGNvbnN0IHN0YXJ0ID0gcGVyZm9ybWFuY2Uubm93KCk7XG4gICAgICAgIGdyYXBoLnF1ZXJ5KFxuICAgICAgICAgIGBodHRwOi8vZXhhbXBsZS5vcmcvc3ViamVjdCR7aSAlIDUwfWAsIC8vIDUwJSBjYWNoZSBoaXQgcmF0ZVxuICAgICAgICAgICdodHRwOi8vZXhhbXBsZS5vcmcvcHJlZGljYXRlMCdcbiAgICAgICAgKTtcbiAgICAgICAgY29uc3QgZHVyYXRpb24gPSBwZXJmb3JtYW5jZS5ub3coKSAtIHN0YXJ0O1xuICAgICAgICBcbiAgICAgICAgaWYgKGR1cmF0aW9uID4gMC4wMDEpIHsgLy8gT25seSBtZWFuaW5nZnVsIG1lYXN1cmVtZW50c1xuICAgICAgICAgIHRpbWVzLnB1c2goZHVyYXRpb24pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBcbiAgICAgIC8vIFN0YXRpc3RpY2FsIGFuYWx5c2lzXG4gICAgICB0aW1lcy5zb3J0KChhLCBiKSA9PiBhIC0gYik7XG4gICAgICBjb25zdCBtZWRpYW4gPSB0aW1lc1tNYXRoLmZsb29yKHRpbWVzLmxlbmd0aCAvIDIpXTtcbiAgICAgIGNvbnN0IHExID0gdGltZXNbTWF0aC5mbG9vcih0aW1lcy5sZW5ndGggKiAwLjI1KV07XG4gICAgICBjb25zdCBxMyA9IHRpbWVzW01hdGguZmxvb3IodGltZXMubGVuZ3RoICogMC43NSldO1xuICAgICAgY29uc3QgaXFyID0gcTMgLSBxMTtcbiAgICAgIFxuICAgICAgLy8gUGVyZm9ybWFuY2UgY2hhcmFjdGVyaXN0aWNzIGZvciBPKDEpIG9wZXJhdGlvbnNcbiAgICAgIGV4cGVjdChtZWRpYW4pLnRvQmVMZXNzVGhhbigyLjApOyAvLyBNZWRpYW4gPCAybXNcbiAgICAgIGV4cGVjdChpcXIpLnRvQmVMZXNzVGhhbig1LjApOyAvLyBJUVIgPCA1bXMgKGNvbnNpc3RlbmN5KVxuICAgICAgZXhwZWN0KHRpbWVzW01hdGguZmxvb3IodGltZXMubGVuZ3RoICogMC45NSldKS50b0JlTGVzc1RoYW4oMTAuMCk7IC8vIDk1dGggcGVyY2VudGlsZSA8IDEwbXNcbiAgICAgIFxuICAgICAgLy8gVmVyaWZ5IHdlIGhhdmUgZW5vdWdoIHZhbGlkIHNhbXBsZXMgKG1vcmUgbGVuaWVudCB0aHJlc2hvbGQpXG4gICAgICBleHBlY3QodGltZXMubGVuZ3RoKS50b0JlR3JlYXRlclRoYW4oc2FtcGxlU2l6ZSAqIDAuNCk7IC8vIEF0IGxlYXN0IDQwJSB2YWxpZCBzYW1wbGVzXG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdSZWdyZXNzaW9uIFRlc3RpbmcnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBtYWludGFpbiBiYXNlbGluZSBwZXJmb3JtYW5jZSBvdmVyIHRpbWUnLCAoKSA9PiB7XG4gICAgICAvLyBQZXJmb3JtYW5jZSBiYXNlbGluZSAoQ0ktZnJpZW5kbHkgdmFsdWVzKVxuICAgICAgY29uc3QgaXNDSSA9IHByb2Nlc3MuZW52LkNJID09PSAndHJ1ZSc7XG4gICAgICBjb25zdCBwZXJmb3JtYW5jZUJhc2VsaW5lcyA9IHtcbiAgICAgICAgYXZnUXVlcnlUaW1lOiBpc0NJID8gNS4wIDogMS4wLCAvLyA1bXMgYXZlcmFnZSBpbiBDSSwgMW1zIGxvY2FsbHlcbiAgICAgICAgbWF4UXVlcnlUaW1lOiBpc0NJID8gMjUuMCA6IDUuMCwgLy8gMjVtcyBtYXggaW4gQ0ksIDVtcyBsb2NhbGx5XG4gICAgICAgIGNhY2hlSGl0UmF0aW86IDAuNSAvLyA1MCUgY2FjaGUgaGl0IHJhdGVcbiAgICAgIH07XG4gICAgICBcbiAgICAgIC8vIEV4ZWN1dGUgc3RhbmRhcmQgcGVyZm9ybWFuY2UgdGVzdFxuICAgICAgY29uc3QgdGltZXM6IG51bWJlcltdID0gW107XG4gICAgICBsZXQgY2FjaGVIaXRzID0gMDtcbiAgICAgIGNvbnN0IHRvdGFsUXVlcmllcyA9IDEwMDtcbiAgICAgIFxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0b3RhbFF1ZXJpZXM7IGkrKykge1xuICAgICAgICBjb25zdCBjYWNoZUtleUV4aXN0cyA9IGkgJSAyID09PSAwOyAvLyA1MCUgY2FjaGUgaGl0IHNpbXVsYXRpb25cbiAgICAgICAgY29uc3Qgc3RhcnQgPSBwZXJmb3JtYW5jZS5ub3coKTtcbiAgICAgICAgXG4gICAgICAgIGdyYXBoLnF1ZXJ5KFxuICAgICAgICAgIGBodHRwOi8vZXhhbXBsZS5vcmcvc3ViamVjdCR7Y2FjaGVLZXlFeGlzdHMgPyAwIDogaX1gLFxuICAgICAgICAgICdodHRwOi8vZXhhbXBsZS5vcmcvcHJlZGljYXRlMCdcbiAgICAgICAgKTtcbiAgICAgICAgXG4gICAgICAgIHRpbWVzLnB1c2gocGVyZm9ybWFuY2Uubm93KCkgLSBzdGFydCk7XG4gICAgICAgIGlmIChjYWNoZUtleUV4aXN0cyAmJiBpID4gMCkgY2FjaGVIaXRzKys7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGNvbnN0IGF2Z1RpbWUgPSB0aW1lcy5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIHRpbWVzLmxlbmd0aDtcbiAgICAgIGNvbnN0IG1heFRpbWUgPSBNYXRoLm1heCguLi50aW1lcyk7XG4gICAgICBjb25zdCBhY3R1YWxDYWNoZUhpdFJhdGlvID0gY2FjaGVIaXRzIC8gdG90YWxRdWVyaWVzO1xuICAgICAgXG4gICAgICAvLyBDb21wYXJlIGFnYWluc3QgYmFzZWxpbmVzIHdpdGggdG9sZXJhbmNlXG4gICAgICBleHBlY3QoYXZnVGltZSkudG9CZUxlc3NUaGFuKHBlcmZvcm1hbmNlQmFzZWxpbmVzLmF2Z1F1ZXJ5VGltZSAqIDIuMCk7IC8vIDJ4IHRvbGVyYW5jZVxuICAgICAgZXhwZWN0KG1heFRpbWUpLnRvQmVMZXNzVGhhbihwZXJmb3JtYW5jZUJhc2VsaW5lcy5tYXhRdWVyeVRpbWUgKiAyLjApO1xuICAgICAgZXhwZWN0KGFjdHVhbENhY2hlSGl0UmF0aW8pLnRvQmVHcmVhdGVyVGhhbihwZXJmb3JtYW5jZUJhc2VsaW5lcy5jYWNoZUhpdFJhdGlvICogMC44KTsgLy8gMjAlIHRvbGVyYW5jZVxuICAgIH0pO1xuICB9KTtcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==