ef15beb9a7b9ed24cb39507666db25fb
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ButtonCommand = exports.CommandType = void 0;
const Entity_1 = require("../core/Entity");
const Result_1 = require("../core/Result");
/**
 * Types of commands that can be executed
 */
var CommandType;
(function (CommandType) {
    CommandType["CREATE_ASSET"] = "CREATE_ASSET";
    CommandType["CREATE_CHILD_TASK"] = "CREATE_CHILD_TASK";
    CommandType["OPEN_ASSET"] = "OPEN_ASSET";
    CommandType["DELETE_ASSET"] = "DELETE_ASSET";
    CommandType["RUN_TEMPLATE"] = "RUN_TEMPLATE";
    CommandType["EXECUTE_SEARCH"] = "EXECUTE_SEARCH";
    CommandType["TRIGGER_WORKFLOW"] = "TRIGGER_WORKFLOW";
    CommandType["CUSTOM"] = "CUSTOM";
})(CommandType = exports.CommandType || (exports.CommandType = {}));
class ButtonCommand extends Entity_1.Entity {
    constructor(props) {
        super(props, props.id.toString());
    }
    generateId() {
        return this.props.id.toString();
    }
    validate() {
        if (!this.props.id) {
            throw new Error("ButtonCommand must have a valid ID");
        }
        if (!this.props.name || this.props.name.trim().length === 0) {
            throw new Error("ButtonCommand must have a non-empty name");
        }
        if (!this.props.type) {
            throw new Error("ButtonCommand must have a valid type");
        }
    }
    /**
     * Factory method with validation
     */
    static create(props) {
        // Validate command name
        if (!props.name || props.name.trim().length === 0) {
            return Result_1.Result.fail("Command name cannot be empty");
        }
        // Validate parameters if input is required
        if (props.requiresInput &&
            (!props.parameters || props.parameters.length === 0)) {
            return Result_1.Result.fail("Commands requiring input must define parameters");
        }
        // Validate each parameter
        for (const param of props.parameters) {
            if (!param.name || param.name.trim().length === 0) {
                return Result_1.Result.fail("Parameter name cannot be empty");
            }
            if (param.validation) {
                try {
                    new RegExp(param.validation);
                }
                catch (e) {
                    return Result_1.Result.fail(`Invalid validation regex for parameter ${param.name}`);
                }
            }
        }
        // Validate command-specific requirements
        if (props.type === CommandType.RUN_TEMPLATE && !props.template) {
            return Result_1.Result.fail("Template commands must specify a template");
        }
        if (props.type === CommandType.CUSTOM && !props.script) {
            return Result_1.Result.fail("Custom commands must specify a script");
        }
        return Result_1.Result.ok(new ButtonCommand(props));
    }
    // Getters
    get id() {
        return this.props.id;
    }
    get type() {
        return this.props.type;
    }
    get name() {
        return this.props.name;
    }
    get description() {
        return this.props.description;
    }
    get requiresInput() {
        return this.props.requiresInput;
    }
    get parameters() {
        return this.props.parameters;
    }
    get targetClass() {
        return this.props.targetClass;
    }
    get template() {
        return this.props.template;
    }
    get script() {
        return this.props.script;
    }
    /**
     * Validate input parameters against command definition
     */
    validateInput(input) {
        const validated = {};
        const errors = [];
        for (const param of this.parameters) {
            const value = input[param.name];
            // Check required parameters
            if (param.required &&
                (value === undefined || value === null || value === "")) {
                errors.push(`Required parameter '${param.name}' is missing`);
                continue;
            }
            // Skip optional parameters if not provided
            if (!param.required && (value === undefined || value === null)) {
                if (param.defaultValue !== undefined) {
                    validated[param.name] = param.defaultValue;
                }
                continue;
            }
            // Type validation
            if (!this.validateParameterType(value, param.type)) {
                errors.push(`Parameter '${param.name}' must be of type ${param.type}`);
                continue;
            }
            // Custom validation
            if (param.validation) {
                const regex = new RegExp(param.validation);
                if (!regex.test(String(value))) {
                    errors.push(`Parameter '${param.name}' does not match validation pattern`);
                    continue;
                }
            }
            validated[param.name] = value;
        }
        if (errors.length > 0) {
            return Result_1.Result.fail(errors.join("; "));
        }
        return Result_1.Result.ok(validated);
    }
    /**
     * Check if command can be executed in current context
     */
    canExecute(context) {
        // Check if command is applicable to current class
        if (this.targetClass && context.currentClass !== this.targetClass) {
            return false;
        }
        // Check if command requires selection
        if (this.type === CommandType.DELETE_ASSET && !context.hasSelection) {
            return false;
        }
        return true;
    }
    /**
     * Build execution context for the command
     */
    buildExecutionContext(input) {
        const validationResult = this.validateInput(input);
        if (validationResult.isFailure) {
            return Result_1.Result.fail(validationResult.error);
        }
        const context = {
            commandId: this.id.toString(),
            commandType: this.type,
            parameters: validationResult.getValue(),
            timestamp: new Date(),
            template: this.props.template,
            script: this.props.script,
            targetClass: this.props.targetClass,
        };
        return Result_1.Result.ok(context);
    }
    validateParameterType(value, type) {
        switch (type) {
            case "string":
                return typeof value === "string";
            case "number":
                return typeof value === "number" || !isNaN(Number(value));
            case "boolean":
                return (typeof value === "boolean" || value === "true" || value === "false");
            case "date":
                return !isNaN(Date.parse(String(value)));
            case "asset":
                return (typeof value === "string" &&
                    value.startsWith("[[") &&
                    value.endsWith("]]"));
            case "array":
                return Array.isArray(value) || typeof value === "string";
            default:
                return true;
        }
    }
}
exports.ButtonCommand = ButtonCommand;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2RvbWFpbi9lbnRpdGllcy9CdXR0b25Db21tYW5kLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLDJDQUF3QztBQUV4QywyQ0FBd0M7QUFFeEM7O0dBRUc7QUFDSCxJQUFZLFdBU1g7QUFURCxXQUFZLFdBQVc7SUFDckIsNENBQTZCLENBQUE7SUFDN0Isc0RBQXVDLENBQUE7SUFDdkMsd0NBQXlCLENBQUE7SUFDekIsNENBQTZCLENBQUE7SUFDN0IsNENBQTZCLENBQUE7SUFDN0IsZ0RBQWlDLENBQUE7SUFDakMsb0RBQXFDLENBQUE7SUFDckMsZ0NBQWlCLENBQUE7QUFDbkIsQ0FBQyxFQVRXLFdBQVcsR0FBWCxtQkFBVyxLQUFYLG1CQUFXLFFBU3RCO0FBOEJELE1BQWEsYUFBYyxTQUFRLGVBQTBCO0lBQzNELFlBQW9CLEtBQXlCO1FBQzNDLEtBQUssQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFFUyxVQUFVO1FBQ2xCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDbEMsQ0FBQztJQUVTLFFBQVE7UUFDaEIsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFO1lBQ2xCLE1BQU0sSUFBSSxLQUFLLENBQUMsb0NBQW9DLENBQUMsQ0FBQztTQUN2RDtRQUVELElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQzNELE1BQU0sSUFBSSxLQUFLLENBQUMsMENBQTBDLENBQUMsQ0FBQztTQUM3RDtRQUVELElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRTtZQUNwQixNQUFNLElBQUksS0FB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QUksT0FBTyxLQUFLLEtBQUssUUFBUSxDQUFDO1lBQzNEO2dCQUNFLE9BQU8sSUFBSSxDQUFDO1NBQ2Y7SUFDSCxDQUFDO0NBQ0Y7QUE3T0Qsc0NBNk9DIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9raXRlbGV2L0RvY3VtZW50cy9leG9jb3J0ZXgtb2JzaWRpYW4tcGx1Z2luL3NyYy9kb21haW4vZW50aXRpZXMvQnV0dG9uQ29tbWFuZC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFbnRpdHkgfSBmcm9tIFwiLi4vY29yZS9FbnRpdHlcIjtcbmltcG9ydCB7IEFzc2V0SWQgfSBmcm9tIFwiLi4vdmFsdWUtb2JqZWN0cy9Bc3NldElkXCI7XG5pbXBvcnQgeyBSZXN1bHQgfSBmcm9tIFwiLi4vY29yZS9SZXN1bHRcIjtcblxuLyoqXG4gKiBUeXBlcyBvZiBjb21tYW5kcyB0aGF0IGNhbiBiZSBleGVjdXRlZFxuICovXG5leHBvcnQgZW51bSBDb21tYW5kVHlwZSB7XG4gIENSRUFURV9BU1NFVCA9IFwiQ1JFQVRFX0FTU0VUXCIsXG4gIENSRUFURV9DSElMRF9UQVNLID0gXCJDUkVBVEVfQ0hJTERfVEFTS1wiLFxuICBPUEVOX0FTU0VUID0gXCJPUEVOX0FTU0VUXCIsXG4gIERFTEVURV9BU1NFVCA9IFwiREVMRVRFX0FTU0VUXCIsXG4gIFJVTl9URU1QTEFURSA9IFwiUlVOX1RFTVBMQVRFXCIsXG4gIEVYRUNVVEVfU0VBUkNIID0gXCJFWEVDVVRFX1NFQVJDSFwiLFxuICBUUklHR0VSX1dPUktGTE9XID0gXCJUUklHR0VSX1dPUktGTE9XXCIsXG4gIENVU1RPTSA9IFwiQ1VTVE9NXCIsXG59XG5cbi8qKlxuICogUGFyYW1ldGVyIGRlZmluaXRpb24gZm9yIGNvbW1hbmQgaW5wdXRzXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ29tbWFuZFBhcmFtZXRlciB7XG4gIG5hbWU6IHN0cmluZztcbiAgdHlwZTogXCJzdHJpbmdcIiB8IFwibnVtYmVyXCIgfCBcImJvb2xlYW5cIiB8IFwiYXNzZXRcIiB8IFwiZGF0ZVwiIHwgXCJhcnJheVwiO1xuICByZXF1aXJlZDogYm9vbGVhbjtcbiAgZGVmYXVsdFZhbHVlPzogYW55O1xuICBsYWJlbD86IHN0cmluZztcbiAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XG4gIHZhbGlkYXRpb24/OiBzdHJpbmc7IC8vIFJlZ2V4IG9yIHZhbGlkYXRpb24gcnVsZVxufVxuXG4vKipcbiAqIERvbWFpbiBFbnRpdHkgcmVwcmVzZW50aW5nIGEgQnV0dG9uIENvbW1hbmRcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBCdXR0b25Db21tYW5kUHJvcHMge1xuICBpZDogQXNzZXRJZDtcbiAgdHlwZTogQ29tbWFuZFR5cGU7XG4gIG5hbWU6IHN0cmluZztcbiAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XG4gIHJlcXVpcmVzSW5wdXQ6IGJvb2xlYW47XG4gIHBhcmFtZXRlcnM6IENvbW1hbmRQYXJhbWV0ZXJbXTtcbiAgdGFyZ2V0Q2xhc3M/OiBzdHJpbmc7IC8vIEZvciBjb21tYW5kcyB0aGF0IG9wZXJhdGUgb24gc3BlY2lmaWMgY2xhc3Nlc1xuICB0ZW1wbGF0ZT86IHN0cmluZzsgLy8gRm9yIHRlbXBsYXRlLWJhc2VkIGNvbW1hbmRzXG4gIHNjcmlwdD86IHN0cmluZzsgLy8gRm9yIGN1c3RvbSBzY3JpcHQgY29tbWFuZHNcbn1cblxuZXhwb3J0IGNsYXNzIEJ1dHRvbkNvbW1hbmQgZXh0ZW5kcyBFbnRpdHk8QnV0dG9uQ29tbWFuZFByb3BzPiB7XG4gIHByaXZhdGUgY29uc3RydWN0b3IocHJvcHM6IEJ1dHRvbkNvbW1hbmRQcm9wcykge1xuICAgIHN1cGVyKHByb3BzLCBwcm9wcy5pZC50b1N0cmluZygpKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZW5lcmF0ZUlkKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMucHJvcHMuaWQudG9TdHJpbmcoKTtcbiAgfVxuXG4gIHByb3RlY3RlZCB2YWxpZGF0ZSgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMucHJvcHMuaWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkJ1dHRvbkNvbW1hbmQgbXVzdCBoYXZlIGEgdmFsaWQgSURcIik7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLnByb3BzLm5hbWUgfHwgdGhpcy5wcm9wcy5uYW1lLnRyaW0oKS5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkJ1dHRvbkNvbW1hbmQgbXVzdCBoYXZlIGEgbm9uLWVtcHR5IG5hbWVcIik7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLnByb3BzLnR5cGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkJ1dHRvbkNvbW1hbmQgbXVzdCBoYXZlIGEgdmFsaWQgdHlwZVwiKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRmFjdG9yeSBtZXRob2Qgd2l0aCB2YWxpZGF0aW9uXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGNyZWF0ZShwcm9wczogQnV0dG9uQ29tbWFuZFByb3BzKTogUmVzdWx0PEJ1dHRvbkNvbW1hbmQ+IHtcbiAgICAvLyBWYWxpZGF0ZSBjb21tYW5kIG5hbWVcbiAgICBpZiAoIXByb3BzLm5hbWUgfHwgcHJvcHMubmFtZS50cmltKCkubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8QnV0dG9uQ29tbWFuZD4oXCJDb21tYW5kIG5hbWUgY2Fubm90IGJlIGVtcHR5XCIpO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIHBhcmFtZXRlcnMgaWYgaW5wdXQgaXMgcmVxdWlyZWRcbiAgICBpZiAoXG4gICAgICBwcm9wcy5yZXF1aXJlc0lucHV0ICYmXG4gICAgICAoIXByb3BzLnBhcmFtZXRlcnMgfHwgcHJvcHMucGFyYW1ldGVycy5sZW5ndGggPT09IDApXG4gICAgKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8QnV0dG9uQ29tbWFuZD4oXG4gICAgICAgIFwiQ29tbWFuZHMgcmVxdWlyaW5nIGlucHV0IG11c3QgZGVmaW5lIHBhcmFtZXRlcnNcIixcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgZWFjaCBwYXJhbWV0ZXJcbiAgICBmb3IgKGNvbnN0IHBhcmFtIG9mIHByb3BzLnBhcmFtZXRlcnMpIHtcbiAgICAgIGlmICghcGFyYW0ubmFtZSB8fCBwYXJhbS5uYW1lLnRyaW0oKS5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPEJ1dHRvbkNvbW1hbmQ+KFwiUGFyYW1ldGVyIG5hbWUgY2Fubm90IGJlIGVtcHR5XCIpO1xuICAgICAgfVxuXG4gICAgICBpZiAocGFyYW0udmFsaWRhdGlvbikge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIG5ldyBSZWdFeHAocGFyYW0udmFsaWRhdGlvbik7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8QnV0dG9uQ29tbWFuZD4oXG4gICAgICAgICAgICBgSW52YWxpZCB2YWxpZGF0aW9uIHJlZ2V4IGZvciBwYXJhbWV0ZXIgJHtwYXJhbS5uYW1lfWAsXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIGNvbW1hbmQtc3BlY2lmaWMgcmVxdWlyZW1lbnRzXG4gICAgaWYgKHByb3BzLnR5cGUgPT09IENvbW1hbmRUeXBlLlJVTl9URU1QTEFURSAmJiAhcHJvcHMudGVtcGxhdGUpIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxCdXR0b25Db21tYW5kPihcbiAgICAgICAgXCJUZW1wbGF0ZSBjb21tYW5kcyBtdXN0IHNwZWNpZnkgYSB0ZW1wbGF0ZVwiLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBpZiAocHJvcHMudHlwZSA9PT0gQ29tbWFuZFR5cGUuQ1VTVE9NICYmICFwcm9wcy5zY3JpcHQpIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxCdXR0b25Db21tYW5kPihcbiAgICAgICAgXCJDdXN0b20gY29tbWFuZHMgbXVzdCBzcGVjaWZ5IGEgc2NyaXB0XCIsXG4gICAgICApO1xuICAgIH1cblxuICAgIHJldHVybiBSZXN1bHQub2s8QnV0dG9uQ29tbWFuZD4obmV3IEJ1dHRvbkNvbW1hbmQocHJvcHMpKTtcbiAgfVxuXG4gIC8vIEdldHRlcnNcbiAgZ2V0IGlkKCk6IEFzc2V0SWQge1xuICAgIHJldHVybiB0aGlzLnByb3BzLmlkO1xuICB9XG5cbiAgZ2V0IHR5cGUoKTogQ29tbWFuZFR5cGUge1xuICAgIHJldHVybiB0aGlzLnByb3BzLnR5cGU7XG4gIH1cblxuICBnZXQgbmFtZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnByb3BzLm5hbWU7XG4gIH1cblxuICBnZXQgZGVzY3JpcHRpb24oKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5wcm9wcy5kZXNjcmlwdGlvbjtcbiAgfVxuXG4gIGdldCByZXF1aXJlc0lucHV0KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnByb3BzLnJlcXVpcmVzSW5wdXQ7XG4gIH1cblxuICBnZXQgcGFyYW1ldGVycygpOiBDb21tYW5kUGFyYW1ldGVyW10ge1xuICAgIHJldHVybiB0aGlzLnByb3BzLnBhcmFtZXRlcnM7XG4gIH1cblxuICBnZXQgdGFyZ2V0Q2xhc3MoKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5wcm9wcy50YXJnZXRDbGFzcztcbiAgfVxuXG4gIGdldCB0ZW1wbGF0ZSgpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLnByb3BzLnRlbXBsYXRlO1xuICB9XG5cbiAgZ2V0IHNjcmlwdCgpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIHJldHVybiB0aGlzLnByb3BzLnNjcmlwdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZSBpbnB1dCBwYXJhbWV0ZXJzIGFnYWluc3QgY29tbWFuZCBkZWZpbml0aW9uXG4gICAqL1xuICBwdWJsaWMgdmFsaWRhdGVJbnB1dChcbiAgICBpbnB1dDogUmVjb3JkPHN0cmluZywgYW55PixcbiAgKTogUmVzdWx0PFJlY29yZDxzdHJpbmcsIGFueT4+IHtcbiAgICBjb25zdCB2YWxpZGF0ZWQ6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcbiAgICBjb25zdCBlcnJvcnM6IHN0cmluZ1tdID0gW107XG5cbiAgICBmb3IgKGNvbnN0IHBhcmFtIG9mIHRoaXMucGFyYW1ldGVycykge1xuICAgICAgY29uc3QgdmFsdWUgPSBpbnB1dFtwYXJhbS5uYW1lXTtcblxuICAgICAgLy8gQ2hlY2sgcmVxdWlyZWQgcGFyYW1ldGVyc1xuICAgICAgaWYgKFxuICAgICAgICBwYXJhbS5yZXF1aXJlZCAmJlxuICAgICAgICAodmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gXCJcIilcbiAgICAgICkge1xuICAgICAgICBlcnJvcnMucHVzaChgUmVxdWlyZWQgcGFyYW1ldGVyICcke3BhcmFtLm5hbWV9JyBpcyBtaXNzaW5nYCk7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICAvLyBTa2lwIG9wdGlvbmFsIHBhcmFtZXRlcnMgaWYgbm90IHByb3ZpZGVkXG4gICAgICBpZiAoIXBhcmFtLnJlcXVpcmVkICYmICh2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8IHZhbHVlID09PSBudWxsKSkge1xuICAgICAgICBpZiAocGFyYW0uZGVmYXVsdFZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICB2YWxpZGF0ZWRbcGFyYW0ubmFtZV0gPSBwYXJhbS5kZWZhdWx0VmFsdWU7XG4gICAgICAgIH1cbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIC8vIFR5cGUgdmFsaWRhdGlvblxuICAgICAgaWYgKCF0aGlzLnZhbGlkYXRlUGFyYW1ldGVyVHlwZSh2YWx1ZSwgcGFyYW0udHlwZSkpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goYFBhcmFtZXRlciAnJHtwYXJhbS5uYW1lfScgbXVzdCBiZSBvZiB0eXBlICR7cGFyYW0udHlwZX1gKTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIC8vIEN1c3RvbSB2YWxpZGF0aW9uXG4gICAgICBpZiAocGFyYW0udmFsaWRhdGlvbikge1xuICAgICAgICBjb25zdCByZWdleCA9IG5ldyBSZWdFeHAocGFyYW0udmFsaWRhdGlvbik7XG4gICAgICAgIGlmICghcmVnZXgudGVzdChTdHJpbmcodmFsdWUpKSkge1xuICAgICAgICAgIGVycm9ycy5wdXNoKFxuICAgICAgICAgICAgYFBhcmFtZXRlciAnJHtwYXJhbS5uYW1lfScgZG9lcyBub3QgbWF0Y2ggdmFsaWRhdGlvbiBwYXR0ZXJuYCxcbiAgICAgICAgICApO1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHZhbGlkYXRlZFtwYXJhbS5uYW1lXSA9IHZhbHVlO1xuICAgIH1cblxuICAgIGlmIChlcnJvcnMubGVuZ3RoID4gMCkge1xuICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPFJlY29yZDxzdHJpbmcsIGFueT4+KGVycm9ycy5qb2luKFwiOyBcIikpO1xuICAgIH1cblxuICAgIHJldHVybiBSZXN1bHQub2s8UmVjb3JkPHN0cmluZywgYW55Pj4odmFsaWRhdGVkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBjb21tYW5kIGNhbiBiZSBleGVjdXRlZCBpbiBjdXJyZW50IGNvbnRleHRcbiAgICovXG4gIHB1YmxpYyBjYW5FeGVjdXRlKGNvbnRleHQ6IHtcbiAgICBjdXJyZW50Q2xhc3M/OiBzdHJpbmc7XG4gICAgaGFzU2VsZWN0aW9uPzogYm9vbGVhbjtcbiAgfSk6IGJvb2xlYW4ge1xuICAgIC8vIENoZWNrIGlmIGNvbW1hbmQgaXMgYXBwbGljYWJsZSB0byBjdXJyZW50IGNsYXNzXG4gICAgaWYgKHRoaXMudGFyZ2V0Q2xhc3MgJiYgY29udGV4dC5jdXJyZW50Q2xhc3MgIT09IHRoaXMudGFyZ2V0Q2xhc3MpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiBjb21tYW5kIHJlcXVpcmVzIHNlbGVjdGlvblxuICAgIGlmICh0aGlzLnR5cGUgPT09IENvbW1hbmRUeXBlLkRFTEVURV9BU1NFVCAmJiAhY29udGV4dC5oYXNTZWxlY3Rpb24pIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBCdWlsZCBleGVjdXRpb24gY29udGV4dCBmb3IgdGhlIGNvbW1hbmRcbiAgICovXG4gIHB1YmxpYyBidWlsZEV4ZWN1dGlvbkNvbnRleHQoXG4gICAgaW5wdXQ6IFJlY29yZDxzdHJpbmcsIGFueT4sXG4gICk6IFJlc3VsdDxDb21tYW5kRXhlY3V0aW9uQ29udGV4dD4ge1xuICAgIGNvbnN0IHZhbGlkYXRpb25SZXN1bHQgPSB0aGlzLnZhbGlkYXRlSW5wdXQoaW5wdXQpO1xuXG4gICAgaWYgKHZhbGlkYXRpb25SZXN1bHQuaXNGYWlsdXJlKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8Q29tbWFuZEV4ZWN1dGlvbkNvbnRleHQ+KHZhbGlkYXRpb25SZXN1bHQuZXJyb3IpO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbnRleHQ6IENvbW1hbmRFeGVjdXRpb25Db250ZXh0ID0ge1xuICAgICAgY29tbWFuZElkOiB0aGlzLmlkLnRvU3RyaW5nKCksXG4gICAgICBjb21tYW5kVHlwZTogdGhpcy50eXBlLFxuICAgICAgcGFyYW1ldGVyczogdmFsaWRhdGlvblJlc3VsdC5nZXRWYWx1ZSgpLFxuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgdGVtcGxhdGU6IHRoaXMucHJvcHMudGVtcGxhdGUsXG4gICAgICBzY3JpcHQ6IHRoaXMucHJvcHMuc2NyaXB0LFxuICAgICAgdGFyZ2V0Q2xhc3M6IHRoaXMucHJvcHMudGFyZ2V0Q2xhc3MsXG4gICAgfTtcblxuICAgIHJldHVybiBSZXN1bHQub2s8Q29tbWFuZEV4ZWN1dGlvbkNvbnRleHQ+KGNvbnRleHQpO1xuICB9XG5cbiAgcHJpdmF0ZSB2YWxpZGF0ZVBhcmFtZXRlclR5cGUodmFsdWU6IGFueSwgdHlwZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICBjYXNlIFwic3RyaW5nXCI6XG4gICAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09IFwic3RyaW5nXCI7XG4gICAgICBjYXNlIFwibnVtYmVyXCI6XG4gICAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09IFwibnVtYmVyXCIgfHwgIWlzTmFOKE51bWJlcih2YWx1ZSkpO1xuICAgICAgY2FzZSBcImJvb2xlYW5cIjpcbiAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICB0eXBlb2YgdmFsdWUgPT09IFwiYm9vbGVhblwiIHx8IHZhbHVlID09PSBcInRydWVcIiB8fCB2YWx1ZSA9PT0gXCJmYWxzZVwiXG4gICAgICAgICk7XG4gICAgICBjYXNlIFwiZGF0ZVwiOlxuICAgICAgICByZXR1cm4gIWlzTmFOKERhdGUucGFyc2UoU3RyaW5nKHZhbHVlKSkpO1xuICAgICAgY2FzZSBcImFzc2V0XCI6XG4gICAgICAgIHJldHVybiAoXG4gICAgICAgICAgdHlwZW9mIHZhbHVlID09PSBcInN0cmluZ1wiICYmXG4gICAgICAgICAgdmFsdWUuc3RhcnRzV2l0aChcIltbXCIpICYmXG4gICAgICAgICAgdmFsdWUuZW5kc1dpdGgoXCJdXVwiKVxuICAgICAgICApO1xuICAgICAgY2FzZSBcImFycmF5XCI6XG4gICAgICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSB8fCB0eXBlb2YgdmFsdWUgPT09IFwic3RyaW5nXCI7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBDb250ZXh0IGZvciBjb21tYW5kIGV4ZWN1dGlvblxuICovXG5leHBvcnQgaW50ZXJmYWNlIENvbW1hbmRFeGVjdXRpb25Db250ZXh0IHtcbiAgY29tbWFuZElkOiBzdHJpbmc7XG4gIGNvbW1hbmRUeXBlOiBDb21tYW5kVHlwZTtcbiAgcGFyYW1ldGVyczogUmVjb3JkPHN0cmluZywgYW55PjtcbiAgdGltZXN0YW1wOiBEYXRlO1xuICB0ZW1wbGF0ZT86IHN0cmluZztcbiAgc2NyaXB0Pzogc3RyaW5nO1xuICB0YXJnZXRDbGFzcz86IHN0cmluZztcbn1cbiJdLCJ2ZXJzaW9uIjozfQ==