046d38f7b1529cf7d42297e361111b27
"use strict";
/**
 * RDF Graph implementation for managing collections of triples
 * Provides efficient querying and manipulation of semantic data
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.Graph = void 0;
/**
 * RDF Graph - A collection of RDF triples
 */
class Graph {
    constructor(triples = []) {
        this.triples = new Set();
        this.spo = new Map();
        this.pos = new Map();
        this.osp = new Map();
        for (const triple of triples) {
            this.add(triple);
        }
    }
    /**
     * Add a triple to the graph
     */
    add(triple) {
        if (this.has(triple))
            return;
        this.triples.add(triple);
        const s = triple.getSubject().toString();
        const p = triple.getPredicate().toString();
        const o = triple.getObject().toString();
        // Update SPO index
        if (!this.spo.has(s))
            this.spo.set(s, new Map());
        if (!this.spo.get(s).has(p))
            this.spo.get(s).set(p, new Set());
        this.spo.get(s).get(p).add(o);
        // Update POS index
        if (!this.pos.has(p))
            this.pos.set(p, new Map());
        if (!this.pos.get(p).has(o))
            this.pos.get(p).set(o, new Set());
        this.pos.get(p).get(o).add(s);
        // Update OSP index
        if (!this.osp.has(o))
            this.osp.set(o, new Map());
        if (!this.osp.get(o).has(s))
            this.osp.get(o).set(s, new Set());
        this.osp.get(o).get(s).add(p);
    }
    /**
     * Remove a triple from the graph
     */
    remove(triple) {
        if (!this.has(triple))
            return;
        this.triples.delete(triple);
        const s = triple.getSubject().toString();
        const p = triple.getPredicate().toString();
        const o = triple.getObject().toString();
        // Update SPO index
        this.spo.get(s)?.get(p)?.delete(o);
        if (this.spo.get(s)?.get(p)?.size === 0) {
            this.spo.get(s)?.delete(p);
        }
        if (this.spo.get(s)?.size === 0) {
            this.spo.delete(s);
        }
        // Update POS index
        this.pos.get(p)?.get(o)?.delete(s);
        if (this.pos.get(p)?.get(o)?.size === 0) {
            this.pos.get(p)?.delete(o);
        }
        if (this.pos.get(p)?.size === 0) {
            this.pos.delete(p);
        }
        // Update OSP index
        this.osp.get(o)?.get(s)?.delete(p);
        if (this.osp.get(o)?.get(s)?.size === 0) {
            this.osp.get(o)?.delete(s);
        }
        if (this.osp.get(o)?.size === 0) {
            this.osp.delete(o);
        }
    }
    /**
     * Check if the graph contains a triple
     */
    has(triple) {
        const s = triple.getSubject().toString();
        const p = triple.getPredicate().toString();
        const o = triple.getObject().toString();
        return this.spo.get(s)?.get(p)?.has(o) ?? false;
    }
    /**
     * Get all triples matching a pattern
     * null values act as wildcards
     */
    match(subject = null, predicate = null, object = null) {
        const results = [];
        if (subject && predicate && object) {
            // Exact match
            for (const triple of this.triples) {
                if (triple.getSubject().toString() === subject.toString() &&
                    triple.getPredicate().toString() === predicate.toString() &&
                    triple.getObject().toString() === object.toString()) {
                    results.push(triple);
                }
            }
        }
        else if (subject && predicate) {
            // S P ?
            const objects = this.spo
                .get(subject.toString())
                ?.get(predicate.toString());
            if (objects) {
                for (const triple of this.triples) {
                    if (triple.getSubject().toString() === subject.toString() &&
                        triple.getPredicate().toString() === predicate.toString()) {
                        results.push(triple);
                    }
                }
            }
        }
        else if (predicate && object) {
            // ? P O
            const subjects = this.pos
                .get(predicate.toString())
                ?.get(object.toString());
            if (subjects) {
                for (const triple of this.triples) {
                    if (triple.getPredicate().toString() === predicate.toString() &&
                        triple.getObject().toString() === object.toString()) {
                        results.push(triple);
                    }
                }
            }
        }
        else if (subject && object) {
            // S ? O
            const predicates = this.osp
                .get(object.toString())
                ?.get(subject.toString());
            if (predicates) {
                for (const triple of this.triples) {
                    if (triple.getSubject().toString() === subject.toString() &&
                        triple.getObject().toString() === object.toString()) {
                        results.push(triple);
                    }
                }
            }
        }
        else if (subject) {
            // S ? ?
            for (const triple of this.triples) {
                if (triple.getSubject().toString() === subject.toString()) {
                    results.push(triple);
                }
            }
        }
        else if (predicate) {
            // ? P ?
            for (const triple of this.triples) {
                if (triple.getPredicate().toString() === predicate.toString()) {
                    results.push(triple);
                }
            }
        }
        else if (object) {
            // ? ? O
            for (const triple of this.triples) {
                if (triple.getObject().toString() === object.toString()) {
                    results.push(triple);
                }
            }
        }
        else {
            // ? ? ? - return all
            return Array.from(this.triples);
        }
        return results;
    }
    /**
     * Get all subjects in the graph
     */
    subjects() {
        const subjects = new Set();
        for (const triple of this.triples) {
            subjects.add(triple.getSubject());
        }
        return subjects;
    }
    /**
     * Get all predicates in the graph
     */
    predicates() {
        const predicates = new Set();
        for (const triple of this.triples) {
            predicates.add(triple.getPredicate());
        }
        return predicates;
    }
    /**
     * Get all objects in the graph
     */
    objects() {
        const objects = new Set();
        for (const triple of this.triples) {
            objects.add(triple.getObject());
        }
        return objects;
    }
    /**
     * Get the size of the graph (number of triples)
     */
    size() {
        return this.triples.size;
    }
    /**
     * Check if the graph is empty
     */
    isEmpty() {
        return this.triples.size === 0;
    }
    /**
     * Clear all triples from the graph
     */
    clear() {
        this.triples.clear();
        this.spo.clear();
        this.pos.clear();
        this.osp.clear();
    }
    /**
     * Merge another graph into this one
     */
    merge(other) {
        for (const triple of other.toArray()) {
            this.add(triple);
        }
    }
    /**
     * Create a new graph with triples matching a pattern
     */
    filter(subject = null, predicate = null, object = null) {
        return new Graph(this.match(subject, predicate, object));
    }
    /**
     * Convert the graph to an array of triples
     */
    toArray() {
        return Array.from(this.triples);
    }
    /**
     * Create a human-readable string representation
     */
    toString() {
        return Array.from(this.triples)
            .map((t) => t.toString())
            .join("\n");
    }
    /**
     * Create a copy of this graph
     */
    clone() {
        return new Graph(this.toArray());
    }
    /**
     * Check if two graphs are equal
     */
    equals(other) {
        if (this.size() !== other.size())
            return false;
        for (const triple of this.triples) {
            if (!other.has(triple))
                return false;
        }
        return true;
    }
    /**
     * Alias for add method - used by some services
     */
    addTriple(triple) {
        this.add(triple);
    }
    /**
     * Get all triples (alias for toArray)
     */
    getTriples() {
        return this.toArray();
    }
    /**
     * Alias for has method - used by some services
     */
    hasTriple(triple) {
        return this.has(triple);
    }
}
exports.Graph = Graph;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2RvbWFpbi9zZW1hbnRpYy9jb3JlL0dyYXBoLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7OztBQVVIOztHQUVHO0FBQ0gsTUFBYSxLQUFLO0lBTWhCLFlBQVksVUFBb0IsRUFBRTtRQUwxQixZQUFPLEdBQWdCLElBQUksR0FBRyxFQUFFLENBQUM7UUFDakMsUUFBRyxHQUEwQyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ3ZELFFBQUcsR0FBMEMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUN2RCxRQUFHLEdBQTBDLElBQUksR0FBRyxFQUFFLENBQUM7UUFHN0QsS0FBSyxNQUFNLE1BQU0sSUFBSSxPQUFPLEVBQUU7WUFDNUIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNsQjtJQUNILENBQUM7SUFFRDs7T0FFRztJQUNILEdBQUcsQ0FBQyxNQUFjO1FBQ2hCLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUM7WUFBRSxPQUFPO1FBRTdCLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRXpCLE1BQU0sQ0FBQyxHQUFHLE1BQU0sQ0FBQyxVQUFVLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUN6QyxNQUFNLENBQUMsR0FBRyxNQUFNLENBQUMsWUFBWSxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUM7UUFDM0MsTUFBTSxDQUFDLEdBQUcsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBRXhDLG1CQUFtQjtRQUNuQixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksR0FBRyxFQUFFLENBQUMsQ0FBQztRQUNqRCxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQ2pFLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFaEMsbUJBQW1CO1FBQ25CLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQ2pELElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxJQUFJLEdBQUcsRUFBRSxDQUFDLENBQUM7UUFDakUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFFLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVoQyxtQkFBbUI7UUFDbkIsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxJQUFJLEdBQUcsRUFBRSxDQUFDLENBQUM7UUFDakQsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFBRSxJQUFJLENBQUMsR0FBRyxD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LENBQUM7SUFFRDs7T0FFRztJQUNILE1BQU0sQ0FBQyxLQUFZO1FBQ2pCLElBQUksSUFBSSxDQUFDLElBQUksRUFBRSxLQUFLLEtBQUssQ0FBQyxJQUFJLEVBQUU7WUFBRSxPQUFPLEtBQUssQ0FBQztRQUUvQyxLQUFLLE1BQU0sTUFBTSxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDakMsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDO2dCQUFFLE9BQU8sS0FBSyxDQUFDO1NBQ3RDO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxTQUFTLENBQUMsTUFBYztRQUN0QixJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ25CLENBQUM7SUFFRDs7T0FFRztJQUNILFVBQVU7UUFDUixPQUFPLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUN4QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxTQUFTLENBQUMsTUFBYztRQUN0QixPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDMUIsQ0FBQztDQUNGO0FBaFVELHNCQWdVQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva2l0ZWxldi9Eb2N1bWVudHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi9zcmMvZG9tYWluL3NlbWFudGljL2NvcmUvR3JhcGgudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBSREYgR3JhcGggaW1wbGVtZW50YXRpb24gZm9yIG1hbmFnaW5nIGNvbGxlY3Rpb25zIG9mIHRyaXBsZXNcbiAqIFByb3ZpZGVzIGVmZmljaWVudCBxdWVyeWluZyBhbmQgbWFuaXB1bGF0aW9uIG9mIHNlbWFudGljIGRhdGFcbiAqL1xuXG5pbXBvcnQgeyBUcmlwbGUsIElSSSwgQmxhbmtOb2RlLCBMaXRlcmFsIH0gZnJvbSBcIi4vVHJpcGxlXCI7XG5pbXBvcnQgeyBSZXN1bHQgfSBmcm9tIFwiLi4vLi4vY29yZS9SZXN1bHRcIjtcblxuZXhwb3J0IHR5cGUgTm9kZSA9IElSSSB8IEJsYW5rTm9kZSB8IExpdGVyYWw7XG5leHBvcnQgdHlwZSBTdWJqZWN0ID0gSVJJIHwgQmxhbmtOb2RlO1xuZXhwb3J0IHR5cGUgUHJlZGljYXRlID0gSVJJO1xuZXhwb3J0IHR5cGUgT2JqZWN0ID0gTm9kZTtcblxuLyoqXG4gKiBSREYgR3JhcGggLSBBIGNvbGxlY3Rpb24gb2YgUkRGIHRyaXBsZXNcbiAqL1xuZXhwb3J0IGNsYXNzIEdyYXBoIHtcbiAgcHJpdmF0ZSB0cmlwbGVzOiBTZXQ8VHJpcGxlPiA9IG5ldyBTZXQoKTtcbiAgcHJpdmF0ZSBzcG86IE1hcDxzdHJpbmcsIE1hcDxzdHJpbmcsIFNldDxzdHJpbmc+Pj4gPSBuZXcgTWFwKCk7XG4gIHByaXZhdGUgcG9zOiBNYXA8c3RyaW5nLCBNYXA8c3RyaW5nLCBTZXQ8c3RyaW5nPj4+ID0gbmV3IE1hcCgpO1xuICBwcml2YXRlIG9zcDogTWFwPHN0cmluZywgTWFwPHN0cmluZywgU2V0PHN0cmluZz4+PiA9IG5ldyBNYXAoKTtcblxuICBjb25zdHJ1Y3Rvcih0cmlwbGVzOiBUcmlwbGVbXSA9IFtdKSB7XG4gICAgZm9yIChjb25zdCB0cmlwbGUgb2YgdHJpcGxlcykge1xuICAgICAgdGhpcy5hZGQodHJpcGxlKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQWRkIGEgdHJpcGxlIHRvIHRoZSBncmFwaFxuICAgKi9cbiAgYWRkKHRyaXBsZTogVHJpcGxlKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaGFzKHRyaXBsZSkpIHJldHVybjtcblxuICAgIHRoaXMudHJpcGxlcy5hZGQodHJpcGxlKTtcblxuICAgIGNvbnN0IHMgPSB0cmlwbGUuZ2V0U3ViamVjdCgpLnRvU3RyaW5nKCk7XG4gICAgY29uc3QgcCA9IHRyaXBsZS5nZXRQcmVkaWNhdGUoKS50b1N0cmluZygpO1xuICAgIGNvbnN0IG8gPSB0cmlwbGUuZ2V0T2JqZWN0KCkudG9TdHJpbmcoKTtcblxuICAgIC8vIFVwZGF0ZSBTUE8gaW5kZXhcbiAgICBpZiAoIXRoaXMuc3BvLmhhcyhzKSkgdGhpcy5zcG8uc2V0KHMsIG5ldyBNYXAoKSk7XG4gICAgaWYgKCF0aGlzLnNwby5nZXQocykhLmhhcyhwKSkgdGhpcy5zcG8uZ2V0KHMpIS5zZXQocCwgbmV3IFNldCgpKTtcbiAgICB0aGlzLnNwby5nZXQocykhLmdldChwKSEuYWRkKG8pO1xuXG4gICAgLy8gVXBkYXRlIFBPUyBpbmRleFxuICAgIGlmICghdGhpcy5wb3MuaGFzKHApKSB0aGlzLnBvcy5zZXQocCwgbmV3IE1hcCgpKTtcbiAgICBpZiAoIXRoaXMucG9zLmdldChwKSEuaGFzKG8pKSB0aGlzLnBvcy5nZXQocCkhLnNldChvLCBuZXcgU2V0KCkpO1xuICAgIHRoaXMucG9zLmdldChwKSEuZ2V0KG8pIS5hZGQocyk7XG5cbiAgICAvLyBVcGRhdGUgT1NQIGluZGV4XG4gICAgaWYgKCF0aGlzLm9zcC5oYXMobykpIHRoaXMub3NwLnNldChvLCBuZXcgTWFwKCkpO1xuICAgIGlmICghdGhpcy5vc3AuZ2V0KG8pIS5oYXMocykpIHRoaXMub3NwLmdldChvKSEuc2V0KHMsIG5ldyBTZXQoKSk7XG4gICAgdGhpcy5vc3AuZ2V0KG8pIS5nZXQocykhLmFkZChwKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZW1vdmUgYSB0cmlwbGUgZnJvbSB0aGUgZ3JhcGhcbiAgICovXG4gIHJlbW92ZSh0cmlwbGU6IFRyaXBsZSk6IHZvaWQge1xuICAgIGlmICghdGhpcy5oYXModHJpcGxlKSkgcmV0dXJuO1xuXG4gICAgdGhpcy50cmlwbGVzLmRlbGV0ZSh0cmlwbGUpO1xuXG4gICAgY29uc3QgcyA9IHRyaXBsZS5nZXRTdWJqZWN0KCkudG9TdHJpbmcoKTtcbiAgICBjb25zdCBwID0gdHJpcGxlLmdldFByZWRpY2F0ZSgpLnRvU3RyaW5nKCk7XG4gICAgY29uc3QgbyA9IHRyaXBsZS5nZXRPYmplY3QoKS50b1N0cmluZygpO1xuXG4gICAgLy8gVXBkYXRlIFNQTyBpbmRleFxuICAgIHRoaXMuc3BvLmdldChzKT8uZ2V0KHApPy5kZWxldGUobyk7XG4gICAgaWYgKHRoaXMuc3BvLmdldChzKT8uZ2V0KHApPy5zaXplID09PSAwKSB7XG4gICAgICB0aGlzLnNwby5nZXQocyk/LmRlbGV0ZShwKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuc3BvLmdldChzKT8uc2l6ZSA9PT0gMCkge1xuICAgICAgdGhpcy5zcG8uZGVsZXRlKHMpO1xuICAgIH1cblxuICAgIC8vIFVwZGF0ZSBQT1MgaW5kZXhcbiAgICB0aGlzLnBvcy5nZXQocCk/LmdldChvKT8uZGVsZXRlKHMpO1xuICAgIGlmICh0aGlzLnBvcy5nZXQocCk/LmdldChvKT8uc2l6ZSA9PT0gMCkge1xuICAgICAgdGhpcy5wb3MuZ2V0KHApPy5kZWxldGUobyk7XG4gICAgfVxuICAgIGlmICh0aGlzLnBvcy5nZXQocCk/LnNpemUgPT09IDApIHtcbiAgICAgIHRoaXMucG9zLmRlbGV0ZShwKTtcbiAgICB9XG5cbiAgICAvLyBVcGRhdGUgT1NQIGluZGV4XG4gICAgdGhpcy5vc3AuZ2V0KG8pPy5nZXQocyk/LmRlbGV0ZShwKTtcbiAgICBpZiAodGhpcy5vc3AuZ2V0KG8pPy5nZXQocyk/LnNpemUgPT09IDApIHtcbiAgICAgIHRoaXMub3NwLmdldChvKT8uZGVsZXRlKHMpO1xuICAgIH1cbiAgICBpZiAodGhpcy5vc3AuZ2V0KG8pPy5zaXplID09PSAwKSB7XG4gICAgICB0aGlzLm9zcC5kZWxldGUobyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIHRoZSBncmFwaCBjb250YWlucyBhIHRyaXBsZVxuICAgKi9cbiAgaGFzKHRyaXBsZTogVHJpcGxlKTogYm9vbGVhbiB7XG4gICAgY29uc3QgcyA9IHRyaXBsZS5nZXRTdWJqZWN0KCkudG9TdHJpbmcoKTtcbiAgICBjb25zdCBwID0gdHJpcGxlLmdldFByZWRpY2F0ZSgpLnRvU3RyaW5nKCk7XG4gICAgY29uc3QgbyA9IHRyaXBsZS5nZXRPYmplY3QoKS50b1N0cmluZygpO1xuXG4gICAgcmV0dXJuIHRoaXMuc3BvLmdldChzKT8uZ2V0KHApPy5oYXMobykgPz8gZmFsc2U7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGFsbCB0cmlwbGVzIG1hdGNoaW5nIGEgcGF0dGVyblxuICAgKiBudWxsIHZhbHVlcyBhY3QgYXMgd2lsZGNhcmRzXG4gICAqL1xuICBtYXRjaChcbiAgICBzdWJqZWN0OiBTdWJqZWN0IHwgbnVsbCA9IG51bGwsXG4gICAgcHJlZGljYXRlOiBQcmVkaWNhdGUgfCBudWxsID0gbnVsbCxcbiAgICBvYmplY3Q6IE9iamVjdCB8IG51bGwgPSBudWxsLFxuICApOiBUcmlwbGVbXSB7XG4gICAgY29uc3QgcmVzdWx0czogVHJpcGxlW10gPSBbXTtcblxuICAgIGlmIChzdWJqZWN0ICYmIHByZWRpY2F0ZSAmJiBvYmplY3QpIHtcbiAgICAgIC8vIEV4YWN0IG1hdGNoXG4gICAgICBmb3IgKGNvbnN0IHRyaXBsZSBvZiB0aGlzLnRyaXBsZXMpIHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgIHRyaXBsZS5nZXRTdWJqZWN0KCkudG9TdHJpbmcoKSA9PT0gc3ViamVjdC50b1N0cmluZygpICYmXG4gICAgICAgICAgdHJpcGxlLmdldFByZWRpY2F0ZSgpLnRvU3RyaW5nKCkgPT09IHByZWRpY2F0ZS50b1N0cmluZygpICYmXG4gICAgICAgICAgdHJpcGxlLmdldE9iamVjdCgpLnRvU3RyaW5nKCkgPT09IG9iamVjdC50b1N0cmluZygpXG4gICAgICAgICkge1xuICAgICAgICAgIHJlc3VsdHMucHVzaCh0cmlwbGUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChzdWJqZWN0ICYmIHByZWRpY2F0ZSkge1xuICAgICAgLy8gUyBQID9cbiAgICAgIGNvbnN0IG9iamVjdHMgPSB0aGlzLnNwb1xuICAgICAgICAuZ2V0KHN1YmplY3QudG9TdHJpbmcoKSlcbiAgICAgICAgPy5nZXQocHJlZGljYXRlLnRvU3RyaW5nKCkpO1xuICAgICAgaWYgKG9iamVjdHMpIHtcbiAgICAgICAgZm9yIChjb25zdCB0cmlwbGUgb2YgdGhpcy50cmlwbGVzKSB7XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgdHJpcGxlLmdldFN1YmplY3QoKS50b1N0cmluZygpID09PSBzdWJqZWN0LnRvU3RyaW5nKCkgJiZcbiAgICAgICAgICAgIHRyaXBsZS5nZXRQcmVkaWNhdGUoKS50b1N0cmluZygpID09PSBwcmVkaWNhdGUudG9TdHJpbmcoKVxuICAgICAgICAgICkge1xuICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHRyaXBsZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChwcmVkaWNhdGUgJiYgb2JqZWN0KSB7XG4gICAgICAvLyA/IFAgT1xuICAgICAgY29uc3Qgc3ViamVjdHMgPSB0aGlzLnBvc1xuICAgICAgICAuZ2V0KHByZWRpY2F0ZS50b1N0cmluZygpKVxuICAgICAgICA/LmdldChvYmplY3QudG9TdHJpbmcoKSk7XG4gICAgICBpZiAoc3ViamVjdHMpIHtcbiAgICAgICAgZm9yIChjb25zdCB0cmlwbGUgb2YgdGhpcy50cmlwbGVzKSB7XG4gICAgICAgICAgaWYgKFxuICAgICAgICAgICAgdHJpcGxlLmdldFByZWRpY2F0ZSgpLnRvU3RyaW5nKCkgPT09IHByZWRpY2F0ZS50b1N0cmluZygpICYmXG4gICAgICAgICAgICB0cmlwbGUuZ2V0T2JqZWN0KCkudG9TdHJpbmcoKSA9PT0gb2JqZWN0LnRvU3RyaW5nKClcbiAgICAgICAgICApIHtcbiAgICAgICAgICAgIHJlc3VsdHMucHVzaCh0cmlwbGUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoc3ViamVjdCAmJiBvYmplY3QpIHtcbiAgICAgIC8vIFMgPyBPXG4gICAgICBjb25zdCBwcmVkaWNhdGVzID0gdGhpcy5vc3BcbiAgICAgICAgLmdldChvYmplY3QudG9TdHJpbmcoKSlcbiAgICAgICAgPy5nZXQoc3ViamVjdC50b1N0cmluZygpKTtcbiAgICAgIGlmIChwcmVkaWNhdGVzKSB7XG4gICAgICAgIGZvciAoY29uc3QgdHJpcGxlIG9mIHRoaXMudHJpcGxlcykge1xuICAgICAgICAgIGlmIChcbiAgICAgICAgICAgIHRyaXBsZS5nZXRTdWJqZWN0KCkudG9TdHJpbmcoKSA9PT0gc3ViamVjdC50b1N0cmluZygpICYmXG4gICAgICAgICAgICB0cmlwbGUuZ2V0T2JqZWN0KCkudG9TdHJpbmcoKSA9PT0gb2JqZWN0LnRvU3RyaW5nKClcbiAgICAgICAgICApIHtcbiAgICAgICAgICAgIHJlc3VsdHMucHVzaCh0cmlwbGUpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoc3ViamVjdCkge1xuICAgICAgLy8gUyA/ID9cbiAgICAgIGZvciAoY29uc3QgdHJpcGxlIG9mIHRoaXMudHJpcGxlcykge1xuICAgICAgICBpZiAodHJpcGxlLmdldFN1YmplY3QoKS50b1N0cmluZygpID09PSBzdWJqZWN0LnRvU3RyaW5nKCkpIHtcbiAgICAgICAgICByZXN1bHRzLnB1c2godHJpcGxlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAocHJlZGljYXRlKSB7XG4gICAgICAvLyA/IFAgP1xuICAgICAgZm9yIChjb25zdCB0cmlwbGUgb2YgdGhpcy50cmlwbGVzKSB7XG4gICAgICAgIGlmICh0cmlwbGUuZ2V0UHJlZGljYXRlKCkudG9TdHJpbmcoKSA9PT0gcHJlZGljYXRlLnRvU3RyaW5nKCkpIHtcbiAgICAgICAgICByZXN1bHRzLnB1c2godHJpcGxlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSBpZiAob2JqZWN0KSB7XG4gICAgICAvLyA/ID8gT1xuICAgICAgZm9yIChjb25zdCB0cmlwbGUgb2YgdGhpcy50cmlwbGVzKSB7XG4gICAgICAgIGlmICh0cmlwbGUuZ2V0T2JqZWN0KCkudG9TdHJpbmcoKSA9PT0gb2JqZWN0LnRvU3RyaW5nKCkpIHtcbiAgICAgICAgICByZXN1bHRzLnB1c2godHJpcGxlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyA/ID8gPyAtIHJldHVybiBhbGxcbiAgICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMudHJpcGxlcyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdHM7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGFsbCBzdWJqZWN0cyBpbiB0aGUgZ3JhcGhcbiAgICovXG4gIHN1YmplY3RzKCk6IFNldDxTdWJqZWN0PiB7XG4gICAgY29uc3Qgc3ViamVjdHMgPSBuZXcgU2V0PFN1YmplY3Q+KCk7XG4gICAgZm9yIChjb25zdCB0cmlwbGUgb2YgdGhpcy50cmlwbGVzKSB7XG4gICAgICBzdWJqZWN0cy5hZGQodHJpcGxlLmdldFN1YmplY3QoKSk7XG4gICAgfVxuICAgIHJldHVybiBzdWJqZWN0cztcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYWxsIHByZWRpY2F0ZXMgaW4gdGhlIGdyYXBoXG4gICAqL1xuICBwcmVkaWNhdGVzKCk6IFNldDxQcmVkaWNhdGU+IHtcbiAgICBjb25zdCBwcmVkaWNhdGVzID0gbmV3IFNldDxQcmVkaWNhdGU+KCk7XG4gICAgZm9yIChjb25zdCB0cmlwbGUgb2YgdGhpcy50cmlwbGVzKSB7XG4gICAgICBwcmVkaWNhdGVzLmFkZCh0cmlwbGUuZ2V0UHJlZGljYXRlKCkpO1xuICAgIH1cbiAgICByZXR1cm4gcHJlZGljYXRlcztcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYWxsIG9iamVjdHMgaW4gdGhlIGdyYXBoXG4gICAqL1xuICBvYmplY3RzKCk6IFNldDxPYmplY3Q+IHtcbiAgICBjb25zdCBvYmplY3RzID0gbmV3IFNldDxPYmplY3Q+KCk7XG4gICAgZm9yIChjb25zdCB0cmlwbGUgb2YgdGhpcy50cmlwbGVzKSB7XG4gICAgICBvYmplY3RzLmFkZCh0cmlwbGUuZ2V0T2JqZWN0KCkpO1xuICAgIH1cbiAgICByZXR1cm4gb2JqZWN0cztcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIHNpemUgb2YgdGhlIGdyYXBoIChudW1iZXIgb2YgdHJpcGxlcylcbiAgICovXG4gIHNpemUoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy50cmlwbGVzLnNpemU7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgdGhlIGdyYXBoIGlzIGVtcHR5XG4gICAqL1xuICBpc0VtcHR5KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnRyaXBsZXMuc2l6ZSA9PT0gMDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhciBhbGwgdHJpcGxlcyBmcm9tIHRoZSBncmFwaFxuICAgKi9cbiAgY2xlYXIoKTogdm9pZCB7XG4gICAgdGhpcy50cmlwbGVzLmNsZWFyKCk7XG4gICAgdGhpcy5zcG8uY2xlYXIoKTtcbiAgICB0aGlzLnBvcy5jbGVhcigpO1xuICAgIHRoaXMub3NwLmNsZWFyKCk7XG4gIH1cblxuICAvKipcbiAgICogTWVyZ2UgYW5vdGhlciBncmFwaCBpbnRvIHRoaXMgb25lXG4gICAqL1xuICBtZXJnZShvdGhlcjogR3JhcGgpOiB2b2lkIHtcbiAgICBmb3IgKGNvbnN0IHRyaXBsZSBvZiBvdGhlci50b0FycmF5KCkpIHtcbiAgICAgIHRoaXMuYWRkKHRyaXBsZSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIG5ldyBncmFwaCB3aXRoIHRyaXBsZXMgbWF0Y2hpbmcgYSBwYXR0ZXJuXG4gICAqL1xuICBmaWx0ZXIoXG4gICAgc3ViamVjdDogU3ViamVjdCB8IG51bGwgPSBudWxsLFxuICAgIHByZWRpY2F0ZTogUHJlZGljYXRlIHwgbnVsbCA9IG51bGwsXG4gICAgb2JqZWN0OiBPYmplY3QgfCBudWxsID0gbnVsbCxcbiAgKTogR3JhcGgge1xuICAgIHJldHVybiBuZXcgR3JhcGgodGhpcy5tYXRjaChzdWJqZWN0LCBwcmVkaWNhdGUsIG9iamVjdCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIENvbnZlcnQgdGhlIGdyYXBoIHRvIGFuIGFycmF5IG9mIHRyaXBsZXNcbiAgICovXG4gIHRvQXJyYXkoKTogVHJpcGxlW10ge1xuICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMudHJpcGxlcyk7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGEgaHVtYW4tcmVhZGFibGUgc3RyaW5nIHJlcHJlc2VudGF0aW9uXG4gICAqL1xuICB0b1N0cmluZygpOiBzdHJpbmcge1xuICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMudHJpcGxlcylcbiAgICAgIC5tYXAoKHQpID0+IHQudG9TdHJpbmcoKSlcbiAgICAgIC5qb2luKFwiXFxuXCIpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBhIGNvcHkgb2YgdGhpcyBncmFwaFxuICAgKi9cbiAgY2xvbmUoKTogR3JhcGgge1xuICAgIHJldHVybiBuZXcgR3JhcGgodGhpcy50b0FycmF5KCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIHR3byBncmFwaHMgYXJlIGVxdWFsXG4gICAqL1xuICBlcXVhbHMob3RoZXI6IEdyYXBoKTogYm9vbGVhbiB7XG4gICAgaWYgKHRoaXMuc2l6ZSgpICE9PSBvdGhlci5zaXplKCkpIHJldHVybiBmYWxzZTtcblxuICAgIGZvciAoY29uc3QgdHJpcGxlIG9mIHRoaXMudHJpcGxlcykge1xuICAgICAgaWYgKCFvdGhlci5oYXModHJpcGxlKSkgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIEFsaWFzIGZvciBhZGQgbWV0aG9kIC0gdXNlZCBieSBzb21lIHNlcnZpY2VzXG4gICAqL1xuICBhZGRUcmlwbGUodHJpcGxlOiBUcmlwbGUpOiB2b2lkIHtcbiAgICB0aGlzLmFkZCh0cmlwbGUpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBhbGwgdHJpcGxlcyAoYWxpYXMgZm9yIHRvQXJyYXkpXG4gICAqL1xuICBnZXRUcmlwbGVzKCk6IFRyaXBsZVtdIHtcbiAgICByZXR1cm4gdGhpcy50b0FycmF5KCk7XG4gIH1cblxuICAvKipcbiAgICogQWxpYXMgZm9yIGhhcyBtZXRob2QgLSB1c2VkIGJ5IHNvbWUgc2VydmljZXNcbiAgICovXG4gIGhhc1RyaXBsZSh0cmlwbGU6IFRyaXBsZSk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmhhcyh0cmlwbGUpO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=