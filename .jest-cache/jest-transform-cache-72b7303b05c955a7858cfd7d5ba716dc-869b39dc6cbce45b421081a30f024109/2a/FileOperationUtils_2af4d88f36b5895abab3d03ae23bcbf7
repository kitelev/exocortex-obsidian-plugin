343f4293a5555854b745e80e931f57da
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FileOperationUtils = void 0;
const obsidian_1 = require("obsidian");
/**
 * Common file operation utilities to eliminate duplication across repositories
 * Implements DRY principle for file handling, YAML processing, and frontmatter operations
 */
class FileOperationUtils {
    /**
     * Build YAML frontmatter with consistent formatting
     */
    static buildYamlFrontmatter(frontmatter) {
        const yamlLines = ["---"];
        for (const [key, value] of Object.entries(frontmatter)) {
            if (value === undefined || value === null)
                continue;
            if (Array.isArray(value)) {
                yamlLines.push(`${key}:`);
                for (const item of value) {
                    const itemStr = String(item);
                    if (this.needsQuotes(itemStr)) {
                        yamlLines.push(`  - "${this.escapeQuotes(itemStr)}"`);
                    }
                    else {
                        yamlLines.push(`  - ${itemStr}`);
                    }
                }
            }
            else if (typeof value === "object" && value !== null) {
                yamlLines.push(`${key}: ${JSON.stringify(value)}`);
            }
            else if (typeof value === "boolean" || typeof value === "number") {
                yamlLines.push(`${key}: ${value}`);
            }
            else {
                const valueStr = String(value);
                if (this.needsQuotes(valueStr)) {
                    yamlLines.push(`${key}: "${this.escapeQuotes(valueStr)}"`);
                }
                else {
                    yamlLines.push(`${key}: ${valueStr}`);
                }
            }
        }
        yamlLines.push("---");
        return yamlLines;
    }
    /**
     * Check if string value needs quotes in YAML
     */
    static needsQuotes(valueStr) {
        return ((valueStr.includes("[[") && valueStr.includes("]]")) ||
            valueStr.includes(":") ||
            valueStr.includes("#") ||
            valueStr.includes("[") ||
            valueStr.includes("]") ||
            valueStr.includes("{") ||
            valueStr.includes("}") ||
            valueStr.includes("|") ||
            valueStr.includes(">") ||
            valueStr.includes("@") ||
            valueStr.includes("`") ||
            valueStr.includes('"') ||
            valueStr.includes("'") ||
            valueStr.startsWith(" ") ||
            valueStr.endsWith(" "));
    }
    /**
     * Escape quotes in string values
     */
    static escapeQuotes(valueStr) {
        return valueStr.replace(/"/g, '\\"');
    }
    /**
     * Extract body content from file, preserving content after frontmatter
     */
    static extractBodyContent(content) {
        if (content.startsWith("---\n")) {
            const endOfFrontmatter = content.indexOf("\n---\n", 4);
            if (endOfFrontmatter !== -1) {
                return content.substring(endOfFrontmatter + 5);
            }
            else {
                // Malformed frontmatter, preserve original content
                return content;
            }
        }
        else {
            // No frontmatter, entire content is body
            return content;
        }
    }
    /**
     * Find file by multiple criteria with fallback logic
     */
    static findFileWithFallback(app, criteria) {
        // First check if asset has a stored file path
        if (criteria.storedPath) {
            const file = app.vault.getAbstractFileByPath(criteria.storedPath);
            if (file instanceof obsidian_1.TFile) {
                return file;
            }
        }
        // If not found by stored path, try by asset ID
        if (criteria.uid) {
            const files = app.vault.getMarkdownFiles();
            for (const file of files) {
                const cache = app.metadataCache.getFileCache(file);
                if (cache?.frontmatter?.["exo__Asset_uid"] === criteria.uid) {
                    return file;
                }
            }
        }
        // If not found by ID, try by filename
        if (criteria.filename) {
            const fileName = criteria.filename.endsWith(".md")
                ? criteria.filename
                : `${criteria.filename}.md`;
            const file = app.vault.getAbstractFileByPath(fileName);
            if (file instanceof obsidian_1.TFile) {
                return file;
            }
        }
        return null;
    }
    /**
     * Update file with new frontmatter and preserve body content
     */
    static async updateFileWithFrontmatter(app, file, frontmatter) {
        const existingContent = await app.vault.read(file);
        const bodyContent = this.extractBodyContent(existingContent);
        const yamlLines = this.buildYamlFrontmatter(frontmatter);
        const newContent = yamlLines.join("\n") + "\n" + bodyContent;
        await app.vault.modify(file, newContent);
    }
    /**
     * Create new file with frontmatter
     */
    static async createFileWithFrontmatter(app, filename, frontmatter) {
        const yamlLines = this.buildYamlFrontmatter(frontmatter);
        const content = yamlLines.join("\n") + "\n";
        await app.vault.create(filename, content);
    }
    /**
     * Get files filtered by frontmatter property
     */
    static getFilesWithProperty(app, propertyKey, propertyValue) {
        const files = app.vault.getMarkdownFiles();
        return files.filter((file) => {
            const cache = app.metadataCache.getFileCache(file);
            const frontmatter = cache?.frontmatter;
            if (!frontmatter || !frontmatter[propertyKey]) {
                return false;
            }
            if (propertyValue === undefined) {
                return true; // Just check property exists
            }
            return frontmatter[propertyKey] === propertyValue;
        });
    }
    /**
     * Merge frontmatter updates with existing frontmatter
     */
    static mergeFrontmatter(existing, updates) {
        return { ...existing, ...updates };
    }
    /**
     * Check if reference matches current asset in various formats
     */
    static isReferencingAsset(referenceValue, assetName) {
        if (!referenceValue)
            return false;
        // Handle both string and array formats
        const refs = Array.isArray(referenceValue)
            ? referenceValue
            : [referenceValue];
        return refs.some((ref) => {
            const cleanRef = String(ref).replace(/\[\[|\]\]/g, "");
            // Match against various possible reference formats
            return (cleanRef === assetName ||
                cleanRef === `${assetName}.md` ||
                ref.includes(`[[${assetName}]]`) ||
                ref.includes(assetName));
        });
    }
}
exports.FileOperationUtils = FileOperationUtils;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL3NoYXJlZC91dGlscy9GaWxlT3BlcmF0aW9uVXRpbHMudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQUEsdUNBQXNDO0FBRXRDOzs7R0FHRztBQUNILE1BQWEsa0JBQWtCO0lBQzdCOztPQUVHO0lBQ0gsTUFBTSxDQUFDLG9CQUFvQixDQUFDLFdBQWdDO1FBQzFELE1BQU0sU0FBUyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFMUIsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLEVBQUU7WUFDdEQsSUFBSSxLQUFLLEtBQUssU0FBUyxJQUFJLEtBQUssS0FBSyxJQUFJO2dCQUFFLFNBQVM7WUFFcEQsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFO2dCQUN4QixTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQztnQkFDMUIsS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLEVBQUU7b0JBQ3hCLE1BQU0sT0FBTyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztvQkFDN0IsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxFQUFFO3dCQUM3QixTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsSUFBSSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7cUJBQ3ZEO3lCQUFNO3dCQUNMLFNBQVMsQ0FBQyxJQUFJLENBQUMsT0FBTyxPQUFPLEVBQUUsQ0FBQyxDQUFDO3FCQUNsQztpQkFDRjthQUNGO2lCQUFNLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxJQUFJLEtBQUssS0FBSyxJQUFJLEVBQUU7Z0JBQ3RELFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLEtBQUssSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsRUFB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QWEsS0FBSyxTQUFTLEVBQUU7Z0JBQy9CLE9BQU8sSUFBSSxDQUFDLENBQUMsNkJBQTZCO2FBQzNDO1lBRUQsT0FBTyxXQUFXLENBQUMsV0FBVyxDQUFDLEtBQUssYUFBYSxDQUFDO1FBQ3BELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLGdCQUFnQixDQUNyQixRQUE2QixFQUM3QixPQUE0QjtRQUU1QixPQUFPLEVBQUUsR0FBRyxRQUFRLEVBQUUsR0FBRyxPQUFPLEVBQUUsQ0FBQztJQUNyQyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsa0JBQWtCLENBQUMsY0FBbUIsRUFBRSxTQUFpQjtRQUM5RCxJQUFJLENBQUMsY0FBYztZQUFFLE9BQU8sS0FBSyxDQUFDO1FBRWxDLHVDQUF1QztRQUN2QyxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLGNBQWMsQ0FBQztZQUN4QyxDQUFDLENBQUMsY0FBYztZQUNoQixDQUFDLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUVyQixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUUsRUFBRTtZQUN2QixNQUFNLFFBQVEsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxFQUFFLENBQUMsQ0FBQztZQUV2RCxtREFBbUQ7WUFDbkQsT0FBTyxDQUNMLFFBQVEsS0FBSyxTQUFTO2dCQUN0QixRQUFRLEtBQUssR0FBRyxTQUFTLEtBQUs7Z0JBQzlCLEdBQUcsQ0FBQyxRQUFRLENBQUMsS0FBSyxTQUFTLElBQUksQ0FBQztnQkFDaEMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FDeEIsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztDQUNGO0FBek5ELGdEQXlOQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva2l0ZWxldi9Eb2N1bWVudHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi9zcmMvc2hhcmVkL3V0aWxzL0ZpbGVPcGVyYXRpb25VdGlscy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHAsIFRGaWxlIH0gZnJvbSBcIm9ic2lkaWFuXCI7XG5cbi8qKlxuICogQ29tbW9uIGZpbGUgb3BlcmF0aW9uIHV0aWxpdGllcyB0byBlbGltaW5hdGUgZHVwbGljYXRpb24gYWNyb3NzIHJlcG9zaXRvcmllc1xuICogSW1wbGVtZW50cyBEUlkgcHJpbmNpcGxlIGZvciBmaWxlIGhhbmRsaW5nLCBZQU1MIHByb2Nlc3NpbmcsIGFuZCBmcm9udG1hdHRlciBvcGVyYXRpb25zXG4gKi9cbmV4cG9ydCBjbGFzcyBGaWxlT3BlcmF0aW9uVXRpbHMge1xuICAvKipcbiAgICogQnVpbGQgWUFNTCBmcm9udG1hdHRlciB3aXRoIGNvbnNpc3RlbnQgZm9ybWF0dGluZ1xuICAgKi9cbiAgc3RhdGljIGJ1aWxkWWFtbEZyb250bWF0dGVyKGZyb250bWF0dGVyOiBSZWNvcmQ8c3RyaW5nLCBhbnk+KTogc3RyaW5nW10ge1xuICAgIGNvbnN0IHlhbWxMaW5lcyA9IFtcIi0tLVwiXTtcblxuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGZyb250bWF0dGVyKSkge1xuICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgfHwgdmFsdWUgPT09IG51bGwpIGNvbnRpbnVlO1xuXG4gICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgeWFtbExpbmVzLnB1c2goYCR7a2V5fTpgKTtcbiAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHZhbHVlKSB7XG4gICAgICAgICAgY29uc3QgaXRlbVN0ciA9IFN0cmluZyhpdGVtKTtcbiAgICAgICAgICBpZiAodGhpcy5uZWVkc1F1b3RlcyhpdGVtU3RyKSkge1xuICAgICAgICAgICAgeWFtbExpbmVzLnB1c2goYCAgLSBcIiR7dGhpcy5lc2NhcGVRdW90ZXMoaXRlbVN0cil9XCJgKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgeWFtbExpbmVzLnB1c2goYCAgLSAke2l0ZW1TdHJ9YCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gXCJvYmplY3RcIiAmJiB2YWx1ZSAhPT0gbnVsbCkge1xuICAgICAgICB5YW1sTGluZXMucHVzaChgJHtrZXl9OiAke0pTT04uc3RyaW5naWZ5KHZhbHVlKX1gKTtcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSBcImJvb2xlYW5cIiB8fCB0eXBlb2YgdmFsdWUgPT09IFwibnVtYmVyXCIpIHtcbiAgICAgICAgeWFtbExpbmVzLnB1c2goYCR7a2V5fTogJHt2YWx1ZX1gKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IHZhbHVlU3RyID0gU3RyaW5nKHZhbHVlKTtcbiAgICAgICAgaWYgKHRoaXMubmVlZHNRdW90ZXModmFsdWVTdHIpKSB7XG4gICAgICAgICAgeWFtbExpbmVzLnB1c2goYCR7a2V5fTogXCIke3RoaXMuZXNjYXBlUXVvdGVzKHZhbHVlU3RyKX1cImApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHlhbWxMaW5lcy5wdXNoKGAke2tleX06ICR7dmFsdWVTdHJ9YCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICB5YW1sTGluZXMucHVzaChcIi0tLVwiKTtcbiAgICByZXR1cm4geWFtbExpbmVzO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIHN0cmluZyB2YWx1ZSBuZWVkcyBxdW90ZXMgaW4gWUFNTFxuICAgKi9cbiAgcHJpdmF0ZSBzdGF0aWMgbmVlZHNRdW90ZXModmFsdWVTdHI6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAoXG4gICAgICAodmFsdWVTdHIuaW5jbHVkZXMoXCJbW1wiKSAmJiB2YWx1ZVN0ci5pbmNsdWRlcyhcIl1dXCIpKSB8fFxuICAgICAgdmFsdWVTdHIuaW5jbHVkZXMoXCI6XCIpIHx8XG4gICAgICB2YWx1ZVN0ci5pbmNsdWRlcyhcIiNcIikgfHxcbiAgICAgIHZhbHVlU3RyLmluY2x1ZGVzKFwiW1wiKSB8fFxuICAgICAgdmFsdWVTdHIuaW5jbHVkZXMoXCJdXCIpIHx8XG4gICAgICB2YWx1ZVN0ci5pbmNsdWRlcyhcIntcIikgfHxcbiAgICAgIHZhbHVlU3RyLmluY2x1ZGVzKFwifVwiKSB8fFxuICAgICAgdmFsdWVTdHIuaW5jbHVkZXMoXCJ8XCIpIHx8XG4gICAgICB2YWx1ZVN0ci5pbmNsdWRlcyhcIj5cIikgfHxcbiAgICAgIHZhbHVlU3RyLmluY2x1ZGVzKFwiQFwiKSB8fFxuICAgICAgdmFsdWVTdHIuaW5jbHVkZXMoXCJgXCIpIHx8XG4gICAgICB2YWx1ZVN0ci5pbmNsdWRlcygnXCInKSB8fFxuICAgICAgdmFsdWVTdHIuaW5jbHVkZXMoXCInXCIpIHx8XG4gICAgICB2YWx1ZVN0ci5zdGFydHNXaXRoKFwiIFwiKSB8fFxuICAgICAgdmFsdWVTdHIuZW5kc1dpdGgoXCIgXCIpXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFc2NhcGUgcXVvdGVzIGluIHN0cmluZyB2YWx1ZXNcbiAgICovXG4gIHByaXZhdGUgc3RhdGljIGVzY2FwZVF1b3Rlcyh2YWx1ZVN0cjogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdmFsdWVTdHIucmVwbGFjZSgvXCIvZywgJ1xcXFxcIicpO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4dHJhY3QgYm9keSBjb250ZW50IGZyb20gZmlsZSwgcHJlc2VydmluZyBjb250ZW50IGFmdGVyIGZyb250bWF0dGVyXG4gICAqL1xuICBzdGF0aWMgZXh0cmFjdEJvZHlDb250ZW50KGNvbnRlbnQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKGNvbnRlbnQuc3RhcnRzV2l0aChcIi0tLVxcblwiKSkge1xuICAgICAgY29uc3QgZW5kT2ZGcm9udG1hdHRlciA9IGNvbnRlbnQuaW5kZXhPZihcIlxcbi0tLVxcblwiLCA0KTtcbiAgICAgIGlmIChlbmRPZkZyb250bWF0dGVyICE9PSAtMSkge1xuICAgICAgICByZXR1cm4gY29udGVudC5zdWJzdHJpbmcoZW5kT2ZGcm9udG1hdHRlciArIDUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gTWFsZm9ybWVkIGZyb250bWF0dGVyLCBwcmVzZXJ2ZSBvcmlnaW5hbCBjb250ZW50XG4gICAgICAgIHJldHVybiBjb250ZW50O1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyBObyBmcm9udG1hdHRlciwgZW50aXJlIGNvbnRlbnQgaXMgYm9keVxuICAgICAgcmV0dXJuIGNvbnRlbnQ7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEZpbmQgZmlsZSBieSBtdWx0aXBsZSBjcml0ZXJpYSB3aXRoIGZhbGxiYWNrIGxvZ2ljXG4gICAqL1xuICBzdGF0aWMgZmluZEZpbGVXaXRoRmFsbGJhY2soXG4gICAgYXBwOiBBcHAsXG4gICAgY3JpdGVyaWE6IHtcbiAgICAgIHVpZD86IHN0cmluZztcbiAgICAgIHN0b3JlZFBhdGg/OiBzdHJpbmc7XG4gICAgICBmaWxlbmFtZT86IHN0cmluZztcbiAgICB9LFxuICApOiBURmlsZSB8IG51bGwge1xuICAgIC8vIEZpcnN0IGNoZWNrIGlmIGFzc2V0IGhhcyBhIHN0b3JlZCBmaWxlIHBhdGhcbiAgICBpZiAoY3JpdGVyaWEuc3RvcmVkUGF0aCkge1xuICAgICAgY29uc3QgZmlsZSA9IGFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoY3JpdGVyaWEuc3RvcmVkUGF0aCk7XG4gICAgICBpZiAoZmlsZSBpbnN0YW5jZW9mIFRGaWxlKSB7XG4gICAgICAgIHJldHVybiBmaWxlO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIElmIG5vdCBmb3VuZCBieSBzdG9yZWQgcGF0aCwgdHJ5IGJ5IGFzc2V0IElEXG4gICAgaWYgKGNyaXRlcmlhLnVpZCkge1xuICAgICAgY29uc3QgZmlsZXMgPSBhcHAudmF1bHQuZ2V0TWFya2Rvd25GaWxlcygpO1xuICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICAgIGNvbnN0IGNhY2hlID0gYXBwLm1ldGFkYXRhQ2FjaGUuZ2V0RmlsZUNhY2hlKGZpbGUpO1xuICAgICAgICBpZiAoY2FjaGU/LmZyb250bWF0dGVyPy5bXCJleG9fX0Fzc2V0X3VpZFwiXSA9PT0gY3JpdGVyaWEudWlkKSB7XG4gICAgICAgICAgcmV0dXJuIGZpbGU7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBJZiBub3QgZm91bmQgYnkgSUQsIHRyeSBieSBmaWxlbmFtZVxuICAgIGlmIChjcml0ZXJpYS5maWxlbmFtZSkge1xuICAgICAgY29uc3QgZmlsZU5hbWUgPSBjcml0ZXJpYS5maWxlbmFtZS5lbmRzV2l0aChcIi5tZFwiKVxuICAgICAgICA/IGNyaXRlcmlhLmZpbGVuYW1lXG4gICAgICAgIDogYCR7Y3JpdGVyaWEuZmlsZW5hbWV9Lm1kYDtcbiAgICAgIGNvbnN0IGZpbGUgPSBhcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKGZpbGVOYW1lKTtcbiAgICAgIGlmIChmaWxlIGluc3RhbmNlb2YgVEZpbGUpIHtcbiAgICAgICAgcmV0dXJuIGZpbGU7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIGZpbGUgd2l0aCBuZXcgZnJvbnRtYXR0ZXIgYW5kIHByZXNlcnZlIGJvZHkgY29udGVudFxuICAgKi9cbiAgc3RhdGljIGFzeW5jIHVwZGF0ZUZpbGVXaXRoRnJvbnRtYXR0ZXIoXG4gICAgYXBwOiBBcHAsXG4gICAgZmlsZTogVEZpbGUsXG4gICAgZnJvbnRtYXR0ZXI6IFJlY29yZDxzdHJpbmcsIGFueT4sXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGV4aXN0aW5nQ29udGVudCA9IGF3YWl0IGFwcC52YXVsdC5yZWFkKGZpbGUpO1xuICAgIGNvbnN0IGJvZHlDb250ZW50ID0gdGhpcy5leHRyYWN0Qm9keUNvbnRlbnQoZXhpc3RpbmdDb250ZW50KTtcbiAgICBjb25zdCB5YW1sTGluZXMgPSB0aGlzLmJ1aWxkWWFtbEZyb250bWF0dGVyKGZyb250bWF0dGVyKTtcbiAgICBjb25zdCBuZXdDb250ZW50ID0geWFtbExpbmVzLmpvaW4oXCJcXG5cIikgKyBcIlxcblwiICsgYm9keUNvbnRlbnQ7XG5cbiAgICBhd2FpdCBhcHAudmF1bHQubW9kaWZ5KGZpbGUsIG5ld0NvbnRlbnQpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBuZXcgZmlsZSB3aXRoIGZyb250bWF0dGVyXG4gICAqL1xuICBzdGF0aWMgYXN5bmMgY3JlYXRlRmlsZVdpdGhGcm9udG1hdHRlcihcbiAgICBhcHA6IEFwcCxcbiAgICBmaWxlbmFtZTogc3RyaW5nLFxuICAgIGZyb250bWF0dGVyOiBSZWNvcmQ8c3RyaW5nLCBhbnk+LFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCB5YW1sTGluZXMgPSB0aGlzLmJ1aWxkWWFtbEZyb250bWF0dGVyKGZyb250bWF0dGVyKTtcbiAgICBjb25zdCBjb250ZW50ID0geWFtbExpbmVzLmpvaW4oXCJcXG5cIikgKyBcIlxcblwiO1xuICAgIGF3YWl0IGFwcC52YXVsdC5jcmVhdGUoZmlsZW5hbWUsIGNvbnRlbnQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBmaWxlcyBmaWx0ZXJlZCBieSBmcm9udG1hdHRlciBwcm9wZXJ0eVxuICAgKi9cbiAgc3RhdGljIGdldEZpbGVzV2l0aFByb3BlcnR5KFxuICAgIGFwcDogQXBwLFxuICAgIHByb3BlcnR5S2V5OiBzdHJpbmcsXG4gICAgcHJvcGVydHlWYWx1ZT86IGFueSxcbiAgKTogVEZpbGVbXSB7XG4gICAgY29uc3QgZmlsZXMgPSBhcHAudmF1bHQuZ2V0TWFya2Rvd25GaWxlcygpO1xuICAgIHJldHVybiBmaWxlcy5maWx0ZXIoKGZpbGUpID0+IHtcbiAgICAgIGNvbnN0IGNhY2hlID0gYXBwLm1ldGFkYXRhQ2FjaGUuZ2V0RmlsZUNhY2hlKGZpbGUpO1xuICAgICAgY29uc3QgZnJvbnRtYXR0ZXIgPSBjYWNoZT8uZnJvbnRtYXR0ZXI7XG5cbiAgICAgIGlmICghZnJvbnRtYXR0ZXIgfHwgIWZyb250bWF0dGVyW3Byb3BlcnR5S2V5XSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG5cbiAgICAgIGlmIChwcm9wZXJ0eVZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7IC8vIEp1c3QgY2hlY2sgcHJvcGVydHkgZXhpc3RzXG4gICAgICB9XG5cbiAgICAgIHJldHVybiBmcm9udG1hdHRlcltwcm9wZXJ0eUtleV0gPT09IHByb3BlcnR5VmFsdWU7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogTWVyZ2UgZnJvbnRtYXR0ZXIgdXBkYXRlcyB3aXRoIGV4aXN0aW5nIGZyb250bWF0dGVyXG4gICAqL1xuICBzdGF0aWMgbWVyZ2VGcm9udG1hdHRlcihcbiAgICBleGlzdGluZzogUmVjb3JkPHN0cmluZywgYW55PixcbiAgICB1cGRhdGVzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+LFxuICApOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHtcbiAgICByZXR1cm4geyAuLi5leGlzdGluZywgLi4udXBkYXRlcyB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIHJlZmVyZW5jZSBtYXRjaGVzIGN1cnJlbnQgYXNzZXQgaW4gdmFyaW91cyBmb3JtYXRzXG4gICAqL1xuICBzdGF0aWMgaXNSZWZlcmVuY2luZ0Fzc2V0KHJlZmVyZW5jZVZhbHVlOiBhbnksIGFzc2V0TmFtZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgaWYgKCFyZWZlcmVuY2VWYWx1ZSkgcmV0dXJuIGZhbHNlO1xuXG4gICAgLy8gSGFuZGxlIGJvdGggc3RyaW5nIGFuZCBhcnJheSBmb3JtYXRzXG4gICAgY29uc3QgcmVmcyA9IEFycmF5LmlzQXJyYXkocmVmZXJlbmNlVmFsdWUpXG4gICAgICA/IHJlZmVyZW5jZVZhbHVlXG4gICAgICA6IFtyZWZlcmVuY2VWYWx1ZV07XG5cbiAgICByZXR1cm4gcmVmcy5zb21lKChyZWYpID0+IHtcbiAgICAgIGNvbnN0IGNsZWFuUmVmID0gU3RyaW5nKHJlZikucmVwbGFjZSgvXFxbXFxbfFxcXVxcXS9nLCBcIlwiKTtcblxuICAgICAgLy8gTWF0Y2ggYWdhaW5zdCB2YXJpb3VzIHBvc3NpYmxlIHJlZmVyZW5jZSBmb3JtYXRzXG4gICAgICByZXR1cm4gKFxuICAgICAgICBjbGVhblJlZiA9PT0gYXNzZXROYW1lIHx8XG4gICAgICAgIGNsZWFuUmVmID09PSBgJHthc3NldE5hbWV9Lm1kYCB8fFxuICAgICAgICByZWYuaW5jbHVkZXMoYFtbJHthc3NldE5hbWV9XV1gKSB8fFxuICAgICAgICByZWYuaW5jbHVkZXMoYXNzZXROYW1lKVxuICAgICAgKTtcbiAgICB9KTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9