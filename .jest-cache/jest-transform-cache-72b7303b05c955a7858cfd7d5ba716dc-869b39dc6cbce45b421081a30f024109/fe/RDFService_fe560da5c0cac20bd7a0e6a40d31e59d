b302e63dfc3393fc4d67dbf040cc632a
"use strict";
/**
 * RDF Service - Coordinates RDF operations using specialized services
 * Follows Single Responsibility Principle by delegating to specific services
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.RDFService = void 0;
const tslib_1 = require("tslib");
const obsidian_1 = require("obsidian");
const Graph_1 = require("../../domain/semantic/core/Graph");
const Triple_1 = require("../../domain/semantic/core/Triple");
const Result_1 = require("../../domain/core/Result");
const RDFSerializer_1 = require("./RDFSerializer");
const RDFParser_1 = require("./RDFParser");
const NamespaceManager_1 = require("./NamespaceManager");
const RDFValidator_1 = require("./RDFValidator");
const RDFFileManager_1 = require("./RDFFileManager");
class RDFService {
    constructor(app, namespaceManager) {
        this.app = app;
        this.namespaceManager = namespaceManager || new NamespaceManager_1.NamespaceManager();
        this.serializer = new RDFSerializer_1.RDFSerializer(this.namespaceManager);
        this.parser = new RDFParser_1.RDFParser(this.namespaceManager);
        this.validator = new RDFValidator_1.RDFValidator();
        this.fileManager = new RDFFileManager_1.RDFFileManager(app);
    }
    /**
     * Export graph to RDF format
     */
    exportGraph(graph, options) {
        var _a, _b;
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const validationResult = this.validator.validateExportOptions(options);
                if (validationResult.isFailure) {
                    return Result_1.Result.fail(validationResult.errorValue());
                }
                const serializationOptions = {
                    format: options.format,
                    includeComments: (_a = options.includeComments) !== null && _a !== void 0 ? _a : true,
                    prettyPrint: (_b = options.prettyPrint) !== null && _b !== void 0 ? _b : true,
                    baseIRI: options.baseIRI,
                    namespaceManager: this.namespaceManager
                };
                const result = this.serializer.serialize(graph, serializationOptions);
                if (result.isFailure) {
                    return result;
                }
                const serializedData = result.getValue();
                if (options.saveToVault) {
                    const fileName = this.fileManager.generateFileName(options.fileName, options.format);
                    const filePath = options.targetFolder ? `${options.targetFolder}/${fileName}` : fileName;
                    const saveResult = yield this.fileManager.saveToVault(serializedData.content, filePath);
                    if (saveResult.isFailure) {
                        return Result_1.Result.fail(saveResult.errorValue());
                    }
                    new obsidian_1.Notice(`Exported ${serializedData.tripleCount} triples to ${filePath}`);
                }
                return result;
            }
            catch (error) {
                return Result_1.Result.fail(`Export failed: ${error.message}`);
            }
        });
    }
    /**
     * Import RDF data and merge with existing graph
     */
    importRDF(content, graph, options) {
        var _a, _b;
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const validationResult = this.validator.validateImportOptions(options);
                if (validationResult.isFailure) {
                    return Result_1.Result.fail(validationResult.errorValue());
                }
                const parseOptions = {
                    format: options.format,
                    baseIRI: options.baseIRI,
                    namespaceManager: this.namespaceManager,
                    validateInput: (_a = options.validateInput) !== null && _a !== void 0 ? _a : true,
                    strictMode: (_b = options.strictMode) !== null && _b !== void 0 ? _b : false
                };
                const parseResult = this.parser.parse(content, parseOptions);
                if (parseResult.isFailure) {
                    return Result_1.Result.fail(`Import parsing failed: ${parseResult.errorValue()}`);
                }
                const imported = parseResult.getValue();
                if (options.validateInput) {
                    const validationOptions = {
                        strictMode: options.strictMode,
                        checkDuplicates: true,
                        checkNamespaces: true,
                        checkLiterals: true
                    };
                    const graphValidation = this.validator.validateGraph(imported.graph, validationOptions);
                    if (graphValidation.isFailure) {
                        return Result_1.Result.fail(graphValidation.errorValue());
                    }
                    const validation = graphValidation.getValue();
                    if (!validation.isValid && options.strictMode) {
                        const errorMessages = validation.errors.map(e => e.message).join('; ');
                        return Result_1.Result.fail(`Import validation failed: ${errorMessages}`);
                    }
                    if (validation.warnings.length > 0) {
                        new obsidian_1.Notice(`Import completed with ${validation.warnings.length} warnings`);
                    }
                }
                let finalGraph;
                if (options.mergeMode === 'replace') {
                    finalGraph = imported.graph;
                }
                else {
                    finalGraph = graph.clone();
                    finalGraph.merge(imported.graph);
                }
                for (const [prefix, namespace] of Object.entries(imported.namespaces)) {
                    if (!this.namespaceManager.hasPrefix(prefix)) {
                        this.namespaceManager.addBinding(prefix, namespace);
                    }
                }
                return Result_1.Result.ok({ graph: finalGraph, imported });
            }
            catch (error) {
                return Result_1.Result.fail(`Import failed: ${error.message}`);
            }
        });
    }
    /**
     * Import RDF from vault file
     */
    importFromVaultFile(file, graph, options) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const contentResult = yield this.fileManager.readFromVault(file.path);
                if (contentResult.isFailure) {
                    return Result_1.Result.fail(contentResult.errorValue());
                }
                if (!options.format) {
                    options.format = this.fileManager.detectFormatFromExtension(file.name);
                }
                return yield this.importRDF(contentResult.getValue(), graph, options);
            }
            catch (error) {
                return Result_1.Result.fail(`Failed to import from vault file: ${error.message}`);
            }
        });
    }
    /**
     * Export SPARQL query results
     */
    exportQueryResults(results, format, fileName, saveToVault = true) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const graph = this.convertQueryResultsToGraph(results);
                const options = {
                    format,
                    fileName: fileName || 'sparql-results',
                    saveToVault,
                    includeComments: true,
                    prettyPrint: true,
                    targetFolder: 'exports'
                };
                return yield this.exportGraph(graph, options);
            }
            catch (error) {
                return Result_1.Result.fail(`Query results export failed: ${error.message}`);
            }
        });
    }
    /**
     * Validate a graph
     */
    validateGraph(graph, options) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return this.validator.validateGraph(graph, options);
        });
    }
    /**
     * List RDF files in vault
     */
    listRDFFiles(folder) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return this.fileManager.listRDFFiles(folder);
        });
    }
    /**
     * Convert SPARQL query results to graph
     */
    convertQueryResultsToGraph(results) {
        const graph = new Graph_1.Graph();
        for (const result of results) {
            if (result.subject && result.predicate && result.object) {
                try {
                    const subject = this.createNodeFromValue(result.subject);
                    const predicate = this.createNodeFromValue(result.predicate);
                    const object = this.createNodeFromValue(result.object);
                    if (subject && predicate && object) {
                        const triple = new Triple_1.Triple(subject, predicate, object);
                        graph.add(triple);
                    }
                }
                catch (error) {
                    console.warn('Failed to convert query result to triple:', error);
                }
            }
        }
        return graph;
    }
    /**
     * Create RDF node from query result value
     */
    createNodeFromValue(value) {
        if (typeof value === 'string') {
            if (value.startsWith('_:')) {
                return new Triple_1.BlankNode(value);
            }
            else if (value.startsWith('http://') || value.startsWith('https://') || value.includes(':')) {
                try {
                    return new Triple_1.IRI(value);
                }
                catch (_a) {
                    return Triple_1.Literal.string(value);
                }
            }
            else {
                return Triple_1.Literal.string(value);
            }
        }
        else if (typeof value === 'number') {
            return Number.isInteger(value) ? Triple_1.Literal.integer(value) : Triple_1.Literal.double(value);
        }
        else if (typeof value === 'boolean') {
            return Triple_1.Literal.boolean(value);
        }
        else if (value && typeof value === 'object') {
            if (value.type === 'uri' || value.type === 'iri') {
                return new Triple_1.IRI(value.value);
            }
            else if (value.type === 'bnode') {
                return new Triple_1.BlankNode(value.value);
            }
            else if (value.type === 'literal') {
                if (value.datatype) {
                    return new Triple_1.Literal(value.value, new Triple_1.IRI(value.datatype));
                }
                else if (value.lang) {
                    return new Triple_1.Literal(value.value, undefined, value.lang);
                }
                else {
                    return new Triple_1.Literal(value.value);
                }
            }
        }
        return null;
    }
    /**
     * Get namespace manager instance
     */
    getNamespaceManager() {
        return this.namespaceManager;
    }
    /**
     * Get supported export formats
     */
    getSupportedFormats() {
        return ['turtle', 'n-triples', 'json-ld', 'rdf-xml'];
    }
    /**
     * Get format information
     */
    getFormatInfo(format) {
        const formatMap = {
            'turtle': { extension: '.ttl', mimeType: 'text/turtle', name: 'Turtle' },
            'n-triples': { extension: '.nt', mimeType: 'application/n-triples', name: 'N-Triples' },
            'json-ld': { extension: '.jsonld', mimeType: 'application/ld+json', name: 'JSON-LD' },
            'rdf-xml': { extension: '.rdf', mimeType: 'application/rdf+xml', name: 'RDF/XML' }
        };
        return formatMap[format];
    }
}
exports.RDFService = RDFService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2FwcGxpY2F0aW9uL3NlcnZpY2VzL1JERlNlcnZpY2UudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7OztBQUVILHVDQUE4QztBQUM5Qyw0REFBeUQ7QUFDekQsOERBQW9GO0FBQ3BGLHFEQUFrRDtBQUNsRCxtREFBc0c7QUFDdEcsMkNBQW1FO0FBQ25FLHlEQUFzRDtBQUN0RCxpREFBaUU7QUFDakUscURBQWtEO0FBc0JsRCxNQUFhLFVBQVU7SUFPbkIsWUFDWSxHQUFRLEVBQ2hCLGdCQUFtQztRQUQzQixRQUFHLEdBQUgsR0FBRyxDQUFLO1FBR2hCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxnQkFBZ0IsSUFBSSxJQUFJLG1DQUFnQixFQUFFLENBQUM7UUFDbkUsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLDZCQUFhLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDM0QsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLHFCQUFTLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFDbkQsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLDJCQUFZLEVBQUUsQ0FBQztRQUNwQyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksK0JBQWMsQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBRUQ7O09BRUc7SUFDRyxXQUFXLENBQUMsS0FBWSxFQUFFLE9BQXlCOzs7WUFDckQsSUFBSTtnQkFDQSxNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMscUJBQXFCLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQ3ZFLElBQUksZ0JBQWdCLENBQUMsU0FBUyxFQUFFO29CQUM1QixPQUFPLGVBQU0sQ0FBQyxJQUFJLENBQXNCLGdCQUFnQixDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUM7aUJBQzFFO2dCQUVELE1BQU0sb0JBQW9CLEdBQXlCO29CQUMvQyxNQUFNLEVB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aWFuLXBsdWdpbi9zcmMvYXBwbGljYXRpb24vc2VydmljZXMvUkRGU2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFJERiBTZXJ2aWNlIC0gQ29vcmRpbmF0ZXMgUkRGIG9wZXJhdGlvbnMgdXNpbmcgc3BlY2lhbGl6ZWQgc2VydmljZXNcbiAqIEZvbGxvd3MgU2luZ2xlIFJlc3BvbnNpYmlsaXR5IFByaW5jaXBsZSBieSBkZWxlZ2F0aW5nIHRvIHNwZWNpZmljIHNlcnZpY2VzXG4gKi9cblxuaW1wb3J0IHsgQXBwLCBOb3RpY2UsIFRGaWxlIH0gZnJvbSAnb2JzaWRpYW4nO1xuaW1wb3J0IHsgR3JhcGggfSBmcm9tICcuLi8uLi9kb21haW4vc2VtYW50aWMvY29yZS9HcmFwaCc7XG5pbXBvcnQgeyBUcmlwbGUsIElSSSwgQmxhbmtOb2RlLCBMaXRlcmFsIH0gZnJvbSAnLi4vLi4vZG9tYWluL3NlbWFudGljL2NvcmUvVHJpcGxlJztcbmltcG9ydCB7IFJlc3VsdCB9IGZyb20gJy4uLy4uL2RvbWFpbi9jb3JlL1Jlc3VsdCc7XG5pbXBvcnQgeyBSREZTZXJpYWxpemVyLCBSREZGb3JtYXQsIFNlcmlhbGl6YXRpb25PcHRpb25zLCBTZXJpYWxpemF0aW9uUmVzdWx0IH0gZnJvbSAnLi9SREZTZXJpYWxpemVyJztcbmltcG9ydCB7IFJERlBhcnNlciwgUGFyc2VPcHRpb25zLCBQYXJzZVJlc3VsdCB9IGZyb20gJy4vUkRGUGFyc2VyJztcbmltcG9ydCB7IE5hbWVzcGFjZU1hbmFnZXIgfSBmcm9tICcuL05hbWVzcGFjZU1hbmFnZXInO1xuaW1wb3J0IHsgUkRGVmFsaWRhdG9yLCBWYWxpZGF0aW9uT3B0aW9ucyB9IGZyb20gJy4vUkRGVmFsaWRhdG9yJztcbmltcG9ydCB7IFJERkZpbGVNYW5hZ2VyIH0gZnJvbSAnLi9SREZGaWxlTWFuYWdlcic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgUkRGRXhwb3J0T3B0aW9ucyB7XG4gICAgZm9ybWF0OiBSREZGb3JtYXQ7XG4gICAgaW5jbHVkZUNvbW1lbnRzPzogYm9vbGVhbjtcbiAgICBwcmV0dHlQcmludD86IGJvb2xlYW47XG4gICAgYmFzZUlSST86IHN0cmluZztcbiAgICBmaWxlTmFtZT86IHN0cmluZztcbiAgICBzYXZlVG9WYXVsdD86IGJvb2xlYW47XG4gICAgdGFyZ2V0Rm9sZGVyPzogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFJERkltcG9ydE9wdGlvbnMge1xuICAgIGZvcm1hdD86IFJERkZvcm1hdDtcbiAgICBtZXJnZU1vZGU6ICdtZXJnZScgfCAncmVwbGFjZSc7XG4gICAgdmFsaWRhdGVJbnB1dD86IGJvb2xlYW47XG4gICAgc3RyaWN0TW9kZT86IGJvb2xlYW47XG4gICAgYmFzZUlSST86IHN0cmluZztcbn1cblxuZXhwb3J0IHR5cGUgeyBWYWxpZGF0aW9uRXJyb3IgfSBmcm9tICcuL1JERlZhbGlkYXRvcic7XG5cbmV4cG9ydCBjbGFzcyBSREZTZXJ2aWNlIHtcbiAgICBwcml2YXRlIHNlcmlhbGl6ZXI6IFJERlNlcmlhbGl6ZXI7XG4gICAgcHJpdmF0ZSBwYXJzZXI6IFJERlBhcnNlcjtcbiAgICBwcml2YXRlIHZhbGlkYXRvcjogUkRGVmFsaWRhdG9yO1xuICAgIHByaXZhdGUgZmlsZU1hbmFnZXI6IFJERkZpbGVNYW5hZ2VyO1xuICAgIHByaXZhdGUgbmFtZXNwYWNlTWFuYWdlcjogTmFtZXNwYWNlTWFuYWdlcjtcbiAgICBcbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBhcHA6IEFwcCxcbiAgICAgICAgbmFtZXNwYWNlTWFuYWdlcj86IE5hbWVzcGFjZU1hbmFnZXJcbiAgICApIHtcbiAgICAgICAgdGhpcy5uYW1lc3BhY2VNYW5hZ2VyID0gbmFtZXNwYWNlTWFuYWdlciB8fCBuZXcgTmFtZXNwYWNlTWFuYWdlcigpO1xuICAgICAgICB0aGlzLnNlcmlhbGl6ZXIgPSBuZXcgUkRGU2VyaWFsaXplcih0aGlzLm5hbWVzcGFjZU1hbmFnZXIpO1xuICAgICAgICB0aGlzLnBhcnNlciA9IG5ldyBSREZQYXJzZXIodGhpcy5uYW1lc3BhY2VNYW5hZ2VyKTtcbiAgICAgICAgdGhpcy52YWxpZGF0b3IgPSBuZXcgUkRGVmFsaWRhdG9yKCk7XG4gICAgICAgIHRoaXMuZmlsZU1hbmFnZXIgPSBuZXcgUkRGRmlsZU1hbmFnZXIoYXBwKTtcbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogRXhwb3J0IGdyYXBoIHRvIFJERiBmb3JtYXRcbiAgICAgKi9cbiAgICBhc3luYyBleHBvcnRHcmFwaChncmFwaDogR3JhcGgsIG9wdGlvbnM6IFJERkV4cG9ydE9wdGlvbnMpOiBQcm9taXNlPFJlc3VsdDxTZXJpYWxpemF0aW9uUmVzdWx0Pj4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgdmFsaWRhdGlvblJlc3VsdCA9IHRoaXMudmFsaWRhdG9yLnZhbGlkYXRlRXhwb3J0T3B0aW9ucyhvcHRpb25zKTtcbiAgICAgICAgICAgIGlmICh2YWxpZGF0aW9uUmVzdWx0LmlzRmFpbHVyZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxTZXJpYWxpemF0aW9uUmVzdWx0Pih2YWxpZGF0aW9uUmVzdWx0LmVycm9yVmFsdWUoKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IHNlcmlhbGl6YXRpb25PcHRpb25zOiBTZXJpYWxpemF0aW9uT3B0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICBmb3JtYXQ6IG9wdGlvbnMuZm9ybWF0LFxuICAgICAgICAgICAgICAgIGluY2x1ZGVDb21tZW50czogb3B0aW9ucy5pbmNsdWRlQ29tbWVudHMgPz8gdHJ1ZSxcbiAgICAgICAgICAgICAgICBwcmV0dHlQcmludDogb3B0aW9ucy5wcmV0dHlQcmludCA/PyB0cnVlLFxuICAgICAgICAgICAgICAgIGJhc2VJUkk6IG9wdGlvbnMuYmFzZUlSSSxcbiAgICAgICAgICAgICAgICBuYW1lc3BhY2VNYW5hZ2VyOiB0aGlzLm5hbWVzcGFjZU1hbmFnZXJcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuc2VyaWFsaXplci5zZXJpYWxpemUoZ3JhcGgsIHNlcmlhbGl6YXRpb25PcHRpb25zKTtcbiAgICAgICAgICAgIGlmIChyZXN1bHQuaXNGYWlsdXJlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3Qgc2VyaWFsaXplZERhdGEgPSByZXN1bHQuZ2V0VmFsdWUoKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKG9wdGlvbnMuc2F2ZVRvVmF1bHQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBmaWxlTmFtZSA9IHRoaXMuZmlsZU1hbmFnZXIuZ2VuZXJhdGVGaWxlTmFtZShvcHRpb25zLmZpbGVOYW1lLCBvcHRpb25zLmZvcm1hdCk7XG4gICAgICAgICAgICAgICAgY29uc3QgZmlsZVBhdGggPSBvcHRpb25zLnRhcmdldEZvbGRlciA/IGAke29wdGlvbnMudGFyZ2V0Rm9sZGVyfS8ke2ZpbGVOYW1lfWAgOiBmaWxlTmFtZTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBjb25zdCBzYXZlUmVzdWx0ID0gYXdhaXQgdGhpcy5maWxlTWFuYWdlci5zYXZlVG9WYXVsdChzZXJpYWxpemVkRGF0YS5jb250ZW50LCBmaWxlUGF0aCk7XG4gICAgICAgICAgICAgICAgaWYgKHNhdmVSZXN1bHQuaXNGYWlsdXJlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbChzYXZlUmVzdWx0LmVycm9yVmFsdWUoKSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIG5ldyBOb3RpY2UoYEV4cG9ydGVkICR7c2VyaWFsaXplZERhdGEudHJpcGxlQ291bnR9IHRyaXBsZXMgdG8gJHtmaWxlUGF0aH1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbChgRXhwb3J0IGZhaWxlZDogJHtlcnJvci5tZXNzYWdlfWApO1xuICAgICAgICB9XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIEltcG9ydCBSREYgZGF0YSBhbmQgbWVyZ2Ugd2l0aCBleGlzdGluZyBncmFwaFxuICAgICAqL1xuICAgIGFzeW5jIGltcG9ydFJERihcbiAgICAgICAgY29udGVudDogc3RyaW5nLCBcbiAgICAgICAgZ3JhcGg6IEdyYXBoLCBcbiAgICAgICAgb3B0aW9uczogUkRGSW1wb3J0T3B0aW9uc1xuICAgICk6IFByb21pc2U8UmVzdWx0PHsgZ3JhcGg6IEdyYXBoOyBpbXBvcnRlZDogUGFyc2VSZXN1bHQgfT4+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHZhbGlkYXRpb25SZXN1bHQgPSB0aGlzLnZhbGlkYXRvci52YWxpZGF0ZUltcG9ydE9wdGlvbnMob3B0aW9ucyk7XG4gICAgICAgICAgICBpZiAodmFsaWRhdGlvblJlc3VsdC5pc0ZhaWx1cmUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8eyBncmFwaDogR3JhcGg7IGltcG9ydGVkOiBQYXJzZVJlc3VsdCB9Pih2YWxpZGF0aW9uUmVzdWx0LmVycm9yVmFsdWUoKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IHBhcnNlT3B0aW9uczogUGFyc2VPcHRpb25zID0ge1xuICAgICAgICAgICAgICAgIGZvcm1hdDogb3B0aW9ucy5mb3JtYXQsXG4gICAgICAgICAgICAgICAgYmFzZUlSSTogb3B0aW9ucy5iYXNlSVJJLFxuICAgICAgICAgICAgICAgIG5hbWVzcGFjZU1hbmFnZXI6IHRoaXMubmFtZXNwYWNlTWFuYWdlcixcbiAgICAgICAgICAgICAgICB2YWxpZGF0ZUlucHV0OiBvcHRpb25zLnZhbGlkYXRlSW5wdXQgPz8gdHJ1ZSxcbiAgICAgICAgICAgICAgICBzdHJpY3RNb2RlOiBvcHRpb25zLnN0cmljdE1vZGUgPz8gZmFsc2VcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IHBhcnNlUmVzdWx0ID0gdGhpcy5wYXJzZXIucGFyc2UoY29udGVudCwgcGFyc2VPcHRpb25zKTtcbiAgICAgICAgICAgIGlmIChwYXJzZVJlc3VsdC5pc0ZhaWx1cmUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWwoYEltcG9ydCBwYXJzaW5nIGZhaWxlZDogJHtwYXJzZVJlc3VsdC5lcnJvclZhbHVlKCl9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IGltcG9ydGVkID0gcGFyc2VSZXN1bHQuZ2V0VmFsdWUoKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKG9wdGlvbnMudmFsaWRhdGVJbnB1dCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkYXRpb25PcHRpb25zOiBWYWxpZGF0aW9uT3B0aW9ucyA9IHtcbiAgICAgICAgICAgICAgICAgICAgc3RyaWN0TW9kZTogb3B0aW9ucy5zdHJpY3RNb2RlLFxuICAgICAgICAgICAgICAgICAgICBjaGVja0R1cGxpY2F0ZXM6IHRydWUsXG4gICAgICAgICAgICAgICAgICAgIGNoZWNrTmFtZXNwYWNlczogdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgY2hlY2tMaXRlcmFsczogdHJ1ZVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY29uc3QgZ3JhcGhWYWxpZGF0aW9uID0gdGhpcy52YWxpZGF0b3IudmFsaWRhdGVHcmFwaChpbXBvcnRlZC5ncmFwaCwgdmFsaWRhdGlvbk9wdGlvbnMpO1xuICAgICAgICAgICAgICAgIGlmIChncmFwaFZhbGlkYXRpb24uaXNGYWlsdXJlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbChncmFwaFZhbGlkYXRpb24uZXJyb3JWYWx1ZSgpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgY29uc3QgdmFsaWRhdGlvbiA9IGdyYXBoVmFsaWRhdGlvbi5nZXRWYWx1ZSgpO1xuICAgICAgICAgICAgICAgIGlmICghdmFsaWRhdGlvbi5pc1ZhbGlkICYmIG9wdGlvbnMuc3RyaWN0TW9kZSkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBlcnJvck1lc3NhZ2VzID0gdmFsaWRhdGlvbi5lcnJvcnMubWFwKGUgPT4gZS5tZXNzYWdlKS5qb2luKCc7ICcpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWwoYEltcG9ydCB2YWxpZGF0aW9uIGZhaWxlZDogJHtlcnJvck1lc3NhZ2VzfWApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICBpZiAodmFsaWRhdGlvbi53YXJuaW5ncy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIG5ldyBOb3RpY2UoYEltcG9ydCBjb21wbGV0ZWQgd2l0aCAke3ZhbGlkYXRpb24ud2FybmluZ3MubGVuZ3RofSB3YXJuaW5nc2ApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgbGV0IGZpbmFsR3JhcGg6IEdyYXBoO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAob3B0aW9ucy5tZXJnZU1vZGUgPT09ICdyZXBsYWNlJykge1xuICAgICAgICAgICAgICAgIGZpbmFsR3JhcGggPSBpbXBvcnRlZC5ncmFwaDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZmluYWxHcmFwaCA9IGdyYXBoLmNsb25lKCk7XG4gICAgICAgICAgICAgICAgZmluYWxHcmFwaC5tZXJnZShpbXBvcnRlZC5ncmFwaCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGZvciAoY29uc3QgW3ByZWZpeCwgbmFtZXNwYWNlXSBvZiBPYmplY3QuZW50cmllcyhpbXBvcnRlZC5uYW1lc3BhY2VzKSkge1xuICAgICAgICAgICAgICAgIGlmICghdGhpcy5uYW1lc3BhY2VNYW5hZ2VyLmhhc1ByZWZpeChwcmVmaXgpKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMubmFtZXNwYWNlTWFuYWdlci5hZGRCaW5kaW5nKHByZWZpeCwgbmFtZXNwYWNlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQub2soeyBncmFwaDogZmluYWxHcmFwaCwgaW1wb3J0ZWQgfSk7XG4gICAgICAgICAgICBcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbChgSW1wb3J0IGZhaWxlZDogJHtlcnJvci5tZXNzYWdlfWApO1xuICAgICAgICB9XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIEltcG9ydCBSREYgZnJvbSB2YXVsdCBmaWxlXG4gICAgICovXG4gICAgYXN5bmMgaW1wb3J0RnJvbVZhdWx0RmlsZShmaWxlOiBURmlsZSwgZ3JhcGg6IEdyYXBoLCBvcHRpb25zOiBSREZJbXBvcnRPcHRpb25zKTogUHJvbWlzZTxSZXN1bHQ8eyBncmFwaDogR3JhcGg7IGltcG9ydGVkOiBQYXJzZVJlc3VsdCB9Pj4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgY29udGVudFJlc3VsdCA9IGF3YWl0IHRoaXMuZmlsZU1hbmFnZXIucmVhZEZyb21WYXVsdChmaWxlLnBhdGgpO1xuICAgICAgICAgICAgaWYgKGNvbnRlbnRSZXN1bHQuaXNGYWlsdXJlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsKGNvbnRlbnRSZXN1bHQuZXJyb3JWYWx1ZSgpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKCFvcHRpb25zLmZvcm1hdCkge1xuICAgICAgICAgICAgICAgIG9wdGlvbnMuZm9ybWF0ID0gdGhpcy5maWxlTWFuYWdlci5kZXRlY3RGb3JtYXRGcm9tRXh0ZW5zaW9uKGZpbGUubmFtZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmltcG9ydFJERihjb250ZW50UmVzdWx0LmdldFZhbHVlKCksIGdyYXBoLCBvcHRpb25zKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbChgRmFpbGVkIHRvIGltcG9ydCBmcm9tIHZhdWx0IGZpbGU6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBFeHBvcnQgU1BBUlFMIHF1ZXJ5IHJlc3VsdHNcbiAgICAgKi9cbiAgICBhc3luYyBleHBvcnRRdWVyeVJlc3VsdHMoXG4gICAgICAgIHJlc3VsdHM6IGFueVtdLCBcbiAgICAgICAgZm9ybWF0OiBSREZGb3JtYXQsXG4gICAgICAgIGZpbGVOYW1lPzogc3RyaW5nLFxuICAgICAgICBzYXZlVG9WYXVsdDogYm9vbGVhbiA9IHRydWVcbiAgICApOiBQcm9taXNlPFJlc3VsdDxTZXJpYWxpemF0aW9uUmVzdWx0Pj4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgZ3JhcGggPSB0aGlzLmNvbnZlcnRRdWVyeVJlc3VsdHNUb0dyYXBoKHJlc3VsdHMpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCBvcHRpb25zOiBSREZFeHBvcnRPcHRpb25zID0ge1xuICAgICAgICAgICAgICAgIGZvcm1hdCxcbiAgICAgICAgICAgICAgICBmaWxlTmFtZTogZmlsZU5hbWUgfHwgJ3NwYXJxbC1yZXN1bHRzJyxcbiAgICAgICAgICAgICAgICBzYXZlVG9WYXVsdCxcbiAgICAgICAgICAgICAgICBpbmNsdWRlQ29tbWVudHM6IHRydWUsXG4gICAgICAgICAgICAgICAgcHJldHR5UHJpbnQ6IHRydWUsXG4gICAgICAgICAgICAgICAgdGFyZ2V0Rm9sZGVyOiAnZXhwb3J0cydcbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLmV4cG9ydEdyYXBoKGdyYXBoLCBvcHRpb25zKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbChgUXVlcnkgcmVzdWx0cyBleHBvcnQgZmFpbGVkOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogVmFsaWRhdGUgYSBncmFwaFxuICAgICAqL1xuICAgIGFzeW5jIHZhbGlkYXRlR3JhcGgoZ3JhcGg6IEdyYXBoLCBvcHRpb25zPzogVmFsaWRhdGlvbk9wdGlvbnMpOiBQcm9taXNlPFJlc3VsdDxhbnk+PiB7XG4gICAgICAgIHJldHVybiB0aGlzLnZhbGlkYXRvci52YWxpZGF0ZUdyYXBoKGdyYXBoLCBvcHRpb25zKTtcbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogTGlzdCBSREYgZmlsZXMgaW4gdmF1bHRcbiAgICAgKi9cbiAgICBhc3luYyBsaXN0UkRGRmlsZXMoZm9sZGVyPzogc3RyaW5nKTogUHJvbWlzZTxSZXN1bHQ8VEZpbGVbXT4+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlsZU1hbmFnZXIubGlzdFJERkZpbGVzKGZvbGRlcik7XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIENvbnZlcnQgU1BBUlFMIHF1ZXJ5IHJlc3VsdHMgdG8gZ3JhcGhcbiAgICAgKi9cbiAgICBwcml2YXRlIGNvbnZlcnRRdWVyeVJlc3VsdHNUb0dyYXBoKHJlc3VsdHM6IGFueVtdKTogR3JhcGgge1xuICAgICAgICBjb25zdCBncmFwaCA9IG5ldyBHcmFwaCgpO1xuICAgICAgICBcbiAgICAgICAgZm9yIChjb25zdCByZXN1bHQgb2YgcmVzdWx0cykge1xuICAgICAgICAgICAgaWYgKHJlc3VsdC5zdWJqZWN0ICYmIHJlc3VsdC5wcmVkaWNhdGUgJiYgcmVzdWx0Lm9iamVjdCkge1xuICAgICAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHN1YmplY3QgPSB0aGlzLmNyZWF0ZU5vZGVGcm9tVmFsdWUocmVzdWx0LnN1YmplY3QpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBwcmVkaWNhdGUgPSB0aGlzLmNyZWF0ZU5vZGVGcm9tVmFsdWUocmVzdWx0LnByZWRpY2F0ZSkgYXMgSVJJO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBvYmplY3QgPSB0aGlzLmNyZWF0ZU5vZGVGcm9tVmFsdWUocmVzdWx0Lm9iamVjdCk7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBpZiAoc3ViamVjdCAmJiBwcmVkaWNhdGUgJiYgb2JqZWN0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0cmlwbGUgPSBuZXcgVHJpcGxlKHN1YmplY3QgYXMgSVJJIHwgQmxhbmtOb2RlLCBwcmVkaWNhdGUsIG9iamVjdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBncmFwaC5hZGQodHJpcGxlKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybignRmFpbGVkIHRvIGNvbnZlcnQgcXVlcnkgcmVzdWx0IHRvIHRyaXBsZTonLCBlcnJvcik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gZ3JhcGg7XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIENyZWF0ZSBSREYgbm9kZSBmcm9tIHF1ZXJ5IHJlc3VsdCB2YWx1ZVxuICAgICAqL1xuICAgIHByaXZhdGUgY3JlYXRlTm9kZUZyb21WYWx1ZSh2YWx1ZTogYW55KTogSVJJIHwgQmxhbmtOb2RlIHwgTGl0ZXJhbCB8IG51bGwge1xuICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgaWYgKHZhbHVlLnN0YXJ0c1dpdGgoJ186JykpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IEJsYW5rTm9kZSh2YWx1ZSk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKHZhbHVlLnN0YXJ0c1dpdGgoJ2h0dHA6Ly8nKSB8fCB2YWx1ZS5zdGFydHNXaXRoKCdodHRwczovLycpIHx8IHZhbHVlLmluY2x1ZGVzKCc6JykpIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IElSSSh2YWx1ZSk7XG4gICAgICAgICAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBMaXRlcmFsLnN0cmluZyh2YWx1ZSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gTGl0ZXJhbC5zdHJpbmcodmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgICAgIHJldHVybiBOdW1iZXIuaXNJbnRlZ2VyKHZhbHVlKSA/IExpdGVyYWwuaW50ZWdlcih2YWx1ZSkgOiBMaXRlcmFsLmRvdWJsZSh2YWx1ZSk7XG4gICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbicpIHtcbiAgICAgICAgICAgIHJldHVybiBMaXRlcmFsLmJvb2xlYW4odmFsdWUpO1xuICAgICAgICB9IGVsc2UgaWYgKHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgIGlmICh2YWx1ZS50eXBlID09PSAndXJpJyB8fCB2YWx1ZS50eXBlID09PSAnaXJpJykge1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgSVJJKHZhbHVlLnZhbHVlKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUudHlwZSA9PT0gJ2Jub2RlJykge1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgQmxhbmtOb2RlKHZhbHVlLnZhbHVlKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUudHlwZSA9PT0gJ2xpdGVyYWwnKSB7XG4gICAgICAgICAgICAgICAgaWYgKHZhbHVlLmRhdGF0eXBlKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBuZXcgTGl0ZXJhbCh2YWx1ZS52YWx1ZSwgbmV3IElSSSh2YWx1ZS5kYXRhdHlwZSkpO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodmFsdWUubGFuZykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbmV3IExpdGVyYWwodmFsdWUudmFsdWUsIHVuZGVmaW5lZCwgdmFsdWUubGFuZyk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBMaXRlcmFsKHZhbHVlLnZhbHVlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBHZXQgbmFtZXNwYWNlIG1hbmFnZXIgaW5zdGFuY2VcbiAgICAgKi9cbiAgICBnZXROYW1lc3BhY2VNYW5hZ2VyKCk6IE5hbWVzcGFjZU1hbmFnZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5uYW1lc3BhY2VNYW5hZ2VyO1xuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBHZXQgc3VwcG9ydGVkIGV4cG9ydCBmb3JtYXRzXG4gICAgICovXG4gICAgZ2V0U3VwcG9ydGVkRm9ybWF0cygpOiBSREZGb3JtYXRbXSB7XG4gICAgICAgIHJldHVybiBbJ3R1cnRsZScsICduLXRyaXBsZXMnLCAnanNvbi1sZCcsICdyZGYteG1sJ107XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIEdldCBmb3JtYXQgaW5mb3JtYXRpb25cbiAgICAgKi9cbiAgICBnZXRGb3JtYXRJbmZvKGZvcm1hdDogUkRGRm9ybWF0KTogeyBleHRlbnNpb246IHN0cmluZzsgbWltZVR5cGU6IHN0cmluZzsgbmFtZTogc3RyaW5nIH0ge1xuICAgICAgICBjb25zdCBmb3JtYXRNYXAgPSB7XG4gICAgICAgICAgICAndHVydGxlJzogeyBleHRlbnNpb246ICcudHRsJywgbWltZVR5cGU6ICd0ZXh0L3R1cnRsZScsIG5hbWU6ICdUdXJ0bGUnIH0sXG4gICAgICAgICAgICAnbi10cmlwbGVzJzogeyBleHRlbnNpb246ICcubnQnLCBtaW1lVHlwZTogJ2FwcGxpY2F0aW9uL24tdHJpcGxlcycsIG5hbWU6ICdOLVRyaXBsZXMnIH0sXG4gICAgICAgICAgICAnanNvbi1sZCc6IHsgZXh0ZW5zaW9uOiAnLmpzb25sZCcsIG1pbWVUeXBlOiAnYXBwbGljYXRpb24vbGQranNvbicsIG5hbWU6ICdKU09OLUxEJyB9LFxuICAgICAgICAgICAgJ3JkZi14bWwnOiB7IGV4dGVuc2lvbjogJy5yZGYnLCBtaW1lVHlwZTogJ2FwcGxpY2F0aW9uL3JkZit4bWwnLCBuYW1lOiAnUkRGL1hNTCcgfVxuICAgICAgICB9O1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIGZvcm1hdE1hcFtmb3JtYXRdO1xuICAgIH1cbn0iXSwidmVyc2lvbiI6M30=