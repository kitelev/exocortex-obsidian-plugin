1338f9a800507488dc20496fe7cf53cf
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Asset = void 0;
const AssetId_1 = require("../value-objects/AssetId");
const ClassName_1 = require("../value-objects/ClassName");
const OntologyPrefix_1 = require("../value-objects/OntologyPrefix");
const PropertyValue_1 = require("../value-objects/PropertyValue");
const Entity_1 = require("../core/Entity");
const Result_1 = require("../core/Result");
/**
 * Domain entity representing an Exocortex Asset
 * Core business logic and invariants
 */
class Asset extends Entity_1.Entity {
    constructor(props, id) {
        super(props, props.id.toString());
    }
    generateId() {
        return this.props.id.toString();
    }
    validate() {
        if (!this.props.id) {
            throw new Error("Asset must have a valid ID");
        }
        if (!this.props.title || this.props.title.trim().length === 0) {
            throw new Error("Asset must have a non-empty title");
        }
        if (this.props.title.length > 200) {
            throw new Error("Asset title cannot exceed 200 characters");
        }
        if (!this.props.className) {
            throw new Error("Asset must have a valid class name");
        }
        if (!this.props.ontology) {
            throw new Error("Asset must belong to a valid ontology");
        }
        // Validate all property values
        for (const [key, propertyValue] of this.props.properties) {
            if (!(propertyValue instanceof PropertyValue_1.PropertyValue)) {
                throw new Error(`Property '${key}' must be a PropertyValue instance`);
            }
        }
    }
    static create(params) {
        if (!params.label || params.label.trim().length === 0) {
            return Result_1.Result.fail("Asset label cannot be empty");
        }
        if (params.label.length > 200) {
            return Result_1.Result.fail("Asset label cannot exceed 200 characters");
        }
        // Convert properties to PropertyValue objects
        const propertyMap = new Map();
        if (params.properties) {
            for (const [key, value] of Object.entries(params.properties)) {
                const propertyValueResult = PropertyValue_1.PropertyValue.create(value);
                if (!propertyValueResult.isSuccess) {
                    return Result_1.Result.fail(`Invalid property '${key}': ${propertyValueResult.getError()}`);
                }
                propertyMap.set(key, propertyValueResult.getValue());
            }
        }
        const props = {
            id: params.id,
            title: params.label.trim(),
            className: params.className,
            ontology: params.ontology,
            label: params.label.trim(),
            description: params.description?.trim(),
            properties: propertyMap,
            createdAt: new Date(),
            updatedAt: new Date(),
            version: 1,
        };
        try {
            const asset = new Asset(props);
            asset.validate();
            // Add domain event for asset creation
            asset.addDomainEvent(asset.createDomainEvent("AssetCreated", {
                assetId: params.id.toString(),
                className: params.className.toString(),
                ontology: params.ontology.toString(),
            }));
            return Result_1.Result.ok(asset);
        }
        catch (error) {
            return Result_1.Result.fail(`Asset creation failed: ${error}`);
        }
    }
    // Getters
    getId() {
        return this.props.id;
    }
    getTitle() {
        return this.props.title;
    }
    getClassName() {
        return this.props.className;
    }
    getOntologyPrefix() {
        return this.props.ontology;
    }
    getProperties() {
        return new Map(this.props.properties);
    }
    getProperty(key) {
        return this.props.properties.get(key);
    }
    getPropertyValue(key) {
        const propertyValue = this.props.properties.get(key);
        return propertyValue ? propertyValue.getValue() : undefined;
    }
    hasProperty(key) {
        return this.props.properties.has(key);
    }
    getVersion() {
        return this.props.version;
    }
    getCreatedAt() {
        return this.props.createdAt;
    }
    getUpdatedAt() {
        return this.props.updatedAt;
    }
    // Business methods
    updateTitle(title) {
        if (!title || title.trim().length === 0) {
            return Result_1.Result.fail("Asset title cannot be empty");
        }
        if (title.length > 200) {
            return Result_1.Result.fail("Asset title cannot exceed 200 characters");
        }
        const oldTitle = this.props.title;
        this.props.title = title.trim();
        this.props.label = title.trim();
        this.props.updatedAt = new Date();
        this.props.version += 1;
        this.addDomainEvent(this.createDomainEvent("AssetTitleUpdated", {
            assetId: this.props.id.toString(),
            oldTitle,
            newTitle: title.trim(),
        }));
        return Result_1.Result.ok();
    }
    setProperty(key, value) {
        if (!key || key.trim().length === 0) {
            return Result_1.Result.fail("Property key cannot be empty");
        }
        const propertyValueResult = PropertyValue_1.PropertyValue.create(value);
        if (!propertyValueResult.isSuccess) {
            return Result_1.Result.fail(`Invalid property value: ${propertyValueResult.getError()}`);
        }
        const oldValue = this.props.properties.get(key);
        this.props.properties.set(key, propertyValueResult.getValue());
        this.props.updatedAt = new Date();
        this.props.version += 1;
        this.addDomainEvent(this.createDomainEvent("AssetPropertyUpdated", {
            assetId: this.props.id.toString(),
            propertyKey: key,
            oldValue: oldValue?.getValue(),
            newValue: value,
        }));
        return Result_1.Result.ok();
    }
    removeProperty(key) {
        if (!this.props.properties.has(key)) {
            return Result_1.Result.fail(`Property '${key}' does not exist`);
        }
        const oldValue = this.props.properties.get(key);
        this.props.properties.delete(key);
        this.props.updatedAt = new Date();
        this.props.version += 1;
        this.addDomainEvent(this.createDomainEvent("AssetPropertyRemoved", {
            assetId: this.props.id.toString(),
            propertyKey: key,
            removedValue: oldValue?.getValue(),
        }));
        return Result_1.Result.ok();
    }
    changeClass(className) {
        if (!className) {
            return Result_1.Result.fail("Class name cannot be null");
        }
        const oldClassName = this.props.className;
        this.props.className = className;
        this.props.updatedAt = new Date();
        this.props.version += 1;
        this.addDomainEvent(this.createDomainEvent("AssetClassChanged", {
            assetId: this.props.id.toString(),
            oldClassName: oldClassName.toString(),
            newClassName: className.toString(),
        }));
        return Result_1.Result.ok();
    }
    updateDescription(description) {
        if (description && description.length > 2000) {
            return Result_1.Result.fail("Description cannot exceed 2000 characters");
        }
        const oldDescription = this.props.description;
        this.props.description = description?.trim();
        this.props.updatedAt = new Date();
        this.props.version += 1;
        this.addDomainEvent(this.createDomainEvent("AssetDescriptionUpdated", {
            assetId: this.props.id.toString(),
            oldDescription,
            newDescription: description?.trim(),
        }));
        return Result_1.Result.ok();
    }
    /**
     * Apply bulk property updates atomically
     */
    updateProperties(updates) {
        const validatedProperties = new Map();
        // Validate all properties first
        for (const [key, value] of Object.entries(updates)) {
            if (!key || key.trim().length === 0) {
                return Result_1.Result.fail("Property key cannot be empty");
            }
            const propertyValueResult = PropertyValue_1.PropertyValue.create(value);
            if (!propertyValueResult.isSuccess) {
                return Result_1.Result.fail(`Invalid property '${key}': ${propertyValueResult.getError()}`);
            }
            validatedProperties.set(key, propertyValueResult.getValue());
        }
        // Apply all updates atomically
        const oldProperties = new Map(this.props.properties);
        for (const [key, propertyValue] of validatedProperties) {
            this.props.properties.set(key, propertyValue);
        }
        this.props.updatedAt = new Date();
        this.props.version += 1;
        this.addDomainEvent(this.createDomainEvent("AssetPropertiesUpdated", {
            assetId: this.props.id.toString(),
            updatedProperties: Object.keys(updates),
            changeCount: validatedProperties.size,
        }));
        return Result_1.Result.ok();
    }
    /**
     * Check if asset can be deleted (business rules)
     */
    canDelete() {
        const reasons = [];
        // Add business rules for deletion
        // For example: cannot delete if it has dependent assets
        return {
            canDelete: reasons.length === 0,
            reasons,
        };
    }
    /**
     * Mark asset as deleted (soft delete)
     */
    markAsDeleted() {
        const deleteCheck = this.canDelete();
        if (!deleteCheck.canDelete) {
            return Result_1.Result.fail(`Cannot delete asset: ${deleteCheck.reasons.join(", ")}`);
        }
        this.addDomainEvent(this.createDomainEvent("AssetDeleted", {
            assetId: this.props.id.toString(),
            className: this.props.className.toString(),
            title: this.props.title,
        }));
        return Result_1.Result.ok();
    }
    toFrontmatter() {
        // Always ensure mandatory fields are present with proper formats
        const frontmatter = {
            exo__Asset_uid: this.props.id.toString(),
            exo__Asset_label: this.props.title,
            exo__Asset_isDefinedBy: `[[!${this.props.ontology.toString()}]]`,
            exo__Asset_createdAt: this.props.createdAt
                .toISOString()
                .replace(/\.\d{3}Z$/, ""),
            exo__Asset_updatedAt: this.props.updatedAt
                .toISOString()
                .replace(/\.\d{3}Z$/, ""),
            exo__Asset_version: this.props.version,
            exo__Instance_class: [this.props.className.toWikiLink()],
        };
        // Add description if present
        if (this.props.description) {
            frontmatter.exo__Asset_description = this.props.description;
        }
        // Add custom properties with proper value extraction
        for (const [key, propertyValue] of this.props.properties) {
            if (!frontmatter[key]) {
                frontmatter[key] = propertyValue.getValue();
            }
        }
        return frontmatter;
    }
    /**
     * Validates if an asset has all mandatory properties for creation
     * @param frontmatter The frontmatter to validate
     * @returns ValidationResult indicating success or failure with details
     */
    static validateMandatoryProperties(frontmatter) {
        const errors = [];
        // Check for mandatory exo__Asset_uid (UUID format)
        const uid = frontmatter["exo__Asset_uid"];
        if (!uid) {
            errors.push("Missing mandatory field: exo__Asset_uid");
        }
        else {
            // Validate UUID format
            const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!uuidRegex.test(uid.toString())) {
                errors.push("exo__Asset_uid must be a valid UUID format");
            }
        }
        // Check for mandatory exo__Asset_isDefinedBy (ontology reference)
        const isDefinedBy = frontmatter["exo__Asset_isDefinedBy"];
        if (!isDefinedBy) {
            errors.push("Missing mandatory field: exo__Asset_isDefinedBy");
        }
        else {
            // Validate format like "[[Ontology - Exocortex]]" or "[[!exo]]"
            const ontologyRegex = /^\[\[(!?[a-zA-Z][a-zA-Z0-9_\- ]*)\]\]$/;
            if (!ontologyRegex.test(isDefinedBy.toString())) {
                errors.push("exo__Asset_isDefinedBy must be in format [[Ontology Name]] or [[!prefix]]");
            }
        }
        // Check for mandatory exo__Asset_createdAt (ISO timestamp)
        const createdAt = frontmatter["exo__Asset_createdAt"];
        if (!createdAt) {
            errors.push("Missing mandatory field: exo__Asset_createdAt");
        }
        else {
            // Validate ISO timestamp format (YYYY-MM-DDTHH:mm:ss or with milliseconds and timezone)
            const isoRegex = /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{3})?(Z|[+-]\d{2}:\d{2})?$/;
            if (!isoRegex.test(createdAt.toString())) {
                errors.push("exo__Asset_createdAt must be in ISO timestamp format (YYYY-MM-DDTHH:mm:ss)");
            }
        }
        return {
            isValid: errors.length === 0,
            errors,
        };
    }
    static fromFrontmatter(frontmatter, fileName) {
        // Validate mandatory properties first
        const validation = Asset.validateMandatoryProperties(frontmatter);
        if (!validation.isValid) {
            console.warn(`Asset validation failed for ${fileName}:`, validation.errors);
            return null; // Silently ignore invalid assets
        }
        try {
            const idResult = AssetId_1.AssetId.create(frontmatter["exo__Asset_uid"]);
            if (!idResult.isSuccess) {
                console.warn(`Invalid Asset ID for ${fileName}:`, idResult.getError());
                return null;
            }
            const id = idResult.getValue();
            const label = frontmatter["exo__Asset_label"] || fileName.replace(".md", "");
            const classValue = Array.isArray(frontmatter["exo__Instance_class"])
                ? frontmatter["exo__Instance_class"][0]
                : frontmatter["exo__Instance_class"];
            const classNameResult = ClassName_1.ClassName.create(classValue || "exo__Asset");
            const className = classNameResult.isSuccess
                ? classNameResult.getValue()
                : ClassName_1.ClassName.create("exo__Asset").getValue();
            const ontologyValue = frontmatter["exo__Asset_isDefinedBy"]?.replace(/\[\[!?|\]\]/g, "") ||
                "exo";
            const ontologyResult = OntologyPrefix_1.OntologyPrefix.create(ontologyValue);
            const ontology = ontologyResult.isSuccess
                ? ontologyResult.getValue()
                : OntologyPrefix_1.OntologyPrefix.create("exo").getValue();
            const createdAt = new Date(frontmatter["exo__Asset_createdAt"]);
            if (isNaN(createdAt.getTime())) {
                console.warn(`Invalid createdAt timestamp for ${fileName}`);
                return null;
            }
            const properties = {};
            for (const [key, value] of Object.entries(frontmatter)) {
                if (!key.startsWith("exo__Asset_") &&
                    !key.startsWith("exo__Instance_")) {
                    properties[key] = value;
                }
            }
            // Use the factory method instead of constructor
            const result = Asset.create({
                id,
                label,
                className,
                ontology,
                properties,
            });
            if (result.isSuccess) {
                const asset = result.getValue();
                // Update timestamps and version with validated values
                asset.props.createdAt = createdAt;
                asset.props.version = frontmatter["exo__Asset_version"] || 1;
                const updatedAt = frontmatter["exo__Asset_updatedAt"];
                if (updatedAt) {
                    const updatedAtDate = new Date(updatedAt);
                    if (!isNaN(updatedAtDate.getTime())) {
                        asset.props.updatedAt = updatedAtDate;
                    }
                }
                return asset;
            }
            else {
                console.warn("Failed to create asset from frontmatter:", result.getError());
            }
            return null;
        }
        catch (error) {
            console.warn("Failed to create asset from frontmatter:", error);
            return null;
        }
    }
}
exports.Asset = Asset;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2RvbWFpbi9lbnRpdGllcy9Bc3NldC50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSxzREFBbUQ7QUFDbkQsMERBQXVEO0FBQ3ZELG9FQUFpRTtBQUNqRSxrRUFBK0Q7QUFDL0QsMkNBQXFEO0FBQ3JELDJDQUF3QztBQWdCeEM7OztHQUdHO0FBQ0gsTUFBYSxLQUFNLFNBQVEsZUFBa0I7SUFDM0MsWUFBb0IsS0FBaUIsRUFBRSxFQUFXO1FBQ2hELEtBQUssQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFFUyxVQUFVO1FBQ2xCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDbEMsQ0FBQztJQUVTLFFBQVE7UUFDaEIsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxFQUFFO1lBQ2xCLE1BQU0sSUFBSSxLQUFLLENBQUMsNEJBQTRCLENBQUMsQ0FBQztTQUMvQztRQUVELElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFO1lBQzdELE1BQU0sSUFBSSxLQUFLLENBQUMsbUNBQW1DLENBQUMsQ0FBQztTQUN0RDtRQUVELElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFHLEdBQUcsRUFBRTtZQUNqQyxNQUFNLElBQUksS0FBSyxDQUFDLDBDQUEwQyxDQUFDLENBQUM7U0FDN0Q7UUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUU7WUFDekIsTUFBTSxJQUFJLEtBQUssQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO1NBQ3ZEO1FBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFL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QUFVO2FBQ1gsQ0FBQyxDQUFDO1lBRUgsSUFBSSxNQUFNLENBQUMsU0FBUyxFQUFFO2dCQUNwQixNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsUUFBUSxFQUFHLENBQUM7Z0JBQ2pDLHNEQUFzRDtnQkFDckQsS0FBYSxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO2dCQUMxQyxLQUFhLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxXQUFXLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBRXRFLE1BQU0sU0FBUyxHQUFHLFdBQVcsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO2dCQUN0RCxJQUFJLFNBQVMsRUFBRTtvQkFDYixNQUFNLGFBQWEsR0FBRyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztvQkFDMUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsT0FBTyxFQUFFLENBQUMsRUFBRTt3QkFDbEMsS0FBYSxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsYUFBYSxDQUFDO3FCQUNoRDtpQkFDRjtnQkFFRCxPQUFPLEtBQUssQ0FBQzthQUNkO2lCQUFNO2dCQUNMLE9BQU8sQ0FBQyxJQUFJLENBQ1YsMENBQTBDLEVBQzFDLE1BQU0sQ0FBQyxRQUFRLEVBQUUsQ0FDbEIsQ0FBQzthQUNIO1lBRUQsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ2QsT0FBTyxDQUFDLElBQUksQ0FBQywwQ0FBMEMsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNoRSxPQUFPLElBQUksQ0FBQztTQUNiO0lBQ0gsQ0FBQztDQUNGO0FBL2dCRCxzQkErZ0JDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9raXRlbGV2L0RvY3VtZW50cy9leG9jb3J0ZXgtb2JzaWRpYW4tcGx1Z2luL3NyYy9kb21haW4vZW50aXRpZXMvQXNzZXQudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXNzZXRJZCB9IGZyb20gXCIuLi92YWx1ZS1vYmplY3RzL0Fzc2V0SWRcIjtcbmltcG9ydCB7IENsYXNzTmFtZSB9IGZyb20gXCIuLi92YWx1ZS1vYmplY3RzL0NsYXNzTmFtZVwiO1xuaW1wb3J0IHsgT250b2xvZ3lQcmVmaXggfSBmcm9tIFwiLi4vdmFsdWUtb2JqZWN0cy9PbnRvbG9neVByZWZpeFwiO1xuaW1wb3J0IHsgUHJvcGVydHlWYWx1ZSB9IGZyb20gXCIuLi92YWx1ZS1vYmplY3RzL1Byb3BlcnR5VmFsdWVcIjtcbmltcG9ydCB7IEVudGl0eSwgRG9tYWluRXZlbnQgfSBmcm9tIFwiLi4vY29yZS9FbnRpdHlcIjtcbmltcG9ydCB7IFJlc3VsdCB9IGZyb20gXCIuLi9jb3JlL1Jlc3VsdFwiO1xuXG5pbnRlcmZhY2UgQXNzZXRQcm9wcyB7XG4gIGlkOiBBc3NldElkO1xuICB0aXRsZTogc3RyaW5nO1xuICBjbGFzc05hbWU6IENsYXNzTmFtZTtcbiAgb250b2xvZ3k6IE9udG9sb2d5UHJlZml4O1xuICBsYWJlbD86IHN0cmluZztcbiAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XG4gIHByb3BlcnRpZXM6IE1hcDxzdHJpbmcsIFByb3BlcnR5VmFsdWU+O1xuICBjcmVhdGVkQXQ6IERhdGU7XG4gIHVwZGF0ZWRBdDogRGF0ZTtcbiAgZmlsZVBhdGg/OiBzdHJpbmc7XG4gIHZlcnNpb246IG51bWJlcjsgLy8gRm9yIG9wdGltaXN0aWMgbG9ja2luZ1xufVxuXG4vKipcbiAqIERvbWFpbiBlbnRpdHkgcmVwcmVzZW50aW5nIGFuIEV4b2NvcnRleCBBc3NldFxuICogQ29yZSBidXNpbmVzcyBsb2dpYyBhbmQgaW52YXJpYW50c1xuICovXG5leHBvcnQgY2xhc3MgQXNzZXQgZXh0ZW5kcyBFbnRpdHk8QXNzZXRQcm9wcz4ge1xuICBwcml2YXRlIGNvbnN0cnVjdG9yKHByb3BzOiBBc3NldFByb3BzLCBpZD86IHN0cmluZykge1xuICAgIHN1cGVyKHByb3BzLCBwcm9wcy5pZC50b1N0cmluZygpKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZW5lcmF0ZUlkKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMucHJvcHMuaWQudG9TdHJpbmcoKTtcbiAgfVxuXG4gIHByb3RlY3RlZCB2YWxpZGF0ZSgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMucHJvcHMuaWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkFzc2V0IG11c3QgaGF2ZSBhIHZhbGlkIElEXCIpO1xuICAgIH1cblxuICAgIGlmICghdGhpcy5wcm9wcy50aXRsZSB8fCB0aGlzLnByb3BzLnRpdGxlLnRyaW0oKS5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkFzc2V0IG11c3QgaGF2ZSBhIG5vbi1lbXB0eSB0aXRsZVwiKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5wcm9wcy50aXRsZS5sZW5ndGggPiAyMDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkFzc2V0IHRpdGxlIGNhbm5vdCBleGNlZWQgMjAwIGNoYXJhY3RlcnNcIik7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLnByb3BzLmNsYXNzTmFtZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQXNzZXQgbXVzdCBoYXZlIGEgdmFsaWQgY2xhc3MgbmFtZVwiKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMucHJvcHMub250b2xvZ3kpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkFzc2V0IG11c3QgYmVsb25nIHRvIGEgdmFsaWQgb250b2xvZ3lcIik7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgYWxsIHByb3BlcnR5IHZhbHVlc1xuICAgIGZvciAoY29uc3QgW2tleSwgcHJvcGVydHlWYWx1ZV0gb2YgdGhpcy5wcm9wcy5wcm9wZXJ0aWVzKSB7XG4gICAgICBpZiAoIShwcm9wZXJ0eVZhbHVlIGluc3RhbmNlb2YgUHJvcGVydHlWYWx1ZSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBQcm9wZXJ0eSAnJHtrZXl9JyBtdXN0IGJlIGEgUHJvcGVydHlWYWx1ZSBpbnN0YW5jZWApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHN0YXRpYyBjcmVhdGUocGFyYW1zOiB7XG4gICAgaWQ6IEFzc2V0SWQ7XG4gICAgY2xhc3NOYW1lOiBDbGFzc05hbWU7XG4gICAgb250b2xvZ3k6IE9udG9sb2d5UHJlZml4O1xuICAgIGxhYmVsOiBzdHJpbmc7XG4gICAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XG4gICAgcHJvcGVydGllcz86IFJlY29yZDxzdHJpbmcsIGFueT47XG4gIH0pOiBSZXN1bHQ8QXNzZXQ+IHtcbiAgICBpZiAoIXBhcmFtcy5sYWJlbCB8fCBwYXJhbXMubGFiZWwudHJpbSgpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPEFzc2V0PihcIkFzc2V0IGxhYmVsIGNhbm5vdCBiZSBlbXB0eVwiKTtcbiAgICB9XG5cbiAgICBpZiAocGFyYW1zLmxhYmVsLmxlbmd0aCA+IDIwMCkge1xuICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPEFzc2V0PihcIkFzc2V0IGxhYmVsIGNhbm5vdCBleGNlZWQgMjAwIGNoYXJhY3RlcnNcIik7XG4gICAgfVxuXG4gICAgLy8gQ29udmVydCBwcm9wZXJ0aWVzIHRvIFByb3BlcnR5VmFsdWUgb2JqZWN0c1xuICAgIGNvbnN0IHByb3BlcnR5TWFwID0gbmV3IE1hcDxzdHJpbmcsIFByb3BlcnR5VmFsdWU+KCk7XG4gICAgaWYgKHBhcmFtcy5wcm9wZXJ0aWVzKSB7XG4gICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhwYXJhbXMucHJvcGVydGllcykpIHtcbiAgICAgICAgY29uc3QgcHJvcGVydHlWYWx1ZVJlc3VsdCA9IFByb3BlcnR5VmFsdWUuY3JlYXRlKHZhbHVlKTtcbiAgICAgICAgaWYgKCFwcm9wZXJ0eVZhbHVlUmVzdWx0LmlzU3VjY2Vzcykge1xuICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxBc3NldD4oXG4gICAgICAgICAgICBgSW52YWxpZCBwcm9wZXJ0eSAnJHtrZXl9JzogJHtwcm9wZXJ0eVZhbHVlUmVzdWx0LmdldEVycm9yKCl9YCxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIHByb3BlcnR5TWFwLnNldChrZXksIHByb3BlcnR5VmFsdWVSZXN1bHQuZ2V0VmFsdWUoKSEpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHByb3BzOiBBc3NldFByb3BzID0ge1xuICAgICAgaWQ6IHBhcmFtcy5pZCxcbiAgICAgIHRpdGxlOiBwYXJhbXMubGFiZWwudHJpbSgpLFxuICAgICAgY2xhc3NOYW1lOiBwYXJhbXMuY2xhc3NOYW1lLFxuICAgICAgb250b2xvZ3k6IHBhcmFtcy5vbnRvbG9neSxcbiAgICAgIGxhYmVsOiBwYXJhbXMubGFiZWwudHJpbSgpLFxuICAgICAgZGVzY3JpcHRpb246IHBhcmFtcy5kZXNjcmlwdGlvbj8udHJpbSgpLFxuICAgICAgcHJvcGVydGllczogcHJvcGVydHlNYXAsXG4gICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICB2ZXJzaW9uOiAxLFxuICAgIH07XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgYXNzZXQgPSBuZXcgQXNzZXQocHJvcHMpO1xuICAgICAgYXNzZXQudmFsaWRhdGUoKTtcblxuICAgICAgLy8gQWRkIGRvbWFpbiBldmVudCBmb3IgYXNzZXQgY3JlYXRpb25cbiAgICAgIGFzc2V0LmFkZERvbWFpbkV2ZW50KFxuICAgICAgICBhc3NldC5jcmVhdGVEb21haW5FdmVudChcIkFzc2V0Q3JlYXRlZFwiLCB7XG4gICAgICAgICAgYXNzZXRJZDogcGFyYW1zLmlkLnRvU3RyaW5nKCksXG4gICAgICAgICAgY2xhc3NOYW1lOiBwYXJhbXMuY2xhc3NOYW1lLnRvU3RyaW5nKCksXG4gICAgICAgICAgb250b2xvZ3k6IHBhcmFtcy5vbnRvbG9neS50b1N0cmluZygpLFxuICAgICAgICB9KSxcbiAgICAgICk7XG5cbiAgICAgIHJldHVybiBSZXN1bHQub2s8QXNzZXQ+KGFzc2V0KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPEFzc2V0PihgQXNzZXQgY3JlYXRpb24gZmFpbGVkOiAke2Vycm9yfWApO1xuICAgIH1cbiAgfVxuXG4gIC8vIEdldHRlcnNcbiAgZ2V0SWQoKTogQXNzZXRJZCB7XG4gICAgcmV0dXJuIHRoaXMucHJvcHMuaWQ7XG4gIH1cblxuICBnZXRUaXRsZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLnByb3BzLnRpdGxlO1xuICB9XG5cbiAgZ2V0Q2xhc3NOYW1lKCk6IENsYXNzTmFtZSB7XG4gICAgcmV0dXJuIHRoaXMucHJvcHMuY2xhc3NOYW1lO1xuICB9XG5cbiAgZ2V0T250b2xvZ3lQcmVmaXgoKTogT250b2xvZ3lQcmVmaXgge1xuICAgIHJldHVybiB0aGlzLnByb3BzLm9udG9sb2d5O1xuICB9XG5cbiAgZ2V0UHJvcGVydGllcygpOiBNYXA8c3RyaW5nLCBQcm9wZXJ0eVZhbHVlPiB7XG4gICAgcmV0dXJuIG5ldyBNYXAodGhpcy5wcm9wcy5wcm9wZXJ0aWVzKTtcbiAgfVxuXG4gIGdldFByb3BlcnR5KGtleTogc3RyaW5nKTogUHJvcGVydHlWYWx1ZSB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHRoaXMucHJvcHMucHJvcGVydGllcy5nZXQoa2V5KTtcbiAgfVxuXG4gIGdldFByb3BlcnR5VmFsdWUoa2V5OiBzdHJpbmcpOiBhbnkge1xuICAgIGNvbnN0IHByb3BlcnR5VmFsdWUgPSB0aGlzLnByb3BzLnByb3BlcnRpZXMuZ2V0KGtleSk7XG4gICAgcmV0dXJuIHByb3BlcnR5VmFsdWUgPyBwcm9wZXJ0eVZhbHVlLmdldFZhbHVlKCkgOiB1bmRlZmluZWQ7XG4gIH1cblxuICBoYXNQcm9wZXJ0eShrZXk6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLnByb3BzLnByb3BlcnRpZXMuaGFzKGtleSk7XG4gIH1cblxuICBnZXRWZXJzaW9uKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMucHJvcHMudmVyc2lvbjtcbiAgfVxuXG4gIGdldENyZWF0ZWRBdCgpOiBEYXRlIHtcbiAgICByZXR1cm4gdGhpcy5wcm9wcy5jcmVhdGVkQXQ7XG4gIH1cblxuICBnZXRVcGRhdGVkQXQoKTogRGF0ZSB7XG4gICAgcmV0dXJuIHRoaXMucHJvcHMudXBkYXRlZEF0O1xuICB9XG5cbiAgLy8gQnVzaW5lc3MgbWV0aG9kc1xuICB1cGRhdGVUaXRsZSh0aXRsZTogc3RyaW5nKTogUmVzdWx0PHZvaWQ+IHtcbiAgICBpZiAoIXRpdGxlIHx8IHRpdGxlLnRyaW0oKS5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDx2b2lkPihcIkFzc2V0IHRpdGxlIGNhbm5vdCBiZSBlbXB0eVwiKTtcbiAgICB9XG5cbiAgICBpZiAodGl0bGUubGVuZ3RoID4gMjAwKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8dm9pZD4oXCJBc3NldCB0aXRsZSBjYW5ub3QgZXhjZWVkIDIwMCBjaGFyYWN0ZXJzXCIpO1xuICAgIH1cblxuICAgIGNvbnN0IG9sZFRpdGxlID0gdGhpcy5wcm9wcy50aXRsZTtcbiAgICB0aGlzLnByb3BzLnRpdGxlID0gdGl0bGUudHJpbSgpO1xuICAgIHRoaXMucHJvcHMubGFiZWwgPSB0aXRsZS50cmltKCk7XG4gICAgdGhpcy5wcm9wcy51cGRhdGVkQXQgPSBuZXcgRGF0ZSgpO1xuICAgIHRoaXMucHJvcHMudmVyc2lvbiArPSAxO1xuXG4gICAgdGhpcy5hZGREb21haW5FdmVudChcbiAgICAgIHRoaXMuY3JlYXRlRG9tYWluRXZlbnQoXCJBc3NldFRpdGxlVXBkYXRlZFwiLCB7XG4gICAgICAgIGFzc2V0SWQ6IHRoaXMucHJvcHMuaWQudG9TdHJpbmcoKSxcbiAgICAgICAgb2xkVGl0bGUsXG4gICAgICAgIG5ld1RpdGxlOiB0aXRsZS50cmltKCksXG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgcmV0dXJuIFJlc3VsdC5vazx2b2lkPigpO1xuICB9XG5cbiAgc2V0UHJvcGVydHkoa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpOiBSZXN1bHQ8dm9pZD4ge1xuICAgIGlmICgha2V5IHx8IGtleS50cmltKCkubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8dm9pZD4oXCJQcm9wZXJ0eSBrZXkgY2Fubm90IGJlIGVtcHR5XCIpO1xuICAgIH1cblxuICAgIGNvbnN0IHByb3BlcnR5VmFsdWVSZXN1bHQgPSBQcm9wZXJ0eVZhbHVlLmNyZWF0ZSh2YWx1ZSk7XG4gICAgaWYgKCFwcm9wZXJ0eVZhbHVlUmVzdWx0LmlzU3VjY2Vzcykge1xuICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPHZvaWQ+KFxuICAgICAgICBgSW52YWxpZCBwcm9wZXJ0eSB2YWx1ZTogJHtwcm9wZXJ0eVZhbHVlUmVzdWx0LmdldEVycm9yKCl9YCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3Qgb2xkVmFsdWUgPSB0aGlzLnByb3BzLnByb3BlcnRpZXMuZ2V0KGtleSk7XG4gICAgdGhpcy5wcm9wcy5wcm9wZXJ0aWVzLnNldChrZXksIHByb3BlcnR5VmFsdWVSZXN1bHQuZ2V0VmFsdWUoKSEpO1xuICAgIHRoaXMucHJvcHMudXBkYXRlZEF0ID0gbmV3IERhdGUoKTtcbiAgICB0aGlzLnByb3BzLnZlcnNpb24gKz0gMTtcblxuICAgIHRoaXMuYWRkRG9tYWluRXZlbnQoXG4gICAgICB0aGlzLmNyZWF0ZURvbWFpbkV2ZW50KFwiQXNzZXRQcm9wZXJ0eVVwZGF0ZWRcIiwge1xuICAgICAgICBhc3NldElkOiB0aGlzLnByb3BzLmlkLnRvU3RyaW5nKCksXG4gICAgICAgIHByb3BlcnR5S2V5OiBrZXksXG4gICAgICAgIG9sZFZhbHVlOiBvbGRWYWx1ZT8uZ2V0VmFsdWUoKSxcbiAgICAgICAgbmV3VmFsdWU6IHZhbHVlLFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIHJldHVybiBSZXN1bHQub2s8dm9pZD4oKTtcbiAgfVxuXG4gIHJlbW92ZVByb3BlcnR5KGtleTogc3RyaW5nKTogUmVzdWx0PHZvaWQ+IHtcbiAgICBpZiAoIXRoaXMucHJvcHMucHJvcGVydGllcy5oYXMoa2V5KSkge1xuICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPHZvaWQ+KGBQcm9wZXJ0eSAnJHtrZXl9JyBkb2VzIG5vdCBleGlzdGApO1xuICAgIH1cblxuICAgIGNvbnN0IG9sZFZhbHVlID0gdGhpcy5wcm9wcy5wcm9wZXJ0aWVzLmdldChrZXkpO1xuICAgIHRoaXMucHJvcHMucHJvcGVydGllcy5kZWxldGUoa2V5KTtcbiAgICB0aGlzLnByb3BzLnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCk7XG4gICAgdGhpcy5wcm9wcy52ZXJzaW9uICs9IDE7XG5cbiAgICB0aGlzLmFkZERvbWFpbkV2ZW50KFxuICAgICAgdGhpcy5jcmVhdGVEb21haW5FdmVudChcIkFzc2V0UHJvcGVydHlSZW1vdmVkXCIsIHtcbiAgICAgICAgYXNzZXRJZDogdGhpcy5wcm9wcy5pZC50b1N0cmluZygpLFxuICAgICAgICBwcm9wZXJ0eUtleToga2V5LFxuICAgICAgICByZW1vdmVkVmFsdWU6IG9sZFZhbHVlPy5nZXRWYWx1ZSgpLFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIHJldHVybiBSZXN1bHQub2s8dm9pZD4oKTtcbiAgfVxuXG4gIGNoYW5nZUNsYXNzKGNsYXNzTmFtZTogQ2xhc3NOYW1lKTogUmVzdWx0PHZvaWQ+IHtcbiAgICBpZiAoIWNsYXNzTmFtZSkge1xuICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPHZvaWQ+KFwiQ2xhc3MgbmFtZSBjYW5ub3QgYmUgbnVsbFwiKTtcbiAgICB9XG5cbiAgICBjb25zdCBvbGRDbGFzc05hbWUgPSB0aGlzLnByb3BzLmNsYXNzTmFtZTtcbiAgICB0aGlzLnByb3BzLmNsYXNzTmFtZSA9IGNsYXNzTmFtZTtcbiAgICB0aGlzLnByb3BzLnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCk7XG4gICAgdGhpcy5wcm9wcy52ZXJzaW9uICs9IDE7XG5cbiAgICB0aGlzLmFkZERvbWFpbkV2ZW50KFxuICAgICAgdGhpcy5jcmVhdGVEb21haW5FdmVudChcIkFzc2V0Q2xhc3NDaGFuZ2VkXCIsIHtcbiAgICAgICAgYXNzZXRJZDogdGhpcy5wcm9wcy5pZC50b1N0cmluZygpLFxuICAgICAgICBvbGRDbGFzc05hbWU6IG9sZENsYXNzTmFtZS50b1N0cmluZygpLFxuICAgICAgICBuZXdDbGFzc05hbWU6IGNsYXNzTmFtZS50b1N0cmluZygpLFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIHJldHVybiBSZXN1bHQub2s8dm9pZD4oKTtcbiAgfVxuXG4gIHVwZGF0ZURlc2NyaXB0aW9uKGRlc2NyaXB0aW9uOiBzdHJpbmcpOiBSZXN1bHQ8dm9pZD4ge1xuICAgIGlmIChkZXNjcmlwdGlvbiAmJiBkZXNjcmlwdGlvbi5sZW5ndGggPiAyMDAwKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8dm9pZD4oXCJEZXNjcmlwdGlvbiBjYW5ub3QgZXhjZWVkIDIwMDAgY2hhcmFjdGVyc1wiKTtcbiAgICB9XG5cbiAgICBjb25zdCBvbGREZXNjcmlwdGlvbiA9IHRoaXMucHJvcHMuZGVzY3JpcHRpb247XG4gICAgdGhpcy5wcm9wcy5kZXNjcmlwdGlvbiA9IGRlc2NyaXB0aW9uPy50cmltKCk7XG4gICAgdGhpcy5wcm9wcy51cGRhdGVkQXQgPSBuZXcgRGF0ZSgpO1xuICAgIHRoaXMucHJvcHMudmVyc2lvbiArPSAxO1xuXG4gICAgdGhpcy5hZGREb21haW5FdmVudChcbiAgICAgIHRoaXMuY3JlYXRlRG9tYWluRXZlbnQoXCJBc3NldERlc2NyaXB0aW9uVXBkYXRlZFwiLCB7XG4gICAgICAgIGFzc2V0SWQ6IHRoaXMucHJvcHMuaWQudG9TdHJpbmcoKSxcbiAgICAgICAgb2xkRGVzY3JpcHRpb24sXG4gICAgICAgIG5ld0Rlc2NyaXB0aW9uOiBkZXNjcmlwdGlvbj8udHJpbSgpLFxuICAgICAgfSksXG4gICAgKTtcblxuICAgIHJldHVybiBSZXN1bHQub2s8dm9pZD4oKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBcHBseSBidWxrIHByb3BlcnR5IHVwZGF0ZXMgYXRvbWljYWxseVxuICAgKi9cbiAgdXBkYXRlUHJvcGVydGllcyh1cGRhdGVzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+KTogUmVzdWx0PHZvaWQ+IHtcbiAgICBjb25zdCB2YWxpZGF0ZWRQcm9wZXJ0aWVzID0gbmV3IE1hcDxzdHJpbmcsIFByb3BlcnR5VmFsdWU+KCk7XG5cbiAgICAvLyBWYWxpZGF0ZSBhbGwgcHJvcGVydGllcyBmaXJzdFxuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHVwZGF0ZXMpKSB7XG4gICAgICBpZiAoIWtleSB8fCBrZXkudHJpbSgpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8dm9pZD4oXCJQcm9wZXJ0eSBrZXkgY2Fubm90IGJlIGVtcHR5XCIpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBwcm9wZXJ0eVZhbHVlUmVzdWx0ID0gUHJvcGVydHlWYWx1ZS5jcmVhdGUodmFsdWUpO1xuICAgICAgaWYgKCFwcm9wZXJ0eVZhbHVlUmVzdWx0LmlzU3VjY2Vzcykge1xuICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8dm9pZD4oXG4gICAgICAgICAgYEludmFsaWQgcHJvcGVydHkgJyR7a2V5fSc6ICR7cHJvcGVydHlWYWx1ZVJlc3VsdC5nZXRFcnJvcigpfWAsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHZhbGlkYXRlZFByb3BlcnRpZXMuc2V0KGtleSwgcHJvcGVydHlWYWx1ZVJlc3VsdC5nZXRWYWx1ZSgpISk7XG4gICAgfVxuXG4gICAgLy8gQXBwbHkgYWxsIHVwZGF0ZXMgYXRvbWljYWxseVxuICAgIGNvbnN0IG9sZFByb3BlcnRpZXMgPSBuZXcgTWFwKHRoaXMucHJvcHMucHJvcGVydGllcyk7XG4gICAgZm9yIChjb25zdCBba2V5LCBwcm9wZXJ0eVZhbHVlXSBvZiB2YWxpZGF0ZWRQcm9wZXJ0aWVzKSB7XG4gICAgICB0aGlzLnByb3BzLnByb3BlcnRpZXMuc2V0KGtleSwgcHJvcGVydHlWYWx1ZSk7XG4gICAgfVxuXG4gICAgdGhpcy5wcm9wcy51cGRhdGVkQXQgPSBuZXcgRGF0ZSgpO1xuICAgIHRoaXMucHJvcHMudmVyc2lvbiArPSAxO1xuXG4gICAgdGhpcy5hZGREb21haW5FdmVudChcbiAgICAgIHRoaXMuY3JlYXRlRG9tYWluRXZlbnQoXCJBc3NldFByb3BlcnRpZXNVcGRhdGVkXCIsIHtcbiAgICAgICAgYXNzZXRJZDogdGhpcy5wcm9wcy5pZC50b1N0cmluZygpLFxuICAgICAgICB1cGRhdGVkUHJvcGVydGllczogT2JqZWN0LmtleXModXBkYXRlcyksXG4gICAgICAgIGNoYW5nZUNvdW50OiB2YWxpZGF0ZWRQcm9wZXJ0aWVzLnNpemUsXG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgcmV0dXJuIFJlc3VsdC5vazx2b2lkPigpO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIGFzc2V0IGNhbiBiZSBkZWxldGVkIChidXNpbmVzcyBydWxlcylcbiAgICovXG4gIGNhbkRlbGV0ZSgpOiB7IGNhbkRlbGV0ZTogYm9vbGVhbjsgcmVhc29uczogc3RyaW5nW10gfSB7XG4gICAgY29uc3QgcmVhc29uczogc3RyaW5nW10gPSBbXTtcblxuICAgIC8vIEFkZCBidXNpbmVzcyBydWxlcyBmb3IgZGVsZXRpb25cbiAgICAvLyBGb3IgZXhhbXBsZTogY2Fubm90IGRlbGV0ZSBpZiBpdCBoYXMgZGVwZW5kZW50IGFzc2V0c1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIGNhbkRlbGV0ZTogcmVhc29ucy5sZW5ndGggPT09IDAsXG4gICAgICByZWFzb25zLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogTWFyayBhc3NldCBhcyBkZWxldGVkIChzb2Z0IGRlbGV0ZSlcbiAgICovXG4gIG1hcmtBc0RlbGV0ZWQoKTogUmVzdWx0PHZvaWQ+IHtcbiAgICBjb25zdCBkZWxldGVDaGVjayA9IHRoaXMuY2FuRGVsZXRlKCk7XG4gICAgaWYgKCFkZWxldGVDaGVjay5jYW5EZWxldGUpIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDx2b2lkPihcbiAgICAgICAgYENhbm5vdCBkZWxldGUgYXNzZXQ6ICR7ZGVsZXRlQ2hlY2sucmVhc29ucy5qb2luKFwiLCBcIil9YCxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgdGhpcy5hZGREb21haW5FdmVudChcbiAgICAgIHRoaXMuY3JlYXRlRG9tYWluRXZlbnQoXCJBc3NldERlbGV0ZWRcIiwge1xuICAgICAgICBhc3NldElkOiB0aGlzLnByb3BzLmlkLnRvU3RyaW5nKCksXG4gICAgICAgIGNsYXNzTmFtZTogdGhpcy5wcm9wcy5jbGFzc05hbWUudG9TdHJpbmcoKSxcbiAgICAgICAgdGl0bGU6IHRoaXMucHJvcHMudGl0bGUsXG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgcmV0dXJuIFJlc3VsdC5vazx2b2lkPigpO1xuICB9XG5cbiAgdG9Gcm9udG1hdHRlcigpOiBSZWNvcmQ8c3RyaW5nLCBhbnk+IHtcbiAgICAvLyBBbHdheXMgZW5zdXJlIG1hbmRhdG9yeSBmaWVsZHMgYXJlIHByZXNlbnQgd2l0aCBwcm9wZXIgZm9ybWF0c1xuICAgIGNvbnN0IGZyb250bWF0dGVyOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge1xuICAgICAgZXhvX19Bc3NldF91aWQ6IHRoaXMucHJvcHMuaWQudG9TdHJpbmcoKSxcbiAgICAgIGV4b19fQXNzZXRfbGFiZWw6IHRoaXMucHJvcHMudGl0bGUsXG4gICAgICBleG9fX0Fzc2V0X2lzRGVmaW5lZEJ5OiBgW1shJHt0aGlzLnByb3BzLm9udG9sb2d5LnRvU3RyaW5nKCl9XV1gLFxuICAgICAgZXhvX19Bc3NldF9jcmVhdGVkQXQ6IHRoaXMucHJvcHMuY3JlYXRlZEF0XG4gICAgICAgIC50b0lTT1N0cmluZygpXG4gICAgICAgIC5yZXBsYWNlKC9cXC5cXGR7M31aJC8sIFwiXCIpLCAvLyBSZW1vdmUgbWlsbGlzZWNvbmRzIGZvciBjbGVhbmVyIGZvcm1hdFxuICAgICAgZXhvX19Bc3NldF91cGRhdGVkQXQ6IHRoaXMucHJvcHMudXBkYXRlZEF0XG4gICAgICAgIC50b0lTT1N0cmluZygpXG4gICAgICAgIC5yZXBsYWNlKC9cXC5cXGR7M31aJC8sIFwiXCIpLFxuICAgICAgZXhvX19Bc3NldF92ZXJzaW9uOiB0aGlzLnByb3BzLnZlcnNpb24sXG4gICAgICBleG9fX0luc3RhbmNlX2NsYXNzOiBbdGhpcy5wcm9wcy5jbGFzc05hbWUudG9XaWtpTGluaygpXSxcbiAgICB9O1xuXG4gICAgLy8gQWRkIGRlc2NyaXB0aW9uIGlmIHByZXNlbnRcbiAgICBpZiAodGhpcy5wcm9wcy5kZXNjcmlwdGlvbikge1xuICAgICAgZnJvbnRtYXR0ZXIuZXhvX19Bc3NldF9kZXNjcmlwdGlvbiA9IHRoaXMucHJvcHMuZGVzY3JpcHRpb247XG4gICAgfVxuXG4gICAgLy8gQWRkIGN1c3RvbSBwcm9wZXJ0aWVzIHdpdGggcHJvcGVyIHZhbHVlIGV4dHJhY3Rpb25cbiAgICBmb3IgKGNvbnN0IFtrZXksIHByb3BlcnR5VmFsdWVdIG9mIHRoaXMucHJvcHMucHJvcGVydGllcykge1xuICAgICAgaWYgKCFmcm9udG1hdHRlcltrZXldKSB7XG4gICAgICAgIGZyb250bWF0dGVyW2tleV0gPSBwcm9wZXJ0eVZhbHVlLmdldFZhbHVlKCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGZyb250bWF0dGVyO1xuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlcyBpZiBhbiBhc3NldCBoYXMgYWxsIG1hbmRhdG9yeSBwcm9wZXJ0aWVzIGZvciBjcmVhdGlvblxuICAgKiBAcGFyYW0gZnJvbnRtYXR0ZXIgVGhlIGZyb250bWF0dGVyIHRvIHZhbGlkYXRlXG4gICAqIEByZXR1cm5zIFZhbGlkYXRpb25SZXN1bHQgaW5kaWNhdGluZyBzdWNjZXNzIG9yIGZhaWx1cmUgd2l0aCBkZXRhaWxzXG4gICAqL1xuICBwcml2YXRlIHN0YXRpYyB2YWxpZGF0ZU1hbmRhdG9yeVByb3BlcnRpZXMoXG4gICAgZnJvbnRtYXR0ZXI6IFJlY29yZDxzdHJpbmcsIGFueT4sXG4gICk6IHsgaXNWYWxpZDogYm9vbGVhbjsgZXJyb3JzOiBzdHJpbmdbXSB9IHtcbiAgICBjb25zdCBlcnJvcnM6IHN0cmluZ1tdID0gW107XG5cbiAgICAvLyBDaGVjayBmb3IgbWFuZGF0b3J5IGV4b19fQXNzZXRfdWlkIChVVUlEIGZvcm1hdClcbiAgICBjb25zdCB1aWQgPSBmcm9udG1hdHRlcltcImV4b19fQXNzZXRfdWlkXCJdO1xuICAgIGlmICghdWlkKSB7XG4gICAgICBlcnJvcnMucHVzaChcIk1pc3NpbmcgbWFuZGF0b3J5IGZpZWxkOiBleG9fX0Fzc2V0X3VpZFwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gVmFsaWRhdGUgVVVJRCBmb3JtYXRcbiAgICAgIGNvbnN0IHV1aWRSZWdleCA9XG4gICAgICAgIC9eWzAtOWEtZl17OH0tWzAtOWEtZl17NH0tWzAtOWEtZl17NH0tWzAtOWEtZl17NH0tWzAtOWEtZl17MTJ9JC9pO1xuICAgICAgaWYgKCF1dWlkUmVnZXgudGVzdCh1aWQudG9TdHJpbmcoKSkpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goXCJleG9fX0Fzc2V0X3VpZCBtdXN0IGJlIGEgdmFsaWQgVVVJRCBmb3JtYXRcIik7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgZm9yIG1hbmRhdG9yeSBleG9fX0Fzc2V0X2lzRGVmaW5lZEJ5IChvbnRvbG9neSByZWZlcmVuY2UpXG4gICAgY29uc3QgaXNEZWZpbmVkQnkgPSBmcm9udG1hdHRlcltcImV4b19fQXNzZXRfaXNEZWZpbmVkQnlcIl07XG4gICAgaWYgKCFpc0RlZmluZWRCeSkge1xuICAgICAgZXJyb3JzLnB1c2goXCJNaXNzaW5nIG1hbmRhdG9yeSBmaWVsZDogZXhvX19Bc3NldF9pc0RlZmluZWRCeVwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gVmFsaWRhdGUgZm9ybWF0IGxpa2UgXCJbW09udG9sb2d5IC0gRXhvY29ydGV4XV1cIiBvciBcIltbIWV4b11dXCJcbiAgICAgIGNvbnN0IG9udG9sb2d5UmVnZXggPSAvXlxcW1xcWyghP1thLXpBLVpdW2EtekEtWjAtOV9cXC0gXSopXFxdXFxdJC87XG4gICAgICBpZiAoIW9udG9sb2d5UmVnZXgudGVzdChpc0RlZmluZWRCeS50b1N0cmluZygpKSkge1xuICAgICAgICBlcnJvcnMucHVzaChcbiAgICAgICAgICBcImV4b19fQXNzZXRfaXNEZWZpbmVkQnkgbXVzdCBiZSBpbiBmb3JtYXQgW1tPbnRvbG9neSBOYW1lXV0gb3IgW1shcHJlZml4XV1cIixcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBDaGVjayBmb3IgbWFuZGF0b3J5IGV4b19fQXNzZXRfY3JlYXRlZEF0IChJU08gdGltZXN0YW1wKVxuICAgIGNvbnN0IGNyZWF0ZWRBdCA9IGZyb250bWF0dGVyW1wiZXhvX19Bc3NldF9jcmVhdGVkQXRcIl07XG4gICAgaWYgKCFjcmVhdGVkQXQpIHtcbiAgICAgIGVycm9ycy5wdXNoKFwiTWlzc2luZyBtYW5kYXRvcnkgZmllbGQ6IGV4b19fQXNzZXRfY3JlYXRlZEF0XCIpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBWYWxpZGF0ZSBJU08gdGltZXN0YW1wIGZvcm1hdCAoWVlZWS1NTS1ERFRISDptbTpzcyBvciB3aXRoIG1pbGxpc2Vjb25kcyBhbmQgdGltZXpvbmUpXG4gICAgICBjb25zdCBpc29SZWdleCA9XG4gICAgICAgIC9eXFxkezR9LVxcZHsyfS1cXGR7Mn1UXFxkezJ9OlxcZHsyfTpcXGR7Mn0oXFwuXFxkezN9KT8oWnxbKy1dXFxkezJ9OlxcZHsyfSk/JC87XG4gICAgICBpZiAoIWlzb1JlZ2V4LnRlc3QoY3JlYXRlZEF0LnRvU3RyaW5nKCkpKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKFxuICAgICAgICAgIFwiZXhvX19Bc3NldF9jcmVhdGVkQXQgbXVzdCBiZSBpbiBJU08gdGltZXN0YW1wIGZvcm1hdCAoWVlZWS1NTS1ERFRISDptbTpzcylcIixcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgaXNWYWxpZDogZXJyb3JzLmxlbmd0aCA9PT0gMCxcbiAgICAgIGVycm9ycyxcbiAgICB9O1xuICB9XG5cbiAgc3RhdGljIGZyb21Gcm9udG1hdHRlcihcbiAgICBmcm9udG1hdHRlcjogUmVjb3JkPHN0cmluZywgYW55PixcbiAgICBmaWxlTmFtZTogc3RyaW5nLFxuICApOiBBc3NldCB8IG51bGwge1xuICAgIC8vIFZhbGlkYXRlIG1hbmRhdG9yeSBwcm9wZXJ0aWVzIGZpcnN0XG4gICAgY29uc3QgdmFsaWRhdGlvbiA9IEFzc2V0LnZhbGlkYXRlTWFuZGF0b3J5UHJvcGVydGllcyhmcm9udG1hdHRlcik7XG4gICAgaWYgKCF2YWxpZGF0aW9uLmlzVmFsaWQpIHtcbiAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgYEFzc2V0IHZhbGlkYXRpb24gZmFpbGVkIGZvciAke2ZpbGVOYW1lfTpgLFxuICAgICAgICB2YWxpZGF0aW9uLmVycm9ycyxcbiAgICAgICk7XG4gICAgICByZXR1cm4gbnVsbDsgLy8gU2lsZW50bHkgaWdub3JlIGludmFsaWQgYXNzZXRzXG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGlkUmVzdWx0ID0gQXNzZXRJZC5jcmVhdGUoZnJvbnRtYXR0ZXJbXCJleG9fX0Fzc2V0X3VpZFwiXSk7XG4gICAgICBpZiAoIWlkUmVzdWx0LmlzU3VjY2Vzcykge1xuICAgICAgICBjb25zb2xlLndhcm4oYEludmFsaWQgQXNzZXQgSUQgZm9yICR7ZmlsZU5hbWV9OmAsIGlkUmVzdWx0LmdldEVycm9yKCkpO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGlkID0gaWRSZXN1bHQuZ2V0VmFsdWUoKSE7XG5cbiAgICAgIGNvbnN0IGxhYmVsID1cbiAgICAgICAgZnJvbnRtYXR0ZXJbXCJleG9fX0Fzc2V0X2xhYmVsXCJdIHx8IGZpbGVOYW1lLnJlcGxhY2UoXCIubWRcIiwgXCJcIik7XG5cbiAgICAgIGNvbnN0IGNsYXNzVmFsdWUgPSBBcnJheS5pc0FycmF5KGZyb250bWF0dGVyW1wiZXhvX19JbnN0YW5jZV9jbGFzc1wiXSlcbiAgICAgICAgPyBmcm9udG1hdHRlcltcImV4b19fSW5zdGFuY2VfY2xhc3NcIl1bMF1cbiAgICAgICAgOiBmcm9udG1hdHRlcltcImV4b19fSW5zdGFuY2VfY2xhc3NcIl07XG4gICAgICBjb25zdCBjbGFzc05hbWVSZXN1bHQgPSBDbGFzc05hbWUuY3JlYXRlKGNsYXNzVmFsdWUgfHwgXCJleG9fX0Fzc2V0XCIpO1xuICAgICAgY29uc3QgY2xhc3NOYW1lID0gY2xhc3NOYW1lUmVzdWx0LmlzU3VjY2Vzc1xuICAgICAgICA/IGNsYXNzTmFtZVJlc3VsdC5nZXRWYWx1ZSgpXG4gICAgICAgIDogQ2xhc3NOYW1lLmNyZWF0ZShcImV4b19fQXNzZXRcIikuZ2V0VmFsdWUoKSE7XG5cbiAgICAgIGNvbnN0IG9udG9sb2d5VmFsdWUgPVxuICAgICAgICBmcm9udG1hdHRlcltcImV4b19fQXNzZXRfaXNEZWZpbmVkQnlcIl0/LnJlcGxhY2UoL1xcW1xcWyE/fFxcXVxcXS9nLCBcIlwiKSB8fFxuICAgICAgICBcImV4b1wiO1xuICAgICAgY29uc3Qgb250b2xvZ3lSZXN1bHQgPSBPbnRvbG9neVByZWZpeC5jcmVhdGUob250b2xvZ3lWYWx1ZSk7XG4gICAgICBjb25zdCBvbnRvbG9neSA9IG9udG9sb2d5UmVzdWx0LmlzU3VjY2Vzc1xuICAgICAgICA/IG9udG9sb2d5UmVzdWx0LmdldFZhbHVlKClcbiAgICAgICAgOiBPbnRvbG9neVByZWZpeC5jcmVhdGUoXCJleG9cIikuZ2V0VmFsdWUoKSE7XG5cbiAgICAgIGNvbnN0IGNyZWF0ZWRBdCA9IG5ldyBEYXRlKGZyb250bWF0dGVyW1wiZXhvX19Bc3NldF9jcmVhdGVkQXRcIl0pO1xuICAgICAgaWYgKGlzTmFOKGNyZWF0ZWRBdC5nZXRUaW1lKCkpKSB7XG4gICAgICAgIGNvbnNvbGUud2FybihgSW52YWxpZCBjcmVhdGVkQXQgdGltZXN0YW1wIGZvciAke2ZpbGVOYW1lfWApO1xuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcHJvcGVydGllczogUmVjb3JkPHN0cmluZywgYW55PiA9IHt9O1xuICAgICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoZnJvbnRtYXR0ZXIpKSB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICAha2V5LnN0YXJ0c1dpdGgoXCJleG9fX0Fzc2V0X1wiKSAmJlxuICAgICAgICAgICFrZXkuc3RhcnRzV2l0aChcImV4b19fSW5zdGFuY2VfXCIpXG4gICAgICAgICkge1xuICAgICAgICAgIHByb3BlcnRpZXNba2V5XSA9IHZhbHVlO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFVzZSB0aGUgZmFjdG9yeSBtZXRob2QgaW5zdGVhZCBvZiBjb25zdHJ1Y3RvclxuICAgICAgY29uc3QgcmVzdWx0ID0gQXNzZXQuY3JlYXRlKHtcbiAgICAgICAgaWQsXG4gICAgICAgIGxhYmVsLFxuICAgICAgICBjbGFzc05hbWUsXG4gICAgICAgIG9udG9sb2d5LFxuICAgICAgICBwcm9wZXJ0aWVzLFxuICAgICAgfSk7XG5cbiAgICAgIGlmIChyZXN1bHQuaXNTdWNjZXNzKSB7XG4gICAgICAgIGNvbnN0IGFzc2V0ID0gcmVzdWx0LmdldFZhbHVlKCkhO1xuICAgICAgICAvLyBVcGRhdGUgdGltZXN0YW1wcyBhbmQgdmVyc2lvbiB3aXRoIHZhbGlkYXRlZCB2YWx1ZXNcbiAgICAgICAgKGFzc2V0IGFzIGFueSkucHJvcHMuY3JlYXRlZEF0ID0gY3JlYXRlZEF0O1xuICAgICAgICAoYXNzZXQgYXMgYW55KS5wcm9wcy52ZXJzaW9uID0gZnJvbnRtYXR0ZXJbXCJleG9fX0Fzc2V0X3ZlcnNpb25cIl0gfHwgMTtcblxuICAgICAgICBjb25zdCB1cGRhdGVkQXQgPSBmcm9udG1hdHRlcltcImV4b19fQXNzZXRfdXBkYXRlZEF0XCJdO1xuICAgICAgICBpZiAodXBkYXRlZEF0KSB7XG4gICAgICAgICAgY29uc3QgdXBkYXRlZEF0RGF0ZSA9IG5ldyBEYXRlKHVwZGF0ZWRBdCk7XG4gICAgICAgICAgaWYgKCFpc05hTih1cGRhdGVkQXREYXRlLmdldFRpbWUoKSkpIHtcbiAgICAgICAgICAgIChhc3NldCBhcyBhbnkpLnByb3BzLnVwZGF0ZWRBdCA9IHVwZGF0ZWRBdERhdGU7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGFzc2V0O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICAgIFwiRmFpbGVkIHRvIGNyZWF0ZSBhc3NldCBmcm9tIGZyb250bWF0dGVyOlwiLFxuICAgICAgICAgIHJlc3VsdC5nZXRFcnJvcigpLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKFwiRmFpbGVkIHRvIGNyZWF0ZSBhc3NldCBmcm9tIGZyb250bWF0dGVyOlwiLCBlcnJvcik7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==