6e029c3cfc8662087bc18d822346a38d
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ButtonCommand = exports.CommandType = void 0;
const Entity_1 = require("../core/Entity");
const Result_1 = require("../core/Result");
/**
 * Types of commands that can be executed
 */
var CommandType;
(function (CommandType) {
    CommandType["CREATE_ASSET"] = "CREATE_ASSET";
    CommandType["OPEN_ASSET"] = "OPEN_ASSET";
    CommandType["DELETE_ASSET"] = "DELETE_ASSET";
    CommandType["RUN_TEMPLATE"] = "RUN_TEMPLATE";
    CommandType["EXECUTE_SEARCH"] = "EXECUTE_SEARCH";
    CommandType["TRIGGER_WORKFLOW"] = "TRIGGER_WORKFLOW";
    CommandType["CUSTOM"] = "CUSTOM";
})(CommandType = exports.CommandType || (exports.CommandType = {}));
class ButtonCommand extends Entity_1.Entity {
    constructor(props) {
        super(props);
    }
    /**
     * Factory method with validation
     */
    static create(props) {
        // Validate command name
        if (!props.name || props.name.trim().length === 0) {
            return Result_1.Result.fail('Command name cannot be empty');
        }
        // Validate parameters if input is required
        if (props.requiresInput && (!props.parameters || props.parameters.length === 0)) {
            return Result_1.Result.fail('Commands requiring input must define parameters');
        }
        // Validate each parameter
        for (const param of props.parameters) {
            if (!param.name || param.name.trim().length === 0) {
                return Result_1.Result.fail('Parameter name cannot be empty');
            }
            if (param.validation) {
                try {
                    new RegExp(param.validation);
                }
                catch (e) {
                    return Result_1.Result.fail(`Invalid validation regex for parameter ${param.name}`);
                }
            }
        }
        // Validate command-specific requirements
        if (props.type === CommandType.RUN_TEMPLATE && !props.template) {
            return Result_1.Result.fail('Template commands must specify a template');
        }
        if (props.type === CommandType.CUSTOM && !props.script) {
            return Result_1.Result.fail('Custom commands must specify a script');
        }
        return Result_1.Result.ok(new ButtonCommand(props));
    }
    // Getters
    get id() {
        return this.props.id;
    }
    get type() {
        return this.props.type;
    }
    get name() {
        return this.props.name;
    }
    get description() {
        return this.props.description;
    }
    get requiresInput() {
        return this.props.requiresInput;
    }
    get parameters() {
        return this.props.parameters;
    }
    get targetClass() {
        return this.props.targetClass;
    }
    get template() {
        return this.props.template;
    }
    get script() {
        return this.props.script;
    }
    /**
     * Validate input parameters against command definition
     */
    validateInput(input) {
        const validated = {};
        const errors = [];
        for (const param of this.parameters) {
            const value = input[param.name];
            // Check required parameters
            if (param.required && (value === undefined || value === null || value === '')) {
                errors.push(`Required parameter '${param.name}' is missing`);
                continue;
            }
            // Skip optional parameters if not provided
            if (!param.required && (value === undefined || value === null)) {
                if (param.defaultValue !== undefined) {
                    validated[param.name] = param.defaultValue;
                }
                continue;
            }
            // Type validation
            if (!this.validateParameterType(value, param.type)) {
                errors.push(`Parameter '${param.name}' must be of type ${param.type}`);
                continue;
            }
            // Custom validation
            if (param.validation) {
                const regex = new RegExp(param.validation);
                if (!regex.test(String(value))) {
                    errors.push(`Parameter '${param.name}' does not match validation pattern`);
                    continue;
                }
            }
            validated[param.name] = value;
        }
        if (errors.length > 0) {
            return Result_1.Result.fail(errors.join('; '));
        }
        return Result_1.Result.ok(validated);
    }
    /**
     * Check if command can be executed in current context
     */
    canExecute(context) {
        // Check if command is applicable to current class
        if (this.targetClass && context.currentClass !== this.targetClass) {
            return false;
        }
        // Check if command requires selection
        if (this.type === CommandType.DELETE_ASSET && !context.hasSelection) {
            return false;
        }
        return true;
    }
    /**
     * Build execution context for the command
     */
    buildExecutionContext(input) {
        const validationResult = this.validateInput(input);
        if (validationResult.isFailure) {
            return Result_1.Result.fail(validationResult.error);
        }
        const context = {
            commandId: this.id.toString(),
            commandType: this.type,
            parameters: validationResult.getValue(),
            timestamp: new Date(),
            template: this.props.template,
            script: this.props.script,
            targetClass: this.props.targetClass
        };
        return Result_1.Result.ok(context);
    }
    validateParameterType(value, type) {
        switch (type) {
            case 'string':
                return typeof value === 'string';
            case 'number':
                return typeof value === 'number' || !isNaN(Number(value));
            case 'boolean':
                return typeof value === 'boolean' || value === 'true' || value === 'false';
            case 'date':
                return !isNaN(Date.parse(String(value)));
            case 'asset':
                return typeof value === 'string' && value.startsWith('[[') && value.endsWith(']]');
            case 'array':
                return Array.isArray(value) || typeof value === 'string';
            default:
                return true;
        }
    }
}
exports.ButtonCommand = ButtonCommand;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2RvbWFpbi9lbnRpdGllcy9CdXR0b25Db21tYW5kLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLDJDQUF3QztBQUV4QywyQ0FBd0M7QUFFeEM7O0dBRUc7QUFDSCxJQUFZLFdBUVg7QUFSRCxXQUFZLFdBQVc7SUFDbkIsNENBQTZCLENBQUE7SUFDN0Isd0NBQXlCLENBQUE7SUFDekIsNENBQTZCLENBQUE7SUFDN0IsNENBQTZCLENBQUE7SUFDN0IsZ0RBQWlDLENBQUE7SUFDakMsb0RBQXFDLENBQUE7SUFDckMsZ0NBQWlCLENBQUE7QUFDckIsQ0FBQyxFQVJXLFdBQVcsR0FBWCxtQkFBVyxLQUFYLG1CQUFXLFFBUXRCO0FBOEJELE1BQWEsYUFBYyxTQUFRLGVBQTBCO0lBQ3pELFlBQW9CLEtBQXlCO1FBQ3pDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNqQixDQUFDO0lBRUQ7O09BRUc7SUFDSSxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQXlCO1FBQzFDLHdCQUF3QjtRQUN4QixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDL0MsT0FBTyxlQUFNLENBQUMsSUFBSSxDQUFnQiw4QkFBOEIsQ0FBQyxDQUFDO1NBQ3JFO1FBRUQsMkNBQTJDO1FBQzNDLElBQUksS0FBSyxDQUFDLGFBQWEsSUFBSSxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQVUsSUFBSSxLQUFLLENBQUMsVUFBVSxDQUFDLE1BQU0sS0FBSyxDQUFDLENBQUMsRUFBRTtZQUM3RSxPQUFPLGVBQU0sQ0FBQyxJQUFJLENBQWdCLGlEQUFpRCxDQUFDLENBQUM7U0FDeEY7UUFFRCwwQkFBMEI7UUFDMUIsS0FBSyxNQUFNLEtBQUssSUFBSSxLQUFLLENBQUMsVUFBVSxFQUFFO1lBQ2xDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRTtnQkFDL0MsT0FBTyxlQUFNLENBQUMsSUFBSSxDQUFnQixnQ0FBZ0MsQ0FBQyxDQUFDO2FBQ3ZFO1lBRUQsSUFBSSxLQUFLLENBQUMsVUFBVSxFQUFFO2dCQUNsQixJQUFJO29CQUNBLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUMsQ0FBQztpQkFDaEM7Z0JBQUMsT0FBTyxDQUFDLEVBQUU7b0JBQ1IsT0FBTyxlQUFNLENBQUMsSUFBSSxDQUFnQiwwQ0FBMEMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7aUJBQzdGO2FBQ0o7U0FDSjtRQUVELHlDQUF5QztRQUN6QyxJQUFJLEtBQUssQ0FBQyxJQUFJLEtBQUssV0FBVyxDQUFDLFlBQVksSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUU7WUFDNUQsT0FBTyxlQUFNLENBQUMsSUFBSSxDQUFnQiwyQ0FBMkMsQ0FBQyxDQUFDO1NBQ2xGO1FBRUQsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLFdBQVcsQ0FBQyxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFO1lBQ3BELE9BQU8sZUFBTSxDQUFDLElBQUksQ0FBZ0IsdUNBQXVDLENBQUMsQ0FBQztTQUM5RTtRQUVELE9BQU8sZUFBTSxDQUFDLEVBQUUsQ0FBZ0IsSUFBSSxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUM5RCxDQUFDO0lBRUQsVUFBVTtJQUNWLElBQUksRUFBRTtRQUNGLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7SUFDekIsQ0FBQztJQUVELElBQUksSUFBSTtRQUNKLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUM7SUFDM0IsQ0FBQztJQUVELElBQUksSUFBSTtRQUNKLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUM7SUFDM0IsQ0FBQztJQUVELElBQUksV0FBVztRQUNYLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUM7SUFDbEMsQ0FBQztJQUVELElBQUksYUFBYTtRQUNiLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUM7SUFDcEMsQ0FBQztJQUVELElBQUksVUFBVTtRQUNWLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxVQUFVLENBQUM7SUFDakMsQ0FBQztJQUVELElBQUksV0FBVztRQUNYLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxXQUFXLENBQUM7SUFDbEMsQ0FBQztJQUVELElBQUksUUFBUTtRQUNSLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUM7SUFDL0IsQ0FBQztJQUVELElBQUksTUFBTTtRQUNOLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUM7SUFDN0IsQ0FBQztJQUVEOztPQUVHO0lBQ0ksYUFBYSxDQUFDLEtBQTBCO1FBQzNDLE1BQU0sU0FBUyxHQUF3QixFQUFFLENBQUM7UUFDMUMsTUFBTSxNQUFNLEdBQWEsRUFBRSxDQUFDO1FBRTVCLEtBQUssTUFBTSxLQUFLLElBQUksSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNqQyxNQUFNLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBRWhDLDRCQUE0QjtZQUM1QixJQUFJLEtBQUssQ0FBQyxRQUFRLElBQUksQ0FBQyxLQUFLLEtBQUssU0FBUyxJQUFJLEtBQUssS0FBSyxJQUFJLElBQUksS0FBSyxLQUFLLEVBQUUsQ0FBQyxFQUFFO2dCQUMzRSxNQUFNLENBQUMsSUFBSSxDQUFDLHVCQUF1QixLQUFLLENBQUMsSUFBSSxjQUFjLENBQUMsQ0FBQztnQkFDN0QsU0FBUzthQUNaO1lBRUQsMkNBQTJDO1lBQzNDLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxJQUFJLENBQUMsS0FBSyxLQUFLLFNBQVMsSUFBSSxLQUFLLEtBQUssSUFBSSxDQUFDLEVBQUU7Z0JBQzVELElBQUksS0FBSyxDQUFDLFlBQVksS0FBSyxTQUFTLEVBQUU7b0JBQ2xDLFNBQVMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsS0FBSyxDQUFDLFlBQVksQ0FBQztpQkFDOUM7Z0JBQ0QsU0FBUzthQUNaO1lBRUQsa0JBQWtCO1lBQ2xCLElBQUksQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUMsS0FBSyxFQUFFLEtBQUssQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDaEQsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLEtBQUssQ0FBQyxJQUFJLHFCQUFxQixLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztnQkFDdkUsU0FBUzthQUNaO1lBRUQsb0JBQW9CO1lBQ3BCLElBQUksS0FBSyxDQUFDLFVBQVUsRUFBRTtnQkFDbEIsTUFBTSxLQUFLLEdBQUcsSUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDO2dCQUMzQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRTtvQkFDNUIsTUFBTSxDQUFDLElBQUksQ0FBQyxjQUFjLEtBQUssQ0FBQyxJQUFJLHFDQUFxQyxDQUFDLENBQUM7b0JBQzNFLFNBQVM7aUJBQ1o7YUFDSjtZQUVELFNBQVMsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsS0FBSyxDQUFDO1NBQ2pDO1FBRUQsSUFBSSxNQUFNLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUNuQixPQUFPLGVBQU0sQ0FBQyxJQUFJLENBQXNCLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztTQUM5RDtRQUVELE9BQU8sZUFBTSxDQUFDLEVBQUUsQ0FBc0IsU0FBUyxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVEOztPQUVHO0lBQ0ksVUFBVSxDQUFDLE9BQTBEO1FBQ3hFLGtEQUFrRDtRQUNsRCxJQUFJLElBQUksQ0FBQyxXQUFXLElBQUksT0FBTyxDQUFDLFlBQVksS0FBSyxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQy9ELE9BQU8sS0FBSyxDQUFDO1NBQ2hCO1FBRUQsc0NBQXNDO1FBQ3RDLElBQUksSUFBSSxDQUFDLElBQUksS0FBSyxXQUFXLENBQUMsWUFBWSxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRTtZQUNqRSxPQUFPLEtBQUssQ0FBQztTQUNoQjtRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFFRDs7T0FFRztJQUNJLHFCQUFxQixDQUFDLEtBQTBCO1FBQ25ELE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUVuRCxJQUFJLGdCQUFnQixDQUFDLFNBQVMsRUFBRTtZQUM1QixPQUFPLGVBQU0sQ0FBQyxJQUFJLENBQTBCLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3ZFO1FBRUQsTUFBTSxPQUFPLEdBQTRCO1lBQ3JDLFNBQVMsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRTtZQUM3QixXQUFXLEVBQUUsSUFBSSxDQUFDLElBQUk7WUFDdEIsVUFBVSxFQUFFLGdCQUFnQixDQUFDLFFBQVEsRUFBRTtZQUN2QyxTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUU7WUFDckIsUUFBUSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUTtZQUM3QixNQUFNLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNO1lBQ3pCLFdBQVcsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVc7U0FDdEMsQ0FBQztRQUVGLE9BQU8sZUFBTSxDQUFDLEVBQUUsQ0FBMEIsT0FBTyxDQUFDLENBQUM7SUFDdkQsQ0FBQztJQUVPLHFCQUFxQixDQUFDLEtBQVUsRUFBRSxJQUFZO1FBQ2xELFFBQVEsSUFBSSxFQUFFO1lBQ1YsS0FBSyxRQUFRO2dCQUNULE9BQU8sT0FBTyxLQUFLLEtBQUssUUFBUSxDQUFDO1lBQ3JDLEtBQUssUUFBUTtnQkFDVCxPQUFPLE9BQU8sS0FBSyxLQUFLLFFBQVEsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztZQUM5RCxLQUFLLFNBQVM7Z0JBQ1YsT0FBTyxPQUFPLEtBQUssS0FBSyxTQUFTLElBQUksS0FBSyxLQUFLLE1BQU0sSUFBSSxLQUFLLEtBQUssT0FBTyxDQUFDO1lBQy9FLEtBQUssTUFBTTtnQkFDUCxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM3QyxLQUFLLE9BQU87Z0JBQ1IsT0FBTyxPQUFPLEtBQUssS0FBSyxRQUFRLElBQUksS0FBSyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3ZGLEtBQUssT0FBTztnQkFDUixPQUFPLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxDQUFDO1lBQzdEO2dCQUNJLE9BQU8sSUFBSSxDQUFDO1NBQ25CO0lBQ0wsQ0FBQztDQUNKO0FBOUxELHNDQThMQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva2l0ZWxldi9Eb2N1bWVudHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi9zcmMvZG9tYWluL2VudGl0aWVzL0J1dHRvbkNvbW1hbmQudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRW50aXR5IH0gZnJvbSAnLi4vY29yZS9FbnRpdHknO1xuaW1wb3J0IHsgQXNzZXRJZCB9IGZyb20gJy4uL3ZhbHVlLW9iamVjdHMvQXNzZXRJZCc7XG5pbXBvcnQgeyBSZXN1bHQgfSBmcm9tICcuLi9jb3JlL1Jlc3VsdCc7XG5cbi8qKlxuICogVHlwZXMgb2YgY29tbWFuZHMgdGhhdCBjYW4gYmUgZXhlY3V0ZWRcbiAqL1xuZXhwb3J0IGVudW0gQ29tbWFuZFR5cGUge1xuICAgIENSRUFURV9BU1NFVCA9ICdDUkVBVEVfQVNTRVQnLFxuICAgIE9QRU5fQVNTRVQgPSAnT1BFTl9BU1NFVCcsXG4gICAgREVMRVRFX0FTU0VUID0gJ0RFTEVURV9BU1NFVCcsXG4gICAgUlVOX1RFTVBMQVRFID0gJ1JVTl9URU1QTEFURScsXG4gICAgRVhFQ1VURV9TRUFSQ0ggPSAnRVhFQ1VURV9TRUFSQ0gnLFxuICAgIFRSSUdHRVJfV09SS0ZMT1cgPSAnVFJJR0dFUl9XT1JLRkxPVycsXG4gICAgQ1VTVE9NID0gJ0NVU1RPTSdcbn1cblxuLyoqXG4gKiBQYXJhbWV0ZXIgZGVmaW5pdGlvbiBmb3IgY29tbWFuZCBpbnB1dHNcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDb21tYW5kUGFyYW1ldGVyIHtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgdHlwZTogJ3N0cmluZycgfCAnbnVtYmVyJyB8ICdib29sZWFuJyB8ICdhc3NldCcgfCAnZGF0ZScgfCAnYXJyYXknO1xuICAgIHJlcXVpcmVkOiBib29sZWFuO1xuICAgIGRlZmF1bHRWYWx1ZT86IGFueTtcbiAgICBsYWJlbD86IHN0cmluZztcbiAgICBkZXNjcmlwdGlvbj86IHN0cmluZztcbiAgICB2YWxpZGF0aW9uPzogc3RyaW5nOyAvLyBSZWdleCBvciB2YWxpZGF0aW9uIHJ1bGVcbn1cblxuLyoqXG4gKiBEb21haW4gRW50aXR5IHJlcHJlc2VudGluZyBhIEJ1dHRvbiBDb21tYW5kXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQnV0dG9uQ29tbWFuZFByb3BzIHtcbiAgICBpZDogQXNzZXRJZDtcbiAgICB0eXBlOiBDb21tYW5kVHlwZTtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XG4gICAgcmVxdWlyZXNJbnB1dDogYm9vbGVhbjtcbiAgICBwYXJhbWV0ZXJzOiBDb21tYW5kUGFyYW1ldGVyW107XG4gICAgdGFyZ2V0Q2xhc3M/OiBzdHJpbmc7IC8vIEZvciBjb21tYW5kcyB0aGF0IG9wZXJhdGUgb24gc3BlY2lmaWMgY2xhc3Nlc1xuICAgIHRlbXBsYXRlPzogc3RyaW5nOyAvLyBGb3IgdGVtcGxhdGUtYmFzZWQgY29tbWFuZHNcbiAgICBzY3JpcHQ/OiBzdHJpbmc7IC8vIEZvciBjdXN0b20gc2NyaXB0IGNvbW1hbmRzXG59XG5cbmV4cG9ydCBjbGFzcyBCdXR0b25Db21tYW5kIGV4dGVuZHMgRW50aXR5PEJ1dHRvbkNvbW1hbmRQcm9wcz4ge1xuICAgIHByaXZhdGUgY29uc3RydWN0b3IocHJvcHM6IEJ1dHRvbkNvbW1hbmRQcm9wcykge1xuICAgICAgICBzdXBlcihwcm9wcyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRmFjdG9yeSBtZXRob2Qgd2l0aCB2YWxpZGF0aW9uXG4gICAgICovXG4gICAgcHVibGljIHN0YXRpYyBjcmVhdGUocHJvcHM6IEJ1dHRvbkNvbW1hbmRQcm9wcyk6IFJlc3VsdDxCdXR0b25Db21tYW5kPiB7XG4gICAgICAgIC8vIFZhbGlkYXRlIGNvbW1hbmQgbmFtZVxuICAgICAgICBpZiAoIXByb3BzLm5hbWUgfHwgcHJvcHMubmFtZS50cmltKCkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8QnV0dG9uQ29tbWFuZD4oJ0NvbW1hbmQgbmFtZSBjYW5ub3QgYmUgZW1wdHknKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFZhbGlkYXRlIHBhcmFtZXRlcnMgaWYgaW5wdXQgaXMgcmVxdWlyZWRcbiAgICAgICAgaWYgKHByb3BzLnJlcXVpcmVzSW5wdXQgJiYgKCFwcm9wcy5wYXJhbWV0ZXJzIHx8IHByb3BzLnBhcmFtZXRlcnMubGVuZ3RoID09PSAwKSkge1xuICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPEJ1dHRvbkNvbW1hbmQ+KCdDb21tYW5kcyByZXF1aXJpbmcgaW5wdXQgbXVzdCBkZWZpbmUgcGFyYW1ldGVycycpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gVmFsaWRhdGUgZWFjaCBwYXJhbWV0ZXJcbiAgICAgICAgZm9yIChjb25zdCBwYXJhbSBvZiBwcm9wcy5wYXJhbWV0ZXJzKSB7XG4gICAgICAgICAgICBpZiAoIXBhcmFtLm5hbWUgfHwgcGFyYW0ubmFtZS50cmltKCkubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPEJ1dHRvbkNvbW1hbmQ+KCdQYXJhbWV0ZXIgbmFtZSBjYW5ub3QgYmUgZW1wdHknKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKHBhcmFtLnZhbGlkYXRpb24pIHtcbiAgICAgICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgICAgICBuZXcgUmVnRXhwKHBhcmFtLnZhbGlkYXRpb24pO1xuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPEJ1dHRvbkNvbW1hbmQ+KGBJbnZhbGlkIHZhbGlkYXRpb24gcmVnZXggZm9yIHBhcmFtZXRlciAke3BhcmFtLm5hbWV9YCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gVmFsaWRhdGUgY29tbWFuZC1zcGVjaWZpYyByZXF1aXJlbWVudHNcbiAgICAgICAgaWYgKHByb3BzLnR5cGUgPT09IENvbW1hbmRUeXBlLlJVTl9URU1QTEFURSAmJiAhcHJvcHMudGVtcGxhdGUpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxCdXR0b25Db21tYW5kPignVGVtcGxhdGUgY29tbWFuZHMgbXVzdCBzcGVjaWZ5IGEgdGVtcGxhdGUnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChwcm9wcy50eXBlID09PSBDb21tYW5kVHlwZS5DVVNUT00gJiYgIXByb3BzLnNjcmlwdCkge1xuICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPEJ1dHRvbkNvbW1hbmQ+KCdDdXN0b20gY29tbWFuZHMgbXVzdCBzcGVjaWZ5IGEgc2NyaXB0Jyk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gUmVzdWx0Lm9rPEJ1dHRvbkNvbW1hbmQ+KG5ldyBCdXR0b25Db21tYW5kKHByb3BzKSk7XG4gICAgfVxuXG4gICAgLy8gR2V0dGVyc1xuICAgIGdldCBpZCgpOiBBc3NldElkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvcHMuaWQ7XG4gICAgfVxuXG4gICAgZ2V0IHR5cGUoKTogQ29tbWFuZFR5cGUge1xuICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy50eXBlO1xuICAgIH1cblxuICAgIGdldCBuYW1lKCk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiB0aGlzLnByb3BzLm5hbWU7XG4gICAgfVxuXG4gICAgZ2V0IGRlc2NyaXB0aW9uKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiB0aGlzLnByb3BzLmRlc2NyaXB0aW9uO1xuICAgIH1cblxuICAgIGdldCByZXF1aXJlc0lucHV0KCk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy5yZXF1aXJlc0lucHV0O1xuICAgIH1cblxuICAgIGdldCBwYXJhbWV0ZXJzKCk6IENvbW1hbmRQYXJhbWV0ZXJbXSB7XG4gICAgICAgIHJldHVybiB0aGlzLnByb3BzLnBhcmFtZXRlcnM7XG4gICAgfVxuXG4gICAgZ2V0IHRhcmdldENsYXNzKCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiB0aGlzLnByb3BzLnRhcmdldENsYXNzO1xuICAgIH1cblxuICAgIGdldCB0ZW1wbGF0ZSgpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgICAgICByZXR1cm4gdGhpcy5wcm9wcy50ZW1wbGF0ZTtcbiAgICB9XG5cbiAgICBnZXQgc2NyaXB0KCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiB0aGlzLnByb3BzLnNjcmlwdDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBWYWxpZGF0ZSBpbnB1dCBwYXJhbWV0ZXJzIGFnYWluc3QgY29tbWFuZCBkZWZpbml0aW9uXG4gICAgICovXG4gICAgcHVibGljIHZhbGlkYXRlSW5wdXQoaW5wdXQ6IFJlY29yZDxzdHJpbmcsIGFueT4pOiBSZXN1bHQ8UmVjb3JkPHN0cmluZywgYW55Pj4ge1xuICAgICAgICBjb25zdCB2YWxpZGF0ZWQ6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcbiAgICAgICAgY29uc3QgZXJyb3JzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgICAgIGZvciAoY29uc3QgcGFyYW0gb2YgdGhpcy5wYXJhbWV0ZXJzKSB7XG4gICAgICAgICAgICBjb25zdCB2YWx1ZSA9IGlucHV0W3BhcmFtLm5hbWVdO1xuXG4gICAgICAgICAgICAvLyBDaGVjayByZXF1aXJlZCBwYXJhbWV0ZXJzXG4gICAgICAgICAgICBpZiAocGFyYW0ucmVxdWlyZWQgJiYgKHZhbHVlID09PSB1bmRlZmluZWQgfHwgdmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09ICcnKSkge1xuICAgICAgICAgICAgICAgIGVycm9ycy5wdXNoKGBSZXF1aXJlZCBwYXJhbWV0ZXIgJyR7cGFyYW0ubmFtZX0nIGlzIG1pc3NpbmdgKTtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gU2tpcCBvcHRpb25hbCBwYXJhbWV0ZXJzIGlmIG5vdCBwcm92aWRlZFxuICAgICAgICAgICAgaWYgKCFwYXJhbS5yZXF1aXJlZCAmJiAodmFsdWUgPT09IHVuZGVmaW5lZCB8fCB2YWx1ZSA9PT0gbnVsbCkpIHtcbiAgICAgICAgICAgICAgICBpZiAocGFyYW0uZGVmYXVsdFZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVkW3BhcmFtLm5hbWVdID0gcGFyYW0uZGVmYXVsdFZhbHVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gVHlwZSB2YWxpZGF0aW9uXG4gICAgICAgICAgICBpZiAoIXRoaXMudmFsaWRhdGVQYXJhbWV0ZXJUeXBlKHZhbHVlLCBwYXJhbS50eXBlKSkge1xuICAgICAgICAgICAgICAgIGVycm9ycy5wdXNoKGBQYXJhbWV0ZXIgJyR7cGFyYW0ubmFtZX0nIG11c3QgYmUgb2YgdHlwZSAke3BhcmFtLnR5cGV9YCk7XG4gICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIEN1c3RvbSB2YWxpZGF0aW9uXG4gICAgICAgICAgICBpZiAocGFyYW0udmFsaWRhdGlvbikge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlZ2V4ID0gbmV3IFJlZ0V4cChwYXJhbS52YWxpZGF0aW9uKTtcbiAgICAgICAgICAgICAgICBpZiAoIXJlZ2V4LnRlc3QoU3RyaW5nKHZhbHVlKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgZXJyb3JzLnB1c2goYFBhcmFtZXRlciAnJHtwYXJhbS5uYW1lfScgZG9lcyBub3QgbWF0Y2ggdmFsaWRhdGlvbiBwYXR0ZXJuYCk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdmFsaWRhdGVkW3BhcmFtLm5hbWVdID0gdmFsdWU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxSZWNvcmQ8c3RyaW5nLCBhbnk+PihlcnJvcnMuam9pbignOyAnKSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gUmVzdWx0Lm9rPFJlY29yZDxzdHJpbmcsIGFueT4+KHZhbGlkYXRlZCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgaWYgY29tbWFuZCBjYW4gYmUgZXhlY3V0ZWQgaW4gY3VycmVudCBjb250ZXh0XG4gICAgICovXG4gICAgcHVibGljIGNhbkV4ZWN1dGUoY29udGV4dDogeyBjdXJyZW50Q2xhc3M/OiBzdHJpbmc7IGhhc1NlbGVjdGlvbj86IGJvb2xlYW4gfSk6IGJvb2xlYW4ge1xuICAgICAgICAvLyBDaGVjayBpZiBjb21tYW5kIGlzIGFwcGxpY2FibGUgdG8gY3VycmVudCBjbGFzc1xuICAgICAgICBpZiAodGhpcy50YXJnZXRDbGFzcyAmJiBjb250ZXh0LmN1cnJlbnRDbGFzcyAhPT0gdGhpcy50YXJnZXRDbGFzcykge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ2hlY2sgaWYgY29tbWFuZCByZXF1aXJlcyBzZWxlY3Rpb25cbiAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gQ29tbWFuZFR5cGUuREVMRVRFX0FTU0VUICYmICFjb250ZXh0Lmhhc1NlbGVjdGlvbikge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQnVpbGQgZXhlY3V0aW9uIGNvbnRleHQgZm9yIHRoZSBjb21tYW5kXG4gICAgICovXG4gICAgcHVibGljIGJ1aWxkRXhlY3V0aW9uQ29udGV4dChpbnB1dDogUmVjb3JkPHN0cmluZywgYW55Pik6IFJlc3VsdDxDb21tYW5kRXhlY3V0aW9uQ29udGV4dD4ge1xuICAgICAgICBjb25zdCB2YWxpZGF0aW9uUmVzdWx0ID0gdGhpcy52YWxpZGF0ZUlucHV0KGlucHV0KTtcbiAgICAgICAgXG4gICAgICAgIGlmICh2YWxpZGF0aW9uUmVzdWx0LmlzRmFpbHVyZSkge1xuICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPENvbW1hbmRFeGVjdXRpb25Db250ZXh0Pih2YWxpZGF0aW9uUmVzdWx0LmVycm9yKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNvbnRleHQ6IENvbW1hbmRFeGVjdXRpb25Db250ZXh0ID0ge1xuICAgICAgICAgICAgY29tbWFuZElkOiB0aGlzLmlkLnRvU3RyaW5nKCksXG4gICAgICAgICAgICBjb21tYW5kVHlwZTogdGhpcy50eXBlLFxuICAgICAgICAgICAgcGFyYW1ldGVyczogdmFsaWRhdGlvblJlc3VsdC5nZXRWYWx1ZSgpLFxuICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgICAgdGVtcGxhdGU6IHRoaXMucHJvcHMudGVtcGxhdGUsXG4gICAgICAgICAgICBzY3JpcHQ6IHRoaXMucHJvcHMuc2NyaXB0LFxuICAgICAgICAgICAgdGFyZ2V0Q2xhc3M6IHRoaXMucHJvcHMudGFyZ2V0Q2xhc3NcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gUmVzdWx0Lm9rPENvbW1hbmRFeGVjdXRpb25Db250ZXh0Pihjb250ZXh0KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHZhbGlkYXRlUGFyYW1ldGVyVHlwZSh2YWx1ZTogYW55LCB0eXBlOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICAgICAgICBjYXNlICdzdHJpbmcnOlxuICAgICAgICAgICAgICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdzdHJpbmcnO1xuICAgICAgICAgICAgY2FzZSAnbnVtYmVyJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJyB8fCAhaXNOYU4oTnVtYmVyKHZhbHVlKSk7XG4gICAgICAgICAgICBjYXNlICdib29sZWFuJzpcbiAgICAgICAgICAgICAgICByZXR1cm4gdHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbicgfHwgdmFsdWUgPT09ICd0cnVlJyB8fCB2YWx1ZSA9PT0gJ2ZhbHNlJztcbiAgICAgICAgICAgIGNhc2UgJ2RhdGUnOlxuICAgICAgICAgICAgICAgIHJldHVybiAhaXNOYU4oRGF0ZS5wYXJzZShTdHJpbmcodmFsdWUpKSk7XG4gICAgICAgICAgICBjYXNlICdhc3NldCc6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycgJiYgdmFsdWUuc3RhcnRzV2l0aCgnW1snKSAmJiB2YWx1ZS5lbmRzV2l0aCgnXV0nKTtcbiAgICAgICAgICAgIGNhc2UgJ2FycmF5JzpcbiAgICAgICAgICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheSh2YWx1ZSkgfHwgdHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbi8qKlxuICogQ29udGV4dCBmb3IgY29tbWFuZCBleGVjdXRpb25cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDb21tYW5kRXhlY3V0aW9uQ29udGV4dCB7XG4gICAgY29tbWFuZElkOiBzdHJpbmc7XG4gICAgY29tbWFuZFR5cGU6IENvbW1hbmRUeXBlO1xuICAgIHBhcmFtZXRlcnM6IFJlY29yZDxzdHJpbmcsIGFueT47XG4gICAgdGltZXN0YW1wOiBEYXRlO1xuICAgIHRlbXBsYXRlPzogc3RyaW5nO1xuICAgIHNjcmlwdD86IHN0cmluZztcbiAgICB0YXJnZXRDbGFzcz86IHN0cmluZztcbn0iXSwidmVyc2lvbiI6M30=