69403c16defa05c7007b8425ed8ebcbb
"use strict";
/**
 * Namespace Manager for handling RDF namespace prefixes and URI expansion
 * Manages common RDF vocabularies and custom namespace prefixes
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.NamespaceManager = void 0;
const Triple_1 = require("../../domain/semantic/core/Triple");
const Result_1 = require("../../domain/core/Result");
class NamespaceManager {
    constructor() {
        this.bindings = new Map();
        this.reverseBindings = new Map();
        this.initializeDefaultNamespaces();
    }
    /**
     * Initialize common RDF namespace prefixes
     */
    initializeDefaultNamespaces() {
        this.addBinding('rdf', 'http://www.w3.org/1999/02/22-rdf-syntax-ns#');
        this.addBinding('rdfs', 'http://www.w3.org/2000/01/rdf-schema#');
        this.addBinding('owl', 'http://www.w3.org/2002/07/owl#');
        this.addBinding('xsd', 'http://www.w3.org/2001/XMLSchema#');
        this.addBinding('dc', 'http://purl.org/dc/elements/1.1/');
        this.addBinding('dcterms', 'http://purl.org/dc/terms/');
        this.addBinding('foaf', 'http://xmlns.com/foaf/0.1/');
        this.addBinding('skos', 'http://www.w3.org/2004/02/skos/core#');
        this.addBinding('void', 'http://rdfs.org/ns/void#');
        // Exocortex namespaces
        this.addBinding('exo', 'https://exocortex.io/ontology/core#');
        this.addBinding('ems', 'https://exocortex.io/ontology/ems#');
        this.addBinding('vault', 'obsidian://vault/');
    }
    /**
     * Add a namespace binding
     */
    addBinding(prefix, namespace) {
        try {
            const iri = new Triple_1.IRI(namespace);
            this.bindings.set(prefix, iri);
            this.reverseBindings.set(namespace, prefix);
        }
        catch (error) {
            console.warn(`Invalid namespace URI for prefix ${prefix}: ${namespace}`);
        }
    }
    /**
     * Remove a namespace binding
     */
    removeBinding(prefix) {
        const namespace = this.bindings.get(prefix);
        if (namespace) {
            this.bindings.delete(prefix);
            this.reverseBindings.delete(namespace.toString());
        }
    }
    /**
     * Get namespace URI for a prefix
     */
    getNamespace(prefix) {
        return this.bindings.get(prefix);
    }
    /**
     * Get prefix for a namespace URI
     */
    getPrefix(namespace) {
        return this.reverseBindings.get(namespace);
    }
    /**
     * Expand a CURIE (Compact URI) to full IRI
     */
    expandCURIE(curie) {
        const colonIndex = curie.indexOf(':');
        if (colonIndex === -1) {
            return Result_1.Result.fail(`Invalid CURIE format: ${curie}`);
        }
        const prefix = curie.substring(0, colonIndex);
        const localName = curie.substring(colonIndex + 1);
        const namespace = this.bindings.get(prefix);
        if (!namespace) {
            return Result_1.Result.fail(`Unknown prefix: ${prefix}`);
        }
        try {
            const fullIRI = new Triple_1.IRI(namespace.toString() + localName);
            return Result_1.Result.ok(fullIRI);
        }
        catch (error) {
            return Result_1.Result.fail(`Invalid expanded IRI: ${error.message}`);
        }
    }
    /**
     * Compress a full IRI to CURIE if possible
     */
    compressIRI(iri) {
        const iriString = iri.toString();
        // Try to find a matching namespace
        for (const [namespace, prefix] of this.reverseBindings) {
            if (iriString.startsWith(namespace)) {
                const localName = iriString.substring(namespace.length);
                // Only compress if the local name is valid
                if (this.isValidLocalName(localName)) {
                    return `${prefix}:${localName}`;
                }
            }
        }
        // Return full IRI if no compression possible
        return `<${iriString}>`;
    }
    /**
     * Check if a local name is valid for CURIE compression
     */
    isValidLocalName(localName) {
        // Basic validation - should start with letter or underscore
        // and contain only alphanumeric characters, hyphens, underscores
        return /^[a-zA-Z_][a-zA-Z0-9_-]*$/.test(localName);
    }
    /**
     * Parse and add namespace prefixes from RDF content
     */
    parseNamespaces(content, format) {
        const lines = content.split('\n');
        for (const line of lines) {
            const trimmed = line.trim();
            if (format === 'turtle' || format === 'n3') {
                // Parse @prefix declarations
                const prefixMatch = trimmed.match(/^@prefix\s+(\w+):\s+<([^>]+)>\s*\.\s*$/);
                if (prefixMatch) {
                    const [, prefix, namespace] = prefixMatch;
                    this.addBinding(prefix, namespace);
                    continue;
                }
                // Parse PREFIX declarations (SPARQL style)
                const sparqlPrefixMatch = trimmed.match(/^PREFIX\s+(\w+):\s+<([^>]+)>\s*$/);
                if (sparqlPrefixMatch) {
                    const [, prefix, namespace] = sparqlPrefixMatch;
                    this.addBinding(prefix, namespace);
                }
            }
        }
    }
    /**
     * Generate namespace prefix declarations for a format
     */
    generatePrefixDeclarations(format) {
        const declarations = [];
        for (const [prefix, namespace] of this.bindings) {
            switch (format) {
                case 'turtle':
                case 'n3':
                    declarations.push(`@prefix ${prefix}: <${namespace.toString()}> .`);
                    break;
                case 'sparql':
                    declarations.push(`PREFIX ${prefix}: <${namespace.toString()}>`);
                    break;
            }
        }
        return declarations.join('\n');
    }
    /**
     * Get all namespace bindings
     */
    getAllBindings() {
        return Array.from(this.bindings.entries()).map(([prefix, namespace]) => ({
            prefix,
            namespace
        }));
    }
    /**
     * Clear all custom bindings (keeps default ones)
     */
    clearCustomBindings() {
        this.bindings.clear();
        this.reverseBindings.clear();
        this.initializeDefaultNamespaces();
    }
    /**
     * Check if a prefix exists
     */
    hasPrefix(prefix) {
        return this.bindings.has(prefix);
    }
    /**
     * Check if a namespace exists
     */
    hasNamespace(namespace) {
        return this.reverseBindings.has(namespace);
    }
    /**
     * Create a copy of the namespace manager
     */
    clone() {
        const clone = new NamespaceManager();
        clone.clearCustomBindings();
        for (const [prefix, namespace] of this.bindings) {
            clone.addBinding(prefix, namespace.toString());
        }
        return clone;
    }
}
exports.NamespaceManager = NamespaceManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2FwcGxpY2F0aW9uL3NlcnZpY2VzL05hbWVzcGFjZU1hbmFnZXIudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7O0FBRUgsOERBQXdEO0FBQ3hELHFEQUFrRDtBQU9sRCxNQUFhLGdCQUFnQjtJQUl6QjtRQUhRLGFBQVEsR0FBcUIsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUN2QyxvQkFBZSxHQUF3QixJQUFJLEdBQUcsRUFBRSxDQUFDO1FBR3JELElBQUksQ0FBQywyQkFBMkIsRUFBRSxDQUFDO0lBQ3ZDLENBQUM7SUFFRDs7T0FFRztJQUNLLDJCQUEyQjtRQUMvQixJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSw2Q0FBNkMsQ0FBQyxDQUFDO1FBQ3RFLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLHVDQUF1QyxDQUFDLENBQUM7UUFDakUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsZ0NBQWdDLENBQUMsQ0FBQztRQUN6RCxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxtQ0FBbUMsQ0FBQyxDQUFDO1FBQzVELElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLGtDQUFrQyxDQUFDLENBQUM7UUFDMUQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLEVBQUUsMkJBQTJCLENBQUMsQ0FBQztRQUN4RCxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSw0QkFBNEIsQ0FBQyxDQUFDO1FBQ3RELElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLHNDQUFzQyxDQUFDLENBQUM7UUFDaEUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsMEJBQTBCLENBQUMsQ0FBQztRQUVwRCx1QkFBdUI7UUFDdkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUscUNBQXFDLENBQUMsQ0FBQztRQUM5RCxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxvQ0FBb0MsQ0FBQyxDQUFDO1FBQzdELElBQUksQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLG1CQUFtQixDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUVEOztPQUVHO0lBQ0gsVUFBVSxDQUFDLE1BQWMsRUFBRSxTQUFpQjtRQUN4QyxJQUFJO1lBQ0EsTUFBTSxHQUFHLEdBQUcsSUFBSSxZQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDL0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQy9CLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQztTQUMvQztRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ1osT0FBTyxDQUFDLElBQUksQ0FBQyxvQ0FBb0MsTUFBTSxLQUFLLFNBQVMsRUFBRSxDQUFDLENBQUM7U0FDNUU7SUFDTCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxhQUFhLENBQUMsTUFBYztRQUN4QixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM1QyxJQUFJLFNBQVMsRUFBRTtZQUNYLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzdCLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1NBQ3JEO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0gsWUFBWSxDQUFDLE1BQWM7UUFDdkIsT0FBTyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNyQyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxTQUFTLENBQUMsU0FBaUI7UUFDdkIsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUMvQyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxXQUFXLENBQUMsS0FBYTtRQUNyQixNQUFNLFVBQVUsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3RDLElBQUksVUFBVSxLQUFLLENBQUMsQ0FBQyxFQUFFO1lBQ25CLE9BQU8sZUFBTSxDQUFDLElBQUksQ0FBQyx5QkFBeUIsS0FBSyxFQUFFLENBQUMsQ0FBQztTQUN4RDtRQUVELE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxDQUFDO1FBQzlDLE1BQU0sU0FBUyxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRWxELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzVDLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDWixPQUFPLGVBQU0sQ0FBQyxJQUFJLENBQUMsbUJBQW1CLE1BQU0sRUFBRSxDQUFDLENBQUM7U0FDbkQ7UUFFRCxJQUFJO1lBQ0EsTUFBTSxPQUFPLEdBQUcsSUFBSSxZQUFHLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxHQUFHLFNBQVMsQ0FBQyxDQUFDO1lBQzFELE9BQU8sZUFBTSxDQUFDLEVBQUUsQ0FBQyxPQUFPLENBQUMsQ0FBQztTQUM3QjtRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ1osT0FBTyxlQUFNLENBQUMsSUFBSSxDQUFDLHlCQUF5QixLQUFLLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztTQUNoRTtJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNILFdBQVcsQ0FBQyxHQUFRO1FBQ2hCLE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQyxRQUFRLEVBQUUsQ0FBQztRQUVqQyxtQ0FBbUM7UUFDbkMsS0FBSyxNQUFNLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxlQUFlLEVBQUU7WUFDcEQsSUFBSSxTQUFTLENBQUMsVUFBVSxDQUFDLFNBQVMsQ0FBQyxFQUFFO2dCQUNqQyxNQUFNLFNBQVMsR0FBRyxTQUFTLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDeEQsMkNBQTJDO2dCQUMzQyxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTLENBQUMsRUFBRTtvQkFDbEMsT0FBTyxHQUFHLE1BQU0sSUFBSSxTQUFTLEVBQUUsQ0FBQztpQkFDbkM7YUFDSjtTQUNKO1FBRUQsNkNBQTZDO1FBQzdDLE9BQU8sSUFBSSxTQUFTLEdBQUcsQ0FBQztJQUM1QixDQUFDO0lBRUQ7O09BRUc7SUFDSyxnQkFBZ0IsQ0FBQyxTQUFpQjtRQUN0Qyw0REFBNEQ7UUFDNUQsaUVBQWlFO1FBQ2pFLE9BQU8sMkJBQTJCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFFRDs7T0FFRztJQUNILGVBQWUsQ0FBQyxPQUFlLEVBQUUsTUFBdUI7UUFDcEQsTUFBTSxLQUFLLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUVsQyxLQUFLLE1BQU0sSUFBSSxJQUFJLEtBQUssRUFBRTtZQUN0QixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7WUFFNUIsSUFBSSxNQUFNLEtBQUssUUFBUSxJQUFJLE1BQU0sS0FBSyxJQUFJLEVBQUU7Z0JBQ3hDLDZCQUE2QjtnQkFDN0IsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyx3Q0FBd0MsQ0FBQyxDQUFDO2dCQUM1RSxJQUFJLFdBQVcsRUFBRTtvQkFDYixNQUFNLENBQUMsRUFBRSxNQUFNLEVBQUUsU0FBUyxDQUFDLEdBQUcsV0FBVyxDQUFDO29CQUMxQyxJQUFJLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQztvQkFDbkMsU0FBUztpQkFDWjtnQkFFRCwyQ0FBMkM7Z0JBQzNDLE1BQU0saUJBQWlCLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO2dCQUM1RSxJQUFJLGlCQUFpQixFQUFFO29CQUNuQixNQUFNLENBQUMsRUFBRSxNQUFNLEVBQUUsU0FBUyxDQUFDLEdBQUcsaUJBQWlCLENBQUM7b0JBQ2hELElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFDO2lCQUN0QzthQUNKO1NBQ0o7SUFDTCxDQUFDO0lBRUQ7O09BRUc7SUFDSCwwQkFBMEIsQ0FBQyxNQUFrQztRQUN6RCxNQUFNLFlBQVksR0FBYSxFQUFFLENBQUM7UUFFbEMsS0FBSyxNQUFNLENBQUMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDN0MsUUFBUSxNQUFNLEVBQUU7Z0JBQ1osS0FBSyxRQUFRLENBQUM7Z0JBQ2QsS0FBSyxJQUFJO29CQUNMLFlBQVksQ0FBQyxJQUFJLENBQUMsV0FBVyxNQUFNLE1BQU0sU0FBUyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztvQkFDcEUsTUFBTTtnQkFDVixLQUFLLFFBQVE7b0JBQ1QsWUFBWSxDQUFDLElBQUksQ0FBQyxVQUFVLE1BQU0sTUFBTSxTQUFTLENBQUMsUUFBUSxFQUFFLEdBQUcsQ0FBQyxDQUFDO29CQUNqRSxNQUFNO2FBQ2I7U0FDSjtRQUVELE9BQU8sWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxjQUFjO1FBQ1YsT0FBTyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUNyRSxNQUFNO1lBQ04sU0FBUztTQUNaLENBQUMsQ0FBQyxDQUFDO0lBQ1IsQ0FBQztJQUVEOztPQUVHO0lBQ0gsbUJBQW1CO1FBQ2YsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUN0QixJQUFJLENBQUMsZUFBZSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQzdCLElBQUksQ0FBQywyQkFBMkIsRUFBRSxDQUFDO0lBQ3ZDLENBQUM7SUFFRDs7T0FFRztJQUNILFNBQVMsQ0FBQyxNQUFjO1FBQ3BCLE9BQU8sSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsWUFBWSxDQUFDLFNBQWlCO1FBQzFCLE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSztRQUNELE1BQU0sS0FBSyxHQUFHLElBQUksZ0JBQWdCLEVBQUUsQ0FBQztRQUNyQyxLQUFLLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztRQUU1QixLQUFLLE1BQU0sQ0FBQyxNQUFNLEVBQUUsU0FBUyxDQUFDLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUM3QyxLQUFLLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQztTQUNsRDtRQUVELE9BQU8sS0FBSyxDQUFDO0lBQ2pCLENBQUM7Q0FDSjtBQXhORCw0Q0F3TkMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2FwcGxpY2F0aW9uL3NlcnZpY2VzL05hbWVzcGFjZU1hbmFnZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBOYW1lc3BhY2UgTWFuYWdlciBmb3IgaGFuZGxpbmcgUkRGIG5hbWVzcGFjZSBwcmVmaXhlcyBhbmQgVVJJIGV4cGFuc2lvblxuICogTWFuYWdlcyBjb21tb24gUkRGIHZvY2FidWxhcmllcyBhbmQgY3VzdG9tIG5hbWVzcGFjZSBwcmVmaXhlc1xuICovXG5cbmltcG9ydCB7IElSSSB9IGZyb20gJy4uLy4uL2RvbWFpbi9zZW1hbnRpYy9jb3JlL1RyaXBsZSc7XG5pbXBvcnQgeyBSZXN1bHQgfSBmcm9tICcuLi8uLi9kb21haW4vY29yZS9SZXN1bHQnO1xuXG5leHBvcnQgaW50ZXJmYWNlIE5hbWVzcGFjZUJpbmRpbmcge1xuICAgIHByZWZpeDogc3RyaW5nO1xuICAgIG5hbWVzcGFjZTogSVJJO1xufVxuXG5leHBvcnQgY2xhc3MgTmFtZXNwYWNlTWFuYWdlciB7XG4gICAgcHJpdmF0ZSBiaW5kaW5nczogTWFwPHN0cmluZywgSVJJPiA9IG5ldyBNYXAoKTtcbiAgICBwcml2YXRlIHJldmVyc2VCaW5kaW5nczogTWFwPHN0cmluZywgc3RyaW5nPiA9IG5ldyBNYXAoKTtcbiAgICBcbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgdGhpcy5pbml0aWFsaXplRGVmYXVsdE5hbWVzcGFjZXMoKTtcbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogSW5pdGlhbGl6ZSBjb21tb24gUkRGIG5hbWVzcGFjZSBwcmVmaXhlc1xuICAgICAqL1xuICAgIHByaXZhdGUgaW5pdGlhbGl6ZURlZmF1bHROYW1lc3BhY2VzKCk6IHZvaWQge1xuICAgICAgICB0aGlzLmFkZEJpbmRpbmcoJ3JkZicsICdodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjJyk7XG4gICAgICAgIHRoaXMuYWRkQmluZGluZygncmRmcycsICdodHRwOi8vd3d3LnczLm9yZy8yMDAwLzAxL3JkZi1zY2hlbWEjJyk7XG4gICAgICAgIHRoaXMuYWRkQmluZGluZygnb3dsJywgJ2h0dHA6Ly93d3cudzMub3JnLzIwMDIvMDcvb3dsIycpO1xuICAgICAgICB0aGlzLmFkZEJpbmRpbmcoJ3hzZCcsICdodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSMnKTtcbiAgICAgICAgdGhpcy5hZGRCaW5kaW5nKCdkYycsICdodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLycpO1xuICAgICAgICB0aGlzLmFkZEJpbmRpbmcoJ2RjdGVybXMnLCAnaHR0cDovL3B1cmwub3JnL2RjL3Rlcm1zLycpO1xuICAgICAgICB0aGlzLmFkZEJpbmRpbmcoJ2ZvYWYnLCAnaHR0cDovL3htbG5zLmNvbS9mb2FmLzAuMS8nKTtcbiAgICAgICAgdGhpcy5hZGRCaW5kaW5nKCdza29zJywgJ2h0dHA6Ly93d3cudzMub3JnLzIwMDQvMDIvc2tvcy9jb3JlIycpO1xuICAgICAgICB0aGlzLmFkZEJpbmRpbmcoJ3ZvaWQnLCAnaHR0cDovL3JkZnMub3JnL25zL3ZvaWQjJyk7XG4gICAgICAgIFxuICAgICAgICAvLyBFeG9jb3J0ZXggbmFtZXNwYWNlc1xuICAgICAgICB0aGlzLmFkZEJpbmRpbmcoJ2V4bycsICdodHRwczovL2V4b2NvcnRleC5pby9vbnRvbG9neS9jb3JlIycpO1xuICAgICAgICB0aGlzLmFkZEJpbmRpbmcoJ2VtcycsICdodHRwczovL2V4b2NvcnRleC5pby9vbnRvbG9neS9lbXMjJyk7XG4gICAgICAgIHRoaXMuYWRkQmluZGluZygndmF1bHQnLCAnb2JzaWRpYW46Ly92YXVsdC8nKTtcbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogQWRkIGEgbmFtZXNwYWNlIGJpbmRpbmdcbiAgICAgKi9cbiAgICBhZGRCaW5kaW5nKHByZWZpeDogc3RyaW5nLCBuYW1lc3BhY2U6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgaXJpID0gbmV3IElSSShuYW1lc3BhY2UpO1xuICAgICAgICAgICAgdGhpcy5iaW5kaW5ncy5zZXQocHJlZml4LCBpcmkpO1xuICAgICAgICAgICAgdGhpcy5yZXZlcnNlQmluZGluZ3Muc2V0KG5hbWVzcGFjZSwgcHJlZml4KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihgSW52YWxpZCBuYW1lc3BhY2UgVVJJIGZvciBwcmVmaXggJHtwcmVmaXh9OiAke25hbWVzcGFjZX1gKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBSZW1vdmUgYSBuYW1lc3BhY2UgYmluZGluZ1xuICAgICAqL1xuICAgIHJlbW92ZUJpbmRpbmcocHJlZml4OiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgbmFtZXNwYWNlID0gdGhpcy5iaW5kaW5ncy5nZXQocHJlZml4KTtcbiAgICAgICAgaWYgKG5hbWVzcGFjZSkge1xuICAgICAgICAgICAgdGhpcy5iaW5kaW5ncy5kZWxldGUocHJlZml4KTtcbiAgICAgICAgICAgIHRoaXMucmV2ZXJzZUJpbmRpbmdzLmRlbGV0ZShuYW1lc3BhY2UudG9TdHJpbmcoKSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogR2V0IG5hbWVzcGFjZSBVUkkgZm9yIGEgcHJlZml4XG4gICAgICovXG4gICAgZ2V0TmFtZXNwYWNlKHByZWZpeDogc3RyaW5nKTogSVJJIHwgdW5kZWZpbmVkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYmluZGluZ3MuZ2V0KHByZWZpeCk7XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIEdldCBwcmVmaXggZm9yIGEgbmFtZXNwYWNlIFVSSVxuICAgICAqL1xuICAgIGdldFByZWZpeChuYW1lc3BhY2U6IHN0cmluZyk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgICAgIHJldHVybiB0aGlzLnJldmVyc2VCaW5kaW5ncy5nZXQobmFtZXNwYWNlKTtcbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogRXhwYW5kIGEgQ1VSSUUgKENvbXBhY3QgVVJJKSB0byBmdWxsIElSSVxuICAgICAqL1xuICAgIGV4cGFuZENVUklFKGN1cmllOiBzdHJpbmcpOiBSZXN1bHQ8SVJJPiB7XG4gICAgICAgIGNvbnN0IGNvbG9uSW5kZXggPSBjdXJpZS5pbmRleE9mKCc6Jyk7XG4gICAgICAgIGlmIChjb2xvbkluZGV4ID09PSAtMSkge1xuICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsKGBJbnZhbGlkIENVUklFIGZvcm1hdDogJHtjdXJpZX1gKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgY29uc3QgcHJlZml4ID0gY3VyaWUuc3Vic3RyaW5nKDAsIGNvbG9uSW5kZXgpO1xuICAgICAgICBjb25zdCBsb2NhbE5hbWUgPSBjdXJpZS5zdWJzdHJpbmcoY29sb25JbmRleCArIDEpO1xuICAgICAgICBcbiAgICAgICAgY29uc3QgbmFtZXNwYWNlID0gdGhpcy5iaW5kaW5ncy5nZXQocHJlZml4KTtcbiAgICAgICAgaWYgKCFuYW1lc3BhY2UpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbChgVW5rbm93biBwcmVmaXg6ICR7cHJlZml4fWApO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgZnVsbElSSSA9IG5ldyBJUkkobmFtZXNwYWNlLnRvU3RyaW5nKCkgKyBsb2NhbE5hbWUpO1xuICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5vayhmdWxsSVJJKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbChgSW52YWxpZCBleHBhbmRlZCBJUkk6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBDb21wcmVzcyBhIGZ1bGwgSVJJIHRvIENVUklFIGlmIHBvc3NpYmxlXG4gICAgICovXG4gICAgY29tcHJlc3NJUkkoaXJpOiBJUkkpOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBpcmlTdHJpbmcgPSBpcmkudG9TdHJpbmcoKTtcbiAgICAgICAgXG4gICAgICAgIC8vIFRyeSB0byBmaW5kIGEgbWF0Y2hpbmcgbmFtZXNwYWNlXG4gICAgICAgIGZvciAoY29uc3QgW25hbWVzcGFjZSwgcHJlZml4XSBvZiB0aGlzLnJldmVyc2VCaW5kaW5ncykge1xuICAgICAgICAgICAgaWYgKGlyaVN0cmluZy5zdGFydHNXaXRoKG5hbWVzcGFjZSkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBsb2NhbE5hbWUgPSBpcmlTdHJpbmcuc3Vic3RyaW5nKG5hbWVzcGFjZS5sZW5ndGgpO1xuICAgICAgICAgICAgICAgIC8vIE9ubHkgY29tcHJlc3MgaWYgdGhlIGxvY2FsIG5hbWUgaXMgdmFsaWRcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc1ZhbGlkTG9jYWxOYW1lKGxvY2FsTmFtZSkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGAke3ByZWZpeH06JHtsb2NhbE5hbWV9YDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIC8vIFJldHVybiBmdWxsIElSSSBpZiBubyBjb21wcmVzc2lvbiBwb3NzaWJsZVxuICAgICAgICByZXR1cm4gYDwke2lyaVN0cmluZ30+YDtcbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogQ2hlY2sgaWYgYSBsb2NhbCBuYW1lIGlzIHZhbGlkIGZvciBDVVJJRSBjb21wcmVzc2lvblxuICAgICAqL1xuICAgIHByaXZhdGUgaXNWYWxpZExvY2FsTmFtZShsb2NhbE5hbWU6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICAvLyBCYXNpYyB2YWxpZGF0aW9uIC0gc2hvdWxkIHN0YXJ0IHdpdGggbGV0dGVyIG9yIHVuZGVyc2NvcmVcbiAgICAgICAgLy8gYW5kIGNvbnRhaW4gb25seSBhbHBoYW51bWVyaWMgY2hhcmFjdGVycywgaHlwaGVucywgdW5kZXJzY29yZXNcbiAgICAgICAgcmV0dXJuIC9eW2EtekEtWl9dW2EtekEtWjAtOV8tXSokLy50ZXN0KGxvY2FsTmFtZSk7XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIFBhcnNlIGFuZCBhZGQgbmFtZXNwYWNlIHByZWZpeGVzIGZyb20gUkRGIGNvbnRlbnRcbiAgICAgKi9cbiAgICBwYXJzZU5hbWVzcGFjZXMoY29udGVudDogc3RyaW5nLCBmb3JtYXQ6ICd0dXJ0bGUnIHwgJ24zJyk6IHZvaWQge1xuICAgICAgICBjb25zdCBsaW5lcyA9IGNvbnRlbnQuc3BsaXQoJ1xcbicpO1xuICAgICAgICBcbiAgICAgICAgZm9yIChjb25zdCBsaW5lIG9mIGxpbmVzKSB7XG4gICAgICAgICAgICBjb25zdCB0cmltbWVkID0gbGluZS50cmltKCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChmb3JtYXQgPT09ICd0dXJ0bGUnIHx8IGZvcm1hdCA9PT0gJ24zJykge1xuICAgICAgICAgICAgICAgIC8vIFBhcnNlIEBwcmVmaXggZGVjbGFyYXRpb25zXG4gICAgICAgICAgICAgICAgY29uc3QgcHJlZml4TWF0Y2ggPSB0cmltbWVkLm1hdGNoKC9eQHByZWZpeFxccysoXFx3Kyk6XFxzKzwoW14+XSspPlxccypcXC5cXHMqJC8pO1xuICAgICAgICAgICAgICAgIGlmIChwcmVmaXhNYXRjaCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBbLCBwcmVmaXgsIG5hbWVzcGFjZV0gPSBwcmVmaXhNYXRjaDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRCaW5kaW5nKHByZWZpeCwgbmFtZXNwYWNlKTtcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFBhcnNlIFBSRUZJWCBkZWNsYXJhdGlvbnMgKFNQQVJRTCBzdHlsZSlcbiAgICAgICAgICAgICAgICBjb25zdCBzcGFycWxQcmVmaXhNYXRjaCA9IHRyaW1tZWQubWF0Y2goL15QUkVGSVhcXHMrKFxcdyspOlxccys8KFtePl0rKT5cXHMqJC8pO1xuICAgICAgICAgICAgICAgIGlmIChzcGFycWxQcmVmaXhNYXRjaCkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBbLCBwcmVmaXgsIG5hbWVzcGFjZV0gPSBzcGFycWxQcmVmaXhNYXRjaDtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5hZGRCaW5kaW5nKHByZWZpeCwgbmFtZXNwYWNlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogR2VuZXJhdGUgbmFtZXNwYWNlIHByZWZpeCBkZWNsYXJhdGlvbnMgZm9yIGEgZm9ybWF0XG4gICAgICovXG4gICAgZ2VuZXJhdGVQcmVmaXhEZWNsYXJhdGlvbnMoZm9ybWF0OiAndHVydGxlJyB8ICduMycgfCAnc3BhcnFsJyk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IGRlY2xhcmF0aW9uczogc3RyaW5nW10gPSBbXTtcbiAgICAgICAgXG4gICAgICAgIGZvciAoY29uc3QgW3ByZWZpeCwgbmFtZXNwYWNlXSBvZiB0aGlzLmJpbmRpbmdzKSB7XG4gICAgICAgICAgICBzd2l0Y2ggKGZvcm1hdCkge1xuICAgICAgICAgICAgICAgIGNhc2UgJ3R1cnRsZSc6XG4gICAgICAgICAgICAgICAgY2FzZSAnbjMnOlxuICAgICAgICAgICAgICAgICAgICBkZWNsYXJhdGlvbnMucHVzaChgQHByZWZpeCAke3ByZWZpeH06IDwke25hbWVzcGFjZS50b1N0cmluZygpfT4gLmApO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlICdzcGFycWwnOlxuICAgICAgICAgICAgICAgICAgICBkZWNsYXJhdGlvbnMucHVzaChgUFJFRklYICR7cHJlZml4fTogPCR7bmFtZXNwYWNlLnRvU3RyaW5nKCl9PmApO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIGRlY2xhcmF0aW9ucy5qb2luKCdcXG4nKTtcbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogR2V0IGFsbCBuYW1lc3BhY2UgYmluZGluZ3NcbiAgICAgKi9cbiAgICBnZXRBbGxCaW5kaW5ncygpOiBOYW1lc3BhY2VCaW5kaW5nW10ge1xuICAgICAgICByZXR1cm4gQXJyYXkuZnJvbSh0aGlzLmJpbmRpbmdzLmVudHJpZXMoKSkubWFwKChbcHJlZml4LCBuYW1lc3BhY2VdKSA9PiAoe1xuICAgICAgICAgICAgcHJlZml4LFxuICAgICAgICAgICAgbmFtZXNwYWNlXG4gICAgICAgIH0pKTtcbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogQ2xlYXIgYWxsIGN1c3RvbSBiaW5kaW5ncyAoa2VlcHMgZGVmYXVsdCBvbmVzKVxuICAgICAqL1xuICAgIGNsZWFyQ3VzdG9tQmluZGluZ3MoKTogdm9pZCB7XG4gICAgICAgIHRoaXMuYmluZGluZ3MuY2xlYXIoKTtcbiAgICAgICAgdGhpcy5yZXZlcnNlQmluZGluZ3MuY2xlYXIoKTtcbiAgICAgICAgdGhpcy5pbml0aWFsaXplRGVmYXVsdE5hbWVzcGFjZXMoKTtcbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogQ2hlY2sgaWYgYSBwcmVmaXggZXhpc3RzXG4gICAgICovXG4gICAgaGFzUHJlZml4KHByZWZpeDogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiB0aGlzLmJpbmRpbmdzLmhhcyhwcmVmaXgpO1xuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBDaGVjayBpZiBhIG5hbWVzcGFjZSBleGlzdHNcbiAgICAgKi9cbiAgICBoYXNOYW1lc3BhY2UobmFtZXNwYWNlOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmV2ZXJzZUJpbmRpbmdzLmhhcyhuYW1lc3BhY2UpO1xuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBjb3B5IG9mIHRoZSBuYW1lc3BhY2UgbWFuYWdlclxuICAgICAqL1xuICAgIGNsb25lKCk6IE5hbWVzcGFjZU1hbmFnZXIge1xuICAgICAgICBjb25zdCBjbG9uZSA9IG5ldyBOYW1lc3BhY2VNYW5hZ2VyKCk7XG4gICAgICAgIGNsb25lLmNsZWFyQ3VzdG9tQmluZGluZ3MoKTtcbiAgICAgICAgXG4gICAgICAgIGZvciAoY29uc3QgW3ByZWZpeCwgbmFtZXNwYWNlXSBvZiB0aGlzLmJpbmRpbmdzKSB7XG4gICAgICAgICAgICBjbG9uZS5hZGRCaW5kaW5nKHByZWZpeCwgbmFtZXNwYWNlLnRvU3RyaW5nKCkpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gY2xvbmU7XG4gICAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==