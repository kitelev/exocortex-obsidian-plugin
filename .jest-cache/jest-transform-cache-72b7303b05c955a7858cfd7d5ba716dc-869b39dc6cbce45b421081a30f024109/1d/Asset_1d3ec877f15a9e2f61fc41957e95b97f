f2b75136ea474e1eb239d6d836b0a0b2
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Asset = void 0;
const AssetId_1 = require("../value-objects/AssetId");
const ClassName_1 = require("../value-objects/ClassName");
const OntologyPrefix_1 = require("../value-objects/OntologyPrefix");
const Entity_1 = require("../core/Entity");
const Result_1 = require("../core/Result");
/**
 * Domain entity representing an Exocortex Asset
 * Core business logic and invariants
 */
class Asset extends Entity_1.Entity {
    constructor(props) {
        super(props);
    }
    static create(params) {
        if (!params.label || params.label.trim().length === 0) {
            return Result_1.Result.fail('Asset label cannot be empty');
        }
        const props = {
            id: params.id,
            title: params.label,
            className: params.className,
            ontology: params.ontology,
            label: params.label,
            description: params.description,
            properties: new Map(Object.entries(params.properties || {})),
            createdAt: new Date(),
            updatedAt: new Date()
        };
        return Result_1.Result.ok(new Asset(props));
    }
    // Getters
    getId() {
        return this.props.id;
    }
    getTitle() {
        return this.props.title;
    }
    getClassName() {
        return this.props.className;
    }
    getOntologyPrefix() {
        return this.props.ontology;
    }
    getProperties() {
        return new Map(this.props.properties);
    }
    getProperty(key) {
        return this.props.properties.get(key);
    }
    getCreatedAt() {
        return this.props.createdAt;
    }
    getUpdatedAt() {
        return this.props.updatedAt;
    }
    // Business methods
    updateTitle(title) {
        if (!title || title.trim().length === 0) {
            throw new Error('Asset title cannot be empty');
        }
        this.props.title = title;
        this.props.updatedAt = new Date();
    }
    setProperty(key, value) {
        this.props.properties.set(key, value);
        this.props.updatedAt = new Date();
    }
    removeProperty(key) {
        this.props.properties.delete(key);
        this.props.updatedAt = new Date();
    }
    changeClass(className) {
        this.props.className = className;
        this.props.updatedAt = new Date();
    }
    toFrontmatter() {
        const frontmatter = {
            'exo__Asset_uid': this.props.id.toString(),
            'exo__Asset_label': this.props.title,
            'exo__Asset_isDefinedBy': `[[!${this.props.ontology.toString()}]]`,
            'exo__Asset_createdAt': this.props.createdAt.toISOString(),
            'exo__Instance_class': [this.props.className.toWikiLink()]
        };
        // Add custom properties
        for (const [key, value] of this.props.properties) {
            if (!frontmatter[key]) {
                frontmatter[key] = value;
            }
        }
        return frontmatter;
    }
    static fromFrontmatter(frontmatter, fileName) {
        var _a;
        try {
            const idResult = AssetId_1.AssetId.create(frontmatter['exo__Asset_uid'] || AssetId_1.AssetId.generate().toString());
            const id = idResult.isSuccess ? idResult.getValue() : AssetId_1.AssetId.generate();
            const label = frontmatter['exo__Asset_label'] || fileName.replace('.md', '');
            const classValue = Array.isArray(frontmatter['exo__Instance_class'])
                ? frontmatter['exo__Instance_class'][0]
                : frontmatter['exo__Instance_class'];
            const classNameResult = ClassName_1.ClassName.create(classValue || 'exo__Asset');
            const className = classNameResult.isSuccess ? classNameResult.getValue() : ClassName_1.ClassName.create('exo__Asset').getValue();
            const ontologyValue = ((_a = frontmatter['exo__Asset_isDefinedBy']) === null || _a === void 0 ? void 0 : _a.replace(/\[\[!?|\]\]/g, '')) || 'exo';
            const ontologyResult = OntologyPrefix_1.OntologyPrefix.create(ontologyValue);
            const ontology = ontologyResult.isSuccess ? ontologyResult.getValue() : OntologyPrefix_1.OntologyPrefix.create('exo').getValue();
            const createdAt = frontmatter['exo__Asset_createdAt']
                ? new Date(frontmatter['exo__Asset_createdAt'])
                : new Date();
            const properties = {};
            for (const [key, value] of Object.entries(frontmatter)) {
                if (!key.startsWith('exo__Asset_') && !key.startsWith('exo__Instance_')) {
                    properties[key] = value;
                }
            }
            // Use the factory method instead of constructor
            const result = Asset.create({
                id,
                label,
                className,
                ontology,
                properties
            });
            if (result.isSuccess) {
                const asset = result.getValue();
                // Update timestamps
                asset.props.createdAt = createdAt;
                return asset;
            }
            else {
                console.warn('Failed to create asset from frontmatter:', result.error);
            }
            return null;
        }
        catch (error) {
            console.warn('Failed to create asset from frontmatter:', error);
            return null;
        }
    }
}
exports.Asset = Asset;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2RvbWFpbi9lbnRpdGllcy9Bc3NldC50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSxzREFBbUQ7QUFDbkQsMERBQXVEO0FBQ3ZELG9FQUFpRTtBQUNqRSwyQ0FBd0M7QUFDeEMsMkNBQXdDO0FBZXhDOzs7R0FHRztBQUNILE1BQWEsS0FBTSxTQUFRLGVBQWtCO0lBRTNDLFlBQW9CLEtBQWlCO1FBQ25DLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNmLENBQUM7SUFFRCxNQUFNLENBQUMsTUFBTSxDQUFDLE1BT2I7UUFDQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssSUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDckQsT0FBTyxlQUFNLENBQUMsSUFBSSxDQUFRLDZCQUE2QixDQUFDLENBQUM7U0FDMUQ7UUFFRCxNQUFNLEtBQUssR0FBZTtZQUN4QixFQUFFLEVBQUUsTUFBTSxDQUFDLEVBQUU7WUFDYixLQUFLLEVBQUUsTUFBTSxDQUFDLEtBQUs7WUFDbkIsU0FBUyxFQUFFLE1BQU0sQ0FBQyxTQUFTO1lBQzNCLFFBQVEsRUFBRSxNQUFNLENBQUMsUUFBUTtZQUN6QixLQUFLLEVBQUUsTUFBTSxDQUFDLEtBQUs7WUFDbkIsV0FBVyxFQUFFLE1BQU0sQ0FBQyxXQUFXO1lBQy9CLFVBQVUsRUFBRSxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxVQUFVLElBQUksRUFBRSxDQUFDLENBQUM7WUFDNUQsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO1lBQ3JCLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtTQUN0QixDQUFDO1FBRUYsT0FBTyxlQUFNLENBQUMsRUFBRSxDQUFRLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVELFVBQVU7SUFDVixLQUFL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YUFDeEU7WUFFRCxPQUFPLElBQUksQ0FBQztTQUNiO1FBQUMsT0FBTyxLQUFLLEVBQUU7WUFDZCxPQUFPLENBQUMsSUFBSSxDQUFDLDBDQUEwQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ2hFLE9BQU8sSUFBSSxDQUFDO1NBQ2I7SUFDSCxDQUFDO0NBQ0Y7QUFoS0Qsc0JBZ0tDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9raXRlbGV2L0RvY3VtZW50cy9leG9jb3J0ZXgtb2JzaWRpYW4tcGx1Z2luL3NyYy9kb21haW4vZW50aXRpZXMvQXNzZXQudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXNzZXRJZCB9IGZyb20gJy4uL3ZhbHVlLW9iamVjdHMvQXNzZXRJZCc7XG5pbXBvcnQgeyBDbGFzc05hbWUgfSBmcm9tICcuLi92YWx1ZS1vYmplY3RzL0NsYXNzTmFtZSc7XG5pbXBvcnQgeyBPbnRvbG9neVByZWZpeCB9IGZyb20gJy4uL3ZhbHVlLW9iamVjdHMvT250b2xvZ3lQcmVmaXgnO1xuaW1wb3J0IHsgRW50aXR5IH0gZnJvbSAnLi4vY29yZS9FbnRpdHknO1xuaW1wb3J0IHsgUmVzdWx0IH0gZnJvbSAnLi4vY29yZS9SZXN1bHQnO1xuXG5pbnRlcmZhY2UgQXNzZXRQcm9wcyB7XG4gIGlkOiBBc3NldElkO1xuICB0aXRsZTogc3RyaW5nO1xuICBjbGFzc05hbWU6IENsYXNzTmFtZTtcbiAgb250b2xvZ3k6IE9udG9sb2d5UHJlZml4O1xuICBsYWJlbD86IHN0cmluZztcbiAgZGVzY3JpcHRpb24/OiBzdHJpbmc7XG4gIHByb3BlcnRpZXM6IE1hcDxzdHJpbmcsIGFueT47XG4gIGNyZWF0ZWRBdDogRGF0ZTtcbiAgdXBkYXRlZEF0OiBEYXRlO1xuICBmaWxlUGF0aD86IHN0cmluZzsgLy8gU3RvcmUgdGhlIGFjdHVhbCBmaWxlIHBhdGhcbn1cblxuLyoqXG4gKiBEb21haW4gZW50aXR5IHJlcHJlc2VudGluZyBhbiBFeG9jb3J0ZXggQXNzZXRcbiAqIENvcmUgYnVzaW5lc3MgbG9naWMgYW5kIGludmFyaWFudHNcbiAqL1xuZXhwb3J0IGNsYXNzIEFzc2V0IGV4dGVuZHMgRW50aXR5PEFzc2V0UHJvcHM+IHtcbiAgXG4gIHByaXZhdGUgY29uc3RydWN0b3IocHJvcHM6IEFzc2V0UHJvcHMpIHtcbiAgICBzdXBlcihwcm9wcyk7XG4gIH1cblxuICBzdGF0aWMgY3JlYXRlKHBhcmFtczoge1xuICAgIGlkOiBBc3NldElkO1xuICAgIGNsYXNzTmFtZTogQ2xhc3NOYW1lO1xuICAgIG9udG9sb2d5OiBPbnRvbG9neVByZWZpeDtcbiAgICBsYWJlbDogc3RyaW5nO1xuICAgIGRlc2NyaXB0aW9uPzogc3RyaW5nO1xuICAgIHByb3BlcnRpZXM/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xuICB9KTogUmVzdWx0PEFzc2V0PiB7XG4gICAgaWYgKCFwYXJhbXMubGFiZWwgfHwgcGFyYW1zLmxhYmVsLnRyaW0oKS5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxBc3NldD4oJ0Fzc2V0IGxhYmVsIGNhbm5vdCBiZSBlbXB0eScpO1xuICAgIH1cblxuICAgIGNvbnN0IHByb3BzOiBBc3NldFByb3BzID0ge1xuICAgICAgaWQ6IHBhcmFtcy5pZCxcbiAgICAgIHRpdGxlOiBwYXJhbXMubGFiZWwsXG4gICAgICBjbGFzc05hbWU6IHBhcmFtcy5jbGFzc05hbWUsXG4gICAgICBvbnRvbG9neTogcGFyYW1zLm9udG9sb2d5LFxuICAgICAgbGFiZWw6IHBhcmFtcy5sYWJlbCxcbiAgICAgIGRlc2NyaXB0aW9uOiBwYXJhbXMuZGVzY3JpcHRpb24sXG4gICAgICBwcm9wZXJ0aWVzOiBuZXcgTWFwKE9iamVjdC5lbnRyaWVzKHBhcmFtcy5wcm9wZXJ0aWVzIHx8IHt9KSksXG4gICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKClcbiAgICB9O1xuXG4gICAgcmV0dXJuIFJlc3VsdC5vazxBc3NldD4obmV3IEFzc2V0KHByb3BzKSk7XG4gIH1cblxuICAvLyBHZXR0ZXJzXG4gIGdldElkKCk6IEFzc2V0SWQge1xuICAgIHJldHVybiB0aGlzLnByb3BzLmlkO1xuICB9XG5cbiAgZ2V0VGl0bGUoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5wcm9wcy50aXRsZTtcbiAgfVxuXG4gIGdldENsYXNzTmFtZSgpOiBDbGFzc05hbWUge1xuICAgIHJldHVybiB0aGlzLnByb3BzLmNsYXNzTmFtZTtcbiAgfVxuXG4gIGdldE9udG9sb2d5UHJlZml4KCk6IE9udG9sb2d5UHJlZml4IHtcbiAgICByZXR1cm4gdGhpcy5wcm9wcy5vbnRvbG9neTtcbiAgfVxuXG4gIGdldFByb3BlcnRpZXMoKTogTWFwPHN0cmluZywgYW55PiB7XG4gICAgcmV0dXJuIG5ldyBNYXAodGhpcy5wcm9wcy5wcm9wZXJ0aWVzKTtcbiAgfVxuXG4gIGdldFByb3BlcnR5KGtleTogc3RyaW5nKTogYW55IHtcbiAgICByZXR1cm4gdGhpcy5wcm9wcy5wcm9wZXJ0aWVzLmdldChrZXkpO1xuICB9XG5cbiAgZ2V0Q3JlYXRlZEF0KCk6IERhdGUge1xuICAgIHJldHVybiB0aGlzLnByb3BzLmNyZWF0ZWRBdDtcbiAgfVxuXG4gIGdldFVwZGF0ZWRBdCgpOiBEYXRlIHtcbiAgICByZXR1cm4gdGhpcy5wcm9wcy51cGRhdGVkQXQ7XG4gIH1cblxuICAvLyBCdXNpbmVzcyBtZXRob2RzXG4gIHVwZGF0ZVRpdGxlKHRpdGxlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAoIXRpdGxlIHx8IHRpdGxlLnRyaW0oKS5sZW5ndGggPT09IDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQXNzZXQgdGl0bGUgY2Fubm90IGJlIGVtcHR5Jyk7XG4gICAgfVxuICAgIHRoaXMucHJvcHMudGl0bGUgPSB0aXRsZTtcbiAgICB0aGlzLnByb3BzLnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCk7XG4gIH1cblxuICBzZXRQcm9wZXJ0eShrZXk6IHN0cmluZywgdmFsdWU6IGFueSk6IHZvaWQge1xuICAgIHRoaXMucHJvcHMucHJvcGVydGllcy5zZXQoa2V5LCB2YWx1ZSk7XG4gICAgdGhpcy5wcm9wcy51cGRhdGVkQXQgPSBuZXcgRGF0ZSgpO1xuICB9XG5cbiAgcmVtb3ZlUHJvcGVydHkoa2V5OiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLnByb3BzLnByb3BlcnRpZXMuZGVsZXRlKGtleSk7XG4gICAgdGhpcy5wcm9wcy51cGRhdGVkQXQgPSBuZXcgRGF0ZSgpO1xuICB9XG5cbiAgY2hhbmdlQ2xhc3MoY2xhc3NOYW1lOiBDbGFzc05hbWUpOiB2b2lkIHtcbiAgICB0aGlzLnByb3BzLmNsYXNzTmFtZSA9IGNsYXNzTmFtZTtcbiAgICB0aGlzLnByb3BzLnVwZGF0ZWRBdCA9IG5ldyBEYXRlKCk7XG4gIH1cblxuICB0b0Zyb250bWF0dGVyKCk6IFJlY29yZDxzdHJpbmcsIGFueT4ge1xuICAgIGNvbnN0IGZyb250bWF0dGVyOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge1xuICAgICAgJ2V4b19fQXNzZXRfdWlkJzogdGhpcy5wcm9wcy5pZC50b1N0cmluZygpLFxuICAgICAgJ2V4b19fQXNzZXRfbGFiZWwnOiB0aGlzLnByb3BzLnRpdGxlLFxuICAgICAgJ2V4b19fQXNzZXRfaXNEZWZpbmVkQnknOiBgW1shJHt0aGlzLnByb3BzLm9udG9sb2d5LnRvU3RyaW5nKCl9XV1gLFxuICAgICAgJ2V4b19fQXNzZXRfY3JlYXRlZEF0JzogdGhpcy5wcm9wcy5jcmVhdGVkQXQudG9JU09TdHJpbmcoKSxcbiAgICAgICdleG9fX0luc3RhbmNlX2NsYXNzJzogW3RoaXMucHJvcHMuY2xhc3NOYW1lLnRvV2lraUxpbmsoKV1cbiAgICB9O1xuXG4gICAgLy8gQWRkIGN1c3RvbSBwcm9wZXJ0aWVzXG4gICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgdGhpcy5wcm9wcy5wcm9wZXJ0aWVzKSB7XG4gICAgICBpZiAoIWZyb250bWF0dGVyW2tleV0pIHtcbiAgICAgICAgZnJvbnRtYXR0ZXJba2V5XSA9IHZhbHVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBmcm9udG1hdHRlcjtcbiAgfVxuXG4gIHN0YXRpYyBmcm9tRnJvbnRtYXR0ZXIoZnJvbnRtYXR0ZXI6IFJlY29yZDxzdHJpbmcsIGFueT4sIGZpbGVOYW1lOiBzdHJpbmcpOiBBc3NldCB8IG51bGwge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBpZFJlc3VsdCA9IEFzc2V0SWQuY3JlYXRlKGZyb250bWF0dGVyWydleG9fX0Fzc2V0X3VpZCddIHx8IEFzc2V0SWQuZ2VuZXJhdGUoKS50b1N0cmluZygpKTtcbiAgICAgIGNvbnN0IGlkID0gaWRSZXN1bHQuaXNTdWNjZXNzID8gaWRSZXN1bHQuZ2V0VmFsdWUoKSA6IEFzc2V0SWQuZ2VuZXJhdGUoKTtcbiAgICAgIGNvbnN0IGxhYmVsID0gZnJvbnRtYXR0ZXJbJ2V4b19fQXNzZXRfbGFiZWwnXSB8fCBmaWxlTmFtZS5yZXBsYWNlKCcubWQnLCAnJyk7XG4gICAgICBcbiAgICAgIGNvbnN0IGNsYXNzVmFsdWUgPSBBcnJheS5pc0FycmF5KGZyb250bWF0dGVyWydleG9fX0luc3RhbmNlX2NsYXNzJ10pIFxuICAgICAgICA/IGZyb250bWF0dGVyWydleG9fX0luc3RhbmNlX2NsYXNzJ11bMF0gXG4gICAgICAgIDogZnJvbnRtYXR0ZXJbJ2V4b19fSW5zdGFuY2VfY2xhc3MnXTtcbiAgICAgIGNvbnN0IGNsYXNzTmFtZVJlc3VsdCA9IENsYXNzTmFtZS5jcmVhdGUoY2xhc3NWYWx1ZSB8fCAnZXhvX19Bc3NldCcpO1xuICAgICAgY29uc3QgY2xhc3NOYW1lID0gY2xhc3NOYW1lUmVzdWx0LmlzU3VjY2VzcyA/IGNsYXNzTmFtZVJlc3VsdC5nZXRWYWx1ZSgpIDogQ2xhc3NOYW1lLmNyZWF0ZSgnZXhvX19Bc3NldCcpLmdldFZhbHVlKCkhO1xuICAgICAgXG4gICAgICBjb25zdCBvbnRvbG9neVZhbHVlID0gZnJvbnRtYXR0ZXJbJ2V4b19fQXNzZXRfaXNEZWZpbmVkQnknXT8ucmVwbGFjZSgvXFxbXFxbIT98XFxdXFxdL2csICcnKSB8fCAnZXhvJztcbiAgICAgIGNvbnN0IG9udG9sb2d5UmVzdWx0ID0gT250b2xvZ3lQcmVmaXguY3JlYXRlKG9udG9sb2d5VmFsdWUpO1xuICAgICAgY29uc3Qgb250b2xvZ3kgPSBvbnRvbG9neVJlc3VsdC5pc1N1Y2Nlc3MgPyBvbnRvbG9neVJlc3VsdC5nZXRWYWx1ZSgpIDogT250b2xvZ3lQcmVmaXguY3JlYXRlKCdleG8nKS5nZXRWYWx1ZSgpITtcbiAgICAgIFxuICAgICAgY29uc3QgY3JlYXRlZEF0ID0gZnJvbnRtYXR0ZXJbJ2V4b19fQXNzZXRfY3JlYXRlZEF0J10gXG4gICAgICAgID8gbmV3IERhdGUoZnJvbnRtYXR0ZXJbJ2V4b19fQXNzZXRfY3JlYXRlZEF0J10pIFxuICAgICAgICA6IG5ldyBEYXRlKCk7XG4gICAgICBcbiAgICAgIGNvbnN0IHByb3BlcnRpZXM6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcbiAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGZyb250bWF0dGVyKSkge1xuICAgICAgICBpZiAoIWtleS5zdGFydHNXaXRoKCdleG9fX0Fzc2V0XycpICYmICFrZXkuc3RhcnRzV2l0aCgnZXhvX19JbnN0YW5jZV8nKSkge1xuICAgICAgICAgIHByb3BlcnRpZXNba2V5XSA9IHZhbHVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBcbiAgICAgIC8vIFVzZSB0aGUgZmFjdG9yeSBtZXRob2QgaW5zdGVhZCBvZiBjb25zdHJ1Y3RvclxuICAgICAgY29uc3QgcmVzdWx0ID0gQXNzZXQuY3JlYXRlKHtcbiAgICAgICAgaWQsXG4gICAgICAgIGxhYmVsLFxuICAgICAgICBjbGFzc05hbWUsXG4gICAgICAgIG9udG9sb2d5LFxuICAgICAgICBwcm9wZXJ0aWVzXG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgaWYgKHJlc3VsdC5pc1N1Y2Nlc3MpIHtcbiAgICAgICAgY29uc3QgYXNzZXQgPSByZXN1bHQuZ2V0VmFsdWUoKSE7XG4gICAgICAgIC8vIFVwZGF0ZSB0aW1lc3RhbXBzXG4gICAgICAgIChhc3NldCBhcyBhbnkpLnByb3BzLmNyZWF0ZWRBdCA9IGNyZWF0ZWRBdDtcbiAgICAgICAgcmV0dXJuIGFzc2V0O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS53YXJuKCdGYWlsZWQgdG8gY3JlYXRlIGFzc2V0IGZyb20gZnJvbnRtYXR0ZXI6JywgcmVzdWx0LmVycm9yKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUud2FybignRmFpbGVkIHRvIGNyZWF0ZSBhc3NldCBmcm9tIGZyb250bWF0dGVyOicsIGVycm9yKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==