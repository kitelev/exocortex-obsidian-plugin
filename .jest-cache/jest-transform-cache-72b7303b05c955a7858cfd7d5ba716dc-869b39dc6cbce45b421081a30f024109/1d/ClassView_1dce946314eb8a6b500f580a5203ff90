080f47ec44f2e269c9b7aa4ac762a908
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ClassView = void 0;
const AggregateRoot_1 = require("../core/AggregateRoot");
const Result_1 = require("../core/Result");
class ClassView extends AggregateRoot_1.AggregateRoot {
    constructor(props) {
        super(props);
    }
    /**
     * Factory method with business rules validation
     */
    static create(props) {
        // Validate class name
        if (!props.className) {
            return Result_1.Result.fail('Class view must be associated with a class');
        }
        // Validate button count
        if (props.buttons.length > ClassView.MAX_BUTTONS_PER_VIEW) {
            return Result_1.Result.fail(`Class view cannot have more than ${ClassView.MAX_BUTTONS_PER_VIEW} buttons`);
        }
        // Check for duplicate button orders
        const orders = props.buttons.map(b => b.order);
        const uniqueOrders = new Set(orders);
        if (uniqueOrders.size !== orders.length) {
            return Result_1.Result.fail('Buttons cannot have duplicate order values');
        }
        // Set default display options
        const defaultDisplayOptions = {
            showProperties: true,
            showRelations: true,
            showBacklinks: true,
            showButtons: true,
            buttonPosition: 'top'
        };
        return Result_1.Result.ok(new ClassView(Object.assign(Object.assign({}, props), { displayOptions: props.displayOptions || defaultDisplayOptions })));
    }
    // Getters
    get id() {
        return this.props.id;
    }
    get className() {
        return this.props.className;
    }
    get buttons() {
        // Return sorted by order
        return [...this.props.buttons].sort((a, b) => a.order - b.order);
    }
    get displayOptions() {
        return this.props.displayOptions || {
            showProperties: true,
            showRelations: true,
            showBacklinks: true,
            showButtons: true,
            buttonPosition: 'top'
        };
    }
    /**
     * Add a button to the view
     */
    addButton(button) {
        // Check max buttons limit
        if (this.props.buttons.length >= ClassView.MAX_BUTTONS_PER_VIEW) {
            return Result_1.Result.fail(`Cannot add more buttons. Maximum of ${ClassView.MAX_BUTTONS_PER_VIEW} reached`);
        }
        // Check for duplicate button
        if (this.props.buttons.some(b => b.id.equals(button.id))) {
            return Result_1.Result.fail('Button already exists in this view');
        }
        // Check for order conflict
        if (this.props.buttons.some(b => b.order === button.order)) {
            return Result_1.Result.fail(`Button with order ${button.order} already exists`);
        }
        this.props.buttons.push(button);
        // Raise domain event
        this.addDomainEvent({
            aggregateId: this.id.toString(),
            eventType: 'ButtonAddedToClassView',
            eventData: {
                classViewId: this.id.toString(),
                className: this.className.value,
                buttonId: button.id.toString(),
                buttonLabel: button.label
            }
        });
        return Result_1.Result.ok();
    }
    /**
     * Remove a button from the view
     */
    removeButton(buttonId) {
        const buttonIndex = this.props.buttons.findIndex(b => b.id.equals(buttonId));
        if (buttonIndex === -1) {
            return Result_1.Result.fail('Button not found in this view');
        }
        const removedButton = this.props.buttons.splice(buttonIndex, 1)[0];
        // Raise domain event
        this.addDomainEvent({
            aggregateId: this.id.toString(),
            eventType: 'ButtonRemovedFromClassView',
            eventData: {
                classViewId: this.id.toString(),
                className: this.className.value,
                buttonId: removedButton.id.toString()
            }
        });
        return Result_1.Result.ok();
    }
    /**
     * Reorder buttons
     */
    reorderButtons(buttonOrders) {
        // Validate all buttons are present
        for (const button of this.props.buttons) {
            if (!buttonOrders.has(button.id.toString())) {
                return Result_1.Result.fail(`Missing order for button ${button.id.toString()}`);
            }
        }
        // Check for duplicate orders
        const orders = Array.from(buttonOrders.values());
        const uniqueOrders = new Set(orders);
        if (uniqueOrders.size !== orders.length) {
            return Result_1.Result.fail('Duplicate order values not allowed');
        }
        // Apply new orders
        for (const button of this.props.buttons) {
            const newOrder = buttonOrders.get(button.id.toString());
            if (newOrder !== undefined) {
                // This would normally update the button's order
                // but we need to maintain immutability
                Object.defineProperty(button, 'order', { value: newOrder });
            }
        }
        // Raise domain event
        this.addDomainEvent({
            aggregateId: this.id.toString(),
            eventType: 'ButtonsReordered',
            eventData: {
                classViewId: this.id.toString(),
                className: this.className.value,
                newOrder: Array.from(buttonOrders.entries())
            }
        });
        return Result_1.Result.ok();
    }
    /**
     * Update display options
     */
    updateDisplayOptions(options) {
        this.props.displayOptions = Object.assign(Object.assign({}, this.displayOptions), options);
        // Raise domain event
        this.addDomainEvent({
            aggregateId: this.id.toString(),
            eventType: 'DisplayOptionsUpdated',
            eventData: {
                classViewId: this.id.toString(),
                className: this.className.value,
                displayOptions: this.props.displayOptions
            }
        });
        return Result_1.Result.ok();
    }
    /**
     * Get enabled buttons only
     */
    getEnabledButtons() {
        return this.buttons.filter(b => b.isEnabled);
    }
    /**
     * Check if view has any executable buttons
     */
    hasExecutableButtons() {
        return this.getEnabledButtons().length > 0 && this.displayOptions.showButtons;
    }
    /**
     * Find button by ID
     */
    findButton(buttonId) {
        return this.props.buttons.find(b => b.id.equals(buttonId));
    }
}
exports.ClassView = ClassView;
ClassView.MAX_BUTTONS_PER_VIEW = 20;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2RvbWFpbi9hZ2dyZWdhdGVzL0NsYXNzVmlldy50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSx5REFBc0Q7QUFHdEQsMkNBQXdDO0FBdUJ4QyxNQUFhLFNBQVUsU0FBUSw2QkFBNkI7SUFHeEQsWUFBb0IsS0FBcUI7UUFDckMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2pCLENBQUM7SUFFRDs7T0FFRztJQUNJLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBcUI7UUFDdEMsc0JBQXNCO1FBQ3RCLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFO1lBQ2xCLE9BQU8sZUFBTSxDQUFDLElBQUksQ0FBWSw0Q0FBNEMsQ0FBQyxDQUFDO1NBQy9FO1FBRUQsd0JBQXdCO1FBQ3hCLElBQUksS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsU0FBUyxDQUFDLG9CQUFvQixFQUFFO1lBQ3ZELE9BQU8sZUFBTSxDQUFDLElBQUksQ0FDZCxvQ0FBb0MsU0FBUyxDQUFDLG9CQUFvQixVQUFVLENBQy9FLENBQUM7U0FDTDtRQUVELG9DQUFvQztRQUNwQyxNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMvQyxNQUFNLFlBQVksR0FBRyxJQUFJLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUNyQyxJQUFJLFlBQVksQ0FBQyxJQUFJLEtBQUssTUFBTSxDQUFDLE1BQU0sRUFBRTtZQUNyQyxPQUFPLGVBQU0sQ0FBQyxJQUFJLENBQVksNENBQTRDLENBQUMsQ0FBQztTQUMvRTtRQUVELDhCQUE4QjtRQUM5QixNQUFNLHFCQUFxQixHQUFtQjtZQUMxQyxjQUFjLEVBQUUsSUFBSTtZQUNwQixhQUFhLEVBQUUsSUFBSTtZQUNuQixhQUFhLEVBQUUsSUFBSTtZQUNuQixXQUFXLEVBQUUs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LE9BQU8sQ0FDYixDQUFDO1FBRUYscUJBQXFCO1FBQ3JCLElBQUksQ0FBQyxjQUFjLENBQUM7WUFDaEIsV0FBVyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFO1lBQy9CLFNBQVMsRUFBRSx1QkFBdUI7WUFDbEMsU0FBUyxFQUFFO2dCQUNQLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRTtnQkFDL0IsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSztnQkFDL0IsY0FBYyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYzthQUM1QztTQUNKLENBQUMsQ0FBQztRQUVILE9BQU8sZUFBTSxDQUFDLEVBQUUsRUFBUSxDQUFDO0lBQzdCLENBQUM7SUFFRDs7T0FFRztJQUNJLGlCQUFpQjtRQUNwQixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ2pELENBQUM7SUFFRDs7T0FFRztJQUNJLG9CQUFvQjtRQUN2QixPQUFPLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDLE1BQU0sR0FBRyxDQUFDLElBQUksSUFBSSxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUM7SUFDbEYsQ0FBQztJQUVEOztPQUVHO0lBQ0ksVUFBVSxDQUFDLFFBQWlCO1FBQy9CLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztJQUMvRCxDQUFDOztBQXpOTCw4QkEwTkM7QUF6TjJCLDhCQUFvQixHQUFHLEVBQUUsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva2l0ZWxldi9Eb2N1bWVudHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi9zcmMvZG9tYWluL2FnZ3JlZ2F0ZXMvQ2xhc3NWaWV3LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFnZ3JlZ2F0ZVJvb3QgfSBmcm9tICcuLi9jb3JlL0FnZ3JlZ2F0ZVJvb3QnO1xuaW1wb3J0IHsgQXNzZXRJZCB9IGZyb20gJy4uL3ZhbHVlLW9iamVjdHMvQXNzZXRJZCc7XG5pbXBvcnQgeyBDbGFzc05hbWUgfSBmcm9tICcuLi92YWx1ZS1vYmplY3RzL0NsYXNzTmFtZSc7XG5pbXBvcnQgeyBSZXN1bHQgfSBmcm9tICcuLi9jb3JlL1Jlc3VsdCc7XG5pbXBvcnQgeyBVSUJ1dHRvbiB9IGZyb20gJy4uL2VudGl0aWVzL1VJQnV0dG9uJztcblxuLyoqXG4gKiBBZ2dyZWdhdGUgUm9vdCBmb3IgQ2xhc3MgVmlldyBDb25maWd1cmF0aW9uXG4gKiBUaGlzIGFnZ3JlZ2F0ZSBtYW5hZ2VzIHRoZSByZWxhdGlvbnNoaXAgYmV0d2VlbiBjbGFzc2VzIGFuZCB0aGVpciBVSSBidXR0b25zXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ2xhc3NWaWV3UHJvcHMge1xuICAgIGlkOiBBc3NldElkO1xuICAgIGNsYXNzTmFtZTogQ2xhc3NOYW1lO1xuICAgIGJ1dHRvbnM6IFVJQnV0dG9uW107XG4gICAgbGF5b3V0VGVtcGxhdGU/OiBzdHJpbmc7XG4gICAgZGlzcGxheU9wdGlvbnM/OiBEaXNwbGF5T3B0aW9ucztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBEaXNwbGF5T3B0aW9ucyB7XG4gICAgc2hvd1Byb3BlcnRpZXM6IGJvb2xlYW47XG4gICAgc2hvd1JlbGF0aW9uczogYm9vbGVhbjtcbiAgICBzaG93QmFja2xpbmtzOiBib29sZWFuO1xuICAgIHNob3dCdXR0b25zOiBib29sZWFuO1xuICAgIGJ1dHRvblBvc2l0aW9uOiAndG9wJyB8ICdib3R0b20nIHwgJ2Zsb2F0aW5nJztcbn1cblxuZXhwb3J0IGNsYXNzIENsYXNzVmlldyBleHRlbmRzIEFnZ3JlZ2F0ZVJvb3Q8Q2xhc3NWaWV3UHJvcHM+IHtcbiAgICBwcml2YXRlIHN0YXRpYyByZWFkb25seSBNQVhfQlVUVE9OU19QRVJfVklFVyA9IDIwO1xuXG4gICAgcHJpdmF0ZSBjb25zdHJ1Y3Rvcihwcm9wczogQ2xhc3NWaWV3UHJvcHMpIHtcbiAgICAgICAgc3VwZXIocHJvcHMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEZhY3RvcnkgbWV0aG9kIHdpdGggYnVzaW5lc3MgcnVsZXMgdmFsaWRhdGlvblxuICAgICAqL1xuICAgIHB1YmxpYyBzdGF0aWMgY3JlYXRlKHByb3BzOiBDbGFzc1ZpZXdQcm9wcyk6IFJlc3VsdDxDbGFzc1ZpZXc+IHtcbiAgICAgICAgLy8gVmFsaWRhdGUgY2xhc3MgbmFtZVxuICAgICAgICBpZiAoIXByb3BzLmNsYXNzTmFtZSkge1xuICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPENsYXNzVmlldz4oJ0NsYXNzIHZpZXcgbXVzdCBiZSBhc3NvY2lhdGVkIHdpdGggYSBjbGFzcycpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gVmFsaWRhdGUgYnV0dG9uIGNvdW50XG4gICAgICAgIGlmIChwcm9wcy5idXR0b25zLmxlbmd0aCA+IENsYXNzVmlldy5NQVhfQlVUVE9OU19QRVJfVklFVykge1xuICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPENsYXNzVmlldz4oXG4gICAgICAgICAgICAgICAgYENsYXNzIHZpZXcgY2Fubm90IGhhdmUgbW9yZSB0aGFuICR7Q2xhc3NWaWV3Lk1BWF9CVVRUT05TX1BFUl9WSUVXfSBidXR0b25zYFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENoZWNrIGZvciBkdXBsaWNhdGUgYnV0dG9uIG9yZGVyc1xuICAgICAgICBjb25zdCBvcmRlcnMgPSBwcm9wcy5idXR0b25zLm1hcChiID0+IGIub3JkZXIpO1xuICAgICAgICBjb25zdCB1bmlxdWVPcmRlcnMgPSBuZXcgU2V0KG9yZGVycyk7XG4gICAgICAgIGlmICh1bmlxdWVPcmRlcnMuc2l6ZSAhPT0gb3JkZXJzLmxlbmd0aCkge1xuICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPENsYXNzVmlldz4oJ0J1dHRvbnMgY2Fubm90IGhhdmUgZHVwbGljYXRlIG9yZGVyIHZhbHVlcycpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gU2V0IGRlZmF1bHQgZGlzcGxheSBvcHRpb25zXG4gICAgICAgIGNvbnN0IGRlZmF1bHREaXNwbGF5T3B0aW9uczogRGlzcGxheU9wdGlvbnMgPSB7XG4gICAgICAgICAgICBzaG93UHJvcGVydGllczogdHJ1ZSxcbiAgICAgICAgICAgIHNob3dSZWxhdGlvbnM6IHRydWUsXG4gICAgICAgICAgICBzaG93QmFja2xpbmtzOiB0cnVlLFxuICAgICAgICAgICAgc2hvd0J1dHRvbnM6IHRydWUsXG4gICAgICAgICAgICBidXR0b25Qb3NpdGlvbjogJ3RvcCdcbiAgICAgICAgfTtcblxuICAgICAgICByZXR1cm4gUmVzdWx0Lm9rPENsYXNzVmlldz4obmV3IENsYXNzVmlldyh7XG4gICAgICAgICAgICAuLi5wcm9wcyxcbiAgICAgICAgICAgIGRpc3BsYXlPcHRpb25zOiBwcm9wcy5kaXNwbGF5T3B0aW9ucyB8fCBkZWZhdWx0RGlzcGxheU9wdGlvbnNcbiAgICAgICAgfSkpO1xuICAgIH1cblxuICAgIC8vIEdldHRlcnNcbiAgICBnZXQgaWQoKTogQXNzZXRJZCB7XG4gICAgICAgIHJldHVybiB0aGlzLnByb3BzLmlkO1xuICAgIH1cblxuICAgIGdldCBjbGFzc05hbWUoKTogQ2xhc3NOYW1lIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvcHMuY2xhc3NOYW1lO1xuICAgIH1cblxuICAgIGdldCBidXR0b25zKCk6IFVJQnV0dG9uW10ge1xuICAgICAgICAvLyBSZXR1cm4gc29ydGVkIGJ5IG9yZGVyXG4gICAgICAgIHJldHVybiBbLi4udGhpcy5wcm9wcy5idXR0b25zXS5zb3J0KChhLCBiKSA9PiBhLm9yZGVyIC0gYi5vcmRlcik7XG4gICAgfVxuXG4gICAgZ2V0IGRpc3BsYXlPcHRpb25zKCk6IERpc3BsYXlPcHRpb25zIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvcHMuZGlzcGxheU9wdGlvbnMgfHwge1xuICAgICAgICAgICAgc2hvd1Byb3BlcnRpZXM6IHRydWUsXG4gICAgICAgICAgICBzaG93UmVsYXRpb25zOiB0cnVlLFxuICAgICAgICAgICAgc2hvd0JhY2tsaW5rczogdHJ1ZSxcbiAgICAgICAgICAgIHNob3dCdXR0b25zOiB0cnVlLFxuICAgICAgICAgICAgYnV0dG9uUG9zaXRpb246ICd0b3AnXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkIGEgYnV0dG9uIHRvIHRoZSB2aWV3XG4gICAgICovXG4gICAgcHVibGljIGFkZEJ1dHRvbihidXR0b246IFVJQnV0dG9uKTogUmVzdWx0PHZvaWQ+IHtcbiAgICAgICAgLy8gQ2hlY2sgbWF4IGJ1dHRvbnMgbGltaXRcbiAgICAgICAgaWYgKHRoaXMucHJvcHMuYnV0dG9ucy5sZW5ndGggPj0gQ2xhc3NWaWV3Lk1BWF9CVVRUT05TX1BFUl9WSUVXKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8dm9pZD4oXG4gICAgICAgICAgICAgICAgYENhbm5vdCBhZGQgbW9yZSBidXR0b25zLiBNYXhpbXVtIG9mICR7Q2xhc3NWaWV3Lk1BWF9CVVRUT05TX1BFUl9WSUVXfSByZWFjaGVkYFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENoZWNrIGZvciBkdXBsaWNhdGUgYnV0dG9uXG4gICAgICAgIGlmICh0aGlzLnByb3BzLmJ1dHRvbnMuc29tZShiID0+IGIuaWQuZXF1YWxzKGJ1dHRvbi5pZCkpKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8dm9pZD4oJ0J1dHRvbiBhbHJlYWR5IGV4aXN0cyBpbiB0aGlzIHZpZXcnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENoZWNrIGZvciBvcmRlciBjb25mbGljdFxuICAgICAgICBpZiAodGhpcy5wcm9wcy5idXR0b25zLnNvbWUoYiA9PiBiLm9yZGVyID09PSBidXR0b24ub3JkZXIpKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8dm9pZD4oYEJ1dHRvbiB3aXRoIG9yZGVyICR7YnV0dG9uLm9yZGVyfSBhbHJlYWR5IGV4aXN0c2ApO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5wcm9wcy5idXR0b25zLnB1c2goYnV0dG9uKTtcblxuICAgICAgICAvLyBSYWlzZSBkb21haW4gZXZlbnRcbiAgICAgICAgdGhpcy5hZGREb21haW5FdmVudCh7XG4gICAgICAgICAgICBhZ2dyZWdhdGVJZDogdGhpcy5pZC50b1N0cmluZygpLFxuICAgICAgICAgICAgZXZlbnRUeXBlOiAnQnV0dG9uQWRkZWRUb0NsYXNzVmlldycsXG4gICAgICAgICAgICBldmVudERhdGE6IHtcbiAgICAgICAgICAgICAgICBjbGFzc1ZpZXdJZDogdGhpcy5pZC50b1N0cmluZygpLFxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZTogdGhpcy5jbGFzc05hbWUudmFsdWUsXG4gICAgICAgICAgICAgICAgYnV0dG9uSWQ6IGJ1dHRvbi5pZC50b1N0cmluZygpLFxuICAgICAgICAgICAgICAgIGJ1dHRvbkxhYmVsOiBidXR0b24ubGFiZWxcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIFJlc3VsdC5vazx2b2lkPigpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJlbW92ZSBhIGJ1dHRvbiBmcm9tIHRoZSB2aWV3XG4gICAgICovXG4gICAgcHVibGljIHJlbW92ZUJ1dHRvbihidXR0b25JZDogQXNzZXRJZCk6IFJlc3VsdDx2b2lkPiB7XG4gICAgICAgIGNvbnN0IGJ1dHRvbkluZGV4ID0gdGhpcy5wcm9wcy5idXR0b25zLmZpbmRJbmRleChiID0+IGIuaWQuZXF1YWxzKGJ1dHRvbklkKSk7XG4gICAgICAgIFxuICAgICAgICBpZiAoYnV0dG9uSW5kZXggPT09IC0xKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8dm9pZD4oJ0J1dHRvbiBub3QgZm91bmQgaW4gdGhpcyB2aWV3Jyk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZW1vdmVkQnV0dG9uID0gdGhpcy5wcm9wcy5idXR0b25zLnNwbGljZShidXR0b25JbmRleCwgMSlbMF07XG5cbiAgICAgICAgLy8gUmFpc2UgZG9tYWluIGV2ZW50XG4gICAgICAgIHRoaXMuYWRkRG9tYWluRXZlbnQoe1xuICAgICAgICAgICAgYWdncmVnYXRlSWQ6IHRoaXMuaWQudG9TdHJpbmcoKSxcbiAgICAgICAgICAgIGV2ZW50VHlwZTogJ0J1dHRvblJlbW92ZWRGcm9tQ2xhc3NWaWV3JyxcbiAgICAgICAgICAgIGV2ZW50RGF0YToge1xuICAgICAgICAgICAgICAgIGNsYXNzVmlld0lkOiB0aGlzLmlkLnRvU3RyaW5nKCksXG4gICAgICAgICAgICAgICAgY2xhc3NOYW1lOiB0aGlzLmNsYXNzTmFtZS52YWx1ZSxcbiAgICAgICAgICAgICAgICBidXR0b25JZDogcmVtb3ZlZEJ1dHRvbi5pZC50b1N0cmluZygpXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBSZXN1bHQub2s8dm9pZD4oKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSZW9yZGVyIGJ1dHRvbnNcbiAgICAgKi9cbiAgICBwdWJsaWMgcmVvcmRlckJ1dHRvbnMoYnV0dG9uT3JkZXJzOiBNYXA8c3RyaW5nLCBudW1iZXI+KTogUmVzdWx0PHZvaWQ+IHtcbiAgICAgICAgLy8gVmFsaWRhdGUgYWxsIGJ1dHRvbnMgYXJlIHByZXNlbnRcbiAgICAgICAgZm9yIChjb25zdCBidXR0b24gb2YgdGhpcy5wcm9wcy5idXR0b25zKSB7XG4gICAgICAgICAgICBpZiAoIWJ1dHRvbk9yZGVycy5oYXMoYnV0dG9uLmlkLnRvU3RyaW5nKCkpKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPHZvaWQ+KGBNaXNzaW5nIG9yZGVyIGZvciBidXR0b24gJHtidXR0b24uaWQudG9TdHJpbmcoKX1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENoZWNrIGZvciBkdXBsaWNhdGUgb3JkZXJzXG4gICAgICAgIGNvbnN0IG9yZGVycyA9IEFycmF5LmZyb20oYnV0dG9uT3JkZXJzLnZhbHVlcygpKTtcbiAgICAgICAgY29uc3QgdW5pcXVlT3JkZXJzID0gbmV3IFNldChvcmRlcnMpO1xuICAgICAgICBpZiAodW5pcXVlT3JkZXJzLnNpemUgIT09IG9yZGVycy5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDx2b2lkPignRHVwbGljYXRlIG9yZGVyIHZhbHVlcyBub3QgYWxsb3dlZCcpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQXBwbHkgbmV3IG9yZGVyc1xuICAgICAgICBmb3IgKGNvbnN0IGJ1dHRvbiBvZiB0aGlzLnByb3BzLmJ1dHRvbnMpIHtcbiAgICAgICAgICAgIGNvbnN0IG5ld09yZGVyID0gYnV0dG9uT3JkZXJzLmdldChidXR0b24uaWQudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICBpZiAobmV3T3JkZXIgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIC8vIFRoaXMgd291bGQgbm9ybWFsbHkgdXBkYXRlIHRoZSBidXR0b24ncyBvcmRlclxuICAgICAgICAgICAgICAgIC8vIGJ1dCB3ZSBuZWVkIHRvIG1haW50YWluIGltbXV0YWJpbGl0eVxuICAgICAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShidXR0b24sICdvcmRlcicsIHsgdmFsdWU6IG5ld09yZGVyIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gUmFpc2UgZG9tYWluIGV2ZW50XG4gICAgICAgIHRoaXMuYWRkRG9tYWluRXZlbnQoe1xuICAgICAgICAgICAgYWdncmVnYXRlSWQ6IHRoaXMuaWQudG9TdHJpbmcoKSxcbiAgICAgICAgICAgIGV2ZW50VHlwZTogJ0J1dHRvbnNSZW9yZGVyZWQnLFxuICAgICAgICAgICAgZXZlbnREYXRhOiB7XG4gICAgICAgICAgICAgICAgY2xhc3NWaWV3SWQ6IHRoaXMuaWQudG9TdHJpbmcoKSxcbiAgICAgICAgICAgICAgICBjbGFzc05hbWU6IHRoaXMuY2xhc3NOYW1lLnZhbHVlLFxuICAgICAgICAgICAgICAgIG5ld09yZGVyOiBBcnJheS5mcm9tKGJ1dHRvbk9yZGVycy5lbnRyaWVzKCkpXG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiBSZXN1bHQub2s8dm9pZD4oKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGUgZGlzcGxheSBvcHRpb25zXG4gICAgICovXG4gICAgcHVibGljIHVwZGF0ZURpc3BsYXlPcHRpb25zKG9wdGlvbnM6IFBhcnRpYWw8RGlzcGxheU9wdGlvbnM+KTogUmVzdWx0PHZvaWQ+IHtcbiAgICAgICAgdGhpcy5wcm9wcy5kaXNwbGF5T3B0aW9ucyA9IHtcbiAgICAgICAgICAgIC4uLnRoaXMuZGlzcGxheU9wdGlvbnMsXG4gICAgICAgICAgICAuLi5vcHRpb25zXG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gUmFpc2UgZG9tYWluIGV2ZW50XG4gICAgICAgIHRoaXMuYWRkRG9tYWluRXZlbnQoe1xuICAgICAgICAgICAgYWdncmVnYXRlSWQ6IHRoaXMuaWQudG9TdHJpbmcoKSxcbiAgICAgICAgICAgIGV2ZW50VHlwZTogJ0Rpc3BsYXlPcHRpb25zVXBkYXRlZCcsXG4gICAgICAgICAgICBldmVudERhdGE6IHtcbiAgICAgICAgICAgICAgICBjbGFzc1ZpZXdJZDogdGhpcy5pZC50b1N0cmluZygpLFxuICAgICAgICAgICAgICAgIGNsYXNzTmFtZTogdGhpcy5jbGFzc05hbWUudmFsdWUsXG4gICAgICAgICAgICAgICAgZGlzcGxheU9wdGlvbnM6IHRoaXMucHJvcHMuZGlzcGxheU9wdGlvbnNcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIFJlc3VsdC5vazx2b2lkPigpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdldCBlbmFibGVkIGJ1dHRvbnMgb25seVxuICAgICAqL1xuICAgIHB1YmxpYyBnZXRFbmFibGVkQnV0dG9ucygpOiBVSUJ1dHRvbltdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuYnV0dG9ucy5maWx0ZXIoYiA9PiBiLmlzRW5hYmxlZCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2hlY2sgaWYgdmlldyBoYXMgYW55IGV4ZWN1dGFibGUgYnV0dG9uc1xuICAgICAqL1xuICAgIHB1YmxpYyBoYXNFeGVjdXRhYmxlQnV0dG9ucygpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0RW5hYmxlZEJ1dHRvbnMoKS5sZW5ndGggPiAwICYmIHRoaXMuZGlzcGxheU9wdGlvbnMuc2hvd0J1dHRvbnM7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRmluZCBidXR0b24gYnkgSURcbiAgICAgKi9cbiAgICBwdWJsaWMgZmluZEJ1dHRvbihidXR0b25JZDogQXNzZXRJZCk6IFVJQnV0dG9uIHwgdW5kZWZpbmVkIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvcHMuYnV0dG9ucy5maW5kKGIgPT4gYi5pZC5lcXVhbHMoYnV0dG9uSWQpKTtcbiAgICB9XG59Il0sInZlcnNpb24iOjN9