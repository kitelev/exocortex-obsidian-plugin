9bab34e982623e614e6e4e0dcce54dfd
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GetCurrentProjectUseCase = void 0;
const ClassName_1 = require("../../domain/value-objects/ClassName");
/**
 * Use case for getting current project context
 * Implements intelligent project detection based on user context
 * Following TOGAF principles for business capability
 */
class GetCurrentProjectUseCase {
    constructor(assetRepository, focusService, graph) {
        this.assetRepository = assetRepository;
        this.focusService = focusService;
        this.graph = graph;
    }
    async execute(request) {
        try {
            // Get all available projects
            const availableProjects = await this.getAvailableProjects(request.preferences?.includeCompleted ?? false, request.preferences?.maxResults ?? 10);
            // Detect current project based on context
            const currentProject = await this.detectCurrentProject(request, availableProjects);
            // Determine detection strategy and confidence
            const context = this.buildContextInfo(request, currentProject);
            return {
                success: true,
                currentProject,
                availableProjects,
                context,
            };
        }
        catch (error) {
            return {
                success: false,
                availableProjects: [],
                context: {
                    strategy: "error",
                    confidence: 0,
                    reasoning: `Failed to get project context: ${error.message}`,
                },
                message: error.message,
            };
        }
    }
    /**
     * Get all available projects from the system
     */
    async getAvailableProjects(includeCompleted, maxResults) {
        try {
            // Find assets with Project class
            const projectClassName = ClassName_1.ClassName.create("ems__Project");
            if (projectClassName.isFailure) {
                return [];
            }
            const projectAssets = await this.assetRepository.findByClass(projectClassName.getValue());
            // Convert to response format and filter
            const projects = projectAssets
                .filter((asset) => {
                if (!includeCompleted) {
                    const status = asset.getPropertyValue("status");
                    return status !== "completed" && status !== "cancelled";
                }
                return true;
            })
                .map((asset) => ({
                id: asset.getId().toString(),
                title: asset.getTitle(),
                status: asset.getPropertyValue("status") || "active",
                priority: asset.getPropertyValue("priority") || "medium",
                description: asset.getPropertyValue("description"),
                isActive: asset.getPropertyValue("status") === "active",
                lastUpdated: asset.getPropertyValue("updatedAt") || new Date().toISOString(),
            }))
                .sort((a, b) => {
                // Sort by active status first, then by last updated
                if (a.isActive && !b.isActive)
                    return -1;
                if (!a.isActive && b.isActive)
                    return 1;
                return (new Date(b.lastUpdated).getTime() -
                    new Date(a.lastUpdated).getTime());
            })
                .slice(0, maxResults);
            return projects;
        }
        catch (error) {
            console.warn("Failed to get available projects:", error);
            return [];
        }
    }
    /**
     * Detect current project based on context clues
     */
    async detectCurrentProject(request, availableProjects) {
        const strategy = request.preferences?.selectionStrategy || "context";
        switch (strategy) {
            case "context":
                return this.detectByContext(request, availableProjects);
            case "recent":
                return this.detectByRecentActivity(availableProjects);
            case "active":
                return this.detectByActiveStatus(availableProjects);
            case "priority":
                return this.detectByPriority(availableProjects);
            default:
                return this.detectByContext(request, availableProjects);
        }
    }
    /**
     * Detect project by analyzing current file context
     */
    async detectByContext(request, availableProjects) {
        if (!request.activeFile) {
            return this.detectByRecentActivity(availableProjects);
        }
        try {
            // Check if current file is a project file
            const currentAsset = await this.assetRepository.findByFilename(request.activeFile);
            if (currentAsset) {
                const className = currentAsset.getClassName().toString();
                if (className === "ems__Project") {
                    return this.assetToProjectResponse(currentAsset);
                }
                // Check if current asset has project relationship
                const projectId = currentAsset.getProperty("projectId") ||
                    currentAsset.getProperty("exo__Effort_parent");
                if (projectId) {
                    const cleanProjectId = projectId.toString().replace(/\[\[|\]\]/g, "");
                    const project = availableProjects.find((p) => p.id === cleanProjectId);
                    if (project) {
                        return project;
                    }
                }
            }
            // Use RDF graph to find project relationships
            const projectFromGraph = await this.findProjectFromGraph(request.activeFile, availableProjects);
            if (projectFromGraph) {
                return projectFromGraph;
            }
            // Fallback to recent activity
            return this.detectByRecentActivity(availableProjects);
        }
        catch (error) {
            console.warn("Context-based project detection failed:", error);
            return this.detectByRecentActivity(availableProjects);
        }
    }
    /**
     * Detect project using RDF graph relationships
     */
    async findProjectFromGraph(activeFile, availableProjects) {
        try {
            // Clean file path for IRI
            const fileIRI = activeFile.replace(/\.md$/, "").replace(/\s+/g, "_");
            // Query for project relationships
            const projectTriples = this.graph.query(fileIRI, "exo__Effort_parent");
            if (projectTriples.length > 0) {
                const projectIRI = projectTriples[0].getObject().toString();
                const project = availableProjects.find((p) => p.id === projectIRI || p.title.replace(/\s+/g, "_") === projectIRI);
                if (project) {
                    return project;
                }
            }
            // Check reverse relationships (project -> task)
            const taskTriples = this.graph.query(undefined, "exo__Effort_parent", fileIRI);
            for (const triple of taskTriples) {
                const potentialProject = triple.getSubject().toString();
                const project = availableProjects.find((p) => p.id === potentialProject ||
                    p.title.replace(/\s+/g, "_") === potentialProject);
                if (project) {
                    return project;
                }
            }
            return undefined;
        }
        catch (error) {
            console.warn("Graph-based project detection failed:", error);
            return undefined;
        }
    }
    /**
     * Detect project by recent activity
     */
    detectByRecentActivity(availableProjects) {
        const recentProjects = availableProjects
            .filter((p) => p.isActive)
            .sort((a, b) => new Date(b.lastUpdated).getTime() - new Date(a.lastUpdated).getTime());
        return recentProjects[0];
    }
    /**
     * Detect project by active status
     */
    detectByActiveStatus(availableProjects) {
        return availableProjects.find((p) => p.isActive);
    }
    /**
     * Detect project by priority
     */
    detectByPriority(availableProjects) {
        const priorityOrder = {
            urgent: 4,
            high: 3,
            medium: 2,
            low: 1,
        };
        return availableProjects
            .filter((p) => p.isActive)
            .sort((a, b) => (priorityOrder[b.priority] || 2) - (priorityOrder[a.priority] || 2))[0];
    }
    /**
     * Build context information for response
     */
    buildContextInfo(request, currentProject) {
        const strategy = request.preferences?.selectionStrategy || "context";
        let confidence = 0;
        let reasoning = "";
        if (currentProject) {
            switch (strategy) {
                case "context":
                    confidence = request.activeFile ? 0.8 : 0.3;
                    reasoning = request.activeFile
                        ? `Detected from current file context: ${request.activeFile}`
                        : "Used most recent active project";
                    break;
                case "recent":
                    confidence = 0.6;
                    reasoning = "Selected most recently updated active project";
                    break;
                case "active":
                    confidence = 0.5;
                    reasoning = "Selected first active project";
                    break;
                case "priority":
                    confidence = 0.7;
                    reasoning = "Selected highest priority active project";
                    break;
            }
        }
        else {
            reasoning = "No suitable project found";
        }
        return {
            strategy,
            confidence,
            reasoning,
        };
    }
    /**
     * Convert Asset to project response format
     */
    assetToProjectResponse(asset) {
        return {
            id: asset.getId().toString(),
            title: asset.getTitle(),
            status: asset.getPropertyValue("status") || "active",
            priority: asset.getPropertyValue("priority") || "medium",
            description: asset.getPropertyValue("description"),
        };
    }
}
exports.GetCurrentProjectUseCase = GetCurrentProjectUseCase;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2FwcGxpY2F0aW9uL3VzZS1jYXNlcy9HZXRDdXJyZW50UHJvamVjdFVzZUNhc2UudHMiLCJtYXBwaW5ncyI6Ijs7O0FBRUEsb0VBQWlFO0FBVWpFOzs7O0dBSUc7QUFDSCxNQUFhLHdCQUF3QjtJQUNuQyxZQUNtQixlQUFpQyxFQUNqQyxZQUE2QixFQUM3QixLQUFtQjtRQUZuQixvQkFBZSxHQUFmLGVBQWUsQ0FBa0I7UUFDakMsaUJBQVksR0FBWixZQUFZLENBQWlCO1FBQzdCLFVBQUssR0FBTCxLQUFLLENBQWM7SUFDbkMsQ0FBQztJQUVKLEtBQUssQ0FBQyxPQUFPLENBQ1gsT0FBaUM7UUFFakMsSUFBSTtZQUNGLDZCQUE2QjtZQUM3QixNQUFNLGlCQUFpQixHQUFHLE1BQU0sSUFBSSxDQUFDLG9CQUFvQixDQUN2RCxPQUFPLENBQUMsV0FBVyxFQUFFLGdCQUFnQixJQUFJLEtBQUssRUFDOUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxVQUFVLElBQUksRUFBRSxDQUN0QyxDQUFDO1lBRUYsMENBQTBDO1lBQzFDLE1BQU0sY0FBYyxHQUFHLE1BQU0sSUFBSSxDQUFDLG9CQUFvQixDQUNwRCxPQUFPLEVBQ1AsaUJBQWlCLENBQ2xCLENBQUM7WUFFRiw4Q0FBOEM7WUFDOUMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxjQUFjLENBQUMsQ0FBQztZQUUvRCxPQUFPO2dCQUNMLE9BQU8sRUFBRSxJQUFJO2dCQUNiLGNBQWM7Z0JBQ2QsaUJBQWlCO2dCQUNqQixPQUFPO2FBQ1IsQ0FBQztTQUNIO1FBQUMsT0FBTyxLQUFLLEVBQUU7WUFDZCxPQUFPO2dCQUNMLE9BQU8sRUFBRSxLQUFLO2dCQUNkLGlCQUFpQixFQUFFLEVBQUU7Z0JBQ3JCLE9BQU8sRUFBRTtvQkFDUCxRQUFRLEVBQUUsT0FBTztvQkFDakIsVUFBVSxFQUFFLENBQUM7b0JBQ2IsU0FBUyxF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Z0JBQWdCLENBQUMsUUFBUSxDQUFDLElBQUksUUFBUTtZQUNwRCxRQUFRLEVBQUUsS0FBSyxDQUFDLGdCQUFnQixDQUFDLFVBQVUsQ0FBQyxJQUFJLFFBQVE7WUFDeEQsV0FBVyxFQUFFLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxhQUFhLENBQUM7U0FDbkQsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQTdVRCw0REE2VUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2FwcGxpY2F0aW9uL3VzZS1jYXNlcy9HZXRDdXJyZW50UHJvamVjdFVzZUNhc2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXNzZXQgfSBmcm9tIFwiLi4vLi4vZG9tYWluL2VudGl0aWVzL0Fzc2V0XCI7XG5pbXBvcnQgeyBBc3NldElkIH0gZnJvbSBcIi4uLy4uL2RvbWFpbi92YWx1ZS1vYmplY3RzL0Fzc2V0SWRcIjtcbmltcG9ydCB7IENsYXNzTmFtZSB9IGZyb20gXCIuLi8uLi9kb21haW4vdmFsdWUtb2JqZWN0cy9DbGFzc05hbWVcIjtcbmltcG9ydCB7IElBc3NldFJlcG9zaXRvcnkgfSBmcm9tIFwiLi4vLi4vZG9tYWluL3JlcG9zaXRvcmllcy9JQXNzZXRSZXBvc2l0b3J5XCI7XG5pbXBvcnQgeyBFeG9Gb2N1c1NlcnZpY2UgfSBmcm9tIFwiLi4vc2VydmljZXMvRXhvRm9jdXNTZXJ2aWNlXCI7XG5pbXBvcnQgeyBJbmRleGVkR3JhcGggfSBmcm9tIFwiLi4vLi4vZG9tYWluL3NlbWFudGljL2NvcmUvSW5kZXhlZEdyYXBoXCI7XG5pbXBvcnQgeyBJUkkgfSBmcm9tIFwiLi4vLi4vZG9tYWluL3NlbWFudGljL2NvcmUvVHJpcGxlXCI7XG5pbXBvcnQge1xuICBHZXRDdXJyZW50UHJvamVjdFJlcXVlc3QsXG4gIEdldEN1cnJlbnRQcm9qZWN0UmVzcG9uc2UsXG59IGZyb20gXCIuLi9kdG9zL0NyZWF0ZVRhc2tSZXF1ZXN0XCI7XG5cbi8qKlxuICogVXNlIGNhc2UgZm9yIGdldHRpbmcgY3VycmVudCBwcm9qZWN0IGNvbnRleHRcbiAqIEltcGxlbWVudHMgaW50ZWxsaWdlbnQgcHJvamVjdCBkZXRlY3Rpb24gYmFzZWQgb24gdXNlciBjb250ZXh0XG4gKiBGb2xsb3dpbmcgVE9HQUYgcHJpbmNpcGxlcyBmb3IgYnVzaW5lc3MgY2FwYWJpbGl0eVxuICovXG5leHBvcnQgY2xhc3MgR2V0Q3VycmVudFByb2plY3RVc2VDYXNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSByZWFkb25seSBhc3NldFJlcG9zaXRvcnk6IElBc3NldFJlcG9zaXRvcnksXG4gICAgcHJpdmF0ZSByZWFkb25seSBmb2N1c1NlcnZpY2U6IEV4b0ZvY3VzU2VydmljZSxcbiAgICBwcml2YXRlIHJlYWRvbmx5IGdyYXBoOiBJbmRleGVkR3JhcGgsXG4gICkge31cblxuICBhc3luYyBleGVjdXRlKFxuICAgIHJlcXVlc3Q6IEdldEN1cnJlbnRQcm9qZWN0UmVxdWVzdCxcbiAgKTogUHJvbWlzZTxHZXRDdXJyZW50UHJvamVjdFJlc3BvbnNlPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIEdldCBhbGwgYXZhaWxhYmxlIHByb2plY3RzXG4gICAgICBjb25zdCBhdmFpbGFibGVQcm9qZWN0cyA9IGF3YWl0IHRoaXMuZ2V0QXZhaWxhYmxlUHJvamVjdHMoXG4gICAgICAgIHJlcXVlc3QucHJlZmVyZW5jZXM/LmluY2x1ZGVDb21wbGV0ZWQgPz8gZmFsc2UsXG4gICAgICAgIHJlcXVlc3QucHJlZmVyZW5jZXM/Lm1heFJlc3VsdHMgPz8gMTAsXG4gICAgICApO1xuXG4gICAgICAvLyBEZXRlY3QgY3VycmVudCBwcm9qZWN0IGJhc2VkIG9uIGNvbnRleHRcbiAgICAgIGNvbnN0IGN1cnJlbnRQcm9qZWN0ID0gYXdhaXQgdGhpcy5kZXRlY3RDdXJyZW50UHJvamVjdChcbiAgICAgICAgcmVxdWVzdCxcbiAgICAgICAgYXZhaWxhYmxlUHJvamVjdHMsXG4gICAgICApO1xuXG4gICAgICAvLyBEZXRlcm1pbmUgZGV0ZWN0aW9uIHN0cmF0ZWd5IGFuZCBjb25maWRlbmNlXG4gICAgICBjb25zdCBjb250ZXh0ID0gdGhpcy5idWlsZENvbnRleHRJbmZvKHJlcXVlc3QsIGN1cnJlbnRQcm9qZWN0KTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgY3VycmVudFByb2plY3QsXG4gICAgICAgIGF2YWlsYWJsZVByb2plY3RzLFxuICAgICAgICBjb250ZXh0LFxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGF2YWlsYWJsZVByb2plY3RzOiBbXSxcbiAgICAgICAgY29udGV4dDoge1xuICAgICAgICAgIHN0cmF0ZWd5OiBcImVycm9yXCIsXG4gICAgICAgICAgY29uZmlkZW5jZTogMCxcbiAgICAgICAgICByZWFzb25pbmc6IGBGYWlsZWQgdG8gZ2V0IHByb2plY3QgY29udGV4dDogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgIH0sXG4gICAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYWxsIGF2YWlsYWJsZSBwcm9qZWN0cyBmcm9tIHRoZSBzeXN0ZW1cbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZ2V0QXZhaWxhYmxlUHJvamVjdHMoXG4gICAgaW5jbHVkZUNvbXBsZXRlZDogYm9vbGVhbixcbiAgICBtYXhSZXN1bHRzOiBudW1iZXIsXG4gICk6IFByb21pc2U8R2V0Q3VycmVudFByb2plY3RSZXNwb25zZVtcImF2YWlsYWJsZVByb2plY3RzXCJdPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIEZpbmQgYXNzZXRzIHdpdGggUHJvamVjdCBjbGFzc1xuICAgICAgY29uc3QgcHJvamVjdENsYXNzTmFtZSA9IENsYXNzTmFtZS5jcmVhdGUoXCJlbXNfX1Byb2plY3RcIik7XG4gICAgICBpZiAocHJvamVjdENsYXNzTmFtZS5pc0ZhaWx1cmUpIHtcbiAgICAgICAgcmV0dXJuIFtdO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBwcm9qZWN0QXNzZXRzID0gYXdhaXQgdGhpcy5hc3NldFJlcG9zaXRvcnkuZmluZEJ5Q2xhc3MoXG4gICAgICAgIHByb2plY3RDbGFzc05hbWUuZ2V0VmFsdWUoKSxcbiAgICAgICk7XG5cbiAgICAgIC8vIENvbnZlcnQgdG8gcmVzcG9uc2UgZm9ybWF0IGFuZCBmaWx0ZXJcbiAgICAgIGNvbnN0IHByb2plY3RzID0gcHJvamVjdEFzc2V0c1xuICAgICAgICAuZmlsdGVyKChhc3NldCkgPT4ge1xuICAgICAgICAgIGlmICghaW5jbHVkZUNvbXBsZXRlZCkge1xuICAgICAgICAgICAgY29uc3Qgc3RhdHVzID0gYXNzZXQuZ2V0UHJvcGVydHlWYWx1ZShcInN0YXR1c1wiKTtcbiAgICAgICAgICAgIHJldHVybiBzdGF0dXMgIT09IFwiY29tcGxldGVkXCIgJiYgc3RhdHVzICE9PSBcImNhbmNlbGxlZFwiO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSlcbiAgICAgICAgLm1hcCgoYXNzZXQpID0+ICh7XG4gICAgICAgICAgaWQ6IGFzc2V0LmdldElkKCkudG9TdHJpbmcoKSxcbiAgICAgICAgICB0aXRsZTogYXNzZXQuZ2V0VGl0bGUoKSxcbiAgICAgICAgICBzdGF0dXM6IGFzc2V0LmdldFByb3BlcnR5VmFsdWUoXCJzdGF0dXNcIikgfHwgXCJhY3RpdmVcIixcbiAgICAgICAgICBwcmlvcml0eTogYXNzZXQuZ2V0UHJvcGVydHlWYWx1ZShcInByaW9yaXR5XCIpIHx8IFwibWVkaXVtXCIsXG4gICAgICAgICAgZGVzY3JpcHRpb246IGFzc2V0LmdldFByb3BlcnR5VmFsdWUoXCJkZXNjcmlwdGlvblwiKSxcbiAgICAgICAgICBpc0FjdGl2ZTogYXNzZXQuZ2V0UHJvcGVydHlWYWx1ZShcInN0YXR1c1wiKSA9PT0gXCJhY3RpdmVcIixcbiAgICAgICAgICBsYXN0VXBkYXRlZDpcbiAgICAgICAgICAgIGFzc2V0LmdldFByb3BlcnR5VmFsdWUoXCJ1cGRhdGVkQXRcIikgfHwgbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgICB9KSlcbiAgICAgICAgLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgICAgICAvLyBTb3J0IGJ5IGFjdGl2ZSBzdGF0dXMgZmlyc3QsIHRoZW4gYnkgbGFzdCB1cGRhdGVkXG4gICAgICAgICAgaWYgKGEuaXNBY3RpdmUgJiYgIWIuaXNBY3RpdmUpIHJldHVybiAtMTtcbiAgICAgICAgICBpZiAoIWEuaXNBY3RpdmUgJiYgYi5pc0FjdGl2ZSkgcmV0dXJuIDE7XG4gICAgICAgICAgcmV0dXJuIChcbiAgICAgICAgICAgIG5ldyBEYXRlKGIubGFzdFVwZGF0ZWQpLmdldFRpbWUoKSAtXG4gICAgICAgICAgICBuZXcgRGF0ZShhLmxhc3RVcGRhdGVkKS5nZXRUaW1lKClcbiAgICAgICAgICApO1xuICAgICAgICB9KVxuICAgICAgICAuc2xpY2UoMCwgbWF4UmVzdWx0cyk7XG5cbiAgICAgIHJldHVybiBwcm9qZWN0cztcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKFwiRmFpbGVkIHRvIGdldCBhdmFpbGFibGUgcHJvamVjdHM6XCIsIGVycm9yKTtcbiAgICAgIHJldHVybiBbXTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRGV0ZWN0IGN1cnJlbnQgcHJvamVjdCBiYXNlZCBvbiBjb250ZXh0IGNsdWVzXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGRldGVjdEN1cnJlbnRQcm9qZWN0KFxuICAgIHJlcXVlc3Q6IEdldEN1cnJlbnRQcm9qZWN0UmVxdWVzdCxcbiAgICBhdmFpbGFibGVQcm9qZWN0czogR2V0Q3VycmVudFByb2plY3RSZXNwb25zZVtcImF2YWlsYWJsZVByb2plY3RzXCJdLFxuICApOiBQcm9taXNlPEdldEN1cnJlbnRQcm9qZWN0UmVzcG9uc2VbXCJjdXJyZW50UHJvamVjdFwiXSB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IHN0cmF0ZWd5ID0gcmVxdWVzdC5wcmVmZXJlbmNlcz8uc2VsZWN0aW9uU3RyYXRlZ3kgfHwgXCJjb250ZXh0XCI7XG5cbiAgICBzd2l0Y2ggKHN0cmF0ZWd5KSB7XG4gICAgICBjYXNlIFwiY29udGV4dFwiOlxuICAgICAgICByZXR1cm4gdGhpcy5kZXRlY3RCeUNvbnRleHQocmVxdWVzdCwgYXZhaWxhYmxlUHJvamVjdHMpO1xuICAgICAgY2FzZSBcInJlY2VudFwiOlxuICAgICAgICByZXR1cm4gdGhpcy5kZXRlY3RCeVJlY2VudEFjdGl2aXR5KGF2YWlsYWJsZVByb2plY3RzKTtcbiAgICAgIGNhc2UgXCJhY3RpdmVcIjpcbiAgICAgICAgcmV0dXJuIHRoaXMuZGV0ZWN0QnlBY3RpdmVTdGF0dXMoYXZhaWxhYmxlUHJvamVjdHMpO1xuICAgICAgY2FzZSBcInByaW9yaXR5XCI6XG4gICAgICAgIHJldHVybiB0aGlzLmRldGVjdEJ5UHJpb3JpdHkoYXZhaWxhYmxlUHJvamVjdHMpO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIHRoaXMuZGV0ZWN0QnlDb250ZXh0KHJlcXVlc3QsIGF2YWlsYWJsZVByb2plY3RzKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRGV0ZWN0IHByb2plY3QgYnkgYW5hbHl6aW5nIGN1cnJlbnQgZmlsZSBjb250ZXh0XG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGRldGVjdEJ5Q29udGV4dChcbiAgICByZXF1ZXN0OiBHZXRDdXJyZW50UHJvamVjdFJlcXVlc3QsXG4gICAgYXZhaWxhYmxlUHJvamVjdHM6IEdldEN1cnJlbnRQcm9qZWN0UmVzcG9uc2VbXCJhdmFpbGFibGVQcm9qZWN0c1wiXSxcbiAgKTogUHJvbWlzZTxHZXRDdXJyZW50UHJvamVjdFJlc3BvbnNlW1wiY3VycmVudFByb2plY3RcIl0gfCB1bmRlZmluZWQ+IHtcbiAgICBpZiAoIXJlcXVlc3QuYWN0aXZlRmlsZSkge1xuICAgICAgcmV0dXJuIHRoaXMuZGV0ZWN0QnlSZWNlbnRBY3Rpdml0eShhdmFpbGFibGVQcm9qZWN0cyk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIC8vIENoZWNrIGlmIGN1cnJlbnQgZmlsZSBpcyBhIHByb2plY3QgZmlsZVxuICAgICAgY29uc3QgY3VycmVudEFzc2V0ID0gYXdhaXQgdGhpcy5hc3NldFJlcG9zaXRvcnkuZmluZEJ5RmlsZW5hbWUoXG4gICAgICAgIHJlcXVlc3QuYWN0aXZlRmlsZSxcbiAgICAgICk7XG4gICAgICBpZiAoY3VycmVudEFzc2V0KSB7XG4gICAgICAgIGNvbnN0IGNsYXNzTmFtZSA9IGN1cnJlbnRBc3NldC5nZXRDbGFzc05hbWUoKS50b1N0cmluZygpO1xuICAgICAgICBpZiAoY2xhc3NOYW1lID09PSBcImVtc19fUHJvamVjdFwiKSB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuYXNzZXRUb1Byb2plY3RSZXNwb25zZShjdXJyZW50QXNzZXQpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ2hlY2sgaWYgY3VycmVudCBhc3NldCBoYXMgcHJvamVjdCByZWxhdGlvbnNoaXBcbiAgICAgICAgY29uc3QgcHJvamVjdElkID1cbiAgICAgICAgICBjdXJyZW50QXNzZXQuZ2V0UHJvcGVydHkoXCJwcm9qZWN0SWRcIikgfHxcbiAgICAgICAgICBjdXJyZW50QXNzZXQuZ2V0UHJvcGVydHkoXCJleG9fX0VmZm9ydF9wYXJlbnRcIik7XG4gICAgICAgIGlmIChwcm9qZWN0SWQpIHtcbiAgICAgICAgICBjb25zdCBjbGVhblByb2plY3RJZCA9IHByb2plY3RJZC50b1N0cmluZygpLnJlcGxhY2UoL1xcW1xcW3xcXF1cXF0vZywgXCJcIik7XG4gICAgICAgICAgY29uc3QgcHJvamVjdCA9IGF2YWlsYWJsZVByb2plY3RzLmZpbmQoXG4gICAgICAgICAgICAocCkgPT4gcC5pZCA9PT0gY2xlYW5Qcm9qZWN0SWQsXG4gICAgICAgICAgKTtcbiAgICAgICAgICBpZiAocHJvamVjdCkge1xuICAgICAgICAgICAgcmV0dXJuIHByb2plY3Q7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFVzZSBSREYgZ3JhcGggdG8gZmluZCBwcm9qZWN0IHJlbGF0aW9uc2hpcHNcbiAgICAgIGNvbnN0IHByb2plY3RGcm9tR3JhcGggPSBhd2FpdCB0aGlzLmZpbmRQcm9qZWN0RnJvbUdyYXBoKFxuICAgICAgICByZXF1ZXN0LmFjdGl2ZUZpbGUsXG4gICAgICAgIGF2YWlsYWJsZVByb2plY3RzLFxuICAgICAgKTtcbiAgICAgIGlmIChwcm9qZWN0RnJvbUdyYXBoKSB7XG4gICAgICAgIHJldHVybiBwcm9qZWN0RnJvbUdyYXBoO1xuICAgICAgfVxuXG4gICAgICAvLyBGYWxsYmFjayB0byByZWNlbnQgYWN0aXZpdHlcbiAgICAgIHJldHVybiB0aGlzLmRldGVjdEJ5UmVjZW50QWN0aXZpdHkoYXZhaWxhYmxlUHJvamVjdHMpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLndhcm4oXCJDb250ZXh0LWJhc2VkIHByb2plY3QgZGV0ZWN0aW9uIGZhaWxlZDpcIiwgZXJyb3IpO1xuICAgICAgcmV0dXJuIHRoaXMuZGV0ZWN0QnlSZWNlbnRBY3Rpdml0eShhdmFpbGFibGVQcm9qZWN0cyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIERldGVjdCBwcm9qZWN0IHVzaW5nIFJERiBncmFwaCByZWxhdGlvbnNoaXBzXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGZpbmRQcm9qZWN0RnJvbUdyYXBoKFxuICAgIGFjdGl2ZUZpbGU6IHN0cmluZyxcbiAgICBhdmFpbGFibGVQcm9qZWN0czogR2V0Q3VycmVudFByb2plY3RSZXNwb25zZVtcImF2YWlsYWJsZVByb2plY3RzXCJdLFxuICApOiBQcm9taXNlPEdldEN1cnJlbnRQcm9qZWN0UmVzcG9uc2VbXCJjdXJyZW50UHJvamVjdFwiXSB8IHVuZGVmaW5lZD4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBDbGVhbiBmaWxlIHBhdGggZm9yIElSSVxuICAgICAgY29uc3QgZmlsZUlSSSA9IGFjdGl2ZUZpbGUucmVwbGFjZSgvXFwubWQkLywgXCJcIikucmVwbGFjZSgvXFxzKy9nLCBcIl9cIik7XG5cbiAgICAgIC8vIFF1ZXJ5IGZvciBwcm9qZWN0IHJlbGF0aW9uc2hpcHNcbiAgICAgIGNvbnN0IHByb2plY3RUcmlwbGVzID0gdGhpcy5ncmFwaC5xdWVyeShmaWxlSVJJLCBcImV4b19fRWZmb3J0X3BhcmVudFwiKTtcblxuICAgICAgaWYgKHByb2plY3RUcmlwbGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgY29uc3QgcHJvamVjdElSSSA9IHByb2plY3RUcmlwbGVzWzBdLmdldE9iamVjdCgpLnRvU3RyaW5nKCk7XG4gICAgICAgIGNvbnN0IHByb2plY3QgPSBhdmFpbGFibGVQcm9qZWN0cy5maW5kKFxuICAgICAgICAgIChwKSA9PlxuICAgICAgICAgICAgcC5pZCA9PT0gcHJvamVjdElSSSB8fCBwLnRpdGxlLnJlcGxhY2UoL1xccysvZywgXCJfXCIpID09PSBwcm9qZWN0SVJJLFxuICAgICAgICApO1xuICAgICAgICBpZiAocHJvamVjdCkge1xuICAgICAgICAgIHJldHVybiBwcm9qZWN0O1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIENoZWNrIHJldmVyc2UgcmVsYXRpb25zaGlwcyAocHJvamVjdCAtPiB0YXNrKVxuICAgICAgY29uc3QgdGFza1RyaXBsZXMgPSB0aGlzLmdyYXBoLnF1ZXJ5KFxuICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgIFwiZXhvX19FZmZvcnRfcGFyZW50XCIsXG4gICAgICAgIGZpbGVJUkksXG4gICAgICApO1xuXG4gICAgICBmb3IgKGNvbnN0IHRyaXBsZSBvZiB0YXNrVHJpcGxlcykge1xuICAgICAgICBjb25zdCBwb3RlbnRpYWxQcm9qZWN0ID0gdHJpcGxlLmdldFN1YmplY3QoKS50b1N0cmluZygpO1xuICAgICAgICBjb25zdCBwcm9qZWN0ID0gYXZhaWxhYmxlUHJvamVjdHMuZmluZChcbiAgICAgICAgICAocCkgPT5cbiAgICAgICAgICAgIHAuaWQgPT09IHBvdGVudGlhbFByb2plY3QgfHxcbiAgICAgICAgICAgIHAudGl0bGUucmVwbGFjZSgvXFxzKy9nLCBcIl9cIikgPT09IHBvdGVudGlhbFByb2plY3QsXG4gICAgICAgICk7XG4gICAgICAgIGlmIChwcm9qZWN0KSB7XG4gICAgICAgICAgcmV0dXJuIHByb2plY3Q7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKFwiR3JhcGgtYmFzZWQgcHJvamVjdCBkZXRlY3Rpb24gZmFpbGVkOlwiLCBlcnJvcik7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBEZXRlY3QgcHJvamVjdCBieSByZWNlbnQgYWN0aXZpdHlcbiAgICovXG4gIHByaXZhdGUgZGV0ZWN0QnlSZWNlbnRBY3Rpdml0eShcbiAgICBhdmFpbGFibGVQcm9qZWN0czogR2V0Q3VycmVudFByb2plY3RSZXNwb25zZVtcImF2YWlsYWJsZVByb2plY3RzXCJdLFxuICApOiBHZXRDdXJyZW50UHJvamVjdFJlc3BvbnNlW1wiY3VycmVudFByb2plY3RcIl0gfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHJlY2VudFByb2plY3RzID0gYXZhaWxhYmxlUHJvamVjdHNcbiAgICAgIC5maWx0ZXIoKHApID0+IHAuaXNBY3RpdmUpXG4gICAgICAuc29ydChcbiAgICAgICAgKGEsIGIpID0+XG4gICAgICAgICAgbmV3IERhdGUoYi5sYXN0VXBkYXRlZCkuZ2V0VGltZSgpIC0gbmV3IERhdGUoYS5sYXN0VXBkYXRlZCkuZ2V0VGltZSgpLFxuICAgICAgKTtcblxuICAgIHJldHVybiByZWNlbnRQcm9qZWN0c1swXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZXRlY3QgcHJvamVjdCBieSBhY3RpdmUgc3RhdHVzXG4gICAqL1xuICBwcml2YXRlIGRldGVjdEJ5QWN0aXZlU3RhdHVzKFxuICAgIGF2YWlsYWJsZVByb2plY3RzOiBHZXRDdXJyZW50UHJvamVjdFJlc3BvbnNlW1wiYXZhaWxhYmxlUHJvamVjdHNcIl0sXG4gICk6IEdldEN1cnJlbnRQcm9qZWN0UmVzcG9uc2VbXCJjdXJyZW50UHJvamVjdFwiXSB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIGF2YWlsYWJsZVByb2plY3RzLmZpbmQoKHApID0+IHAuaXNBY3RpdmUpO1xuICB9XG5cbiAgLyoqXG4gICAqIERldGVjdCBwcm9qZWN0IGJ5IHByaW9yaXR5XG4gICAqL1xuICBwcml2YXRlIGRldGVjdEJ5UHJpb3JpdHkoXG4gICAgYXZhaWxhYmxlUHJvamVjdHM6IEdldEN1cnJlbnRQcm9qZWN0UmVzcG9uc2VbXCJhdmFpbGFibGVQcm9qZWN0c1wiXSxcbiAgKTogR2V0Q3VycmVudFByb2plY3RSZXNwb25zZVtcImN1cnJlbnRQcm9qZWN0XCJdIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBwcmlvcml0eU9yZGVyOiBSZWNvcmQ8c3RyaW5nLCBudW1iZXI+ID0ge1xuICAgICAgdXJnZW50OiA0LFxuICAgICAgaGlnaDogMyxcbiAgICAgIG1lZGl1bTogMixcbiAgICAgIGxvdzogMSxcbiAgICB9O1xuXG4gICAgcmV0dXJuIGF2YWlsYWJsZVByb2plY3RzXG4gICAgICAuZmlsdGVyKChwKSA9PiBwLmlzQWN0aXZlKVxuICAgICAgLnNvcnQoXG4gICAgICAgIChhLCBiKSA9PlxuICAgICAgICAgIChwcmlvcml0eU9yZGVyW2IucHJpb3JpdHldIHx8IDIpIC0gKHByaW9yaXR5T3JkZXJbYS5wcmlvcml0eV0gfHwgMiksXG4gICAgICApWzBdO1xuICB9XG5cbiAgLyoqXG4gICAqIEJ1aWxkIGNvbnRleHQgaW5mb3JtYXRpb24gZm9yIHJlc3BvbnNlXG4gICAqL1xuICBwcml2YXRlIGJ1aWxkQ29udGV4dEluZm8oXG4gICAgcmVxdWVzdDogR2V0Q3VycmVudFByb2plY3RSZXF1ZXN0LFxuICAgIGN1cnJlbnRQcm9qZWN0PzogR2V0Q3VycmVudFByb2plY3RSZXNwb25zZVtcImN1cnJlbnRQcm9qZWN0XCJdLFxuICApOiBHZXRDdXJyZW50UHJvamVjdFJlc3BvbnNlW1wiY29udGV4dFwiXSB7XG4gICAgY29uc3Qgc3RyYXRlZ3kgPSByZXF1ZXN0LnByZWZlcmVuY2VzPy5zZWxlY3Rpb25TdHJhdGVneSB8fCBcImNvbnRleHRcIjtcblxuICAgIGxldCBjb25maWRlbmNlID0gMDtcbiAgICBsZXQgcmVhc29uaW5nID0gXCJcIjtcblxuICAgIGlmIChjdXJyZW50UHJvamVjdCkge1xuICAgICAgc3dpdGNoIChzdHJhdGVneSkge1xuICAgICAgICBjYXNlIFwiY29udGV4dFwiOlxuICAgICAgICAgIGNvbmZpZGVuY2UgPSByZXF1ZXN0LmFjdGl2ZUZpbGUgPyAwLjggOiAwLjM7XG4gICAgICAgICAgcmVhc29uaW5nID0gcmVxdWVzdC5hY3RpdmVGaWxlXG4gICAgICAgICAgICA/IGBEZXRlY3RlZCBmcm9tIGN1cnJlbnQgZmlsZSBjb250ZXh0OiAke3JlcXVlc3QuYWN0aXZlRmlsZX1gXG4gICAgICAgICAgICA6IFwiVXNlZCBtb3N0IHJlY2VudCBhY3RpdmUgcHJvamVjdFwiO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFwicmVjZW50XCI6XG4gICAgICAgICAgY29uZmlkZW5jZSA9IDAuNjtcbiAgICAgICAgICByZWFzb25pbmcgPSBcIlNlbGVjdGVkIG1vc3QgcmVjZW50bHkgdXBkYXRlZCBhY3RpdmUgcHJvamVjdFwiO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFwiYWN0aXZlXCI6XG4gICAgICAgICAgY29uZmlkZW5jZSA9IDAuNTtcbiAgICAgICAgICByZWFzb25pbmcgPSBcIlNlbGVjdGVkIGZpcnN0IGFjdGl2ZSBwcm9qZWN0XCI7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgXCJwcmlvcml0eVwiOlxuICAgICAgICAgIGNvbmZpZGVuY2UgPSAwLjc7XG4gICAgICAgICAgcmVhc29uaW5nID0gXCJTZWxlY3RlZCBoaWdoZXN0IHByaW9yaXR5IGFjdGl2ZSBwcm9qZWN0XCI7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlYXNvbmluZyA9IFwiTm8gc3VpdGFibGUgcHJvamVjdCBmb3VuZFwiO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBzdHJhdGVneSxcbiAgICAgIGNvbmZpZGVuY2UsXG4gICAgICByZWFzb25pbmcsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb252ZXJ0IEFzc2V0IHRvIHByb2plY3QgcmVzcG9uc2UgZm9ybWF0XG4gICAqL1xuICBwcml2YXRlIGFzc2V0VG9Qcm9qZWN0UmVzcG9uc2UoXG4gICAgYXNzZXQ6IEFzc2V0LFxuICApOiBHZXRDdXJyZW50UHJvamVjdFJlc3BvbnNlW1wiY3VycmVudFByb2plY3RcIl0ge1xuICAgIHJldHVybiB7XG4gICAgICBpZDogYXNzZXQuZ2V0SWQoKS50b1N0cmluZygpLFxuICAgICAgdGl0bGU6IGFzc2V0LmdldFRpdGxlKCksXG4gICAgICBzdGF0dXM6IGFzc2V0LmdldFByb3BlcnR5VmFsdWUoXCJzdGF0dXNcIikgfHwgXCJhY3RpdmVcIixcbiAgICAgIHByaW9yaXR5OiBhc3NldC5nZXRQcm9wZXJ0eVZhbHVlKFwicHJpb3JpdHlcIikgfHwgXCJtZWRpdW1cIixcbiAgICAgIGRlc2NyaXB0aW9uOiBhc3NldC5nZXRQcm9wZXJ0eVZhbHVlKFwiZGVzY3JpcHRpb25cIiksXG4gICAgfTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9