f45a2d5d7c7f18fbe27650aed9091760
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ErrorHandlerService = void 0;
const tslib_1 = require("tslib");
const ExocortexError_1 = require("../../domain/errors/ExocortexError");
const ErrorAnalyzer_1 = require("../../domain/errors/ErrorAnalyzer");
const EnhancedResult_1 = require("../../domain/core/EnhancedResult");
const obsidian_1 = require("obsidian");
class ErrorHandlerService {
    constructor(options = {}) {
        this.options = options;
        this.errorHistory = [];
        this.errorMetrics = {
            totalErrors: 0,
            errorsBySeverity: {
                [ExocortexError_1.ErrorSeverity.CRITICAL]: 0,
                [ExocortexError_1.ErrorSeverity.ERROR]: 0,
                [ExocortexError_1.ErrorSeverity.WARNING]: 0,
                [ExocortexError_1.ErrorSeverity.INFO]: 0
            },
            errorsByCategory: {
                [ExocortexError_1.ErrorCategory.SYNTAX]: 0,
                [ExocortexError_1.ErrorCategory.SEMANTIC]: 0,
                [ExocortexError_1.ErrorCategory.VALIDATION]: 0,
                [ExocortexError_1.ErrorCategory.SYSTEM]: 0,
                [ExocortexError_1.ErrorCategory.NETWORK]: 0,
                [ExocortexError_1.ErrorCategory.PERMISSION]: 0
            },
            averageResolutionTime: 0
        };
        this.resolutionTimes = [];
        this.maxHistorySize = 100;
        this.errorStartTimes = new Map();
        this.options = Object.assign({ showUserNotification: true, logToConsole: true, trackMetrics: true, autoRecover: false }, options);
    }
    handleError(error, context) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const startTime = Date.now();
            try {
                let exoError;
                if (typeof error === 'string') {
                    exoError = ErrorAnalyzer_1.ErrorAnalyzer.analyze(error);
                }
                else if (error instanceof Error) {
                    exoError = ErrorAnalyzer_1.ErrorAnalyzer.analyze(error);
                }
                else {
                    exoError = error;
                }
                if (context) {
                    exoError = Object.assign(Object.assign({}, exoError), { context: Object.assign(Object.assign({}, exoError.context), context) });
                }
                this.errorStartTimes.set(exoError.id, startTime);
                if (this.options.trackMetrics) {
                    this.updateMetrics(exoError);
                }
                if (this.options.logToConsole) {
                    this.logError(exoError);
                }
                if (this.options.showUserNotification) {
                    this.showUserNotification(exoError);
                }
                this.addToHistory(exoError);
                if (this.options.autoRecover && exoError.recoverable) {
                    yield this.attemptRecovery(exoError);
                }
                return EnhancedResult_1.EnhancedResult.okEnhanced();
            }
            catch (handlingError) {
                console.error('Error in error handler:', handlingError);
                return EnhancedResult_1.EnhancedResult.failEnhanced(ExocortexError_1.ErrorBuilder.create()
                    .withTitle('Error Handler Failed')
                    .withMessage('Failed to handle the error properly')
                    .withSeverity(ExocortexError_1.ErrorSeverity.CRITICAL)
                    .withCategory(ExocortexError_1.ErrorCategory.SYSTEM)
                    .withContext({
                    operation: 'Error Handling',
                    timestamp: new Date()
                })
                    .withTechnicalDetails(handlingError instanceof Error ? handlingError.message : String(handlingError))
                    .build());
            }
        });
    }
    markErrorResolved(errorId) {
        const startTime = this.errorStartTimes.get(errorId);
        if (startTime) {
            const resolutionTime = Date.now() - startTime;
            this.resolutionTimes.push(resolutionTime);
            if (this.resolutionTimes.length > 100) {
                this.resolutionTimes.shift();
            }
            this.errorMetrics.averageResolutionTime =
                this.resolutionTimes.reduce((a, b) => a + b, 0) / this.resolutionTimes.length;
            this.errorStartTimes.delete(errorId);
        }
    }
    updateMetrics(error) {
        this.errorMetrics.totalErrors++;
        this.errorMetrics.errorsBySeverity[error.severity]++;
        this.errorMetrics.errorsByCategory[error.category]++;
        this.errorMetrics.lastError = error;
    }
    logError(error) {
        const logLevel = this.getLogLevel(error.severity);
        const logMessage = this.formatErrorForConsole(error);
        switch (logLevel) {
            case 'error':
                console.error(logMessage, error);
                break;
            case 'warn':
                console.warn(logMessage, error);
                break;
            case 'info':
                console.info(logMessage, error);
                break;
            default:
                console.log(logMessage, error);
        }
    }
    getLogLevel(severity) {
        switch (severity) {
            case ExocortexError_1.ErrorSeverity.CRITICAL:
            case ExocortexError_1.ErrorSeverity.ERROR:
                return 'error';
            case ExocortexError_1.ErrorSeverity.WARNING:
                return 'warn';
            case ExocortexError_1.ErrorSeverity.INFO:
                return 'info';
            default:
                return 'log';
        }
    }
    formatErrorForConsole(error) {
        const parts = [
            `[${error.severity.toUpperCase()}]`,
            `[${error.category}]`,
            error.title,
            '-',
            error.message
        ];
        if (error.context.location) {
            if (typeof error.context.location === 'object' && 'line' in error.context.location) {
                parts.push(`(Line ${error.context.location.line}:${error.context.location.column})`);
            }
        }
        return parts.join(' ');
    }
    showUserNotification(error) {
        const duration = this.getNotificationDuration(error.severity);
        const message = this.formatErrorForUser(error);
        new obsidian_1.Notice(message, duration);
    }
    getNotificationDuration(severity) {
        switch (severity) {
            case ExocortexError_1.ErrorSeverity.CRITICAL:
                return 10000;
            case ExocortexError_1.ErrorSeverity.ERROR:
                return 7000;
            case ExocortexError_1.ErrorSeverity.WARNING:
                return 5000;
            case ExocortexError_1.ErrorSeverity.INFO:
                return 3000;
            default:
                return 5000;
        }
    }
    formatErrorForUser(error) {
        let message = `${error.title}: ${error.message}`;
        if (error.suggestions && error.suggestions.length > 0) {
            const topSuggestion = error.suggestions[0];
            message += `\n\nðŸ’¡ ${topSuggestion.title}`;
        }
        return message;
    }
    addToHistory(error) {
        this.errorHistory.unshift(error);
        if (this.errorHistory.length > this.maxHistorySize) {
            this.errorHistory.pop();
        }
    }
    attemptRecovery(error) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (!error.suggestions || error.suggestions.length === 0) {
                return;
            }
            const autoFixSuggestion = error.suggestions.find(s => s.confidence && s.confidence > 0.9 && s.action);
            if (autoFixSuggestion && autoFixSuggestion.action) {
                try {
                    yield autoFixSuggestion.action.handler();
                    new obsidian_1.Notice(`Auto-recovery: ${autoFixSuggestion.title}`, 3000);
                }
                catch (recoveryError) {
                    console.error('Auto-recovery failed:', recoveryError);
                }
            }
        });
    }
    getMetrics() {
        return Object.assign({}, this.errorMetrics);
    }
    getErrorHistory() {
        return [...this.errorHistory];
    }
    clearHistory() {
        this.errorHistory = [];
        this.errorStartTimes.clear();
    }
    getSuggestions(error) {
        const exoError = ErrorAnalyzer_1.ErrorAnalyzer.analyze(error);
        return exoError.suggestions || [];
    }
    analyzeError(error) {
        return ErrorAnalyzer_1.ErrorAnalyzer.analyze(error);
    }
}
exports.ErrorHandlerService = ErrorHandlerService;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2FwcGxpY2F0aW9uL3NlcnZpY2VzL0Vycm9ySGFuZGxlclNlcnZpY2UudHMiLCJtYXBwaW5ncyI6Ijs7OztBQUFBLHVFQUErSDtBQUMvSCxxRUFBa0U7QUFDbEUscUVBQWtFO0FBQ2xFLHVDQUFrQztBQWlCbEMsTUFBYSxtQkFBbUI7SUF3QjVCLFlBQW9CLFVBQStCLEVBQUU7UUFBakMsWUFBTyxHQUFQLE9BQU8sQ0FBMEI7UUF2QjdDLGlCQUFZLEdBQXFCLEVBQUUsQ0FBQztRQUNwQyxpQkFBWSxHQUFpQjtZQUNqQyxXQUFXLEVBQUUsQ0FBQztZQUNkLGdCQUFnQixFQUFFO2dCQUNkLENBQUMsOEJBQWEsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO2dCQUMzQixDQUFDLDhCQUFhLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztnQkFDeEIsQ0FBQyw4QkFBYSxDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUM7Z0JBQzFCLENBQUMsOEJBQWEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO2FBQzFCO1lBQ0QsZ0JBQWdCLEVBQUU7Z0JBQ2QsQ0FBQyw4QkFBYSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7Z0JBQ3pCLENBQUMsOEJBQWEsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO2dCQUMzQixDQUFDLDhCQUFhLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQztnQkFDN0IsQ0FBQyw4QkFBYSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7Z0JBQ3pCLENBQUMsOEJBQWEsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO2dCQUMxQixDQUFDLDhCQUFhLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQzthQUNoQztZQUNELHFCQUFxQixFQUFFLENBQUM7U0FDM0IsQ0FBQztRQUNNLG9CQUFlLEdBQWEsRUFBRSxDQUFDO1FBQy9CLG1CQUFjLEdBQUcsR0FBRyxDQUFDO1FBQ3JCLG9CQUFlLEdBQUcsSUFBSSxHQUFH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LEtBQUssRUFBRSxDQUFDO0lBQ2pDLENBQUM7SUFFRCxjQUFjLENBQUMsS0FBcUI7UUFDaEMsTUFBTSxRQUFRLEdBQUcsNkJBQWEsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDOUMsT0FBTyxRQUFRLENBQUMsV0FBVyxJQUFJLEVBQUUsQ0FBQztJQUN0QyxDQUFDO0lBRUQsWUFBWSxDQUFDLEtBQXFCO1FBQzlCLE9BQU8sNkJBQWEsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDeEMsQ0FBQztDQUNKO0FBN1BELGtEQTZQQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva2l0ZWxldi9Eb2N1bWVudHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi9zcmMvYXBwbGljYXRpb24vc2VydmljZXMvRXJyb3JIYW5kbGVyU2VydmljZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFeG9jb3J0ZXhFcnJvciwgRXJyb3JTZXZlcml0eSwgRXJyb3JDYXRlZ29yeSwgRml4U3VnZ2VzdGlvbiwgRXJyb3JCdWlsZGVyIH0gZnJvbSAnLi4vLi4vZG9tYWluL2Vycm9ycy9FeG9jb3J0ZXhFcnJvcic7XG5pbXBvcnQgeyBFcnJvckFuYWx5emVyIH0gZnJvbSAnLi4vLi4vZG9tYWluL2Vycm9ycy9FcnJvckFuYWx5emVyJztcbmltcG9ydCB7IEVuaGFuY2VkUmVzdWx0IH0gZnJvbSAnLi4vLi4vZG9tYWluL2NvcmUvRW5oYW5jZWRSZXN1bHQnO1xuaW1wb3J0IHsgTm90aWNlIH0gZnJvbSAnb2JzaWRpYW4nO1xuXG5leHBvcnQgaW50ZXJmYWNlIEVycm9ySGFuZGxlck9wdGlvbnMge1xuICAgIHNob3dVc2VyTm90aWZpY2F0aW9uPzogYm9vbGVhbjtcbiAgICBsb2dUb0NvbnNvbGU/OiBib29sZWFuO1xuICAgIHRyYWNrTWV0cmljcz86IGJvb2xlYW47XG4gICAgYXV0b1JlY292ZXI/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEVycm9yTWV0cmljcyB7XG4gICAgdG90YWxFcnJvcnM6IG51bWJlcjtcbiAgICBlcnJvcnNCeVNldmVyaXR5OiBSZWNvcmQ8RXJyb3JTZXZlcml0eSwgbnVtYmVyPjtcbiAgICBlcnJvcnNCeUNhdGVnb3J5OiBSZWNvcmQ8RXJyb3JDYXRlZ29yeSwgbnVtYmVyPjtcbiAgICBhdmVyYWdlUmVzb2x1dGlvblRpbWU6IG51bWJlcjtcbiAgICBsYXN0RXJyb3I/OiBFeG9jb3J0ZXhFcnJvcjtcbn1cblxuZXhwb3J0IGNsYXNzIEVycm9ySGFuZGxlclNlcnZpY2Uge1xuICAgIHByaXZhdGUgZXJyb3JIaXN0b3J5OiBFeG9jb3J0ZXhFcnJvcltdID0gW107XG4gICAgcHJpdmF0ZSBlcnJvck1ldHJpY3M6IEVycm9yTWV0cmljcyA9IHtcbiAgICAgICAgdG90YWxFcnJvcnM6IDAsXG4gICAgICAgIGVycm9yc0J5U2V2ZXJpdHk6IHtcbiAgICAgICAgICAgIFtFcnJvclNldmVyaXR5LkNSSVRJQ0FMXTogMCxcbiAgICAgICAgICAgIFtFcnJvclNldmVyaXR5LkVSUk9SXTogMCxcbiAgICAgICAgICAgIFtFcnJvclNldmVyaXR5LldBUk5JTkddOiAwLFxuICAgICAgICAgICAgW0Vycm9yU2V2ZXJpdHkuSU5GT106IDBcbiAgICAgICAgfSxcbiAgICAgICAgZXJyb3JzQnlDYXRlZ29yeToge1xuICAgICAgICAgICAgW0Vycm9yQ2F0ZWdvcnkuU1lOVEFYXTogMCxcbiAgICAgICAgICAgIFtFcnJvckNhdGVnb3J5LlNFTUFOVElDXTogMCxcbiAgICAgICAgICAgIFtFcnJvckNhdGVnb3J5LlZBTElEQVRJT05dOiAwLFxuICAgICAgICAgICAgW0Vycm9yQ2F0ZWdvcnkuU1lTVEVNXTogMCxcbiAgICAgICAgICAgIFtFcnJvckNhdGVnb3J5Lk5FVFdPUktdOiAwLFxuICAgICAgICAgICAgW0Vycm9yQ2F0ZWdvcnkuUEVSTUlTU0lPTl06IDBcbiAgICAgICAgfSxcbiAgICAgICAgYXZlcmFnZVJlc29sdXRpb25UaW1lOiAwXG4gICAgfTtcbiAgICBwcml2YXRlIHJlc29sdXRpb25UaW1lczogbnVtYmVyW10gPSBbXTtcbiAgICBwcml2YXRlIG1heEhpc3RvcnlTaXplID0gMTAwO1xuICAgIHByaXZhdGUgZXJyb3JTdGFydFRpbWVzID0gbmV3IE1hcDxzdHJpbmcsIG51bWJlcj4oKTtcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgb3B0aW9uczogRXJyb3JIYW5kbGVyT3B0aW9ucyA9IHt9KSB7XG4gICAgICAgIHRoaXMub3B0aW9ucyA9IHtcbiAgICAgICAgICAgIHNob3dVc2VyTm90aWZpY2F0aW9uOiB0cnVlLFxuICAgICAgICAgICAgbG9nVG9Db25zb2xlOiB0cnVlLFxuICAgICAgICAgICAgdHJhY2tNZXRyaWNzOiB0cnVlLFxuICAgICAgICAgICAgYXV0b1JlY292ZXI6IGZhbHNlLFxuICAgICAgICAgICAgLi4ub3B0aW9uc1xuICAgICAgICB9O1xuICAgIH1cblxuICAgIGFzeW5jIGhhbmRsZUVycm9yKGVycm9yOiBFcnJvciB8IEV4b2NvcnRleEVycm9yIHwgc3RyaW5nLCBjb250ZXh0PzogUGFydGlhbDxFeG9jb3J0ZXhFcnJvclsnY29udGV4dCddPik6IFByb21pc2U8RW5oYW5jZWRSZXN1bHQ8dm9pZD4+IHtcbiAgICAgICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICAgICAgXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBsZXQgZXhvRXJyb3I6IEV4b2NvcnRleEVycm9yO1xuXG4gICAgICAgICAgICBpZiAodHlwZW9mIGVycm9yID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgICAgIGV4b0Vycm9yID0gRXJyb3JBbmFseXplci5hbmFseXplKGVycm9yKTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvcikge1xuICAgICAgICAgICAgICAgIGV4b0Vycm9yID0gRXJyb3JBbmFseXplci5hbmFseXplKGVycm9yKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgZXhvRXJyb3IgPSBlcnJvcjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNvbnRleHQpIHtcbiAgICAgICAgICAgICAgICBleG9FcnJvciA9IHtcbiAgICAgICAgICAgICAgICAgICAgLi4uZXhvRXJyb3IsXG4gICAgICAgICAgICAgICAgICAgIGNvbnRleHQ6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIC4uLmV4b0Vycm9yLmNvbnRleHQsXG4gICAgICAgICAgICAgICAgICAgICAgICAuLi5jb250ZXh0XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmVycm9yU3RhcnRUaW1lcy5zZXQoZXhvRXJyb3IuaWQsIHN0YXJ0VGltZSk7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMudHJhY2tNZXRyaWNzKSB7XG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVNZXRyaWNzKGV4b0Vycm9yKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5sb2dUb0NvbnNvbGUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmxvZ0Vycm9yKGV4b0Vycm9yKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5zaG93VXNlck5vdGlmaWNhdGlvbikge1xuICAgICAgICAgICAgICAgIHRoaXMuc2hvd1VzZXJOb3RpZmljYXRpb24oZXhvRXJyb3IpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmFkZFRvSGlzdG9yeShleG9FcnJvcik7XG5cbiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuYXV0b1JlY292ZXIgJiYgZXhvRXJyb3IucmVjb3ZlcmFibGUpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmF0dGVtcHRSZWNvdmVyeShleG9FcnJvcik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBFbmhhbmNlZFJlc3VsdC5va0VuaGFuY2VkKCk7XG4gICAgICAgIH0gY2F0Y2ggKGhhbmRsaW5nRXJyb3IpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGluIGVycm9yIGhhbmRsZXI6JywgaGFuZGxpbmdFcnJvcik7XG4gICAgICAgICAgICByZXR1cm4gRW5oYW5jZWRSZXN1bHQuZmFpbEVuaGFuY2VkKFxuICAgICAgICAgICAgICAgIEVycm9yQnVpbGRlci5jcmVhdGUoKVxuICAgICAgICAgICAgICAgICAgICAud2l0aFRpdGxlKCdFcnJvciBIYW5kbGVyIEZhaWxlZCcpXG4gICAgICAgICAgICAgICAgICAgIC53aXRoTWVzc2FnZSgnRmFpbGVkIHRvIGhhbmRsZSB0aGUgZXJyb3IgcHJvcGVybHknKVxuICAgICAgICAgICAgICAgICAgICAud2l0aFNldmVyaXR5KEVycm9yU2V2ZXJpdHkuQ1JJVElDQUwpXG4gICAgICAgICAgICAgICAgICAgIC53aXRoQ2F0ZWdvcnkoRXJyb3JDYXRlZ29yeS5TWVNURU0pXG4gICAgICAgICAgICAgICAgICAgIC53aXRoQ29udGV4dCh7XG4gICAgICAgICAgICAgICAgICAgICAgICBvcGVyYXRpb246ICdFcnJvciBIYW5kbGluZycsXG4gICAgICAgICAgICAgICAgICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKClcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgLndpdGhUZWNobmljYWxEZXRhaWxzKGhhbmRsaW5nRXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGhhbmRsaW5nRXJyb3IubWVzc2FnZSA6IFN0cmluZyhoYW5kbGluZ0Vycm9yKSlcbiAgICAgICAgICAgICAgICAgICAgLmJ1aWxkKClcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBtYXJrRXJyb3JSZXNvbHZlZChlcnJvcklkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgY29uc3Qgc3RhcnRUaW1lID0gdGhpcy5lcnJvclN0YXJ0VGltZXMuZ2V0KGVycm9ySWQpO1xuICAgICAgICBpZiAoc3RhcnRUaW1lKSB7XG4gICAgICAgICAgICBjb25zdCByZXNvbHV0aW9uVGltZSA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG4gICAgICAgICAgICB0aGlzLnJlc29sdXRpb25UaW1lcy5wdXNoKHJlc29sdXRpb25UaW1lKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKHRoaXMucmVzb2x1dGlvblRpbWVzLmxlbmd0aCA+IDEwMCkge1xuICAgICAgICAgICAgICAgIHRoaXMucmVzb2x1dGlvblRpbWVzLnNoaWZ0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIHRoaXMuZXJyb3JNZXRyaWNzLmF2ZXJhZ2VSZXNvbHV0aW9uVGltZSA9IFxuICAgICAgICAgICAgICAgIHRoaXMucmVzb2x1dGlvblRpbWVzLnJlZHVjZSgoYSwgYikgPT4gYSArIGIsIDApIC8gdGhpcy5yZXNvbHV0aW9uVGltZXMubGVuZ3RoO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICB0aGlzLmVycm9yU3RhcnRUaW1lcy5kZWxldGUoZXJyb3JJZCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHVwZGF0ZU1ldHJpY3MoZXJyb3I6IEV4b2NvcnRleEVycm9yKTogdm9pZCB7XG4gICAgICAgIHRoaXMuZXJyb3JNZXRyaWNzLnRvdGFsRXJyb3JzKys7XG4gICAgICAgIHRoaXMuZXJyb3JNZXRyaWNzLmVycm9yc0J5U2V2ZXJpdHlbZXJyb3Iuc2V2ZXJpdHldKys7XG4gICAgICAgIHRoaXMuZXJyb3JNZXRyaWNzLmVycm9yc0J5Q2F0ZWdvcnlbZXJyb3IuY2F0ZWdvcnldKys7XG4gICAgICAgIHRoaXMuZXJyb3JNZXRyaWNzLmxhc3RFcnJvciA9IGVycm9yO1xuICAgIH1cblxuICAgIHByaXZhdGUgbG9nRXJyb3IoZXJyb3I6IEV4b2NvcnRleEVycm9yKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGxvZ0xldmVsID0gdGhpcy5nZXRMb2dMZXZlbChlcnJvci5zZXZlcml0eSk7XG4gICAgICAgIGNvbnN0IGxvZ01lc3NhZ2UgPSB0aGlzLmZvcm1hdEVycm9yRm9yQ29uc29sZShlcnJvcik7XG5cbiAgICAgICAgc3dpdGNoIChsb2dMZXZlbCkge1xuICAgICAgICAgICAgY2FzZSAnZXJyb3InOlxuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IobG9nTWVzc2FnZSwgZXJyb3IpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAnd2Fybic6XG4gICAgICAgICAgICAgICAgY29uc29sZS53YXJuKGxvZ01lc3NhZ2UsIGVycm9yKTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgJ2luZm8nOlxuICAgICAgICAgICAgICAgIGNvbnNvbGUuaW5mbyhsb2dNZXNzYWdlLCBlcnJvcik7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGxvZ01lc3NhZ2UsIGVycm9yKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0TG9nTGV2ZWwoc2V2ZXJpdHk6IEVycm9yU2V2ZXJpdHkpOiAnZXJyb3InIHwgJ3dhcm4nIHwgJ2luZm8nIHwgJ2xvZycge1xuICAgICAgICBzd2l0Y2ggKHNldmVyaXR5KSB7XG4gICAgICAgICAgICBjYXNlIEVycm9yU2V2ZXJpdHkuQ1JJVElDQUw6XG4gICAgICAgICAgICBjYXNlIEVycm9yU2V2ZXJpdHkuRVJST1I6XG4gICAgICAgICAgICAgICAgcmV0dXJuICdlcnJvcic7XG4gICAgICAgICAgICBjYXNlIEVycm9yU2V2ZXJpdHkuV0FSTklORzpcbiAgICAgICAgICAgICAgICByZXR1cm4gJ3dhcm4nO1xuICAgICAgICAgICAgY2FzZSBFcnJvclNldmVyaXR5LklORk86XG4gICAgICAgICAgICAgICAgcmV0dXJuICdpbmZvJztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgcmV0dXJuICdsb2cnO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBmb3JtYXRFcnJvckZvckNvbnNvbGUoZXJyb3I6IEV4b2NvcnRleEVycm9yKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgcGFydHMgPSBbXG4gICAgICAgICAgICBgWyR7ZXJyb3Iuc2V2ZXJpdHkudG9VcHBlckNhc2UoKX1dYCxcbiAgICAgICAgICAgIGBbJHtlcnJvci5jYXRlZ29yeX1dYCxcbiAgICAgICAgICAgIGVycm9yLnRpdGxlLFxuICAgICAgICAgICAgJy0nLFxuICAgICAgICAgICAgZXJyb3IubWVzc2FnZVxuICAgICAgICBdO1xuXG4gICAgICAgIGlmIChlcnJvci5jb250ZXh0LmxvY2F0aW9uKSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGVycm9yLmNvbnRleHQubG9jYXRpb24gPT09ICdvYmplY3QnICYmICdsaW5lJyBpbiBlcnJvci5jb250ZXh0LmxvY2F0aW9uKSB7XG4gICAgICAgICAgICAgICAgcGFydHMucHVzaChgKExpbmUgJHtlcnJvci5jb250ZXh0LmxvY2F0aW9uLmxpbmV9OiR7ZXJyb3IuY29udGV4dC5sb2NhdGlvbi5jb2x1bW59KWApO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHBhcnRzLmpvaW4oJyAnKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNob3dVc2VyTm90aWZpY2F0aW9uKGVycm9yOiBFeG9jb3J0ZXhFcnJvcik6IHZvaWQge1xuICAgICAgICBjb25zdCBkdXJhdGlvbiA9IHRoaXMuZ2V0Tm90aWZpY2F0aW9uRHVyYXRpb24oZXJyb3Iuc2V2ZXJpdHkpO1xuICAgICAgICBjb25zdCBtZXNzYWdlID0gdGhpcy5mb3JtYXRFcnJvckZvclVzZXIoZXJyb3IpO1xuICAgICAgICBcbiAgICAgICAgbmV3IE5vdGljZShtZXNzYWdlLCBkdXJhdGlvbik7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXROb3RpZmljYXRpb25EdXJhdGlvbihzZXZlcml0eTogRXJyb3JTZXZlcml0eSk6IG51bWJlciB7XG4gICAgICAgIHN3aXRjaCAoc2V2ZXJpdHkpIHtcbiAgICAgICAgICAgIGNhc2UgRXJyb3JTZXZlcml0eS5DUklUSUNBTDpcbiAgICAgICAgICAgICAgICByZXR1cm4gMTAwMDA7XG4gICAgICAgICAgICBjYXNlIEVycm9yU2V2ZXJpdHkuRVJST1I6XG4gICAgICAgICAgICAgICAgcmV0dXJuIDcwMDA7XG4gICAgICAgICAgICBjYXNlIEVycm9yU2V2ZXJpdHkuV0FSTklORzpcbiAgICAgICAgICAgICAgICByZXR1cm4gNTAwMDtcbiAgICAgICAgICAgIGNhc2UgRXJyb3JTZXZlcml0eS5JTkZPOlxuICAgICAgICAgICAgICAgIHJldHVybiAzMDAwO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICByZXR1cm4gNTAwMDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZm9ybWF0RXJyb3JGb3JVc2VyKGVycm9yOiBFeG9jb3J0ZXhFcnJvcik6IHN0cmluZyB7XG4gICAgICAgIGxldCBtZXNzYWdlID0gYCR7ZXJyb3IudGl0bGV9OiAke2Vycm9yLm1lc3NhZ2V9YDtcbiAgICAgICAgXG4gICAgICAgIGlmIChlcnJvci5zdWdnZXN0aW9ucyAmJiBlcnJvci5zdWdnZXN0aW9ucy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb25zdCB0b3BTdWdnZXN0aW9uID0gZXJyb3Iuc3VnZ2VzdGlvbnNbMF07XG4gICAgICAgICAgICBtZXNzYWdlICs9IGBcXG5cXG7wn5KhICR7dG9wU3VnZ2VzdGlvbi50aXRsZX1gO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gbWVzc2FnZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFkZFRvSGlzdG9yeShlcnJvcjogRXhvY29ydGV4RXJyb3IpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5lcnJvckhpc3RvcnkudW5zaGlmdChlcnJvcik7XG4gICAgICAgIFxuICAgICAgICBpZiAodGhpcy5lcnJvckhpc3RvcnkubGVuZ3RoID4gdGhpcy5tYXhIaXN0b3J5U2l6ZSkge1xuICAgICAgICAgICAgdGhpcy5lcnJvckhpc3RvcnkucG9wKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIGF0dGVtcHRSZWNvdmVyeShlcnJvcjogRXhvY29ydGV4RXJyb3IpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgaWYgKCFlcnJvci5zdWdnZXN0aW9ucyB8fCBlcnJvci5zdWdnZXN0aW9ucy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGF1dG9GaXhTdWdnZXN0aW9uID0gZXJyb3Iuc3VnZ2VzdGlvbnMuZmluZChzID0+IFxuICAgICAgICAgICAgcy5jb25maWRlbmNlICYmIHMuY29uZmlkZW5jZSA+IDAuOSAmJiBzLmFjdGlvblxuICAgICAgICApO1xuXG4gICAgICAgIGlmIChhdXRvRml4U3VnZ2VzdGlvbiAmJiBhdXRvRml4U3VnZ2VzdGlvbi5hY3Rpb24pIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgYXV0b0ZpeFN1Z2dlc3Rpb24uYWN0aW9uLmhhbmRsZXIoKTtcbiAgICAgICAgICAgICAgICBuZXcgTm90aWNlKGBBdXRvLXJlY292ZXJ5OiAke2F1dG9GaXhTdWdnZXN0aW9uLnRpdGxlfWAsIDMwMDApO1xuICAgICAgICAgICAgfSBjYXRjaCAocmVjb3ZlcnlFcnJvcikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0F1dG8tcmVjb3ZlcnkgZmFpbGVkOicsIHJlY292ZXJ5RXJyb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgZ2V0TWV0cmljcygpOiBFcnJvck1ldHJpY3Mge1xuICAgICAgICByZXR1cm4geyAuLi50aGlzLmVycm9yTWV0cmljcyB9O1xuICAgIH1cblxuICAgIGdldEVycm9ySGlzdG9yeSgpOiBFeG9jb3J0ZXhFcnJvcltdIHtcbiAgICAgICAgcmV0dXJuIFsuLi50aGlzLmVycm9ySGlzdG9yeV07XG4gICAgfVxuXG4gICAgY2xlYXJIaXN0b3J5KCk6IHZvaWQge1xuICAgICAgICB0aGlzLmVycm9ySGlzdG9yeSA9IFtdO1xuICAgICAgICB0aGlzLmVycm9yU3RhcnRUaW1lcy5jbGVhcigpO1xuICAgIH1cblxuICAgIGdldFN1Z2dlc3Rpb25zKGVycm9yOiBFcnJvciB8IHN0cmluZyk6IEZpeFN1Z2dlc3Rpb25bXSB7XG4gICAgICAgIGNvbnN0IGV4b0Vycm9yID0gRXJyb3JBbmFseXplci5hbmFseXplKGVycm9yKTtcbiAgICAgICAgcmV0dXJuIGV4b0Vycm9yLnN1Z2dlc3Rpb25zIHx8IFtdO1xuICAgIH1cblxuICAgIGFuYWx5emVFcnJvcihlcnJvcjogRXJyb3IgfCBzdHJpbmcpOiBFeG9jb3J0ZXhFcnJvciB7XG4gICAgICAgIHJldHVybiBFcnJvckFuYWx5emVyLmFuYWx5emUoZXJyb3IpO1xuICAgIH1cbn0iXSwidmVyc2lvbiI6M30=