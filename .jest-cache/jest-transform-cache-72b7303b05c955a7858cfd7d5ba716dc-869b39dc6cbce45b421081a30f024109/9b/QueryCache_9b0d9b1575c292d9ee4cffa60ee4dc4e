1f97326f0737194152fcb64ade0e8b9f
"use strict";
/**
 * SPARQL Query Cache Service
 * Provides in-memory caching for SPARQL query results with TTL and cache invalidation
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.QueryCache = exports.DEFAULT_CACHE_CONFIG = void 0;
exports.DEFAULT_CACHE_CONFIG = {
    maxSize: 1000,
    defaultTTL: 5 * 60 * 1000,
    maxTTL: 30 * 60 * 1000,
    cleanupInterval: 60 * 1000,
    enabled: true
};
class QueryCache {
    constructor(config = {}) {
        this.config = Object.assign(Object.assign({}, exports.DEFAULT_CACHE_CONFIG), config);
        this.cache = new Map();
        this.stats = {
            hits: 0,
            misses: 0,
            evictions: 0,
            totalQueries: 0,
            hitRate: 0,
            size: 0,
            maxSize: this.config.maxSize
        };
        this.startCleanupTimer();
    }
    /**
     * Get cached result for a query
     */
    get(queryKey) {
        if (!this.config.enabled) {
            this.stats.misses++;
            this.stats.totalQueries++;
            this.updateHitRate();
            return null;
        }
        const entry = this.cache.get(queryKey);
        this.stats.totalQueries++;
        if (!entry) {
            this.stats.misses++;
            this.updateHitRate();
            return null;
        }
        // Check if entry has expired
        if (Date.now() > entry.expiresAt) {
            this.cache.delete(queryKey);
            this.stats.misses++;
            this.stats.evictions++;
            this.updateStats();
            this.updateHitRate();
            return null;
        }
        this.stats.hits++;
        this.updateHitRate();
        return entry.value;
    }
    /**
     * Set cached result for a query
     */
    set(queryKey, value, ttl) {
        if (!this.config.enabled) {
            return;
        }
        const requestedTTL = ttl !== undefined ? ttl : this.config.defaultTTL;
        const effectiveTTL = Math.min(Math.max(requestedTTL, 0), this.config.maxTTL);
        const now = Date.now();
        // Don't cache if TTL is zero or negative
        if (effectiveTTL <= 0) {
            return;
        }
        // Evict oldest entries if cache is full
        while (this.cache.size >= this.config.maxSize) {
            this.evictOldest();
        }
        const entry = {
            value,
            timestamp: now,
            expiresAt: now + effectiveTTL,
            queryHash: this.hashQuery(queryKey)
        };
        this.cache.set(queryKey, entry);
        this.updateStats();
    }
    /**
     * Normalize and create cache key from SPARQL query
     */
    createCacheKey(query) {
        // First split on the colon to handle prefix separately if it exists
        const colonIndex = query.indexOf(':');
        let prefix = '';
        let queryPart = query;
        if (colonIndex > 0 && colonIndex < 20) { // Assume prefix is short
            prefix = query.substring(0, colonIndex).toLowerCase() + ':';
            queryPart = query.substring(colonIndex + 1);
        }
        // Normalize the query by removing extra whitespace and converting to lowercase
        const normalized = queryPart
            .trim() // Remove leading/trailing whitespace first
            .replace(/[\r\n\t]+/g, ' ') // Replace newlines and tabs with spaces
            .replace(/\s+/g, ' ') // Replace multiple spaces with single space
            .replace(/\s*\{\s*/g, ' { ') // Normalize spacing around curly braces
            .replace(/\s*\}\s*/g, ' } ')
            .replace(/\s*\(\s*/g, ' ( ') // Normalize spacing around parentheses
            .replace(/\s*\)\s*/g, ' ) ')
            .replace(/\s+/g, ' ') // Clean up spaces again
            .trim() // Trim again after replacements
            .toLowerCase(); // Convert to lowercase for case-insensitive matching
        const fullKey = prefix + normalized;
        // Use the normalized string directly as the key for better consistency
        // Only hash very long queries
        if (fullKey.length > 1000) {
            return this.hashQuery(fullKey);
        }
        return fullKey;
    }
    /**
     * Invalidate all cached entries
     */
    invalidateAll() {
        const sizeBefore = this.cache.size;
        this.cache.clear();
        this.stats.evictions += sizeBefore;
        this.updateStats();
    }
    /**
     * Invalidate entries based on a predicate function
     */
    invalidateWhere(predicate) {
        let invalidated = 0;
        for (const [key, entry] of this.cache.entries()) {
            if (predicate(key, entry)) {
                this.cache.delete(key);
                invalidated++;
            }
        }
        this.stats.evictions += invalidated;
        this.updateStats();
        return invalidated;
    }
    /**
     * Get current cache statistics
     */
    getStatistics() {
        return Object.assign({}, this.stats);
    }
    /**
     * Update cache configuration
     */
    updateConfig(newConfig) {
        this.config = Object.assign(Object.assign({}, this.config), newConfig);
        this.stats.maxSize = this.config.maxSize;
        // If cache is disabled, clear it
        if (!this.config.enabled) {
            this.invalidateAll();
        }
        // If max size reduced, evict entries
        while (this.cache.size > this.config.maxSize) {
            this.evictOldest();
        }
        this.updateStats();
        // Restart cleanup timer if interval changed
        if (newConfig.cleanupInterval !== undefined) {
            this.stopCleanupTimer();
            this.startCleanupTimer();
        }
    }
    /**
     * Get current configuration
     */
    getConfig() {
        return Object.assign({}, this.config);
    }
    /**
     * Manually trigger cleanup of expired entries
     */
    cleanup() {
        const now = Date.now();
        let cleaned = 0;
        for (const [key, entry] of this.cache.entries()) {
            if (now > entry.expiresAt) {
                this.cache.delete(key);
                cleaned++;
            }
        }
        if (cleaned > 0) {
            this.stats.evictions += cleaned;
            this.updateStats();
        }
        return cleaned;
    }
    /**
     * Check if a query result is cached
     */
    has(queryKey) {
        if (!this.config.enabled) {
            return false;
        }
        const entry = this.cache.get(queryKey);
        if (!entry) {
            return false;
        }
        // Check if expired
        if (Date.now() > entry.expiresAt) {
            this.cache.delete(queryKey);
            this.stats.evictions++;
            this.updateStats();
            return false;
        }
        return true;
    }
    /**
     * Destroy the cache and cleanup resources
     */
    destroy() {
        this.stopCleanupTimer();
        this.cache.clear();
    }
    // Private methods
    hashQuery(query) {
        // Simple hash function for query strings
        let hash = 0;
        if (query.length === 0)
            return hash.toString();
        for (let i = 0; i < query.length; i++) {
            const char = query.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // Convert to 32-bit integer
        }
        return Math.abs(hash).toString();
    }
    evictOldest() {
        let oldestKey = null;
        let oldestTimestamp = Infinity;
        for (const [key, entry] of this.cache.entries()) {
            if (entry.timestamp < oldestTimestamp) {
                oldestTimestamp = entry.timestamp;
                oldestKey = key;
            }
        }
        if (oldestKey) {
            this.cache.delete(oldestKey);
            this.stats.evictions++;
            this.updateStats();
        }
    }
    updateStats() {
        this.stats.size = this.cache.size;
    }
    updateHitRate() {
        this.stats.hitRate = this.stats.totalQueries > 0
            ? (this.stats.hits / this.stats.totalQueries) * 100
            : 0;
    }
    startCleanupTimer() {
        if (this.config.cleanupInterval > 0) {
            this.cleanupTimer = setInterval(() => {
                this.cleanup();
            }, this.config.cleanupInterval);
        }
    }
    stopCleanupTimer() {
        if (this.cleanupTimer) {
            clearInterval(this.cleanupTimer);
            this.cleanupTimer = undefined;
        }
    }
}
exports.QueryCache = QueryCache;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2FwcGxpY2F0aW9uL3NlcnZpY2VzL1F1ZXJ5Q2FjaGUudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7O0FBMkJVLFFBQUEsb0JBQW9CLEdBQXFCO0lBQ2xELE9BQU8sRUFBRSxJQUFJO0lBQ2IsVUFBVSxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSTtJQUN6QixNQUFNLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJO0lBQ3RCLGVBQWUsRUFBRSxFQUFFLEdBQUcsSUFBSTtJQUMxQixPQUFPLEVBQUUsSUFBSTtDQUNoQixDQUFDO0FBRUYsTUFBYSxVQUFVO0lBTW5CLFlBQVksU0FBb0MsRUFBRTtRQUM5QyxJQUFJLENBQUMsTUFBTSxtQ0FBUSw0QkFBb0IsR0FBSyxNQUFNLENBQUUsQ0FBQztRQUNyRCxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLEtBQUssR0FBRztZQUNULElBQUksRUFBRSxDQUFDO1lBQ1AsTUFBTSxFQUFFLENBQUM7WUFDVCxTQUFTLEVBQUUsQ0FBQztZQUNaLFlBQVksRUFBRSxDQUFDO1lBQ2YsT0FBTyxFQUFFLENBQUM7WUFDVixJQUFJLEVBQUUsQ0FBQztZQUNQLE9BQU8sRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU87U0FDL0IsQ0FBQztRQUVGLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO0lBQzdCLENBQUM7SUFFRDs7T0FFRztJQUNILEdBQUcsQ0FBSSxRQUFnQjtRQUNuQixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUU7WUFDdEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNwQixJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO1lBQzFCLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUNyQixPQUFPLElBQUks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cyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2FwcGxpY2F0aW9uL3NlcnZpY2VzL1F1ZXJ5Q2FjaGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBTUEFSUUwgUXVlcnkgQ2FjaGUgU2VydmljZVxuICogUHJvdmlkZXMgaW4tbWVtb3J5IGNhY2hpbmcgZm9yIFNQQVJRTCBxdWVyeSByZXN1bHRzIHdpdGggVFRMIGFuZCBjYWNoZSBpbnZhbGlkYXRpb25cbiAqL1xuXG5leHBvcnQgaW50ZXJmYWNlIENhY2hlRW50cnk8VD4ge1xuICAgIHZhbHVlOiBUO1xuICAgIHRpbWVzdGFtcDogbnVtYmVyO1xuICAgIGV4cGlyZXNBdDogbnVtYmVyO1xuICAgIHF1ZXJ5SGFzaDogc3RyaW5nO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENhY2hlU3RhdGlzdGljcyB7XG4gICAgaGl0czogbnVtYmVyO1xuICAgIG1pc3NlczogbnVtYmVyO1xuICAgIGV2aWN0aW9uczogbnVtYmVyO1xuICAgIHRvdGFsUXVlcmllczogbnVtYmVyO1xuICAgIGhpdFJhdGU6IG51bWJlcjtcbiAgICBzaXplOiBudW1iZXI7XG4gICAgbWF4U2l6ZTogbnVtYmVyO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFF1ZXJ5Q2FjaGVDb25maWcge1xuICAgIG1heFNpemU6IG51bWJlcjsgICAgICAgICAgLy8gTWF4aW11bSBudW1iZXIgb2YgY2FjaGVkIGVudHJpZXNcbiAgICBkZWZhdWx0VFRMOiBudW1iZXI7ICAgICAgIC8vIERlZmF1bHQgVFRMIGluIG1pbGxpc2Vjb25kc1xuICAgIG1heFRUTDogbnVtYmVyOyAgICAgICAgICAvLyBNYXhpbXVtIFRUTCBpbiBtaWxsaXNlY29uZHNcbiAgICBjbGVhbnVwSW50ZXJ2YWw6IG51bWJlcjsgIC8vIENsZWFudXAgaW50ZXJ2YWwgaW4gbWlsbGlzZWNvbmRzXG4gICAgZW5hYmxlZDogYm9vbGVhbjsgICAgICAgICAvLyBXaGV0aGVyIGNhY2hpbmcgaXMgZW5hYmxlZFxufVxuXG5leHBvcnQgY29uc3QgREVGQVVMVF9DQUNIRV9DT05GSUc6IFF1ZXJ5Q2FjaGVDb25maWcgPSB7XG4gICAgbWF4U2l6ZTogMTAwMCxcbiAgICBkZWZhdWx0VFRMOiA1ICogNjAgKiAxMDAwLCAgICAvLyA1IG1pbnV0ZXNcbiAgICBtYXhUVEw6IDMwICogNjAgKiAxMDAwLCAgICAgICAvLyAzMCBtaW51dGVzXG4gICAgY2xlYW51cEludGVydmFsOiA2MCAqIDEwMDAsICAgIC8vIDEgbWludXRlXG4gICAgZW5hYmxlZDogdHJ1ZVxufTtcblxuZXhwb3J0IGNsYXNzIFF1ZXJ5Q2FjaGUge1xuICAgIHByaXZhdGUgY2FjaGU6IE1hcDxzdHJpbmcsIENhY2hlRW50cnk8YW55Pj47XG4gICAgcHJpdmF0ZSBzdGF0czogQ2FjaGVTdGF0aXN0aWNzO1xuICAgIHByaXZhdGUgY29uZmlnOiBRdWVyeUNhY2hlQ29uZmlnO1xuICAgIHByaXZhdGUgY2xlYW51cFRpbWVyPzogTm9kZUpTLlRpbWVvdXQ7XG5cbiAgICBjb25zdHJ1Y3Rvcihjb25maWc6IFBhcnRpYWw8UXVlcnlDYWNoZUNvbmZpZz4gPSB7fSkge1xuICAgICAgICB0aGlzLmNvbmZpZyA9IHsgLi4uREVGQVVMVF9DQUNIRV9DT05GSUcsIC4uLmNvbmZpZyB9O1xuICAgICAgICB0aGlzLmNhY2hlID0gbmV3IE1hcCgpO1xuICAgICAgICB0aGlzLnN0YXRzID0ge1xuICAgICAgICAgICAgaGl0czogMCxcbiAgICAgICAgICAgIG1pc3NlczogMCxcbiAgICAgICAgICAgIGV2aWN0aW9uczogMCxcbiAgICAgICAgICAgIHRvdGFsUXVlcmllczogMCxcbiAgICAgICAgICAgIGhpdFJhdGU6IDAsXG4gICAgICAgICAgICBzaXplOiAwLFxuICAgICAgICAgICAgbWF4U2l6ZTogdGhpcy5jb25maWcubWF4U2l6ZVxuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMuc3RhcnRDbGVhbnVwVGltZXIoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgY2FjaGVkIHJlc3VsdCBmb3IgYSBxdWVyeVxuICAgICAqL1xuICAgIGdldDxUPihxdWVyeUtleTogc3RyaW5nKTogVCB8IG51bGwge1xuICAgICAgICBpZiAoIXRoaXMuY29uZmlnLmVuYWJsZWQpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdHMubWlzc2VzKys7XG4gICAgICAgICAgICB0aGlzLnN0YXRzLnRvdGFsUXVlcmllcysrO1xuICAgICAgICAgICAgdGhpcy51cGRhdGVIaXRSYXRlKCk7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGVudHJ5ID0gdGhpcy5jYWNoZS5nZXQocXVlcnlLZXkpO1xuICAgICAgICB0aGlzLnN0YXRzLnRvdGFsUXVlcmllcysrO1xuXG4gICAgICAgIGlmICghZW50cnkpIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdHMubWlzc2VzKys7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUhpdFJhdGUoKTtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ2hlY2sgaWYgZW50cnkgaGFzIGV4cGlyZWRcbiAgICAgICAgaWYgKERhdGUubm93KCkgPiBlbnRyeS5leHBpcmVzQXQpIHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGUuZGVsZXRlKHF1ZXJ5S2V5KTtcbiAgICAgICAgICAgIHRoaXMuc3RhdHMubWlzc2VzKys7XG4gICAgICAgICAgICB0aGlzLnN0YXRzLmV2aWN0aW9ucysrO1xuICAgICAgICAgICAgdGhpcy51cGRhdGVTdGF0cygpO1xuICAgICAgICAgICAgdGhpcy51cGRhdGVIaXRSYXRlKCk7XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc3RhdHMuaGl0cysrO1xuICAgICAgICB0aGlzLnVwZGF0ZUhpdFJhdGUoKTtcbiAgICAgICAgcmV0dXJuIGVudHJ5LnZhbHVlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNldCBjYWNoZWQgcmVzdWx0IGZvciBhIHF1ZXJ5XG4gICAgICovXG4gICAgc2V0PFQ+KHF1ZXJ5S2V5OiBzdHJpbmcsIHZhbHVlOiBULCB0dGw/OiBudW1iZXIpOiB2b2lkIHtcbiAgICAgICAgaWYgKCF0aGlzLmNvbmZpZy5lbmFibGVkKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCByZXF1ZXN0ZWRUVEwgPSB0dGwgIT09IHVuZGVmaW5lZCA/IHR0bCA6IHRoaXMuY29uZmlnLmRlZmF1bHRUVEw7XG4gICAgICAgIGNvbnN0IGVmZmVjdGl2ZVRUTCA9IE1hdGgubWluKE1hdGgubWF4KHJlcXVlc3RlZFRUTCwgMCksIHRoaXMuY29uZmlnLm1heFRUTCk7XG5cbiAgICAgICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICAgICAgXG4gICAgICAgIC8vIERvbid0IGNhY2hlIGlmIFRUTCBpcyB6ZXJvIG9yIG5lZ2F0aXZlXG4gICAgICAgIGlmIChlZmZlY3RpdmVUVEwgPD0gMCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyBFdmljdCBvbGRlc3QgZW50cmllcyBpZiBjYWNoZSBpcyBmdWxsXG4gICAgICAgIHdoaWxlICh0aGlzLmNhY2hlLnNpemUgPj0gdGhpcy5jb25maWcubWF4U2l6ZSkge1xuICAgICAgICAgICAgdGhpcy5ldmljdE9sZGVzdCgpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBjb25zdCBlbnRyeTogQ2FjaGVFbnRyeTxUPiA9IHtcbiAgICAgICAgICAgIHZhbHVlLFxuICAgICAgICAgICAgdGltZXN0YW1wOiBub3csXG4gICAgICAgICAgICBleHBpcmVzQXQ6IG5vdyArIGVmZmVjdGl2ZVRUTCxcbiAgICAgICAgICAgIHF1ZXJ5SGFzaDogdGhpcy5oYXNoUXVlcnkocXVlcnlLZXkpXG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5jYWNoZS5zZXQocXVlcnlLZXksIGVudHJ5KTtcbiAgICAgICAgdGhpcy51cGRhdGVTdGF0cygpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIE5vcm1hbGl6ZSBhbmQgY3JlYXRlIGNhY2hlIGtleSBmcm9tIFNQQVJRTCBxdWVyeVxuICAgICAqL1xuICAgIGNyZWF0ZUNhY2hlS2V5KHF1ZXJ5OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICAvLyBGaXJzdCBzcGxpdCBvbiB0aGUgY29sb24gdG8gaGFuZGxlIHByZWZpeCBzZXBhcmF0ZWx5IGlmIGl0IGV4aXN0c1xuICAgICAgICBjb25zdCBjb2xvbkluZGV4ID0gcXVlcnkuaW5kZXhPZignOicpO1xuICAgICAgICBsZXQgcHJlZml4ID0gJyc7XG4gICAgICAgIGxldCBxdWVyeVBhcnQgPSBxdWVyeTtcbiAgICAgICAgXG4gICAgICAgIGlmIChjb2xvbkluZGV4ID4gMCAmJiBjb2xvbkluZGV4IDwgMjApIHsgLy8gQXNzdW1lIHByZWZpeCBpcyBzaG9ydFxuICAgICAgICAgICAgcHJlZml4ID0gcXVlcnkuc3Vic3RyaW5nKDAsIGNvbG9uSW5kZXgpLnRvTG93ZXJDYXNlKCkgKyAnOic7XG4gICAgICAgICAgICBxdWVyeVBhcnQgPSBxdWVyeS5zdWJzdHJpbmcoY29sb25JbmRleCArIDEpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyBOb3JtYWxpemUgdGhlIHF1ZXJ5IGJ5IHJlbW92aW5nIGV4dHJhIHdoaXRlc3BhY2UgYW5kIGNvbnZlcnRpbmcgdG8gbG93ZXJjYXNlXG4gICAgICAgIGNvbnN0IG5vcm1hbGl6ZWQgPSBxdWVyeVBhcnRcbiAgICAgICAgICAgIC50cmltKCkgICAgICAgICAgICAgICAgICAgICAgICAgLy8gUmVtb3ZlIGxlYWRpbmcvdHJhaWxpbmcgd2hpdGVzcGFjZSBmaXJzdFxuICAgICAgICAgICAgLnJlcGxhY2UoL1tcXHJcXG5cXHRdKy9nLCAnICcpICAgIC8vIFJlcGxhY2UgbmV3bGluZXMgYW5kIHRhYnMgd2l0aCBzcGFjZXNcbiAgICAgICAgICAgIC5yZXBsYWNlKC9cXHMrL2csICcgJykgICAgICAgICAgIC8vIFJlcGxhY2UgbXVsdGlwbGUgc3BhY2VzIHdpdGggc2luZ2xlIHNwYWNlXG4gICAgICAgICAgICAucmVwbGFjZSgvXFxzKlxce1xccyovZywgJyB7ICcpICAgIC8vIE5vcm1hbGl6ZSBzcGFjaW5nIGFyb3VuZCBjdXJseSBicmFjZXNcbiAgICAgICAgICAgIC5yZXBsYWNlKC9cXHMqXFx9XFxzKi9nLCAnIH0gJykgICAgXG4gICAgICAgICAgICAucmVwbGFjZSgvXFxzKlxcKFxccyovZywgJyAoICcpICAgIC8vIE5vcm1hbGl6ZSBzcGFjaW5nIGFyb3VuZCBwYXJlbnRoZXNlc1xuICAgICAgICAgICAgLnJlcGxhY2UoL1xccypcXClcXHMqL2csICcgKSAnKSAgICBcbiAgICAgICAgICAgIC5yZXBsYWNlKC9cXHMrL2csICcgJykgICAgICAgICAgIC8vIENsZWFuIHVwIHNwYWNlcyBhZ2FpblxuICAgICAgICAgICAgLnRyaW0oKSAgICAgICAgICAgICAgICAgICAgICAgICAvLyBUcmltIGFnYWluIGFmdGVyIHJlcGxhY2VtZW50c1xuICAgICAgICAgICAgLnRvTG93ZXJDYXNlKCk7ICAgICAgICAgICAgICAgICAvLyBDb252ZXJ0IHRvIGxvd2VyY2FzZSBmb3IgY2FzZS1pbnNlbnNpdGl2ZSBtYXRjaGluZ1xuXG4gICAgICAgIGNvbnN0IGZ1bGxLZXkgPSBwcmVmaXggKyBub3JtYWxpemVkO1xuICAgICAgICBcbiAgICAgICAgLy8gVXNlIHRoZSBub3JtYWxpemVkIHN0cmluZyBkaXJlY3RseSBhcyB0aGUga2V5IGZvciBiZXR0ZXIgY29uc2lzdGVuY3lcbiAgICAgICAgLy8gT25seSBoYXNoIHZlcnkgbG9uZyBxdWVyaWVzXG4gICAgICAgIGlmIChmdWxsS2V5Lmxlbmd0aCA+IDEwMDApIHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmhhc2hRdWVyeShmdWxsS2V5KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZnVsbEtleTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBJbnZhbGlkYXRlIGFsbCBjYWNoZWQgZW50cmllc1xuICAgICAqL1xuICAgIGludmFsaWRhdGVBbGwoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHNpemVCZWZvcmUgPSB0aGlzLmNhY2hlLnNpemU7XG4gICAgICAgIHRoaXMuY2FjaGUuY2xlYXIoKTtcbiAgICAgICAgdGhpcy5zdGF0cy5ldmljdGlvbnMgKz0gc2l6ZUJlZm9yZTtcbiAgICAgICAgdGhpcy51cGRhdGVTdGF0cygpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEludmFsaWRhdGUgZW50cmllcyBiYXNlZCBvbiBhIHByZWRpY2F0ZSBmdW5jdGlvblxuICAgICAqL1xuICAgIGludmFsaWRhdGVXaGVyZShwcmVkaWNhdGU6IChrZXk6IHN0cmluZywgZW50cnk6IENhY2hlRW50cnk8YW55PikgPT4gYm9vbGVhbik6IG51bWJlciB7XG4gICAgICAgIGxldCBpbnZhbGlkYXRlZCA9IDA7XG4gICAgICAgIFxuICAgICAgICBmb3IgKGNvbnN0IFtrZXksIGVudHJ5XSBvZiB0aGlzLmNhY2hlLmVudHJpZXMoKSkge1xuICAgICAgICAgICAgaWYgKHByZWRpY2F0ZShrZXksIGVudHJ5KSkge1xuICAgICAgICAgICAgICAgIHRoaXMuY2FjaGUuZGVsZXRlKGtleSk7XG4gICAgICAgICAgICAgICAgaW52YWxpZGF0ZWQrKztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuc3RhdHMuZXZpY3Rpb25zICs9IGludmFsaWRhdGVkO1xuICAgICAgICB0aGlzLnVwZGF0ZVN0YXRzKCk7XG4gICAgICAgIHJldHVybiBpbnZhbGlkYXRlZDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBHZXQgY3VycmVudCBjYWNoZSBzdGF0aXN0aWNzXG4gICAgICovXG4gICAgZ2V0U3RhdGlzdGljcygpOiBDYWNoZVN0YXRpc3RpY3Mge1xuICAgICAgICByZXR1cm4geyAuLi50aGlzLnN0YXRzIH07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlIGNhY2hlIGNvbmZpZ3VyYXRpb25cbiAgICAgKi9cbiAgICB1cGRhdGVDb25maWcobmV3Q29uZmlnOiBQYXJ0aWFsPFF1ZXJ5Q2FjaGVDb25maWc+KTogdm9pZCB7XG4gICAgICAgIHRoaXMuY29uZmlnID0geyAuLi50aGlzLmNvbmZpZywgLi4ubmV3Q29uZmlnIH07XG4gICAgICAgIHRoaXMuc3RhdHMubWF4U2l6ZSA9IHRoaXMuY29uZmlnLm1heFNpemU7XG5cbiAgICAgICAgLy8gSWYgY2FjaGUgaXMgZGlzYWJsZWQsIGNsZWFyIGl0XG4gICAgICAgIGlmICghdGhpcy5jb25maWcuZW5hYmxlZCkge1xuICAgICAgICAgICAgdGhpcy5pbnZhbGlkYXRlQWxsKCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBJZiBtYXggc2l6ZSByZWR1Y2VkLCBldmljdCBlbnRyaWVzXG4gICAgICAgIHdoaWxlICh0aGlzLmNhY2hlLnNpemUgPiB0aGlzLmNvbmZpZy5tYXhTaXplKSB7XG4gICAgICAgICAgICB0aGlzLmV2aWN0T2xkZXN0KCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy51cGRhdGVTdGF0cygpO1xuXG4gICAgICAgIC8vIFJlc3RhcnQgY2xlYW51cCB0aW1lciBpZiBpbnRlcnZhbCBjaGFuZ2VkXG4gICAgICAgIGlmIChuZXdDb25maWcuY2xlYW51cEludGVydmFsICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgIHRoaXMuc3RvcENsZWFudXBUaW1lcigpO1xuICAgICAgICAgICAgdGhpcy5zdGFydENsZWFudXBUaW1lcigpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2V0IGN1cnJlbnQgY29uZmlndXJhdGlvblxuICAgICAqL1xuICAgIGdldENvbmZpZygpOiBRdWVyeUNhY2hlQ29uZmlnIHtcbiAgICAgICAgcmV0dXJuIHsgLi4udGhpcy5jb25maWcgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBNYW51YWxseSB0cmlnZ2VyIGNsZWFudXAgb2YgZXhwaXJlZCBlbnRyaWVzXG4gICAgICovXG4gICAgY2xlYW51cCgpOiBudW1iZXIge1xuICAgICAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgICAgICBsZXQgY2xlYW5lZCA9IDA7XG5cbiAgICAgICAgZm9yIChjb25zdCBba2V5LCBlbnRyeV0gb2YgdGhpcy5jYWNoZS5lbnRyaWVzKCkpIHtcbiAgICAgICAgICAgIGlmIChub3cgPiBlbnRyeS5leHBpcmVzQXQpIHtcbiAgICAgICAgICAgICAgICB0aGlzLmNhY2hlLmRlbGV0ZShrZXkpO1xuICAgICAgICAgICAgICAgIGNsZWFuZWQrKztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjbGVhbmVkID4gMCkge1xuICAgICAgICAgICAgdGhpcy5zdGF0cy5ldmljdGlvbnMgKz0gY2xlYW5lZDtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlU3RhdHMoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBjbGVhbmVkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENoZWNrIGlmIGEgcXVlcnkgcmVzdWx0IGlzIGNhY2hlZFxuICAgICAqL1xuICAgIGhhcyhxdWVyeUtleTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIGlmICghdGhpcy5jb25maWcuZW5hYmxlZCkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZW50cnkgPSB0aGlzLmNhY2hlLmdldChxdWVyeUtleSk7XG4gICAgICAgIGlmICghZW50cnkpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIENoZWNrIGlmIGV4cGlyZWRcbiAgICAgICAgaWYgKERhdGUubm93KCkgPiBlbnRyeS5leHBpcmVzQXQpIHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGUuZGVsZXRlKHF1ZXJ5S2V5KTtcbiAgICAgICAgICAgIHRoaXMuc3RhdHMuZXZpY3Rpb25zKys7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVN0YXRzKCk7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBEZXN0cm95IHRoZSBjYWNoZSBhbmQgY2xlYW51cCByZXNvdXJjZXNcbiAgICAgKi9cbiAgICBkZXN0cm95KCk6IHZvaWQge1xuICAgICAgICB0aGlzLnN0b3BDbGVhbnVwVGltZXIoKTtcbiAgICAgICAgdGhpcy5jYWNoZS5jbGVhcigpO1xuICAgIH1cblxuICAgIC8vIFByaXZhdGUgbWV0aG9kc1xuXG4gICAgcHJpdmF0ZSBoYXNoUXVlcnkocXVlcnk6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIC8vIFNpbXBsZSBoYXNoIGZ1bmN0aW9uIGZvciBxdWVyeSBzdHJpbmdzXG4gICAgICAgIGxldCBoYXNoID0gMDtcbiAgICAgICAgaWYgKHF1ZXJ5Lmxlbmd0aCA9PT0gMCkgcmV0dXJuIGhhc2gudG9TdHJpbmcoKTtcbiAgICAgICAgXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcXVlcnkubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIGNvbnN0IGNoYXIgPSBxdWVyeS5jaGFyQ29kZUF0KGkpO1xuICAgICAgICAgICAgaGFzaCA9ICgoaGFzaCA8PCA1KSAtIGhhc2gpICsgY2hhcjtcbiAgICAgICAgICAgIGhhc2ggPSBoYXNoICYgaGFzaDsgLy8gQ29udmVydCB0byAzMi1iaXQgaW50ZWdlclxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gTWF0aC5hYnMoaGFzaCkudG9TdHJpbmcoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGV2aWN0T2xkZXN0KCk6IHZvaWQge1xuICAgICAgICBsZXQgb2xkZXN0S2V5OiBzdHJpbmcgfCBudWxsID0gbnVsbDtcbiAgICAgICAgbGV0IG9sZGVzdFRpbWVzdGFtcCA9IEluZmluaXR5O1xuXG4gICAgICAgIGZvciAoY29uc3QgW2tleSwgZW50cnldIG9mIHRoaXMuY2FjaGUuZW50cmllcygpKSB7XG4gICAgICAgICAgICBpZiAoZW50cnkudGltZXN0YW1wIDwgb2xkZXN0VGltZXN0YW1wKSB7XG4gICAgICAgICAgICAgICAgb2xkZXN0VGltZXN0YW1wID0gZW50cnkudGltZXN0YW1wO1xuICAgICAgICAgICAgICAgIG9sZGVzdEtleSA9IGtleTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChvbGRlc3RLZXkpIHtcbiAgICAgICAgICAgIHRoaXMuY2FjaGUuZGVsZXRlKG9sZGVzdEtleSk7XG4gICAgICAgICAgICB0aGlzLnN0YXRzLmV2aWN0aW9ucysrO1xuICAgICAgICAgICAgdGhpcy51cGRhdGVTdGF0cygpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB1cGRhdGVTdGF0cygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5zdGF0cy5zaXplID0gdGhpcy5jYWNoZS5zaXplO1xuICAgIH1cblxuICAgIHByaXZhdGUgdXBkYXRlSGl0UmF0ZSgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5zdGF0cy5oaXRSYXRlID0gdGhpcy5zdGF0cy50b3RhbFF1ZXJpZXMgPiAwIFxuICAgICAgICAgICAgPyAodGhpcy5zdGF0cy5oaXRzIC8gdGhpcy5zdGF0cy50b3RhbFF1ZXJpZXMpICogMTAwIFxuICAgICAgICAgICAgOiAwO1xuICAgIH1cblxuICAgIHByaXZhdGUgc3RhcnRDbGVhbnVwVGltZXIoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmNvbmZpZy5jbGVhbnVwSW50ZXJ2YWwgPiAwKSB7XG4gICAgICAgICAgICB0aGlzLmNsZWFudXBUaW1lciA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmNsZWFudXAoKTtcbiAgICAgICAgICAgIH0sIHRoaXMuY29uZmlnLmNsZWFudXBJbnRlcnZhbCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHN0b3BDbGVhbnVwVGltZXIoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLmNsZWFudXBUaW1lcikge1xuICAgICAgICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLmNsZWFudXBUaW1lcik7XG4gICAgICAgICAgICB0aGlzLmNsZWFudXBUaW1lciA9IHVuZGVmaW5lZDtcbiAgICAgICAgfVxuICAgIH1cbn0iXSwidmVyc2lvbiI6M30=