ad00731f24040d581501622c6e3bcb47
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TemplateParameterModal = void 0;
const obsidian_1 = require("obsidian");
class TemplateParameterModal extends obsidian_1.Modal {
    constructor(app, template, options) {
        super(app);
        this.options = options;
        this.parameterInputs = new Map();
        this.validationErrors = new Map();
        this.template = template;
    }
    onOpen() {
        const { contentEl } = this;
        contentEl.empty();
        this.createHeader();
        this.createParameterForm();
        this.createButtons();
        this.setupKeyboardHandlers();
        // Focus first input
        const firstInput = Array.from(this.parameterInputs.values())[0];
        if (firstInput) {
            setTimeout(() => firstInput.focus(), 100);
        }
    }
    onClose() {
        this.parameterInputs.clear();
        this.validationErrors.clear();
    }
    createHeader() {
        const header = this.contentEl.createDiv('template-parameter-header');
        header.style.cssText = `
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--background-modifier-border);
        `;
        const title = header.createEl('h2');
        title.textContent = 'Configure Template Parameters';
        title.style.cssText = `
            margin: 0 0 8px 0;
            color: var(--text-normal);
            font-size: 20px;
            font-weight: 600;
        `;
        const templateName = header.createDiv('template-name');
        templateName.textContent = this.template.getMetadata().name;
        templateName.style.cssText = `
            color: var(--text-accent);
            font-weight: 500;
            margin-bottom: 8px;
        `;
        const description = header.createDiv('template-description');
        description.textContent = this.template.getMetadata().description;
        description.style.cssText = `
            color: var(--text-muted);
            line-height: 1.5;
            margin-bottom: 16px;
        `;
        if (this.template.getMetadata().exampleUsage) {
            const example = header.createDiv('template-example');
            example.innerHTML = `
                <strong style="color: var(--text-normal);">Example:</strong>
                <em style="color: var(--text-muted);">${this.template.getMetadata().exampleUsage}</em>
            `;
        }
    }
    createParameterForm() {
        const parameters = this.template.getParameters();
        if (parameters.length === 0) {
            const noParams = this.contentEl.createDiv('no-parameters');
            noParams.textContent = 'This template has no parameters to configure.';
            noParams.style.cssText = `
                text-align: center;
                color: var(--text-muted);
                font-style: italic;
                padding: 20px;
            `;
            return;
        }
        const form = this.contentEl.createDiv('parameter-form');
        form.style.cssText = `
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-bottom: 24px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 8px;
        `;
        parameters.forEach(parameter => {
            this.createParameterInput(form, parameter);
        });
    }
    createParameterInput(container, parameter) {
        const paramContainer = container.createDiv('parameter-container');
        paramContainer.style.cssText = `
            padding: 16px;
            border: 1px solid var(--background-modifier-border);
            border-radius: var(--radius-s);
            background: var(--background-secondary);
        `;
        // Parameter header
        const header = paramContainer.createDiv('parameter-header');
        header.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        `;
        const nameContainer = header.createDiv();
        const name = nameContainer.createEl('label');
        name.textContent = parameter.name;
        name.style.cssText = `
            color: var(--text-normal);
            font-weight: 500;
            font-size: 14px;
            display: block;
        `;
        if (parameter.required) {
            const required = nameContainer.createSpan();
            required.textContent = ' *';
            required.style.cssText = 'color: var(--text-error);';
        }
        const badges = header.createDiv();
        badges.style.cssText = 'display: flex; gap: 4px; align-items: center;';
        const typeBadge = badges.createSpan();
        typeBadge.textContent = parameter.type;
        typeBadge.style.cssText = `
            font-size: 10px;
            padding: 2px 6px;
            background: var(--background-primary);
            color: var(--text-muted);
            border-radius: 4px;
            border: 1px solid var(--background-modifier-border);
        `;
        // Description
        if (parameter.description) {
            const description = paramContainer.createDiv();
            description.textContent = parameter.description;
            description.style.cssText = `
                color: var(--text-muted);
                font-size: 12px;
                line-height: 1.4;
                margin-bottom: 8px;
            `;
        }
        // Input field
        const input = this.createInputElement(parameter);
        input.style.cssText = `
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--background-modifier-border);
            border-radius: var(--radius-s);
            background: var(--background-primary);
            color: var(--text-normal);
            font-size: 14px;
            font-family: ${parameter.type === 'literal' ? 'var(--font-monospace)' : 'inherit'};
        `;
        // Set default value
        if (parameter.defaultValue) {
            input.value = parameter.defaultValue;
        }
        // Validation
        const errorContainer = paramContainer.createDiv('parameter-error');
        errorContainer.style.cssText = `
            color: var(--text-error);
            font-size: 12px;
            margin-top: 4px;
            min-height: 16px;
        `;
        // Event handlers
        input.addEventListener('input', () => this.validateParameter(parameter, input, errorContainer));
        input.addEventListener('blur', () => this.validateParameter(parameter, input, errorContainer));
        paramContainer.appendChild(input);
        this.parameterInputs.set(parameter.id || `param_${parameter.name}`, input);
        // Constraints help text
        if (parameter.constraints) {
            this.createConstraintsHelp(paramContainer, parameter.constraints);
        }
    }
    createInputElement(parameter) {
        var _a, _b;
        if ((_a = parameter.constraints) === null || _a === void 0 ? void 0 : _a.allowedValues) {
            const select = document.createElement('select');
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = 'Select...';
            select.appendChild(emptyOption);
            parameter.constraints.allowedValues.forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;
                select.appendChild(option);
            });
            return select;
        }
        if (parameter.type === 'literal' && (!((_b = parameter.constraints) === null || _b === void 0 ? void 0 : _b.maxLength) || parameter.constraints.maxLength > 100)) {
            const textarea = document.createElement('textarea');
            textarea.rows = 3;
            return textarea;
        }
        const input = document.createElement('input');
        input.type = 'text';
        if (parameter.type === 'entity' || parameter.type === 'property') {
            input.placeholder = parameter.type === 'entity' ? 'e.g., Person, ex:John, <http://example.org/Person>' : 'e.g., name, ex:hasAge, ?property';
        }
        return input;
    }
    createConstraintsHelp(container, constraints) {
        const hints = [];
        if (constraints === null || constraints === void 0 ? void 0 : constraints.pattern) {
            hints.push(`Pattern: ${constraints.pattern}`);
        }
        if (constraints === null || constraints === void 0 ? void 0 : constraints.minLength) {
            hints.push(`Min length: ${constraints.minLength}`);
        }
        if (constraints === null || constraints === void 0 ? void 0 : constraints.maxLength) {
            hints.push(`Max length: ${constraints.maxLength}`);
        }
        if (hints.length > 0) {
            const help = container.createDiv('parameter-help');
            help.textContent = hints.join(' â€¢ ');
            help.style.cssText = `
                color: var(--text-muted);
                font-size: 11px;
                margin-top: 4px;
                font-style: italic;
            `;
        }
    }
    validateParameter(parameter, input, errorContainer) {
        const value = input.value.trim();
        errorContainer.textContent = '';
        this.validationErrors.delete(parameter.id || `param_${parameter.name}`);
        // Required check
        if (parameter.required && !value) {
            const error = `${parameter.name} is required`;
            errorContainer.textContent = error;
            this.validationErrors.set(parameter.id || `param_${parameter.name}`, error);
            input.style.borderColor = 'var(--text-error)';
            return false;
        }
        // Skip other validations if empty and not required
        if (!value && !parameter.required) {
            input.style.borderColor = 'var(--background-modifier-border)';
            return true;
        }
        // Constraints validation
        if (parameter.constraints) {
            const constraints = parameter.constraints;
            if (constraints.pattern && !new RegExp(constraints.pattern).test(value)) {
                const error = 'Value does not match required pattern';
                errorContainer.textContent = error;
                this.validationErrors.set(parameter.id || `param_${parameter.name}`, error);
                input.style.borderColor = 'var(--text-error)';
                return false;
            }
            if (constraints.minLength && value.length < constraints.minLength) {
                const error = `Minimum length is ${constraints.minLength}`;
                errorContainer.textContent = error;
                this.validationErrors.set(parameter.id || `param_${parameter.name}`, error);
                input.style.borderColor = 'var(--text-error)';
                return false;
            }
            if (constraints.maxLength && value.length > constraints.maxLength) {
                const error = `Maximum length is ${constraints.maxLength}`;
                errorContainer.textContent = error;
                this.validationErrors.set(parameter.id || `param_${parameter.name}`, error);
                input.style.borderColor = 'var(--text-error)';
                return false;
            }
            if (constraints.allowedValues && !constraints.allowedValues.includes(value)) {
                const error = 'Value must be one of the allowed options';
                errorContainer.textContent = error;
                this.validationErrors.set(parameter.id || `param_${parameter.name}`, error);
                input.style.borderColor = 'var(--text-error)';
                return false;
            }
        }
        input.style.borderColor = 'var(--background-modifier-border)';
        return true;
    }
    validateAllParameters() {
        var _a;
        let allValid = true;
        for (const [parameterId, input] of this.parameterInputs) {
            const parameter = this.template.getParameter(parameterId);
            if (!parameter)
                continue;
            const errorContainer = (_a = input.parentElement) === null || _a === void 0 ? void 0 : _a.querySelector('.parameter-error');
            if (!this.validateParameter(parameter, input, errorContainer)) {
                allValid = false;
            }
        }
        return allValid;
    }
    createButtons() {
        const buttonContainer = this.contentEl.createDiv('modal-button-container');
        buttonContainer.style.cssText = `
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--background-modifier-border);
        `;
        const cancelButton = buttonContainer.createEl('button');
        cancelButton.textContent = 'Cancel';
        cancelButton.addEventListener('click', () => {
            var _a, _b;
            (_b = (_a = this.options).onCancel) === null || _b === void 0 ? void 0 : _b.call(_a);
            this.close();
        });
        const submitButton = buttonContainer.createEl('button');
        submitButton.textContent = 'Apply Template';
        submitButton.className = 'mod-cta';
        submitButton.addEventListener('click', () => this.handleSubmit());
    }
    handleSubmit() {
        if (!this.validateAllParameters()) {
            return;
        }
        const parameterValues = new Map();
        for (const [parameterId, input] of this.parameterInputs) {
            const value = input.value.trim();
            if (value) {
                parameterValues.set(parameterId, value);
            }
        }
        // Set parameter values on template
        for (const [parameterId, value] of parameterValues) {
            try {
                this.template.setParameterValue(parameterId, value);
            }
            catch (error) {
                console.error(`Failed to set parameter ${parameterId}:`, error);
                return;
            }
        }
        this.options.onSubmit(this.template, parameterValues);
        this.close();
    }
    setupKeyboardHandlers() {
        this.contentEl.addEventListener('keydown', (e) => {
            var _a, _b;
            if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                this.handleSubmit();
            }
            if (e.key === 'Escape') {
                e.preventDefault();
                (_b = (_a = this.options).onCancel) === null || _b === void 0 ? void 0 : _b.call(_a);
                this.close();
            }
        });
    }
}
exports.TemplateParameterModal = TemplateParameterModal;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL3ByZXNlbnRhdGlvbi9tb2RhbHMvVGVtcGxhdGVQYXJhbWV0ZXJNb2RhbC50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSx1Q0FBK0M7QUFRL0MsTUFBYSxzQkFBdUIsU0FBUSxnQkFBSztJQUs3QyxZQUNJLEdBQVEsRUFDUixRQUF1QixFQUNmLE9BQXNDO1FBRTlDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUZILFlBQU8sR0FBUCxPQUFPLENBQStCO1FBTjFDLG9CQUFlLEdBQTRFLElBQUksR0FBRyxFQUFFLENBQUM7UUFDckcscUJBQWdCLEdBQXdCLElBQUksR0FBRyxFQUFFLENBQUM7UUFRdEQsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7SUFDN0IsQ0FBQztJQUVELE1BQU07UUFDRixNQUFNLEVBQUUsU0FBUyxFQUFFLEdBQUcsSUFBSSxDQUFDO1FBQzNCLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUVsQixJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDcEIsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBRTdCLG9CQUFvQjtRQUNwQixNQUFNLFVBQVUsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNoRSxJQUFJLFVBQVUsRUFBRTtZQUNaLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLEVBQUUsR0FBRyxDQUFDLENBQUM7U0FDN0M7SUFDTCxDQUFDO0lBRUQsT0FBTztRQUNILElBQUksQ0FBQyxlQUFlLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDN0IsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssRUFBRSxD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QUFFLGVBQWUsQ0FBQyxDQUFDO1FBQ3RELElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNqQixDQUFDO0lBRU8scUJBQXFCO1FBQ3pCLElBQUksQ0FBQyxTQUFTLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBZ0IsRUFBRSxFQUFFOztZQUM1RCxJQUFJLENBQUMsQ0FBQyxHQUFHLEtBQUssT0FBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUU7Z0JBQy9DLENBQUMsQ0FBQyxjQUFjLEVBQUUsQ0FBQztnQkFDbkIsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO2FBQ3ZCO1lBRUQsSUFBSSxDQUFDLENBQUMsR0FBRyxLQUFLLFFBQVEsRUFBRTtnQkFDcEIsQ0FBQyxDQUFDLGNBQWMsRUFBRSxDQUFDO2dCQUNuQixNQUFBLE1BQUEsSUFBSSxDQUFDLE9BQU8sRUFBQyxRQUFRLGtEQUFJLENBQUM7Z0JBQzFCLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQzthQUNoQjtRQUNMLENBQUMsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztDQUNKO0FBamFELHdEQWlhQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva2l0ZWxldi9Eb2N1bWVudHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi9zcmMvcHJlc2VudGF0aW9uL21vZGFscy9UZW1wbGF0ZVBhcmFtZXRlck1vZGFsLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE1vZGFsLCBBcHAsIFNldHRpbmcgfSBmcm9tICdvYnNpZGlhbic7XG5pbXBvcnQgeyBRdWVyeVRlbXBsYXRlLCBUZW1wbGF0ZVBhcmFtZXRlciB9IGZyb20gJy4uLy4uL2RvbWFpbi92aXN1YWwvUXVlcnlUZW1wbGF0ZSc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgVGVtcGxhdGVQYXJhbWV0ZXJNb2RhbE9wdGlvbnMge1xuICAgIG9uU3VibWl0OiAodGVtcGxhdGU6IFF1ZXJ5VGVtcGxhdGUsIHBhcmFtZXRlclZhbHVlczogTWFwPHN0cmluZywgc3RyaW5nPikgPT4gdm9pZDtcbiAgICBvbkNhbmNlbD86ICgpID0+IHZvaWQ7XG59XG5cbmV4cG9ydCBjbGFzcyBUZW1wbGF0ZVBhcmFtZXRlck1vZGFsIGV4dGVuZHMgTW9kYWwge1xuICAgIHByaXZhdGUgdGVtcGxhdGU6IFF1ZXJ5VGVtcGxhdGU7XG4gICAgcHJpdmF0ZSBwYXJhbWV0ZXJJbnB1dHM6IE1hcDxzdHJpbmcsIEhUTUxJbnB1dEVsZW1lbnQgfCBIVE1MVGV4dEFyZWFFbGVtZW50IHwgSFRNTFNlbGVjdEVsZW1lbnQ+ID0gbmV3IE1hcCgpO1xuICAgIHByaXZhdGUgdmFsaWRhdGlvbkVycm9yczogTWFwPHN0cmluZywgc3RyaW5nPiA9IG5ldyBNYXAoKTtcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBhcHA6IEFwcCxcbiAgICAgICAgdGVtcGxhdGU6IFF1ZXJ5VGVtcGxhdGUsXG4gICAgICAgIHByaXZhdGUgb3B0aW9uczogVGVtcGxhdGVQYXJhbWV0ZXJNb2RhbE9wdGlvbnNcbiAgICApIHtcbiAgICAgICAgc3VwZXIoYXBwKTtcbiAgICAgICAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlO1xuICAgIH1cblxuICAgIG9uT3BlbigpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgeyBjb250ZW50RWwgfSA9IHRoaXM7XG4gICAgICAgIGNvbnRlbnRFbC5lbXB0eSgpO1xuXG4gICAgICAgIHRoaXMuY3JlYXRlSGVhZGVyKCk7XG4gICAgICAgIHRoaXMuY3JlYXRlUGFyYW1ldGVyRm9ybSgpO1xuICAgICAgICB0aGlzLmNyZWF0ZUJ1dHRvbnMoKTtcbiAgICAgICAgdGhpcy5zZXR1cEtleWJvYXJkSGFuZGxlcnMoKTtcbiAgICAgICAgXG4gICAgICAgIC8vIEZvY3VzIGZpcnN0IGlucHV0XG4gICAgICAgIGNvbnN0IGZpcnN0SW5wdXQgPSBBcnJheS5mcm9tKHRoaXMucGFyYW1ldGVySW5wdXRzLnZhbHVlcygpKVswXTtcbiAgICAgICAgaWYgKGZpcnN0SW5wdXQpIHtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gZmlyc3RJbnB1dC5mb2N1cygpLCAxMDApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgb25DbG9zZSgpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5wYXJhbWV0ZXJJbnB1dHMuY2xlYXIoKTtcbiAgICAgICAgdGhpcy52YWxpZGF0aW9uRXJyb3JzLmNsZWFyKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVIZWFkZXIoKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IGhlYWRlciA9IHRoaXMuY29udGVudEVsLmNyZWF0ZURpdigndGVtcGxhdGUtcGFyYW1ldGVyLWhlYWRlcicpO1xuICAgICAgICBoZWFkZXIuc3R5bGUuY3NzVGV4dCA9IGBcbiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDI0cHg7XG4gICAgICAgICAgICBwYWRkaW5nLWJvdHRvbTogMTZweDtcbiAgICAgICAgICAgIGJvcmRlci1ib3R0b206IDFweCBzb2xpZCB2YXIoLS1iYWNrZ3JvdW5kLW1vZGlmaWVyLWJvcmRlcik7XG4gICAgICAgIGA7XG5cbiAgICAgICAgY29uc3QgdGl0bGUgPSBoZWFkZXIuY3JlYXRlRWwoJ2gyJyk7XG4gICAgICAgIHRpdGxlLnRleHRDb250ZW50ID0gJ0NvbmZpZ3VyZSBUZW1wbGF0ZSBQYXJhbWV0ZXJzJztcbiAgICAgICAgdGl0bGUuc3R5bGUuY3NzVGV4dCA9IGBcbiAgICAgICAgICAgIG1hcmdpbjogMCAwIDhweCAwO1xuICAgICAgICAgICAgY29sb3I6IHZhcigtLXRleHQtbm9ybWFsKTtcbiAgICAgICAgICAgIGZvbnQtc2l6ZTogMjBweDtcbiAgICAgICAgICAgIGZvbnQtd2VpZ2h0OiA2MDA7XG4gICAgICAgIGA7XG5cbiAgICAgICAgY29uc3QgdGVtcGxhdGVOYW1lID0gaGVhZGVyLmNyZWF0ZURpdigndGVtcGxhdGUtbmFtZScpO1xuICAgICAgICB0ZW1wbGF0ZU5hbWUudGV4dENvbnRlbnQgPSB0aGlzLnRlbXBsYXRlLmdldE1ldGFkYXRhKCkubmFtZTtcbiAgICAgICAgdGVtcGxhdGVOYW1lLnN0eWxlLmNzc1RleHQgPSBgXG4gICAgICAgICAgICBjb2xvcjogdmFyKC0tdGV4dC1hY2NlbnQpO1xuICAgICAgICAgICAgZm9udC13ZWlnaHQ6IDUwMDtcbiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDhweDtcbiAgICAgICAgYDtcblxuICAgICAgICBjb25zdCBkZXNjcmlwdGlvbiA9IGhlYWRlci5jcmVhdGVEaXYoJ3RlbXBsYXRlLWRlc2NyaXB0aW9uJyk7XG4gICAgICAgIGRlc2NyaXB0aW9uLnRleHRDb250ZW50ID0gdGhpcy50ZW1wbGF0ZS5nZXRNZXRhZGF0YSgpLmRlc2NyaXB0aW9uO1xuICAgICAgICBkZXNjcmlwdGlvbi5zdHlsZS5jc3NUZXh0ID0gYFxuICAgICAgICAgICAgY29sb3I6IHZhcigtLXRleHQtbXV0ZWQpO1xuICAgICAgICAgICAgbGluZS1oZWlnaHQ6IDEuNTtcbiAgICAgICAgICAgIG1hcmdpbi1ib3R0b206IDE2cHg7XG4gICAgICAgIGA7XG5cbiAgICAgICAgaWYgKHRoaXMudGVtcGxhdGUuZ2V0TWV0YWRhdGEoKS5leGFtcGxlVXNhZ2UpIHtcbiAgICAgICAgICAgIGNvbnN0IGV4YW1wbGUgPSBoZWFkZXIuY3JlYXRlRGl2KCd0ZW1wbGF0ZS1leGFtcGxlJyk7XG4gICAgICAgICAgICBleGFtcGxlLmlubmVySFRNTCA9IGBcbiAgICAgICAgICAgICAgICA8c3Ryb25nIHN0eWxlPVwiY29sb3I6IHZhcigtLXRleHQtbm9ybWFsKTtcIj5FeGFtcGxlOjwvc3Ryb25nPlxuICAgICAgICAgICAgICAgIDxlbSBzdHlsZT1cImNvbG9yOiB2YXIoLS10ZXh0LW11dGVkKTtcIj4ke3RoaXMudGVtcGxhdGUuZ2V0TWV0YWRhdGEoKS5leGFtcGxlVXNhZ2V9PC9lbT5cbiAgICAgICAgICAgIGA7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZVBhcmFtZXRlckZvcm0oKTogdm9pZCB7XG4gICAgICAgIGNvbnN0IHBhcmFtZXRlcnMgPSB0aGlzLnRlbXBsYXRlLmdldFBhcmFtZXRlcnMoKTtcbiAgICAgICAgXG4gICAgICAgIGlmIChwYXJhbWV0ZXJzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgY29uc3Qgbm9QYXJhbXMgPSB0aGlzLmNvbnRlbnRFbC5jcmVhdGVEaXYoJ25vLXBhcmFtZXRlcnMnKTtcbiAgICAgICAgICAgIG5vUGFyYW1zLnRleHRDb250ZW50ID0gJ1RoaXMgdGVtcGxhdGUgaGFzIG5vIHBhcmFtZXRlcnMgdG8gY29uZmlndXJlLic7XG4gICAgICAgICAgICBub1BhcmFtcy5zdHlsZS5jc3NUZXh0ID0gYFxuICAgICAgICAgICAgICAgIHRleHQtYWxpZ246IGNlbnRlcjtcbiAgICAgICAgICAgICAgICBjb2xvcjogdmFyKC0tdGV4dC1tdXRlZCk7XG4gICAgICAgICAgICAgICAgZm9udC1zdHlsZTogaXRhbGljO1xuICAgICAgICAgICAgICAgIHBhZGRpbmc6IDIwcHg7XG4gICAgICAgICAgICBgO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZm9ybSA9IHRoaXMuY29udGVudEVsLmNyZWF0ZURpdigncGFyYW1ldGVyLWZvcm0nKTtcbiAgICAgICAgZm9ybS5zdHlsZS5jc3NUZXh0ID0gYFxuICAgICAgICAgICAgZGlzcGxheTogZmxleDtcbiAgICAgICAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47XG4gICAgICAgICAgICBnYXA6IDE2cHg7XG4gICAgICAgICAgICBtYXJnaW4tYm90dG9tOiAyNHB4O1xuICAgICAgICAgICAgbWF4LWhlaWdodDogNDAwcHg7XG4gICAgICAgICAgICBvdmVyZmxvdy15OiBhdXRvO1xuICAgICAgICAgICAgcGFkZGluZy1yaWdodDogOHB4O1xuICAgICAgICBgO1xuXG4gICAgICAgIHBhcmFtZXRlcnMuZm9yRWFjaChwYXJhbWV0ZXIgPT4ge1xuICAgICAgICAgICAgdGhpcy5jcmVhdGVQYXJhbWV0ZXJJbnB1dChmb3JtLCBwYXJhbWV0ZXIpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNyZWF0ZVBhcmFtZXRlcklucHV0KGNvbnRhaW5lcjogSFRNTEVsZW1lbnQsIHBhcmFtZXRlcjogVGVtcGxhdGVQYXJhbWV0ZXIpOiB2b2lkIHtcbiAgICAgICAgY29uc3QgcGFyYW1Db250YWluZXIgPSBjb250YWluZXIuY3JlYXRlRGl2KCdwYXJhbWV0ZXItY29udGFpbmVyJyk7XG4gICAgICAgIHBhcmFtQ29udGFpbmVyLnN0eWxlLmNzc1RleHQgPSBgXG4gICAgICAgICAgICBwYWRkaW5nOiAxNnB4O1xuICAgICAgICAgICAgYm9yZGVyOiAxcHggc29saWQgdmFyKC0tYmFja2dyb3VuZC1tb2RpZmllci1ib3JkZXIpO1xuICAgICAgICAgICAgYm9yZGVyLXJhZGl1czogdmFyKC0tcmFkaXVzLXMpO1xuICAgICAgICAgICAgYmFja2dyb3VuZDogdmFyKC0tYmFja2dyb3VuZC1zZWNvbmRhcnkpO1xuICAgICAgICBgO1xuXG4gICAgICAgIC8vIFBhcmFtZXRlciBoZWFkZXJcbiAgICAgICAgY29uc3QgaGVhZGVyID0gcGFyYW1Db250YWluZXIuY3JlYXRlRGl2KCdwYXJhbWV0ZXItaGVhZGVyJyk7XG4gICAgICAgIGhlYWRlci5zdHlsZS5jc3NUZXh0ID0gYFxuICAgICAgICAgICAgZGlzcGxheTogZmxleDtcbiAgICAgICAgICAgIGp1c3RpZnktY29udGVudDogc3BhY2UtYmV0d2VlbjtcbiAgICAgICAgICAgIGFsaWduLWl0ZW1zOiBmbGV4LXN0YXJ0O1xuICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogOHB4O1xuICAgICAgICBgO1xuXG4gICAgICAgIGNvbnN0IG5hbWVDb250YWluZXIgPSBoZWFkZXIuY3JlYXRlRGl2KCk7XG4gICAgICAgIGNvbnN0IG5hbWUgPSBuYW1lQ29udGFpbmVyLmNyZWF0ZUVsKCdsYWJlbCcpO1xuICAgICAgICBuYW1lLnRleHRDb250ZW50ID0gcGFyYW1ldGVyLm5hbWU7XG4gICAgICAgIG5hbWUuc3R5bGUuY3NzVGV4dCA9IGBcbiAgICAgICAgICAgIGNvbG9yOiB2YXIoLS10ZXh0LW5vcm1hbCk7XG4gICAgICAgICAgICBmb250LXdlaWdodDogNTAwO1xuICAgICAgICAgICAgZm9udC1zaXplOiAxNHB4O1xuICAgICAgICAgICAgZGlzcGxheTogYmxvY2s7XG4gICAgICAgIGA7XG5cbiAgICAgICAgaWYgKHBhcmFtZXRlci5yZXF1aXJlZCkge1xuICAgICAgICAgICAgY29uc3QgcmVxdWlyZWQgPSBuYW1lQ29udGFpbmVyLmNyZWF0ZVNwYW4oKTtcbiAgICAgICAgICAgIHJlcXVpcmVkLnRleHRDb250ZW50ID0gJyAqJztcbiAgICAgICAgICAgIHJlcXVpcmVkLnN0eWxlLmNzc1RleHQgPSAnY29sb3I6IHZhcigtLXRleHQtZXJyb3IpOyc7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBiYWRnZXMgPSBoZWFkZXIuY3JlYXRlRGl2KCk7XG4gICAgICAgIGJhZGdlcy5zdHlsZS5jc3NUZXh0ID0gJ2Rpc3BsYXk6IGZsZXg7IGdhcDogNHB4OyBhbGlnbi1pdGVtczogY2VudGVyOyc7XG5cbiAgICAgICAgY29uc3QgdHlwZUJhZGdlID0gYmFkZ2VzLmNyZWF0ZVNwYW4oKTtcbiAgICAgICAgdHlwZUJhZGdlLnRleHRDb250ZW50ID0gcGFyYW1ldGVyLnR5cGU7XG4gICAgICAgIHR5cGVCYWRnZS5zdHlsZS5jc3NUZXh0ID0gYFxuICAgICAgICAgICAgZm9udC1zaXplOiAxMHB4O1xuICAgICAgICAgICAgcGFkZGluZzogMnB4IDZweDtcbiAgICAgICAgICAgIGJhY2tncm91bmQ6IHZhcigtLWJhY2tncm91bmQtcHJpbWFyeSk7XG4gICAgICAgICAgICBjb2xvcjogdmFyKC0tdGV4dC1tdXRlZCk7XG4gICAgICAgICAgICBib3JkZXItcmFkaXVzOiA0cHg7XG4gICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1iYWNrZ3JvdW5kLW1vZGlmaWVyLWJvcmRlcik7XG4gICAgICAgIGA7XG5cbiAgICAgICAgLy8gRGVzY3JpcHRpb25cbiAgICAgICAgaWYgKHBhcmFtZXRlci5kZXNjcmlwdGlvbikge1xuICAgICAgICAgICAgY29uc3QgZGVzY3JpcHRpb24gPSBwYXJhbUNvbnRhaW5lci5jcmVhdGVEaXYoKTtcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uLnRleHRDb250ZW50ID0gcGFyYW1ldGVyLmRlc2NyaXB0aW9uO1xuICAgICAgICAgICAgZGVzY3JpcHRpb24uc3R5bGUuY3NzVGV4dCA9IGBcbiAgICAgICAgICAgICAgICBjb2xvcjogdmFyKC0tdGV4dC1tdXRlZCk7XG4gICAgICAgICAgICAgICAgZm9udC1zaXplOiAxMnB4O1xuICAgICAgICAgICAgICAgIGxpbmUtaGVpZ2h0OiAxLjQ7XG4gICAgICAgICAgICAgICAgbWFyZ2luLWJvdHRvbTogOHB4O1xuICAgICAgICAgICAgYDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIElucHV0IGZpZWxkXG4gICAgICAgIGNvbnN0IGlucHV0ID0gdGhpcy5jcmVhdGVJbnB1dEVsZW1lbnQocGFyYW1ldGVyKTtcbiAgICAgICAgaW5wdXQuc3R5bGUuY3NzVGV4dCA9IGBcbiAgICAgICAgICAgIHdpZHRoOiAxMDAlO1xuICAgICAgICAgICAgcGFkZGluZzogOHB4IDEycHg7XG4gICAgICAgICAgICBib3JkZXI6IDFweCBzb2xpZCB2YXIoLS1iYWNrZ3JvdW5kLW1vZGlmaWVyLWJvcmRlcik7XG4gICAgICAgICAgICBib3JkZXItcmFkaXVzOiB2YXIoLS1yYWRpdXMtcyk7XG4gICAgICAgICAgICBiYWNrZ3JvdW5kOiB2YXIoLS1iYWNrZ3JvdW5kLXByaW1hcnkpO1xuICAgICAgICAgICAgY29sb3I6IHZhcigtLXRleHQtbm9ybWFsKTtcbiAgICAgICAgICAgIGZvbnQtc2l6ZTogMTRweDtcbiAgICAgICAgICAgIGZvbnQtZmFtaWx5OiAke3BhcmFtZXRlci50eXBlID09PSAnbGl0ZXJhbCcgPyAndmFyKC0tZm9udC1tb25vc3BhY2UpJyA6ICdpbmhlcml0J307XG4gICAgICAgIGA7XG5cbiAgICAgICAgLy8gU2V0IGRlZmF1bHQgdmFsdWVcbiAgICAgICAgaWYgKHBhcmFtZXRlci5kZWZhdWx0VmFsdWUpIHtcbiAgICAgICAgICAgIGlucHV0LnZhbHVlID0gcGFyYW1ldGVyLmRlZmF1bHRWYWx1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFZhbGlkYXRpb25cbiAgICAgICAgY29uc3QgZXJyb3JDb250YWluZXIgPSBwYXJhbUNvbnRhaW5lci5jcmVhdGVEaXYoJ3BhcmFtZXRlci1lcnJvcicpO1xuICAgICAgICBlcnJvckNvbnRhaW5lci5zdHlsZS5jc3NUZXh0ID0gYFxuICAgICAgICAgICAgY29sb3I6IHZhcigtLXRleHQtZXJyb3IpO1xuICAgICAgICAgICAgZm9udC1zaXplOiAxMnB4O1xuICAgICAgICAgICAgbWFyZ2luLXRvcDogNHB4O1xuICAgICAgICAgICAgbWluLWhlaWdodDogMTZweDtcbiAgICAgICAgYDtcblxuICAgICAgICAvLyBFdmVudCBoYW5kbGVyc1xuICAgICAgICBpbnB1dC5hZGRFdmVudExpc3RlbmVyKCdpbnB1dCcsICgpID0+IHRoaXMudmFsaWRhdGVQYXJhbWV0ZXIocGFyYW1ldGVyLCBpbnB1dCwgZXJyb3JDb250YWluZXIpKTtcbiAgICAgICAgaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcignYmx1cicsICgpID0+IHRoaXMudmFsaWRhdGVQYXJhbWV0ZXIocGFyYW1ldGVyLCBpbnB1dCwgZXJyb3JDb250YWluZXIpKTtcblxuICAgICAgICBwYXJhbUNvbnRhaW5lci5hcHBlbmRDaGlsZChpbnB1dCk7XG4gICAgICAgIHRoaXMucGFyYW1ldGVySW5wdXRzLnNldChwYXJhbWV0ZXIuaWQgfHwgYHBhcmFtXyR7cGFyYW1ldGVyLm5hbWV9YCwgaW5wdXQpO1xuXG4gICAgICAgIC8vIENvbnN0cmFpbnRzIGhlbHAgdGV4dFxuICAgICAgICBpZiAocGFyYW1ldGVyLmNvbnN0cmFpbnRzKSB7XG4gICAgICAgICAgICB0aGlzLmNyZWF0ZUNvbnN0cmFpbnRzSGVscChwYXJhbUNvbnRhaW5lciwgcGFyYW1ldGVyLmNvbnN0cmFpbnRzKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlSW5wdXRFbGVtZW50KHBhcmFtZXRlcjogVGVtcGxhdGVQYXJhbWV0ZXIpOiBIVE1MSW5wdXRFbGVtZW50IHwgSFRNTFRleHRBcmVhRWxlbWVudCB8IEhUTUxTZWxlY3RFbGVtZW50IHtcbiAgICAgICAgaWYgKHBhcmFtZXRlci5jb25zdHJhaW50cz8uYWxsb3dlZFZhbHVlcykge1xuICAgICAgICAgICAgY29uc3Qgc2VsZWN0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2VsZWN0Jyk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IGVtcHR5T3B0aW9uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnb3B0aW9uJyk7XG4gICAgICAgICAgICBlbXB0eU9wdGlvbi52YWx1ZSA9ICcnO1xuICAgICAgICAgICAgZW1wdHlPcHRpb24udGV4dENvbnRlbnQgPSAnU2VsZWN0Li4uJztcbiAgICAgICAgICAgIHNlbGVjdC5hcHBlbmRDaGlsZChlbXB0eU9wdGlvbik7XG5cbiAgICAgICAgICAgIHBhcmFtZXRlci5jb25zdHJhaW50cy5hbGxvd2VkVmFsdWVzLmZvckVhY2godmFsdWUgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IG9wdGlvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ29wdGlvbicpO1xuICAgICAgICAgICAgICAgIG9wdGlvbi52YWx1ZSA9IHZhbHVlO1xuICAgICAgICAgICAgICAgIG9wdGlvbi50ZXh0Q29udGVudCA9IHZhbHVlO1xuICAgICAgICAgICAgICAgIHNlbGVjdC5hcHBlbmRDaGlsZChvcHRpb24pO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHJldHVybiBzZWxlY3Q7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAocGFyYW1ldGVyLnR5cGUgPT09ICdsaXRlcmFsJyAmJiAoIXBhcmFtZXRlci5jb25zdHJhaW50cz8ubWF4TGVuZ3RoIHx8IHBhcmFtZXRlci5jb25zdHJhaW50cy5tYXhMZW5ndGggPiAxMDApKSB7XG4gICAgICAgICAgICBjb25zdCB0ZXh0YXJlYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RleHRhcmVhJyk7XG4gICAgICAgICAgICB0ZXh0YXJlYS5yb3dzID0gMztcbiAgICAgICAgICAgIHJldHVybiB0ZXh0YXJlYTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW5wdXQnKTtcbiAgICAgICAgaW5wdXQudHlwZSA9ICd0ZXh0JztcblxuICAgICAgICBpZiAocGFyYW1ldGVyLnR5cGUgPT09ICdlbnRpdHknIHx8IHBhcmFtZXRlci50eXBlID09PSAncHJvcGVydHknKSB7XG4gICAgICAgICAgICBpbnB1dC5wbGFjZWhvbGRlciA9IHBhcmFtZXRlci50eXBlID09PSAnZW50aXR5JyA/ICdlLmcuLCBQZXJzb24sIGV4OkpvaG4sIDxodHRwOi8vZXhhbXBsZS5vcmcvUGVyc29uPicgOiAnZS5nLiwgbmFtZSwgZXg6aGFzQWdlLCA/cHJvcGVydHknO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGlucHV0O1xuICAgIH1cblxuICAgIHByaXZhdGUgY3JlYXRlQ29uc3RyYWludHNIZWxwKGNvbnRhaW5lcjogSFRNTEVsZW1lbnQsIGNvbnN0cmFpbnRzOiBUZW1wbGF0ZVBhcmFtZXRlclsnY29uc3RyYWludHMnXSk6IHZvaWQge1xuICAgICAgICBjb25zdCBoaW50czogc3RyaW5nW10gPSBbXTtcblxuICAgICAgICBpZiAoY29uc3RyYWludHM/LnBhdHRlcm4pIHtcbiAgICAgICAgICAgIGhpbnRzLnB1c2goYFBhdHRlcm46ICR7Y29uc3RyYWludHMucGF0dGVybn1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb25zdHJhaW50cz8ubWluTGVuZ3RoKSB7XG4gICAgICAgICAgICBoaW50cy5wdXNoKGBNaW4gbGVuZ3RoOiAke2NvbnN0cmFpbnRzLm1pbkxlbmd0aH1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChjb25zdHJhaW50cz8ubWF4TGVuZ3RoKSB7XG4gICAgICAgICAgICBoaW50cy5wdXNoKGBNYXggbGVuZ3RoOiAke2NvbnN0cmFpbnRzLm1heExlbmd0aH1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChoaW50cy5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBjb25zdCBoZWxwID0gY29udGFpbmVyLmNyZWF0ZURpdigncGFyYW1ldGVyLWhlbHAnKTtcbiAgICAgICAgICAgIGhlbHAudGV4dENvbnRlbnQgPSBoaW50cy5qb2luKCcg4oCiICcpO1xuICAgICAgICAgICAgaGVscC5zdHlsZS5jc3NUZXh0ID0gYFxuICAgICAgICAgICAgICAgIGNvbG9yOiB2YXIoLS10ZXh0LW11dGVkKTtcbiAgICAgICAgICAgICAgICBmb250LXNpemU6IDExcHg7XG4gICAgICAgICAgICAgICAgbWFyZ2luLXRvcDogNHB4O1xuICAgICAgICAgICAgICAgIGZvbnQtc3R5bGU6IGl0YWxpYztcbiAgICAgICAgICAgIGA7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHZhbGlkYXRlUGFyYW1ldGVyKFxuICAgICAgICBwYXJhbWV0ZXI6IFRlbXBsYXRlUGFyYW1ldGVyLCBcbiAgICAgICAgaW5wdXQ6IEhUTUxJbnB1dEVsZW1lbnQgfCBIVE1MVGV4dEFyZWFFbGVtZW50IHwgSFRNTFNlbGVjdEVsZW1lbnQsIFxuICAgICAgICBlcnJvckNvbnRhaW5lcjogSFRNTEVsZW1lbnRcbiAgICApOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBpbnB1dC52YWx1ZS50cmltKCk7XG4gICAgICAgIGVycm9yQ29udGFpbmVyLnRleHRDb250ZW50ID0gJyc7XG4gICAgICAgIHRoaXMudmFsaWRhdGlvbkVycm9ycy5kZWxldGUocGFyYW1ldGVyLmlkIHx8IGBwYXJhbV8ke3BhcmFtZXRlci5uYW1lfWApO1xuXG4gICAgICAgIC8vIFJlcXVpcmVkIGNoZWNrXG4gICAgICAgIGlmIChwYXJhbWV0ZXIucmVxdWlyZWQgJiYgIXZhbHVlKSB7XG4gICAgICAgICAgICBjb25zdCBlcnJvciA9IGAke3BhcmFtZXRlci5uYW1lfSBpcyByZXF1aXJlZGA7XG4gICAgICAgICAgICBlcnJvckNvbnRhaW5lci50ZXh0Q29udGVudCA9IGVycm9yO1xuICAgICAgICAgICAgdGhpcy52YWxpZGF0aW9uRXJyb3JzLnNldChwYXJhbWV0ZXIuaWQgfHwgYHBhcmFtXyR7cGFyYW1ldGVyLm5hbWV9YCwgZXJyb3IpO1xuICAgICAgICAgICAgaW5wdXQuc3R5bGUuYm9yZGVyQ29sb3IgPSAndmFyKC0tdGV4dC1lcnJvciknO1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gU2tpcCBvdGhlciB2YWxpZGF0aW9ucyBpZiBlbXB0eSBhbmQgbm90IHJlcXVpcmVkXG4gICAgICAgIGlmICghdmFsdWUgJiYgIXBhcmFtZXRlci5yZXF1aXJlZCkge1xuICAgICAgICAgICAgaW5wdXQuc3R5bGUuYm9yZGVyQ29sb3IgPSAndmFyKC0tYmFja2dyb3VuZC1tb2RpZmllci1ib3JkZXIpJztcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQ29uc3RyYWludHMgdmFsaWRhdGlvblxuICAgICAgICBpZiAocGFyYW1ldGVyLmNvbnN0cmFpbnRzKSB7XG4gICAgICAgICAgICBjb25zdCBjb25zdHJhaW50cyA9IHBhcmFtZXRlci5jb25zdHJhaW50cztcblxuICAgICAgICAgICAgaWYgKGNvbnN0cmFpbnRzLnBhdHRlcm4gJiYgIW5ldyBSZWdFeHAoY29uc3RyYWludHMucGF0dGVybikudGVzdCh2YWx1ZSkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBlcnJvciA9ICdWYWx1ZSBkb2VzIG5vdCBtYXRjaCByZXF1aXJlZCBwYXR0ZXJuJztcbiAgICAgICAgICAgICAgICBlcnJvckNvbnRhaW5lci50ZXh0Q29udGVudCA9IGVycm9yO1xuICAgICAgICAgICAgICAgIHRoaXMudmFsaWRhdGlvbkVycm9ycy5zZXQocGFyYW1ldGVyLmlkIHx8IGBwYXJhbV8ke3BhcmFtZXRlci5uYW1lfWAsIGVycm9yKTtcbiAgICAgICAgICAgICAgICBpbnB1dC5zdHlsZS5ib3JkZXJDb2xvciA9ICd2YXIoLS10ZXh0LWVycm9yKSc7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBpZiAoY29uc3RyYWludHMubWluTGVuZ3RoICYmIHZhbHVlLmxlbmd0aCA8IGNvbnN0cmFpbnRzLm1pbkxlbmd0aCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yID0gYE1pbmltdW0gbGVuZ3RoIGlzICR7Y29uc3RyYWludHMubWluTGVuZ3RofWA7XG4gICAgICAgICAgICAgICAgZXJyb3JDb250YWluZXIudGV4dENvbnRlbnQgPSBlcnJvcjtcbiAgICAgICAgICAgICAgICB0aGlzLnZhbGlkYXRpb25FcnJvcnMuc2V0KHBhcmFtZXRlci5pZCB8fCBgcGFyYW1fJHtwYXJhbWV0ZXIubmFtZX1gLCBlcnJvcik7XG4gICAgICAgICAgICAgICAgaW5wdXQuc3R5bGUuYm9yZGVyQ29sb3IgPSAndmFyKC0tdGV4dC1lcnJvciknO1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKGNvbnN0cmFpbnRzLm1heExlbmd0aCAmJiB2YWx1ZS5sZW5ndGggPiBjb25zdHJhaW50cy5tYXhMZW5ndGgpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBlcnJvciA9IGBNYXhpbXVtIGxlbmd0aCBpcyAke2NvbnN0cmFpbnRzLm1heExlbmd0aH1gO1xuICAgICAgICAgICAgICAgIGVycm9yQ29udGFpbmVyLnRleHRDb250ZW50ID0gZXJyb3I7XG4gICAgICAgICAgICAgICAgdGhpcy52YWxpZGF0aW9uRXJyb3JzLnNldChwYXJhbWV0ZXIuaWQgfHwgYHBhcmFtXyR7cGFyYW1ldGVyLm5hbWV9YCwgZXJyb3IpO1xuICAgICAgICAgICAgICAgIGlucHV0LnN0eWxlLmJvcmRlckNvbG9yID0gJ3ZhcigtLXRleHQtZXJyb3IpJztcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjb25zdHJhaW50cy5hbGxvd2VkVmFsdWVzICYmICFjb25zdHJhaW50cy5hbGxvd2VkVmFsdWVzLmluY2x1ZGVzKHZhbHVlKSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yID0gJ1ZhbHVlIG11c3QgYmUgb25lIG9mIHRoZSBhbGxvd2VkIG9wdGlvbnMnO1xuICAgICAgICAgICAgICAgIGVycm9yQ29udGFpbmVyLnRleHRDb250ZW50ID0gZXJyb3I7XG4gICAgICAgICAgICAgICAgdGhpcy52YWxpZGF0aW9uRXJyb3JzLnNldChwYXJhbWV0ZXIuaWQgfHwgYHBhcmFtXyR7cGFyYW1ldGVyLm5hbWV9YCwgZXJyb3IpO1xuICAgICAgICAgICAgICAgIGlucHV0LnN0eWxlLmJvcmRlckNvbG9yID0gJ3ZhcigtLXRleHQtZXJyb3IpJztcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpbnB1dC5zdHlsZS5ib3JkZXJDb2xvciA9ICd2YXIoLS1iYWNrZ3JvdW5kLW1vZGlmaWVyLWJvcmRlciknO1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHZhbGlkYXRlQWxsUGFyYW1ldGVycygpOiBib29sZWFuIHtcbiAgICAgICAgbGV0IGFsbFZhbGlkID0gdHJ1ZTtcblxuICAgICAgICBmb3IgKGNvbnN0IFtwYXJhbWV0ZXJJZCwgaW5wdXRdIG9mIHRoaXMucGFyYW1ldGVySW5wdXRzKSB7XG4gICAgICAgICAgICBjb25zdCBwYXJhbWV0ZXIgPSB0aGlzLnRlbXBsYXRlLmdldFBhcmFtZXRlcihwYXJhbWV0ZXJJZCk7XG4gICAgICAgICAgICBpZiAoIXBhcmFtZXRlcikgY29udGludWU7XG5cbiAgICAgICAgICAgIGNvbnN0IGVycm9yQ29udGFpbmVyID0gaW5wdXQucGFyZW50RWxlbWVudD8ucXVlcnlTZWxlY3RvcignLnBhcmFtZXRlci1lcnJvcicpIGFzIEhUTUxFbGVtZW50O1xuICAgICAgICAgICAgaWYgKCF0aGlzLnZhbGlkYXRlUGFyYW1ldGVyKHBhcmFtZXRlciwgaW5wdXQsIGVycm9yQ29udGFpbmVyKSkge1xuICAgICAgICAgICAgICAgIGFsbFZhbGlkID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYWxsVmFsaWQ7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjcmVhdGVCdXR0b25zKCk6IHZvaWQge1xuICAgICAgICBjb25zdCBidXR0b25Db250YWluZXIgPSB0aGlzLmNvbnRlbnRFbC5jcmVhdGVEaXYoJ21vZGFsLWJ1dHRvbi1jb250YWluZXInKTtcbiAgICAgICAgYnV0dG9uQ29udGFpbmVyLnN0eWxlLmNzc1RleHQgPSBgXG4gICAgICAgICAgICBkaXNwbGF5OiBmbGV4O1xuICAgICAgICAgICAganVzdGlmeS1jb250ZW50OiBmbGV4LWVuZDtcbiAgICAgICAgICAgIGdhcDogOHB4O1xuICAgICAgICAgICAgbWFyZ2luLXRvcDogMTZweDtcbiAgICAgICAgICAgIHBhZGRpbmctdG9wOiAxNnB4O1xuICAgICAgICAgICAgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHZhcigtLWJhY2tncm91bmQtbW9kaWZpZXItYm9yZGVyKTtcbiAgICAgICAgYDtcblxuICAgICAgICBjb25zdCBjYW5jZWxCdXR0b24gPSBidXR0b25Db250YWluZXIuY3JlYXRlRWwoJ2J1dHRvbicpO1xuICAgICAgICBjYW5jZWxCdXR0b24udGV4dENvbnRlbnQgPSAnQ2FuY2VsJztcbiAgICAgICAgY2FuY2VsQnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5vcHRpb25zLm9uQ2FuY2VsPy4oKTtcbiAgICAgICAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3Qgc3VibWl0QnV0dG9uID0gYnV0dG9uQ29udGFpbmVyLmNyZWF0ZUVsKCdidXR0b24nKTtcbiAgICAgICAgc3VibWl0QnV0dG9uLnRleHRDb250ZW50ID0gJ0FwcGx5IFRlbXBsYXRlJztcbiAgICAgICAgc3VibWl0QnV0dG9uLmNsYXNzTmFtZSA9ICdtb2QtY3RhJztcbiAgICAgICAgc3VibWl0QnV0dG9uLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gdGhpcy5oYW5kbGVTdWJtaXQoKSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBoYW5kbGVTdWJtaXQoKTogdm9pZCB7XG4gICAgICAgIGlmICghdGhpcy52YWxpZGF0ZUFsbFBhcmFtZXRlcnMoKSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgcGFyYW1ldGVyVmFsdWVzID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZz4oKTtcbiAgICAgICAgXG4gICAgICAgIGZvciAoY29uc3QgW3BhcmFtZXRlcklkLCBpbnB1dF0gb2YgdGhpcy5wYXJhbWV0ZXJJbnB1dHMpIHtcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gaW5wdXQudmFsdWUudHJpbSgpO1xuICAgICAgICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgcGFyYW1ldGVyVmFsdWVzLnNldChwYXJhbWV0ZXJJZCwgdmFsdWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gU2V0IHBhcmFtZXRlciB2YWx1ZXMgb24gdGVtcGxhdGVcbiAgICAgICAgZm9yIChjb25zdCBbcGFyYW1ldGVySWQsIHZhbHVlXSBvZiBwYXJhbWV0ZXJWYWx1ZXMpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgdGhpcy50ZW1wbGF0ZS5zZXRQYXJhbWV0ZXJWYWx1ZShwYXJhbWV0ZXJJZCwgdmFsdWUpO1xuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gc2V0IHBhcmFtZXRlciAke3BhcmFtZXRlcklkfTpgLCBlcnJvcik7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5vcHRpb25zLm9uU3VibWl0KHRoaXMudGVtcGxhdGUsIHBhcmFtZXRlclZhbHVlcyk7XG4gICAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNldHVwS2V5Ym9hcmRIYW5kbGVycygpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5jb250ZW50RWwuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIChlOiBLZXlib2FyZEV2ZW50KSA9PiB7XG4gICAgICAgICAgICBpZiAoZS5rZXkgPT09ICdFbnRlcicgJiYgKGUuY3RybEtleSB8fCBlLm1ldGFLZXkpKSB7XG4gICAgICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIHRoaXMuaGFuZGxlU3VibWl0KCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChlLmtleSA9PT0gJ0VzY2FwZScpIHtcbiAgICAgICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLm9uQ2FuY2VsPy4oKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNsb3NlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbn0iXSwidmVyc2lvbiI6M30=