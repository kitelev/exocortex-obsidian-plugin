70699be4bdefd7ac6c0348ce7d72fac1
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GraphLifecycleManager = void 0;
const obsidian_1 = require("obsidian");
const Graph_1 = require("../../domain/semantic/core/Graph");
const Triple_1 = require("../../domain/semantic/core/Triple");
/**
 * Graph Lifecycle Manager following Pure Fabrication Pattern (GRASP)
 * Single Responsibility: Manage knowledge graph lifecycle and file synchronization
 */
class GraphLifecycleManager {
    constructor(plugin) {
        this.plugin = plugin;
        this.graph = new Graph_1.Graph();
    }
    async initialize() {
        // Load vault data into graph
        try {
            await this.loadVaultIntoGraph();
        }
        catch (error) {
            // Vault loading failed - plugin should still function
            console.warn("Failed to load vault into graph:", error);
        }
        // Register file modification handlers
        this.registerFileHandlers();
        new obsidian_1.Notice("ðŸ” Exocortex: Knowledge graph loaded!");
    }
    async cleanup() {
        if (this.graph) {
            this.graph.clear();
        }
    }
    getManagerId() {
        return "GraphLifecycleManager";
    }
    getGraph() {
        return this.graph;
    }
    /**
     * Set callback for cache invalidation when graph changes
     */
    setCacheInvalidationCallback(callback) {
        this.cacheInvalidationCallback = callback;
    }
    async loadVaultIntoGraph() {
        // Loading vault data
        const startTime = Date.now();
        let triplesCount = 0;
        try {
            const files = this.plugin.app.vault.getMarkdownFiles();
            for (const file of files) {
                try {
                    const content = await this.plugin.app.vault.read(file);
                    const triples = this.extractTriplesFromFile(file, content);
                    for (const triple of triples) {
                        this.graph.add(triple);
                        triplesCount++;
                    }
                }
                catch (err) {
                    // File processing failed - continue with next file
                }
            }
        }
        catch (err) {
            // Vault access failed - plugin should still function
            console.warn("Failed to access vault files during graph initialization:", err);
            new obsidian_1.Notice("Exocortex: Unable to load vault files into graph");
            return;
        }
        const loadTime = Date.now() - startTime;
        // Vault data loaded
    }
    registerFileHandlers() {
        // Register file modification handler to update graph
        this.plugin.registerEvent(this.plugin.app.vault.on("modify", async (file) => {
            if (file instanceof obsidian_1.TFile && file.extension === "md") {
                await this.updateFileInGraph(file);
            }
        }));
        // Register file creation handler
        this.plugin.registerEvent(this.plugin.app.vault.on("create", async (file) => {
            if (file instanceof obsidian_1.TFile && file.extension === "md") {
                await this.updateFileInGraph(file);
            }
        }));
        // Register file deletion handler
        this.plugin.registerEvent(this.plugin.app.vault.on("delete", async (file) => {
            if (file instanceof obsidian_1.TFile && file.extension === "md") {
                this.removeFileFromGraph(file);
            }
        }));
    }
    async updateFileInGraph(file) {
        try {
            // Remove old triples for this file
            this.removeFileFromGraph(file);
            // Add new triples
            const content = await this.plugin.app.vault.read(file);
            const triples = this.extractTriplesFromFile(file, content);
            for (const triple of triples) {
                this.graph.add(triple);
            }
            // Invalidate cache when graph changes
            this.cacheInvalidationCallback?.();
        }
        catch (err) {
            // File update failed
        }
    }
    removeFileFromGraph(file) {
        const subject = new Triple_1.IRI(`file://${file.basename}`);
        const triplesToRemove = this.graph.match(subject, null, null);
        for (const triple of triplesToRemove) {
            this.graph.remove(triple);
        }
        // Invalidate cache when graph changes
        this.cacheInvalidationCallback?.();
    }
    extractTriplesFromFile(file, content) {
        const triples = [];
        const subject = new Triple_1.IRI(`file://${file.basename}`);
        // Extract frontmatter
        const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
        if (frontmatterMatch) {
            const frontmatter = this.parseFrontmatter(frontmatterMatch[1]);
            for (const [key, value] of Object.entries(frontmatter)) {
                if (Array.isArray(value)) {
                    for (const v of value) {
                        triples.push(new Triple_1.Triple(subject, new Triple_1.IRI(key), Triple_1.Literal.string(String(v))));
                    }
                }
                else if (value !== null && value !== undefined) {
                    triples.push(new Triple_1.Triple(subject, new Triple_1.IRI(key), Triple_1.Literal.string(String(value))));
                }
            }
        }
        // Add basic file metadata
        triples.push(new Triple_1.Triple(subject, new Triple_1.IRI("file_path"), Triple_1.Literal.string(file.path)));
        triples.push(new Triple_1.Triple(subject, new Triple_1.IRI("file_name"), Triple_1.Literal.string(file.name)));
        return triples;
    }
    parseFrontmatter(yaml) {
        const result = {};
        const lines = yaml.split("\n");
        let currentKey = null;
        let currentValue = null;
        let inArray = false;
        for (const line of lines) {
            const trimmed = line.trim();
            if (!trimmed)
                continue;
            // Check for array item
            if (line.startsWith("  - ") || line.startsWith("    - ")) {
                if (currentKey && inArray) {
                    const value = line.substring(line.indexOf("- ") + 2).trim();
                    const cleanValue = value
                        .replace(/^["']|["']$/g, "")
                        .replace(/\[\[|\]\]/g, "");
                    if (!Array.isArray(currentValue)) {
                        currentValue = [];
                    }
                    currentValue.push(cleanValue);
                }
                continue;
            }
            // Check for key:value pair
            if (trimmed.includes(":")) {
                // Save previous key-value if exists
                if (currentKey !== null && currentValue !== null) {
                    result[currentKey] = currentValue;
                }
                const colonIndex = trimmed.indexOf(":");
                currentKey = trimmed.substring(0, colonIndex).trim();
                const valueStr = trimmed.substring(colonIndex + 1).trim();
                if (!valueStr) {
                    // Value will be on next lines (array)
                    inArray = true;
                    currentValue = [];
                }
                else {
                    // Single value
                    inArray = false;
                    currentValue = valueStr
                        .replace(/^["']|["']$/g, "")
                        .replace(/\[\[|\]\]/g, "");
                }
            }
        }
        // Save last key-value
        if (currentKey !== null && currentValue !== null) {
            result[currentKey] = currentValue;
        }
        return result;
    }
}
exports.GraphLifecycleManager = GraphLifecycleManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2luZnJhc3RydWN0dXJlL2xpZmVjeWNsZS9HcmFwaExpZmVjeWNsZU1hbmFnZXIudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQUEsdUNBQWlEO0FBRWpELDREQUF5RDtBQUN6RCw4REFBeUU7QUFPekU7OztHQUdHO0FBQ0gsTUFBYSxxQkFBcUI7SUFJaEMsWUFBNkIsTUFBYztRQUFkLFdBQU0sR0FBTixNQUFNLENBQVE7UUFDekMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLGFBQUssRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFFRCxLQUFLLENBQUMsVUFBVTtRQUNkLDZCQUE2QjtRQUM3QixJQUFJO1lBQ0YsTUFBTSxJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztTQUNqQztRQUFDLE9BQU8sS0FBSyxFQUFFO1lBQ2Qsc0RBQXNEO1lBQ3RELE9BQU8sQ0FBQyxJQUFJLENBQUMsa0NBQWtDLEVBQUUsS0FBSyxDQUFDLENBQUM7U0FDekQ7UUFFRCxzQ0FBc0M7UUFDdEMsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7UUFFNUIsSUFBSSxpQkFBTSxDQUFDLHVDQUF1QyxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUVELEtBQUssQ0FBQyxPQUFPO1FBQ1gsSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ2QsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztTQUNwQjtJQUNILENBQUM7SUFFRCxZQUFZO1FBQ1YsT0FBTyx1QkFBdUIsQ0FBQztJQUNqQyxDQUFDO0lBRUQsUUFBUTtRQUNOLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQztJQUNwQixDQUFDO0lBRUQ7O09BRUc7SUFDSCw0QkFBNEIsQ0FBQyxRQUFtQztRQUM5RCxJQUFJLENBQUMseUJBQXlCLEdBQUcsUUFBUSxDQUFDO0lBQzVDLENBQUM7SUFFTyxLQUFLLENBQUMsa0JBQWtCO1FBQzlCLHFCQUFxQjtRQUNyQixNQUFNLFNB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QUFDLFVBQVUsQ0FBQyxHQUFHLFlBQVksQ0FBQztpQkFDbkM7Z0JBRUQsTUFBTSxVQUFVLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDeEMsVUFBVSxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLFVBQVUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUNyRCxNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFFMUQsSUFBSSxDQUFDLFFBQVEsRUFBRTtvQkFDYixzQ0FBc0M7b0JBQ3RDLE9BQU8sR0FBRyxJQUFJLENBQUM7b0JBQ2YsWUFBWSxHQUFHLEVBQUUsQ0FBQztpQkFDbkI7cUJBQU07b0JBQ0wsZUFBZTtvQkFDZixPQUFPLEdBQUcsS0FBSyxDQUFDO29CQUNoQixZQUFZLEdBQUcsUUFBUTt5QkFDcEIsT0FBTyxDQUFDLGNBQWMsRUFBRSxFQUFFLENBQUM7eUJBQzNCLE9BQU8sQ0FBQyxZQUFZLEVBQUUsRUFBRSxDQUFDLENBQUM7aUJBQzlCO2FBQ0Y7U0FDRjtRQUVELHNCQUFzQjtRQUN0QixJQUFJLFVBQVUsS0FBSyxJQUFJLElBQUksWUFBWSxLQUFLLElBQUksRUFBRTtZQUNoRCxNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsWUFBWSxDQUFDO1NBQ25DO1FBRUQsT0FBTyxNQUFNLENBQUM7SUFDaEIsQ0FBQztDQUNGO0FBNU9ELHNEQTRPQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva2l0ZWxldi9Eb2N1bWVudHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi9zcmMvaW5mcmFzdHJ1Y3R1cmUvbGlmZWN5Y2xlL0dyYXBoTGlmZWN5Y2xlTWFuYWdlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQbHVnaW4sIFRGaWxlLCBOb3RpY2UgfSBmcm9tIFwib2JzaWRpYW5cIjtcbmltcG9ydCB7IElMaWZlY3ljbGVNYW5hZ2VyIH0gZnJvbSBcIi4uLy4uL2FwcGxpY2F0aW9uL3BvcnRzL0lMaWZlY3ljbGVNYW5hZ2VyXCI7XG5pbXBvcnQgeyBHcmFwaCB9IGZyb20gXCIuLi8uLi9kb21haW4vc2VtYW50aWMvY29yZS9HcmFwaFwiO1xuaW1wb3J0IHsgVHJpcGxlLCBJUkksIExpdGVyYWwgfSBmcm9tIFwiLi4vLi4vZG9tYWluL3NlbWFudGljL2NvcmUvVHJpcGxlXCI7XG5cbi8qKlxuICogQ2FsbGJhY2sgdHlwZSBmb3IgY2FjaGUgaW52YWxpZGF0aW9uXG4gKi9cbnR5cGUgQ2FjaGVJbnZhbGlkYXRpb25DYWxsYmFjayA9ICgpID0+IHZvaWQ7XG5cbi8qKlxuICogR3JhcGggTGlmZWN5Y2xlIE1hbmFnZXIgZm9sbG93aW5nIFB1cmUgRmFicmljYXRpb24gUGF0dGVybiAoR1JBU1ApXG4gKiBTaW5nbGUgUmVzcG9uc2liaWxpdHk6IE1hbmFnZSBrbm93bGVkZ2UgZ3JhcGggbGlmZWN5Y2xlIGFuZCBmaWxlIHN5bmNocm9uaXphdGlvblxuICovXG5leHBvcnQgY2xhc3MgR3JhcGhMaWZlY3ljbGVNYW5hZ2VyIGltcGxlbWVudHMgSUxpZmVjeWNsZU1hbmFnZXIge1xuICBwcml2YXRlIGdyYXBoOiBHcmFwaDtcbiAgcHJpdmF0ZSBjYWNoZUludmFsaWRhdGlvbkNhbGxiYWNrPzogQ2FjaGVJbnZhbGlkYXRpb25DYWxsYmFjaztcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHBsdWdpbjogUGx1Z2luKSB7XG4gICAgdGhpcy5ncmFwaCA9IG5ldyBHcmFwaCgpO1xuICB9XG5cbiAgYXN5bmMgaW5pdGlhbGl6ZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBMb2FkIHZhdWx0IGRhdGEgaW50byBncmFwaFxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmxvYWRWYXVsdEludG9HcmFwaCgpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAvLyBWYXVsdCBsb2FkaW5nIGZhaWxlZCAtIHBsdWdpbiBzaG91bGQgc3RpbGwgZnVuY3Rpb25cbiAgICAgIGNvbnNvbGUud2FybihcIkZhaWxlZCB0byBsb2FkIHZhdWx0IGludG8gZ3JhcGg6XCIsIGVycm9yKTtcbiAgICB9XG5cbiAgICAvLyBSZWdpc3RlciBmaWxlIG1vZGlmaWNhdGlvbiBoYW5kbGVyc1xuICAgIHRoaXMucmVnaXN0ZXJGaWxlSGFuZGxlcnMoKTtcblxuICAgIG5ldyBOb3RpY2UoXCLwn5SNIEV4b2NvcnRleDogS25vd2xlZGdlIGdyYXBoIGxvYWRlZCFcIik7XG4gIH1cblxuICBhc3luYyBjbGVhbnVwKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0aGlzLmdyYXBoKSB7XG4gICAgICB0aGlzLmdyYXBoLmNsZWFyKCk7XG4gICAgfVxuICB9XG5cbiAgZ2V0TWFuYWdlcklkKCk6IHN0cmluZyB7XG4gICAgcmV0dXJuIFwiR3JhcGhMaWZlY3ljbGVNYW5hZ2VyXCI7XG4gIH1cblxuICBnZXRHcmFwaCgpOiBHcmFwaCB7XG4gICAgcmV0dXJuIHRoaXMuZ3JhcGg7XG4gIH1cblxuICAvKipcbiAgICogU2V0IGNhbGxiYWNrIGZvciBjYWNoZSBpbnZhbGlkYXRpb24gd2hlbiBncmFwaCBjaGFuZ2VzXG4gICAqL1xuICBzZXRDYWNoZUludmFsaWRhdGlvbkNhbGxiYWNrKGNhbGxiYWNrOiBDYWNoZUludmFsaWRhdGlvbkNhbGxiYWNrKTogdm9pZCB7XG4gICAgdGhpcy5jYWNoZUludmFsaWRhdGlvbkNhbGxiYWNrID0gY2FsbGJhY2s7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGxvYWRWYXVsdEludG9HcmFwaCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBMb2FkaW5nIHZhdWx0IGRhdGFcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIGxldCB0cmlwbGVzQ291bnQgPSAwO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZpbGVzID0gdGhpcy5wbHVnaW4uYXBwLnZhdWx0LmdldE1hcmtkb3duRmlsZXMoKTtcblxuICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uc3QgY29udGVudCA9IGF3YWl0IHRoaXMucGx1Z2luLmFwcC52YXVsdC5yZWFkKGZpbGUpO1xuICAgICAgICAgIGNvbnN0IHRyaXBsZXMgPSB0aGlzLmV4dHJhY3RUcmlwbGVzRnJvbUZpbGUoZmlsZSwgY29udGVudCk7XG5cbiAgICAgICAgICBmb3IgKGNvbnN0IHRyaXBsZSBvZiB0cmlwbGVzKSB7XG4gICAgICAgICAgICB0aGlzLmdyYXBoLmFkZCh0cmlwbGUpO1xuICAgICAgICAgICAgdHJpcGxlc0NvdW50Kys7XG4gICAgICAgICAgfVxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAvLyBGaWxlIHByb2Nlc3NpbmcgZmFpbGVkIC0gY29udGludWUgd2l0aCBuZXh0IGZpbGVcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgLy8gVmF1bHQgYWNjZXNzIGZhaWxlZCAtIHBsdWdpbiBzaG91bGQgc3RpbGwgZnVuY3Rpb25cbiAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgXCJGYWlsZWQgdG8gYWNjZXNzIHZhdWx0IGZpbGVzIGR1cmluZyBncmFwaCBpbml0aWFsaXphdGlvbjpcIixcbiAgICAgICAgZXJyLFxuICAgICAgKTtcbiAgICAgIG5ldyBOb3RpY2UoXCJFeG9jb3J0ZXg6IFVuYWJsZSB0byBsb2FkIHZhdWx0IGZpbGVzIGludG8gZ3JhcGhcIik7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgbG9hZFRpbWUgPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xuICAgIC8vIFZhdWx0IGRhdGEgbG9hZGVkXG4gIH1cblxuICBwcml2YXRlIHJlZ2lzdGVyRmlsZUhhbmRsZXJzKCk6IHZvaWQge1xuICAgIC8vIFJlZ2lzdGVyIGZpbGUgbW9kaWZpY2F0aW9uIGhhbmRsZXIgdG8gdXBkYXRlIGdyYXBoXG4gICAgdGhpcy5wbHVnaW4ucmVnaXN0ZXJFdmVudChcbiAgICAgIHRoaXMucGx1Z2luLmFwcC52YXVsdC5vbihcIm1vZGlmeVwiLCBhc3luYyAoZmlsZSkgPT4ge1xuICAgICAgICBpZiAoZmlsZSBpbnN0YW5jZW9mIFRGaWxlICYmIGZpbGUuZXh0ZW5zaW9uID09PSBcIm1kXCIpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZUZpbGVJbkdyYXBoKGZpbGUpO1xuICAgICAgICB9XG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgLy8gUmVnaXN0ZXIgZmlsZSBjcmVhdGlvbiBoYW5kbGVyXG4gICAgdGhpcy5wbHVnaW4ucmVnaXN0ZXJFdmVudChcbiAgICAgIHRoaXMucGx1Z2luLmFwcC52YXVsdC5vbihcImNyZWF0ZVwiLCBhc3luYyAoZmlsZSkgPT4ge1xuICAgICAgICBpZiAoZmlsZSBpbnN0YW5jZW9mIFRGaWxlICYmIGZpbGUuZXh0ZW5zaW9uID09PSBcIm1kXCIpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLnVwZGF0ZUZpbGVJbkdyYXBoKGZpbGUpO1xuICAgICAgICB9XG4gICAgICB9KSxcbiAgICApO1xuXG4gICAgLy8gUmVnaXN0ZXIgZmlsZSBkZWxldGlvbiBoYW5kbGVyXG4gICAgdGhpcy5wbHVnaW4ucmVnaXN0ZXJFdmVudChcbiAgICAgIHRoaXMucGx1Z2luLmFwcC52YXVsdC5vbihcImRlbGV0ZVwiLCBhc3luYyAoZmlsZSkgPT4ge1xuICAgICAgICBpZiAoZmlsZSBpbnN0YW5jZW9mIFRGaWxlICYmIGZpbGUuZXh0ZW5zaW9uID09PSBcIm1kXCIpIHtcbiAgICAgICAgICB0aGlzLnJlbW92ZUZpbGVGcm9tR3JhcGgoZmlsZSk7XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHVwZGF0ZUZpbGVJbkdyYXBoKGZpbGU6IFRGaWxlKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFJlbW92ZSBvbGQgdHJpcGxlcyBmb3IgdGhpcyBmaWxlXG4gICAgICB0aGlzLnJlbW92ZUZpbGVGcm9tR3JhcGgoZmlsZSk7XG5cbiAgICAgIC8vIEFkZCBuZXcgdHJpcGxlc1xuICAgICAgY29uc3QgY29udGVudCA9IGF3YWl0IHRoaXMucGx1Z2luLmFwcC52YXVsdC5yZWFkKGZpbGUpO1xuICAgICAgY29uc3QgdHJpcGxlcyA9IHRoaXMuZXh0cmFjdFRyaXBsZXNGcm9tRmlsZShmaWxlLCBjb250ZW50KTtcblxuICAgICAgZm9yIChjb25zdCB0cmlwbGUgb2YgdHJpcGxlcykge1xuICAgICAgICB0aGlzLmdyYXBoLmFkZCh0cmlwbGUpO1xuICAgICAgfVxuXG4gICAgICAvLyBJbnZhbGlkYXRlIGNhY2hlIHdoZW4gZ3JhcGggY2hhbmdlc1xuICAgICAgdGhpcy5jYWNoZUludmFsaWRhdGlvbkNhbGxiYWNrPy4oKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIC8vIEZpbGUgdXBkYXRlIGZhaWxlZFxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlRmlsZUZyb21HcmFwaChmaWxlOiBURmlsZSk6IHZvaWQge1xuICAgIGNvbnN0IHN1YmplY3QgPSBuZXcgSVJJKGBmaWxlOi8vJHtmaWxlLmJhc2VuYW1lfWApO1xuICAgIGNvbnN0IHRyaXBsZXNUb1JlbW92ZSA9IHRoaXMuZ3JhcGgubWF0Y2goc3ViamVjdCwgbnVsbCwgbnVsbCk7XG5cbiAgICBmb3IgKGNvbnN0IHRyaXBsZSBvZiB0cmlwbGVzVG9SZW1vdmUpIHtcbiAgICAgIHRoaXMuZ3JhcGgucmVtb3ZlKHRyaXBsZSk7XG4gICAgfVxuXG4gICAgLy8gSW52YWxpZGF0ZSBjYWNoZSB3aGVuIGdyYXBoIGNoYW5nZXNcbiAgICB0aGlzLmNhY2hlSW52YWxpZGF0aW9uQ2FsbGJhY2s/LigpO1xuICB9XG5cbiAgcHJpdmF0ZSBleHRyYWN0VHJpcGxlc0Zyb21GaWxlKGZpbGU6IFRGaWxlLCBjb250ZW50OiBzdHJpbmcpOiBUcmlwbGVbXSB7XG4gICAgY29uc3QgdHJpcGxlczogVHJpcGxlW10gPSBbXTtcbiAgICBjb25zdCBzdWJqZWN0ID0gbmV3IElSSShgZmlsZTovLyR7ZmlsZS5iYXNlbmFtZX1gKTtcblxuICAgIC8vIEV4dHJhY3QgZnJvbnRtYXR0ZXJcbiAgICBjb25zdCBmcm9udG1hdHRlck1hdGNoID0gY29udGVudC5tYXRjaCgvXi0tLVxcbihbXFxzXFxTXSo/KVxcbi0tLS8pO1xuXG4gICAgaWYgKGZyb250bWF0dGVyTWF0Y2gpIHtcbiAgICAgIGNvbnN0IGZyb250bWF0dGVyID0gdGhpcy5wYXJzZUZyb250bWF0dGVyKGZyb250bWF0dGVyTWF0Y2hbMV0pO1xuXG4gICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhmcm9udG1hdHRlcikpIHtcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICAgICAgZm9yIChjb25zdCB2IG9mIHZhbHVlKSB7XG4gICAgICAgICAgICB0cmlwbGVzLnB1c2goXG4gICAgICAgICAgICAgIG5ldyBUcmlwbGUoc3ViamVjdCwgbmV3IElSSShrZXkpLCBMaXRlcmFsLnN0cmluZyhTdHJpbmcodikpKSxcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2UgaWYgKHZhbHVlICE9PSBudWxsICYmIHZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICB0cmlwbGVzLnB1c2goXG4gICAgICAgICAgICBuZXcgVHJpcGxlKHN1YmplY3QsIG5ldyBJUkkoa2V5KSwgTGl0ZXJhbC5zdHJpbmcoU3RyaW5nKHZhbHVlKSkpLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBBZGQgYmFzaWMgZmlsZSBtZXRhZGF0YVxuICAgIHRyaXBsZXMucHVzaChcbiAgICAgIG5ldyBUcmlwbGUoc3ViamVjdCwgbmV3IElSSShcImZpbGVfcGF0aFwiKSwgTGl0ZXJhbC5zdHJpbmcoZmlsZS5wYXRoKSksXG4gICAgKTtcblxuICAgIHRyaXBsZXMucHVzaChcbiAgICAgIG5ldyBUcmlwbGUoc3ViamVjdCwgbmV3IElSSShcImZpbGVfbmFtZVwiKSwgTGl0ZXJhbC5zdHJpbmcoZmlsZS5uYW1lKSksXG4gICAgKTtcblxuICAgIHJldHVybiB0cmlwbGVzO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZUZyb250bWF0dGVyKHlhbWw6IHN0cmluZyk6IFJlY29yZDxzdHJpbmcsIGFueT4ge1xuICAgIGNvbnN0IHJlc3VsdDogUmVjb3JkPHN0cmluZywgYW55PiA9IHt9O1xuICAgIGNvbnN0IGxpbmVzID0geWFtbC5zcGxpdChcIlxcblwiKTtcbiAgICBsZXQgY3VycmVudEtleTogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG4gICAgbGV0IGN1cnJlbnRWYWx1ZTogYW55ID0gbnVsbDtcbiAgICBsZXQgaW5BcnJheSA9IGZhbHNlO1xuXG4gICAgZm9yIChjb25zdCBsaW5lIG9mIGxpbmVzKSB7XG4gICAgICBjb25zdCB0cmltbWVkID0gbGluZS50cmltKCk7XG5cbiAgICAgIGlmICghdHJpbW1lZCkgY29udGludWU7XG5cbiAgICAgIC8vIENoZWNrIGZvciBhcnJheSBpdGVtXG4gICAgICBpZiAobGluZS5zdGFydHNXaXRoKFwiICAtIFwiKSB8fCBsaW5lLnN0YXJ0c1dpdGgoXCIgICAgLSBcIikpIHtcbiAgICAgICAgaWYgKGN1cnJlbnRLZXkgJiYgaW5BcnJheSkge1xuICAgICAgICAgIGNvbnN0IHZhbHVlID0gbGluZS5zdWJzdHJpbmcobGluZS5pbmRleE9mKFwiLSBcIikgKyAyKS50cmltKCk7XG4gICAgICAgICAgY29uc3QgY2xlYW5WYWx1ZSA9IHZhbHVlXG4gICAgICAgICAgICAucmVwbGFjZSgvXltcIiddfFtcIiddJC9nLCBcIlwiKVxuICAgICAgICAgICAgLnJlcGxhY2UoL1xcW1xcW3xcXF1cXF0vZywgXCJcIik7XG4gICAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KGN1cnJlbnRWYWx1ZSkpIHtcbiAgICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9IFtdO1xuICAgICAgICAgIH1cbiAgICAgICAgICBjdXJyZW50VmFsdWUucHVzaChjbGVhblZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgZm9yIGtleTp2YWx1ZSBwYWlyXG4gICAgICBpZiAodHJpbW1lZC5pbmNsdWRlcyhcIjpcIikpIHtcbiAgICAgICAgLy8gU2F2ZSBwcmV2aW91cyBrZXktdmFsdWUgaWYgZXhpc3RzXG4gICAgICAgIGlmIChjdXJyZW50S2V5ICE9PSBudWxsICYmIGN1cnJlbnRWYWx1ZSAhPT0gbnVsbCkge1xuICAgICAgICAgIHJlc3VsdFtjdXJyZW50S2V5XSA9IGN1cnJlbnRWYWx1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IGNvbG9uSW5kZXggPSB0cmltbWVkLmluZGV4T2YoXCI6XCIpO1xuICAgICAgICBjdXJyZW50S2V5ID0gdHJpbW1lZC5zdWJzdHJpbmcoMCwgY29sb25JbmRleCkudHJpbSgpO1xuICAgICAgICBjb25zdCB2YWx1ZVN0ciA9IHRyaW1tZWQuc3Vic3RyaW5nKGNvbG9uSW5kZXggKyAxKS50cmltKCk7XG5cbiAgICAgICAgaWYgKCF2YWx1ZVN0cikge1xuICAgICAgICAgIC8vIFZhbHVlIHdpbGwgYmUgb24gbmV4dCBsaW5lcyAoYXJyYXkpXG4gICAgICAgICAgaW5BcnJheSA9IHRydWU7XG4gICAgICAgICAgY3VycmVudFZhbHVlID0gW107XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gU2luZ2xlIHZhbHVlXG4gICAgICAgICAgaW5BcnJheSA9IGZhbHNlO1xuICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9IHZhbHVlU3RyXG4gICAgICAgICAgICAucmVwbGFjZSgvXltcIiddfFtcIiddJC9nLCBcIlwiKVxuICAgICAgICAgICAgLnJlcGxhY2UoL1xcW1xcW3xcXF1cXF0vZywgXCJcIik7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBTYXZlIGxhc3Qga2V5LXZhbHVlXG4gICAgaWYgKGN1cnJlbnRLZXkgIT09IG51bGwgJiYgY3VycmVudFZhbHVlICE9PSBudWxsKSB7XG4gICAgICByZXN1bHRbY3VycmVudEtleV0gPSBjdXJyZW50VmFsdWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9