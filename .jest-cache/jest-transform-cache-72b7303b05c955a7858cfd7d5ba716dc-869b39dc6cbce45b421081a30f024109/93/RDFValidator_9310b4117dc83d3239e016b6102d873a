92fe9ba9dd3496fd50b5485488d93e40
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RDFValidator = void 0;
const Result_1 = require("../../domain/core/Result");
const Triple_1 = require("../../domain/semantic/core/Triple");
class RDFValidator {
    constructor() { }
    validateGraph(graph, options = {}) {
        const errors = [];
        const warnings = [];
        const stats = {
            tripleCount: 0,
            duplicateCount: 0,
            invalidIRICount: 0,
            invalidLiteralCount: 0
        };
        try {
            const triples = graph.toArray();
            stats.tripleCount = triples.length;
            const seenTriples = new Set();
            for (const triple of triples) {
                const validationErrors = this.validateTriple(triple, options);
                errors.push(...validationErrors.filter(e => e.type === 'error'));
                warnings.push(...validationErrors.filter(e => e.type === 'warning'));
                if (validationErrors.some(e => e.message.includes('Invalid IRI'))) {
                    stats.invalidIRICount++;
                }
                if (validationErrors.some(e => e.message.includes('Invalid literal'))) {
                    stats.invalidLiteralCount++;
                }
                if (options.checkDuplicates) {
                    const tripleKey = this.getTripleKey(triple);
                    if (seenTriples.has(tripleKey)) {
                        stats.duplicateCount++;
                        warnings.push({
                            type: 'warning',
                            message: 'Duplicate triple detected',
                            triple
                        });
                    }
                    else {
                        seenTriples.add(tripleKey);
                    }
                }
            }
            const result = {
                isValid: errors.length === 0,
                errors,
                warnings,
                stats
            };
            return Result_1.Result.ok(result);
        }
        catch (error) {
            return Result_1.Result.fail(`Validation failed: ${error.message}`);
        }
    }
    validateTriple(triple, options = {}) {
        const errors = [];
        const subject = triple.getSubject();
        const predicate = triple.getPredicate();
        const object = triple.getObject();
        if (!subject || !predicate || !object) {
            errors.push({
                type: 'error',
                message: 'Triple is missing required components',
                triple
            });
            return errors;
        }
        if (subject instanceof Triple_1.IRI) {
            const iriErrors = this.validateIRI(subject.toString());
            if (iriErrors.length > 0) {
                errors.push({
                    type: options.strictMode ? 'error' : 'warning',
                    message: `Invalid IRI in subject: ${iriErrors.join(', ')}`,
                    triple
                });
            }
        }
        if (predicate instanceof Triple_1.IRI) {
            const iriErrors = this.validateIRI(predicate.toString());
            if (iriErrors.length > 0) {
                errors.push({
                    type: 'error',
                    message: `Invalid IRI in predicate: ${iriErrors.join(', ')}`,
                    triple
                });
            }
        }
        if (object instanceof Triple_1.IRI) {
            const iriErrors = this.validateIRI(object.toString());
            if (iriErrors.length > 0) {
                errors.push({
                    type: options.strictMode ? 'error' : 'warning',
                    message: `Invalid IRI in object: ${iriErrors.join(', ')}`,
                    triple
                });
            }
        }
        if (options.checkLiterals && object instanceof Triple_1.Literal) {
            const literalErrors = this.validateLiteral(object);
            errors.push(...literalErrors);
        }
        return errors;
    }
    validateIRI(iri) {
        const errors = [];
        if (!iri || iri.trim() === '') {
            errors.push('IRI cannot be empty');
            return errors;
        }
        if (!/^[a-zA-Z][a-zA-Z0-9+.-]*:/.test(iri)) {
            errors.push('IRI must start with a valid scheme');
        }
        const invalidChars = /[\s<>"{}|\\^`]/;
        if (invalidChars.test(iri)) {
            errors.push('IRI contains invalid characters');
        }
        if (iri.length > 2048) {
            errors.push('IRI exceeds maximum length');
        }
        return errors;
    }
    validateLiteral(literal) {
        const errors = [];
        const datatype = literal.getDatatype();
        const language = literal.getLanguage();
        const value = literal.getValue();
        if (datatype) {
            const datatypeErrors = this.validateIRI(datatype.toString());
            if (datatypeErrors.length > 0) {
                errors.push({
                    type: 'warning',
                    message: `Invalid datatype IRI: ${datatypeErrors.join(', ')}`
                });
            }
            const isValid = this.validateLiteralValue(value, datatype.toString());
            if (!isValid) {
                errors.push({
                    type: 'warning',
                    message: `Literal value does not match declared datatype ${datatype.toString()}`
                });
            }
        }
        if (language) {
            if (!/^[a-z]{2,3}(-[A-Z]{2})?$/.test(language)) {
                errors.push({
                    type: 'warning',
                    message: `Invalid language tag: ${language}`
                });
            }
        }
        return errors;
    }
    validateLiteralValue(value, datatypeIRI) {
        const xsdNamespace = 'http://www.w3.org/2001/XMLSchema#';
        if (datatypeIRI === `${xsdNamespace}integer`) {
            return /^-?\d+$/.test(value);
        }
        if (datatypeIRI === `${xsdNamespace}decimal`) {
            return /^-?\d+(\.\d+)?$/.test(value);
        }
        if (datatypeIRI === `${xsdNamespace}boolean`) {
            return value === 'true' || value === 'false';
        }
        if (datatypeIRI === `${xsdNamespace}dateTime`) {
            return /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(value);
        }
        if (datatypeIRI === `${xsdNamespace}date`) {
            return /^\d{4}-\d{2}-\d{2}$/.test(value);
        }
        return true;
    }
    validateExportOptions(options) {
        if (!options.format) {
            return Result_1.Result.fail('Export format is required');
        }
        const validFormats = ['turtle', 'n-triples', 'json-ld', 'rdf-xml'];
        if (!validFormats.includes(options.format)) {
            return Result_1.Result.fail(`Unsupported export format: ${options.format}`);
        }
        if (options.targetFolder && typeof options.targetFolder !== 'string') {
            return Result_1.Result.fail('Target folder must be a string');
        }
        if (options.fileName && typeof options.fileName !== 'string') {
            return Result_1.Result.fail('File name must be a string');
        }
        return Result_1.Result.ok();
    }
    validateImportOptions(options) {
        if (!options.mergeMode) {
            return Result_1.Result.fail('Merge mode is required');
        }
        if (options.mergeMode !== 'merge' && options.mergeMode !== 'replace') {
            return Result_1.Result.fail(`Invalid merge mode: ${options.mergeMode}`);
        }
        if (options.format) {
            const validFormats = ['turtle', 'n-triples', 'json-ld', 'rdf-xml'];
            if (!validFormats.includes(options.format)) {
                return Result_1.Result.fail(`Unsupported import format: ${options.format}`);
            }
        }
        return Result_1.Result.ok();
    }
    getTripleKey(triple) {
        const subject = triple.getSubject();
        const predicate = triple.getPredicate();
        const object = triple.getObject();
        const subjectStr = subject instanceof Triple_1.IRI ? subject.toString() :
            subject instanceof Triple_1.BlankNode ? `_:${subject.toString()}` : '';
        const predicateStr = predicate.toString();
        const objectStr = object instanceof Triple_1.IRI ? object.toString() :
            object instanceof Triple_1.BlankNode ? `_:${object.toString()}` :
                object instanceof Triple_1.Literal ? `"${object.toString()}"` : '';
        return `${subjectStr}|${predicateStr}|${objectStr}`;
    }
}
exports.RDFValidator = RDFValidator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2FwcGxpY2F0aW9uL3NlcnZpY2VzL1JERlZhbGlkYXRvci50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSxxREFBa0Q7QUFFbEQsOERBQW9GO0FBNkJwRixNQUFhLFlBQVk7SUFDckIsZ0JBQWUsQ0FBQztJQUVoQixhQUFhLENBQUMsS0FBWSxFQUFFLFVBQTZCLEVBQUU7UUFDdkQsTUFBTSxNQUFNLEdBQXNCLEVBQUUsQ0FBQztRQUNyQyxNQUFNLFFBQVEsR0FBc0IsRUFBRSxDQUFDO1FBQ3ZDLE1BQU0sS0FBSyxHQUFHO1lBQ1YsV0FBVyxFQUFFLENBQUM7WUFDZCxjQUFjLEVBQUUsQ0FBQztZQUNqQixlQUFlLEVBQUUsQ0FBQztZQUNsQixtQkFBbUIsRUFBRSxDQUFDO1NBQ3pCLENBQUM7UUFFRixJQUFJO1lBQ0EsTUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ2hDLEtBQUssQ0FBQyxXQUFXLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQztZQUVuQyxNQUFNLFdBQVcsR0FBRyxJQUFJLEdBQUcsRUFBVSxDQUFDO1lBRXRDLEtBQUssTUFBTSxNQUFNLElBQUksT0FBTyxFQUFFO2dCQUMxQixNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFDO2dCQUM5RCxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxPQUFPLENBQUMsQ0FBQyxDQUFDO2dCQUNqRSxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsZ0JBQWdCLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUVyRSxJQUFJLGdCQUFnQixDQUFDLElBQUksQ0FB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aWFuLXBsdWdpbi9zcmMvYXBwbGljYXRpb24vc2VydmljZXMvUkRGVmFsaWRhdG9yLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFJlc3VsdCB9IGZyb20gJy4uLy4uL2RvbWFpbi9jb3JlL1Jlc3VsdCc7XG5pbXBvcnQgeyBHcmFwaCB9IGZyb20gJy4uLy4uL2RvbWFpbi9zZW1hbnRpYy9jb3JlL0dyYXBoJztcbmltcG9ydCB7IFRyaXBsZSwgSVJJLCBCbGFua05vZGUsIExpdGVyYWwgfSBmcm9tICcuLi8uLi9kb21haW4vc2VtYW50aWMvY29yZS9UcmlwbGUnO1xuaW1wb3J0IHsgUkRGRm9ybWF0IH0gZnJvbSAnLi9SREZTZXJpYWxpemVyJztcblxuZXhwb3J0IGludGVyZmFjZSBWYWxpZGF0aW9uRXJyb3Ige1xuICAgIHR5cGU6ICdlcnJvcicgfCAnd2FybmluZyc7XG4gICAgbWVzc2FnZTogc3RyaW5nO1xuICAgIHRyaXBsZT86IFRyaXBsZTtcbiAgICBsb2NhdGlvbj86IHsgbGluZT86IG51bWJlcjsgY29sdW1uPzogbnVtYmVyIH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVmFsaWRhdGlvbk9wdGlvbnMge1xuICAgIHN0cmljdE1vZGU/OiBib29sZWFuO1xuICAgIGNoZWNrRHVwbGljYXRlcz86IGJvb2xlYW47XG4gICAgY2hlY2tOYW1lc3BhY2VzPzogYm9vbGVhbjtcbiAgICBjaGVja0xpdGVyYWxzPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBWYWxpZGF0aW9uUmVzdWx0IHtcbiAgICBpc1ZhbGlkOiBib29sZWFuO1xuICAgIGVycm9yczogVmFsaWRhdGlvbkVycm9yW107XG4gICAgd2FybmluZ3M6IFZhbGlkYXRpb25FcnJvcltdO1xuICAgIHN0YXRzOiB7XG4gICAgICAgIHRyaXBsZUNvdW50OiBudW1iZXI7XG4gICAgICAgIGR1cGxpY2F0ZUNvdW50OiBudW1iZXI7XG4gICAgICAgIGludmFsaWRJUklDb3VudDogbnVtYmVyO1xuICAgICAgICBpbnZhbGlkTGl0ZXJhbENvdW50OiBudW1iZXI7XG4gICAgfTtcbn1cblxuZXhwb3J0IGNsYXNzIFJERlZhbGlkYXRvciB7XG4gICAgY29uc3RydWN0b3IoKSB7fVxuXG4gICAgdmFsaWRhdGVHcmFwaChncmFwaDogR3JhcGgsIG9wdGlvbnM6IFZhbGlkYXRpb25PcHRpb25zID0ge30pOiBSZXN1bHQ8VmFsaWRhdGlvblJlc3VsdD4ge1xuICAgICAgICBjb25zdCBlcnJvcnM6IFZhbGlkYXRpb25FcnJvcltdID0gW107XG4gICAgICAgIGNvbnN0IHdhcm5pbmdzOiBWYWxpZGF0aW9uRXJyb3JbXSA9IFtdO1xuICAgICAgICBjb25zdCBzdGF0cyA9IHtcbiAgICAgICAgICAgIHRyaXBsZUNvdW50OiAwLFxuICAgICAgICAgICAgZHVwbGljYXRlQ291bnQ6IDAsXG4gICAgICAgICAgICBpbnZhbGlkSVJJQ291bnQ6IDAsXG4gICAgICAgICAgICBpbnZhbGlkTGl0ZXJhbENvdW50OiAwXG4gICAgICAgIH07XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IHRyaXBsZXMgPSBncmFwaC50b0FycmF5KCk7XG4gICAgICAgICAgICBzdGF0cy50cmlwbGVDb3VudCA9IHRyaXBsZXMubGVuZ3RoO1xuXG4gICAgICAgICAgICBjb25zdCBzZWVuVHJpcGxlcyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHRyaXBsZSBvZiB0cmlwbGVzKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdmFsaWRhdGlvbkVycm9ycyA9IHRoaXMudmFsaWRhdGVUcmlwbGUodHJpcGxlLCBvcHRpb25zKTtcbiAgICAgICAgICAgICAgICBlcnJvcnMucHVzaCguLi52YWxpZGF0aW9uRXJyb3JzLmZpbHRlcihlID0+IGUudHlwZSA9PT0gJ2Vycm9yJykpO1xuICAgICAgICAgICAgICAgIHdhcm5pbmdzLnB1c2goLi4udmFsaWRhdGlvbkVycm9ycy5maWx0ZXIoZSA9PiBlLnR5cGUgPT09ICd3YXJuaW5nJykpO1xuXG4gICAgICAgICAgICAgICAgaWYgKHZhbGlkYXRpb25FcnJvcnMuc29tZShlID0+IGUubWVzc2FnZS5pbmNsdWRlcygnSW52YWxpZCBJUkknKSkpIHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdHMuaW52YWxpZElSSUNvdW50Kys7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh2YWxpZGF0aW9uRXJyb3JzLnNvbWUoZSA9PiBlLm1lc3NhZ2UuaW5jbHVkZXMoJ0ludmFsaWQgbGl0ZXJhbCcpKSkge1xuICAgICAgICAgICAgICAgICAgICBzdGF0cy5pbnZhbGlkTGl0ZXJhbENvdW50Kys7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuY2hlY2tEdXBsaWNhdGVzKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRyaXBsZUtleSA9IHRoaXMuZ2V0VHJpcGxlS2V5KHRyaXBsZSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChzZWVuVHJpcGxlcy5oYXModHJpcGxlS2V5KSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgc3RhdHMuZHVwbGljYXRlQ291bnQrKztcbiAgICAgICAgICAgICAgICAgICAgICAgIHdhcm5pbmdzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICd3YXJuaW5nJyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiAnRHVwbGljYXRlIHRyaXBsZSBkZXRlY3RlZCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJpcGxlXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHNlZW5UcmlwbGVzLmFkZCh0cmlwbGVLZXkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCByZXN1bHQ6IFZhbGlkYXRpb25SZXN1bHQgPSB7XG4gICAgICAgICAgICAgICAgaXNWYWxpZDogZXJyb3JzLmxlbmd0aCA9PT0gMCxcbiAgICAgICAgICAgICAgICBlcnJvcnMsXG4gICAgICAgICAgICAgICAgd2FybmluZ3MsXG4gICAgICAgICAgICAgICAgc3RhdHNcbiAgICAgICAgICAgIH07XG5cbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQub2socmVzdWx0KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbChgVmFsaWRhdGlvbiBmYWlsZWQ6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHZhbGlkYXRlVHJpcGxlKHRyaXBsZTogVHJpcGxlLCBvcHRpb25zOiBWYWxpZGF0aW9uT3B0aW9ucyA9IHt9KTogVmFsaWRhdGlvbkVycm9yW10ge1xuICAgICAgICBjb25zdCBlcnJvcnM6IFZhbGlkYXRpb25FcnJvcltdID0gW107XG5cbiAgICAgICAgY29uc3Qgc3ViamVjdCA9IHRyaXBsZS5nZXRTdWJqZWN0KCk7XG4gICAgICAgIGNvbnN0IHByZWRpY2F0ZSA9IHRyaXBsZS5nZXRQcmVkaWNhdGUoKTtcbiAgICAgICAgY29uc3Qgb2JqZWN0ID0gdHJpcGxlLmdldE9iamVjdCgpO1xuXG4gICAgICAgIGlmICghc3ViamVjdCB8fCAhcHJlZGljYXRlIHx8ICFvYmplY3QpIHtcbiAgICAgICAgICAgIGVycm9ycy5wdXNoKHtcbiAgICAgICAgICAgICAgICB0eXBlOiAnZXJyb3InLFxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6ICdUcmlwbGUgaXMgbWlzc2luZyByZXF1aXJlZCBjb21wb25lbnRzJyxcbiAgICAgICAgICAgICAgICB0cmlwbGVcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIGVycm9ycztcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChzdWJqZWN0IGluc3RhbmNlb2YgSVJJKSB7XG4gICAgICAgICAgICBjb25zdCBpcmlFcnJvcnMgPSB0aGlzLnZhbGlkYXRlSVJJKHN1YmplY3QudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICBpZiAoaXJpRXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBlcnJvcnMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IG9wdGlvbnMuc3RyaWN0TW9kZSA/ICdlcnJvcicgOiAnd2FybmluZycsXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGBJbnZhbGlkIElSSSBpbiBzdWJqZWN0OiAke2lyaUVycm9ycy5qb2luKCcsICcpfWAsXG4gICAgICAgICAgICAgICAgICAgIHRyaXBsZVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHByZWRpY2F0ZSBpbnN0YW5jZW9mIElSSSkge1xuICAgICAgICAgICAgY29uc3QgaXJpRXJyb3JzID0gdGhpcy52YWxpZGF0ZUlSSShwcmVkaWNhdGUudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICBpZiAoaXJpRXJyb3JzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICBlcnJvcnMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIHR5cGU6ICdlcnJvcicsXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGBJbnZhbGlkIElSSSBpbiBwcmVkaWNhdGU6ICR7aXJpRXJyb3JzLmpvaW4oJywgJyl9YCxcbiAgICAgICAgICAgICAgICAgICAgdHJpcGxlXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBpZiAob2JqZWN0IGluc3RhbmNlb2YgSVJJKSB7XG4gICAgICAgICAgICBjb25zdCBpcmlFcnJvcnMgPSB0aGlzLnZhbGlkYXRlSVJJKG9iamVjdC50b1N0cmluZygpKTtcbiAgICAgICAgICAgIGlmIChpcmlFcnJvcnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGVycm9ycy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogb3B0aW9ucy5zdHJpY3RNb2RlID8gJ2Vycm9yJyA6ICd3YXJuaW5nJyxcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogYEludmFsaWQgSVJJIGluIG9iamVjdDogJHtpcmlFcnJvcnMuam9pbignLCAnKX1gLFxuICAgICAgICAgICAgICAgICAgICB0cmlwbGVcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChvcHRpb25zLmNoZWNrTGl0ZXJhbHMgJiYgb2JqZWN0IGluc3RhbmNlb2YgTGl0ZXJhbCkge1xuICAgICAgICAgICAgY29uc3QgbGl0ZXJhbEVycm9ycyA9IHRoaXMudmFsaWRhdGVMaXRlcmFsKG9iamVjdCk7XG4gICAgICAgICAgICBlcnJvcnMucHVzaCguLi5saXRlcmFsRXJyb3JzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBlcnJvcnM7XG4gICAgfVxuXG4gICAgdmFsaWRhdGVJUkkoaXJpOiBzdHJpbmcpOiBzdHJpbmdbXSB7XG4gICAgICAgIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcblxuICAgICAgICBpZiAoIWlyaSB8fCBpcmkudHJpbSgpID09PSAnJykge1xuICAgICAgICAgICAgZXJyb3JzLnB1c2goJ0lSSSBjYW5ub3QgYmUgZW1wdHknKTtcbiAgICAgICAgICAgIHJldHVybiBlcnJvcnM7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIS9eW2EtekEtWl1bYS16QS1aMC05Ky4tXSo6Ly50ZXN0KGlyaSkpIHtcbiAgICAgICAgICAgIGVycm9ycy5wdXNoKCdJUkkgbXVzdCBzdGFydCB3aXRoIGEgdmFsaWQgc2NoZW1lJyk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBpbnZhbGlkQ2hhcnMgPSAvW1xcczw+XCJ7fXxcXFxcXmBdLztcbiAgICAgICAgaWYgKGludmFsaWRDaGFycy50ZXN0KGlyaSkpIHtcbiAgICAgICAgICAgIGVycm9ycy5wdXNoKCdJUkkgY29udGFpbnMgaW52YWxpZCBjaGFyYWN0ZXJzJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoaXJpLmxlbmd0aCA+IDIwNDgpIHtcbiAgICAgICAgICAgIGVycm9ycy5wdXNoKCdJUkkgZXhjZWVkcyBtYXhpbXVtIGxlbmd0aCcpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGVycm9ycztcbiAgICB9XG5cbiAgICB2YWxpZGF0ZUxpdGVyYWwobGl0ZXJhbDogTGl0ZXJhbCk6IFZhbGlkYXRpb25FcnJvcltdIHtcbiAgICAgICAgY29uc3QgZXJyb3JzOiBWYWxpZGF0aW9uRXJyb3JbXSA9IFtdO1xuXG4gICAgICAgIGNvbnN0IGRhdGF0eXBlID0gbGl0ZXJhbC5nZXREYXRhdHlwZSgpO1xuICAgICAgICBjb25zdCBsYW5ndWFnZSA9IGxpdGVyYWwuZ2V0TGFuZ3VhZ2UoKTtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBsaXRlcmFsLmdldFZhbHVlKCk7XG5cbiAgICAgICAgaWYgKGRhdGF0eXBlKSB7XG4gICAgICAgICAgICBjb25zdCBkYXRhdHlwZUVycm9ycyA9IHRoaXMudmFsaWRhdGVJUkkoZGF0YXR5cGUudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICBpZiAoZGF0YXR5cGVFcnJvcnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGVycm9ycy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3dhcm5pbmcnLFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBgSW52YWxpZCBkYXRhdHlwZSBJUkk6ICR7ZGF0YXR5cGVFcnJvcnMuam9pbignLCAnKX1gXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGlzVmFsaWQgPSB0aGlzLnZhbGlkYXRlTGl0ZXJhbFZhbHVlKHZhbHVlLCBkYXRhdHlwZS50b1N0cmluZygpKTtcbiAgICAgICAgICAgIGlmICghaXNWYWxpZCkge1xuICAgICAgICAgICAgICAgIGVycm9ycy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3dhcm5pbmcnLFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBgTGl0ZXJhbCB2YWx1ZSBkb2VzIG5vdCBtYXRjaCBkZWNsYXJlZCBkYXRhdHlwZSAke2RhdGF0eXBlLnRvU3RyaW5nKCl9YFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGxhbmd1YWdlKSB7XG4gICAgICAgICAgICBpZiAoIS9eW2Etel17MiwzfSgtW0EtWl17Mn0pPyQvLnRlc3QobGFuZ3VhZ2UpKSB7XG4gICAgICAgICAgICAgICAgZXJyb3JzLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICB0eXBlOiAnd2FybmluZycsXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGBJbnZhbGlkIGxhbmd1YWdlIHRhZzogJHtsYW5ndWFnZX1gXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gZXJyb3JzO1xuICAgIH1cblxuICAgIHByaXZhdGUgdmFsaWRhdGVMaXRlcmFsVmFsdWUodmFsdWU6IHN0cmluZywgZGF0YXR5cGVJUkk6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICBjb25zdCB4c2ROYW1lc3BhY2UgPSAnaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEjJztcbiAgICAgICAgXG4gICAgICAgIGlmIChkYXRhdHlwZUlSSSA9PT0gYCR7eHNkTmFtZXNwYWNlfWludGVnZXJgKSB7XG4gICAgICAgICAgICByZXR1cm4gL14tP1xcZCskLy50ZXN0KHZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZGF0YXR5cGVJUkkgPT09IGAke3hzZE5hbWVzcGFjZX1kZWNpbWFsYCkge1xuICAgICAgICAgICAgcmV0dXJuIC9eLT9cXGQrKFxcLlxcZCspPyQvLnRlc3QodmFsdWUpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChkYXRhdHlwZUlSSSA9PT0gYCR7eHNkTmFtZXNwYWNlfWJvb2xlYW5gKSB7XG4gICAgICAgICAgICByZXR1cm4gdmFsdWUgPT09ICd0cnVlJyB8fCB2YWx1ZSA9PT0gJ2ZhbHNlJztcbiAgICAgICAgfVxuICAgICAgICBpZiAoZGF0YXR5cGVJUkkgPT09IGAke3hzZE5hbWVzcGFjZX1kYXRlVGltZWApIHtcbiAgICAgICAgICAgIHJldHVybiAvXlxcZHs0fS1cXGR7Mn0tXFxkezJ9VFxcZHsyfTpcXGR7Mn06XFxkezJ9Ly50ZXN0KHZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZGF0YXR5cGVJUkkgPT09IGAke3hzZE5hbWVzcGFjZX1kYXRlYCkge1xuICAgICAgICAgICAgcmV0dXJuIC9eXFxkezR9LVxcZHsyfS1cXGR7Mn0kLy50ZXN0KHZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgdmFsaWRhdGVFeHBvcnRPcHRpb25zKG9wdGlvbnM6IGFueSk6IFJlc3VsdDx2b2lkPiB7XG4gICAgICAgIGlmICghb3B0aW9ucy5mb3JtYXQpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbCgnRXhwb3J0IGZvcm1hdCBpcyByZXF1aXJlZCcpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdmFsaWRGb3JtYXRzOiBSREZGb3JtYXRbXSA9IFsndHVydGxlJywgJ24tdHJpcGxlcycsICdqc29uLWxkJywgJ3JkZi14bWwnXTtcbiAgICAgICAgaWYgKCF2YWxpZEZvcm1hdHMuaW5jbHVkZXMob3B0aW9ucy5mb3JtYXQpKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWwoYFVuc3VwcG9ydGVkIGV4cG9ydCBmb3JtYXQ6ICR7b3B0aW9ucy5mb3JtYXR9YCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAob3B0aW9ucy50YXJnZXRGb2xkZXIgJiYgdHlwZW9mIG9wdGlvbnMudGFyZ2V0Rm9sZGVyICE9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsKCdUYXJnZXQgZm9sZGVyIG11c3QgYmUgYSBzdHJpbmcnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChvcHRpb25zLmZpbGVOYW1lICYmIHR5cGVvZiBvcHRpb25zLmZpbGVOYW1lICE9PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsKCdGaWxlIG5hbWUgbXVzdCBiZSBhIHN0cmluZycpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIFJlc3VsdC5vaygpO1xuICAgIH1cblxuICAgIHZhbGlkYXRlSW1wb3J0T3B0aW9ucyhvcHRpb25zOiBhbnkpOiBSZXN1bHQ8dm9pZD4ge1xuICAgICAgICBpZiAoIW9wdGlvbnMubWVyZ2VNb2RlKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWwoJ01lcmdlIG1vZGUgaXMgcmVxdWlyZWQnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChvcHRpb25zLm1lcmdlTW9kZSAhPT0gJ21lcmdlJyAmJiBvcHRpb25zLm1lcmdlTW9kZSAhPT0gJ3JlcGxhY2UnKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWwoYEludmFsaWQgbWVyZ2UgbW9kZTogJHtvcHRpb25zLm1lcmdlTW9kZX1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChvcHRpb25zLmZvcm1hdCkge1xuICAgICAgICAgICAgY29uc3QgdmFsaWRGb3JtYXRzOiBSREZGb3JtYXRbXSA9IFsndHVydGxlJywgJ24tdHJpcGxlcycsICdqc29uLWxkJywgJ3JkZi14bWwnXTtcbiAgICAgICAgICAgIGlmICghdmFsaWRGb3JtYXRzLmluY2x1ZGVzKG9wdGlvbnMuZm9ybWF0KSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbChgVW5zdXBwb3J0ZWQgaW1wb3J0IGZvcm1hdDogJHtvcHRpb25zLmZvcm1hdH1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBSZXN1bHQub2soKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFRyaXBsZUtleSh0cmlwbGU6IFRyaXBsZSk6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IHN1YmplY3QgPSB0cmlwbGUuZ2V0U3ViamVjdCgpO1xuICAgICAgICBjb25zdCBwcmVkaWNhdGUgPSB0cmlwbGUuZ2V0UHJlZGljYXRlKCk7XG4gICAgICAgIGNvbnN0IG9iamVjdCA9IHRyaXBsZS5nZXRPYmplY3QoKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHN1YmplY3RTdHIgPSBzdWJqZWN0IGluc3RhbmNlb2YgSVJJID8gc3ViamVjdC50b1N0cmluZygpIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViamVjdCBpbnN0YW5jZW9mIEJsYW5rTm9kZSA/IGBfOiR7c3ViamVjdC50b1N0cmluZygpfWAgOiAnJztcbiAgICAgICAgY29uc3QgcHJlZGljYXRlU3RyID0gcHJlZGljYXRlLnRvU3RyaW5nKCk7XG4gICAgICAgIGNvbnN0IG9iamVjdFN0ciA9IG9iamVjdCBpbnN0YW5jZW9mIElSSSA/IG9iamVjdC50b1N0cmluZygpIDpcbiAgICAgICAgICAgICAgICAgICAgICAgICBvYmplY3QgaW5zdGFuY2VvZiBCbGFua05vZGUgPyBgXzoke29iamVjdC50b1N0cmluZygpfWAgOlxuICAgICAgICAgICAgICAgICAgICAgICAgIG9iamVjdCBpbnN0YW5jZW9mIExpdGVyYWwgPyBgXCIke29iamVjdC50b1N0cmluZygpfVwiYCA6ICcnO1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIGAke3N1YmplY3RTdHJ9fCR7cHJlZGljYXRlU3RyfXwke29iamVjdFN0cn1gO1xuICAgIH1cbn0iXSwidmVyc2lvbiI6M30=