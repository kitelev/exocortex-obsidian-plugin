2a9892c1e4e708f0024ffbd120d4aeab
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ObsidianAssetRepository = void 0;
const obsidian_1 = require("obsidian");
const Asset_1 = require("../../domain/entities/Asset");
const AbstractFileRepository_1 = require("../../shared/AbstractFileRepository");
/**
 * Obsidian implementation of IAssetRepository
 * Handles asset persistence using Obsidian vault
 */
class ObsidianAssetRepository extends AbstractFileRepository_1.AbstractFileRepository {
    constructor(app) {
        super(app);
    }
    async findById(id) {
        const files = this.app.vault.getMarkdownFiles();
        for (const file of files) {
            const cache = this.app.metadataCache.getFileCache(file);
            if (cache?.frontmatter?.["exo__Asset_uid"] === id.toString()) {
                const asset = Asset_1.Asset.fromFrontmatter(cache.frontmatter, file.basename);
                // Only return valid assets - invalid ones are silently ignored
                if (asset) {
                    return asset;
                }
            }
        }
        return null;
    }
    async findByClass(className) {
        const files = this.app.vault.getMarkdownFiles();
        const assets = [];
        for (const file of files) {
            const cache = this.app.metadataCache.getFileCache(file);
            if (cache?.frontmatter) {
                const classes = cache.frontmatter["exo__Instance_class"];
                const classArray = Array.isArray(classes) ? classes : [classes];
                if (classArray.some((c) => c === className.toWikiLink() || c === className.toString())) {
                    const asset = Asset_1.Asset.fromFrontmatter(cache.frontmatter, file.basename);
                    // Only include valid assets - invalid ones are silently ignored
                    if (asset) {
                        assets.push(asset);
                    }
                }
            }
        }
        return assets;
    }
    async findByOntology(prefix) {
        const files = this.app.vault.getMarkdownFiles();
        const assets = [];
        for (const file of files) {
            const cache = this.app.metadataCache.getFileCache(file);
            if (cache?.frontmatter) {
                const ontology = cache.frontmatter["exo__Asset_isDefinedBy"];
                const ontologyValue = ontology?.replace(/\[\[!?|\]\]/g, "");
                if (ontologyValue === prefix.toString()) {
                    const asset = Asset_1.Asset.fromFrontmatter(cache.frontmatter, file.basename);
                    // Only include valid assets - invalid ones are silently ignored
                    if (asset) {
                        assets.push(asset);
                    }
                }
            }
        }
        return assets;
    }
    async save(asset) {
        await this.saveEntityWithFrontmatter(asset, (a) => a.getTitle(), (a) => a.toFrontmatter(), (a) => this.findExistingAssetFile(a), "Asset");
    }
    findExistingAssetFile(asset) {
        const frontmatter = asset.toFrontmatter();
        const storedPath = asset.props?.filePath;
        const assetId = frontmatter["exo__Asset_uid"];
        const filename = asset.getTitle();
        return this.findFileWithFallback({
            uid: assetId,
            storedPath,
            filename,
        });
    }
    async delete(id) {
        const asset = await this.findById(id);
        if (asset) {
            await this.deleteFileByEntity(asset, (a) => a.getTitle(), "Asset");
        }
    }
    async exists(id) {
        try {
            const found = await this.findById(id);
            return found !== null;
        }
        catch (error) {
            console.error("Error checking asset existence:", error);
            return false;
        }
    }
    async findAll() {
        const files = this.app.vault.getMarkdownFiles();
        const assets = [];
        for (const file of files) {
            const cache = this.app.metadataCache.getFileCache(file);
            if (cache?.frontmatter?.["exo__Asset_uid"]) {
                const asset = Asset_1.Asset.fromFrontmatter(cache.frontmatter, file.basename);
                // Only include valid assets - invalid ones are silently ignored
                if (asset) {
                    assets.push(asset);
                }
            }
        }
        return assets;
    }
    async findByFilename(filename) {
        // Handle different filename formats
        let searchPath = filename;
        // Add .md extension if not present
        if (!searchPath.endsWith(".md")) {
            searchPath = `${searchPath}.md`;
        }
        // Try to find by path first
        let file = this.app.vault.getAbstractFileByPath(searchPath);
        // If not found, search all files by basename
        if (!file) {
            const files = this.app.vault.getMarkdownFiles();
            file =
                files.find((f) => f.path === searchPath || f.name === searchPath) ||
                    null;
        }
        if (file instanceof obsidian_1.TFile) {
            const cache = this.app.metadataCache.getFileCache(file);
            if (cache?.frontmatter) {
                const asset = Asset_1.Asset.fromFrontmatter(cache.frontmatter, file.basename);
                // Only return valid assets - invalid ones are silently ignored
                if (asset) {
                    // Store the file path for later use in save
                    asset.props.filePath = file.path;
                    return asset;
                }
            }
        }
        return null;
    }
    /**
     * Update only the frontmatter of a file by path
     */
    async updateFrontmatterByPath(filePath, updates) {
        await super.updateFrontmatterByPath(filePath, updates);
    }
}
exports.ObsidianAssetRepository = ObsidianAssetRepository;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2luZnJhc3RydWN0dXJlL3JlcG9zaXRvcmllcy9PYnNpZGlhbkFzc2V0UmVwb3NpdG9yeS50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSx1Q0FBc0M7QUFFdEMsdURBQW9EO0FBSXBELGdGQUE2RTtBQUc3RTs7O0dBR0c7QUFDSCxNQUFhLHVCQUNYLFNBQVEsK0NBQXNCO0lBRzlCLFlBQVksR0FBUTtRQUNsQixLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDYixDQUFDO0lBRUQsS0FBSyxDQUFDLFFBQVEsQ0FBQyxFQUFXO1FBQ3hCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFFaEQsS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLEVBQUU7WUFDeEIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3hELElBQUksS0FBSyxFQUFFLFdBQVcsRUFBRSxDQUFDLGdCQUFnQixDQUFDLEtBQUssRUFBRSxDQUFDLFFBQVEsRUFBRSxFQUFFO2dCQUM1RCxNQUFNLEtBQUssR0FBRyxhQUFLLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUN0RSwrREFBK0Q7Z0JBQy9ELElBQUksS0FBSyxFQUFFO29CQUNULE9BQU8sS0FBSyxDQUFDO2lCQUNkO2FBQ0Y7U0FDRjtRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVELEtBQUssQ0FBQyxXQUFXLENBQUMsU0FBb0I7UUFDcEMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUNoRCxNQUFNLE1BQU0sR0FBWSxFQUFFLENBQUM7UUFFM0IsS0FBSyxNQUFNLElBQUks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Z0JBQ3RFLCtEQUErRDtnQkFDL0QsSUFBSSxLQUFLLEVBQUU7b0JBQ1QsNENBQTRDO29CQUMzQyxLQUFhLENBQUMsS0FBSyxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO29CQUMxQyxPQUFPLEtBQUssQ0FBQztpQkFDZDthQUNGO1NBQ0Y7UUFFRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyx1QkFBdUIsQ0FDM0IsUUFBZ0IsRUFDaEIsT0FBNEI7UUFFNUIsTUFBTSxLQUFLLENBQUMsdUJBQXVCLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0lBQ3pELENBQUM7Q0FDRjtBQWxMRCwwREFrTEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2luZnJhc3RydWN0dXJlL3JlcG9zaXRvcmllcy9PYnNpZGlhbkFzc2V0UmVwb3NpdG9yeS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHAsIFRGaWxlIH0gZnJvbSBcIm9ic2lkaWFuXCI7XG5pbXBvcnQgeyBJQXNzZXRSZXBvc2l0b3J5IH0gZnJvbSBcIi4uLy4uL2RvbWFpbi9yZXBvc2l0b3JpZXMvSUFzc2V0UmVwb3NpdG9yeVwiO1xuaW1wb3J0IHsgQXNzZXQgfSBmcm9tIFwiLi4vLi4vZG9tYWluL2VudGl0aWVzL0Fzc2V0XCI7XG5pbXBvcnQgeyBBc3NldElkIH0gZnJvbSBcIi4uLy4uL2RvbWFpbi92YWx1ZS1vYmplY3RzL0Fzc2V0SWRcIjtcbmltcG9ydCB7IENsYXNzTmFtZSB9IGZyb20gXCIuLi8uLi9kb21haW4vdmFsdWUtb2JqZWN0cy9DbGFzc05hbWVcIjtcbmltcG9ydCB7IE9udG9sb2d5UHJlZml4IH0gZnJvbSBcIi4uLy4uL2RvbWFpbi92YWx1ZS1vYmplY3RzL09udG9sb2d5UHJlZml4XCI7XG5pbXBvcnQgeyBBYnN0cmFjdEZpbGVSZXBvc2l0b3J5IH0gZnJvbSBcIi4uLy4uL3NoYXJlZC9BYnN0cmFjdEZpbGVSZXBvc2l0b3J5XCI7XG5pbXBvcnQgeyBGaWxlT3BlcmF0aW9uVXRpbHMgfSBmcm9tIFwiLi4vLi4vc2hhcmVkL3V0aWxzL0ZpbGVPcGVyYXRpb25VdGlsc1wiO1xuXG4vKipcbiAqIE9ic2lkaWFuIGltcGxlbWVudGF0aW9uIG9mIElBc3NldFJlcG9zaXRvcnlcbiAqIEhhbmRsZXMgYXNzZXQgcGVyc2lzdGVuY2UgdXNpbmcgT2JzaWRpYW4gdmF1bHRcbiAqL1xuZXhwb3J0IGNsYXNzIE9ic2lkaWFuQXNzZXRSZXBvc2l0b3J5XG4gIGV4dGVuZHMgQWJzdHJhY3RGaWxlUmVwb3NpdG9yeVxuICBpbXBsZW1lbnRzIElBc3NldFJlcG9zaXRvcnlcbntcbiAgY29uc3RydWN0b3IoYXBwOiBBcHApIHtcbiAgICBzdXBlcihhcHApO1xuICB9XG5cbiAgYXN5bmMgZmluZEJ5SWQoaWQ6IEFzc2V0SWQpOiBQcm9taXNlPEFzc2V0IHwgbnVsbD4ge1xuICAgIGNvbnN0IGZpbGVzID0gdGhpcy5hcHAudmF1bHQuZ2V0TWFya2Rvd25GaWxlcygpO1xuXG4gICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICBjb25zdCBjYWNoZSA9IHRoaXMuYXBwLm1ldGFkYXRhQ2FjaGUuZ2V0RmlsZUNhY2hlKGZpbGUpO1xuICAgICAgaWYgKGNhY2hlPy5mcm9udG1hdHRlcj8uW1wiZXhvX19Bc3NldF91aWRcIl0gPT09IGlkLnRvU3RyaW5nKCkpIHtcbiAgICAgICAgY29uc3QgYXNzZXQgPSBBc3NldC5mcm9tRnJvbnRtYXR0ZXIoY2FjaGUuZnJvbnRtYXR0ZXIsIGZpbGUuYmFzZW5hbWUpO1xuICAgICAgICAvLyBPbmx5IHJldHVybiB2YWxpZCBhc3NldHMgLSBpbnZhbGlkIG9uZXMgYXJlIHNpbGVudGx5IGlnbm9yZWRcbiAgICAgICAgaWYgKGFzc2V0KSB7XG4gICAgICAgICAgcmV0dXJuIGFzc2V0O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBhc3luYyBmaW5kQnlDbGFzcyhjbGFzc05hbWU6IENsYXNzTmFtZSk6IFByb21pc2U8QXNzZXRbXT4ge1xuICAgIGNvbnN0IGZpbGVzID0gdGhpcy5hcHAudmF1bHQuZ2V0TWFya2Rvd25GaWxlcygpO1xuICAgIGNvbnN0IGFzc2V0czogQXNzZXRbXSA9IFtdO1xuXG4gICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICBjb25zdCBjYWNoZSA9IHRoaXMuYXBwLm1ldGFkYXRhQ2FjaGUuZ2V0RmlsZUNhY2hlKGZpbGUpO1xuICAgICAgaWYgKGNhY2hlPy5mcm9udG1hdHRlcikge1xuICAgICAgICBjb25zdCBjbGFzc2VzID0gY2FjaGUuZnJvbnRtYXR0ZXJbXCJleG9fX0luc3RhbmNlX2NsYXNzXCJdO1xuICAgICAgICBjb25zdCBjbGFzc0FycmF5ID0gQXJyYXkuaXNBcnJheShjbGFzc2VzKSA/IGNsYXNzZXMgOiBbY2xhc3Nlc107XG5cbiAgICAgICAgaWYgKFxuICAgICAgICAgIGNsYXNzQXJyYXkuc29tZShcbiAgICAgICAgICAgIChjKSA9PiBjID09PSBjbGFzc05hbWUudG9XaWtpTGluaygpIHx8IGMgPT09IGNsYXNzTmFtZS50b1N0cmluZygpLFxuICAgICAgICAgIClcbiAgICAgICAgKSB7XG4gICAgICAgICAgY29uc3QgYXNzZXQgPSBBc3NldC5mcm9tRnJvbnRtYXR0ZXIoY2FjaGUuZnJvbnRtYXR0ZXIsIGZpbGUuYmFzZW5hbWUpO1xuICAgICAgICAgIC8vIE9ubHkgaW5jbHVkZSB2YWxpZCBhc3NldHMgLSBpbnZhbGlkIG9uZXMgYXJlIHNpbGVudGx5IGlnbm9yZWRcbiAgICAgICAgICBpZiAoYXNzZXQpIHtcbiAgICAgICAgICAgIGFzc2V0cy5wdXNoKGFzc2V0KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gYXNzZXRzO1xuICB9XG5cbiAgYXN5bmMgZmluZEJ5T250b2xvZ3kocHJlZml4OiBPbnRvbG9neVByZWZpeCk6IFByb21pc2U8QXNzZXRbXT4ge1xuICAgIGNvbnN0IGZpbGVzID0gdGhpcy5hcHAudmF1bHQuZ2V0TWFya2Rvd25GaWxlcygpO1xuICAgIGNvbnN0IGFzc2V0czogQXNzZXRbXSA9IFtdO1xuXG4gICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICBjb25zdCBjYWNoZSA9IHRoaXMuYXBwLm1ldGFkYXRhQ2FjaGUuZ2V0RmlsZUNhY2hlKGZpbGUpO1xuICAgICAgaWYgKGNhY2hlPy5mcm9udG1hdHRlcikge1xuICAgICAgICBjb25zdCBvbnRvbG9neSA9IGNhY2hlLmZyb250bWF0dGVyW1wiZXhvX19Bc3NldF9pc0RlZmluZWRCeVwiXTtcbiAgICAgICAgY29uc3Qgb250b2xvZ3lWYWx1ZSA9IG9udG9sb2d5Py5yZXBsYWNlKC9cXFtcXFshP3xcXF1cXF0vZywgXCJcIik7XG5cbiAgICAgICAgaWYgKG9udG9sb2d5VmFsdWUgPT09IHByZWZpeC50b1N0cmluZygpKSB7XG4gICAgICAgICAgY29uc3QgYXNzZXQgPSBBc3NldC5mcm9tRnJvbnRtYXR0ZXIoY2FjaGUuZnJvbnRtYXR0ZXIsIGZpbGUuYmFzZW5hbWUpO1xuICAgICAgICAgIC8vIE9ubHkgaW5jbHVkZSB2YWxpZCBhc3NldHMgLSBpbnZhbGlkIG9uZXMgYXJlIHNpbGVudGx5IGlnbm9yZWRcbiAgICAgICAgICBpZiAoYXNzZXQpIHtcbiAgICAgICAgICAgIGFzc2V0cy5wdXNoKGFzc2V0KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gYXNzZXRzO1xuICB9XG5cbiAgYXN5bmMgc2F2ZShhc3NldDogQXNzZXQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLnNhdmVFbnRpdHlXaXRoRnJvbnRtYXR0ZXIoXG4gICAgICBhc3NldCxcbiAgICAgIChhKSA9PiBhLmdldFRpdGxlKCksXG4gICAgICAoYSkgPT4gYS50b0Zyb250bWF0dGVyKCksXG4gICAgICAoYSkgPT4gdGhpcy5maW5kRXhpc3RpbmdBc3NldEZpbGUoYSksXG4gICAgICBcIkFzc2V0XCIsXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZmluZEV4aXN0aW5nQXNzZXRGaWxlKGFzc2V0OiBBc3NldCk6IFRGaWxlIHwgbnVsbCB7XG4gICAgY29uc3QgZnJvbnRtYXR0ZXIgPSBhc3NldC50b0Zyb250bWF0dGVyKCk7XG4gICAgY29uc3Qgc3RvcmVkUGF0aCA9IChhc3NldCBhcyBhbnkpLnByb3BzPy5maWxlUGF0aDtcbiAgICBjb25zdCBhc3NldElkID0gZnJvbnRtYXR0ZXJbXCJleG9fX0Fzc2V0X3VpZFwiXTtcbiAgICBjb25zdCBmaWxlbmFtZSA9IGFzc2V0LmdldFRpdGxlKCk7XG5cbiAgICByZXR1cm4gdGhpcy5maW5kRmlsZVdpdGhGYWxsYmFjayh7XG4gICAgICB1aWQ6IGFzc2V0SWQsXG4gICAgICBzdG9yZWRQYXRoLFxuICAgICAgZmlsZW5hbWUsXG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBkZWxldGUoaWQ6IEFzc2V0SWQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBhc3NldCA9IGF3YWl0IHRoaXMuZmluZEJ5SWQoaWQpO1xuICAgIGlmIChhc3NldCkge1xuICAgICAgYXdhaXQgdGhpcy5kZWxldGVGaWxlQnlFbnRpdHkoYXNzZXQsIChhKSA9PiBhLmdldFRpdGxlKCksIFwiQXNzZXRcIik7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZXhpc3RzKGlkOiBBc3NldElkKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZvdW5kID0gYXdhaXQgdGhpcy5maW5kQnlJZChpZCk7XG4gICAgICByZXR1cm4gZm91bmQgIT09IG51bGw7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBjaGVja2luZyBhc3NldCBleGlzdGVuY2U6XCIsIGVycm9yKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBmaW5kQWxsKCk6IFByb21pc2U8QXNzZXRbXT4ge1xuICAgIGNvbnN0IGZpbGVzID0gdGhpcy5hcHAudmF1bHQuZ2V0TWFya2Rvd25GaWxlcygpO1xuICAgIGNvbnN0IGFzc2V0czogQXNzZXRbXSA9IFtdO1xuXG4gICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICBjb25zdCBjYWNoZSA9IHRoaXMuYXBwLm1ldGFkYXRhQ2FjaGUuZ2V0RmlsZUNhY2hlKGZpbGUpO1xuICAgICAgaWYgKGNhY2hlPy5mcm9udG1hdHRlcj8uW1wiZXhvX19Bc3NldF91aWRcIl0pIHtcbiAgICAgICAgY29uc3QgYXNzZXQgPSBBc3NldC5mcm9tRnJvbnRtYXR0ZXIoY2FjaGUuZnJvbnRtYXR0ZXIsIGZpbGUuYmFzZW5hbWUpO1xuICAgICAgICAvLyBPbmx5IGluY2x1ZGUgdmFsaWQgYXNzZXRzIC0gaW52YWxpZCBvbmVzIGFyZSBzaWxlbnRseSBpZ25vcmVkXG4gICAgICAgIGlmIChhc3NldCkge1xuICAgICAgICAgIGFzc2V0cy5wdXNoKGFzc2V0KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBhc3NldHM7XG4gIH1cblxuICBhc3luYyBmaW5kQnlGaWxlbmFtZShmaWxlbmFtZTogc3RyaW5nKTogUHJvbWlzZTxBc3NldCB8IG51bGw+IHtcbiAgICAvLyBIYW5kbGUgZGlmZmVyZW50IGZpbGVuYW1lIGZvcm1hdHNcbiAgICBsZXQgc2VhcmNoUGF0aCA9IGZpbGVuYW1lO1xuXG4gICAgLy8gQWRkIC5tZCBleHRlbnNpb24gaWYgbm90IHByZXNlbnRcbiAgICBpZiAoIXNlYXJjaFBhdGguZW5kc1dpdGgoXCIubWRcIikpIHtcbiAgICAgIHNlYXJjaFBhdGggPSBgJHtzZWFyY2hQYXRofS5tZGA7XG4gICAgfVxuXG4gICAgLy8gVHJ5IHRvIGZpbmQgYnkgcGF0aCBmaXJzdFxuICAgIGxldCBmaWxlID0gdGhpcy5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKHNlYXJjaFBhdGgpO1xuXG4gICAgLy8gSWYgbm90IGZvdW5kLCBzZWFyY2ggYWxsIGZpbGVzIGJ5IGJhc2VuYW1lXG4gICAgaWYgKCFmaWxlKSB7XG4gICAgICBjb25zdCBmaWxlcyA9IHRoaXMuYXBwLnZhdWx0LmdldE1hcmtkb3duRmlsZXMoKTtcbiAgICAgIGZpbGUgPVxuICAgICAgICBmaWxlcy5maW5kKChmKSA9PiBmLnBhdGggPT09IHNlYXJjaFBhdGggfHwgZi5uYW1lID09PSBzZWFyY2hQYXRoKSB8fFxuICAgICAgICBudWxsO1xuICAgIH1cblxuICAgIGlmIChmaWxlIGluc3RhbmNlb2YgVEZpbGUpIHtcbiAgICAgIGNvbnN0IGNhY2hlID0gdGhpcy5hcHAubWV0YWRhdGFDYWNoZS5nZXRGaWxlQ2FjaGUoZmlsZSk7XG4gICAgICBpZiAoY2FjaGU/LmZyb250bWF0dGVyKSB7XG4gICAgICAgIGNvbnN0IGFzc2V0ID0gQXNzZXQuZnJvbUZyb250bWF0dGVyKGNhY2hlLmZyb250bWF0dGVyLCBmaWxlLmJhc2VuYW1lKTtcbiAgICAgICAgLy8gT25seSByZXR1cm4gdmFsaWQgYXNzZXRzIC0gaW52YWxpZCBvbmVzIGFyZSBzaWxlbnRseSBpZ25vcmVkXG4gICAgICAgIGlmIChhc3NldCkge1xuICAgICAgICAgIC8vIFN0b3JlIHRoZSBmaWxlIHBhdGggZm9yIGxhdGVyIHVzZSBpbiBzYXZlXG4gICAgICAgICAgKGFzc2V0IGFzIGFueSkucHJvcHMuZmlsZVBhdGggPSBmaWxlLnBhdGg7XG4gICAgICAgICAgcmV0dXJuIGFzc2V0O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIG9ubHkgdGhlIGZyb250bWF0dGVyIG9mIGEgZmlsZSBieSBwYXRoXG4gICAqL1xuICBhc3luYyB1cGRhdGVGcm9udG1hdHRlckJ5UGF0aChcbiAgICBmaWxlUGF0aDogc3RyaW5nLFxuICAgIHVwZGF0ZXM6IFJlY29yZDxzdHJpbmcsIGFueT4sXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHN1cGVyLnVwZGF0ZUZyb250bWF0dGVyQnlQYXRoKGZpbGVQYXRoLCB1cGRhdGVzKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9