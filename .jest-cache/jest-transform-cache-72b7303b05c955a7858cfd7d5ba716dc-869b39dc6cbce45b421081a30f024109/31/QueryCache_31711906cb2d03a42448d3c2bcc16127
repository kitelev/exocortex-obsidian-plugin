c998a1be9063c530a5b67d319eae1b76
"use strict";
/**
 * SPARQL Query Cache Service
 * Provides in-memory caching for SPARQL query results with TTL and cache invalidation
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.QueryCache = exports.DEFAULT_CACHE_CONFIG = void 0;
exports.DEFAULT_CACHE_CONFIG = {
    maxSize: 1000,
    defaultTTL: 5 * 60 * 1000,
    maxTTL: 30 * 60 * 1000,
    cleanupInterval: 60 * 1000,
    enabled: true,
};
class QueryCache {
    constructor(config = {}) {
        this.config = { ...exports.DEFAULT_CACHE_CONFIG, ...config };
        this.cache = new Map();
        this.stats = {
            hits: 0,
            misses: 0,
            evictions: 0,
            totalQueries: 0,
            hitRate: 0,
            size: 0,
            maxSize: this.config.maxSize,
        };
        this.startCleanupTimer();
    }
    /**
     * Get cached result for a query
     */
    get(queryKey) {
        if (!this.config.enabled) {
            this.stats.misses++;
            this.stats.totalQueries++;
            this.updateHitRate();
            return null;
        }
        const entry = this.cache.get(queryKey);
        this.stats.totalQueries++;
        if (!entry) {
            this.stats.misses++;
            this.updateHitRate();
            return null;
        }
        // Check if entry has expired
        if (Date.now() > entry.expiresAt) {
            this.cache.delete(queryKey);
            this.stats.misses++;
            this.stats.evictions++;
            this.updateStats();
            this.updateHitRate();
            return null;
        }
        this.stats.hits++;
        this.updateHitRate();
        return entry.value;
    }
    /**
     * Set cached result for a query
     */
    set(queryKey, value, ttl) {
        if (!this.config.enabled) {
            return;
        }
        const requestedTTL = ttl !== undefined ? ttl : this.config.defaultTTL;
        const effectiveTTL = Math.min(Math.max(requestedTTL, 0), this.config.maxTTL);
        const now = Date.now();
        // Don't cache if TTL is zero or negative
        if (effectiveTTL <= 0) {
            return;
        }
        // Evict oldest entries if cache is full
        while (this.cache.size >= this.config.maxSize) {
            this.evictOldest();
        }
        const entry = {
            value,
            timestamp: now,
            expiresAt: now + effectiveTTL,
            queryHash: this.hashQuery(queryKey),
        };
        this.cache.set(queryKey, entry);
        this.updateStats();
    }
    /**
     * Normalize and create cache key from SPARQL query
     */
    createCacheKey(query) {
        // First split on the colon to handle prefix separately if it exists
        const colonIndex = query.indexOf(":");
        let prefix = "";
        let queryPart = query;
        if (colonIndex > 0 && colonIndex < 20) {
            // Assume prefix is short
            prefix = query.substring(0, colonIndex).toLowerCase() + ":";
            queryPart = query.substring(colonIndex + 1);
        }
        // Normalize the query by removing extra whitespace and converting to lowercase
        const normalized = queryPart
            .trim() // Remove leading/trailing whitespace first
            .replace(/[\r\n\t]+/g, " ") // Replace newlines and tabs with spaces
            .replace(/\s+/g, " ") // Replace multiple spaces with single space
            .replace(/\s*\{\s*/g, " { ") // Normalize spacing around curly braces
            .replace(/\s*\}\s*/g, " } ")
            .replace(/\s*\(\s*/g, " ( ") // Normalize spacing around parentheses
            .replace(/\s*\)\s*/g, " ) ")
            .replace(/\s+/g, " ") // Clean up spaces again
            .trim() // Trim again after replacements
            .toLowerCase(); // Convert to lowercase for case-insensitive matching
        const fullKey = prefix + normalized;
        // Use the normalized string directly as the key for better consistency
        // Only hash very long queries
        if (fullKey.length > 1000) {
            return this.hashQuery(fullKey);
        }
        return fullKey;
    }
    /**
     * Invalidate all cached entries
     */
    invalidateAll() {
        const sizeBefore = this.cache.size;
        this.cache.clear();
        this.stats.evictions += sizeBefore;
        this.updateStats();
    }
    /**
     * Invalidate entries based on a predicate function
     */
    invalidateWhere(predicate) {
        let invalidated = 0;
        for (const [key, entry] of this.cache.entries()) {
            if (predicate(key, entry)) {
                this.cache.delete(key);
                invalidated++;
            }
        }
        this.stats.evictions += invalidated;
        this.updateStats();
        return invalidated;
    }
    /**
     * Get current cache statistics
     */
    getStatistics() {
        return { ...this.stats };
    }
    /**
     * Update cache configuration
     */
    updateConfig(newConfig) {
        this.config = { ...this.config, ...newConfig };
        this.stats.maxSize = this.config.maxSize;
        // If cache is disabled, clear it
        if (!this.config.enabled) {
            this.invalidateAll();
        }
        // If max size reduced, evict entries
        while (this.cache.size > this.config.maxSize) {
            this.evictOldest();
        }
        this.updateStats();
        // Restart cleanup timer if interval changed
        if (newConfig.cleanupInterval !== undefined) {
            this.stopCleanupTimer();
            this.startCleanupTimer();
        }
    }
    /**
     * Get current configuration
     */
    getConfig() {
        return { ...this.config };
    }
    /**
     * Manually trigger cleanup of expired entries
     */
    cleanup() {
        const now = Date.now();
        let cleaned = 0;
        for (const [key, entry] of this.cache.entries()) {
            if (now > entry.expiresAt) {
                this.cache.delete(key);
                cleaned++;
            }
        }
        if (cleaned > 0) {
            this.stats.evictions += cleaned;
            this.updateStats();
        }
        return cleaned;
    }
    /**
     * Check if a query result is cached
     */
    has(queryKey) {
        if (!this.config.enabled) {
            return false;
        }
        const entry = this.cache.get(queryKey);
        if (!entry) {
            return false;
        }
        // Check if expired
        if (Date.now() > entry.expiresAt) {
            this.cache.delete(queryKey);
            this.stats.evictions++;
            this.updateStats();
            return false;
        }
        return true;
    }
    /**
     * Destroy the cache and cleanup resources
     */
    destroy() {
        this.stopCleanupTimer();
        this.cache.clear();
    }
    // Private methods
    hashQuery(query) {
        // Simple hash function for query strings
        let hash = 0;
        if (query.length === 0)
            return hash.toString();
        for (let i = 0; i < query.length; i++) {
            const char = query.charCodeAt(i);
            hash = (hash << 5) - hash + char;
            hash = hash & hash; // Convert to 32-bit integer
        }
        return Math.abs(hash).toString();
    }
    evictOldest() {
        let oldestKey = null;
        let oldestTimestamp = Infinity;
        for (const [key, entry] of this.cache.entries()) {
            if (entry.timestamp < oldestTimestamp) {
                oldestTimestamp = entry.timestamp;
                oldestKey = key;
            }
        }
        if (oldestKey) {
            this.cache.delete(oldestKey);
            this.stats.evictions++;
            this.updateStats();
        }
    }
    updateStats() {
        this.stats.size = this.cache.size;
    }
    updateHitRate() {
        this.stats.hitRate =
            this.stats.totalQueries > 0
                ? (this.stats.hits / this.stats.totalQueries) * 100
                : 0;
    }
    startCleanupTimer() {
        if (this.config.cleanupInterval > 0) {
            this.cleanupTimer = setInterval(() => {
                this.cleanup();
            }, this.config.cleanupInterval);
        }
    }
    stopCleanupTimer() {
        if (this.cleanupTimer) {
            clearInterval(this.cleanupTimer);
            this.cleanupTimer = undefined;
        }
    }
}
exports.QueryCache = QueryCache;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2FwcGxpY2F0aW9uL3NlcnZpY2VzL1F1ZXJ5Q2FjaGUudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7O0FBMkJVLFFBQUEsb0JBQW9CLEdBQXFCO0lBQ3BELE9BQU8sRUFBRSxJQUFJO0lBQ2IsVUFBVSxFQUFFLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSTtJQUN6QixNQUFNLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJO0lBQ3RCLGVBQWUsRUFBRSxFQUFFLEdBQUcsSUFBSTtJQUMxQixPQUFPLEVBQUUsSUFBSTtDQUNkLENBQUM7QUFFRixNQUFhLFVBQVU7SUFNckIsWUFBWSxTQUFvQyxFQUFFO1FBQ2hELElBQUksQ0FBQyxNQUFNLEdBQUcsRUFBRSxHQUFHLDRCQUFvQixFQUFFLEdBQUcsTUFBTSxFQUFFLENBQUM7UUFDckQsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxLQUFLLEdBQUc7WUFDWCxJQUFJLEVBQUUsQ0FBQztZQUNQLE1BQU0sRUFBRSxDQUFDO1lBQ1QsU0FBUyxFQUFFLENBQUM7WUFDWixZQUFZLEVBQUUsQ0FBQztZQUNmLE9BQU8sRUFBRSxDQUFDO1lBQ1YsSUFBSSxFQUFFLENBQUM7WUFDUCxPQUFPLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPO1NBQzdCLENBQUM7UUFFRixJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztJQUMzQixDQUFDO0lBRUQ7O09BRUc7SUFDSCxHQUFHLENBQUksUUFBZ0I7UUFDckIsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFO1lBQ3hCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDcEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUMxQixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDckIsT0FBTyxJQUFJLENBQUM7U0FDYjtRQUVELE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3ZDLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxFQUFFLENBQUM7UUFFMUIsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNWLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDcEIsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ3JCLE9BQU8sSUFBSSxDQUFDO1NBQ2I7UUFFRCw2QkFBNkI7UUFDN0IsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsS0FBSyxDQUFDLFNBQVMsRUFBRTtZQUNoQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUM1QixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ3BCLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUM7WUFDdkIsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ25CLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUNyQixPQUFPLElBQUksQ0FBQztTQUNiO1FBRUQsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNsQixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDckIsT0FBTyxLQUFLLENBQUMsS0FBSyxDQUFDO0lBQ3JCLENBQUM7SUFFRDs7T0FFRztJQUNILEdBQUcsQ0FBSSxRQUFnQixFQUFFLEtBQVEsRUFBRSxHQUFZO1FBQzdDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRTtZQUN4QixPQUFPO1NBQ1I7UUFFRCxNQUFNLFlBQVksR0FBRyxHQUFHLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDO1FBQ3RFLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQzNCLElBQUksQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQyxFQUN6QixJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FDbkIsQ0FBQztRQUVGLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUV2Qix5Q0FBeUM7UUFDekMsSUFBSSxZQUFZLElBQUksQ0FBQyxFQUFFO1lBQ3JCLE9BQU87U0FDUjtRQUVELHdDQUF3QztRQUN4QyxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFO1lBQzdDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUNwQjtRQUVELE1BQU0sS0FBSyxHQUFrQjtZQUMzQixLQUFLO1lBQ0wsU0FBUyxFQUFFLEdBQUc7WUFDZCxTQUFTLEVBQUUsR0FBRyxHQUFHLFlBQVk7WUFDN0IsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDO1NBQ3BDLENBQUM7UUFFRixJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDaEMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3JCLENBQUM7SUFFRDs7T0FFRztJQUNILGNBQWMsQ0FBQyxLQUFhO1FBQzFCLG9FQUFvRTtRQUNwRSxNQUFNLFVBQVUsR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3RDLElBQUksTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUNoQixJQUFJLFNBQVMsR0FBRyxLQUFLLENBQUM7UUFFdEIsSUFBSSxVQUFVLEdBQUcsQ0FBQyxJQUFJLFVBQVUsR0FBRyxFQUFFLEVBQUU7WUFDckMseUJBQXlCO1lBQ3pCLE1BQU0sR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxVQUFVLENBQUMsQ0FBQyxXQUFXLEVBQUUsR0FBRyxHQUFHLENBQUM7WUFDNUQsU0FBUyxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQzdDO1FBRUQsK0VBQStFO1FBQy9FLE1BQU0sVUFBVSxHQUFHLFNBQVM7YUFDekIsSUFBSSxFQUFFLENBQUMsMkNBQTJDO2FBQ2xELE9BQU8sQ0FBQyxZQUFZLEVBQUUsR0FBRyxDQUFDLENBQUMsd0NBQXdDO2FBQ25FLE9BQU8sQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUMsNENBQTRDO2FBQ2pFLE9BQU8sQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLENBQUMsd0NBQXdDO2FBQ3BFLE9BQU8sQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDO2FBQzNCLE9BQU8sQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDLENBQUMsdUNBQXVDO2FBQ25FLE9BQU8sQ0FBQyxXQUFXLEVBQUUsS0FBSyxDQUFDO2FBQzNCLE9BQU8sQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUMsd0JBQXdCO2FBQzdDLElBQUksRUFBRSxDQUFDLGdDQUFnQzthQUN2QyxXQUFXLEVBQUUsQ0FBQyxDQUFDLHFEQUFxRDtRQUV2RSxNQUFNLE9BQU8sR0FBRyxNQUFNLEdBQUcsVUFBVSxDQUFDO1FBRXBDLHVFQUF1RTtRQUN2RSw4QkFBOEI7UUFDOUIsSUFBSSxPQUFPLENBQUMsTUFBTSxHQUFHLElBQUksRUFBRTtZQUN6QixPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDaEM7UUFDRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0lBRUQ7O09BRUc7SUFDSCxhQUFhO1FBQ1gsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUM7UUFDbkMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNuQixJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsSUFBSSxVQUFVLENBQUM7UUFDbkMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3JCLENBQUM7SUFFRDs7T0FFRztJQUNILGVBQWUsQ0FDYixTQUEyRDtRQUUzRCxJQUFJLFdBQVcsR0FBRyxDQUFDLENBQUM7UUFFcEIsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFDL0MsSUFBSSxTQUFTLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxFQUFFO2dCQUN6QixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDdkIsV0FBVyxFQUFFLENBQUM7YUFDZjtTQUNGO1FBRUQsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLElBQUksV0FBVyxDQUFDO1FBQ3BDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNuQixPQUFPLFdBQVcsQ0FBQztJQUNyQixDQUFDO0lBRUQ7O09BRUc7SUFDSCxhQUFhO1FBQ1gsT0FBTyxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFFRDs7T0FFRztJQUNILFlBQVksQ0FBQyxTQUFvQztRQUMvQyxJQUFJLENBQUMsTUFBTSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsU0FBUyxFQUFFLENBQUM7UUFDL0MsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUM7UUFFekMsaUNBQWlDO1FBQ2pDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRTtZQUN4QixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7U0FDdEI7UUFFRCxxQ0FBcUM7UUFDckMsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRTtZQUM1QyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7U0FDcEI7UUFDRCxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7UUFFbkIsNENBQTRDO1FBQzVDLElBQUksU0FBUyxDQUFDLGVBQWUsS0FBSyxTQUFTLEVBQUU7WUFDM0MsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDeEIsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7U0FDMUI7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxTQUFTO1FBQ1AsT0FBTyxFQUFFLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO0lBQzVCLENBQUM7SUFFRDs7T0FFRztJQUNILE9BQU87UUFDTCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDdkIsSUFBSSxPQUFPLEdBQUcsQ0FBQyxDQUFDO1FBRWhCLEtBQUssTUFBTSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxFQUFFO1lBQy9DLElBQUksR0FBRyxHQUFHLEtBQUssQ0FBQyxTQUFTLEVBQUU7Z0JBQ3pCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUN2QixPQUFPLEVBQUUsQ0FBQzthQUNYO1NBQ0Y7UUFFRCxJQUFJLE9BQU8sR0FBRyxDQUFDLEVBQUU7WUFDZixJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsSUFBSSxPQUFPLENBQUM7WUFDaEMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1NBQ3BCO1FBRUQsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsR0FBRyxDQUFDLFFBQWdCO1FBQ2xCLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRTtZQUN4QixPQUFPLEtBQUssQ0FBQztTQUNkO1FBRUQsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDdkMsSUFBSSxDQUFDLEtBQUssRUFBRTtZQUNWLE9BQU8sS0FBSyxDQUFDO1NBQ2Q7UUFFRCxtQkFBbUI7UUFDbkIsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsS0FBSyxDQUFDLFNBQVMsRUFBRTtZQUNoQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUM1QixJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ3ZCLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNuQixPQUFPLEtBQUssQ0FBQztTQUNkO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxPQUFPO1FBQ0wsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDeEIsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNyQixDQUFDO0lBRUQsa0JBQWtCO0lBRVYsU0FBUyxDQUFDLEtBQWE7UUFDN0IseUNBQXlDO1FBQ3pDLElBQUksSUFBSSxHQUFHLENBQUMsQ0FBQztRQUNiLElBQUksS0FBSyxDQUFDLE1BQU0sS0FBSyxDQUFDO1lBQUUsT0FBTyxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7UUFFL0MsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7WUFDckMsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNqQyxJQUFJLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQztZQUNqQyxJQUFJLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLDRCQUE0QjtTQUNqRDtRQUVELE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNuQyxDQUFDO0lBRU8sV0FBVztRQUNqQixJQUFJLFNBQVMsR0FBa0IsSUFBSSxDQUFDO1FBQ3BDLElBQUksZUFBZSxHQUFHLFFBQVEsQ0FBQztRQUUvQixLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsRUFBRTtZQUMvQyxJQUFJLEtBQUssQ0FBQyxTQUFTLEdBQUcsZUFBZSxFQUFFO2dCQUNyQyxlQUFlLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQztnQkFDbEMsU0FBUyxHQUFHLEdBQUcsQ0FBQzthQUNqQjtTQUNGO1FBRUQsSUFBSSxTQUFTLEVBQUU7WUFDYixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUM3QixJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ3ZCLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUNwQjtJQUNILENBQUM7SUFFTyxXQUFXO1FBQ2pCLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDO0lBQ3BDLENBQUM7SUFFTyxhQUFhO1FBQ25CLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTztZQUNoQixJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksR0FBRyxDQUFDO2dCQUN6QixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxHQUFHLEdBQUc7Z0JBQ25ELENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDVixDQUFDO0lBRU8saUJBQWlCO1FBQ3ZCLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxlQUFlLEdBQUcsQ0FBQyxFQUFFO1lBQ25DLElBQUksQ0FBQyxZQUFZLEdBQUcsV0FBVyxDQUFDLEdBQUcsRUFBRTtnQkFDbkMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ2pCLENBQUMsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1NBQ2pDO0lBQ0gsQ0FBQztJQUVPLGdCQUFnQjtRQUN0QixJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDckIsYUFBYSxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUNqQyxJQUFJLENBQUMsWUFBWSxHQUFHLFNBQVMsQ0FBQztTQUMvQjtJQUNILENBQUM7Q0FDRjtBQTFURCxnQ0EwVEMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2FwcGxpY2F0aW9uL3NlcnZpY2VzL1F1ZXJ5Q2FjaGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBTUEFSUUwgUXVlcnkgQ2FjaGUgU2VydmljZVxuICogUHJvdmlkZXMgaW4tbWVtb3J5IGNhY2hpbmcgZm9yIFNQQVJRTCBxdWVyeSByZXN1bHRzIHdpdGggVFRMIGFuZCBjYWNoZSBpbnZhbGlkYXRpb25cbiAqL1xuXG5leHBvcnQgaW50ZXJmYWNlIENhY2hlRW50cnk8VD4ge1xuICB2YWx1ZTogVDtcbiAgdGltZXN0YW1wOiBudW1iZXI7XG4gIGV4cGlyZXNBdDogbnVtYmVyO1xuICBxdWVyeUhhc2g6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBDYWNoZVN0YXRpc3RpY3Mge1xuICBoaXRzOiBudW1iZXI7XG4gIG1pc3NlczogbnVtYmVyO1xuICBldmljdGlvbnM6IG51bWJlcjtcbiAgdG90YWxRdWVyaWVzOiBudW1iZXI7XG4gIGhpdFJhdGU6IG51bWJlcjtcbiAgc2l6ZTogbnVtYmVyO1xuICBtYXhTaXplOiBudW1iZXI7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUXVlcnlDYWNoZUNvbmZpZyB7XG4gIG1heFNpemU6IG51bWJlcjsgLy8gTWF4aW11bSBudW1iZXIgb2YgY2FjaGVkIGVudHJpZXNcbiAgZGVmYXVsdFRUTDogbnVtYmVyOyAvLyBEZWZhdWx0IFRUTCBpbiBtaWxsaXNlY29uZHNcbiAgbWF4VFRMOiBudW1iZXI7IC8vIE1heGltdW0gVFRMIGluIG1pbGxpc2Vjb25kc1xuICBjbGVhbnVwSW50ZXJ2YWw6IG51bWJlcjsgLy8gQ2xlYW51cCBpbnRlcnZhbCBpbiBtaWxsaXNlY29uZHNcbiAgZW5hYmxlZDogYm9vbGVhbjsgLy8gV2hldGhlciBjYWNoaW5nIGlzIGVuYWJsZWRcbn1cblxuZXhwb3J0IGNvbnN0IERFRkFVTFRfQ0FDSEVfQ09ORklHOiBRdWVyeUNhY2hlQ29uZmlnID0ge1xuICBtYXhTaXplOiAxMDAwLFxuICBkZWZhdWx0VFRMOiA1ICogNjAgKiAxMDAwLCAvLyA1IG1pbnV0ZXNcbiAgbWF4VFRMOiAzMCAqIDYwICogMTAwMCwgLy8gMzAgbWludXRlc1xuICBjbGVhbnVwSW50ZXJ2YWw6IDYwICogMTAwMCwgLy8gMSBtaW51dGVcbiAgZW5hYmxlZDogdHJ1ZSxcbn07XG5cbmV4cG9ydCBjbGFzcyBRdWVyeUNhY2hlIHtcbiAgcHJpdmF0ZSBjYWNoZTogTWFwPHN0cmluZywgQ2FjaGVFbnRyeTxhbnk+PjtcbiAgcHJpdmF0ZSBzdGF0czogQ2FjaGVTdGF0aXN0aWNzO1xuICBwcml2YXRlIGNvbmZpZzogUXVlcnlDYWNoZUNvbmZpZztcbiAgcHJpdmF0ZSBjbGVhbnVwVGltZXI/OiBSZXR1cm5UeXBlPHR5cGVvZiBzZXRUaW1lb3V0PjtcblxuICBjb25zdHJ1Y3Rvcihjb25maWc6IFBhcnRpYWw8UXVlcnlDYWNoZUNvbmZpZz4gPSB7fSkge1xuICAgIHRoaXMuY29uZmlnID0geyAuLi5ERUZBVUxUX0NBQ0hFX0NPTkZJRywgLi4uY29uZmlnIH07XG4gICAgdGhpcy5jYWNoZSA9IG5ldyBNYXAoKTtcbiAgICB0aGlzLnN0YXRzID0ge1xuICAgICAgaGl0czogMCxcbiAgICAgIG1pc3NlczogMCxcbiAgICAgIGV2aWN0aW9uczogMCxcbiAgICAgIHRvdGFsUXVlcmllczogMCxcbiAgICAgIGhpdFJhdGU6IDAsXG4gICAgICBzaXplOiAwLFxuICAgICAgbWF4U2l6ZTogdGhpcy5jb25maWcubWF4U2l6ZSxcbiAgICB9O1xuXG4gICAgdGhpcy5zdGFydENsZWFudXBUaW1lcigpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjYWNoZWQgcmVzdWx0IGZvciBhIHF1ZXJ5XG4gICAqL1xuICBnZXQ8VD4ocXVlcnlLZXk6IHN0cmluZyk6IFQgfCBudWxsIHtcbiAgICBpZiAoIXRoaXMuY29uZmlnLmVuYWJsZWQpIHtcbiAgICAgIHRoaXMuc3RhdHMubWlzc2VzKys7XG4gICAgICB0aGlzLnN0YXRzLnRvdGFsUXVlcmllcysrO1xuICAgICAgdGhpcy51cGRhdGVIaXRSYXRlKCk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCBlbnRyeSA9IHRoaXMuY2FjaGUuZ2V0KHF1ZXJ5S2V5KTtcbiAgICB0aGlzLnN0YXRzLnRvdGFsUXVlcmllcysrO1xuXG4gICAgaWYgKCFlbnRyeSkge1xuICAgICAgdGhpcy5zdGF0cy5taXNzZXMrKztcbiAgICAgIHRoaXMudXBkYXRlSGl0UmF0ZSgpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgZW50cnkgaGFzIGV4cGlyZWRcbiAgICBpZiAoRGF0ZS5ub3coKSA+IGVudHJ5LmV4cGlyZXNBdCkge1xuICAgICAgdGhpcy5jYWNoZS5kZWxldGUocXVlcnlLZXkpO1xuICAgICAgdGhpcy5zdGF0cy5taXNzZXMrKztcbiAgICAgIHRoaXMuc3RhdHMuZXZpY3Rpb25zKys7XG4gICAgICB0aGlzLnVwZGF0ZVN0YXRzKCk7XG4gICAgICB0aGlzLnVwZGF0ZUhpdFJhdGUoKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHRoaXMuc3RhdHMuaGl0cysrO1xuICAgIHRoaXMudXBkYXRlSGl0UmF0ZSgpO1xuICAgIHJldHVybiBlbnRyeS52YWx1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgY2FjaGVkIHJlc3VsdCBmb3IgYSBxdWVyeVxuICAgKi9cbiAgc2V0PFQ+KHF1ZXJ5S2V5OiBzdHJpbmcsIHZhbHVlOiBULCB0dGw/OiBudW1iZXIpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuY29uZmlnLmVuYWJsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCByZXF1ZXN0ZWRUVEwgPSB0dGwgIT09IHVuZGVmaW5lZCA/IHR0bCA6IHRoaXMuY29uZmlnLmRlZmF1bHRUVEw7XG4gICAgY29uc3QgZWZmZWN0aXZlVFRMID0gTWF0aC5taW4oXG4gICAgICBNYXRoLm1heChyZXF1ZXN0ZWRUVEwsIDApLFxuICAgICAgdGhpcy5jb25maWcubWF4VFRMLFxuICAgICk7XG5cbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuXG4gICAgLy8gRG9uJ3QgY2FjaGUgaWYgVFRMIGlzIHplcm8gb3IgbmVnYXRpdmVcbiAgICBpZiAoZWZmZWN0aXZlVFRMIDw9IDApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBFdmljdCBvbGRlc3QgZW50cmllcyBpZiBjYWNoZSBpcyBmdWxsXG4gICAgd2hpbGUgKHRoaXMuY2FjaGUuc2l6ZSA+PSB0aGlzLmNvbmZpZy5tYXhTaXplKSB7XG4gICAgICB0aGlzLmV2aWN0T2xkZXN0KCk7XG4gICAgfVxuXG4gICAgY29uc3QgZW50cnk6IENhY2hlRW50cnk8VD4gPSB7XG4gICAgICB2YWx1ZSxcbiAgICAgIHRpbWVzdGFtcDogbm93LFxuICAgICAgZXhwaXJlc0F0OiBub3cgKyBlZmZlY3RpdmVUVEwsXG4gICAgICBxdWVyeUhhc2g6IHRoaXMuaGFzaFF1ZXJ5KHF1ZXJ5S2V5KSxcbiAgICB9O1xuXG4gICAgdGhpcy5jYWNoZS5zZXQocXVlcnlLZXksIGVudHJ5KTtcbiAgICB0aGlzLnVwZGF0ZVN0YXRzKCk7XG4gIH1cblxuICAvKipcbiAgICogTm9ybWFsaXplIGFuZCBjcmVhdGUgY2FjaGUga2V5IGZyb20gU1BBUlFMIHF1ZXJ5XG4gICAqL1xuICBjcmVhdGVDYWNoZUtleShxdWVyeTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAvLyBGaXJzdCBzcGxpdCBvbiB0aGUgY29sb24gdG8gaGFuZGxlIHByZWZpeCBzZXBhcmF0ZWx5IGlmIGl0IGV4aXN0c1xuICAgIGNvbnN0IGNvbG9uSW5kZXggPSBxdWVyeS5pbmRleE9mKFwiOlwiKTtcbiAgICBsZXQgcHJlZml4ID0gXCJcIjtcbiAgICBsZXQgcXVlcnlQYXJ0ID0gcXVlcnk7XG5cbiAgICBpZiAoY29sb25JbmRleCA+IDAgJiYgY29sb25JbmRleCA8IDIwKSB7XG4gICAgICAvLyBBc3N1bWUgcHJlZml4IGlzIHNob3J0XG4gICAgICBwcmVmaXggPSBxdWVyeS5zdWJzdHJpbmcoMCwgY29sb25JbmRleCkudG9Mb3dlckNhc2UoKSArIFwiOlwiO1xuICAgICAgcXVlcnlQYXJ0ID0gcXVlcnkuc3Vic3RyaW5nKGNvbG9uSW5kZXggKyAxKTtcbiAgICB9XG5cbiAgICAvLyBOb3JtYWxpemUgdGhlIHF1ZXJ5IGJ5IHJlbW92aW5nIGV4dHJhIHdoaXRlc3BhY2UgYW5kIGNvbnZlcnRpbmcgdG8gbG93ZXJjYXNlXG4gICAgY29uc3Qgbm9ybWFsaXplZCA9IHF1ZXJ5UGFydFxuICAgICAgLnRyaW0oKSAvLyBSZW1vdmUgbGVhZGluZy90cmFpbGluZyB3aGl0ZXNwYWNlIGZpcnN0XG4gICAgICAucmVwbGFjZSgvW1xcclxcblxcdF0rL2csIFwiIFwiKSAvLyBSZXBsYWNlIG5ld2xpbmVzIGFuZCB0YWJzIHdpdGggc3BhY2VzXG4gICAgICAucmVwbGFjZSgvXFxzKy9nLCBcIiBcIikgLy8gUmVwbGFjZSBtdWx0aXBsZSBzcGFjZXMgd2l0aCBzaW5nbGUgc3BhY2VcbiAgICAgIC5yZXBsYWNlKC9cXHMqXFx7XFxzKi9nLCBcIiB7IFwiKSAvLyBOb3JtYWxpemUgc3BhY2luZyBhcm91bmQgY3VybHkgYnJhY2VzXG4gICAgICAucmVwbGFjZSgvXFxzKlxcfVxccyovZywgXCIgfSBcIilcbiAgICAgIC5yZXBsYWNlKC9cXHMqXFwoXFxzKi9nLCBcIiAoIFwiKSAvLyBOb3JtYWxpemUgc3BhY2luZyBhcm91bmQgcGFyZW50aGVzZXNcbiAgICAgIC5yZXBsYWNlKC9cXHMqXFwpXFxzKi9nLCBcIiApIFwiKVxuICAgICAgLnJlcGxhY2UoL1xccysvZywgXCIgXCIpIC8vIENsZWFuIHVwIHNwYWNlcyBhZ2FpblxuICAgICAgLnRyaW0oKSAvLyBUcmltIGFnYWluIGFmdGVyIHJlcGxhY2VtZW50c1xuICAgICAgLnRvTG93ZXJDYXNlKCk7IC8vIENvbnZlcnQgdG8gbG93ZXJjYXNlIGZvciBjYXNlLWluc2Vuc2l0aXZlIG1hdGNoaW5nXG5cbiAgICBjb25zdCBmdWxsS2V5ID0gcHJlZml4ICsgbm9ybWFsaXplZDtcblxuICAgIC8vIFVzZSB0aGUgbm9ybWFsaXplZCBzdHJpbmcgZGlyZWN0bHkgYXMgdGhlIGtleSBmb3IgYmV0dGVyIGNvbnNpc3RlbmN5XG4gICAgLy8gT25seSBoYXNoIHZlcnkgbG9uZyBxdWVyaWVzXG4gICAgaWYgKGZ1bGxLZXkubGVuZ3RoID4gMTAwMCkge1xuICAgICAgcmV0dXJuIHRoaXMuaGFzaFF1ZXJ5KGZ1bGxLZXkpO1xuICAgIH1cbiAgICByZXR1cm4gZnVsbEtleTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZhbGlkYXRlIGFsbCBjYWNoZWQgZW50cmllc1xuICAgKi9cbiAgaW52YWxpZGF0ZUFsbCgpOiB2b2lkIHtcbiAgICBjb25zdCBzaXplQmVmb3JlID0gdGhpcy5jYWNoZS5zaXplO1xuICAgIHRoaXMuY2FjaGUuY2xlYXIoKTtcbiAgICB0aGlzLnN0YXRzLmV2aWN0aW9ucyArPSBzaXplQmVmb3JlO1xuICAgIHRoaXMudXBkYXRlU3RhdHMoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZhbGlkYXRlIGVudHJpZXMgYmFzZWQgb24gYSBwcmVkaWNhdGUgZnVuY3Rpb25cbiAgICovXG4gIGludmFsaWRhdGVXaGVyZShcbiAgICBwcmVkaWNhdGU6IChrZXk6IHN0cmluZywgZW50cnk6IENhY2hlRW50cnk8YW55PikgPT4gYm9vbGVhbixcbiAgKTogbnVtYmVyIHtcbiAgICBsZXQgaW52YWxpZGF0ZWQgPSAwO1xuXG4gICAgZm9yIChjb25zdCBba2V5LCBlbnRyeV0gb2YgdGhpcy5jYWNoZS5lbnRyaWVzKCkpIHtcbiAgICAgIGlmIChwcmVkaWNhdGUoa2V5LCBlbnRyeSkpIHtcbiAgICAgICAgdGhpcy5jYWNoZS5kZWxldGUoa2V5KTtcbiAgICAgICAgaW52YWxpZGF0ZWQrKztcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLnN0YXRzLmV2aWN0aW9ucyArPSBpbnZhbGlkYXRlZDtcbiAgICB0aGlzLnVwZGF0ZVN0YXRzKCk7XG4gICAgcmV0dXJuIGludmFsaWRhdGVkO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjdXJyZW50IGNhY2hlIHN0YXRpc3RpY3NcbiAgICovXG4gIGdldFN0YXRpc3RpY3MoKTogQ2FjaGVTdGF0aXN0aWNzIHtcbiAgICByZXR1cm4geyAuLi50aGlzLnN0YXRzIH07XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIGNhY2hlIGNvbmZpZ3VyYXRpb25cbiAgICovXG4gIHVwZGF0ZUNvbmZpZyhuZXdDb25maWc6IFBhcnRpYWw8UXVlcnlDYWNoZUNvbmZpZz4pOiB2b2lkIHtcbiAgICB0aGlzLmNvbmZpZyA9IHsgLi4udGhpcy5jb25maWcsIC4uLm5ld0NvbmZpZyB9O1xuICAgIHRoaXMuc3RhdHMubWF4U2l6ZSA9IHRoaXMuY29uZmlnLm1heFNpemU7XG5cbiAgICAvLyBJZiBjYWNoZSBpcyBkaXNhYmxlZCwgY2xlYXIgaXRcbiAgICBpZiAoIXRoaXMuY29uZmlnLmVuYWJsZWQpIHtcbiAgICAgIHRoaXMuaW52YWxpZGF0ZUFsbCgpO1xuICAgIH1cblxuICAgIC8vIElmIG1heCBzaXplIHJlZHVjZWQsIGV2aWN0IGVudHJpZXNcbiAgICB3aGlsZSAodGhpcy5jYWNoZS5zaXplID4gdGhpcy5jb25maWcubWF4U2l6ZSkge1xuICAgICAgdGhpcy5ldmljdE9sZGVzdCgpO1xuICAgIH1cbiAgICB0aGlzLnVwZGF0ZVN0YXRzKCk7XG5cbiAgICAvLyBSZXN0YXJ0IGNsZWFudXAgdGltZXIgaWYgaW50ZXJ2YWwgY2hhbmdlZFxuICAgIGlmIChuZXdDb25maWcuY2xlYW51cEludGVydmFsICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRoaXMuc3RvcENsZWFudXBUaW1lcigpO1xuICAgICAgdGhpcy5zdGFydENsZWFudXBUaW1lcigpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY3VycmVudCBjb25maWd1cmF0aW9uXG4gICAqL1xuICBnZXRDb25maWcoKTogUXVlcnlDYWNoZUNvbmZpZyB7XG4gICAgcmV0dXJuIHsgLi4udGhpcy5jb25maWcgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBNYW51YWxseSB0cmlnZ2VyIGNsZWFudXAgb2YgZXhwaXJlZCBlbnRyaWVzXG4gICAqL1xuICBjbGVhbnVwKCk6IG51bWJlciB7XG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBsZXQgY2xlYW5lZCA9IDA7XG5cbiAgICBmb3IgKGNvbnN0IFtrZXksIGVudHJ5XSBvZiB0aGlzLmNhY2hlLmVudHJpZXMoKSkge1xuICAgICAgaWYgKG5vdyA+IGVudHJ5LmV4cGlyZXNBdCkge1xuICAgICAgICB0aGlzLmNhY2hlLmRlbGV0ZShrZXkpO1xuICAgICAgICBjbGVhbmVkKys7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGNsZWFuZWQgPiAwKSB7XG4gICAgICB0aGlzLnN0YXRzLmV2aWN0aW9ucyArPSBjbGVhbmVkO1xuICAgICAgdGhpcy51cGRhdGVTdGF0cygpO1xuICAgIH1cblxuICAgIHJldHVybiBjbGVhbmVkO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIGEgcXVlcnkgcmVzdWx0IGlzIGNhY2hlZFxuICAgKi9cbiAgaGFzKHF1ZXJ5S2V5OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBpZiAoIXRoaXMuY29uZmlnLmVuYWJsZWQpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCBlbnRyeSA9IHRoaXMuY2FjaGUuZ2V0KHF1ZXJ5S2V5KTtcbiAgICBpZiAoIWVudHJ5KSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgZXhwaXJlZFxuICAgIGlmIChEYXRlLm5vdygpID4gZW50cnkuZXhwaXJlc0F0KSB7XG4gICAgICB0aGlzLmNhY2hlLmRlbGV0ZShxdWVyeUtleSk7XG4gICAgICB0aGlzLnN0YXRzLmV2aWN0aW9ucysrO1xuICAgICAgdGhpcy51cGRhdGVTdGF0cygpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIERlc3Ryb3kgdGhlIGNhY2hlIGFuZCBjbGVhbnVwIHJlc291cmNlc1xuICAgKi9cbiAgZGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLnN0b3BDbGVhbnVwVGltZXIoKTtcbiAgICB0aGlzLmNhY2hlLmNsZWFyKCk7XG4gIH1cblxuICAvLyBQcml2YXRlIG1ldGhvZHNcblxuICBwcml2YXRlIGhhc2hRdWVyeShxdWVyeTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAvLyBTaW1wbGUgaGFzaCBmdW5jdGlvbiBmb3IgcXVlcnkgc3RyaW5nc1xuICAgIGxldCBoYXNoID0gMDtcbiAgICBpZiAocXVlcnkubGVuZ3RoID09PSAwKSByZXR1cm4gaGFzaC50b1N0cmluZygpO1xuXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBxdWVyeS5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgY2hhciA9IHF1ZXJ5LmNoYXJDb2RlQXQoaSk7XG4gICAgICBoYXNoID0gKGhhc2ggPDwgNSkgLSBoYXNoICsgY2hhcjtcbiAgICAgIGhhc2ggPSBoYXNoICYgaGFzaDsgLy8gQ29udmVydCB0byAzMi1iaXQgaW50ZWdlclxuICAgIH1cblxuICAgIHJldHVybiBNYXRoLmFicyhoYXNoKS50b1N0cmluZygpO1xuICB9XG5cbiAgcHJpdmF0ZSBldmljdE9sZGVzdCgpOiB2b2lkIHtcbiAgICBsZXQgb2xkZXN0S2V5OiBzdHJpbmcgfCBudWxsID0gbnVsbDtcbiAgICBsZXQgb2xkZXN0VGltZXN0YW1wID0gSW5maW5pdHk7XG5cbiAgICBmb3IgKGNvbnN0IFtrZXksIGVudHJ5XSBvZiB0aGlzLmNhY2hlLmVudHJpZXMoKSkge1xuICAgICAgaWYgKGVudHJ5LnRpbWVzdGFtcCA8IG9sZGVzdFRpbWVzdGFtcCkge1xuICAgICAgICBvbGRlc3RUaW1lc3RhbXAgPSBlbnRyeS50aW1lc3RhbXA7XG4gICAgICAgIG9sZGVzdEtleSA9IGtleTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAob2xkZXN0S2V5KSB7XG4gICAgICB0aGlzLmNhY2hlLmRlbGV0ZShvbGRlc3RLZXkpO1xuICAgICAgdGhpcy5zdGF0cy5ldmljdGlvbnMrKztcbiAgICAgIHRoaXMudXBkYXRlU3RhdHMoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZVN0YXRzKCk6IHZvaWQge1xuICAgIHRoaXMuc3RhdHMuc2l6ZSA9IHRoaXMuY2FjaGUuc2l6ZTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlSGl0UmF0ZSgpOiB2b2lkIHtcbiAgICB0aGlzLnN0YXRzLmhpdFJhdGUgPVxuICAgICAgdGhpcy5zdGF0cy50b3RhbFF1ZXJpZXMgPiAwXG4gICAgICAgID8gKHRoaXMuc3RhdHMuaGl0cyAvIHRoaXMuc3RhdHMudG90YWxRdWVyaWVzKSAqIDEwMFxuICAgICAgICA6IDA7XG4gIH1cblxuICBwcml2YXRlIHN0YXJ0Q2xlYW51cFRpbWVyKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmNvbmZpZy5jbGVhbnVwSW50ZXJ2YWwgPiAwKSB7XG4gICAgICB0aGlzLmNsZWFudXBUaW1lciA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgICAgdGhpcy5jbGVhbnVwKCk7XG4gICAgICB9LCB0aGlzLmNvbmZpZy5jbGVhbnVwSW50ZXJ2YWwpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc3RvcENsZWFudXBUaW1lcigpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5jbGVhbnVwVGltZXIpIHtcbiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5jbGVhbnVwVGltZXIpO1xuICAgICAgdGhpcy5jbGVhbnVwVGltZXIgPSB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG59XG4iXSwidmVyc2lvbiI6M30=