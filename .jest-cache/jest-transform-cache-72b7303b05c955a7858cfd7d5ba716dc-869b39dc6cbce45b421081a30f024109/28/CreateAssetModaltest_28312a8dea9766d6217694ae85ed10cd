6f79ecc349d27d7dd66adc2b4c17a91f
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// Mock DIContainer
jest.mock("../../../../src/infrastructure/container/DIContainer");
// Mock Notice
jest.mock("obsidian", () => {
    const actual = jest.requireActual("obsidian");
    return {
        ...actual,
        Notice: jest.fn(),
        Setting: jest.fn().mockImplementation(() => ({
            setName: jest.fn().mockReturnThis(),
            setDesc: jest.fn().mockReturnThis(),
            addText: jest.fn().mockReturnThis(),
            addDropdown: jest.fn().mockReturnThis(),
            addToggle: jest.fn().mockReturnThis(),
            addTextArea: jest.fn().mockReturnThis(),
            addButton: jest.fn().mockReturnThis(),
        })),
    };
});
const obsidian_1 = require("obsidian");
const CreateAssetModal_1 = require("../../../../src/presentation/modals/CreateAssetModal");
const DIContainer_1 = require("../../../../src/infrastructure/container/DIContainer");
const Result_1 = require("../../../../src/domain/core/Result");
// Add Obsidian DOM extensions to HTMLElement prototype
beforeAll(() => {
    HTMLElement.prototype.createEl = jest.fn().mockImplementation(function (tag, attrs) {
        const element = document.createElement(tag);
        if (attrs?.text)
            element.textContent = attrs.text;
        if (attrs?.cls)
            element.className = attrs.cls;
        // Append to parent (this) like real Obsidian createEl does
        this.appendChild(element);
        return element;
    });
    HTMLElement.prototype.createDiv = jest.fn().mockImplementation(function (attrs) {
        const element = document.createElement("div");
        if (attrs?.cls)
            element.className = attrs.cls;
        // Append to parent (this) like real Obsidian createDiv does
        this.appendChild(element);
        return element;
    });
    HTMLElement.prototype.empty = jest.fn().mockImplementation(function () {
        while (this.firstChild) {
            this.removeChild(this.firstChild);
        }
    });
});
describe("CreateAssetModal", () => {
    let app;
    let modal;
    let mockCreateAssetUseCase;
    let mockContainer;
    let mockCircuitBreaker;
    let mockPropertyCache;
    beforeEach(() => {
        // Setup app mock with vault and metadataCache
        app = new obsidian_1.App();
        app.vault = {
            getMarkdownFiles: jest.fn().mockReturnValue([]),
            read: jest.fn(),
        };
        app.metadataCache = {
            getFileCache: jest.fn().mockReturnValue(null),
        };
        // Setup CreateAssetUseCase mock
        mockCreateAssetUseCase = {
            execute: jest.fn(),
        };
        // Mock services for enhanced functionality
        mockPropertyCache = {
            getPropertiesForClass: jest.fn().mockReturnValue([]),
            updateClassProperties: jest.fn(),
            hasPropertiesForClass: jest.fn().mockReturnValue(false),
            clearCache: jest.fn(),
        };
        mockCircuitBreaker = {
            execute: jest.fn(),
            getCircuitState: jest.fn(),
            openCircuit: jest.fn(),
            closeCircuit: jest.fn(),
        };
        // Setup DIContainer mock
        mockContainer = {
            getCreateAssetUseCase: jest.fn().mockReturnValue(mockCreateAssetUseCase),
            getInstance: jest.fn().mockReturnThis(),
            resolve: jest.fn().mockImplementation((token) => {
                if (token === 'PropertyCacheService') {
                    return mockPropertyCache;
                }
                if (token === 'CircuitBreakerService') {
                    return mockCircuitBreaker;
                }
                // Return empty mock repositories
                return {};
            }),
        };
        DIContainer_1.DIContainer.getInstance.mockReturnValue(mockContainer);
        // Create modal instance
        modal = new CreateAssetModal_1.CreateAssetModal(app);
    });
    afterEach(() => {
        jest.clearAllMocks();
    });
    describe("Asset Creation with Circuit Breaker", () => {
        test("should create asset successfully through circuit breaker", async () => {
            // Setup circuit breaker to execute operation and return success
            mockCircuitBreaker.execute.mockImplementation(async (name, operation) => {
                // Set up use case to return success
                mockCreateAssetUseCase.execute.mockResolvedValue({
                    success: true,
                    assetId: "test-id",
                    message: "Created asset: Test Asset",
                });
                // Execute the operation
                return await operation();
            });
            modal.assetTitle = "Test Asset";
            modal.assetClass = "exo__Task";
            modal.assetOntology = "exo";
            modal.propertyValues.set("priority", "high");
            const closeSpy = jest.spyOn(modal, "close").mockImplementation(() => { });
            await modal.createAsset();
            expect(mockCircuitBreaker.execute).toHaveBeenCalledWith("asset-creation", expect.any(Function), expect.objectContaining({
                failureThreshold: 3,
                resetTimeout: 30000,
                halfOpenMaxCalls: 2,
            }));
            expect(mockCreateAssetUseCase.execute).toHaveBeenCalledWith({
                title: "Test Asset",
                className: "exo__Task",
                ontologyPrefix: "exo",
                properties: {
                    priority: "high",
                },
            });
            expect(obsidian_1.Notice).toHaveBeenCalledWith("Created asset: Test Asset");
            expect(closeSpy).toHaveBeenCalled();
        });
        test("should handle asset creation failure through circuit breaker", async () => {
            // Setup circuit breaker to execute operation and return failure
            mockCircuitBreaker.execute.mockImplementation(async (name, operation) => {
                mockCreateAssetUseCase.execute.mockResolvedValue({
                    success: false,
                    assetId: "",
                    message: "Creation failed",
                    error: "Invalid asset data",
                });
                return await operation();
            });
            modal.assetTitle = "Test Asset";
            await modal.createAsset();
            expect(obsidian_1.Notice).toHaveBeenCalledWith("Error: Invalid asset data", 5000);
        });
        test("should handle circuit breaker open state", async () => {
            // Setup circuit breaker to return circuit open error
            mockCircuitBreaker.execute.mockResolvedValue(Result_1.Result.fail("Circuit asset-creation is OPEN. Try again in 25 seconds"));
            modal.assetTitle = "Test Asset";
            await modal.createAsset();
            expect(obsidian_1.Notice).toHaveBeenCalledWith("Asset creation is temporarily unavailable. Please try again in a moment.", 5000);
        });
        test("should handle ontology-related errors", async () => {
            mockCircuitBreaker.execute.mockResolvedValue(Result_1.Result.fail("Ontology 'test' not found"));
            modal.assetTitle = "Test Asset";
            await modal.createAsset();
            expect(obsidian_1.Notice).toHaveBeenCalledWith("Ontology issue: Ontology 'test' not found", 8000);
        });
        test("should handle validation errors", async () => {
            mockCircuitBreaker.execute.mockResolvedValue(Result_1.Result.fail("Invalid asset title: contains special characters"));
            modal.assetTitle = "Test@Asset#";
            await modal.createAsset();
            expect(obsidian_1.Notice).toHaveBeenCalledWith("Validation error: Invalid asset title: contains special characters", 6000);
        });
    });
    describe("Property Caching", () => {
        test("should use property cache when updating properties", async () => {
            const cachedProperties = [
                {
                    name: "cached_prop",
                    label: "Cached Property",
                    description: "From cache",
                    type: "string",
                    isRequired: false,
                },
            ];
            mockPropertyCache.getPropertiesForClass.mockReturnValue(cachedProperties);
            mockPropertyCache.hasPropertiesForClass.mockReturnValue(true);
            await modal.updatePropertiesForClass("TestClass");
            expect(mockPropertyCache.getPropertiesForClass).toHaveBeenCalledWith("TestClass");
        });
        test("should update cache when properties are loaded from vault", async () => {
            const file = {
                basename: "propertyName",
                name: "propertyName.md",
            };
            app.vault.getMarkdownFiles.mockReturnValue([file]);
            app.metadataCache.getFileCache.mockReturnValue({
                frontmatter: {
                    exo__Instance_class: "exo__Property",
                    rdfs__domain: "TestClass",
                    rdfs__label: "Property Label",
                },
            });
            mockPropertyCache.hasPropertiesForClass.mockReturnValue(false);
            await modal.updatePropertiesForClass("TestClass");
            // Properties should be loaded and cached
            expect(mockPropertyCache.updateClassProperties).not.toHaveBeenCalled(); // Cache update is handled internally
        });
    });
    describe("Modal Initialization", () => {
        test("should initialize with correct default values", () => {
            expect(modal.assetTitle).toBe("");
            expect(modal.assetClass).toBe("exo__Asset");
            expect(modal.assetOntology).toBe("");
            expect(modal.propertyValues).toBeInstanceOf(Map);
            expect(modal.propertyValues.size).toBe(0);
        });
        test("should properly resolve services from container", () => {
            expect(mockContainer.resolve).toHaveBeenCalledWith("IOntologyRepository");
            expect(mockContainer.resolve).toHaveBeenCalledWith("IClassViewRepository");
            expect(mockContainer.resolve).toHaveBeenCalledWith("PropertyCacheService");
            expect(mockContainer.resolve).toHaveBeenCalledWith("CircuitBreakerService");
        });
    });
    describe("Error Recovery", () => {
        test("should recover from circuit breaker errors", async () => {
            // First call fails
            mockCircuitBreaker.execute.mockResolvedValueOnce(Result_1.Result.fail("Circuit is open"));
            modal.assetTitle = "Test Asset";
            await modal.createAsset();
            expect(obsidian_1.Notice).toHaveBeenCalledWith("Asset creation is temporarily unavailable. Please try again in a moment.", 5000);
            // Reset Notice mock for second call
            obsidian_1.Notice.mockClear();
            // Second call succeeds after circuit recovery
            mockCircuitBreaker.execute.mockImplementation(async (name, operation) => {
                mockCreateAssetUseCase.execute.mockResolvedValue({
                    success: true,
                    assetId: "test-id",
                    message: "Created asset: Test Asset",
                });
                return await operation();
            });
            await modal.createAsset();
            expect(obsidian_1.Notice).toHaveBeenCalledWith("Created asset: Test Asset");
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vdGVzdHMvdW5pdC9wcmVzZW50YXRpb24vbW9kYWxzL0NyZWF0ZUFzc2V0TW9kYWwudGVzdC50cyIsIm1hcHBpbmdzIjoiOztBQU1BLG1CQUFtQjtBQUNuQixJQUFJLENBQUMsSUFBSSxDQUFDLHNEQUFzRCxDQUFDLENBQUM7QUFFbEUsY0FBYztBQUNkLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEdBQUcsRUFBRTtJQUN6QixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQzlDLE9BQU87UUFDTCxHQUFHLE1BQU07UUFDVCxNQUFNLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtRQUNqQixPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDM0MsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxjQUFjLEVBQUU7WUFDbkMsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxjQUFjLEVBQUU7WUFDbkMsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxjQUFjLEVBQUU7WUFDbkMsV0FBVyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxjQUFjLEVBQUU7WUFDdkMsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxjQUFjLEVBQUU7WUFDckMsV0FBVyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxjQUFjLEVBQUU7WUFDdkMsU0FBUyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxjQUFjLEVBQUU7U0FDdEMsQ0FBQyxDQUFDO0tBQ0osQ0FBQztBQUNKLENBQUMsQ0FBQyxDQUFDO0FBekJILHVDQUFnRDtBQUNoRCwyRkFBd0Y7QUFFeEYsc0ZBQW1GO0FBQ25GLCtEQUE0RDtBQWdDNUQsdURBQXVE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S0FBYSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBRW5DLE1BQU0sQ0FBQyxpQkFBTSxDQUFDLENBQUMsb0JBQW9CLENBQ2pDLDBFQUEwRSxFQUMxRSxJQUFJLENBQ0wsQ0FBQztZQUVGLG9DQUFvQztZQUNuQyxpQkFBb0IsQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUVsQyw4Q0FBOEM7WUFDOUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLGtCQUFrQixDQUFDLEtBQUssRUFBRSxJQUFZLEVBQUUsU0FBbUIsRUFBRSxFQUFFO2dCQUN4RixzQkFBc0IsQ0FBQyxPQUFPLENBQUMsaUJBQWlCLENBQUM7b0JBQy9DLE9BQU8sRUFBRSxJQUFJO29CQUNiLE9BQU8sRUFBRSxTQUFTO29CQUNsQixPQUFPLEVBQUUsMkJBQTJCO2lCQUNyQyxDQUFDLENBQUM7Z0JBQ0gsT0FBTyxNQUFNLFNBQVMsRUFBRSxDQUFDO1lBQzNCLENBQUMsQ0FBQyxDQUFDO1lBRUgsTUFBTyxLQUFhLENBQUMsV0FBVyxFQUFFLENBQUM7WUFFbkMsTUFBTSxDQUFDLGlCQUFNLENBQUMsQ0FBQyxvQkFBb0IsQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO1FBQ25FLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva2l0ZWxldi9Eb2N1bWVudHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi90ZXN0cy91bml0L3ByZXNlbnRhdGlvbi9tb2RhbHMvQ3JlYXRlQXNzZXRNb2RhbC50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFwcCwgU2V0dGluZywgTm90aWNlIH0gZnJvbSBcIm9ic2lkaWFuXCI7XG5pbXBvcnQgeyBDcmVhdGVBc3NldE1vZGFsIH0gZnJvbSBcIi4uLy4uLy4uLy4uL3NyYy9wcmVzZW50YXRpb24vbW9kYWxzL0NyZWF0ZUFzc2V0TW9kYWxcIjtcbmltcG9ydCB7IENyZWF0ZUFzc2V0VXNlQ2FzZSB9IGZyb20gXCIuLi8uLi8uLi8uLi9zcmMvYXBwbGljYXRpb24vdXNlLWNhc2VzL0NyZWF0ZUFzc2V0VXNlQ2FzZVwiO1xuaW1wb3J0IHsgRElDb250YWluZXIgfSBmcm9tIFwiLi4vLi4vLi4vLi4vc3JjL2luZnJhc3RydWN0dXJlL2NvbnRhaW5lci9ESUNvbnRhaW5lclwiO1xuaW1wb3J0IHsgUmVzdWx0IH0gZnJvbSBcIi4uLy4uLy4uLy4uL3NyYy9kb21haW4vY29yZS9SZXN1bHRcIjtcblxuLy8gTW9jayBESUNvbnRhaW5lclxuamVzdC5tb2NrKFwiLi4vLi4vLi4vLi4vc3JjL2luZnJhc3RydWN0dXJlL2NvbnRhaW5lci9ESUNvbnRhaW5lclwiKTtcblxuLy8gTW9jayBOb3RpY2Vcbmplc3QubW9jayhcIm9ic2lkaWFuXCIsICgpID0+IHtcbiAgY29uc3QgYWN0dWFsID0gamVzdC5yZXF1aXJlQWN0dWFsKFwib2JzaWRpYW5cIik7XG4gIHJldHVybiB7XG4gICAgLi4uYWN0dWFsLFxuICAgIE5vdGljZTogamVzdC5mbigpLFxuICAgIFNldHRpbmc6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4gKHtcbiAgICAgIHNldE5hbWU6IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgICAgc2V0RGVzYzogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICBhZGRUZXh0OiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICAgIGFkZERyb3Bkb3duOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICAgIGFkZFRvZ2dsZTogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICBhZGRUZXh0QXJlYTogamVzdC5mbigpLm1vY2tSZXR1cm5UaGlzKCksXG4gICAgICBhZGRCdXR0b246IGplc3QuZm4oKS5tb2NrUmV0dXJuVGhpcygpLFxuICAgIH0pKSxcbiAgfTtcbn0pO1xuXG4vLyBFeHRlbmQgSFRNTEVsZW1lbnQgdG8gaW5jbHVkZSBPYnNpZGlhbi1zcGVjaWZpYyBtZXRob2RzXG5kZWNsYXJlIGdsb2JhbCB7XG4gIGludGVyZmFjZSBIVE1MRWxlbWVudCB7XG4gICAgY3JlYXRlRWwodGFnOiBzdHJpbmcsIGF0dHJzPzogYW55KTogSFRNTEVsZW1lbnQ7XG4gICAgY3JlYXRlRGl2KGF0dHJzPzogYW55KTogSFRNTEVsZW1lbnQ7XG4gICAgZW1wdHkoKTogdm9pZDtcbiAgfVxufVxuXG4vLyBBZGQgT2JzaWRpYW4gRE9NIGV4dGVuc2lvbnMgdG8gSFRNTEVsZW1lbnQgcHJvdG90eXBlXG5iZWZvcmVBbGwoKCkgPT4ge1xuICBIVE1MRWxlbWVudC5wcm90b3R5cGUuY3JlYXRlRWwgPSBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGZ1bmN0aW9uIChcbiAgICB0aGlzOiBIVE1MRWxlbWVudCxcbiAgICB0YWc6IHN0cmluZyxcbiAgICBhdHRycz86IGFueSxcbiAgKSB7XG4gICAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQodGFnKTtcbiAgICBpZiAoYXR0cnM/LnRleHQpIGVsZW1lbnQudGV4dENvbnRlbnQgPSBhdHRycy50ZXh0O1xuICAgIGlmIChhdHRycz8uY2xzKSBlbGVtZW50LmNsYXNzTmFtZSA9IGF0dHJzLmNscztcbiAgICAvLyBBcHBlbmQgdG8gcGFyZW50ICh0aGlzKSBsaWtlIHJlYWwgT2JzaWRpYW4gY3JlYXRlRWwgZG9lc1xuICAgIHRoaXMuYXBwZW5kQ2hpbGQoZWxlbWVudCk7XG4gICAgcmV0dXJuIGVsZW1lbnQ7XG4gIH0pO1xuXG4gIEhUTUxFbGVtZW50LnByb3RvdHlwZS5jcmVhdGVEaXYgPSBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKGZ1bmN0aW9uIChcbiAgICB0aGlzOiBIVE1MRWxlbWVudCxcbiAgICBhdHRycz86IGFueSxcbiAgKSB7XG4gICAgY29uc3QgZWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gICAgaWYgKGF0dHJzPy5jbHMpIGVsZW1lbnQuY2xhc3NOYW1lID0gYXR0cnMuY2xzO1xuICAgIC8vIEFwcGVuZCB0byBwYXJlbnQgKHRoaXMpIGxpa2UgcmVhbCBPYnNpZGlhbiBjcmVhdGVEaXYgZG9lc1xuICAgIHRoaXMuYXBwZW5kQ2hpbGQoZWxlbWVudCk7XG4gICAgcmV0dXJuIGVsZW1lbnQ7XG4gIH0pO1xuXG4gIEhUTUxFbGVtZW50LnByb3RvdHlwZS5lbXB0eSA9IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oZnVuY3Rpb24gKCkge1xuICAgIHdoaWxlICh0aGlzLmZpcnN0Q2hpbGQpIHtcbiAgICAgIHRoaXMucmVtb3ZlQ2hpbGQodGhpcy5maXJzdENoaWxkKTtcbiAgICB9XG4gIH0pO1xufSk7XG5cbmRlc2NyaWJlKFwiQ3JlYXRlQXNzZXRNb2RhbFwiLCAoKSA9PiB7XG4gIGxldCBhcHA6IEFwcDtcbiAgbGV0IG1vZGFsOiBDcmVhdGVBc3NldE1vZGFsO1xuICBsZXQgbW9ja0NyZWF0ZUFzc2V0VXNlQ2FzZTogamVzdC5Nb2NrZWQ8Q3JlYXRlQXNzZXRVc2VDYXNlPjtcbiAgbGV0IG1vY2tDb250YWluZXI6IGplc3QuTW9ja2VkPERJQ29udGFpbmVyPjtcbiAgbGV0IG1vY2tDaXJjdWl0QnJlYWtlcjogYW55O1xuICBsZXQgbW9ja1Byb3BlcnR5Q2FjaGU6IGFueTtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAvLyBTZXR1cCBhcHAgbW9jayB3aXRoIHZhdWx0IGFuZCBtZXRhZGF0YUNhY2hlXG4gICAgYXBwID0gbmV3IEFwcCgpO1xuICAgIChhcHAgYXMgYW55KS52YXVsdCA9IHtcbiAgICAgIGdldE1hcmtkb3duRmlsZXM6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoW10pLFxuICAgICAgcmVhZDogamVzdC5mbigpLFxuICAgIH07XG4gICAgKGFwcCBhcyBhbnkpLm1ldGFkYXRhQ2FjaGUgPSB7XG4gICAgICBnZXRGaWxlQ2FjaGU6IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUobnVsbCksXG4gICAgfTtcblxuICAgIC8vIFNldHVwIENyZWF0ZUFzc2V0VXNlQ2FzZSBtb2NrXG4gICAgbW9ja0NyZWF0ZUFzc2V0VXNlQ2FzZSA9IHtcbiAgICAgIGV4ZWN1dGU6IGplc3QuZm4oKSxcbiAgICB9IGFzIGFueTtcblxuICAgIC8vIE1vY2sgc2VydmljZXMgZm9yIGVuaGFuY2VkIGZ1bmN0aW9uYWxpdHlcbiAgICBtb2NrUHJvcGVydHlDYWNoZSA9IHtcbiAgICAgIGdldFByb3BlcnRpZXNGb3JDbGFzczogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZShbXSksXG4gICAgICB1cGRhdGVDbGFzc1Byb3BlcnRpZXM6IGplc3QuZm4oKSxcbiAgICAgIGhhc1Byb3BlcnRpZXNGb3JDbGFzczogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZShmYWxzZSksXG4gICAgICBjbGVhckNhY2hlOiBqZXN0LmZuKCksXG4gICAgfTtcblxuICAgIG1vY2tDaXJjdWl0QnJlYWtlciA9IHtcbiAgICAgIGV4ZWN1dGU6IGplc3QuZm4oKSxcbiAgICAgIGdldENpcmN1aXRTdGF0ZTogamVzdC5mbigpLFxuICAgICAgb3BlbkNpcmN1aXQ6IGplc3QuZm4oKSxcbiAgICAgIGNsb3NlQ2lyY3VpdDogamVzdC5mbigpLFxuICAgIH07XG5cbiAgICAvLyBTZXR1cCBESUNvbnRhaW5lciBtb2NrXG4gICAgbW9ja0NvbnRhaW5lciA9IHtcbiAgICAgIGdldENyZWF0ZUFzc2V0VXNlQ2FzZTogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZShtb2NrQ3JlYXRlQXNzZXRVc2VDYXNlKSxcbiAgICAgIGdldEluc3RhbmNlOiBqZXN0LmZuKCkubW9ja1JldHVyblRoaXMoKSxcbiAgICAgIHJlc29sdmU6IGplc3QuZm4oKS5tb2NrSW1wbGVtZW50YXRpb24oKHRva2VuOiBzdHJpbmcpID0+IHtcbiAgICAgICAgaWYgKHRva2VuID09PSAnUHJvcGVydHlDYWNoZVNlcnZpY2UnKSB7XG4gICAgICAgICAgcmV0dXJuIG1vY2tQcm9wZXJ0eUNhY2hlO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0b2tlbiA9PT0gJ0NpcmN1aXRCcmVha2VyU2VydmljZScpIHtcbiAgICAgICAgICByZXR1cm4gbW9ja0NpcmN1aXRCcmVha2VyO1xuICAgICAgICB9XG4gICAgICAgIC8vIFJldHVybiBlbXB0eSBtb2NrIHJlcG9zaXRvcmllc1xuICAgICAgICByZXR1cm4ge307XG4gICAgICB9KSxcbiAgICB9IGFzIGFueTtcblxuICAgIChESUNvbnRhaW5lci5nZXRJbnN0YW5jZSBhcyBqZXN0Lk1vY2spLm1vY2tSZXR1cm5WYWx1ZShtb2NrQ29udGFpbmVyKTtcblxuICAgIC8vIENyZWF0ZSBtb2RhbCBpbnN0YW5jZVxuICAgIG1vZGFsID0gbmV3IENyZWF0ZUFzc2V0TW9kYWwoYXBwKTtcbiAgfSk7XG5cbiAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICBqZXN0LmNsZWFyQWxsTW9ja3MoKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoXCJBc3NldCBDcmVhdGlvbiB3aXRoIENpcmN1aXQgQnJlYWtlclwiLCAoKSA9PiB7XG4gICAgdGVzdChcInNob3VsZCBjcmVhdGUgYXNzZXQgc3VjY2Vzc2Z1bGx5IHRocm91Z2ggY2lyY3VpdCBicmVha2VyXCIsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIFNldHVwIGNpcmN1aXQgYnJlYWtlciB0byBleGVjdXRlIG9wZXJhdGlvbiBhbmQgcmV0dXJuIHN1Y2Nlc3NcbiAgICAgIG1vY2tDaXJjdWl0QnJlYWtlci5leGVjdXRlLm1vY2tJbXBsZW1lbnRhdGlvbihhc3luYyAobmFtZTogc3RyaW5nLCBvcGVyYXRpb246IEZ1bmN0aW9uKSA9PiB7XG4gICAgICAgIC8vIFNldCB1cCB1c2UgY2FzZSB0byByZXR1cm4gc3VjY2Vzc1xuICAgICAgICBtb2NrQ3JlYXRlQXNzZXRVc2VDYXNlLmV4ZWN1dGUubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgYXNzZXRJZDogXCJ0ZXN0LWlkXCIsXG4gICAgICAgICAgbWVzc2FnZTogXCJDcmVhdGVkIGFzc2V0OiBUZXN0IEFzc2V0XCIsXG4gICAgICAgIH0pO1xuICAgICAgICAvLyBFeGVjdXRlIHRoZSBvcGVyYXRpb25cbiAgICAgICAgcmV0dXJuIGF3YWl0IG9wZXJhdGlvbigpO1xuICAgICAgfSk7XG5cbiAgICAgIChtb2RhbCBhcyBhbnkpLmFzc2V0VGl0bGUgPSBcIlRlc3QgQXNzZXRcIjtcbiAgICAgIChtb2RhbCBhcyBhbnkpLmFzc2V0Q2xhc3MgPSBcImV4b19fVGFza1wiO1xuICAgICAgKG1vZGFsIGFzIGFueSkuYXNzZXRPbnRvbG9neSA9IFwiZXhvXCI7XG4gICAgICAobW9kYWwgYXMgYW55KS5wcm9wZXJ0eVZhbHVlcy5zZXQoXCJwcmlvcml0eVwiLCBcImhpZ2hcIik7XG5cbiAgICAgIGNvbnN0IGNsb3NlU3B5ID0gamVzdC5zcHlPbihtb2RhbCwgXCJjbG9zZVwiKS5tb2NrSW1wbGVtZW50YXRpb24oKCkgPT4ge30pO1xuXG4gICAgICBhd2FpdCAobW9kYWwgYXMgYW55KS5jcmVhdGVBc3NldCgpO1xuXG4gICAgICBleHBlY3QobW9ja0NpcmN1aXRCcmVha2VyLmV4ZWN1dGUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBcImFzc2V0LWNyZWF0aW9uXCIsXG4gICAgICAgIGV4cGVjdC5hbnkoRnVuY3Rpb24pLFxuICAgICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgZmFpbHVyZVRocmVzaG9sZDogMyxcbiAgICAgICAgICByZXNldFRpbWVvdXQ6IDMwMDAwLFxuICAgICAgICAgIGhhbGZPcGVuTWF4Q2FsbHM6IDIsXG4gICAgICAgIH0pXG4gICAgICApO1xuXG4gICAgICBleHBlY3QobW9ja0NyZWF0ZUFzc2V0VXNlQ2FzZS5leGVjdXRlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XG4gICAgICAgIHRpdGxlOiBcIlRlc3QgQXNzZXRcIixcbiAgICAgICAgY2xhc3NOYW1lOiBcImV4b19fVGFza1wiLFxuICAgICAgICBvbnRvbG9neVByZWZpeDogXCJleG9cIixcbiAgICAgICAgcHJvcGVydGllczoge1xuICAgICAgICAgIHByaW9yaXR5OiBcImhpZ2hcIixcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBleHBlY3QoTm90aWNlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcIkNyZWF0ZWQgYXNzZXQ6IFRlc3QgQXNzZXRcIik7XG4gICAgICBleHBlY3QoY2xvc2VTcHkpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcblxuICAgIHRlc3QoXCJzaG91bGQgaGFuZGxlIGFzc2V0IGNyZWF0aW9uIGZhaWx1cmUgdGhyb3VnaCBjaXJjdWl0IGJyZWFrZXJcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gU2V0dXAgY2lyY3VpdCBicmVha2VyIHRvIGV4ZWN1dGUgb3BlcmF0aW9uIGFuZCByZXR1cm4gZmFpbHVyZVxuICAgICAgbW9ja0NpcmN1aXRCcmVha2VyLmV4ZWN1dGUubW9ja0ltcGxlbWVudGF0aW9uKGFzeW5jIChuYW1lOiBzdHJpbmcsIG9wZXJhdGlvbjogRnVuY3Rpb24pID0+IHtcbiAgICAgICAgbW9ja0NyZWF0ZUFzc2V0VXNlQ2FzZS5leGVjdXRlLm1vY2tSZXNvbHZlZFZhbHVlKHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBhc3NldElkOiBcIlwiLFxuICAgICAgICAgIG1lc3NhZ2U6IFwiQ3JlYXRpb24gZmFpbGVkXCIsXG4gICAgICAgICAgZXJyb3I6IFwiSW52YWxpZCBhc3NldCBkYXRhXCIsXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gYXdhaXQgb3BlcmF0aW9uKCk7XG4gICAgICB9KTtcblxuICAgICAgKG1vZGFsIGFzIGFueSkuYXNzZXRUaXRsZSA9IFwiVGVzdCBBc3NldFwiO1xuXG4gICAgICBhd2FpdCAobW9kYWwgYXMgYW55KS5jcmVhdGVBc3NldCgpO1xuXG4gICAgICBleHBlY3QoTm90aWNlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcIkVycm9yOiBJbnZhbGlkIGFzc2V0IGRhdGFcIiwgNTAwMCk7XG4gICAgfSk7XG5cbiAgICB0ZXN0KFwic2hvdWxkIGhhbmRsZSBjaXJjdWl0IGJyZWFrZXIgb3BlbiBzdGF0ZVwiLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBTZXR1cCBjaXJjdWl0IGJyZWFrZXIgdG8gcmV0dXJuIGNpcmN1aXQgb3BlbiBlcnJvclxuICAgICAgbW9ja0NpcmN1aXRCcmVha2VyLmV4ZWN1dGUubW9ja1Jlc29sdmVkVmFsdWUoXG4gICAgICAgIFJlc3VsdC5mYWlsKFwiQ2lyY3VpdCBhc3NldC1jcmVhdGlvbiBpcyBPUEVOLiBUcnkgYWdhaW4gaW4gMjUgc2Vjb25kc1wiKVxuICAgICAgKTtcblxuICAgICAgKG1vZGFsIGFzIGFueSkuYXNzZXRUaXRsZSA9IFwiVGVzdCBBc3NldFwiO1xuXG4gICAgICBhd2FpdCAobW9kYWwgYXMgYW55KS5jcmVhdGVBc3NldCgpO1xuXG4gICAgICBleHBlY3QoTm90aWNlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgXCJBc3NldCBjcmVhdGlvbiBpcyB0ZW1wb3JhcmlseSB1bmF2YWlsYWJsZS4gUGxlYXNlIHRyeSBhZ2FpbiBpbiBhIG1vbWVudC5cIixcbiAgICAgICAgNTAwMFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIHRlc3QoXCJzaG91bGQgaGFuZGxlIG9udG9sb2d5LXJlbGF0ZWQgZXJyb3JzXCIsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tDaXJjdWl0QnJlYWtlci5leGVjdXRlLm1vY2tSZXNvbHZlZFZhbHVlKFxuICAgICAgICBSZXN1bHQuZmFpbChcIk9udG9sb2d5ICd0ZXN0JyBub3QgZm91bmRcIilcbiAgICAgICk7XG5cbiAgICAgIChtb2RhbCBhcyBhbnkpLmFzc2V0VGl0bGUgPSBcIlRlc3QgQXNzZXRcIjtcblxuICAgICAgYXdhaXQgKG1vZGFsIGFzIGFueSkuY3JlYXRlQXNzZXQoKTtcblxuICAgICAgZXhwZWN0KE5vdGljZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIFwiT250b2xvZ3kgaXNzdWU6IE9udG9sb2d5ICd0ZXN0JyBub3QgZm91bmRcIixcbiAgICAgICAgODAwMFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIHRlc3QoXCJzaG91bGQgaGFuZGxlIHZhbGlkYXRpb24gZXJyb3JzXCIsIGFzeW5jICgpID0+IHtcbiAgICAgIG1vY2tDaXJjdWl0QnJlYWtlci5leGVjdXRlLm1vY2tSZXNvbHZlZFZhbHVlKFxuICAgICAgICBSZXN1bHQuZmFpbChcIkludmFsaWQgYXNzZXQgdGl0bGU6IGNvbnRhaW5zIHNwZWNpYWwgY2hhcmFjdGVyc1wiKVxuICAgICAgKTtcblxuICAgICAgKG1vZGFsIGFzIGFueSkuYXNzZXRUaXRsZSA9IFwiVGVzdEBBc3NldCNcIjtcblxuICAgICAgYXdhaXQgKG1vZGFsIGFzIGFueSkuY3JlYXRlQXNzZXQoKTtcblxuICAgICAgZXhwZWN0KE5vdGljZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIFwiVmFsaWRhdGlvbiBlcnJvcjogSW52YWxpZCBhc3NldCB0aXRsZTogY29udGFpbnMgc3BlY2lhbCBjaGFyYWN0ZXJzXCIsXG4gICAgICAgIDYwMDBcbiAgICAgICk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKFwiUHJvcGVydHkgQ2FjaGluZ1wiLCAoKSA9PiB7XG4gICAgdGVzdChcInNob3VsZCB1c2UgcHJvcGVydHkgY2FjaGUgd2hlbiB1cGRhdGluZyBwcm9wZXJ0aWVzXCIsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGNhY2hlZFByb3BlcnRpZXMgPSBbXG4gICAgICAgIHtcbiAgICAgICAgICBuYW1lOiBcImNhY2hlZF9wcm9wXCIsXG4gICAgICAgICAgbGFiZWw6IFwiQ2FjaGVkIFByb3BlcnR5XCIsXG4gICAgICAgICAgZGVzY3JpcHRpb246IFwiRnJvbSBjYWNoZVwiLFxuICAgICAgICAgIHR5cGU6IFwic3RyaW5nXCIsXG4gICAgICAgICAgaXNSZXF1aXJlZDogZmFsc2UsXG4gICAgICAgIH0sXG4gICAgICBdO1xuXG4gICAgICBtb2NrUHJvcGVydHlDYWNoZS5nZXRQcm9wZXJ0aWVzRm9yQ2xhc3MubW9ja1JldHVyblZhbHVlKGNhY2hlZFByb3BlcnRpZXMpO1xuICAgICAgbW9ja1Byb3BlcnR5Q2FjaGUuaGFzUHJvcGVydGllc0ZvckNsYXNzLm1vY2tSZXR1cm5WYWx1ZSh0cnVlKTtcblxuICAgICAgYXdhaXQgKG1vZGFsIGFzIGFueSkudXBkYXRlUHJvcGVydGllc0ZvckNsYXNzKFwiVGVzdENsYXNzXCIpO1xuXG4gICAgICBleHBlY3QobW9ja1Byb3BlcnR5Q2FjaGUuZ2V0UHJvcGVydGllc0ZvckNsYXNzKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcIlRlc3RDbGFzc1wiKTtcbiAgICB9KTtcblxuICAgIHRlc3QoXCJzaG91bGQgdXBkYXRlIGNhY2hlIHdoZW4gcHJvcGVydGllcyBhcmUgbG9hZGVkIGZyb20gdmF1bHRcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgZmlsZSA9IHtcbiAgICAgICAgYmFzZW5hbWU6IFwicHJvcGVydHlOYW1lXCIsXG4gICAgICAgIG5hbWU6IFwicHJvcGVydHlOYW1lLm1kXCIsXG4gICAgICB9O1xuXG4gICAgICAoYXBwLnZhdWx0LmdldE1hcmtkb3duRmlsZXMgYXMgamVzdC5Nb2NrKS5tb2NrUmV0dXJuVmFsdWUoW2ZpbGVdKTtcbiAgICAgIChhcHAubWV0YWRhdGFDYWNoZS5nZXRGaWxlQ2FjaGUgYXMgamVzdC5Nb2NrKS5tb2NrUmV0dXJuVmFsdWUoe1xuICAgICAgICBmcm9udG1hdHRlcjoge1xuICAgICAgICAgIGV4b19fSW5zdGFuY2VfY2xhc3M6IFwiZXhvX19Qcm9wZXJ0eVwiLFxuICAgICAgICAgIHJkZnNfX2RvbWFpbjogXCJUZXN0Q2xhc3NcIixcbiAgICAgICAgICByZGZzX19sYWJlbDogXCJQcm9wZXJ0eSBMYWJlbFwiLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIG1vY2tQcm9wZXJ0eUNhY2hlLmhhc1Byb3BlcnRpZXNGb3JDbGFzcy5tb2NrUmV0dXJuVmFsdWUoZmFsc2UpO1xuXG4gICAgICBhd2FpdCAobW9kYWwgYXMgYW55KS51cGRhdGVQcm9wZXJ0aWVzRm9yQ2xhc3MoXCJUZXN0Q2xhc3NcIik7XG5cbiAgICAgIC8vIFByb3BlcnRpZXMgc2hvdWxkIGJlIGxvYWRlZCBhbmQgY2FjaGVkXG4gICAgICBleHBlY3QobW9ja1Byb3BlcnR5Q2FjaGUudXBkYXRlQ2xhc3NQcm9wZXJ0aWVzKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpOyAvLyBDYWNoZSB1cGRhdGUgaXMgaGFuZGxlZCBpbnRlcm5hbGx5XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKFwiTW9kYWwgSW5pdGlhbGl6YXRpb25cIiwgKCkgPT4ge1xuICAgIHRlc3QoXCJzaG91bGQgaW5pdGlhbGl6ZSB3aXRoIGNvcnJlY3QgZGVmYXVsdCB2YWx1ZXNcIiwgKCkgPT4ge1xuICAgICAgZXhwZWN0KChtb2RhbCBhcyBhbnkpLmFzc2V0VGl0bGUpLnRvQmUoXCJcIik7XG4gICAgICBleHBlY3QoKG1vZGFsIGFzIGFueSkuYXNzZXRDbGFzcykudG9CZShcImV4b19fQXNzZXRcIik7XG4gICAgICBleHBlY3QoKG1vZGFsIGFzIGFueSkuYXNzZXRPbnRvbG9neSkudG9CZShcIlwiKTtcbiAgICAgIGV4cGVjdCgobW9kYWwgYXMgYW55KS5wcm9wZXJ0eVZhbHVlcykudG9CZUluc3RhbmNlT2YoTWFwKTtcbiAgICAgIGV4cGVjdCgobW9kYWwgYXMgYW55KS5wcm9wZXJ0eVZhbHVlcy5zaXplKS50b0JlKDApO1xuICAgIH0pO1xuXG4gICAgdGVzdChcInNob3VsZCBwcm9wZXJseSByZXNvbHZlIHNlcnZpY2VzIGZyb20gY29udGFpbmVyXCIsICgpID0+IHtcbiAgICAgIGV4cGVjdChtb2NrQ29udGFpbmVyLnJlc29sdmUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFwiSU9udG9sb2d5UmVwb3NpdG9yeVwiKTtcbiAgICAgIGV4cGVjdChtb2NrQ29udGFpbmVyLnJlc29sdmUpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFwiSUNsYXNzVmlld1JlcG9zaXRvcnlcIik7XG4gICAgICBleHBlY3QobW9ja0NvbnRhaW5lci5yZXNvbHZlKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcIlByb3BlcnR5Q2FjaGVTZXJ2aWNlXCIpO1xuICAgICAgZXhwZWN0KG1vY2tDb250YWluZXIucmVzb2x2ZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXCJDaXJjdWl0QnJlYWtlclNlcnZpY2VcIik7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKFwiRXJyb3IgUmVjb3ZlcnlcIiwgKCkgPT4ge1xuICAgIHRlc3QoXCJzaG91bGQgcmVjb3ZlciBmcm9tIGNpcmN1aXQgYnJlYWtlciBlcnJvcnNcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gRmlyc3QgY2FsbCBmYWlsc1xuICAgICAgbW9ja0NpcmN1aXRCcmVha2VyLmV4ZWN1dGUubW9ja1Jlc29sdmVkVmFsdWVPbmNlKFxuICAgICAgICBSZXN1bHQuZmFpbChcIkNpcmN1aXQgaXMgb3BlblwiKVxuICAgICAgKTtcblxuICAgICAgKG1vZGFsIGFzIGFueSkuYXNzZXRUaXRsZSA9IFwiVGVzdCBBc3NldFwiO1xuICAgICAgYXdhaXQgKG1vZGFsIGFzIGFueSkuY3JlYXRlQXNzZXQoKTtcblxuICAgICAgZXhwZWN0KE5vdGljZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICAgIFwiQXNzZXQgY3JlYXRpb24gaXMgdGVtcG9yYXJpbHkgdW5hdmFpbGFibGUuIFBsZWFzZSB0cnkgYWdhaW4gaW4gYSBtb21lbnQuXCIsXG4gICAgICAgIDUwMDBcbiAgICAgICk7XG5cbiAgICAgIC8vIFJlc2V0IE5vdGljZSBtb2NrIGZvciBzZWNvbmQgY2FsbFxuICAgICAgKE5vdGljZSBhcyBqZXN0Lk1vY2spLm1vY2tDbGVhcigpO1xuXG4gICAgICAvLyBTZWNvbmQgY2FsbCBzdWNjZWVkcyBhZnRlciBjaXJjdWl0IHJlY292ZXJ5XG4gICAgICBtb2NrQ2lyY3VpdEJyZWFrZXIuZXhlY3V0ZS5tb2NrSW1wbGVtZW50YXRpb24oYXN5bmMgKG5hbWU6IHN0cmluZywgb3BlcmF0aW9uOiBGdW5jdGlvbikgPT4ge1xuICAgICAgICBtb2NrQ3JlYXRlQXNzZXRVc2VDYXNlLmV4ZWN1dGUubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgYXNzZXRJZDogXCJ0ZXN0LWlkXCIsXG4gICAgICAgICAgbWVzc2FnZTogXCJDcmVhdGVkIGFzc2V0OiBUZXN0IEFzc2V0XCIsXG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gYXdhaXQgb3BlcmF0aW9uKCk7XG4gICAgICB9KTtcblxuICAgICAgYXdhaXQgKG1vZGFsIGFzIGFueSkuY3JlYXRlQXNzZXQoKTtcblxuICAgICAgZXhwZWN0KE5vdGljZSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXCJDcmVhdGVkIGFzc2V0OiBUZXN0IEFzc2V0XCIpO1xuICAgIH0pO1xuICB9KTtcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==