1cafc9bb2c3db241ec31dc3c2abdb7ac
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DynamicBacklinksBlockRenderer = void 0;
const DynamicBacklinksService_1 = require("../../application/services/DynamicBacklinksService");
const ObsidianVaultAdapter_1 = require("../../infrastructure/adapters/ObsidianVaultAdapter");
const ObsidianUIAdapter_1 = require("../../infrastructure/adapters/ObsidianUIAdapter");
class DynamicBacklinksBlockRenderer {
    constructor(app) {
        this.app = app;
        const vaultAdapter = new ObsidianVaultAdapter_1.ObsidianVaultAdapter(this.app.vault, this.app.metadataCache);
        const uiAdapter = new ObsidianUIAdapter_1.ObsidianUIAdapter(this.app);
        this.dynamicBacklinksService = new DynamicBacklinksService_1.DynamicBacklinksService(vaultAdapter, uiAdapter);
    }
    async render(container, config, file, dv) {
        // Discover property-based backlinks
        const backlinkResult = await this.dynamicBacklinksService.discoverPropertyBasedBacklinks(file, {
            excludeProperties: config.excludeProperties || [
                "exo__Asset_id",
                "exo__Instance_class",
            ],
            maxResultsPerProperty: config.maxResultsPerProperty,
            filterByClass: config.filterByClass,
        });
        if (backlinkResult.isFailure) {
            container.createEl("p", {
                text: `Error discovering backlinks: ${backlinkResult.getError()}`,
                cls: "exocortex-error",
            });
            return;
        }
        const propertyBacklinks = backlinkResult.getValue();
        if (propertyBacklinks.length === 0) {
            container.createEl("p", {
                text: "No property-based backlinks found",
                cls: "exocortex-empty",
            });
            return;
        }
        // Render each property group as a separate section
        for (const propertyGroup of propertyBacklinks) {
            if (!config.showEmptyProperties &&
                propertyGroup.referencingFiles.length === 0) {
                continue;
            }
            await this.renderPropertyGroup(container, propertyGroup, config);
        }
    }
    async renderPropertyGroup(container, propertyGroup, config) {
        const groupContainer = container.createDiv({
            cls: "exocortex-dynamic-backlinks-group",
        });
        // Property header
        const header = groupContainer.createEl("h4", {
            text: `${this.formatPropertyName(propertyGroup.propertyName)} (${propertyGroup.referencingFiles.length})`,
            cls: "exocortex-property-backlinks-header",
        });
        if (propertyGroup.referencingFiles.length === 0) {
            groupContainer.createEl("p", {
                text: "No files reference this asset via this property",
                cls: "exocortex-empty",
            });
            return;
        }
        // Render backlinks list
        const list = groupContainer.createEl("ul", {
            cls: "exocortex-property-backlinks-list",
        });
        for (const backlinkFile of propertyGroup.referencingFiles) {
            await this.renderBacklinkItem(list, backlinkFile);
        }
    }
    async renderBacklinkItem(list, file) {
        const metadata = this.app.metadataCache.getFileCache(file);
        const frontmatter = metadata?.frontmatter || {};
        const item = list.createEl("li", { cls: "exocortex-backlink-item" });
        // File link
        const link = item.createEl("a", {
            text: frontmatter["exo__Asset_label"] || file.basename,
            href: file.path,
            cls: "internal-link",
        });
        // Class info (if available)
        const instanceClass = frontmatter["exo__Instance_class"];
        if (instanceClass) {
            const classSpan = item.createEl("span", {
                text: ` (${this.cleanClassName(instanceClass)})`,
                cls: "exocortex-class-info",
            });
        }
        // File path (for disambiguation)
        if (file.path !== `${file.basename}.md`) {
            const pathSpan = item.createEl("span", {
                text: ` - ${file.path}`,
                cls: "exocortex-path-info",
            });
        }
    }
    formatPropertyName(propertyName) {
        // Convert property names to more readable format
        return propertyName
            .replace(/^ems__/, "") // Remove ems__ prefix
            .replace(/^exo__/, "") // Remove exo__ prefix
            .replace(/_/g, " ") // Replace underscores with spaces
            .replace(/\b\w/g, (l) => l.toUpperCase()); // Capitalize words
    }
    cleanClassName(className) {
        if (!className)
            return "";
        const str = Array.isArray(className) ? className[0] : className;
        return str?.toString().replace(/\[\[|\]\]/g, "") || "";
    }
}
exports.DynamicBacklinksBlockRenderer = DynamicBacklinksBlockRenderer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL3ByZXNlbnRhdGlvbi9yZW5kZXJlcnMvRHluYW1pY0JhY2tsaW5rc0Jsb2NrUmVuZGVyZXIudHMiLCJtYXBwaW5ncyI6Ijs7O0FBRUEsZ0dBRzREO0FBQzVELDZGQUEwRjtBQUMxRix1RkFBb0Y7QUFFcEYsTUFBYSw2QkFBNkI7SUFHeEMsWUFBb0IsR0FBUTtRQUFSLFFBQUcsR0FBSCxHQUFHLENBQUs7UUFDMUIsTUFBTSxZQUFZLEdBQUcsSUFBSSwyQ0FBb0IsQ0FDM0MsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQ2QsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQ3ZCLENBQUM7UUFDRixNQUFNLFNBQVMsR0FBRyxJQUFJLHFDQUFpQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNsRCxJQUFJLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxpREFBdUIsQ0FDeEQsWUFBWSxFQUNaLFNBQVMsQ0FDVixDQUFDO0lBQ0osQ0FBQztJQUVELEtBQUssQ0FBQyxNQUFNLENBQ1YsU0FBc0IsRUFDdEIsTUFBbUMsRUFDbkMsSUFBVyxFQUNYLEVBQU87UUFFUCxvQ0FBb0M7UUFDcEMsTUFBTSxjQUFjLEdBQ2xCLE1BQU0sSUFBSSxDQUFDLHVCQUF1QixDQUFDLDhCQUE4QixDQUFDLElBQUksRUFBRTtZQUN0RSxpQkFBaUIsRUFBRSxNQUFNLENBQUMsaUJBQWlCLElBQUk7Z0JBQzdDLGVBQWU7Z0JBQ2YscUJBQXFCO2FBQ3RCO1lBQ0QscUJBQXFCLEVBQUUsTUFBTSxDQUFDLHFCQUFxQjtZQUNuRCxhQUFhLEVBQUUsTUFBTSxDQUFDLGFBQWE7U0FDcEMsQ0FBQyxDQUFDO1FBRUwsSUFBSSxjQUFjLENBQUMsU0FBUyxFQUFFO1lBQzVCLFNBQVMsQ0FBQyxRQUFRLENBQUMsR0FBRyxFQUFFO2dCQUN0QixJQUFJLEVBQUUsZ0NBQWdDLGNBQWMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtnQkFD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LCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL3ByZXNlbnRhdGlvbi9yZW5kZXJlcnMvRHluYW1pY0JhY2tsaW5rc0Jsb2NrUmVuZGVyZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwLCBURmlsZSB9IGZyb20gXCJvYnNpZGlhblwiO1xuaW1wb3J0IHsgRHluYW1pY0JhY2tsaW5rc0Jsb2NrQ29uZmlnIH0gZnJvbSBcIi4uLy4uL2RvbWFpbi9lbnRpdGllcy9MYXlvdXRCbG9ja1wiO1xuaW1wb3J0IHtcbiAgRHluYW1pY0JhY2tsaW5rc1NlcnZpY2UsXG4gIFByb3BlcnR5QmFzZWRCYWNrbGluayxcbn0gZnJvbSBcIi4uLy4uL2FwcGxpY2F0aW9uL3NlcnZpY2VzL0R5bmFtaWNCYWNrbGlua3NTZXJ2aWNlXCI7XG5pbXBvcnQgeyBPYnNpZGlhblZhdWx0QWRhcHRlciB9IGZyb20gXCIuLi8uLi9pbmZyYXN0cnVjdHVyZS9hZGFwdGVycy9PYnNpZGlhblZhdWx0QWRhcHRlclwiO1xuaW1wb3J0IHsgT2JzaWRpYW5VSUFkYXB0ZXIgfSBmcm9tIFwiLi4vLi4vaW5mcmFzdHJ1Y3R1cmUvYWRhcHRlcnMvT2JzaWRpYW5VSUFkYXB0ZXJcIjtcblxuZXhwb3J0IGNsYXNzIER5bmFtaWNCYWNrbGlua3NCbG9ja1JlbmRlcmVyIHtcbiAgcHJpdmF0ZSBkeW5hbWljQmFja2xpbmtzU2VydmljZTogRHluYW1pY0JhY2tsaW5rc1NlcnZpY2U7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBhcHA6IEFwcCkge1xuICAgIGNvbnN0IHZhdWx0QWRhcHRlciA9IG5ldyBPYnNpZGlhblZhdWx0QWRhcHRlcihcbiAgICAgIHRoaXMuYXBwLnZhdWx0LFxuICAgICAgdGhpcy5hcHAubWV0YWRhdGFDYWNoZSxcbiAgICApO1xuICAgIGNvbnN0IHVpQWRhcHRlciA9IG5ldyBPYnNpZGlhblVJQWRhcHRlcih0aGlzLmFwcCk7XG4gICAgdGhpcy5keW5hbWljQmFja2xpbmtzU2VydmljZSA9IG5ldyBEeW5hbWljQmFja2xpbmtzU2VydmljZShcbiAgICAgIHZhdWx0QWRhcHRlcixcbiAgICAgIHVpQWRhcHRlcixcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgcmVuZGVyKFxuICAgIGNvbnRhaW5lcjogSFRNTEVsZW1lbnQsXG4gICAgY29uZmlnOiBEeW5hbWljQmFja2xpbmtzQmxvY2tDb25maWcsXG4gICAgZmlsZTogVEZpbGUsXG4gICAgZHY6IGFueSxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8gRGlzY292ZXIgcHJvcGVydHktYmFzZWQgYmFja2xpbmtzXG4gICAgY29uc3QgYmFja2xpbmtSZXN1bHQgPVxuICAgICAgYXdhaXQgdGhpcy5keW5hbWljQmFja2xpbmtzU2VydmljZS5kaXNjb3ZlclByb3BlcnR5QmFzZWRCYWNrbGlua3MoZmlsZSwge1xuICAgICAgICBleGNsdWRlUHJvcGVydGllczogY29uZmlnLmV4Y2x1ZGVQcm9wZXJ0aWVzIHx8IFtcbiAgICAgICAgICBcImV4b19fQXNzZXRfaWRcIixcbiAgICAgICAgICBcImV4b19fSW5zdGFuY2VfY2xhc3NcIixcbiAgICAgICAgXSxcbiAgICAgICAgbWF4UmVzdWx0c1BlclByb3BlcnR5OiBjb25maWcubWF4UmVzdWx0c1BlclByb3BlcnR5LFxuICAgICAgICBmaWx0ZXJCeUNsYXNzOiBjb25maWcuZmlsdGVyQnlDbGFzcyxcbiAgICAgIH0pO1xuXG4gICAgaWYgKGJhY2tsaW5rUmVzdWx0LmlzRmFpbHVyZSkge1xuICAgICAgY29udGFpbmVyLmNyZWF0ZUVsKFwicFwiLCB7XG4gICAgICAgIHRleHQ6IGBFcnJvciBkaXNjb3ZlcmluZyBiYWNrbGlua3M6ICR7YmFja2xpbmtSZXN1bHQuZ2V0RXJyb3IoKX1gLFxuICAgICAgICBjbHM6IFwiZXhvY29ydGV4LWVycm9yXCIsXG4gICAgICB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBwcm9wZXJ0eUJhY2tsaW5rcyA9IGJhY2tsaW5rUmVzdWx0LmdldFZhbHVlKCk7XG5cbiAgICBpZiAocHJvcGVydHlCYWNrbGlua3MubGVuZ3RoID09PSAwKSB7XG4gICAgICBjb250YWluZXIuY3JlYXRlRWwoXCJwXCIsIHtcbiAgICAgICAgdGV4dDogXCJObyBwcm9wZXJ0eS1iYXNlZCBiYWNrbGlua3MgZm91bmRcIixcbiAgICAgICAgY2xzOiBcImV4b2NvcnRleC1lbXB0eVwiLFxuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gUmVuZGVyIGVhY2ggcHJvcGVydHkgZ3JvdXAgYXMgYSBzZXBhcmF0ZSBzZWN0aW9uXG4gICAgZm9yIChjb25zdCBwcm9wZXJ0eUdyb3VwIG9mIHByb3BlcnR5QmFja2xpbmtzKSB7XG4gICAgICBpZiAoXG4gICAgICAgICFjb25maWcuc2hvd0VtcHR5UHJvcGVydGllcyAmJlxuICAgICAgICBwcm9wZXJ0eUdyb3VwLnJlZmVyZW5jaW5nRmlsZXMubGVuZ3RoID09PSAwXG4gICAgICApIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGF3YWl0IHRoaXMucmVuZGVyUHJvcGVydHlHcm91cChjb250YWluZXIsIHByb3BlcnR5R3JvdXAsIGNvbmZpZyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyByZW5kZXJQcm9wZXJ0eUdyb3VwKFxuICAgIGNvbnRhaW5lcjogSFRNTEVsZW1lbnQsXG4gICAgcHJvcGVydHlHcm91cDogUHJvcGVydHlCYXNlZEJhY2tsaW5rLFxuICAgIGNvbmZpZzogRHluYW1pY0JhY2tsaW5rc0Jsb2NrQ29uZmlnLFxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBncm91cENvbnRhaW5lciA9IGNvbnRhaW5lci5jcmVhdGVEaXYoe1xuICAgICAgY2xzOiBcImV4b2NvcnRleC1keW5hbWljLWJhY2tsaW5rcy1ncm91cFwiLFxuICAgIH0pO1xuXG4gICAgLy8gUHJvcGVydHkgaGVhZGVyXG4gICAgY29uc3QgaGVhZGVyID0gZ3JvdXBDb250YWluZXIuY3JlYXRlRWwoXCJoNFwiLCB7XG4gICAgICB0ZXh0OiBgJHt0aGlzLmZvcm1hdFByb3BlcnR5TmFtZShwcm9wZXJ0eUdyb3VwLnByb3BlcnR5TmFtZSl9ICgke3Byb3BlcnR5R3JvdXAucmVmZXJlbmNpbmdGaWxlcy5sZW5ndGh9KWAsXG4gICAgICBjbHM6IFwiZXhvY29ydGV4LXByb3BlcnR5LWJhY2tsaW5rcy1oZWFkZXJcIixcbiAgICB9KTtcblxuICAgIGlmIChwcm9wZXJ0eUdyb3VwLnJlZmVyZW5jaW5nRmlsZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICBncm91cENvbnRhaW5lci5jcmVhdGVFbChcInBcIiwge1xuICAgICAgICB0ZXh0OiBcIk5vIGZpbGVzIHJlZmVyZW5jZSB0aGlzIGFzc2V0IHZpYSB0aGlzIHByb3BlcnR5XCIsXG4gICAgICAgIGNsczogXCJleG9jb3J0ZXgtZW1wdHlcIixcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIFJlbmRlciBiYWNrbGlua3MgbGlzdFxuICAgIGNvbnN0IGxpc3QgPSBncm91cENvbnRhaW5lci5jcmVhdGVFbChcInVsXCIsIHtcbiAgICAgIGNsczogXCJleG9jb3J0ZXgtcHJvcGVydHktYmFja2xpbmtzLWxpc3RcIixcbiAgICB9KTtcblxuICAgIGZvciAoY29uc3QgYmFja2xpbmtGaWxlIG9mIHByb3BlcnR5R3JvdXAucmVmZXJlbmNpbmdGaWxlcykge1xuICAgICAgYXdhaXQgdGhpcy5yZW5kZXJCYWNrbGlua0l0ZW0obGlzdCwgYmFja2xpbmtGaWxlKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHJlbmRlckJhY2tsaW5rSXRlbShcbiAgICBsaXN0OiBIVE1MRWxlbWVudCxcbiAgICBmaWxlOiBURmlsZSxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLmFwcC5tZXRhZGF0YUNhY2hlLmdldEZpbGVDYWNoZShmaWxlKTtcbiAgICBjb25zdCBmcm9udG1hdHRlciA9IG1ldGFkYXRhPy5mcm9udG1hdHRlciB8fCB7fTtcblxuICAgIGNvbnN0IGl0ZW0gPSBsaXN0LmNyZWF0ZUVsKFwibGlcIiwgeyBjbHM6IFwiZXhvY29ydGV4LWJhY2tsaW5rLWl0ZW1cIiB9KTtcblxuICAgIC8vIEZpbGUgbGlua1xuICAgIGNvbnN0IGxpbmsgPSBpdGVtLmNyZWF0ZUVsKFwiYVwiLCB7XG4gICAgICB0ZXh0OiBmcm9udG1hdHRlcltcImV4b19fQXNzZXRfbGFiZWxcIl0gfHwgZmlsZS5iYXNlbmFtZSxcbiAgICAgIGhyZWY6IGZpbGUucGF0aCxcbiAgICAgIGNsczogXCJpbnRlcm5hbC1saW5rXCIsXG4gICAgfSk7XG5cbiAgICAvLyBDbGFzcyBpbmZvIChpZiBhdmFpbGFibGUpXG4gICAgY29uc3QgaW5zdGFuY2VDbGFzcyA9IGZyb250bWF0dGVyW1wiZXhvX19JbnN0YW5jZV9jbGFzc1wiXTtcbiAgICBpZiAoaW5zdGFuY2VDbGFzcykge1xuICAgICAgY29uc3QgY2xhc3NTcGFuID0gaXRlbS5jcmVhdGVFbChcInNwYW5cIiwge1xuICAgICAgICB0ZXh0OiBgICgke3RoaXMuY2xlYW5DbGFzc05hbWUoaW5zdGFuY2VDbGFzcyl9KWAsXG4gICAgICAgIGNsczogXCJleG9jb3J0ZXgtY2xhc3MtaW5mb1wiLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gRmlsZSBwYXRoIChmb3IgZGlzYW1iaWd1YXRpb24pXG4gICAgaWYgKGZpbGUucGF0aCAhPT0gYCR7ZmlsZS5iYXNlbmFtZX0ubWRgKSB7XG4gICAgICBjb25zdCBwYXRoU3BhbiA9IGl0ZW0uY3JlYXRlRWwoXCJzcGFuXCIsIHtcbiAgICAgICAgdGV4dDogYCAtICR7ZmlsZS5wYXRofWAsXG4gICAgICAgIGNsczogXCJleG9jb3J0ZXgtcGF0aC1pbmZvXCIsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGZvcm1hdFByb3BlcnR5TmFtZShwcm9wZXJ0eU5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgLy8gQ29udmVydCBwcm9wZXJ0eSBuYW1lcyB0byBtb3JlIHJlYWRhYmxlIGZvcm1hdFxuICAgIHJldHVybiBwcm9wZXJ0eU5hbWVcbiAgICAgIC5yZXBsYWNlKC9eZW1zX18vLCBcIlwiKSAvLyBSZW1vdmUgZW1zX18gcHJlZml4XG4gICAgICAucmVwbGFjZSgvXmV4b19fLywgXCJcIikgLy8gUmVtb3ZlIGV4b19fIHByZWZpeFxuICAgICAgLnJlcGxhY2UoL18vZywgXCIgXCIpIC8vIFJlcGxhY2UgdW5kZXJzY29yZXMgd2l0aCBzcGFjZXNcbiAgICAgIC5yZXBsYWNlKC9cXGJcXHcvZywgKGwpID0+IGwudG9VcHBlckNhc2UoKSk7IC8vIENhcGl0YWxpemUgd29yZHNcbiAgfVxuXG4gIHByaXZhdGUgY2xlYW5DbGFzc05hbWUoY2xhc3NOYW1lOiBhbnkpOiBzdHJpbmcge1xuICAgIGlmICghY2xhc3NOYW1lKSByZXR1cm4gXCJcIjtcbiAgICBjb25zdCBzdHIgPSBBcnJheS5pc0FycmF5KGNsYXNzTmFtZSkgPyBjbGFzc05hbWVbMF0gOiBjbGFzc05hbWU7XG4gICAgcmV0dXJuIHN0cj8udG9TdHJpbmcoKS5yZXBsYWNlKC9cXFtcXFt8XFxdXFxdL2csIFwiXCIpIHx8IFwiXCI7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==