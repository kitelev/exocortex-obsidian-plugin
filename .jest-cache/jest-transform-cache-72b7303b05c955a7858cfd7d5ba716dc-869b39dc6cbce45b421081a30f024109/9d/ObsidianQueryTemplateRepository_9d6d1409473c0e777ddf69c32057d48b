e795c614de0b7080883409ff492d41a1
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ObsidianQueryTemplateRepository = void 0;
const QueryTemplate_1 = require("../../domain/visual/QueryTemplate");
const BuiltInQueryTemplates_1 = require("./BuiltInQueryTemplates");
class ObsidianQueryTemplateRepository {
    constructor(app, templatesPath = ".exocortex/templates", usageDataPath = ".exocortex/template-usage.json") {
        this.app = app;
        this.templateCache = new Map();
        this.usageData = new Map();
        this.cacheLoaded = false;
        this.templatesPath = templatesPath;
        this.usageDataPath = usageDataPath;
    }
    async findAll() {
        await this.ensureCacheLoaded();
        const templates = Array.from(this.templateCache.values());
        // Sort by usage frequency and then by name
        return templates.sort((a, b) => {
            const usageA = this.usageData.get(a.getId())?.usageCount || 0;
            const usageB = this.usageData.get(b.getId())?.usageCount || 0;
            if (usageA !== usageB) {
                return usageB - usageA;
            }
            return a.getMetadata().name.localeCompare(b.getMetadata().name);
        });
    }
    async findByCriteria(criteria) {
        await this.ensureCacheLoaded();
        let templates = Array.from(this.templateCache.values());
        if (criteria.category) {
            templates = templates.filter((t) => t.getMetadata().category === criteria.category);
        }
        if (criteria.difficulty) {
            templates = templates.filter((t) => t.getMetadata().difficulty === criteria.difficulty);
        }
        if (criteria.nameContains) {
            const searchTerm = criteria.nameContains.toLowerCase();
            templates = templates.filter((t) => t.getMetadata().name.toLowerCase().includes(searchTerm) ||
                t.getMetadata().description.toLowerCase().includes(searchTerm));
        }
        if (criteria.tags && criteria.tags.length > 0) {
            templates = templates.filter((t) => {
                const templateTags = t.getMetadata().tags;
                return criteria.tags.some((tag) => templateTags.includes(tag));
            });
        }
        if (criteria.includeBuiltIn !== undefined) {
            templates = templates.filter((t) => t.isBuiltInTemplate() === criteria.includeBuiltIn);
        }
        if (criteria.includeCustom !== undefined) {
            templates = templates.filter((t) => !t.isBuiltInTemplate() === criteria.includeCustom);
        }
        return templates;
    }
    async findById(id) {
        await this.ensureCacheLoaded();
        return this.templateCache.get(id);
    }
    async findByCategory(category) {
        return this.findByCriteria({ category });
    }
    async findByTags(tags) {
        return this.findByCriteria({ tags });
    }
    async save(template) {
        if (template.isBuiltInTemplate()) {
            throw new Error("Cannot modify built-in templates");
        }
        const exists = await this.exists(template.getId());
        if (exists) {
            return this.update(template);
        }
        else {
            return this.create(template);
        }
    }
    async create(template) {
        if (template.isBuiltInTemplate()) {
            throw new Error("Cannot create built-in templates through repository");
        }
        const exists = await this.exists(template.getId());
        if (exists) {
            throw new Error(`Template with ID ${template.getId()} already exists`);
        }
        await this.ensureTemplatesDirectoryExists();
        const fileName = `${this.sanitizeFileName(template.getMetadata().name)}-${template.getId()}.json`;
        const filePath = `${this.templatesPath}/${fileName}`;
        const data = {
            id: template.getId(),
            metadata: template.getMetadata(),
            layout: template.getLayout(),
            parameters: template.getParameters(),
            sparqlTemplate: template.getSparqlTemplate(),
            isBuiltIn: template.isBuiltInTemplate(),
        };
        await this.app.vault.create(filePath, JSON.stringify(data, null, 2));
        this.templateCache.set(template.getId(), template);
        return template;
    }
    async update(template) {
        if (template.isBuiltInTemplate()) {
            throw new Error("Cannot modify built-in templates");
        }
        const exists = await this.exists(template.getId());
        if (!exists) {
            throw new Error(`Template with ID ${template.getId()} not found`);
        }
        await this.ensureTemplatesDirectoryExists();
        const fileName = await this.findTemplateFile(template.getId());
        if (!fileName) {
            throw new Error(`Template file not found for ID ${template.getId()}`);
        }
        const filePath = `${this.templatesPath}/${fileName}`;
        const file = this.app.vault.getAbstractFileByPath(filePath);
        const data = {
            id: template.getId(),
            metadata: template.getMetadata(),
            layout: template.getLayout(),
            parameters: template.getParameters(),
            sparqlTemplate: template.getSparqlTemplate(),
            isBuiltIn: template.isBuiltInTemplate(),
        };
        await this.app.vault.modify(file, JSON.stringify(data, null, 2));
        this.templateCache.set(template.getId(), template);
        return template;
    }
    async delete(id) {
        const template = await this.findById(id);
        if (!template) {
            return false;
        }
        if (template.isBuiltInTemplate()) {
            throw new Error("Cannot delete built-in templates");
        }
        const fileName = await this.findTemplateFile(id);
        if (!fileName) {
            return false;
        }
        const filePath = `${this.templatesPath}/${fileName}`;
        const file = this.app.vault.getAbstractFileByPath(filePath);
        if (file) {
            await this.app.vault.delete(file);
            this.templateCache.delete(id);
            this.usageData.delete(id);
            await this.saveUsageData();
            return true;
        }
        return false;
    }
    async exists(id) {
        await this.ensureCacheLoaded();
        return this.templateCache.has(id);
    }
    async importTemplates(templatesData) {
        const imported = [];
        for (const templateData of templatesData) {
            try {
                const data = templateData;
                // Don't import if already exists and is built-in
                const existing = this.templateCache.get(data.id);
                if (existing && existing.isBuiltInTemplate()) {
                    continue;
                }
                const template = this.createTemplateFromData(data);
                await this.save(template);
                imported.push(template);
            }
            catch (error) {
                console.warn("Failed to import template:", error);
            }
        }
        return imported;
    }
    async exportTemplates(templateIds) {
        await this.ensureCacheLoaded();
        let templates;
        if (templateIds) {
            templates = templateIds
                .map((id) => this.templateCache.get(id))
                .filter((t) => t !== undefined);
        }
        else {
            templates = Array.from(this.templateCache.values());
        }
        return templates.map((template) => template.toJSON());
    }
    async getBuiltInTemplates() {
        return this.findByCriteria({ includeBuiltIn: true, includeCustom: false });
    }
    async getCustomTemplates() {
        return this.findByCriteria({ includeBuiltIn: false, includeCustom: true });
    }
    async getRecentlyUsed(limit = 10) {
        await this.ensureCacheLoaded();
        const templateUsage = Array.from(this.usageData.entries())
            .sort((a, b) => b[1].lastUsed.getTime() - a[1].lastUsed.getTime())
            .slice(0, limit);
        return templateUsage
            .map(([id]) => this.templateCache.get(id))
            .filter((t) => t !== undefined);
    }
    async recordUsage(templateId) {
        await this.ensureCacheLoaded();
        const existing = this.usageData.get(templateId);
        if (existing) {
            existing.usageCount++;
            existing.lastUsed = new Date();
        }
        else {
            this.usageData.set(templateId, {
                templateId,
                usageCount: 1,
                lastUsed: new Date(),
                parametersFilled: [],
            });
        }
        await this.saveUsageData();
    }
    async getUsageStats(templateId) {
        await this.ensureCacheLoaded();
        const usage = this.usageData.get(templateId);
        if (!usage) {
            return { usageCount: 0 };
        }
        const averageParametersFilled = usage.parametersFilled.length > 0
            ? usage.parametersFilled.reduce((sum, count) => sum + count, 0) /
                usage.parametersFilled.length
            : undefined;
        return {
            usageCount: usage.usageCount,
            lastUsed: usage.lastUsed,
            averageParametersFilled,
        };
    }
    async refresh() {
        this.templateCache.clear();
        this.usageData.clear();
        this.cacheLoaded = false;
        await this.loadBuiltInTemplates();
        await this.loadCustomTemplates();
        await this.loadUsageData();
        this.cacheLoaded = true;
    }
    async ensureCacheLoaded() {
        if (!this.cacheLoaded) {
            await this.refresh();
        }
    }
    async ensureTemplatesDirectoryExists() {
        const templatesDir = this.app.vault.getAbstractFileByPath(this.templatesPath);
        if (!templatesDir) {
            await this.app.vault.createFolder(this.templatesPath);
        }
    }
    async loadBuiltInTemplates() {
        const builtInTemplates = BuiltInQueryTemplates_1.BuiltInQueryTemplates.getAll();
        builtInTemplates.forEach((template) => {
            this.templateCache.set(template.getId(), template);
        });
    }
    async loadCustomTemplates() {
        await this.ensureTemplatesDirectoryExists();
        const templatesDir = this.app.vault.getAbstractFileByPath(this.templatesPath);
        if (!templatesDir || !templatesDir.children) {
            return;
        }
        const files = templatesDir.children.filter((file) => file.extension === "json" && file.name.endsWith(".json"));
        for (const file of files) {
            try {
                const content = await this.app.vault.read(file);
                const data = JSON.parse(content);
                const template = this.createTemplateFromData(data);
                this.templateCache.set(template.getId(), template);
            }
            catch (error) {
                console.warn(`Failed to load template from ${file.path}:`, error);
            }
        }
    }
    async loadUsageData() {
        try {
            const file = this.app.vault.getAbstractFileByPath(this.usageDataPath);
            if (file) {
                const content = await this.app.vault.read(file);
                const data = JSON.parse(content);
                this.usageData.clear();
                data.forEach((usage) => {
                    usage.lastUsed = new Date(usage.lastUsed);
                    this.usageData.set(usage.templateId, usage);
                });
            }
        }
        catch (error) {
            // Usage data file doesn't exist or is corrupted - start fresh
            this.usageData.clear();
        }
    }
    async saveUsageData() {
        const data = Array.from(this.usageData.values());
        const content = JSON.stringify(data, null, 2);
        const file = this.app.vault.getAbstractFileByPath(this.usageDataPath);
        if (file) {
            await this.app.vault.modify(file, content);
        }
        else {
            await this.app.vault.create(this.usageDataPath, content);
        }
    }
    async findTemplateFile(templateId) {
        await this.ensureTemplatesDirectoryExists();
        const templatesDir = this.app.vault.getAbstractFileByPath(this.templatesPath);
        if (!templatesDir || !templatesDir.children) {
            return null;
        }
        const files = templatesDir.children.filter((file) => file.extension === "json" && file.name.includes(templateId));
        return files.length > 0 ? files[0].name : null;
    }
    createTemplateFromData(data) {
        return new QueryTemplate_1.QueryTemplate({
            id: data.id,
            metadata: data.metadata,
            layout: data.layout,
            parameters: data.parameters,
            sparqlTemplate: data.sparqlTemplate || "SELECT * WHERE { ?s ?p ?o }",
            isBuiltIn: data.isBuiltIn,
        });
    }
    sanitizeFileName(name) {
        return name
            .toLowerCase()
            .replace(/[^\w\s-]/g, "")
            .replace(/\s+/g, "-")
            .substring(0, 50);
    }
}
exports.ObsidianQueryTemplateRepository = ObsidianQueryTemplateRepository;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2luZnJhc3RydWN0dXJlL3JlcG9zaXRvcmllcy9PYnNpZGlhblF1ZXJ5VGVtcGxhdGVSZXBvc2l0b3J5LnRzIiwibWFwcGluZ3MiOiI7OztBQUtBLHFFQU0yQztBQUMzQyxtRUFBZ0U7QUFvQmhFLE1BQWEsK0JBQStCO0lBUzFDLFlBQ21CLEdBQVEsRUFDekIsZ0JBQXdCLHNCQUFzQixFQUM5QyxnQkFBd0IsZ0NBQWdDO1FBRnZDLFFBQUcsR0FBSCxHQUFHLENBQUs7UUFMbkIsa0JBQWEsR0FBK0IsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUN0RCxjQUFTLEdBQW1DLElBQUksR0FBRyxFQUFFLENBQUM7UUFDdEQsZ0JBQVcsR0FBWSxLQUFLLENBQUM7UUFPbkMsSUFBSSxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUM7UUFDbkMsSUFBSSxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUM7SUFDckMsQ0FBQztJQUVELEtBQUssQ0FBQyxPQUFPO1FBQ1gsTUFBTSxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUMvQixNQUFNLFNBQVMsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUUxRCwyQ0FBMkM7UUFDM0MsT0FBTyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQzdCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUFFLFVBQVUsSUFBSSxDQUFDLENBQUM7WUFDOUQsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFDLEVBQUUsVUFBVSxJQUFJLENBQUMsQ0FBQztZQUU5RCxJQUFJLE1BQU0sS0FBSyxNQUFNLEVBQUU7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QUNiLE9BQU8sQ0FBQyxXQUFXLEVBQUUsRUFBRSxDQUFDO2FBQ3hCLE9BQU8sQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDO2FBQ3BCLFNBQVMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDdEIsQ0FBQztDQUNGO0FBMWJELDBFQTBiQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva2l0ZWxldi9Eb2N1bWVudHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi9zcmMvaW5mcmFzdHJ1Y3R1cmUvcmVwb3NpdG9yaWVzL09ic2lkaWFuUXVlcnlUZW1wbGF0ZVJlcG9zaXRvcnkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwLCBURmlsZSwgVmF1bHQgfSBmcm9tIFwib2JzaWRpYW5cIjtcbmltcG9ydCB7XG4gIElRdWVyeVRlbXBsYXRlUmVwb3NpdG9yeSxcbiAgVGVtcGxhdGVTZWFyY2hDcml0ZXJpYSxcbn0gZnJvbSBcIi4uLy4uL2RvbWFpbi9yZXBvc2l0b3JpZXMvSVF1ZXJ5VGVtcGxhdGVSZXBvc2l0b3J5XCI7XG5pbXBvcnQge1xuICBRdWVyeVRlbXBsYXRlLFxuICBUZW1wbGF0ZUNhdGVnb3J5LFxuICBUZW1wbGF0ZU1ldGFkYXRhLFxuICBUZW1wbGF0ZUxheW91dCxcbiAgVGVtcGxhdGVQYXJhbWV0ZXIsXG59IGZyb20gXCIuLi8uLi9kb21haW4vdmlzdWFsL1F1ZXJ5VGVtcGxhdGVcIjtcbmltcG9ydCB7IEJ1aWx0SW5RdWVyeVRlbXBsYXRlcyB9IGZyb20gXCIuL0J1aWx0SW5RdWVyeVRlbXBsYXRlc1wiO1xuXG5pbnRlcmZhY2UgU3RvcmVkVGVtcGxhdGVEYXRhIHtcbiAgaWQ6IHN0cmluZztcbiAgbWV0YWRhdGE6IFRlbXBsYXRlTWV0YWRhdGE7XG4gIGxheW91dDogVGVtcGxhdGVMYXlvdXQ7XG4gIHBhcmFtZXRlcnM6IFRlbXBsYXRlUGFyYW1ldGVyW107XG4gIHNwYXJxbFRlbXBsYXRlOiBzdHJpbmc7XG4gIGlzQnVpbHRJbjogYm9vbGVhbjtcbiAgdXNhZ2VDb3VudD86IG51bWJlcjtcbiAgbGFzdFVzZWQ/OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBUZW1wbGF0ZVVzYWdlRGF0YSB7XG4gIHRlbXBsYXRlSWQ6IHN0cmluZztcbiAgdXNhZ2VDb3VudDogbnVtYmVyO1xuICBsYXN0VXNlZDogRGF0ZTtcbiAgcGFyYW1ldGVyc0ZpbGxlZDogbnVtYmVyW107XG59XG5cbmV4cG9ydCBjbGFzcyBPYnNpZGlhblF1ZXJ5VGVtcGxhdGVSZXBvc2l0b3J5XG4gIGltcGxlbWVudHMgSVF1ZXJ5VGVtcGxhdGVSZXBvc2l0b3J5XG57XG4gIHByaXZhdGUgcmVhZG9ubHkgdGVtcGxhdGVzUGF0aDogc3RyaW5nO1xuICBwcml2YXRlIHJlYWRvbmx5IHVzYWdlRGF0YVBhdGg6IHN0cmluZztcbiAgcHJpdmF0ZSB0ZW1wbGF0ZUNhY2hlOiBNYXA8c3RyaW5nLCBRdWVyeVRlbXBsYXRlPiA9IG5ldyBNYXAoKTtcbiAgcHJpdmF0ZSB1c2FnZURhdGE6IE1hcDxzdHJpbmcsIFRlbXBsYXRlVXNhZ2VEYXRhPiA9IG5ldyBNYXAoKTtcbiAgcHJpdmF0ZSBjYWNoZUxvYWRlZDogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgYXBwOiBBcHAsXG4gICAgdGVtcGxhdGVzUGF0aDogc3RyaW5nID0gXCIuZXhvY29ydGV4L3RlbXBsYXRlc1wiLFxuICAgIHVzYWdlRGF0YVBhdGg6IHN0cmluZyA9IFwiLmV4b2NvcnRleC90ZW1wbGF0ZS11c2FnZS5qc29uXCIsXG4gICkge1xuICAgIHRoaXMudGVtcGxhdGVzUGF0aCA9IHRlbXBsYXRlc1BhdGg7XG4gICAgdGhpcy51c2FnZURhdGFQYXRoID0gdXNhZ2VEYXRhUGF0aDtcbiAgfVxuXG4gIGFzeW5jIGZpbmRBbGwoKTogUHJvbWlzZTxRdWVyeVRlbXBsYXRlW10+IHtcbiAgICBhd2FpdCB0aGlzLmVuc3VyZUNhY2hlTG9hZGVkKCk7XG4gICAgY29uc3QgdGVtcGxhdGVzID0gQXJyYXkuZnJvbSh0aGlzLnRlbXBsYXRlQ2FjaGUudmFsdWVzKCkpO1xuXG4gICAgLy8gU29ydCBieSB1c2FnZSBmcmVxdWVuY3kgYW5kIHRoZW4gYnkgbmFtZVxuICAgIHJldHVybiB0ZW1wbGF0ZXMuc29ydCgoYSwgYikgPT4ge1xuICAgICAgY29uc3QgdXNhZ2VBID0gdGhpcy51c2FnZURhdGEuZ2V0KGEuZ2V0SWQoKSk/LnVzYWdlQ291bnQgfHwgMDtcbiAgICAgIGNvbnN0IHVzYWdlQiA9IHRoaXMudXNhZ2VEYXRhLmdldChiLmdldElkKCkpPy51c2FnZUNvdW50IHx8IDA7XG5cbiAgICAgIGlmICh1c2FnZUEgIT09IHVzYWdlQikge1xuICAgICAgICByZXR1cm4gdXNhZ2VCIC0gdXNhZ2VBO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gYS5nZXRNZXRhZGF0YSgpLm5hbWUubG9jYWxlQ29tcGFyZShiLmdldE1ldGFkYXRhKCkubmFtZSk7XG4gICAgfSk7XG4gIH1cblxuICBhc3luYyBmaW5kQnlDcml0ZXJpYShcbiAgICBjcml0ZXJpYTogVGVtcGxhdGVTZWFyY2hDcml0ZXJpYSxcbiAgKTogUHJvbWlzZTxRdWVyeVRlbXBsYXRlW10+IHtcbiAgICBhd2FpdCB0aGlzLmVuc3VyZUNhY2hlTG9hZGVkKCk7XG4gICAgbGV0IHRlbXBsYXRlcyA9IEFycmF5LmZyb20odGhpcy50ZW1wbGF0ZUNhY2hlLnZhbHVlcygpKTtcblxuICAgIGlmIChjcml0ZXJpYS5jYXRlZ29yeSkge1xuICAgICAgdGVtcGxhdGVzID0gdGVtcGxhdGVzLmZpbHRlcihcbiAgICAgICAgKHQpID0+IHQuZ2V0TWV0YWRhdGEoKS5jYXRlZ29yeSA9PT0gY3JpdGVyaWEuY2F0ZWdvcnksXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChjcml0ZXJpYS5kaWZmaWN1bHR5KSB7XG4gICAgICB0ZW1wbGF0ZXMgPSB0ZW1wbGF0ZXMuZmlsdGVyKFxuICAgICAgICAodCkgPT4gdC5nZXRNZXRhZGF0YSgpLmRpZmZpY3VsdHkgPT09IGNyaXRlcmlhLmRpZmZpY3VsdHksXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChjcml0ZXJpYS5uYW1lQ29udGFpbnMpIHtcbiAgICAgIGNvbnN0IHNlYXJjaFRlcm0gPSBjcml0ZXJpYS5uYW1lQ29udGFpbnMudG9Mb3dlckNhc2UoKTtcbiAgICAgIHRlbXBsYXRlcyA9IHRlbXBsYXRlcy5maWx0ZXIoXG4gICAgICAgICh0KSA9PlxuICAgICAgICAgIHQuZ2V0TWV0YWRhdGEoKS5uYW1lLnRvTG93ZXJDYXNlKCkuaW5jbHVkZXMoc2VhcmNoVGVybSkgfHxcbiAgICAgICAgICB0LmdldE1ldGFkYXRhKCkuZGVzY3JpcHRpb24udG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhzZWFyY2hUZXJtKSxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKGNyaXRlcmlhLnRhZ3MgJiYgY3JpdGVyaWEudGFncy5sZW5ndGggPiAwKSB7XG4gICAgICB0ZW1wbGF0ZXMgPSB0ZW1wbGF0ZXMuZmlsdGVyKCh0KSA9PiB7XG4gICAgICAgIGNvbnN0IHRlbXBsYXRlVGFncyA9IHQuZ2V0TWV0YWRhdGEoKS50YWdzO1xuICAgICAgICByZXR1cm4gY3JpdGVyaWEudGFncyEuc29tZSgodGFnKSA9PiB0ZW1wbGF0ZVRhZ3MuaW5jbHVkZXModGFnKSk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICBpZiAoY3JpdGVyaWEuaW5jbHVkZUJ1aWx0SW4gIT09IHVuZGVmaW5lZCkge1xuICAgICAgdGVtcGxhdGVzID0gdGVtcGxhdGVzLmZpbHRlcihcbiAgICAgICAgKHQpID0+IHQuaXNCdWlsdEluVGVtcGxhdGUoKSA9PT0gY3JpdGVyaWEuaW5jbHVkZUJ1aWx0SW4sXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmIChjcml0ZXJpYS5pbmNsdWRlQ3VzdG9tICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRlbXBsYXRlcyA9IHRlbXBsYXRlcy5maWx0ZXIoXG4gICAgICAgICh0KSA9PiAhdC5pc0J1aWx0SW5UZW1wbGF0ZSgpID09PSBjcml0ZXJpYS5pbmNsdWRlQ3VzdG9tLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGVtcGxhdGVzO1xuICB9XG5cbiAgYXN5bmMgZmluZEJ5SWQoaWQ6IHN0cmluZyk6IFByb21pc2U8UXVlcnlUZW1wbGF0ZSB8IHVuZGVmaW5lZD4ge1xuICAgIGF3YWl0IHRoaXMuZW5zdXJlQ2FjaGVMb2FkZWQoKTtcbiAgICByZXR1cm4gdGhpcy50ZW1wbGF0ZUNhY2hlLmdldChpZCk7XG4gIH1cblxuICBhc3luYyBmaW5kQnlDYXRlZ29yeShjYXRlZ29yeTogVGVtcGxhdGVDYXRlZ29yeSk6IFByb21pc2U8UXVlcnlUZW1wbGF0ZVtdPiB7XG4gICAgcmV0dXJuIHRoaXMuZmluZEJ5Q3JpdGVyaWEoeyBjYXRlZ29yeSB9KTtcbiAgfVxuXG4gIGFzeW5jIGZpbmRCeVRhZ3ModGFnczogc3RyaW5nW10pOiBQcm9taXNlPFF1ZXJ5VGVtcGxhdGVbXT4ge1xuICAgIHJldHVybiB0aGlzLmZpbmRCeUNyaXRlcmlhKHsgdGFncyB9KTtcbiAgfVxuXG4gIGFzeW5jIHNhdmUodGVtcGxhdGU6IFF1ZXJ5VGVtcGxhdGUpOiBQcm9taXNlPFF1ZXJ5VGVtcGxhdGU+IHtcbiAgICBpZiAodGVtcGxhdGUuaXNCdWlsdEluVGVtcGxhdGUoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IG1vZGlmeSBidWlsdC1pbiB0ZW1wbGF0ZXNcIik7XG4gICAgfVxuXG4gICAgY29uc3QgZXhpc3RzID0gYXdhaXQgdGhpcy5leGlzdHModGVtcGxhdGUuZ2V0SWQoKSk7XG4gICAgaWYgKGV4aXN0cykge1xuICAgICAgcmV0dXJuIHRoaXMudXBkYXRlKHRlbXBsYXRlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlKHRlbXBsYXRlKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBjcmVhdGUodGVtcGxhdGU6IFF1ZXJ5VGVtcGxhdGUpOiBQcm9taXNlPFF1ZXJ5VGVtcGxhdGU+IHtcbiAgICBpZiAodGVtcGxhdGUuaXNCdWlsdEluVGVtcGxhdGUoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IGNyZWF0ZSBidWlsdC1pbiB0ZW1wbGF0ZXMgdGhyb3VnaCByZXBvc2l0b3J5XCIpO1xuICAgIH1cblxuICAgIGNvbnN0IGV4aXN0cyA9IGF3YWl0IHRoaXMuZXhpc3RzKHRlbXBsYXRlLmdldElkKCkpO1xuICAgIGlmIChleGlzdHMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGVtcGxhdGUgd2l0aCBJRCAke3RlbXBsYXRlLmdldElkKCl9IGFscmVhZHkgZXhpc3RzYCk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5lbnN1cmVUZW1wbGF0ZXNEaXJlY3RvcnlFeGlzdHMoKTtcblxuICAgIGNvbnN0IGZpbGVOYW1lID0gYCR7dGhpcy5zYW5pdGl6ZUZpbGVOYW1lKHRlbXBsYXRlLmdldE1ldGFkYXRhKCkubmFtZSl9LSR7dGVtcGxhdGUuZ2V0SWQoKX0uanNvbmA7XG4gICAgY29uc3QgZmlsZVBhdGggPSBgJHt0aGlzLnRlbXBsYXRlc1BhdGh9LyR7ZmlsZU5hbWV9YDtcblxuICAgIGNvbnN0IGRhdGE6IFN0b3JlZFRlbXBsYXRlRGF0YSA9IHtcbiAgICAgIGlkOiB0ZW1wbGF0ZS5nZXRJZCgpLFxuICAgICAgbWV0YWRhdGE6IHRlbXBsYXRlLmdldE1ldGFkYXRhKCksXG4gICAgICBsYXlvdXQ6IHRlbXBsYXRlLmdldExheW91dCgpLFxuICAgICAgcGFyYW1ldGVyczogdGVtcGxhdGUuZ2V0UGFyYW1ldGVycygpLFxuICAgICAgc3BhcnFsVGVtcGxhdGU6IHRlbXBsYXRlLmdldFNwYXJxbFRlbXBsYXRlKCksXG4gICAgICBpc0J1aWx0SW46IHRlbXBsYXRlLmlzQnVpbHRJblRlbXBsYXRlKCksXG4gICAgfTtcblxuICAgIGF3YWl0IHRoaXMuYXBwLnZhdWx0LmNyZWF0ZShmaWxlUGF0aCwgSlNPTi5zdHJpbmdpZnkoZGF0YSwgbnVsbCwgMikpO1xuICAgIHRoaXMudGVtcGxhdGVDYWNoZS5zZXQodGVtcGxhdGUuZ2V0SWQoKSwgdGVtcGxhdGUpO1xuXG4gICAgcmV0dXJuIHRlbXBsYXRlO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlKHRlbXBsYXRlOiBRdWVyeVRlbXBsYXRlKTogUHJvbWlzZTxRdWVyeVRlbXBsYXRlPiB7XG4gICAgaWYgKHRlbXBsYXRlLmlzQnVpbHRJblRlbXBsYXRlKCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBtb2RpZnkgYnVpbHQtaW4gdGVtcGxhdGVzXCIpO1xuICAgIH1cblxuICAgIGNvbnN0IGV4aXN0cyA9IGF3YWl0IHRoaXMuZXhpc3RzKHRlbXBsYXRlLmdldElkKCkpO1xuICAgIGlmICghZXhpc3RzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRlbXBsYXRlIHdpdGggSUQgJHt0ZW1wbGF0ZS5nZXRJZCgpfSBub3QgZm91bmRgKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLmVuc3VyZVRlbXBsYXRlc0RpcmVjdG9yeUV4aXN0cygpO1xuXG4gICAgY29uc3QgZmlsZU5hbWUgPSBhd2FpdCB0aGlzLmZpbmRUZW1wbGF0ZUZpbGUodGVtcGxhdGUuZ2V0SWQoKSk7XG4gICAgaWYgKCFmaWxlTmFtZSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUZW1wbGF0ZSBmaWxlIG5vdCBmb3VuZCBmb3IgSUQgJHt0ZW1wbGF0ZS5nZXRJZCgpfWApO1xuICAgIH1cblxuICAgIGNvbnN0IGZpbGVQYXRoID0gYCR7dGhpcy50ZW1wbGF0ZXNQYXRofS8ke2ZpbGVOYW1lfWA7XG4gICAgY29uc3QgZmlsZSA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChmaWxlUGF0aCkgYXMgVEZpbGU7XG5cbiAgICBjb25zdCBkYXRhOiBTdG9yZWRUZW1wbGF0ZURhdGEgPSB7XG4gICAgICBpZDogdGVtcGxhdGUuZ2V0SWQoKSxcbiAgICAgIG1ldGFkYXRhOiB0ZW1wbGF0ZS5nZXRNZXRhZGF0YSgpLFxuICAgICAgbGF5b3V0OiB0ZW1wbGF0ZS5nZXRMYXlvdXQoKSxcbiAgICAgIHBhcmFtZXRlcnM6IHRlbXBsYXRlLmdldFBhcmFtZXRlcnMoKSxcbiAgICAgIHNwYXJxbFRlbXBsYXRlOiB0ZW1wbGF0ZS5nZXRTcGFycWxUZW1wbGF0ZSgpLFxuICAgICAgaXNCdWlsdEluOiB0ZW1wbGF0ZS5pc0J1aWx0SW5UZW1wbGF0ZSgpLFxuICAgIH07XG5cbiAgICBhd2FpdCB0aGlzLmFwcC52YXVsdC5tb2RpZnkoZmlsZSwgSlNPTi5zdHJpbmdpZnkoZGF0YSwgbnVsbCwgMikpO1xuICAgIHRoaXMudGVtcGxhdGVDYWNoZS5zZXQodGVtcGxhdGUuZ2V0SWQoKSwgdGVtcGxhdGUpO1xuXG4gICAgcmV0dXJuIHRlbXBsYXRlO1xuICB9XG5cbiAgYXN5bmMgZGVsZXRlKGlkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCB0ZW1wbGF0ZSA9IGF3YWl0IHRoaXMuZmluZEJ5SWQoaWQpO1xuICAgIGlmICghdGVtcGxhdGUpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBpZiAodGVtcGxhdGUuaXNCdWlsdEluVGVtcGxhdGUoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IGRlbGV0ZSBidWlsdC1pbiB0ZW1wbGF0ZXNcIik7XG4gICAgfVxuXG4gICAgY29uc3QgZmlsZU5hbWUgPSBhd2FpdCB0aGlzLmZpbmRUZW1wbGF0ZUZpbGUoaWQpO1xuICAgIGlmICghZmlsZU5hbWUpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCBmaWxlUGF0aCA9IGAke3RoaXMudGVtcGxhdGVzUGF0aH0vJHtmaWxlTmFtZX1gO1xuICAgIGNvbnN0IGZpbGUgPSB0aGlzLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoZmlsZVBhdGgpIGFzIFRGaWxlO1xuXG4gICAgaWYgKGZpbGUpIHtcbiAgICAgIGF3YWl0IHRoaXMuYXBwLnZhdWx0LmRlbGV0ZShmaWxlKTtcbiAgICAgIHRoaXMudGVtcGxhdGVDYWNoZS5kZWxldGUoaWQpO1xuICAgICAgdGhpcy51c2FnZURhdGEuZGVsZXRlKGlkKTtcbiAgICAgIGF3YWl0IHRoaXMuc2F2ZVVzYWdlRGF0YSgpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgYXN5bmMgZXhpc3RzKGlkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBhd2FpdCB0aGlzLmVuc3VyZUNhY2hlTG9hZGVkKCk7XG4gICAgcmV0dXJuIHRoaXMudGVtcGxhdGVDYWNoZS5oYXMoaWQpO1xuICB9XG5cbiAgYXN5bmMgaW1wb3J0VGVtcGxhdGVzKHRlbXBsYXRlc0RhdGE6IG9iamVjdFtdKTogUHJvbWlzZTxRdWVyeVRlbXBsYXRlW10+IHtcbiAgICBjb25zdCBpbXBvcnRlZDogUXVlcnlUZW1wbGF0ZVtdID0gW107XG5cbiAgICBmb3IgKGNvbnN0IHRlbXBsYXRlRGF0YSBvZiB0ZW1wbGF0ZXNEYXRhKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBkYXRhID0gdGVtcGxhdGVEYXRhIGFzIFN0b3JlZFRlbXBsYXRlRGF0YTtcblxuICAgICAgICAvLyBEb24ndCBpbXBvcnQgaWYgYWxyZWFkeSBleGlzdHMgYW5kIGlzIGJ1aWx0LWluXG4gICAgICAgIGNvbnN0IGV4aXN0aW5nID0gdGhpcy50ZW1wbGF0ZUNhY2hlLmdldChkYXRhLmlkKTtcbiAgICAgICAgaWYgKGV4aXN0aW5nICYmIGV4aXN0aW5nLmlzQnVpbHRJblRlbXBsYXRlKCkpIHtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHRlbXBsYXRlID0gdGhpcy5jcmVhdGVUZW1wbGF0ZUZyb21EYXRhKGRhdGEpO1xuICAgICAgICBhd2FpdCB0aGlzLnNhdmUodGVtcGxhdGUpO1xuICAgICAgICBpbXBvcnRlZC5wdXNoKHRlbXBsYXRlKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUud2FybihcIkZhaWxlZCB0byBpbXBvcnQgdGVtcGxhdGU6XCIsIGVycm9yKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gaW1wb3J0ZWQ7XG4gIH1cblxuICBhc3luYyBleHBvcnRUZW1wbGF0ZXModGVtcGxhdGVJZHM/OiBzdHJpbmdbXSk6IFByb21pc2U8b2JqZWN0W10+IHtcbiAgICBhd2FpdCB0aGlzLmVuc3VyZUNhY2hlTG9hZGVkKCk7XG5cbiAgICBsZXQgdGVtcGxhdGVzOiBRdWVyeVRlbXBsYXRlW107XG4gICAgaWYgKHRlbXBsYXRlSWRzKSB7XG4gICAgICB0ZW1wbGF0ZXMgPSB0ZW1wbGF0ZUlkc1xuICAgICAgICAubWFwKChpZCkgPT4gdGhpcy50ZW1wbGF0ZUNhY2hlLmdldChpZCkpXG4gICAgICAgIC5maWx0ZXIoKHQpID0+IHQgIT09IHVuZGVmaW5lZCkgYXMgUXVlcnlUZW1wbGF0ZVtdO1xuICAgIH0gZWxzZSB7XG4gICAgICB0ZW1wbGF0ZXMgPSBBcnJheS5mcm9tKHRoaXMudGVtcGxhdGVDYWNoZS52YWx1ZXMoKSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRlbXBsYXRlcy5tYXAoKHRlbXBsYXRlKSA9PiB0ZW1wbGF0ZS50b0pTT04oKSk7XG4gIH1cblxuICBhc3luYyBnZXRCdWlsdEluVGVtcGxhdGVzKCk6IFByb21pc2U8UXVlcnlUZW1wbGF0ZVtdPiB7XG4gICAgcmV0dXJuIHRoaXMuZmluZEJ5Q3JpdGVyaWEoeyBpbmNsdWRlQnVpbHRJbjogdHJ1ZSwgaW5jbHVkZUN1c3RvbTogZmFsc2UgfSk7XG4gIH1cblxuICBhc3luYyBnZXRDdXN0b21UZW1wbGF0ZXMoKTogUHJvbWlzZTxRdWVyeVRlbXBsYXRlW10+IHtcbiAgICByZXR1cm4gdGhpcy5maW5kQnlDcml0ZXJpYSh7IGluY2x1ZGVCdWlsdEluOiBmYWxzZSwgaW5jbHVkZUN1c3RvbTogdHJ1ZSB9KTtcbiAgfVxuXG4gIGFzeW5jIGdldFJlY2VudGx5VXNlZChsaW1pdDogbnVtYmVyID0gMTApOiBQcm9taXNlPFF1ZXJ5VGVtcGxhdGVbXT4ge1xuICAgIGF3YWl0IHRoaXMuZW5zdXJlQ2FjaGVMb2FkZWQoKTtcblxuICAgIGNvbnN0IHRlbXBsYXRlVXNhZ2UgPSBBcnJheS5mcm9tKHRoaXMudXNhZ2VEYXRhLmVudHJpZXMoKSlcbiAgICAgIC5zb3J0KChhLCBiKSA9PiBiWzFdLmxhc3RVc2VkLmdldFRpbWUoKSAtIGFbMV0ubGFzdFVzZWQuZ2V0VGltZSgpKVxuICAgICAgLnNsaWNlKDAsIGxpbWl0KTtcblxuICAgIHJldHVybiB0ZW1wbGF0ZVVzYWdlXG4gICAgICAubWFwKChbaWRdKSA9PiB0aGlzLnRlbXBsYXRlQ2FjaGUuZ2V0KGlkKSlcbiAgICAgIC5maWx0ZXIoKHQpID0+IHQgIT09IHVuZGVmaW5lZCkgYXMgUXVlcnlUZW1wbGF0ZVtdO1xuICB9XG5cbiAgYXN5bmMgcmVjb3JkVXNhZ2UodGVtcGxhdGVJZDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5lbnN1cmVDYWNoZUxvYWRlZCgpO1xuXG4gICAgY29uc3QgZXhpc3RpbmcgPSB0aGlzLnVzYWdlRGF0YS5nZXQodGVtcGxhdGVJZCk7XG4gICAgaWYgKGV4aXN0aW5nKSB7XG4gICAgICBleGlzdGluZy51c2FnZUNvdW50Kys7XG4gICAgICBleGlzdGluZy5sYXN0VXNlZCA9IG5ldyBEYXRlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudXNhZ2VEYXRhLnNldCh0ZW1wbGF0ZUlkLCB7XG4gICAgICAgIHRlbXBsYXRlSWQsXG4gICAgICAgIHVzYWdlQ291bnQ6IDEsXG4gICAgICAgIGxhc3RVc2VkOiBuZXcgRGF0ZSgpLFxuICAgICAgICBwYXJhbWV0ZXJzRmlsbGVkOiBbXSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuc2F2ZVVzYWdlRGF0YSgpO1xuICB9XG5cbiAgYXN5bmMgZ2V0VXNhZ2VTdGF0cyh0ZW1wbGF0ZUlkOiBzdHJpbmcpOiBQcm9taXNlPHtcbiAgICB1c2FnZUNvdW50OiBudW1iZXI7XG4gICAgbGFzdFVzZWQ/OiBEYXRlO1xuICAgIGF2ZXJhZ2VQYXJhbWV0ZXJzRmlsbGVkPzogbnVtYmVyO1xuICB9PiB7XG4gICAgYXdhaXQgdGhpcy5lbnN1cmVDYWNoZUxvYWRlZCgpO1xuXG4gICAgY29uc3QgdXNhZ2UgPSB0aGlzLnVzYWdlRGF0YS5nZXQodGVtcGxhdGVJZCk7XG4gICAgaWYgKCF1c2FnZSkge1xuICAgICAgcmV0dXJuIHsgdXNhZ2VDb3VudDogMCB9O1xuICAgIH1cblxuICAgIGNvbnN0IGF2ZXJhZ2VQYXJhbWV0ZXJzRmlsbGVkID1cbiAgICAgIHVzYWdlLnBhcmFtZXRlcnNGaWxsZWQubGVuZ3RoID4gMFxuICAgICAgICA/IHVzYWdlLnBhcmFtZXRlcnNGaWxsZWQucmVkdWNlKChzdW0sIGNvdW50KSA9PiBzdW0gKyBjb3VudCwgMCkgL1xuICAgICAgICAgIHVzYWdlLnBhcmFtZXRlcnNGaWxsZWQubGVuZ3RoXG4gICAgICAgIDogdW5kZWZpbmVkO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHVzYWdlQ291bnQ6IHVzYWdlLnVzYWdlQ291bnQsXG4gICAgICBsYXN0VXNlZDogdXNhZ2UubGFzdFVzZWQsXG4gICAgICBhdmVyYWdlUGFyYW1ldGVyc0ZpbGxlZCxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgcmVmcmVzaCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLnRlbXBsYXRlQ2FjaGUuY2xlYXIoKTtcbiAgICB0aGlzLnVzYWdlRGF0YS5jbGVhcigpO1xuICAgIHRoaXMuY2FjaGVMb2FkZWQgPSBmYWxzZTtcbiAgICBhd2FpdCB0aGlzLmxvYWRCdWlsdEluVGVtcGxhdGVzKCk7XG4gICAgYXdhaXQgdGhpcy5sb2FkQ3VzdG9tVGVtcGxhdGVzKCk7XG4gICAgYXdhaXQgdGhpcy5sb2FkVXNhZ2VEYXRhKCk7XG4gICAgdGhpcy5jYWNoZUxvYWRlZCA9IHRydWU7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGVuc3VyZUNhY2hlTG9hZGVkKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghdGhpcy5jYWNoZUxvYWRlZCkge1xuICAgICAgYXdhaXQgdGhpcy5yZWZyZXNoKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBlbnN1cmVUZW1wbGF0ZXNEaXJlY3RvcnlFeGlzdHMoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgdGVtcGxhdGVzRGlyID0gdGhpcy5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKFxuICAgICAgdGhpcy50ZW1wbGF0ZXNQYXRoLFxuICAgICk7XG4gICAgaWYgKCF0ZW1wbGF0ZXNEaXIpIHtcbiAgICAgIGF3YWl0IHRoaXMuYXBwLnZhdWx0LmNyZWF0ZUZvbGRlcih0aGlzLnRlbXBsYXRlc1BhdGgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgbG9hZEJ1aWx0SW5UZW1wbGF0ZXMoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgYnVpbHRJblRlbXBsYXRlcyA9IEJ1aWx0SW5RdWVyeVRlbXBsYXRlcy5nZXRBbGwoKTtcbiAgICBidWlsdEluVGVtcGxhdGVzLmZvckVhY2goKHRlbXBsYXRlKSA9PiB7XG4gICAgICB0aGlzLnRlbXBsYXRlQ2FjaGUuc2V0KHRlbXBsYXRlLmdldElkKCksIHRlbXBsYXRlKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgbG9hZEN1c3RvbVRlbXBsYXRlcygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBhd2FpdCB0aGlzLmVuc3VyZVRlbXBsYXRlc0RpcmVjdG9yeUV4aXN0cygpO1xuXG4gICAgY29uc3QgdGVtcGxhdGVzRGlyID0gdGhpcy5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKFxuICAgICAgdGhpcy50ZW1wbGF0ZXNQYXRoLFxuICAgICk7XG4gICAgaWYgKCF0ZW1wbGF0ZXNEaXIgfHwgISh0ZW1wbGF0ZXNEaXIgYXMgYW55KS5jaGlsZHJlbikge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGZpbGVzID0gKHRlbXBsYXRlc0RpciBhcyBhbnkpLmNoaWxkcmVuLmZpbHRlcihcbiAgICAgIChmaWxlOiBhbnkpID0+IGZpbGUuZXh0ZW5zaW9uID09PSBcImpzb25cIiAmJiBmaWxlLm5hbWUuZW5kc1dpdGgoXCIuanNvblwiKSxcbiAgICApO1xuXG4gICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBjb250ZW50ID0gYXdhaXQgdGhpcy5hcHAudmF1bHQucmVhZChmaWxlKTtcbiAgICAgICAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2UoY29udGVudCkgYXMgU3RvcmVkVGVtcGxhdGVEYXRhO1xuXG4gICAgICAgIGNvbnN0IHRlbXBsYXRlID0gdGhpcy5jcmVhdGVUZW1wbGF0ZUZyb21EYXRhKGRhdGEpO1xuICAgICAgICB0aGlzLnRlbXBsYXRlQ2FjaGUuc2V0KHRlbXBsYXRlLmdldElkKCksIHRlbXBsYXRlKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUud2FybihgRmFpbGVkIHRvIGxvYWQgdGVtcGxhdGUgZnJvbSAke2ZpbGUucGF0aH06YCwgZXJyb3IpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgbG9hZFVzYWdlRGF0YSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZmlsZSA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChcbiAgICAgICAgdGhpcy51c2FnZURhdGFQYXRoLFxuICAgICAgKSBhcyBURmlsZTtcbiAgICAgIGlmIChmaWxlKSB7XG4gICAgICAgIGNvbnN0IGNvbnRlbnQgPSBhd2FpdCB0aGlzLmFwcC52YXVsdC5yZWFkKGZpbGUpO1xuICAgICAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShjb250ZW50KSBhcyBUZW1wbGF0ZVVzYWdlRGF0YVtdO1xuXG4gICAgICAgIHRoaXMudXNhZ2VEYXRhLmNsZWFyKCk7XG4gICAgICAgIGRhdGEuZm9yRWFjaCgodXNhZ2UpID0+IHtcbiAgICAgICAgICB1c2FnZS5sYXN0VXNlZCA9IG5ldyBEYXRlKHVzYWdlLmxhc3RVc2VkKTtcbiAgICAgICAgICB0aGlzLnVzYWdlRGF0YS5zZXQodXNhZ2UudGVtcGxhdGVJZCwgdXNhZ2UpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgLy8gVXNhZ2UgZGF0YSBmaWxlIGRvZXNuJ3QgZXhpc3Qgb3IgaXMgY29ycnVwdGVkIC0gc3RhcnQgZnJlc2hcbiAgICAgIHRoaXMudXNhZ2VEYXRhLmNsZWFyKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzYXZlVXNhZ2VEYXRhKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGRhdGEgPSBBcnJheS5mcm9tKHRoaXMudXNhZ2VEYXRhLnZhbHVlcygpKTtcbiAgICBjb25zdCBjb250ZW50ID0gSlNPTi5zdHJpbmdpZnkoZGF0YSwgbnVsbCwgMik7XG5cbiAgICBjb25zdCBmaWxlID0gdGhpcy5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKFxuICAgICAgdGhpcy51c2FnZURhdGFQYXRoLFxuICAgICkgYXMgVEZpbGU7XG4gICAgaWYgKGZpbGUpIHtcbiAgICAgIGF3YWl0IHRoaXMuYXBwLnZhdWx0Lm1vZGlmeShmaWxlLCBjb250ZW50KTtcbiAgICB9IGVsc2Uge1xuICAgICAgYXdhaXQgdGhpcy5hcHAudmF1bHQuY3JlYXRlKHRoaXMudXNhZ2VEYXRhUGF0aCwgY29udGVudCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBmaW5kVGVtcGxhdGVGaWxlKHRlbXBsYXRlSWQ6IHN0cmluZyk6IFByb21pc2U8c3RyaW5nIHwgbnVsbD4ge1xuICAgIGF3YWl0IHRoaXMuZW5zdXJlVGVtcGxhdGVzRGlyZWN0b3J5RXhpc3RzKCk7XG5cbiAgICBjb25zdCB0ZW1wbGF0ZXNEaXIgPSB0aGlzLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoXG4gICAgICB0aGlzLnRlbXBsYXRlc1BhdGgsXG4gICAgKTtcbiAgICBpZiAoIXRlbXBsYXRlc0RpciB8fCAhKHRlbXBsYXRlc0RpciBhcyBhbnkpLmNoaWxkcmVuKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCBmaWxlcyA9ICh0ZW1wbGF0ZXNEaXIgYXMgYW55KS5jaGlsZHJlbi5maWx0ZXIoXG4gICAgICAoZmlsZTogYW55KSA9PlxuICAgICAgICBmaWxlLmV4dGVuc2lvbiA9PT0gXCJqc29uXCIgJiYgZmlsZS5uYW1lLmluY2x1ZGVzKHRlbXBsYXRlSWQpLFxuICAgICk7XG5cbiAgICByZXR1cm4gZmlsZXMubGVuZ3RoID4gMCA/IGZpbGVzWzBdLm5hbWUgOiBudWxsO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVUZW1wbGF0ZUZyb21EYXRhKGRhdGE6IFN0b3JlZFRlbXBsYXRlRGF0YSk6IFF1ZXJ5VGVtcGxhdGUge1xuICAgIHJldHVybiBuZXcgUXVlcnlUZW1wbGF0ZSh7XG4gICAgICBpZDogZGF0YS5pZCxcbiAgICAgIG1ldGFkYXRhOiBkYXRhLm1ldGFkYXRhLFxuICAgICAgbGF5b3V0OiBkYXRhLmxheW91dCxcbiAgICAgIHBhcmFtZXRlcnM6IGRhdGEucGFyYW1ldGVycyxcbiAgICAgIHNwYXJxbFRlbXBsYXRlOiBkYXRhLnNwYXJxbFRlbXBsYXRlIHx8IFwiU0VMRUNUICogV0hFUkUgeyA/cyA/cCA/byB9XCIsXG4gICAgICBpc0J1aWx0SW46IGRhdGEuaXNCdWlsdEluLFxuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzYW5pdGl6ZUZpbGVOYW1lKG5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIG5hbWVcbiAgICAgIC50b0xvd2VyQ2FzZSgpXG4gICAgICAucmVwbGFjZSgvW15cXHdcXHMtXS9nLCBcIlwiKVxuICAgICAgLnJlcGxhY2UoL1xccysvZywgXCItXCIpXG4gICAgICAuc3Vic3RyaW5nKDAsIDUwKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9