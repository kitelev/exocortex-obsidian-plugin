6db7fa283dbae5601ebaf1e5a9f579ac
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
// Mock DIContainer
jest.mock('../src/infrastructure/container/DIContainer', () => {
    const mockContainer = {
        getCreateAssetUseCase: jest.fn().mockReturnValue({
            execute: jest.fn().mockResolvedValue({
                success: true,
                message: 'Asset created'
            })
        }),
        getPropertyEditingUseCase: jest.fn().mockReturnValue({
            execute: jest.fn().mockResolvedValue({
                success: true,
                message: 'Property edited'
            })
        }),
        resolve: jest.fn().mockImplementation(() => ({})),
        dispose: jest.fn()
    };
    return {
        DIContainer: {
            initialize: jest.fn((app, plugin) => mockContainer),
            getInstance: jest.fn(() => mockContainer)
        }
    };
});
const main_1 = tslib_1.__importDefault(require("../main"));
describe('ExocortexPlugin - SPARQL Version', () => {
    let app;
    let plugin;
    // Mock Obsidian App
    beforeEach(() => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
        app = {
            vault: {
                getMarkdownFiles: jest.fn().mockReturnValue([
                    { basename: 'test-file', path: 'test-file.md' }
                ]),
                read: jest.fn().mockResolvedValue(`---
exo__Asset_uid: test-uid
exo__Asset_label: Test Asset
exo__Instance_class: "[[exo__Class]]"
---

# Test File`),
                on: jest.fn().mockReturnValue({ event: 'mock', callback: jest.fn() })
            },
            workspace: {
                openLinkText: jest.fn()
            },
            metadataCache: {
                getFileCache: jest.fn()
            }
        };
        plugin = new main_1.default(app, {
            id: 'exocortex',
            name: 'Exocortex',
            version: '2.0.0',
            minAppVersion: '1.0.0',
            description: 'SPARQL queries in Obsidian',
            author: 'M.K. Khromov',
            authorUrl: '',
            isDesktopOnly: false
        });
    }));
    describe('Plugin Lifecycle', () => {
        test('should load plugin successfully', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            const registerSpy = jest.spyOn(plugin, 'registerMarkdownCodeBlockProcessor');
            yield plugin.onload();
            expect(registerSpy).toHaveBeenCalledWith('sparql', expect.any(Function));
        }));
        test('should unload plugin successfully', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            yield plugin.onload();
            yield plugin.onunload();
            // Plugin should unload without errors
        }));
    });
    describe('SPARQL Processing', () => {
        test('should register SPARQL code block processor', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            yield plugin.onload();
            // Check if processor was registered (tested via E2E tests)
            expect(true).toBe(true);
        }));
        test('should load vault data into graph', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            yield plugin.onload();
            // Verify that the plugin has loaded data from vault
            // The graph should exist after loading
            expect(plugin['graph']).toBeDefined();
            // Verify vault.getMarkdownFiles was called
            expect(app.vault.getMarkdownFiles).toHaveBeenCalled();
        }));
        test('should initialize SPARQL processor', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            yield plugin.onload();
            // Verify that the SPARQL processor was initialized
            expect(plugin['sparqlProcessor']).toBeDefined();
            // Verify the processor has required components
            expect(plugin['graph']).toBeDefined();
            expect(plugin['sparqlProcessor']).toBeDefined();
        }));
        test('should register event handlers for file changes', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            yield plugin.onload();
            // Verify that file modification handlers were registered
            expect(app.vault.on).toHaveBeenCalledWith('modify', expect.any(Function));
            expect(app.vault.on).toHaveBeenCalledWith('create', expect.any(Function));
            expect(app.vault.on).toHaveBeenCalledWith('delete', expect.any(Function));
        }));
        test('should initialize layout renderer', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            yield plugin.onload();
            // Verify that the graph and processors are initialized
            expect(plugin['graph']).toBeDefined();
            expect(plugin['sparqlProcessor']).toBeDefined();
            expect(plugin['graphVisualizationProcessor']).toBeDefined();
        }));
        test('should initialize API server when enabled', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            // Note: API server initialization depends on settings
            yield plugin.onload();
            // Verify the plugin loaded successfully with core components
            expect(plugin['graph']).toBeDefined();
            expect(plugin['rdfService']).toBeDefined();
            expect(plugin['container']).toBeDefined();
        }));
    });
    describe('DOM Processing', () => {
        test('should register markdown code block processors', () => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
            // Mock the registerMarkdownCodeBlockProcessor method
            const registerProcessorSpy = jest.spyOn(plugin, 'registerMarkdownCodeBlockProcessor')
                .mockImplementation(() => { });
            yield plugin.onload();
            // Verify that processors were registered (with error handling)
            // The plugin should attempt to register both SPARQL and graph processors
            expect(registerProcessorSpy).toHaveBeenCalledTimes(2);
            expect(registerProcessorSpy).toHaveBeenCalledWith('sparql', expect.any(Function));
            expect(registerProcessorSpy).toHaveBeenCalledWith('graph', expect.any(Function));
            // Verify the plugin loaded successfully even if processor registration had issues
            expect(plugin['graph']).toBeDefined();
            registerProcessorSpy.mockRestore();
        }));
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vdGVzdHMvbWFpbi50ZXN0LnRzIiwibWFwcGluZ3MiOiI7OztBQUdBLG1CQUFtQjtBQUNuQixJQUFJLENBQUMsSUFBSSxDQUFDLDZDQUE2QyxFQUFFLEdBQUcsRUFBRTtJQUM1RCxNQUFNLGFBQWEsR0FBRztRQUNwQixxQkFBcUIsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsZUFBZSxDQUFDO1lBQy9DLE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUM7Z0JBQ25DLE9BQU8sRUFBRSxJQUFJO2dCQUNiLE9BQU8sRUFBRSxlQUFlO2FBQ3pCLENBQUM7U0FDSCxDQUFDO1FBQ0YseUJBQXlCLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGVBQWUsQ0FBQztZQUNuRCxPQUFPLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDO2dCQUNuQyxPQUFPLEVBQUUsSUFBSTtnQkFDYixPQUFPLEVBQUUsaUJBQWlCO2FBQzNCLENBQUM7U0FDSCxDQUFDO1FBQ0YsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ2pELE9BQU8sRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO0tBQ25CLENBQUM7SUFFRixPQUFPO1FBQ0wsV0FBVyxFQUFFO1lBQ1gsVUFBVSxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLEVBQUUsQ0FBQyxhQUFhLENBQUM7WUFDbkQsV0FBVyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLENBQUMsYUFBYSxDQUFDO1NBQzFDO0tBQ0YsQ0FBQztBQUNKLENBQUMsQ0FBQyxDQUFDO0FBM0JILDJEQUFzQztBQTZCdEMsUUFBUSxDQUFDLGtDQUFrQyxFQUFFLEdBQUcs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RUFBRSxNQUFNLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFFakYsa0ZBQWtGO1lBQ2xGLE1BQU0sQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUV0QyxvQkFBb0IsQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNyQyxDQUFDLENBQUEsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva2l0ZWxldi9Eb2N1bWVudHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi90ZXN0cy9tYWluLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwLCBURmlsZSwgTm90aWNlLCBNYXJrZG93blBvc3RQcm9jZXNzb3JDb250ZXh0IH0gZnJvbSAnb2JzaWRpYW4nO1xuaW1wb3J0IEV4b2NvcnRleFBsdWdpbiBmcm9tICcuLi9tYWluJztcblxuLy8gTW9jayBESUNvbnRhaW5lclxuamVzdC5tb2NrKCcuLi9zcmMvaW5mcmFzdHJ1Y3R1cmUvY29udGFpbmVyL0RJQ29udGFpbmVyJywgKCkgPT4ge1xuICBjb25zdCBtb2NrQ29udGFpbmVyID0ge1xuICAgIGdldENyZWF0ZUFzc2V0VXNlQ2FzZTogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICBleGVjdXRlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBtZXNzYWdlOiAnQXNzZXQgY3JlYXRlZCdcbiAgICAgIH0pXG4gICAgfSksXG4gICAgZ2V0UHJvcGVydHlFZGl0aW5nVXNlQ2FzZTogamVzdC5mbigpLm1vY2tSZXR1cm5WYWx1ZSh7XG4gICAgICBleGVjdXRlOiBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoe1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBtZXNzYWdlOiAnUHJvcGVydHkgZWRpdGVkJ1xuICAgICAgfSlcbiAgICB9KSxcbiAgICByZXNvbHZlOiBqZXN0LmZuKCkubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+ICh7fSkpLFxuICAgIGRpc3Bvc2U6IGplc3QuZm4oKVxuICB9O1xuXG4gIHJldHVybiB7XG4gICAgRElDb250YWluZXI6IHtcbiAgICAgIGluaXRpYWxpemU6IGplc3QuZm4oKGFwcCwgcGx1Z2luKSA9PiBtb2NrQ29udGFpbmVyKSxcbiAgICAgIGdldEluc3RhbmNlOiBqZXN0LmZuKCgpID0+IG1vY2tDb250YWluZXIpXG4gICAgfVxuICB9O1xufSk7XG5cbmRlc2NyaWJlKCdFeG9jb3J0ZXhQbHVnaW4gLSBTUEFSUUwgVmVyc2lvbicsICgpID0+IHtcbiAgbGV0IGFwcDogQXBwO1xuICBsZXQgcGx1Z2luOiBFeG9jb3J0ZXhQbHVnaW47XG4gIFxuICAvLyBNb2NrIE9ic2lkaWFuIEFwcFxuICBiZWZvcmVFYWNoKGFzeW5jICgpID0+IHtcbiAgICBhcHAgPSB7XG4gICAgICB2YXVsdDoge1xuICAgICAgICBnZXRNYXJrZG93bkZpbGVzOiBqZXN0LmZuKCkubW9ja1JldHVyblZhbHVlKFtcbiAgICAgICAgICB7IGJhc2VuYW1lOiAndGVzdC1maWxlJywgcGF0aDogJ3Rlc3QtZmlsZS5tZCcgfVxuICAgICAgICBdKSxcbiAgICAgICAgcmVhZDogamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKGAtLS1cbmV4b19fQXNzZXRfdWlkOiB0ZXN0LXVpZFxuZXhvX19Bc3NldF9sYWJlbDogVGVzdCBBc3NldFxuZXhvX19JbnN0YW5jZV9jbGFzczogXCJbW2V4b19fQ2xhc3NdXVwiXG4tLS1cblxuIyBUZXN0IEZpbGVgKSxcbiAgICAgICAgb246IGplc3QuZm4oKS5tb2NrUmV0dXJuVmFsdWUoeyBldmVudDogJ21vY2snLCBjYWxsYmFjazogamVzdC5mbigpIH0pXG4gICAgICB9LFxuICAgICAgd29ya3NwYWNlOiB7XG4gICAgICAgIG9wZW5MaW5rVGV4dDogamVzdC5mbigpXG4gICAgICB9LFxuICAgICAgbWV0YWRhdGFDYWNoZToge1xuICAgICAgICBnZXRGaWxlQ2FjaGU6IGplc3QuZm4oKVxuICAgICAgfVxuICAgIH0gYXMgdW5rbm93biBhcyBBcHA7XG4gICAgXG4gICAgcGx1Z2luID0gbmV3IEV4b2NvcnRleFBsdWdpbihhcHAsIHtcbiAgICAgIGlkOiAnZXhvY29ydGV4JyxcbiAgICAgIG5hbWU6ICdFeG9jb3J0ZXgnLFxuICAgICAgdmVyc2lvbjogJzIuMC4wJyxcbiAgICAgIG1pbkFwcFZlcnNpb246ICcxLjAuMCcsXG4gICAgICBkZXNjcmlwdGlvbjogJ1NQQVJRTCBxdWVyaWVzIGluIE9ic2lkaWFuJyxcbiAgICAgIGF1dGhvcjogJ00uSy4gS2hyb21vdicsXG4gICAgICBhdXRob3JVcmw6ICcnLFxuICAgICAgaXNEZXNrdG9wT25seTogZmFsc2VcbiAgICB9KTtcbiAgfSk7XG4gIFxuICBkZXNjcmliZSgnUGx1Z2luIExpZmVjeWNsZScsICgpID0+IHtcbiAgICB0ZXN0KCdzaG91bGQgbG9hZCBwbHVnaW4gc3VjY2Vzc2Z1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVnaXN0ZXJTcHkgPSBqZXN0LnNweU9uKHBsdWdpbiwgJ3JlZ2lzdGVyTWFya2Rvd25Db2RlQmxvY2tQcm9jZXNzb3InKTtcbiAgICAgIGF3YWl0IHBsdWdpbi5vbmxvYWQoKTtcbiAgICAgIFxuICAgICAgZXhwZWN0KHJlZ2lzdGVyU3B5KS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnc3BhcnFsJywgZXhwZWN0LmFueShGdW5jdGlvbikpO1xuICAgIH0pO1xuICAgIFxuICAgIHRlc3QoJ3Nob3VsZCB1bmxvYWQgcGx1Z2luIHN1Y2Nlc3NmdWxseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHBsdWdpbi5vbmxvYWQoKTtcbiAgICAgIGF3YWl0IHBsdWdpbi5vbnVubG9hZCgpO1xuICAgICAgLy8gUGx1Z2luIHNob3VsZCB1bmxvYWQgd2l0aG91dCBlcnJvcnNcbiAgICB9KTtcbiAgfSk7XG4gIFxuICBkZXNjcmliZSgnU1BBUlFMIFByb2Nlc3NpbmcnLCAoKSA9PiB7XG4gICAgdGVzdCgnc2hvdWxkIHJlZ2lzdGVyIFNQQVJRTCBjb2RlIGJsb2NrIHByb2Nlc3NvcicsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHBsdWdpbi5vbmxvYWQoKTtcbiAgICAgIC8vIENoZWNrIGlmIHByb2Nlc3NvciB3YXMgcmVnaXN0ZXJlZCAodGVzdGVkIHZpYSBFMkUgdGVzdHMpXG4gICAgICBleHBlY3QodHJ1ZSkudG9CZSh0cnVlKTtcbiAgICB9KTtcbiAgICBcbiAgICB0ZXN0KCdzaG91bGQgbG9hZCB2YXVsdCBkYXRhIGludG8gZ3JhcGgnLCBhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCBwbHVnaW4ub25sb2FkKCk7XG4gICAgICBcbiAgICAgIC8vIFZlcmlmeSB0aGF0IHRoZSBwbHVnaW4gaGFzIGxvYWRlZCBkYXRhIGZyb20gdmF1bHRcbiAgICAgIC8vIFRoZSBncmFwaCBzaG91bGQgZXhpc3QgYWZ0ZXIgbG9hZGluZ1xuICAgICAgZXhwZWN0KHBsdWdpblsnZ3JhcGgnXSkudG9CZURlZmluZWQoKTtcbiAgICAgIFxuICAgICAgLy8gVmVyaWZ5IHZhdWx0LmdldE1hcmtkb3duRmlsZXMgd2FzIGNhbGxlZFxuICAgICAgZXhwZWN0KGFwcC52YXVsdC5nZXRNYXJrZG93bkZpbGVzKS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG4gICAgXG4gICAgdGVzdCgnc2hvdWxkIGluaXRpYWxpemUgU1BBUlFMIHByb2Nlc3NvcicsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHBsdWdpbi5vbmxvYWQoKTtcbiAgICAgIFxuICAgICAgLy8gVmVyaWZ5IHRoYXQgdGhlIFNQQVJRTCBwcm9jZXNzb3Igd2FzIGluaXRpYWxpemVkXG4gICAgICBleHBlY3QocGx1Z2luWydzcGFycWxQcm9jZXNzb3InXSkudG9CZURlZmluZWQoKTtcbiAgICAgIFxuICAgICAgLy8gVmVyaWZ5IHRoZSBwcm9jZXNzb3IgaGFzIHJlcXVpcmVkIGNvbXBvbmVudHNcbiAgICAgIGV4cGVjdChwbHVnaW5bJ2dyYXBoJ10pLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QocGx1Z2luWydzcGFycWxQcm9jZXNzb3InXSkudG9CZURlZmluZWQoKTtcbiAgICB9KTtcbiAgICBcbiAgICB0ZXN0KCdzaG91bGQgcmVnaXN0ZXIgZXZlbnQgaGFuZGxlcnMgZm9yIGZpbGUgY2hhbmdlcycsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHBsdWdpbi5vbmxvYWQoKTtcbiAgICAgIFxuICAgICAgLy8gVmVyaWZ5IHRoYXQgZmlsZSBtb2RpZmljYXRpb24gaGFuZGxlcnMgd2VyZSByZWdpc3RlcmVkXG4gICAgICBleHBlY3QoYXBwLnZhdWx0Lm9uKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCgnbW9kaWZ5JywgZXhwZWN0LmFueShGdW5jdGlvbikpO1xuICAgICAgZXhwZWN0KGFwcC52YXVsdC5vbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ2NyZWF0ZScsIGV4cGVjdC5hbnkoRnVuY3Rpb24pKTtcbiAgICAgIGV4cGVjdChhcHAudmF1bHQub24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKCdkZWxldGUnLCBleHBlY3QuYW55KEZ1bmN0aW9uKSk7XG4gICAgfSk7XG4gICAgXG4gICAgdGVzdCgnc2hvdWxkIGluaXRpYWxpemUgbGF5b3V0IHJlbmRlcmVyJywgYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgcGx1Z2luLm9ubG9hZCgpO1xuICAgICAgXG4gICAgICAvLyBWZXJpZnkgdGhhdCB0aGUgZ3JhcGggYW5kIHByb2Nlc3NvcnMgYXJlIGluaXRpYWxpemVkXG4gICAgICBleHBlY3QocGx1Z2luWydncmFwaCddKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHBsdWdpblsnc3BhcnFsUHJvY2Vzc29yJ10pLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QocGx1Z2luWydncmFwaFZpc3VhbGl6YXRpb25Qcm9jZXNzb3InXSkudG9CZURlZmluZWQoKTtcbiAgICB9KTtcbiAgICBcbiAgICB0ZXN0KCdzaG91bGQgaW5pdGlhbGl6ZSBBUEkgc2VydmVyIHdoZW4gZW5hYmxlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIE5vdGU6IEFQSSBzZXJ2ZXIgaW5pdGlhbGl6YXRpb24gZGVwZW5kcyBvbiBzZXR0aW5nc1xuICAgICAgYXdhaXQgcGx1Z2luLm9ubG9hZCgpO1xuICAgICAgXG4gICAgICAvLyBWZXJpZnkgdGhlIHBsdWdpbiBsb2FkZWQgc3VjY2Vzc2Z1bGx5IHdpdGggY29yZSBjb21wb25lbnRzXG4gICAgICBleHBlY3QocGx1Z2luWydncmFwaCddKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHBsdWdpblsncmRmU2VydmljZSddKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KHBsdWdpblsnY29udGFpbmVyJ10pLnRvQmVEZWZpbmVkKCk7XG4gICAgfSk7XG4gIH0pO1xuICBcbiAgZGVzY3JpYmUoJ0RPTSBQcm9jZXNzaW5nJywgKCkgPT4ge1xuICAgIHRlc3QoJ3Nob3VsZCByZWdpc3RlciBtYXJrZG93biBjb2RlIGJsb2NrIHByb2Nlc3NvcnMnLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBNb2NrIHRoZSByZWdpc3Rlck1hcmtkb3duQ29kZUJsb2NrUHJvY2Vzc29yIG1ldGhvZFxuICAgICAgY29uc3QgcmVnaXN0ZXJQcm9jZXNzb3JTcHkgPSBqZXN0LnNweU9uKHBsdWdpbiwgJ3JlZ2lzdGVyTWFya2Rvd25Db2RlQmxvY2tQcm9jZXNzb3InIGFzIGFueSlcbiAgICAgICAgLm1vY2tJbXBsZW1lbnRhdGlvbigoKSA9PiB7fSk7XG4gICAgICBcbiAgICAgIGF3YWl0IHBsdWdpbi5vbmxvYWQoKTtcbiAgICAgIFxuICAgICAgLy8gVmVyaWZ5IHRoYXQgcHJvY2Vzc29ycyB3ZXJlIHJlZ2lzdGVyZWQgKHdpdGggZXJyb3IgaGFuZGxpbmcpXG4gICAgICAvLyBUaGUgcGx1Z2luIHNob3VsZCBhdHRlbXB0IHRvIHJlZ2lzdGVyIGJvdGggU1BBUlFMIGFuZCBncmFwaCBwcm9jZXNzb3JzXG4gICAgICBleHBlY3QocmVnaXN0ZXJQcm9jZXNzb3JTcHkpLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygyKTtcbiAgICAgIGV4cGVjdChyZWdpc3RlclByb2Nlc3NvclNweSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ3NwYXJxbCcsIGV4cGVjdC5hbnkoRnVuY3Rpb24pKTtcbiAgICAgIGV4cGVjdChyZWdpc3RlclByb2Nlc3NvclNweSkudG9IYXZlQmVlbkNhbGxlZFdpdGgoJ2dyYXBoJywgZXhwZWN0LmFueShGdW5jdGlvbikpO1xuICAgICAgXG4gICAgICAvLyBWZXJpZnkgdGhlIHBsdWdpbiBsb2FkZWQgc3VjY2Vzc2Z1bGx5IGV2ZW4gaWYgcHJvY2Vzc29yIHJlZ2lzdHJhdGlvbiBoYWQgaXNzdWVzXG4gICAgICBleHBlY3QocGx1Z2luWydncmFwaCddKS50b0JlRGVmaW5lZCgpO1xuICAgICAgXG4gICAgICByZWdpc3RlclByb2Nlc3NvclNweS5tb2NrUmVzdG9yZSgpO1xuICAgIH0pO1xuICB9KTtcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==