d46fe2dde7a5cba936e80dbd93efe4ef
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ObsidianCommandExecutor = void 0;
const obsidian_1 = require("obsidian");
const Result_1 = require("../../domain/core/Result");
const ButtonCommand_1 = require("../../domain/entities/ButtonCommand");
const Asset_1 = require("../../domain/entities/Asset");
const AssetId_1 = require("../../domain/value-objects/AssetId");
const ClassName_1 = require("../../domain/value-objects/ClassName");
const OntologyPrefix_1 = require("../../domain/value-objects/OntologyPrefix");
/**
 * Obsidian implementation of command executor
 * Handles actual command execution in the Obsidian environment
 */
class ObsidianCommandExecutor {
    constructor(app, assetRepository, createChildTaskUseCase) {
        this.app = app;
        this.assetRepository = assetRepository;
        this.createChildTaskUseCase = createChildTaskUseCase;
        this.handlers = new Map();
        this.registerDefaultHandlers();
    }
    async execute(request) {
        const startTime = Date.now();
        try {
            // Validate request
            const validationResult = this.validate(request);
            if (validationResult.isFailure) {
                return Result_1.Result.fail(validationResult.error);
            }
            // Get handler for command type
            const handler = this.handlers.get(request.command.type);
            if (!handler) {
                return Result_1.Result.fail(`No handler registered for command type: ${request.command.type}`);
            }
            // Execute command
            const executionResult = await handler(request);
            const executionTime = Date.now() - startTime;
            if (executionResult.isFailure) {
                return Result_1.Result.ok({
                    commandId: request.context.commandId,
                    status: "failure",
                    error: executionResult.error,
                    executionTime,
                });
            }
            return Result_1.Result.ok({
                commandId: request.context.commandId,
                status: "success",
                output: executionResult.getValue(),
                executionTime,
            });
        }
        catch (error) {
            const executionTime = Date.now() - startTime;
            return Result_1.Result.ok({
                commandId: request.context.commandId,
                status: "failure",
                error: `Unexpected error: ${error.message}`,
                executionTime,
            });
        }
    }
    registerHandler(type, handler) {
        this.handlers.set(type, handler);
    }
    isSupported(type) {
        return this.handlers.has(type);
    }
    validate(request) {
        if (!request.command) {
            return Result_1.Result.fail("Command is required");
        }
        if (!request.context) {
            return Result_1.Result.fail("Execution context is required");
        }
        // Validate command-specific requirements
        const command = request.command;
        if (command.requiresInput &&
            (!request.context.parameters ||
                Object.keys(request.context.parameters).length === 0)) {
            return Result_1.Result.fail("Command requires input parameters");
        }
        return Result_1.Result.ok();
    }
    registerDefaultHandlers() {
        // CREATE_ASSET handler
        this.registerHandler(ButtonCommand_1.CommandType.CREATE_ASSET, async (request) => {
            const params = request.context.parameters;
            // Extract parameters
            const title = params.title || "Untitled";
            const className = params.className || request.context.targetClass || "exo__Asset";
            const ontology = params.ontology || "exo";
            const properties = params.properties || {};
            // Create asset ID
            const idResult = AssetId_1.AssetId.create(this.sanitizeFileName(title));
            if (idResult.isFailure) {
                return Result_1.Result.fail(idResult.error);
            }
            // Create class name
            const classNameResult = ClassName_1.ClassName.create(className);
            if (classNameResult.isFailure) {
                return Result_1.Result.fail(classNameResult.error);
            }
            // Create ontology prefix
            const ontologyResult = OntologyPrefix_1.OntologyPrefix.create(ontology);
            if (ontologyResult.isFailure) {
                return Result_1.Result.fail(ontologyResult.error);
            }
            // Create asset
            const assetResult = Asset_1.Asset.create({
                id: idResult.getValue(),
                className: classNameResult.getValue(),
                ontology: ontologyResult.getValue(),
                label: title,
                description: params.description || "",
                properties: properties,
            });
            if (assetResult.isFailure) {
                return Result_1.Result.fail(assetResult.error);
            }
            // Save asset
            await this.assetRepository.save(assetResult.getValue());
            // Open the new asset
            const file = this.app.vault.getAbstractFileByPath(`${title}.md`);
            if (file instanceof obsidian_1.TFile) {
                await this.app.workspace.getLeaf().openFile(file);
            }
            new obsidian_1.Notice(`Asset "${title}" created successfully`);
            return Result_1.Result.ok({ assetId: idResult.getValue().toString() });
        });
        // OPEN_ASSET handler
        this.registerHandler(ButtonCommand_1.CommandType.OPEN_ASSET, async (request) => {
            const assetId = request.context.assetId || request.context.parameters.assetId;
            if (!assetId) {
                return Result_1.Result.fail("Asset ID is required for OPEN_ASSET command");
            }
            const file = this.app.vault.getAbstractFileByPath(`${assetId}.md`);
            if (!(file instanceof obsidian_1.TFile)) {
                return Result_1.Result.fail(`Asset not found: ${assetId}`);
            }
            await this.app.workspace.getLeaf(true).openFile(file);
            return Result_1.Result.ok({ opened: assetId });
        });
        // DELETE_ASSET handler
        this.registerHandler(ButtonCommand_1.CommandType.DELETE_ASSET, async (request) => {
            const assetId = request.context.assetId || request.context.parameters.assetId;
            if (!assetId) {
                return Result_1.Result.fail("Asset ID is required for DELETE_ASSET command");
            }
            const file = this.app.vault.getAbstractFileByPath(`${assetId}.md`);
            if (!(file instanceof obsidian_1.TFile)) {
                return Result_1.Result.fail(`Asset not found: ${assetId}`);
            }
            // Confirm deletion
            const confirmDelete = await this.confirmAction(`Delete Asset`, `Are you sure you want to delete "${assetId}"? This cannot be undone.`);
            if (!confirmDelete) {
                return Result_1.Result.ok({ cancelled: true });
            }
            await this.app.vault.delete(file);
            new obsidian_1.Notice(`Asset "${assetId}" deleted`);
            return Result_1.Result.ok({ deleted: assetId });
        });
        // RUN_TEMPLATE handler
        this.registerHandler(ButtonCommand_1.CommandType.RUN_TEMPLATE, async (request) => {
            const templateName = request.context.template || request.context.parameters.template_name;
            const targetAssetId = request.context.assetId;
            if (!templateName) {
                return Result_1.Result.fail("Template name is required");
            }
            if (!targetAssetId) {
                return Result_1.Result.fail("Target asset is required for template application");
            }
            // Find template file
            const templateFile = this.app.vault.getAbstractFileByPath(`templates/${templateName}.md`);
            if (!(templateFile instanceof obsidian_1.TFile)) {
                return Result_1.Result.fail(`Template not found: ${templateName}`);
            }
            // Read template content
            const templateContent = await this.app.vault.read(templateFile);
            // Find target asset
            const targetFile = this.app.vault.getAbstractFileByPath(`${targetAssetId}.md`);
            if (!(targetFile instanceof obsidian_1.TFile)) {
                return Result_1.Result.fail(`Target asset not found: ${targetAssetId}`);
            }
            // Apply template (append to existing content)
            const currentContent = await this.app.vault.read(targetFile);
            const newContent = currentContent +
                "\n\n" +
                this.processTemplate(templateContent, request.context.parameters);
            await this.app.vault.modify(targetFile, newContent);
            new obsidian_1.Notice(`Template "${templateName}" applied successfully`);
            return Result_1.Result.ok({ template: templateName, target: targetAssetId });
        });
        // EXECUTE_SEARCH handler
        this.registerHandler(ButtonCommand_1.CommandType.EXECUTE_SEARCH, async (request) => {
            const query = request.context.parameters.query;
            if (!query) {
                return Result_1.Result.fail("Search query is required");
            }
            // Open search with query
            // Using Obsidian internal API for search
            this.app.internalPlugins
                .getPluginById("global-search")
                .instance.openGlobalSearch(query);
            return Result_1.Result.ok({ query });
        });
        // TRIGGER_WORKFLOW handler
        this.registerHandler(ButtonCommand_1.CommandType.TRIGGER_WORKFLOW, async (request) => {
            const workflowName = request.context.parameters.workflow;
            if (!workflowName) {
                return Result_1.Result.fail("Workflow name is required");
            }
            // This would integrate with a workflow system
            // For now, just log the workflow trigger
            console.log(`Triggering workflow: ${workflowName}`, request.context.parameters);
            new obsidian_1.Notice(`Workflow "${workflowName}" triggered`);
            return Result_1.Result.ok({ workflow: workflowName });
        });
        // CUSTOM handler
        this.registerHandler(ButtonCommand_1.CommandType.CUSTOM, async (request) => {
            const script = request.context.script;
            if (!script) {
                return Result_1.Result.fail("Script is required for custom commands");
            }
            // Script execution is disabled for security reasons
            // Dynamic code execution (eval, new Function) poses significant security risks:
            // - Arbitrary code execution
            // - Access to sensitive APIs
            // - Potential data exfiltration
            // Please use predefined commands or safe templating instead
            return Result_1.Result.fail("Script execution is disabled for security. Use predefined commands instead.");
        });
        // CREATE_CHILD_TASK handler
        this.registerHandler(ButtonCommand_1.CommandType.CREATE_CHILD_TASK, async (request) => {
            const projectAssetId = request.context.assetId;
            if (!projectAssetId) {
                return Result_1.Result.fail("Project asset ID is required for CREATE_CHILD_TASK command");
            }
            if (!this.createChildTaskUseCase) {
                return Result_1.Result.fail("CreateChildTaskUseCase not initialized");
            }
            const result = await this.createChildTaskUseCase.execute({
                projectAssetId,
                context: {
                    activeFile: request.context.currentView,
                    selection: request.context.selection?.join("\n"),
                },
            });
            if (!result.success) {
                return Result_1.Result.fail(result.message);
            }
            // Open the new task file
            if (result.taskFilePath) {
                const file = this.app.vault.getAbstractFileByPath(result.taskFilePath);
                if (file instanceof obsidian_1.TFile) {
                    await this.app.workspace.getLeaf(true).openFile(file);
                }
            }
            new obsidian_1.Notice(result.message);
            return Result_1.Result.ok({
                taskId: result.taskId,
                taskFilePath: result.taskFilePath,
            });
        });
    }
    sanitizeFileName(name) {
        // Remove characters that are invalid in file names
        return name.replace(/[\\/:*?"<>|]/g, "-").trim();
    }
    processTemplate(template, parameters) {
        // Replace template variables
        let processed = template;
        for (const [key, value] of Object.entries(parameters)) {
            const regex = new RegExp(`{{\\s*${key}\\s*}}`, "g");
            processed = processed.replace(regex, String(value));
        }
        // Replace date variables
        const now = new Date();
        processed = processed.replace(/{{date}}/g, now.toISOString().split("T")[0]);
        processed = processed.replace(/{{time}}/g, now.toTimeString().split(" ")[0]);
        processed = processed.replace(/{{datetime}}/g, now.toISOString());
        return processed;
    }
    async confirmAction(title, message) {
        return new Promise((resolve) => {
            // Create a simple confirmation modal
            const modal = new ConfirmationModal(this.app, title, message, resolve);
            modal.open();
        });
    }
}
exports.ObsidianCommandExecutor = ObsidianCommandExecutor;
/**
 * Simple confirmation modal
 */
class ConfirmationModal extends obsidian_1.Modal {
    constructor(app, title, message, onConfirm) {
        super(app);
        this.title = title;
        this.message = message;
        this.onConfirm = onConfirm;
    }
    onOpen() {
        const { contentEl } = this;
        contentEl.createEl("h2", { text: this.title });
        contentEl.createEl("p", { text: this.message });
        const buttonContainer = contentEl.createDiv({
            cls: "modal-button-container",
        });
        const cancelBtn = buttonContainer.createEl("button", { text: "Cancel" });
        cancelBtn.addEventListener("click", () => {
            this.onConfirm(false);
            this.close();
        });
        const confirmBtn = buttonContainer.createEl("button", {
            text: "Confirm",
            cls: "mod-warning",
        });
        confirmBtn.addEventListener("click", () => {
            this.onConfirm(true);
            this.close();
        });
    }
    onClose() {
        const { contentEl } = this;
        contentEl.empty();
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2luZnJhc3RydWN0dXJlL3NlcnZpY2VzL09ic2lkaWFuQ29tbWFuZEV4ZWN1dG9yLnRzIiwibWFwcGluZ3MiOiI7OztBQUFBLHVDQUE4RDtBQU05RCxxREFBa0Q7QUFDbEQsdUVBQWtFO0FBRWxFLHVEQUFvRDtBQUNwRCxnRUFBNkQ7QUFDN0Qsb0VBQWlFO0FBQ2pFLDhFQUEyRTtBQUczRTs7O0dBR0c7QUFDSCxNQUFhLHVCQUF1QjtJQU1sQyxZQUNVLEdBQVEsRUFDUixlQUFpQyxFQUNqQyxzQkFBK0M7UUFGL0MsUUFBRyxHQUFILEdBQUcsQ0FBSztRQUNSLG9CQUFlLEdBQWYsZUFBZSxDQUFrQjtRQUNqQywyQkFBc0IsR0FBdEIsc0JBQXNCLENBQXlCO1FBRXZELElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUMxQixJQUFJLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztJQUNqQyxDQUFDO0lBRUQsS0FBSyxDQUFDLE9BQU8sQ0FDWCxPQUFnQztRQUVoQyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFN0IsSUFBSTtZQUNGLG1CQUFtQjtZQUNuQixNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDaEQsSUFBSSxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUU7Z0JBQzlCLE9BQU8sZUFBTSxDQUFDLElBQUksQ0FBeUIsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUM7YUFDcEU7WUFFRCwrQkFBK0I7WUFDL0IsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN4RCxJQUFJLENBQUMsT0FBTyxFQUFFO2dCQUNaLE9BQU8sZUFBTSxDQUFDLElBQUksQ0FDaEIsMkNBQTJDLE9BQU8sQ0FBQyxPQUFP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Q0FBQyxTQUFTLENBQUM7WUFDMUMsR0FBRyxFQUFFLHdCQUF3QjtTQUM5QixDQUFDLENBQUM7UUFFSCxNQUFNLFNBQVMsR0FBRyxlQUFlLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBQ3pFLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFO1lBQ3ZDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDdEIsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2YsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLFVBQVUsR0FBRyxlQUFlLENBQUMsUUFBUSxDQUFDLFFBQVEsRUFBRTtZQUNwRCxJQUFJLEVBQUUsU0FBUztZQUNmLEdBQUcsRUFBRSxhQUFhO1NBQ25CLENBQUMsQ0FBQztRQUNILFVBQVUsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFO1lBQ3hDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDckIsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2YsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsT0FBTztRQUNMLE1BQU0sRUFBRSxTQUFTLEVBQUUsR0FBRyxJQUFJLENBQUM7UUFDM0IsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ3BCLENBQUM7Q0FDRiIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva2l0ZWxldi9Eb2N1bWVudHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi9zcmMvaW5mcmFzdHJ1Y3R1cmUvc2VydmljZXMvT2JzaWRpYW5Db21tYW5kRXhlY3V0b3IudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwLCBOb3RpY2UsIFRGaWxlLCBURm9sZGVyLCBNb2RhbCB9IGZyb20gXCJvYnNpZGlhblwiO1xuaW1wb3J0IHtcbiAgSUNvbW1hbmRFeGVjdXRvcixcbiAgQ29tbWFuZEV4ZWN1dGlvblJlcXVlc3QsXG4gIENvbW1hbmRFeGVjdXRpb25SZXN1bHQsXG59IGZyb20gXCIuLi8uLi9hcHBsaWNhdGlvbi9zZXJ2aWNlcy9JQ29tbWFuZEV4ZWN1dG9yXCI7XG5pbXBvcnQgeyBSZXN1bHQgfSBmcm9tIFwiLi4vLi4vZG9tYWluL2NvcmUvUmVzdWx0XCI7XG5pbXBvcnQgeyBDb21tYW5kVHlwZSB9IGZyb20gXCIuLi8uLi9kb21haW4vZW50aXRpZXMvQnV0dG9uQ29tbWFuZFwiO1xuaW1wb3J0IHsgSUFzc2V0UmVwb3NpdG9yeSB9IGZyb20gXCIuLi8uLi9kb21haW4vcmVwb3NpdG9yaWVzL0lBc3NldFJlcG9zaXRvcnlcIjtcbmltcG9ydCB7IEFzc2V0IH0gZnJvbSBcIi4uLy4uL2RvbWFpbi9lbnRpdGllcy9Bc3NldFwiO1xuaW1wb3J0IHsgQXNzZXRJZCB9IGZyb20gXCIuLi8uLi9kb21haW4vdmFsdWUtb2JqZWN0cy9Bc3NldElkXCI7XG5pbXBvcnQgeyBDbGFzc05hbWUgfSBmcm9tIFwiLi4vLi4vZG9tYWluL3ZhbHVlLW9iamVjdHMvQ2xhc3NOYW1lXCI7XG5pbXBvcnQgeyBPbnRvbG9neVByZWZpeCB9IGZyb20gXCIuLi8uLi9kb21haW4vdmFsdWUtb2JqZWN0cy9PbnRvbG9neVByZWZpeFwiO1xuaW1wb3J0IHsgQ3JlYXRlQ2hpbGRUYXNrVXNlQ2FzZSB9IGZyb20gXCIuLi8uLi9hcHBsaWNhdGlvbi91c2UtY2FzZXMvQ3JlYXRlQ2hpbGRUYXNrVXNlQ2FzZVwiO1xuXG4vKipcbiAqIE9ic2lkaWFuIGltcGxlbWVudGF0aW9uIG9mIGNvbW1hbmQgZXhlY3V0b3JcbiAqIEhhbmRsZXMgYWN0dWFsIGNvbW1hbmQgZXhlY3V0aW9uIGluIHRoZSBPYnNpZGlhbiBlbnZpcm9ubWVudFxuICovXG5leHBvcnQgY2xhc3MgT2JzaWRpYW5Db21tYW5kRXhlY3V0b3IgaW1wbGVtZW50cyBJQ29tbWFuZEV4ZWN1dG9yIHtcbiAgcHJpdmF0ZSBoYW5kbGVyczogTWFwPFxuICAgIENvbW1hbmRUeXBlLFxuICAgIChyZXF1ZXN0OiBDb21tYW5kRXhlY3V0aW9uUmVxdWVzdCkgPT4gUHJvbWlzZTxSZXN1bHQ8YW55Pj5cbiAgPjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGFwcDogQXBwLFxuICAgIHByaXZhdGUgYXNzZXRSZXBvc2l0b3J5OiBJQXNzZXRSZXBvc2l0b3J5LFxuICAgIHByaXZhdGUgY3JlYXRlQ2hpbGRUYXNrVXNlQ2FzZT86IENyZWF0ZUNoaWxkVGFza1VzZUNhc2UsXG4gICkge1xuICAgIHRoaXMuaGFuZGxlcnMgPSBuZXcgTWFwKCk7XG4gICAgdGhpcy5yZWdpc3RlckRlZmF1bHRIYW5kbGVycygpO1xuICB9XG5cbiAgYXN5bmMgZXhlY3V0ZShcbiAgICByZXF1ZXN0OiBDb21tYW5kRXhlY3V0aW9uUmVxdWVzdCxcbiAgKTogUHJvbWlzZTxSZXN1bHQ8Q29tbWFuZEV4ZWN1dGlvblJlc3VsdD4+IHtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIFZhbGlkYXRlIHJlcXVlc3RcbiAgICAgIGNvbnN0IHZhbGlkYXRpb25SZXN1bHQgPSB0aGlzLnZhbGlkYXRlKHJlcXVlc3QpO1xuICAgICAgaWYgKHZhbGlkYXRpb25SZXN1bHQuaXNGYWlsdXJlKSB7XG4gICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxDb21tYW5kRXhlY3V0aW9uUmVzdWx0Pih2YWxpZGF0aW9uUmVzdWx0LmVycm9yKTtcbiAgICAgIH1cblxuICAgICAgLy8gR2V0IGhhbmRsZXIgZm9yIGNvbW1hbmQgdHlwZVxuICAgICAgY29uc3QgaGFuZGxlciA9IHRoaXMuaGFuZGxlcnMuZ2V0KHJlcXVlc3QuY29tbWFuZC50eXBlKTtcbiAgICAgIGlmICghaGFuZGxlcikge1xuICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8Q29tbWFuZEV4ZWN1dGlvblJlc3VsdD4oXG4gICAgICAgICAgYE5vIGhhbmRsZXIgcmVnaXN0ZXJlZCBmb3IgY29tbWFuZCB0eXBlOiAke3JlcXVlc3QuY29tbWFuZC50eXBlfWAsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIEV4ZWN1dGUgY29tbWFuZFxuICAgICAgY29uc3QgZXhlY3V0aW9uUmVzdWx0ID0gYXdhaXQgaGFuZGxlcihyZXF1ZXN0KTtcblxuICAgICAgY29uc3QgZXhlY3V0aW9uVGltZSA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG5cbiAgICAgIGlmIChleGVjdXRpb25SZXN1bHQuaXNGYWlsdXJlKSB7XG4gICAgICAgIHJldHVybiBSZXN1bHQub2s8Q29tbWFuZEV4ZWN1dGlvblJlc3VsdD4oe1xuICAgICAgICAgIGNvbW1hbmRJZDogcmVxdWVzdC5jb250ZXh0LmNvbW1hbmRJZCxcbiAgICAgICAgICBzdGF0dXM6IFwiZmFpbHVyZVwiLFxuICAgICAgICAgIGVycm9yOiBleGVjdXRpb25SZXN1bHQuZXJyb3IsXG4gICAgICAgICAgZXhlY3V0aW9uVGltZSxcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBSZXN1bHQub2s8Q29tbWFuZEV4ZWN1dGlvblJlc3VsdD4oe1xuICAgICAgICBjb21tYW5kSWQ6IHJlcXVlc3QuY29udGV4dC5jb21tYW5kSWQsXG4gICAgICAgIHN0YXR1czogXCJzdWNjZXNzXCIsXG4gICAgICAgIG91dHB1dDogZXhlY3V0aW9uUmVzdWx0LmdldFZhbHVlKCksXG4gICAgICAgIGV4ZWN1dGlvblRpbWUsXG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc3QgZXhlY3V0aW9uVGltZSA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG4gICAgICByZXR1cm4gUmVzdWx0Lm9rPENvbW1hbmRFeGVjdXRpb25SZXN1bHQ+KHtcbiAgICAgICAgY29tbWFuZElkOiByZXF1ZXN0LmNvbnRleHQuY29tbWFuZElkLFxuICAgICAgICBzdGF0dXM6IFwiZmFpbHVyZVwiLFxuICAgICAgICBlcnJvcjogYFVuZXhwZWN0ZWQgZXJyb3I6ICR7ZXJyb3IubWVzc2FnZX1gLFxuICAgICAgICBleGVjdXRpb25UaW1lLFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgcmVnaXN0ZXJIYW5kbGVyKFxuICAgIHR5cGU6IENvbW1hbmRUeXBlLFxuICAgIGhhbmRsZXI6IChyZXF1ZXN0OiBDb21tYW5kRXhlY3V0aW9uUmVxdWVzdCkgPT4gUHJvbWlzZTxSZXN1bHQ8YW55Pj4sXG4gICk6IHZvaWQge1xuICAgIHRoaXMuaGFuZGxlcnMuc2V0KHR5cGUsIGhhbmRsZXIpO1xuICB9XG5cbiAgaXNTdXBwb3J0ZWQodHlwZTogQ29tbWFuZFR5cGUpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5oYW5kbGVycy5oYXModHlwZSk7XG4gIH1cblxuICB2YWxpZGF0ZShyZXF1ZXN0OiBDb21tYW5kRXhlY3V0aW9uUmVxdWVzdCk6IFJlc3VsdDx2b2lkPiB7XG4gICAgaWYgKCFyZXF1ZXN0LmNvbW1hbmQpIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDx2b2lkPihcIkNvbW1hbmQgaXMgcmVxdWlyZWRcIik7XG4gICAgfVxuXG4gICAgaWYgKCFyZXF1ZXN0LmNvbnRleHQpIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDx2b2lkPihcIkV4ZWN1dGlvbiBjb250ZXh0IGlzIHJlcXVpcmVkXCIpO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIGNvbW1hbmQtc3BlY2lmaWMgcmVxdWlyZW1lbnRzXG4gICAgY29uc3QgY29tbWFuZCA9IHJlcXVlc3QuY29tbWFuZDtcblxuICAgIGlmIChcbiAgICAgIGNvbW1hbmQucmVxdWlyZXNJbnB1dCAmJlxuICAgICAgKCFyZXF1ZXN0LmNvbnRleHQucGFyYW1ldGVycyB8fFxuICAgICAgICBPYmplY3Qua2V5cyhyZXF1ZXN0LmNvbnRleHQucGFyYW1ldGVycykubGVuZ3RoID09PSAwKVxuICAgICkge1xuICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPHZvaWQ+KFwiQ29tbWFuZCByZXF1aXJlcyBpbnB1dCBwYXJhbWV0ZXJzXCIpO1xuICAgIH1cblxuICAgIHJldHVybiBSZXN1bHQub2s8dm9pZD4oKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVnaXN0ZXJEZWZhdWx0SGFuZGxlcnMoKTogdm9pZCB7XG4gICAgLy8gQ1JFQVRFX0FTU0VUIGhhbmRsZXJcbiAgICB0aGlzLnJlZ2lzdGVySGFuZGxlcihDb21tYW5kVHlwZS5DUkVBVEVfQVNTRVQsIGFzeW5jIChyZXF1ZXN0KSA9PiB7XG4gICAgICBjb25zdCBwYXJhbXMgPSByZXF1ZXN0LmNvbnRleHQucGFyYW1ldGVycztcblxuICAgICAgLy8gRXh0cmFjdCBwYXJhbWV0ZXJzXG4gICAgICBjb25zdCB0aXRsZSA9IHBhcmFtcy50aXRsZSB8fCBcIlVudGl0bGVkXCI7XG4gICAgICBjb25zdCBjbGFzc05hbWUgPVxuICAgICAgICBwYXJhbXMuY2xhc3NOYW1lIHx8IHJlcXVlc3QuY29udGV4dC50YXJnZXRDbGFzcyB8fCBcImV4b19fQXNzZXRcIjtcbiAgICAgIGNvbnN0IG9udG9sb2d5ID0gcGFyYW1zLm9udG9sb2d5IHx8IFwiZXhvXCI7XG4gICAgICBjb25zdCBwcm9wZXJ0aWVzID0gcGFyYW1zLnByb3BlcnRpZXMgfHwge307XG5cbiAgICAgIC8vIENyZWF0ZSBhc3NldCBJRFxuICAgICAgY29uc3QgaWRSZXN1bHQgPSBBc3NldElkLmNyZWF0ZSh0aGlzLnNhbml0aXplRmlsZU5hbWUodGl0bGUpKTtcbiAgICAgIGlmIChpZFJlc3VsdC5pc0ZhaWx1cmUpIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPGFueT4oaWRSZXN1bHQuZXJyb3IpO1xuICAgICAgfVxuXG4gICAgICAvLyBDcmVhdGUgY2xhc3MgbmFtZVxuICAgICAgY29uc3QgY2xhc3NOYW1lUmVzdWx0ID0gQ2xhc3NOYW1lLmNyZWF0ZShjbGFzc05hbWUpO1xuICAgICAgaWYgKGNsYXNzTmFtZVJlc3VsdC5pc0ZhaWx1cmUpIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPGFueT4oY2xhc3NOYW1lUmVzdWx0LmVycm9yKTtcbiAgICAgIH1cblxuICAgICAgLy8gQ3JlYXRlIG9udG9sb2d5IHByZWZpeFxuICAgICAgY29uc3Qgb250b2xvZ3lSZXN1bHQgPSBPbnRvbG9neVByZWZpeC5jcmVhdGUob250b2xvZ3kpO1xuICAgICAgaWYgKG9udG9sb2d5UmVzdWx0LmlzRmFpbHVyZSkge1xuICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8YW55PihvbnRvbG9neVJlc3VsdC5lcnJvcik7XG4gICAgICB9XG5cbiAgICAgIC8vIENyZWF0ZSBhc3NldFxuICAgICAgY29uc3QgYXNzZXRSZXN1bHQgPSBBc3NldC5jcmVhdGUoe1xuICAgICAgICBpZDogaWRSZXN1bHQuZ2V0VmFsdWUoKSxcbiAgICAgICAgY2xhc3NOYW1lOiBjbGFzc05hbWVSZXN1bHQuZ2V0VmFsdWUoKSxcbiAgICAgICAgb250b2xvZ3k6IG9udG9sb2d5UmVzdWx0LmdldFZhbHVlKCksXG4gICAgICAgIGxhYmVsOiB0aXRsZSxcbiAgICAgICAgZGVzY3JpcHRpb246IHBhcmFtcy5kZXNjcmlwdGlvbiB8fCBcIlwiLFxuICAgICAgICBwcm9wZXJ0aWVzOiBwcm9wZXJ0aWVzLFxuICAgICAgfSk7XG5cbiAgICAgIGlmIChhc3NldFJlc3VsdC5pc0ZhaWx1cmUpIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPGFueT4oYXNzZXRSZXN1bHQuZXJyb3IpO1xuICAgICAgfVxuXG4gICAgICAvLyBTYXZlIGFzc2V0XG4gICAgICBhd2FpdCB0aGlzLmFzc2V0UmVwb3NpdG9yeS5zYXZlKGFzc2V0UmVzdWx0LmdldFZhbHVlKCkpO1xuXG4gICAgICAvLyBPcGVuIHRoZSBuZXcgYXNzZXRcbiAgICAgIGNvbnN0IGZpbGUgPSB0aGlzLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoYCR7dGl0bGV9Lm1kYCk7XG4gICAgICBpZiAoZmlsZSBpbnN0YW5jZW9mIFRGaWxlKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuYXBwLndvcmtzcGFjZS5nZXRMZWFmKCkub3BlbkZpbGUoZmlsZSk7XG4gICAgICB9XG5cbiAgICAgIG5ldyBOb3RpY2UoYEFzc2V0IFwiJHt0aXRsZX1cIiBjcmVhdGVkIHN1Y2Nlc3NmdWxseWApO1xuICAgICAgcmV0dXJuIFJlc3VsdC5vazxhbnk+KHsgYXNzZXRJZDogaWRSZXN1bHQuZ2V0VmFsdWUoKS50b1N0cmluZygpIH0pO1xuICAgIH0pO1xuXG4gICAgLy8gT1BFTl9BU1NFVCBoYW5kbGVyXG4gICAgdGhpcy5yZWdpc3RlckhhbmRsZXIoQ29tbWFuZFR5cGUuT1BFTl9BU1NFVCwgYXN5bmMgKHJlcXVlc3QpID0+IHtcbiAgICAgIGNvbnN0IGFzc2V0SWQgPVxuICAgICAgICByZXF1ZXN0LmNvbnRleHQuYXNzZXRJZCB8fCByZXF1ZXN0LmNvbnRleHQucGFyYW1ldGVycy5hc3NldElkO1xuXG4gICAgICBpZiAoIWFzc2V0SWQpIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPGFueT4oXCJBc3NldCBJRCBpcyByZXF1aXJlZCBmb3IgT1BFTl9BU1NFVCBjb21tYW5kXCIpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBmaWxlID0gdGhpcy5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKGAke2Fzc2V0SWR9Lm1kYCk7XG4gICAgICBpZiAoIShmaWxlIGluc3RhbmNlb2YgVEZpbGUpKSB7XG4gICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxhbnk+KGBBc3NldCBub3QgZm91bmQ6ICR7YXNzZXRJZH1gKTtcbiAgICAgIH1cblxuICAgICAgYXdhaXQgdGhpcy5hcHAud29ya3NwYWNlLmdldExlYWYodHJ1ZSkub3BlbkZpbGUoZmlsZSk7XG4gICAgICByZXR1cm4gUmVzdWx0Lm9rPGFueT4oeyBvcGVuZWQ6IGFzc2V0SWQgfSk7XG4gICAgfSk7XG5cbiAgICAvLyBERUxFVEVfQVNTRVQgaGFuZGxlclxuICAgIHRoaXMucmVnaXN0ZXJIYW5kbGVyKENvbW1hbmRUeXBlLkRFTEVURV9BU1NFVCwgYXN5bmMgKHJlcXVlc3QpID0+IHtcbiAgICAgIGNvbnN0IGFzc2V0SWQgPVxuICAgICAgICByZXF1ZXN0LmNvbnRleHQuYXNzZXRJZCB8fCByZXF1ZXN0LmNvbnRleHQucGFyYW1ldGVycy5hc3NldElkO1xuXG4gICAgICBpZiAoIWFzc2V0SWQpIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPGFueT4oXG4gICAgICAgICAgXCJBc3NldCBJRCBpcyByZXF1aXJlZCBmb3IgREVMRVRFX0FTU0VUIGNvbW1hbmRcIixcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZmlsZSA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChgJHthc3NldElkfS5tZGApO1xuICAgICAgaWYgKCEoZmlsZSBpbnN0YW5jZW9mIFRGaWxlKSkge1xuICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8YW55PihgQXNzZXQgbm90IGZvdW5kOiAke2Fzc2V0SWR9YCk7XG4gICAgICB9XG5cbiAgICAgIC8vIENvbmZpcm0gZGVsZXRpb25cbiAgICAgIGNvbnN0IGNvbmZpcm1EZWxldGUgPSBhd2FpdCB0aGlzLmNvbmZpcm1BY3Rpb24oXG4gICAgICAgIGBEZWxldGUgQXNzZXRgLFxuICAgICAgICBgQXJlIHlvdSBzdXJlIHlvdSB3YW50IHRvIGRlbGV0ZSBcIiR7YXNzZXRJZH1cIj8gVGhpcyBjYW5ub3QgYmUgdW5kb25lLmAsXG4gICAgICApO1xuXG4gICAgICBpZiAoIWNvbmZpcm1EZWxldGUpIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5vazxhbnk+KHsgY2FuY2VsbGVkOiB0cnVlIH0pO1xuICAgICAgfVxuXG4gICAgICBhd2FpdCB0aGlzLmFwcC52YXVsdC5kZWxldGUoZmlsZSk7XG4gICAgICBuZXcgTm90aWNlKGBBc3NldCBcIiR7YXNzZXRJZH1cIiBkZWxldGVkYCk7XG4gICAgICByZXR1cm4gUmVzdWx0Lm9rPGFueT4oeyBkZWxldGVkOiBhc3NldElkIH0pO1xuICAgIH0pO1xuXG4gICAgLy8gUlVOX1RFTVBMQVRFIGhhbmRsZXJcbiAgICB0aGlzLnJlZ2lzdGVySGFuZGxlcihDb21tYW5kVHlwZS5SVU5fVEVNUExBVEUsIGFzeW5jIChyZXF1ZXN0KSA9PiB7XG4gICAgICBjb25zdCB0ZW1wbGF0ZU5hbWUgPVxuICAgICAgICByZXF1ZXN0LmNvbnRleHQudGVtcGxhdGUgfHwgcmVxdWVzdC5jb250ZXh0LnBhcmFtZXRlcnMudGVtcGxhdGVfbmFtZTtcbiAgICAgIGNvbnN0IHRhcmdldEFzc2V0SWQgPSByZXF1ZXN0LmNvbnRleHQuYXNzZXRJZDtcblxuICAgICAgaWYgKCF0ZW1wbGF0ZU5hbWUpIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPGFueT4oXCJUZW1wbGF0ZSBuYW1lIGlzIHJlcXVpcmVkXCIpO1xuICAgICAgfVxuXG4gICAgICBpZiAoIXRhcmdldEFzc2V0SWQpIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPGFueT4oXG4gICAgICAgICAgXCJUYXJnZXQgYXNzZXQgaXMgcmVxdWlyZWQgZm9yIHRlbXBsYXRlIGFwcGxpY2F0aW9uXCIsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIC8vIEZpbmQgdGVtcGxhdGUgZmlsZVxuICAgICAgY29uc3QgdGVtcGxhdGVGaWxlID0gdGhpcy5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKFxuICAgICAgICBgdGVtcGxhdGVzLyR7dGVtcGxhdGVOYW1lfS5tZGAsXG4gICAgICApO1xuICAgICAgaWYgKCEodGVtcGxhdGVGaWxlIGluc3RhbmNlb2YgVEZpbGUpKSB7XG4gICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxhbnk+KGBUZW1wbGF0ZSBub3QgZm91bmQ6ICR7dGVtcGxhdGVOYW1lfWApO1xuICAgICAgfVxuXG4gICAgICAvLyBSZWFkIHRlbXBsYXRlIGNvbnRlbnRcbiAgICAgIGNvbnN0IHRlbXBsYXRlQ29udGVudCA9IGF3YWl0IHRoaXMuYXBwLnZhdWx0LnJlYWQodGVtcGxhdGVGaWxlKTtcblxuICAgICAgLy8gRmluZCB0YXJnZXQgYXNzZXRcbiAgICAgIGNvbnN0IHRhcmdldEZpbGUgPSB0aGlzLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoXG4gICAgICAgIGAke3RhcmdldEFzc2V0SWR9Lm1kYCxcbiAgICAgICk7XG4gICAgICBpZiAoISh0YXJnZXRGaWxlIGluc3RhbmNlb2YgVEZpbGUpKSB7XG4gICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxhbnk+KGBUYXJnZXQgYXNzZXQgbm90IGZvdW5kOiAke3RhcmdldEFzc2V0SWR9YCk7XG4gICAgICB9XG5cbiAgICAgIC8vIEFwcGx5IHRlbXBsYXRlIChhcHBlbmQgdG8gZXhpc3RpbmcgY29udGVudClcbiAgICAgIGNvbnN0IGN1cnJlbnRDb250ZW50ID0gYXdhaXQgdGhpcy5hcHAudmF1bHQucmVhZCh0YXJnZXRGaWxlKTtcbiAgICAgIGNvbnN0IG5ld0NvbnRlbnQgPVxuICAgICAgICBjdXJyZW50Q29udGVudCArXG4gICAgICAgIFwiXFxuXFxuXCIgK1xuICAgICAgICB0aGlzLnByb2Nlc3NUZW1wbGF0ZSh0ZW1wbGF0ZUNvbnRlbnQsIHJlcXVlc3QuY29udGV4dC5wYXJhbWV0ZXJzKTtcblxuICAgICAgYXdhaXQgdGhpcy5hcHAudmF1bHQubW9kaWZ5KHRhcmdldEZpbGUsIG5ld0NvbnRlbnQpO1xuXG4gICAgICBuZXcgTm90aWNlKGBUZW1wbGF0ZSBcIiR7dGVtcGxhdGVOYW1lfVwiIGFwcGxpZWQgc3VjY2Vzc2Z1bGx5YCk7XG4gICAgICByZXR1cm4gUmVzdWx0Lm9rPGFueT4oeyB0ZW1wbGF0ZTogdGVtcGxhdGVOYW1lLCB0YXJnZXQ6IHRhcmdldEFzc2V0SWQgfSk7XG4gICAgfSk7XG5cbiAgICAvLyBFWEVDVVRFX1NFQVJDSCBoYW5kbGVyXG4gICAgdGhpcy5yZWdpc3RlckhhbmRsZXIoQ29tbWFuZFR5cGUuRVhFQ1VURV9TRUFSQ0gsIGFzeW5jIChyZXF1ZXN0KSA9PiB7XG4gICAgICBjb25zdCBxdWVyeSA9IHJlcXVlc3QuY29udGV4dC5wYXJhbWV0ZXJzLnF1ZXJ5O1xuXG4gICAgICBpZiAoIXF1ZXJ5KSB7XG4gICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxhbnk+KFwiU2VhcmNoIHF1ZXJ5IGlzIHJlcXVpcmVkXCIpO1xuICAgICAgfVxuXG4gICAgICAvLyBPcGVuIHNlYXJjaCB3aXRoIHF1ZXJ5XG4gICAgICAvLyBVc2luZyBPYnNpZGlhbiBpbnRlcm5hbCBBUEkgZm9yIHNlYXJjaFxuICAgICAgKHRoaXMuYXBwIGFzIGFueSkuaW50ZXJuYWxQbHVnaW5zXG4gICAgICAgIC5nZXRQbHVnaW5CeUlkKFwiZ2xvYmFsLXNlYXJjaFwiKVxuICAgICAgICAuaW5zdGFuY2Uub3Blbkdsb2JhbFNlYXJjaChxdWVyeSk7XG5cbiAgICAgIHJldHVybiBSZXN1bHQub2s8YW55Pih7IHF1ZXJ5IH0pO1xuICAgIH0pO1xuXG4gICAgLy8gVFJJR0dFUl9XT1JLRkxPVyBoYW5kbGVyXG4gICAgdGhpcy5yZWdpc3RlckhhbmRsZXIoQ29tbWFuZFR5cGUuVFJJR0dFUl9XT1JLRkxPVywgYXN5bmMgKHJlcXVlc3QpID0+IHtcbiAgICAgIGNvbnN0IHdvcmtmbG93TmFtZSA9IHJlcXVlc3QuY29udGV4dC5wYXJhbWV0ZXJzLndvcmtmbG93O1xuXG4gICAgICBpZiAoIXdvcmtmbG93TmFtZSkge1xuICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8YW55PihcIldvcmtmbG93IG5hbWUgaXMgcmVxdWlyZWRcIik7XG4gICAgICB9XG5cbiAgICAgIC8vIFRoaXMgd291bGQgaW50ZWdyYXRlIHdpdGggYSB3b3JrZmxvdyBzeXN0ZW1cbiAgICAgIC8vIEZvciBub3csIGp1c3QgbG9nIHRoZSB3b3JrZmxvdyB0cmlnZ2VyXG4gICAgICBjb25zb2xlLmxvZyhcbiAgICAgICAgYFRyaWdnZXJpbmcgd29ya2Zsb3c6ICR7d29ya2Zsb3dOYW1lfWAsXG4gICAgICAgIHJlcXVlc3QuY29udGV4dC5wYXJhbWV0ZXJzLFxuICAgICAgKTtcblxuICAgICAgbmV3IE5vdGljZShgV29ya2Zsb3cgXCIke3dvcmtmbG93TmFtZX1cIiB0cmlnZ2VyZWRgKTtcbiAgICAgIHJldHVybiBSZXN1bHQub2s8YW55Pih7IHdvcmtmbG93OiB3b3JrZmxvd05hbWUgfSk7XG4gICAgfSk7XG5cbiAgICAvLyBDVVNUT00gaGFuZGxlclxuICAgIHRoaXMucmVnaXN0ZXJIYW5kbGVyKENvbW1hbmRUeXBlLkNVU1RPTSwgYXN5bmMgKHJlcXVlc3QpID0+IHtcbiAgICAgIGNvbnN0IHNjcmlwdCA9IHJlcXVlc3QuY29udGV4dC5zY3JpcHQ7XG5cbiAgICAgIGlmICghc2NyaXB0KSB7XG4gICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxhbnk+KFwiU2NyaXB0IGlzIHJlcXVpcmVkIGZvciBjdXN0b20gY29tbWFuZHNcIik7XG4gICAgICB9XG5cbiAgICAgIC8vIFNjcmlwdCBleGVjdXRpb24gaXMgZGlzYWJsZWQgZm9yIHNlY3VyaXR5IHJlYXNvbnNcbiAgICAgIC8vIER5bmFtaWMgY29kZSBleGVjdXRpb24gKGV2YWwsIG5ldyBGdW5jdGlvbikgcG9zZXMgc2lnbmlmaWNhbnQgc2VjdXJpdHkgcmlza3M6XG4gICAgICAvLyAtIEFyYml0cmFyeSBjb2RlIGV4ZWN1dGlvblxuICAgICAgLy8gLSBBY2Nlc3MgdG8gc2Vuc2l0aXZlIEFQSXNcbiAgICAgIC8vIC0gUG90ZW50aWFsIGRhdGEgZXhmaWx0cmF0aW9uXG4gICAgICAvLyBQbGVhc2UgdXNlIHByZWRlZmluZWQgY29tbWFuZHMgb3Igc2FmZSB0ZW1wbGF0aW5nIGluc3RlYWRcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxhbnk+KFxuICAgICAgICBcIlNjcmlwdCBleGVjdXRpb24gaXMgZGlzYWJsZWQgZm9yIHNlY3VyaXR5LiBVc2UgcHJlZGVmaW5lZCBjb21tYW5kcyBpbnN0ZWFkLlwiLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIC8vIENSRUFURV9DSElMRF9UQVNLIGhhbmRsZXJcbiAgICB0aGlzLnJlZ2lzdGVySGFuZGxlcihDb21tYW5kVHlwZS5DUkVBVEVfQ0hJTERfVEFTSywgYXN5bmMgKHJlcXVlc3QpID0+IHtcbiAgICAgIGNvbnN0IHByb2plY3RBc3NldElkID0gcmVxdWVzdC5jb250ZXh0LmFzc2V0SWQ7XG5cbiAgICAgIGlmICghcHJvamVjdEFzc2V0SWQpIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPGFueT4oXG4gICAgICAgICAgXCJQcm9qZWN0IGFzc2V0IElEIGlzIHJlcXVpcmVkIGZvciBDUkVBVEVfQ0hJTERfVEFTSyBjb21tYW5kXCIsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGlmICghdGhpcy5jcmVhdGVDaGlsZFRhc2tVc2VDYXNlKSB7XG4gICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxhbnk+KFwiQ3JlYXRlQ2hpbGRUYXNrVXNlQ2FzZSBub3QgaW5pdGlhbGl6ZWRcIik7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuY3JlYXRlQ2hpbGRUYXNrVXNlQ2FzZS5leGVjdXRlKHtcbiAgICAgICAgcHJvamVjdEFzc2V0SWQsXG4gICAgICAgIGNvbnRleHQ6IHtcbiAgICAgICAgICBhY3RpdmVGaWxlOiByZXF1ZXN0LmNvbnRleHQuY3VycmVudFZpZXcsXG4gICAgICAgICAgc2VsZWN0aW9uOiByZXF1ZXN0LmNvbnRleHQuc2VsZWN0aW9uPy5qb2luKFwiXFxuXCIpLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGlmICghcmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPGFueT4ocmVzdWx0Lm1lc3NhZ2UpO1xuICAgICAgfVxuXG4gICAgICAvLyBPcGVuIHRoZSBuZXcgdGFzayBmaWxlXG4gICAgICBpZiAocmVzdWx0LnRhc2tGaWxlUGF0aCkge1xuICAgICAgICBjb25zdCBmaWxlID0gdGhpcy5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKHJlc3VsdC50YXNrRmlsZVBhdGgpO1xuICAgICAgICBpZiAoZmlsZSBpbnN0YW5jZW9mIFRGaWxlKSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5hcHAud29ya3NwYWNlLmdldExlYWYodHJ1ZSkub3BlbkZpbGUoZmlsZSk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgbmV3IE5vdGljZShyZXN1bHQubWVzc2FnZSk7XG4gICAgICByZXR1cm4gUmVzdWx0Lm9rPGFueT4oe1xuICAgICAgICB0YXNrSWQ6IHJlc3VsdC50YXNrSWQsXG4gICAgICAgIHRhc2tGaWxlUGF0aDogcmVzdWx0LnRhc2tGaWxlUGF0aCxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzYW5pdGl6ZUZpbGVOYW1lKG5hbWU6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgLy8gUmVtb3ZlIGNoYXJhY3RlcnMgdGhhdCBhcmUgaW52YWxpZCBpbiBmaWxlIG5hbWVzXG4gICAgcmV0dXJuIG5hbWUucmVwbGFjZSgvW1xcXFwvOio/XCI8PnxdL2csIFwiLVwiKS50cmltKCk7XG4gIH1cblxuICBwcml2YXRlIHByb2Nlc3NUZW1wbGF0ZShcbiAgICB0ZW1wbGF0ZTogc3RyaW5nLFxuICAgIHBhcmFtZXRlcnM6IFJlY29yZDxzdHJpbmcsIGFueT4sXG4gICk6IHN0cmluZyB7XG4gICAgLy8gUmVwbGFjZSB0ZW1wbGF0ZSB2YXJpYWJsZXNcbiAgICBsZXQgcHJvY2Vzc2VkID0gdGVtcGxhdGU7XG5cbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhwYXJhbWV0ZXJzKSkge1xuICAgICAgY29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKGB7e1xcXFxzKiR7a2V5fVxcXFxzKn19YCwgXCJnXCIpO1xuICAgICAgcHJvY2Vzc2VkID0gcHJvY2Vzc2VkLnJlcGxhY2UocmVnZXgsIFN0cmluZyh2YWx1ZSkpO1xuICAgIH1cblxuICAgIC8vIFJlcGxhY2UgZGF0ZSB2YXJpYWJsZXNcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIHByb2Nlc3NlZCA9IHByb2Nlc3NlZC5yZXBsYWNlKC97e2RhdGV9fS9nLCBub3cudG9JU09TdHJpbmcoKS5zcGxpdChcIlRcIilbMF0pO1xuICAgIHByb2Nlc3NlZCA9IHByb2Nlc3NlZC5yZXBsYWNlKFxuICAgICAgL3t7dGltZX19L2csXG4gICAgICBub3cudG9UaW1lU3RyaW5nKCkuc3BsaXQoXCIgXCIpWzBdLFxuICAgICk7XG4gICAgcHJvY2Vzc2VkID0gcHJvY2Vzc2VkLnJlcGxhY2UoL3t7ZGF0ZXRpbWV9fS9nLCBub3cudG9JU09TdHJpbmcoKSk7XG5cbiAgICByZXR1cm4gcHJvY2Vzc2VkO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjb25maXJtQWN0aW9uKFxuICAgIHRpdGxlOiBzdHJpbmcsXG4gICAgbWVzc2FnZTogc3RyaW5nLFxuICApOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpID0+IHtcbiAgICAgIC8vIENyZWF0ZSBhIHNpbXBsZSBjb25maXJtYXRpb24gbW9kYWxcbiAgICAgIGNvbnN0IG1vZGFsID0gbmV3IENvbmZpcm1hdGlvbk1vZGFsKHRoaXMuYXBwLCB0aXRsZSwgbWVzc2FnZSwgcmVzb2x2ZSk7XG4gICAgICBtb2RhbC5vcGVuKCk7XG4gICAgfSk7XG4gIH1cbn1cblxuLyoqXG4gKiBTaW1wbGUgY29uZmlybWF0aW9uIG1vZGFsXG4gKi9cbmNsYXNzIENvbmZpcm1hdGlvbk1vZGFsIGV4dGVuZHMgTW9kYWwge1xuICBjb25zdHJ1Y3RvcihcbiAgICBhcHA6IEFwcCxcbiAgICBwcml2YXRlIHRpdGxlOiBzdHJpbmcsXG4gICAgcHJpdmF0ZSBtZXNzYWdlOiBzdHJpbmcsXG4gICAgcHJpdmF0ZSBvbkNvbmZpcm06IChjb25maXJtZWQ6IGJvb2xlYW4pID0+IHZvaWQsXG4gICkge1xuICAgIHN1cGVyKGFwcCk7XG4gIH1cblxuICBvbk9wZW4oKTogdm9pZCB7XG4gICAgY29uc3QgeyBjb250ZW50RWwgfSA9IHRoaXM7XG5cbiAgICBjb250ZW50RWwuY3JlYXRlRWwoXCJoMlwiLCB7IHRleHQ6IHRoaXMudGl0bGUgfSk7XG4gICAgY29udGVudEVsLmNyZWF0ZUVsKFwicFwiLCB7IHRleHQ6IHRoaXMubWVzc2FnZSB9KTtcblxuICAgIGNvbnN0IGJ1dHRvbkNvbnRhaW5lciA9IGNvbnRlbnRFbC5jcmVhdGVEaXYoe1xuICAgICAgY2xzOiBcIm1vZGFsLWJ1dHRvbi1jb250YWluZXJcIixcbiAgICB9KTtcblxuICAgIGNvbnN0IGNhbmNlbEJ0biA9IGJ1dHRvbkNvbnRhaW5lci5jcmVhdGVFbChcImJ1dHRvblwiLCB7IHRleHQ6IFwiQ2FuY2VsXCIgfSk7XG4gICAgY2FuY2VsQnRuLmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCAoKSA9PiB7XG4gICAgICB0aGlzLm9uQ29uZmlybShmYWxzZSk7XG4gICAgICB0aGlzLmNsb3NlKCk7XG4gICAgfSk7XG5cbiAgICBjb25zdCBjb25maXJtQnRuID0gYnV0dG9uQ29udGFpbmVyLmNyZWF0ZUVsKFwiYnV0dG9uXCIsIHtcbiAgICAgIHRleHQ6IFwiQ29uZmlybVwiLFxuICAgICAgY2xzOiBcIm1vZC13YXJuaW5nXCIsXG4gICAgfSk7XG4gICAgY29uZmlybUJ0bi5hZGRFdmVudExpc3RlbmVyKFwiY2xpY2tcIiwgKCkgPT4ge1xuICAgICAgdGhpcy5vbkNvbmZpcm0odHJ1ZSk7XG4gICAgICB0aGlzLmNsb3NlKCk7XG4gICAgfSk7XG4gIH1cblxuICBvbkNsb3NlKCk6IHZvaWQge1xuICAgIGNvbnN0IHsgY29udGVudEVsIH0gPSB0aGlzO1xuICAgIGNvbnRlbnRFbC5lbXB0eSgpO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=