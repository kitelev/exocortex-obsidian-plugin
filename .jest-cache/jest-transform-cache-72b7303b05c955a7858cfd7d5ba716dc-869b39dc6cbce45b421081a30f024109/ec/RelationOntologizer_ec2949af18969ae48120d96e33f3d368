c9c60e9da042ee4cc8ce72758ad1e759
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RelationOntologizer = void 0;
const tslib_1 = require("tslib");
const obsidian_1 = require("obsidian");
const RelationAsset_1 = require("../../domain/entities/RelationAsset");
/**
 * Service for converting asset properties to Relation instances
 * This implements the ontologization of relationships concept
 */
class RelationOntologizer {
    constructor(app) {
        this.relationsFolder = '99 Relations'; // Folder for relation assets
        this.app = app;
    }
    /**
     * Convert frontmatter object properties to Relation assets
     */
    ontologizeAsset(file) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const relations = [];
            const cache = this.app.metadataCache.getFileCache(file);
            if (!(cache === null || cache === void 0 ? void 0 : cache.frontmatter)) {
                return relations;
            }
            const frontmatter = cache.frontmatter;
            const assetUid = frontmatter['exo__Asset_uid'] || file.basename;
            // Process each frontmatter property
            for (const [key, value] of Object.entries(frontmatter)) {
                if (this.isObjectProperty(key, value)) {
                    const propertyRelations = yield this.processProperty(assetUid, key, value, file);
                    relations.push(...propertyRelations);
                }
            }
            return relations;
        });
    }
    /**
     * Check if a property represents an object relationship
     */
    isObjectProperty(key, value) {
        // Skip meta properties
        const metaProperties = [
            'exo__Asset_uid',
            'exo__Asset_createdAt',
            'exo__Asset_modifiedAt',
            'exo__Instance_class',
            'tags',
            'title',
            'status',
            'description'
        ];
        if (metaProperties.includes(key)) {
            return false;
        }
        // Object properties typically have these patterns
        const objectPropertyPatterns = [
            /_relates$/,
            /_parent$/,
            /_children$/,
            /_assignedTo$/,
            /_project$/,
            /_area$/,
            /_partOf$/,
            /_blocks$/,
            /_dependsOn$/,
            /_relatedTo$/,
            /_isDefinedBy$/,
            /_hasPart$/,
            /_hasTask$/
        ];
        // Check if it matches object property patterns
        if (objectPropertyPatterns.some(pattern => pattern.test(key))) {
            return true;
        }
        // Check if value contains wiki link pattern
        if (value !== undefined && value !== null) {
            const valueStr = Array.isArray(value) ? value[0] : String(value);
            if (valueStr && typeof valueStr === 'string' && valueStr.includes('[[')) {
                return true;
            }
        }
        return false;
    }
    /**
     * Process a single property and create relations
     */
    processProperty(subjectUid, predicate, value, sourceFile) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const relations = [];
            // Handle array values
            if (Array.isArray(value)) {
                for (const item of value) {
                    const relation = this.createRelation(subjectUid, predicate, item, sourceFile);
                    if (relation) {
                        relations.push(relation);
                    }
                }
            }
            else {
                const relation = this.createRelation(subjectUid, predicate, value, sourceFile);
                if (relation) {
                    relations.push(relation);
                }
            }
            return relations;
        });
    }
    /**
     * Create a single relation
     */
    createRelation(subject, predicate, object, sourceFile) {
        if (!object)
            return null;
        // Extract object identifier from wiki link
        let objectId = String(object);
        if (objectId.includes('[[')) {
            objectId = objectId.replace(/\[\[|\]\]/g, '');
        }
        // Skip empty values
        if (!objectId || objectId === 'null' || objectId === 'undefined') {
            return null;
        }
        return RelationAsset_1.RelationAssetHelper.create({
            subject,
            predicate,
            object: objectId,
            provenance: `ontologized from ${sourceFile.path}`
        });
    }
    /**
     * Create relation files in vault
     */
    createRelationFiles(relations) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            // Ensure relations folder exists
            yield this.ensureRelationsFolder();
            const created = [];
            const failed = [];
            for (const relation of relations) {
                try {
                    yield this.createRelationFile(relation);
                    created.push(relation.uid);
                }
                catch (error) {
                    console.error(`Failed to create relation ${relation.uid}:`, error);
                    failed.push(relation.uid);
                }
            }
            // Show summary notification
            if (created.length > 0) {
                new obsidian_1.Notice(`Created ${created.length} relation assets`);
            }
            if (failed.length > 0) {
                new obsidian_1.Notice(`Failed to create ${failed.length} relations`);
            }
        });
    }
    /**
     * Create a single relation file
     */
    createRelationFile(relation) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const filename = RelationAsset_1.RelationAssetHelper.generateFilename(relation);
            const filepath = `${this.relationsFolder}/${filename}`;
            // Generate frontmatter
            const frontmatter = RelationAsset_1.RelationAssetHelper.toFrontmatter(relation);
            const frontmatterYaml = this.generateYaml(frontmatter);
            // Generate content
            const content = `---
${frontmatterYaml}---

# Relation: ${relation.predicate}

**Subject**: [[${relation.subject}]]
**Predicate**: \`${relation.predicate}\`
**Object**: [[${relation.object}]]

## Metadata
- **Created**: ${relation.createdAt.toISOString()}
- **Confidence**: ${relation.confidence || 1.0}
- **Provenance**: ${relation.provenance}
${relation.inverseOf ? `- **Inverse**: [[${relation.inverseOf}]]` : ''}

## Description
This relation represents the connection between assets using the predicate \`${relation.predicate}\`.

---
*This file was automatically generated by RelationOntologizer*`;
            // Create the file
            const file = yield this.app.vault.create(filepath, content);
            return file;
        });
    }
    /**
     * Ensure relations folder exists
     */
    ensureRelationsFolder() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const folder = this.app.vault.getAbstractFileByPath(this.relationsFolder);
            if (!folder) {
                yield this.app.vault.createFolder(this.relationsFolder);
            }
        });
    }
    /**
     * Generate YAML from object
     */
    generateYaml(obj) {
        const lines = [];
        for (const [key, value] of Object.entries(obj)) {
            if (value === undefined || value === null)
                continue;
            if (Array.isArray(value)) {
                lines.push(`${key}:`);
                for (const item of value) {
                    lines.push(`  - ${JSON.stringify(item)}`);
                }
            }
            else if (typeof value === 'object') {
                lines.push(`${key}: ${JSON.stringify(value)}`);
            }
            else {
                lines.push(`${key}: ${JSON.stringify(value)}`);
            }
        }
        return lines.join('\n') + '\n';
    }
    /**
     * Clean original asset by removing converted properties
     */
    cleanAssetFrontmatter(file, propertiesToRemove) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const content = yield this.app.vault.read(file);
            const cache = this.app.metadataCache.getFileCache(file);
            if (!(cache === null || cache === void 0 ? void 0 : cache.frontmatter))
                return;
            // Parse frontmatter
            const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
            if (!frontmatterMatch)
                return;
            const frontmatterText = frontmatterMatch[1];
            const lines = frontmatterText.split('\n');
            const newLines = [];
            let skipProperty = false;
            for (const line of lines) {
                // Check if this line starts a property to remove
                const isPropertyLine = propertiesToRemove.some(prop => line.startsWith(`${prop}:`));
                if (isPropertyLine) {
                    skipProperty = true;
                    continue;
                }
                // Skip array items of removed properties
                if (skipProperty && (line.startsWith('  - ') || line.startsWith('    '))) {
                    continue;
                }
                else {
                    skipProperty = false;
                }
                newLines.push(line);
            }
            // Reconstruct content
            const newFrontmatter = newLines.join('\n');
            const newContent = content.replace(frontmatterMatch[0], `---\n${newFrontmatter}\n---`);
            yield this.app.vault.modify(file, newContent);
        });
    }
    /**
     * Migrate entire vault to relation-based model
     */
    migrateVault(progressCallback) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const files = this.app.vault.getMarkdownFiles();
            const errors = [];
            let totalRelations = 0;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                // Skip relation files themselves
                if (file.path.startsWith(this.relationsFolder)) {
                    continue;
                }
                try {
                    const relations = yield this.ontologizeAsset(file);
                    if (relations.length > 0) {
                        yield this.createRelationFiles(relations);
                        // Get properties that were converted
                        const convertedProperties = [...new Set(relations.map(r => r.predicate))];
                        // Clean the original asset
                        yield this.cleanAssetFrontmatter(file, convertedProperties);
                        totalRelations += relations.length;
                    }
                }
                catch (error) {
                    errors.push(`${file.path}: ${error}`);
                }
                if (progressCallback) {
                    progressCallback(i + 1, files.length);
                }
            }
            return {
                assetsProcessed: files.length,
                relationsCreated: totalRelations,
                errors
            };
        });
    }
}
exports.RelationOntologizer = RelationOntologizer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2FwcGxpY2F0aW9uL3NlcnZpY2VzL1JlbGF0aW9uT250b2xvZ2l6ZXIudHMiLCJtYXBwaW5ncyI6Ijs7OztBQUFBLHVDQUF1RDtBQUN2RCx1RUFBeUY7QUFFekY7OztHQUdHO0FBQ0gsTUFBYSxtQkFBbUI7SUFJNUIsWUFBWSxHQUFRO1FBRlosb0JBQWUsR0FBVyxjQUFjLENBQUMsQ0FBQyw2QkFBNkI7UUFHM0UsSUFBSSxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUM7SUFDbkIsQ0FBQztJQUVEOztPQUVHO0lBQ0csZUFBZSxDQUFDLElBQVc7O1lBQzdCLE1BQU0sU0FBUyxHQUFvQixFQUFFLENBQUM7WUFDdEMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBRXhELElBQUksQ0FBQyxDQUFBLEtBQUssYUFBTCxLQUFLLHVCQUFMLEtBQUssQ0FBRSxXQUFXLENBQUEsRUFBRTtnQkFDckIsT0FBTyxTQUFTLENBQUM7YUFDcEI7WUFFRCxNQUFNLFdBQVcsR0FBRyxLQUFLLENBQUMsV0FBVyxDQUFDO1lBQ3RDLE1BQU0sUUFBUSxHQUFHLFdBQVcsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUM7WUFFaEUsb0NBQW9DO1lBQ3BDLEtBQUssTUFBTSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsSUFBSSxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxFQUFFO2dCQUNwRCxJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLEVBQUU7b0JBQ25DLE1BQU0saUJBQWlCLEdBQUcsTUFBTSxJQUFJLENBQUMsZUFBZSxDQUNoRCxRQUFRLEVBQ1IsR0FBRyxFQUNILEtBQUssRUFDTCxJQUFJLENBQ1AsQ0FBQztvQkFDRixTQUFTLENBQUMsSUFBSSxDQUFDLEdB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O3dCQUNyQyxNQUFNLG1CQUFtQixHQUFHLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FDbkMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FDbEMsQ0FBQyxDQUFDO3dCQUVILDJCQUEyQjt3QkFDM0IsTUFBTSxJQUFJLENBQUMscUJBQXFCLENBQUMsSUFBSSxFQUFFLG1CQUFtQixDQUFDLENBQUM7d0JBRTVELGNBQWMsSUFBSSxTQUFTLENBQUMsTUFBTSxDQUFDO3FCQUN0QztpQkFDSjtnQkFBQyxPQUFPLEtBQUssRUFBRTtvQkFDWixNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLElBQUksS0FBSyxLQUFLLEVBQUUsQ0FBQyxDQUFDO2lCQUN6QztnQkFFRCxJQUFJLGdCQUFnQixFQUFFO29CQUNsQixnQkFBZ0IsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztpQkFDekM7YUFDSjtZQUVELE9BQU87Z0JBQ0gsZUFBZSxFQUFFLEtBQUssQ0FBQyxNQUFNO2dCQUM3QixnQkFBZ0IsRUFBRSxjQUFjO2dCQUNoQyxNQUFNO2FBQ1QsQ0FBQztRQUNOLENBQUM7S0FBQTtDQUNKO0FBeFdELGtEQXdXQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva2l0ZWxldi9Eb2N1bWVudHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi9zcmMvYXBwbGljYXRpb24vc2VydmljZXMvUmVsYXRpb25PbnRvbG9naXplci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBURmlsZSwgQXBwLCBOb3RpY2UsIFRGb2xkZXIgfSBmcm9tICdvYnNpZGlhbic7XG5pbXBvcnQgeyBSZWxhdGlvbkFzc2V0LCBSZWxhdGlvbkFzc2V0SGVscGVyIH0gZnJvbSAnLi4vLi4vZG9tYWluL2VudGl0aWVzL1JlbGF0aW9uQXNzZXQnO1xuXG4vKipcbiAqIFNlcnZpY2UgZm9yIGNvbnZlcnRpbmcgYXNzZXQgcHJvcGVydGllcyB0byBSZWxhdGlvbiBpbnN0YW5jZXNcbiAqIFRoaXMgaW1wbGVtZW50cyB0aGUgb250b2xvZ2l6YXRpb24gb2YgcmVsYXRpb25zaGlwcyBjb25jZXB0XG4gKi9cbmV4cG9ydCBjbGFzcyBSZWxhdGlvbk9udG9sb2dpemVyIHtcbiAgICBwcml2YXRlIGFwcDogQXBwO1xuICAgIHByaXZhdGUgcmVsYXRpb25zRm9sZGVyOiBzdHJpbmcgPSAnOTkgUmVsYXRpb25zJzsgLy8gRm9sZGVyIGZvciByZWxhdGlvbiBhc3NldHNcbiAgICBcbiAgICBjb25zdHJ1Y3RvcihhcHA6IEFwcCkge1xuICAgICAgICB0aGlzLmFwcCA9IGFwcDtcbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogQ29udmVydCBmcm9udG1hdHRlciBvYmplY3QgcHJvcGVydGllcyB0byBSZWxhdGlvbiBhc3NldHNcbiAgICAgKi9cbiAgICBhc3luYyBvbnRvbG9naXplQXNzZXQoZmlsZTogVEZpbGUpOiBQcm9taXNlPFJlbGF0aW9uQXNzZXRbXT4ge1xuICAgICAgICBjb25zdCByZWxhdGlvbnM6IFJlbGF0aW9uQXNzZXRbXSA9IFtdO1xuICAgICAgICBjb25zdCBjYWNoZSA9IHRoaXMuYXBwLm1ldGFkYXRhQ2FjaGUuZ2V0RmlsZUNhY2hlKGZpbGUpO1xuICAgICAgICBcbiAgICAgICAgaWYgKCFjYWNoZT8uZnJvbnRtYXR0ZXIpIHtcbiAgICAgICAgICAgIHJldHVybiByZWxhdGlvbnM7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGZyb250bWF0dGVyID0gY2FjaGUuZnJvbnRtYXR0ZXI7XG4gICAgICAgIGNvbnN0IGFzc2V0VWlkID0gZnJvbnRtYXR0ZXJbJ2V4b19fQXNzZXRfdWlkJ10gfHwgZmlsZS5iYXNlbmFtZTtcbiAgICAgICAgXG4gICAgICAgIC8vIFByb2Nlc3MgZWFjaCBmcm9udG1hdHRlciBwcm9wZXJ0eVxuICAgICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhmcm9udG1hdHRlcikpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmlzT2JqZWN0UHJvcGVydHkoa2V5LCB2YWx1ZSkpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBwcm9wZXJ0eVJlbGF0aW9ucyA9IGF3YWl0IHRoaXMucHJvY2Vzc1Byb3BlcnR5KFxuICAgICAgICAgICAgICAgICAgICBhc3NldFVpZCxcbiAgICAgICAgICAgICAgICAgICAga2V5LFxuICAgICAgICAgICAgICAgICAgICB2YWx1ZSxcbiAgICAgICAgICAgICAgICAgICAgZmlsZVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgICAgcmVsYXRpb25zLnB1c2goLi4ucHJvcGVydHlSZWxhdGlvbnMpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gcmVsYXRpb25zO1xuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBDaGVjayBpZiBhIHByb3BlcnR5IHJlcHJlc2VudHMgYW4gb2JqZWN0IHJlbGF0aW9uc2hpcFxuICAgICAqL1xuICAgIHByaXZhdGUgaXNPYmplY3RQcm9wZXJ0eShrZXk6IHN0cmluZywgdmFsdWU/OiBhbnkpOiBib29sZWFuIHtcbiAgICAgICAgLy8gU2tpcCBtZXRhIHByb3BlcnRpZXNcbiAgICAgICAgY29uc3QgbWV0YVByb3BlcnRpZXMgPSBbXG4gICAgICAgICAgICAnZXhvX19Bc3NldF91aWQnLFxuICAgICAgICAgICAgJ2V4b19fQXNzZXRfY3JlYXRlZEF0JyxcbiAgICAgICAgICAgICdleG9fX0Fzc2V0X21vZGlmaWVkQXQnLFxuICAgICAgICAgICAgJ2V4b19fSW5zdGFuY2VfY2xhc3MnLFxuICAgICAgICAgICAgJ3RhZ3MnLFxuICAgICAgICAgICAgJ3RpdGxlJyxcbiAgICAgICAgICAgICdzdGF0dXMnLFxuICAgICAgICAgICAgJ2Rlc2NyaXB0aW9uJ1xuICAgICAgICBdO1xuICAgICAgICBcbiAgICAgICAgaWYgKG1ldGFQcm9wZXJ0aWVzLmluY2x1ZGVzKGtleSkpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8gT2JqZWN0IHByb3BlcnRpZXMgdHlwaWNhbGx5IGhhdmUgdGhlc2UgcGF0dGVybnNcbiAgICAgICAgY29uc3Qgb2JqZWN0UHJvcGVydHlQYXR0ZXJucyA9IFtcbiAgICAgICAgICAgIC9fcmVsYXRlcyQvLFxuICAgICAgICAgICAgL19wYXJlbnQkLyxcbiAgICAgICAgICAgIC9fY2hpbGRyZW4kLyxcbiAgICAgICAgICAgIC9fYXNzaWduZWRUbyQvLFxuICAgICAgICAgICAgL19wcm9qZWN0JC8sXG4gICAgICAgICAgICAvX2FyZWEkLyxcbiAgICAgICAgICAgIC9fcGFydE9mJC8sXG4gICAgICAgICAgICAvX2Jsb2NrcyQvLFxuICAgICAgICAgICAgL19kZXBlbmRzT24kLyxcbiAgICAgICAgICAgIC9fcmVsYXRlZFRvJC8sXG4gICAgICAgICAgICAvX2lzRGVmaW5lZEJ5JC8sXG4gICAgICAgICAgICAvX2hhc1BhcnQkLyxcbiAgICAgICAgICAgIC9faGFzVGFzayQvXG4gICAgICAgIF07XG4gICAgICAgIFxuICAgICAgICAvLyBDaGVjayBpZiBpdCBtYXRjaGVzIG9iamVjdCBwcm9wZXJ0eSBwYXR0ZXJuc1xuICAgICAgICBpZiAob2JqZWN0UHJvcGVydHlQYXR0ZXJucy5zb21lKHBhdHRlcm4gPT4gcGF0dGVybi50ZXN0KGtleSkpKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8gQ2hlY2sgaWYgdmFsdWUgY29udGFpbnMgd2lraSBsaW5rIHBhdHRlcm5cbiAgICAgICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgIT09IG51bGwpIHtcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlU3RyID0gQXJyYXkuaXNBcnJheSh2YWx1ZSkgPyB2YWx1ZVswXSA6IFN0cmluZyh2YWx1ZSk7XG4gICAgICAgICAgICBpZiAodmFsdWVTdHIgJiYgdHlwZW9mIHZhbHVlU3RyID09PSAnc3RyaW5nJyAmJiB2YWx1ZVN0ci5pbmNsdWRlcygnW1snKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIFByb2Nlc3MgYSBzaW5nbGUgcHJvcGVydHkgYW5kIGNyZWF0ZSByZWxhdGlvbnNcbiAgICAgKi9cbiAgICBwcml2YXRlIGFzeW5jIHByb2Nlc3NQcm9wZXJ0eShcbiAgICAgICAgc3ViamVjdFVpZDogc3RyaW5nLFxuICAgICAgICBwcmVkaWNhdGU6IHN0cmluZyxcbiAgICAgICAgdmFsdWU6IGFueSxcbiAgICAgICAgc291cmNlRmlsZTogVEZpbGVcbiAgICApOiBQcm9taXNlPFJlbGF0aW9uQXNzZXRbXT4ge1xuICAgICAgICBjb25zdCByZWxhdGlvbnM6IFJlbGF0aW9uQXNzZXRbXSA9IFtdO1xuICAgICAgICBcbiAgICAgICAgLy8gSGFuZGxlIGFycmF5IHZhbHVlc1xuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiB2YWx1ZSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlbGF0aW9uID0gdGhpcy5jcmVhdGVSZWxhdGlvbihcbiAgICAgICAgICAgICAgICAgICAgc3ViamVjdFVpZCxcbiAgICAgICAgICAgICAgICAgICAgcHJlZGljYXRlLFxuICAgICAgICAgICAgICAgICAgICBpdGVtLFxuICAgICAgICAgICAgICAgICAgICBzb3VyY2VGaWxlXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICBpZiAocmVsYXRpb24pIHtcbiAgICAgICAgICAgICAgICAgICAgcmVsYXRpb25zLnB1c2gocmVsYXRpb24pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbnN0IHJlbGF0aW9uID0gdGhpcy5jcmVhdGVSZWxhdGlvbihcbiAgICAgICAgICAgICAgICBzdWJqZWN0VWlkLFxuICAgICAgICAgICAgICAgIHByZWRpY2F0ZSxcbiAgICAgICAgICAgICAgICB2YWx1ZSxcbiAgICAgICAgICAgICAgICBzb3VyY2VGaWxlXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgaWYgKHJlbGF0aW9uKSB7XG4gICAgICAgICAgICAgICAgcmVsYXRpb25zLnB1c2gocmVsYXRpb24pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gcmVsYXRpb25zO1xuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBDcmVhdGUgYSBzaW5nbGUgcmVsYXRpb25cbiAgICAgKi9cbiAgICBwcml2YXRlIGNyZWF0ZVJlbGF0aW9uKFxuICAgICAgICBzdWJqZWN0OiBzdHJpbmcsXG4gICAgICAgIHByZWRpY2F0ZTogc3RyaW5nLFxuICAgICAgICBvYmplY3Q6IGFueSxcbiAgICAgICAgc291cmNlRmlsZTogVEZpbGVcbiAgICApOiBSZWxhdGlvbkFzc2V0IHwgbnVsbCB7XG4gICAgICAgIGlmICghb2JqZWN0KSByZXR1cm4gbnVsbDtcbiAgICAgICAgXG4gICAgICAgIC8vIEV4dHJhY3Qgb2JqZWN0IGlkZW50aWZpZXIgZnJvbSB3aWtpIGxpbmtcbiAgICAgICAgbGV0IG9iamVjdElkID0gU3RyaW5nKG9iamVjdCk7XG4gICAgICAgIGlmIChvYmplY3RJZC5pbmNsdWRlcygnW1snKSkge1xuICAgICAgICAgICAgb2JqZWN0SWQgPSBvYmplY3RJZC5yZXBsYWNlKC9cXFtcXFt8XFxdXFxdL2csICcnKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8gU2tpcCBlbXB0eSB2YWx1ZXNcbiAgICAgICAgaWYgKCFvYmplY3RJZCB8fCBvYmplY3RJZCA9PT0gJ251bGwnIHx8IG9iamVjdElkID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHJldHVybiBSZWxhdGlvbkFzc2V0SGVscGVyLmNyZWF0ZSh7XG4gICAgICAgICAgICBzdWJqZWN0LFxuICAgICAgICAgICAgcHJlZGljYXRlLFxuICAgICAgICAgICAgb2JqZWN0OiBvYmplY3RJZCxcbiAgICAgICAgICAgIHByb3ZlbmFuY2U6IGBvbnRvbG9naXplZCBmcm9tICR7c291cmNlRmlsZS5wYXRofWBcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIFxuICAgIC8qKlxuICAgICAqIENyZWF0ZSByZWxhdGlvbiBmaWxlcyBpbiB2YXVsdFxuICAgICAqL1xuICAgIGFzeW5jIGNyZWF0ZVJlbGF0aW9uRmlsZXMocmVsYXRpb25zOiBSZWxhdGlvbkFzc2V0W10pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgLy8gRW5zdXJlIHJlbGF0aW9ucyBmb2xkZXIgZXhpc3RzXG4gICAgICAgIGF3YWl0IHRoaXMuZW5zdXJlUmVsYXRpb25zRm9sZGVyKCk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBjcmVhdGVkOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICBjb25zdCBmYWlsZWQ6IHN0cmluZ1tdID0gW107XG4gICAgICAgIFxuICAgICAgICBmb3IgKGNvbnN0IHJlbGF0aW9uIG9mIHJlbGF0aW9ucykge1xuICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmNyZWF0ZVJlbGF0aW9uRmlsZShyZWxhdGlvbik7XG4gICAgICAgICAgICAgICAgY3JlYXRlZC5wdXNoKHJlbGF0aW9uLnVpZCk7XG4gICAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYEZhaWxlZCB0byBjcmVhdGUgcmVsYXRpb24gJHtyZWxhdGlvbi51aWR9OmAsIGVycm9yKTtcbiAgICAgICAgICAgICAgICBmYWlsZWQucHVzaChyZWxhdGlvbi51aWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICAvLyBTaG93IHN1bW1hcnkgbm90aWZpY2F0aW9uXG4gICAgICAgIGlmIChjcmVhdGVkLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIG5ldyBOb3RpY2UoYENyZWF0ZWQgJHtjcmVhdGVkLmxlbmd0aH0gcmVsYXRpb24gYXNzZXRzYCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGZhaWxlZC5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICBuZXcgTm90aWNlKGBGYWlsZWQgdG8gY3JlYXRlICR7ZmFpbGVkLmxlbmd0aH0gcmVsYXRpb25zYCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogQ3JlYXRlIGEgc2luZ2xlIHJlbGF0aW9uIGZpbGVcbiAgICAgKi9cbiAgICBwcml2YXRlIGFzeW5jIGNyZWF0ZVJlbGF0aW9uRmlsZShyZWxhdGlvbjogUmVsYXRpb25Bc3NldCk6IFByb21pc2U8VEZpbGU+IHtcbiAgICAgICAgY29uc3QgZmlsZW5hbWUgPSBSZWxhdGlvbkFzc2V0SGVscGVyLmdlbmVyYXRlRmlsZW5hbWUocmVsYXRpb24pO1xuICAgICAgICBjb25zdCBmaWxlcGF0aCA9IGAke3RoaXMucmVsYXRpb25zRm9sZGVyfS8ke2ZpbGVuYW1lfWA7XG4gICAgICAgIFxuICAgICAgICAvLyBHZW5lcmF0ZSBmcm9udG1hdHRlclxuICAgICAgICBjb25zdCBmcm9udG1hdHRlciA9IFJlbGF0aW9uQXNzZXRIZWxwZXIudG9Gcm9udG1hdHRlcihyZWxhdGlvbik7XG4gICAgICAgIGNvbnN0IGZyb250bWF0dGVyWWFtbCA9IHRoaXMuZ2VuZXJhdGVZYW1sKGZyb250bWF0dGVyKTtcbiAgICAgICAgXG4gICAgICAgIC8vIEdlbmVyYXRlIGNvbnRlbnRcbiAgICAgICAgY29uc3QgY29udGVudCA9IGAtLS1cbiR7ZnJvbnRtYXR0ZXJZYW1sfS0tLVxuXG4jIFJlbGF0aW9uOiAke3JlbGF0aW9uLnByZWRpY2F0ZX1cblxuKipTdWJqZWN0Kio6IFtbJHtyZWxhdGlvbi5zdWJqZWN0fV1dXG4qKlByZWRpY2F0ZSoqOiBcXGAke3JlbGF0aW9uLnByZWRpY2F0ZX1cXGBcbioqT2JqZWN0Kio6IFtbJHtyZWxhdGlvbi5vYmplY3R9XV1cblxuIyMgTWV0YWRhdGFcbi0gKipDcmVhdGVkKio6ICR7cmVsYXRpb24uY3JlYXRlZEF0LnRvSVNPU3RyaW5nKCl9XG4tICoqQ29uZmlkZW5jZSoqOiAke3JlbGF0aW9uLmNvbmZpZGVuY2UgfHwgMS4wfVxuLSAqKlByb3ZlbmFuY2UqKjogJHtyZWxhdGlvbi5wcm92ZW5hbmNlfVxuJHtyZWxhdGlvbi5pbnZlcnNlT2YgPyBgLSAqKkludmVyc2UqKjogW1ske3JlbGF0aW9uLmludmVyc2VPZn1dXWAgOiAnJ31cblxuIyMgRGVzY3JpcHRpb25cblRoaXMgcmVsYXRpb24gcmVwcmVzZW50cyB0aGUgY29ubmVjdGlvbiBiZXR3ZWVuIGFzc2V0cyB1c2luZyB0aGUgcHJlZGljYXRlIFxcYCR7cmVsYXRpb24ucHJlZGljYXRlfVxcYC5cblxuLS0tXG4qVGhpcyBmaWxlIHdhcyBhdXRvbWF0aWNhbGx5IGdlbmVyYXRlZCBieSBSZWxhdGlvbk9udG9sb2dpemVyKmA7XG4gICAgICAgIFxuICAgICAgICAvLyBDcmVhdGUgdGhlIGZpbGVcbiAgICAgICAgY29uc3QgZmlsZSA9IGF3YWl0IHRoaXMuYXBwLnZhdWx0LmNyZWF0ZShmaWxlcGF0aCwgY29udGVudCk7XG4gICAgICAgIHJldHVybiBmaWxlO1xuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBFbnN1cmUgcmVsYXRpb25zIGZvbGRlciBleGlzdHNcbiAgICAgKi9cbiAgICBwcml2YXRlIGFzeW5jIGVuc3VyZVJlbGF0aW9uc0ZvbGRlcigpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgY29uc3QgZm9sZGVyID0gdGhpcy5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKHRoaXMucmVsYXRpb25zRm9sZGVyKTtcbiAgICAgICAgaWYgKCFmb2xkZXIpIHtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuYXBwLnZhdWx0LmNyZWF0ZUZvbGRlcih0aGlzLnJlbGF0aW9uc0ZvbGRlcik7XG4gICAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogR2VuZXJhdGUgWUFNTCBmcm9tIG9iamVjdFxuICAgICAqL1xuICAgIHByaXZhdGUgZ2VuZXJhdGVZYW1sKG9iajogUmVjb3JkPHN0cmluZywgYW55Pik6IHN0cmluZyB7XG4gICAgICAgIGNvbnN0IGxpbmVzOiBzdHJpbmdbXSA9IFtdO1xuICAgICAgICBcbiAgICAgICAgZm9yIChjb25zdCBba2V5LCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMob2JqKSkge1xuICAgICAgICAgICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQgfHwgdmFsdWUgPT09IG51bGwpIGNvbnRpbnVlO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgICAgICAgICAgICBsaW5lcy5wdXNoKGAke2tleX06YCk7XG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHZhbHVlKSB7XG4gICAgICAgICAgICAgICAgICAgIGxpbmVzLnB1c2goYCAgLSAke0pTT04uc3RyaW5naWZ5KGl0ZW0pfWApO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAnb2JqZWN0Jykge1xuICAgICAgICAgICAgICAgIGxpbmVzLnB1c2goYCR7a2V5fTogJHtKU09OLnN0cmluZ2lmeSh2YWx1ZSl9YCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGxpbmVzLnB1c2goYCR7a2V5fTogJHtKU09OLnN0cmluZ2lmeSh2YWx1ZSl9YCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHJldHVybiBsaW5lcy5qb2luKCdcXG4nKSArICdcXG4nO1xuICAgIH1cbiAgICBcbiAgICAvKipcbiAgICAgKiBDbGVhbiBvcmlnaW5hbCBhc3NldCBieSByZW1vdmluZyBjb252ZXJ0ZWQgcHJvcGVydGllc1xuICAgICAqL1xuICAgIGFzeW5jIGNsZWFuQXNzZXRGcm9udG1hdHRlcihmaWxlOiBURmlsZSwgcHJvcGVydGllc1RvUmVtb3ZlOiBzdHJpbmdbXSk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zdCBjb250ZW50ID0gYXdhaXQgdGhpcy5hcHAudmF1bHQucmVhZChmaWxlKTtcbiAgICAgICAgY29uc3QgY2FjaGUgPSB0aGlzLmFwcC5tZXRhZGF0YUNhY2hlLmdldEZpbGVDYWNoZShmaWxlKTtcbiAgICAgICAgXG4gICAgICAgIGlmICghY2FjaGU/LmZyb250bWF0dGVyKSByZXR1cm47XG4gICAgICAgIFxuICAgICAgICAvLyBQYXJzZSBmcm9udG1hdHRlclxuICAgICAgICBjb25zdCBmcm9udG1hdHRlck1hdGNoID0gY29udGVudC5tYXRjaCgvXi0tLVxcbihbXFxzXFxTXSo/KVxcbi0tLS8pO1xuICAgICAgICBpZiAoIWZyb250bWF0dGVyTWF0Y2gpIHJldHVybjtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGZyb250bWF0dGVyVGV4dCA9IGZyb250bWF0dGVyTWF0Y2hbMV07XG4gICAgICAgIGNvbnN0IGxpbmVzID0gZnJvbnRtYXR0ZXJUZXh0LnNwbGl0KCdcXG4nKTtcbiAgICAgICAgY29uc3QgbmV3TGluZXM6IHN0cmluZ1tdID0gW107XG4gICAgICAgIFxuICAgICAgICBsZXQgc2tpcFByb3BlcnR5ID0gZmFsc2U7XG4gICAgICAgIGZvciAoY29uc3QgbGluZSBvZiBsaW5lcykge1xuICAgICAgICAgICAgLy8gQ2hlY2sgaWYgdGhpcyBsaW5lIHN0YXJ0cyBhIHByb3BlcnR5IHRvIHJlbW92ZVxuICAgICAgICAgICAgY29uc3QgaXNQcm9wZXJ0eUxpbmUgPSBwcm9wZXJ0aWVzVG9SZW1vdmUuc29tZShwcm9wID0+IFxuICAgICAgICAgICAgICAgIGxpbmUuc3RhcnRzV2l0aChgJHtwcm9wfTpgKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKGlzUHJvcGVydHlMaW5lKSB7XG4gICAgICAgICAgICAgICAgc2tpcFByb3BlcnR5ID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gU2tpcCBhcnJheSBpdGVtcyBvZiByZW1vdmVkIHByb3BlcnRpZXNcbiAgICAgICAgICAgIGlmIChza2lwUHJvcGVydHkgJiYgKGxpbmUuc3RhcnRzV2l0aCgnICAtICcpIHx8IGxpbmUuc3RhcnRzV2l0aCgnICAgICcpKSkge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBza2lwUHJvcGVydHkgPSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgbmV3TGluZXMucHVzaChsaW5lKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8gUmVjb25zdHJ1Y3QgY29udGVudFxuICAgICAgICBjb25zdCBuZXdGcm9udG1hdHRlciA9IG5ld0xpbmVzLmpvaW4oJ1xcbicpO1xuICAgICAgICBjb25zdCBuZXdDb250ZW50ID0gY29udGVudC5yZXBsYWNlKFxuICAgICAgICAgICAgZnJvbnRtYXR0ZXJNYXRjaFswXSxcbiAgICAgICAgICAgIGAtLS1cXG4ke25ld0Zyb250bWF0dGVyfVxcbi0tLWBcbiAgICAgICAgKTtcbiAgICAgICAgXG4gICAgICAgIGF3YWl0IHRoaXMuYXBwLnZhdWx0Lm1vZGlmeShmaWxlLCBuZXdDb250ZW50KTtcbiAgICB9XG4gICAgXG4gICAgLyoqXG4gICAgICogTWlncmF0ZSBlbnRpcmUgdmF1bHQgdG8gcmVsYXRpb24tYmFzZWQgbW9kZWxcbiAgICAgKi9cbiAgICBhc3luYyBtaWdyYXRlVmF1bHQocHJvZ3Jlc3NDYWxsYmFjaz86IChjdXJyZW50OiBudW1iZXIsIHRvdGFsOiBudW1iZXIpID0+IHZvaWQpOiBQcm9taXNlPHtcbiAgICAgICAgYXNzZXRzUHJvY2Vzc2VkOiBudW1iZXI7XG4gICAgICAgIHJlbGF0aW9uc0NyZWF0ZWQ6IG51bWJlcjtcbiAgICAgICAgZXJyb3JzOiBzdHJpbmdbXTtcbiAgICB9PiB7XG4gICAgICAgIGNvbnN0IGZpbGVzID0gdGhpcy5hcHAudmF1bHQuZ2V0TWFya2Rvd25GaWxlcygpO1xuICAgICAgICBjb25zdCBlcnJvcnM6IHN0cmluZ1tdID0gW107XG4gICAgICAgIGxldCB0b3RhbFJlbGF0aW9ucyA9IDA7XG4gICAgICAgIFxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGZpbGVzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBjb25zdCBmaWxlID0gZmlsZXNbaV07XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIFNraXAgcmVsYXRpb24gZmlsZXMgdGhlbXNlbHZlc1xuICAgICAgICAgICAgaWYgKGZpbGUucGF0aC5zdGFydHNXaXRoKHRoaXMucmVsYXRpb25zRm9sZGVyKSkge1xuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJlbGF0aW9ucyA9IGF3YWl0IHRoaXMub250b2xvZ2l6ZUFzc2V0KGZpbGUpO1xuICAgICAgICAgICAgICAgIGlmIChyZWxhdGlvbnMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmNyZWF0ZVJlbGF0aW9uRmlsZXMocmVsYXRpb25zKTtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIEdldCBwcm9wZXJ0aWVzIHRoYXQgd2VyZSBjb252ZXJ0ZWRcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29udmVydGVkUHJvcGVydGllcyA9IFsuLi5uZXcgU2V0KFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVsYXRpb25zLm1hcChyID0+IHIucHJlZGljYXRlKVxuICAgICAgICAgICAgICAgICAgICApXTtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIC8vIENsZWFuIHRoZSBvcmlnaW5hbCBhc3NldFxuICAgICAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmNsZWFuQXNzZXRGcm9udG1hdHRlcihmaWxlLCBjb252ZXJ0ZWRQcm9wZXJ0aWVzKTtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIHRvdGFsUmVsYXRpb25zICs9IHJlbGF0aW9ucy5sZW5ndGg7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICBlcnJvcnMucHVzaChgJHtmaWxlLnBhdGh9OiAke2Vycm9yfWApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICBpZiAocHJvZ3Jlc3NDYWxsYmFjaykge1xuICAgICAgICAgICAgICAgIHByb2dyZXNzQ2FsbGJhY2soaSArIDEsIGZpbGVzLmxlbmd0aCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBhc3NldHNQcm9jZXNzZWQ6IGZpbGVzLmxlbmd0aCxcbiAgICAgICAgICAgIHJlbGF0aW9uc0NyZWF0ZWQ6IHRvdGFsUmVsYXRpb25zLFxuICAgICAgICAgICAgZXJyb3JzXG4gICAgICAgIH07XG4gICAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==