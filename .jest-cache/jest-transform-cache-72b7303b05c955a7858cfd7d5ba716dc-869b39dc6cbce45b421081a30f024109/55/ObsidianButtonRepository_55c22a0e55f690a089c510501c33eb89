8017e3f827c5ba198a5f10ed5f084380
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ObsidianButtonRepository = void 0;
const tslib_1 = require("tslib");
const obsidian_1 = require("obsidian");
const UIButton_1 = require("../../domain/entities/UIButton");
const ButtonCommand_1 = require("../../domain/entities/ButtonCommand");
const AssetId_1 = require("../../domain/value-objects/AssetId");
const Result_1 = require("../../domain/core/Result");
/**
 * Obsidian implementation of Button repository
 */
class ObsidianButtonRepository {
    constructor(app) {
        this.app = app;
    }
    findButtonById(id) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const file = this.app.vault.getAbstractFileByPath(id.toString() + '.md');
                if (!file || !(file instanceof obsidian_1.TFile)) {
                    return Result_1.Result.ok(null);
                }
                return this.buildButtonFromFile(file);
            }
            catch (error) {
                return Result_1.Result.fail(`Failed to find button: ${error.message}`);
            }
        });
    }
    findCommandById(id) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const file = this.app.vault.getAbstractFileByPath(id.toString() + '.md');
                if (!file || !(file instanceof obsidian_1.TFile)) {
                    return Result_1.Result.ok(null);
                }
                return this.buildCommandFromFile(file);
            }
            catch (error) {
                return Result_1.Result.fail(`Failed to find command: ${error.message}`);
            }
        });
    }
    findAllButtons() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const buttons = [];
                const files = this.app.vault.getMarkdownFiles();
                for (const file of files) {
                    const metadata = this.app.metadataCache.getFileCache(file);
                    if (!(metadata === null || metadata === void 0 ? void 0 : metadata.frontmatter))
                        continue;
                    const instanceClass = metadata.frontmatter['exo__Instance_class'];
                    if (instanceClass !== '[[ui__Button]]')
                        continue;
                    const buttonResult = yield this.buildButtonFromFile(file);
                    if (buttonResult.isSuccess && buttonResult.getValue()) {
                        buttons.push(buttonResult.getValue());
                    }
                }
                return Result_1.Result.ok(buttons);
            }
            catch (error) {
                return Result_1.Result.fail(`Failed to find buttons: ${error.message}`);
            }
        });
    }
    findAllCommands() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const commands = [];
                const files = this.app.vault.getMarkdownFiles();
                for (const file of files) {
                    const metadata = this.app.metadataCache.getFileCache(file);
                    if (!(metadata === null || metadata === void 0 ? void 0 : metadata.frontmatter))
                        continue;
                    const instanceClass = metadata.frontmatter['exo__Instance_class'];
                    if (instanceClass !== '[[ui__ButtonCommand]]')
                        continue;
                    const commandResult = yield this.buildCommandFromFile(file);
                    if (commandResult.isSuccess && commandResult.getValue()) {
                        commands.push(commandResult.getValue());
                    }
                }
                return Result_1.Result.ok(commands);
            }
            catch (error) {
                return Result_1.Result.fail(`Failed to find commands: ${error.message}`);
            }
        });
    }
    findButtonsByCommandId(commandId) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const buttons = [];
                const allButtonsResult = yield this.findAllButtons();
                if (allButtonsResult.isFailure) {
                    return Result_1.Result.fail(allButtonsResult.error);
                }
                const allButtons = allButtonsResult.getValue();
                for (const button of allButtons) {
                    if (button.commandId.equals(commandId)) {
                        buttons.push(button);
                    }
                }
                return Result_1.Result.ok(buttons);
            }
            catch (error) {
                return Result_1.Result.fail(`Failed to find buttons by command: ${error.message}`);
            }
        });
    }
    saveButton(button) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const filePath = `${button.id.toString()}.md`;
                const content = this.serializeButton(button);
                const existingFile = this.app.vault.getAbstractFileByPath(filePath);
                if (existingFile instanceof obsidian_1.TFile) {
                    yield this.app.vault.modify(existingFile, content);
                }
                else {
                    yield this.app.vault.create(filePath, content);
                }
                return Result_1.Result.ok();
            }
            catch (error) {
                return Result_1.Result.fail(`Failed to save button: ${error.message}`);
            }
        });
    }
    saveCommand(command) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const filePath = `${command.id.toString()}.md`;
                const content = this.serializeCommand(command);
                const existingFile = this.app.vault.getAbstractFileByPath(filePath);
                if (existingFile instanceof obsidian_1.TFile) {
                    yield this.app.vault.modify(existingFile, content);
                }
                else {
                    yield this.app.vault.create(filePath, content);
                }
                return Result_1.Result.ok();
            }
            catch (error) {
                return Result_1.Result.fail(`Failed to save command: ${error.message}`);
            }
        });
    }
    deleteButton(id) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const file = this.app.vault.getAbstractFileByPath(id.toString() + '.md');
                if (file instanceof obsidian_1.TFile) {
                    yield this.app.vault.delete(file);
                }
                return Result_1.Result.ok();
            }
            catch (error) {
                return Result_1.Result.fail(`Failed to delete button: ${error.message}`);
            }
        });
    }
    deleteCommand(id) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const file = this.app.vault.getAbstractFileByPath(id.toString() + '.md');
                if (file instanceof obsidian_1.TFile) {
                    yield this.app.vault.delete(file);
                }
                return Result_1.Result.ok();
            }
            catch (error) {
                return Result_1.Result.fail(`Failed to delete command: ${error.message}`);
            }
        });
    }
    buildButtonFromFile(file) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const metadata = this.app.metadataCache.getFileCache(file);
                if (!(metadata === null || metadata === void 0 ? void 0 : metadata.frontmatter)) {
                    return Result_1.Result.ok(null);
                }
                const fm = metadata.frontmatter;
                const idResult = AssetId_1.AssetId.create(file.basename);
                const commandIdResult = AssetId_1.AssetId.create(this.cleanAssetReference(fm['ui__Button_command'] || ''));
                if (idResult.isFailure || commandIdResult.isFailure) {
                    return Result_1.Result.ok(null);
                }
                const buttonResult = UIButton_1.UIButton.create({
                    id: idResult.getValue(),
                    label: fm['ui__Button_label'] || file.basename,
                    commandId: commandIdResult.getValue(),
                    order: fm['ui__Button_order'] || 0,
                    isEnabled: fm['ui__Button_enabled'] !== false,
                    tooltip: fm['ui__Button_tooltip']
                });
                if (buttonResult.isFailure) {
                    return Result_1.Result.fail(buttonResult.error);
                }
                return Result_1.Result.ok(buttonResult.getValue());
            }
            catch (error) {
                return Result_1.Result.fail(`Failed to build button: ${error.message}`);
            }
        });
    }
    buildCommandFromFile(file) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const metadata = this.app.metadataCache.getFileCache(file);
                if (!(metadata === null || metadata === void 0 ? void 0 : metadata.frontmatter)) {
                    return Result_1.Result.ok(null);
                }
                const fm = metadata.frontmatter;
                const idResult = AssetId_1.AssetId.create(file.basename);
                if (idResult.isFailure) {
                    return Result_1.Result.ok(null);
                }
                // Parse command type
                const typeString = fm['ui__Command_type'] || 'CUSTOM';
                const type = this.parseCommandType(typeString);
                // Parse parameters
                const parameters = this.parseParameters(fm['ui__Command_parameters']);
                const commandResult = ButtonCommand_1.ButtonCommand.create({
                    id: idResult.getValue(),
                    type: type,
                    name: fm['ui__Command_name'] || file.basename,
                    description: fm['ui__Command_description'],
                    requiresInput: fm['ui__Command_requiresInput'] === true,
                    parameters: parameters,
                    targetClass: this.cleanAssetReference(fm['ui__Command_targetClass']),
                    template: fm['ui__Command_template'],
                    script: fm['ui__Command_script']
                });
                if (commandResult.isFailure) {
                    return Result_1.Result.fail(commandResult.error);
                }
                return Result_1.Result.ok(commandResult.getValue());
            }
            catch (error) {
                return Result_1.Result.fail(`Failed to build command: ${error.message}`);
            }
        });
    }
    parseCommandType(typeString) {
        const upperType = typeString.toUpperCase();
        return ButtonCommand_1.CommandType[upperType] || ButtonCommand_1.CommandType.CUSTOM;
    }
    parseParameters(paramsData) {
        if (!paramsData)
            return [];
        const params = [];
        const paramArray = this.ensureArray(paramsData);
        for (const param of paramArray) {
            if (typeof param === 'object' && param.name) {
                params.push({
                    name: param.name,
                    type: param.type || 'string',
                    required: param.required === true,
                    defaultValue: param.defaultValue,
                    label: param.label,
                    description: param.description,
                    validation: param.validation
                });
            }
        }
        return params;
    }
    serializeButton(button) {
        const frontmatter = {
            'exo__Instance_class': '[[ui__Button]]',
            'ui__Button_label': button.label,
            'ui__Button_command': `[[${button.commandId.toString()}]]`,
            'ui__Button_order': button.order,
            'ui__Button_enabled': button.isEnabled,
            'ui__Button_tooltip': button.tooltip
        };
        const yamlContent = this.toYaml(frontmatter);
        return `---\n${yamlContent}---\n\n# Button: ${button.label}\n`;
    }
    serializeCommand(command) {
        const frontmatter = {
            'exo__Instance_class': '[[ui__ButtonCommand]]',
            'ui__Command_type': command.type,
            'ui__Command_name': command.name,
            'ui__Command_description': command.description,
            'ui__Command_requiresInput': command.requiresInput,
            'ui__Command_parameters': command.parameters,
            'ui__Command_targetClass': command.targetClass ? `[[${command.targetClass}]]` : null,
            'ui__Command_template': command.template,
            'ui__Command_script': command.script
        };
        const yamlContent = this.toYaml(frontmatter);
        return `---\n${yamlContent}---\n\n# Command: ${command.name}\n`;
    }
    cleanAssetReference(ref) {
        if (typeof ref !== 'string')
            return '';
        return ref.replace(/\[\[|\]\]/g, '').trim();
    }
    ensureArray(value) {
        if (Array.isArray(value))
            return value;
        if (value)
            return [value];
        return [];
    }
    toYaml(obj) {
        // Simple YAML serialization
        return Object.entries(obj)
            .filter(([_, value]) => value !== null && value !== undefined)
            .map(([key, value]) => {
            if (Array.isArray(value)) {
                if (value.length === 0)
                    return `${key}: []`;
                return `${key}:\n${value.map(v => `  - ${JSON.stringify(v)}`).join('\n')}`;
            }
            if (typeof value === 'object') {
                return `${key}: ${JSON.stringify(value)}`;
            }
            return `${key}: ${value}`;
        })
            .join('\n') + '\n';
    }
}
exports.ObsidianButtonRepository = ObsidianButtonRepository;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2luZnJhc3RydWN0dXJlL3JlcG9zaXRvcmllcy9PYnNpZGlhbkJ1dHRvblJlcG9zaXRvcnkudHMiLCJtYXBwaW5ncyI6Ijs7OztBQUFBLHVDQUFzQztBQUV0Qyw2REFBMEQ7QUFDMUQsdUVBQW1HO0FBQ25HLGdFQUE2RDtBQUM3RCxxREFBa0Q7QUFFbEQ7O0dBRUc7QUFDSCxNQUFhLHdCQUF3QjtJQUNqQyxZQUFvQixHQUFRO1FBQVIsUUFBRyxHQUFILEdBQUcsQ0FBSztJQUFHLENBQUM7SUFFMUIsY0FBYyxDQUFDLEVBQVc7O1lBQzVCLElBQUk7Z0JBQ0EsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxHQUFHLEtBQUssQ0FBQyxDQUFDO2dCQUN6RSxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxJQUFJLFlBQVksZ0JBQUssQ0FBQyxFQUFFO29CQUNuQyxPQUFPLGVBQU0sQ0FBQyxFQUFFLENBQWtCLElBQUksQ0FBQyxDQUFDO2lCQUMzQztnQkFFRCxPQUFPLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUN6QztZQUFDLE9BQU8sS0FBSyxFQUFFO2dCQUNaLE9BQU8sZUFBTSxDQUFDLElBQUksQ0FBa0IsMEJBQTBCLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDO2FBQ2xGO1FBQ0wsQ0FBQztLQUFBO0lBRUssZUFBZSxDQUFDLEVBQVc7O1lBQzdCLElBQUk7Z0JBQ0EsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxHQUFHLEtBQUssQ0FBQyxDQUFDO2dCQUN6RSxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxJQUFJLFlBQVksZ0JBQUssQ0FBQyxFQUFFO29C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QUMsS0FBSyxDQUFDLEVBQUU7Z0JBQ3RCLElBQUksS0FBSyxDQUFDLE1BQU0sS0FBSyxDQUFDO29CQUFFLE9BQU8sR0FBRyxHQUFHLE1BQU0sQ0FBQztnQkFDNUMsT0FBTyxHQUFHLEdBQUcsTUFBTSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQzthQUM5RTtZQUNELElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxFQUFFO2dCQUMzQixPQUFPLEdBQUcsR0FBRyxLQUFLLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQzthQUM3QztZQUNELE9BQU8sR0FBRyxHQUFHLEtBQUssS0FBSyxFQUFFLENBQUM7UUFDOUIsQ0FBQyxDQUFDO2FBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQztJQUMzQixDQUFDO0NBQ0o7QUFyVUQsNERBcVVDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9raXRlbGV2L0RvY3VtZW50cy9leG9jb3J0ZXgtb2JzaWRpYW4tcGx1Z2luL3NyYy9pbmZyYXN0cnVjdHVyZS9yZXBvc2l0b3JpZXMvT2JzaWRpYW5CdXR0b25SZXBvc2l0b3J5LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFwcCwgVEZpbGUgfSBmcm9tICdvYnNpZGlhbic7XG5pbXBvcnQgeyBJQnV0dG9uUmVwb3NpdG9yeSB9IGZyb20gJy4uLy4uL2RvbWFpbi9yZXBvc2l0b3JpZXMvSUJ1dHRvblJlcG9zaXRvcnknO1xuaW1wb3J0IHsgVUlCdXR0b24gfSBmcm9tICcuLi8uLi9kb21haW4vZW50aXRpZXMvVUlCdXR0b24nO1xuaW1wb3J0IHsgQnV0dG9uQ29tbWFuZCwgQ29tbWFuZFR5cGUsIENvbW1hbmRQYXJhbWV0ZXIgfSBmcm9tICcuLi8uLi9kb21haW4vZW50aXRpZXMvQnV0dG9uQ29tbWFuZCc7XG5pbXBvcnQgeyBBc3NldElkIH0gZnJvbSAnLi4vLi4vZG9tYWluL3ZhbHVlLW9iamVjdHMvQXNzZXRJZCc7XG5pbXBvcnQgeyBSZXN1bHQgfSBmcm9tICcuLi8uLi9kb21haW4vY29yZS9SZXN1bHQnO1xuXG4vKipcbiAqIE9ic2lkaWFuIGltcGxlbWVudGF0aW9uIG9mIEJ1dHRvbiByZXBvc2l0b3J5XG4gKi9cbmV4cG9ydCBjbGFzcyBPYnNpZGlhbkJ1dHRvblJlcG9zaXRvcnkgaW1wbGVtZW50cyBJQnV0dG9uUmVwb3NpdG9yeSB7XG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBhcHA6IEFwcCkge31cblxuICAgIGFzeW5jIGZpbmRCdXR0b25CeUlkKGlkOiBBc3NldElkKTogUHJvbWlzZTxSZXN1bHQ8VUlCdXR0b24gfCBudWxsPj4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgZmlsZSA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChpZC50b1N0cmluZygpICsgJy5tZCcpO1xuICAgICAgICAgICAgaWYgKCFmaWxlIHx8ICEoZmlsZSBpbnN0YW5jZW9mIFRGaWxlKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBSZXN1bHQub2s8VUlCdXR0b24gfCBudWxsPihudWxsKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYnVpbGRCdXR0b25Gcm9tRmlsZShmaWxlKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxVSUJ1dHRvbiB8IG51bGw+KGBGYWlsZWQgdG8gZmluZCBidXR0b246ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIGZpbmRDb21tYW5kQnlJZChpZDogQXNzZXRJZCk6IFByb21pc2U8UmVzdWx0PEJ1dHRvbkNvbW1hbmQgfCBudWxsPj4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgZmlsZSA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChpZC50b1N0cmluZygpICsgJy5tZCcpO1xuICAgICAgICAgICAgaWYgKCFmaWxlIHx8ICEoZmlsZSBpbnN0YW5jZW9mIFRGaWxlKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBSZXN1bHQub2s8QnV0dG9uQ29tbWFuZCB8IG51bGw+KG51bGwpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5idWlsZENvbW1hbmRGcm9tRmlsZShmaWxlKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxCdXR0b25Db21tYW5kIHwgbnVsbD4oYEZhaWxlZCB0byBmaW5kIGNvbW1hbmQ6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIGZpbmRBbGxCdXR0b25zKCk6IFByb21pc2U8UmVzdWx0PFVJQnV0dG9uW10+PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBidXR0b25zOiBVSUJ1dHRvbltdID0gW107XG4gICAgICAgICAgICBjb25zdCBmaWxlcyA9IHRoaXMuYXBwLnZhdWx0LmdldE1hcmtkb3duRmlsZXMoKTtcblxuICAgICAgICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLmFwcC5tZXRhZGF0YUNhY2hlLmdldEZpbGVDYWNoZShmaWxlKTtcbiAgICAgICAgICAgICAgICBpZiAoIW1ldGFkYXRhPy5mcm9udG1hdHRlcikgY29udGludWU7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBpbnN0YW5jZUNsYXNzID0gbWV0YWRhdGEuZnJvbnRtYXR0ZXJbJ2V4b19fSW5zdGFuY2VfY2xhc3MnXTtcbiAgICAgICAgICAgICAgICBpZiAoaW5zdGFuY2VDbGFzcyAhPT0gJ1tbdWlfX0J1dHRvbl1dJykgY29udGludWU7XG5cbiAgICAgICAgICAgICAgICBjb25zdCBidXR0b25SZXN1bHQgPSBhd2FpdCB0aGlzLmJ1aWxkQnV0dG9uRnJvbUZpbGUoZmlsZSk7XG4gICAgICAgICAgICAgICAgaWYgKGJ1dHRvblJlc3VsdC5pc1N1Y2Nlc3MgJiYgYnV0dG9uUmVzdWx0LmdldFZhbHVlKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgYnV0dG9ucy5wdXNoKGJ1dHRvblJlc3VsdC5nZXRWYWx1ZSgpISk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0Lm9rPFVJQnV0dG9uW10+KGJ1dHRvbnMpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPFVJQnV0dG9uW10+KGBGYWlsZWQgdG8gZmluZCBidXR0b25zOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBmaW5kQWxsQ29tbWFuZHMoKTogUHJvbWlzZTxSZXN1bHQ8QnV0dG9uQ29tbWFuZFtdPj4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgY29tbWFuZHM6IEJ1dHRvbkNvbW1hbmRbXSA9IFtdO1xuICAgICAgICAgICAgY29uc3QgZmlsZXMgPSB0aGlzLmFwcC52YXVsdC5nZXRNYXJrZG93bkZpbGVzKCk7XG5cbiAgICAgICAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykge1xuICAgICAgICAgICAgICAgIGNvbnN0IG1ldGFkYXRhID0gdGhpcy5hcHAubWV0YWRhdGFDYWNoZS5nZXRGaWxlQ2FjaGUoZmlsZSk7XG4gICAgICAgICAgICAgICAgaWYgKCFtZXRhZGF0YT8uZnJvbnRtYXR0ZXIpIGNvbnRpbnVlO1xuXG4gICAgICAgICAgICAgICAgY29uc3QgaW5zdGFuY2VDbGFzcyA9IG1ldGFkYXRhLmZyb250bWF0dGVyWydleG9fX0luc3RhbmNlX2NsYXNzJ107XG4gICAgICAgICAgICAgICAgaWYgKGluc3RhbmNlQ2xhc3MgIT09ICdbW3VpX19CdXR0b25Db21tYW5kXV0nKSBjb250aW51ZTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbW1hbmRSZXN1bHQgPSBhd2FpdCB0aGlzLmJ1aWxkQ29tbWFuZEZyb21GaWxlKGZpbGUpO1xuICAgICAgICAgICAgICAgIGlmIChjb21tYW5kUmVzdWx0LmlzU3VjY2VzcyAmJiBjb21tYW5kUmVzdWx0LmdldFZhbHVlKCkpIHtcbiAgICAgICAgICAgICAgICAgICAgY29tbWFuZHMucHVzaChjb21tYW5kUmVzdWx0LmdldFZhbHVlKCkhKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQub2s8QnV0dG9uQ29tbWFuZFtdPihjb21tYW5kcyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8QnV0dG9uQ29tbWFuZFtdPihgRmFpbGVkIHRvIGZpbmQgY29tbWFuZHM6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGFzeW5jIGZpbmRCdXR0b25zQnlDb21tYW5kSWQoY29tbWFuZElkOiBBc3NldElkKTogUHJvbWlzZTxSZXN1bHQ8VUlCdXR0b25bXT4+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGJ1dHRvbnM6IFVJQnV0dG9uW10gPSBbXTtcbiAgICAgICAgICAgIGNvbnN0IGFsbEJ1dHRvbnNSZXN1bHQgPSBhd2FpdCB0aGlzLmZpbmRBbGxCdXR0b25zKCk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChhbGxCdXR0b25zUmVzdWx0LmlzRmFpbHVyZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxVSUJ1dHRvbltdPihhbGxCdXR0b25zUmVzdWx0LmVycm9yKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgYWxsQnV0dG9ucyA9IGFsbEJ1dHRvbnNSZXN1bHQuZ2V0VmFsdWUoKTtcbiAgICAgICAgICAgIGZvciAoY29uc3QgYnV0dG9uIG9mIGFsbEJ1dHRvbnMpIHtcbiAgICAgICAgICAgICAgICBpZiAoYnV0dG9uLmNvbW1hbmRJZC5lcXVhbHMoY29tbWFuZElkKSkge1xuICAgICAgICAgICAgICAgICAgICBidXR0b25zLnB1c2goYnV0dG9uKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQub2s8VUlCdXR0b25bXT4oYnV0dG9ucyk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8VUlCdXR0b25bXT4oYEZhaWxlZCB0byBmaW5kIGJ1dHRvbnMgYnkgY29tbWFuZDogJHtlcnJvci5tZXNzYWdlfWApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgc2F2ZUJ1dHRvbihidXR0b246IFVJQnV0dG9uKTogUHJvbWlzZTxSZXN1bHQ8dm9pZD4+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGZpbGVQYXRoID0gYCR7YnV0dG9uLmlkLnRvU3RyaW5nKCl9Lm1kYDtcbiAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSB0aGlzLnNlcmlhbGl6ZUJ1dHRvbihidXR0b24pO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCBleGlzdGluZ0ZpbGUgPSB0aGlzLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoZmlsZVBhdGgpO1xuICAgICAgICAgICAgaWYgKGV4aXN0aW5nRmlsZSBpbnN0YW5jZW9mIFRGaWxlKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5hcHAudmF1bHQubW9kaWZ5KGV4aXN0aW5nRmlsZSwgY29udGVudCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuYXBwLnZhdWx0LmNyZWF0ZShmaWxlUGF0aCwgY29udGVudCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQub2s8dm9pZD4oKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDx2b2lkPihgRmFpbGVkIHRvIHNhdmUgYnV0dG9uOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBzYXZlQ29tbWFuZChjb21tYW5kOiBCdXR0b25Db21tYW5kKTogUHJvbWlzZTxSZXN1bHQ8dm9pZD4+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGZpbGVQYXRoID0gYCR7Y29tbWFuZC5pZC50b1N0cmluZygpfS5tZGA7XG4gICAgICAgICAgICBjb25zdCBjb250ZW50ID0gdGhpcy5zZXJpYWxpemVDb21tYW5kKGNvbW1hbmQpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCBleGlzdGluZ0ZpbGUgPSB0aGlzLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoZmlsZVBhdGgpO1xuICAgICAgICAgICAgaWYgKGV4aXN0aW5nRmlsZSBpbnN0YW5jZW9mIFRGaWxlKSB7XG4gICAgICAgICAgICAgICAgYXdhaXQgdGhpcy5hcHAudmF1bHQubW9kaWZ5KGV4aXN0aW5nRmlsZSwgY29udGVudCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGF3YWl0IHRoaXMuYXBwLnZhdWx0LmNyZWF0ZShmaWxlUGF0aCwgY29udGVudCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQub2s8dm9pZD4oKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDx2b2lkPihgRmFpbGVkIHRvIHNhdmUgY29tbWFuZDogJHtlcnJvci5tZXNzYWdlfWApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgZGVsZXRlQnV0dG9uKGlkOiBBc3NldElkKTogUHJvbWlzZTxSZXN1bHQ8dm9pZD4+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGZpbGUgPSB0aGlzLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoaWQudG9TdHJpbmcoKSArICcubWQnKTtcbiAgICAgICAgICAgIGlmIChmaWxlIGluc3RhbmNlb2YgVEZpbGUpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmFwcC52YXVsdC5kZWxldGUoZmlsZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0Lm9rPHZvaWQ+KCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8dm9pZD4oYEZhaWxlZCB0byBkZWxldGUgYnV0dG9uOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBkZWxldGVDb21tYW5kKGlkOiBBc3NldElkKTogUHJvbWlzZTxSZXN1bHQ8dm9pZD4+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGZpbGUgPSB0aGlzLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoaWQudG9TdHJpbmcoKSArICcubWQnKTtcbiAgICAgICAgICAgIGlmIChmaWxlIGluc3RhbmNlb2YgVEZpbGUpIHtcbiAgICAgICAgICAgICAgICBhd2FpdCB0aGlzLmFwcC52YXVsdC5kZWxldGUoZmlsZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0Lm9rPHZvaWQ+KCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8dm9pZD4oYEZhaWxlZCB0byBkZWxldGUgY29tbWFuZDogJHtlcnJvci5tZXNzYWdlfWApO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBidWlsZEJ1dHRvbkZyb21GaWxlKGZpbGU6IFRGaWxlKTogUHJvbWlzZTxSZXN1bHQ8VUlCdXR0b24gfCBudWxsPj4ge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLmFwcC5tZXRhZGF0YUNhY2hlLmdldEZpbGVDYWNoZShmaWxlKTtcbiAgICAgICAgICAgIGlmICghbWV0YWRhdGE/LmZyb250bWF0dGVyKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5vazxVSUJ1dHRvbiB8IG51bGw+KG51bGwpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBmbSA9IG1ldGFkYXRhLmZyb250bWF0dGVyO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCBpZFJlc3VsdCA9IEFzc2V0SWQuY3JlYXRlKGZpbGUuYmFzZW5hbWUpO1xuICAgICAgICAgICAgY29uc3QgY29tbWFuZElkUmVzdWx0ID0gQXNzZXRJZC5jcmVhdGUoXG4gICAgICAgICAgICAgICAgdGhpcy5jbGVhbkFzc2V0UmVmZXJlbmNlKGZtWyd1aV9fQnV0dG9uX2NvbW1hbmQnXSB8fCAnJylcbiAgICAgICAgICAgICk7XG5cbiAgICAgICAgICAgIGlmIChpZFJlc3VsdC5pc0ZhaWx1cmUgfHwgY29tbWFuZElkUmVzdWx0LmlzRmFpbHVyZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBSZXN1bHQub2s8VUlCdXR0b24gfCBudWxsPihudWxsKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgYnV0dG9uUmVzdWx0ID0gVUlCdXR0b24uY3JlYXRlKHtcbiAgICAgICAgICAgICAgICBpZDogaWRSZXN1bHQuZ2V0VmFsdWUoKSxcbiAgICAgICAgICAgICAgICBsYWJlbDogZm1bJ3VpX19CdXR0b25fbGFiZWwnXSB8fCBmaWxlLmJhc2VuYW1lLFxuICAgICAgICAgICAgICAgIGNvbW1hbmRJZDogY29tbWFuZElkUmVzdWx0LmdldFZhbHVlKCksXG4gICAgICAgICAgICAgICAgb3JkZXI6IGZtWyd1aV9fQnV0dG9uX29yZGVyJ10gfHwgMCxcbiAgICAgICAgICAgICAgICBpc0VuYWJsZWQ6IGZtWyd1aV9fQnV0dG9uX2VuYWJsZWQnXSAhPT0gZmFsc2UsXG4gICAgICAgICAgICAgICAgdG9vbHRpcDogZm1bJ3VpX19CdXR0b25fdG9vbHRpcCddXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKGJ1dHRvblJlc3VsdC5pc0ZhaWx1cmUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8VUlCdXR0b24gfCBudWxsPihidXR0b25SZXN1bHQuZXJyb3IpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICByZXR1cm4gUmVzdWx0Lm9rPFVJQnV0dG9uIHwgbnVsbD4oYnV0dG9uUmVzdWx0LmdldFZhbHVlKCkpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPFVJQnV0dG9uIHwgbnVsbD4oYEZhaWxlZCB0byBidWlsZCBidXR0b246ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYXN5bmMgYnVpbGRDb21tYW5kRnJvbUZpbGUoZmlsZTogVEZpbGUpOiBQcm9taXNlPFJlc3VsdDxCdXR0b25Db21tYW5kIHwgbnVsbD4+IHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IG1ldGFkYXRhID0gdGhpcy5hcHAubWV0YWRhdGFDYWNoZS5nZXRGaWxlQ2FjaGUoZmlsZSk7XG4gICAgICAgICAgICBpZiAoIW1ldGFkYXRhPy5mcm9udG1hdHRlcikge1xuICAgICAgICAgICAgICAgIHJldHVybiBSZXN1bHQub2s8QnV0dG9uQ29tbWFuZCB8IG51bGw+KG51bGwpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBmbSA9IG1ldGFkYXRhLmZyb250bWF0dGVyO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb25zdCBpZFJlc3VsdCA9IEFzc2V0SWQuY3JlYXRlKGZpbGUuYmFzZW5hbWUpO1xuICAgICAgICAgICAgaWYgKGlkUmVzdWx0LmlzRmFpbHVyZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBSZXN1bHQub2s8QnV0dG9uQ29tbWFuZCB8IG51bGw+KG51bGwpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBQYXJzZSBjb21tYW5kIHR5cGVcbiAgICAgICAgICAgIGNvbnN0IHR5cGVTdHJpbmcgPSBmbVsndWlfX0NvbW1hbmRfdHlwZSddIHx8ICdDVVNUT00nO1xuICAgICAgICAgICAgY29uc3QgdHlwZSA9IHRoaXMucGFyc2VDb21tYW5kVHlwZSh0eXBlU3RyaW5nKTtcblxuICAgICAgICAgICAgLy8gUGFyc2UgcGFyYW1ldGVyc1xuICAgICAgICAgICAgY29uc3QgcGFyYW1ldGVycyA9IHRoaXMucGFyc2VQYXJhbWV0ZXJzKGZtWyd1aV9fQ29tbWFuZF9wYXJhbWV0ZXJzJ10pO1xuXG4gICAgICAgICAgICBjb25zdCBjb21tYW5kUmVzdWx0ID0gQnV0dG9uQ29tbWFuZC5jcmVhdGUoe1xuICAgICAgICAgICAgICAgIGlkOiBpZFJlc3VsdC5nZXRWYWx1ZSgpLFxuICAgICAgICAgICAgICAgIHR5cGU6IHR5cGUsXG4gICAgICAgICAgICAgICAgbmFtZTogZm1bJ3VpX19Db21tYW5kX25hbWUnXSB8fCBmaWxlLmJhc2VuYW1lLFxuICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBmbVsndWlfX0NvbW1hbmRfZGVzY3JpcHRpb24nXSxcbiAgICAgICAgICAgICAgICByZXF1aXJlc0lucHV0OiBmbVsndWlfX0NvbW1hbmRfcmVxdWlyZXNJbnB1dCddID09PSB0cnVlLFxuICAgICAgICAgICAgICAgIHBhcmFtZXRlcnM6IHBhcmFtZXRlcnMsXG4gICAgICAgICAgICAgICAgdGFyZ2V0Q2xhc3M6IHRoaXMuY2xlYW5Bc3NldFJlZmVyZW5jZShmbVsndWlfX0NvbW1hbmRfdGFyZ2V0Q2xhc3MnXSksXG4gICAgICAgICAgICAgICAgdGVtcGxhdGU6IGZtWyd1aV9fQ29tbWFuZF90ZW1wbGF0ZSddLFxuICAgICAgICAgICAgICAgIHNjcmlwdDogZm1bJ3VpX19Db21tYW5kX3NjcmlwdCddXG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgaWYgKGNvbW1hbmRSZXN1bHQuaXNGYWlsdXJlKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPEJ1dHRvbkNvbW1hbmQgfCBudWxsPihjb21tYW5kUmVzdWx0LmVycm9yKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgcmV0dXJuIFJlc3VsdC5vazxCdXR0b25Db21tYW5kIHwgbnVsbD4oY29tbWFuZFJlc3VsdC5nZXRWYWx1ZSgpKTtcbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxCdXR0b25Db21tYW5kIHwgbnVsbD4oYEZhaWxlZCB0byBidWlsZCBjb21tYW5kOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHBhcnNlQ29tbWFuZFR5cGUodHlwZVN0cmluZzogc3RyaW5nKTogQ29tbWFuZFR5cGUge1xuICAgICAgICBjb25zdCB1cHBlclR5cGUgPSB0eXBlU3RyaW5nLnRvVXBwZXJDYXNlKCk7XG4gICAgICAgIHJldHVybiBDb21tYW5kVHlwZVt1cHBlclR5cGUgYXMga2V5b2YgdHlwZW9mIENvbW1hbmRUeXBlXSB8fCBDb21tYW5kVHlwZS5DVVNUT007XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwYXJzZVBhcmFtZXRlcnMocGFyYW1zRGF0YTogYW55KTogQ29tbWFuZFBhcmFtZXRlcltdIHtcbiAgICAgICAgaWYgKCFwYXJhbXNEYXRhKSByZXR1cm4gW107XG4gICAgICAgIFxuICAgICAgICBjb25zdCBwYXJhbXM6IENvbW1hbmRQYXJhbWV0ZXJbXSA9IFtdO1xuICAgICAgICBjb25zdCBwYXJhbUFycmF5ID0gdGhpcy5lbnN1cmVBcnJheShwYXJhbXNEYXRhKTtcblxuICAgICAgICBmb3IgKGNvbnN0IHBhcmFtIG9mIHBhcmFtQXJyYXkpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFyYW0gPT09ICdvYmplY3QnICYmIHBhcmFtLm5hbWUpIHtcbiAgICAgICAgICAgICAgICBwYXJhbXMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIG5hbWU6IHBhcmFtLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHR5cGU6IHBhcmFtLnR5cGUgfHwgJ3N0cmluZycsXG4gICAgICAgICAgICAgICAgICAgIHJlcXVpcmVkOiBwYXJhbS5yZXF1aXJlZCA9PT0gdHJ1ZSxcbiAgICAgICAgICAgICAgICAgICAgZGVmYXVsdFZhbHVlOiBwYXJhbS5kZWZhdWx0VmFsdWUsXG4gICAgICAgICAgICAgICAgICAgIGxhYmVsOiBwYXJhbS5sYWJlbCxcbiAgICAgICAgICAgICAgICAgICAgZGVzY3JpcHRpb246IHBhcmFtLmRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgICAgICAgICB2YWxpZGF0aW9uOiBwYXJhbS52YWxpZGF0aW9uXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcGFyYW1zO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2VyaWFsaXplQnV0dG9uKGJ1dHRvbjogVUlCdXR0b24pOiBzdHJpbmcge1xuICAgICAgICBjb25zdCBmcm9udG1hdHRlciA9IHtcbiAgICAgICAgICAgICdleG9fX0luc3RhbmNlX2NsYXNzJzogJ1tbdWlfX0J1dHRvbl1dJyxcbiAgICAgICAgICAgICd1aV9fQnV0dG9uX2xhYmVsJzogYnV0dG9uLmxhYmVsLFxuICAgICAgICAgICAgJ3VpX19CdXR0b25fY29tbWFuZCc6IGBbWyR7YnV0dG9uLmNvbW1hbmRJZC50b1N0cmluZygpfV1dYCxcbiAgICAgICAgICAgICd1aV9fQnV0dG9uX29yZGVyJzogYnV0dG9uLm9yZGVyLFxuICAgICAgICAgICAgJ3VpX19CdXR0b25fZW5hYmxlZCc6IGJ1dHRvbi5pc0VuYWJsZWQsXG4gICAgICAgICAgICAndWlfX0J1dHRvbl90b29sdGlwJzogYnV0dG9uLnRvb2x0aXBcbiAgICAgICAgfTtcblxuICAgICAgICBjb25zdCB5YW1sQ29udGVudCA9IHRoaXMudG9ZYW1sKGZyb250bWF0dGVyKTtcbiAgICAgICAgcmV0dXJuIGAtLS1cXG4ke3lhbWxDb250ZW50fS0tLVxcblxcbiMgQnV0dG9uOiAke2J1dHRvbi5sYWJlbH1cXG5gO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2VyaWFsaXplQ29tbWFuZChjb21tYW5kOiBCdXR0b25Db21tYW5kKTogc3RyaW5nIHtcbiAgICAgICAgY29uc3QgZnJvbnRtYXR0ZXIgPSB7XG4gICAgICAgICAgICAnZXhvX19JbnN0YW5jZV9jbGFzcyc6ICdbW3VpX19CdXR0b25Db21tYW5kXV0nLFxuICAgICAgICAgICAgJ3VpX19Db21tYW5kX3R5cGUnOiBjb21tYW5kLnR5cGUsXG4gICAgICAgICAgICAndWlfX0NvbW1hbmRfbmFtZSc6IGNvbW1hbmQubmFtZSxcbiAgICAgICAgICAgICd1aV9fQ29tbWFuZF9kZXNjcmlwdGlvbic6IGNvbW1hbmQuZGVzY3JpcHRpb24sXG4gICAgICAgICAgICAndWlfX0NvbW1hbmRfcmVxdWlyZXNJbnB1dCc6IGNvbW1hbmQucmVxdWlyZXNJbnB1dCxcbiAgICAgICAgICAgICd1aV9fQ29tbWFuZF9wYXJhbWV0ZXJzJzogY29tbWFuZC5wYXJhbWV0ZXJzLFxuICAgICAgICAgICAgJ3VpX19Db21tYW5kX3RhcmdldENsYXNzJzogY29tbWFuZC50YXJnZXRDbGFzcyA/IGBbWyR7Y29tbWFuZC50YXJnZXRDbGFzc31dXWAgOiBudWxsLFxuICAgICAgICAgICAgJ3VpX19Db21tYW5kX3RlbXBsYXRlJzogY29tbWFuZC50ZW1wbGF0ZSxcbiAgICAgICAgICAgICd1aV9fQ29tbWFuZF9zY3JpcHQnOiBjb21tYW5kLnNjcmlwdFxuICAgICAgICB9O1xuXG4gICAgICAgIGNvbnN0IHlhbWxDb250ZW50ID0gdGhpcy50b1lhbWwoZnJvbnRtYXR0ZXIpO1xuICAgICAgICByZXR1cm4gYC0tLVxcbiR7eWFtbENvbnRlbnR9LS0tXFxuXFxuIyBDb21tYW5kOiAke2NvbW1hbmQubmFtZX1cXG5gO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2xlYW5Bc3NldFJlZmVyZW5jZShyZWY6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIGlmICh0eXBlb2YgcmVmICE9PSAnc3RyaW5nJykgcmV0dXJuICcnO1xuICAgICAgICByZXR1cm4gcmVmLnJlcGxhY2UoL1xcW1xcW3xcXF1cXF0vZywgJycpLnRyaW0oKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGVuc3VyZUFycmF5KHZhbHVlOiBhbnkpOiBhbnlbXSB7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgcmV0dXJuIHZhbHVlO1xuICAgICAgICBpZiAodmFsdWUpIHJldHVybiBbdmFsdWVdO1xuICAgICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgcHJpdmF0ZSB0b1lhbWwob2JqOiBhbnkpOiBzdHJpbmcge1xuICAgICAgICAvLyBTaW1wbGUgWUFNTCBzZXJpYWxpemF0aW9uXG4gICAgICAgIHJldHVybiBPYmplY3QuZW50cmllcyhvYmopXG4gICAgICAgICAgICAuZmlsdGVyKChbXywgdmFsdWVdKSA9PiB2YWx1ZSAhPT0gbnVsbCAmJiB2YWx1ZSAhPT0gdW5kZWZpbmVkKVxuICAgICAgICAgICAgLm1hcCgoW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZS5sZW5ndGggPT09IDApIHJldHVybiBgJHtrZXl9OiBbXWA7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBgJHtrZXl9OlxcbiR7dmFsdWUubWFwKHYgPT4gYCAgLSAke0pTT04uc3RyaW5naWZ5KHYpfWApLmpvaW4oJ1xcbicpfWA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBgJHtrZXl9OiAke0pTT04uc3RyaW5naWZ5KHZhbHVlKX1gO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4gYCR7a2V5fTogJHt2YWx1ZX1gO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5qb2luKCdcXG4nKSArICdcXG4nO1xuICAgIH1cbn0iXSwidmVyc2lvbiI6M30=