e8553d43318d3b54121b1e9f00a730ed
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const PropertyEditingUseCase_1 = require("../../src/application/use-cases/PropertyEditingUseCase");
const Asset_1 = require("../../src/domain/entities/Asset");
const AssetId_1 = require("../../src/domain/value-objects/AssetId");
const ClassName_1 = require("../../src/domain/value-objects/ClassName");
const OntologyPrefix_1 = require("../../src/domain/value-objects/OntologyPrefix");
describe("PropertyEditingUseCase Integration", () => {
    let useCase;
    let mockRepository;
    let mockPlugin;
    beforeEach(() => {
        mockRepository = {
            findById: jest.fn(),
            findByFilename: jest.fn(),
            findByClass: jest.fn(),
            findByOntology: jest.fn(),
            save: jest.fn(),
            delete: jest.fn(),
            exists: jest.fn(),
            findAll: jest.fn(),
        };
        mockPlugin = {
            findPropertiesForClass: jest.fn(),
            findAssetsByClass: jest.fn(),
        };
        useCase = new PropertyEditingUseCase_1.PropertyEditingUseCase(mockRepository, mockPlugin);
    });
    afterEach(() => {
        jest.clearAllMocks();
        jest.clearAllTimers();
        // Clear references to prevent memory leaks
        mockRepository = null;
        mockPlugin = null;
        useCase = null;
    });
    describe("execute with different asset identifiers", () => {
        let testAsset;
        beforeEach(() => {
            const assetId = AssetId_1.AssetId.generate();
            const className = ClassName_1.ClassName.create("TestClass").getValue();
            const ontology = OntologyPrefix_1.OntologyPrefix.create("test").getValue();
            const assetResult = Asset_1.Asset.create({
                id: assetId,
                label: "Test Asset",
                className: className,
                ontology: ontology,
                properties: { testProp: "oldValue" },
            });
            if (!assetResult.isSuccess) {
                throw new Error(`Failed to create test asset: ${assetResult.getError()}`);
            }
            testAsset = assetResult.getValue();
        });
        it("should find asset by UUID and update property", async () => {
            mockRepository.findById.mockResolvedValue(testAsset);
            mockRepository.save.mockResolvedValue(undefined);
            const result = await useCase.execute({
                assetId: testAsset.getId().toString(),
                propertyName: "testProp",
                value: "newValue",
                propertyDefinition: {
                    propertyName: "testProp",
                    label: "Test Property",
                    range: "string",
                    isRequired: false,
                },
            });
            expect(result.isSuccess).toBe(true);
            expect(mockRepository.findById).toHaveBeenCalled();
            expect(mockRepository.save).toHaveBeenCalled();
        });
        it("should fallback to filename when UUID not found", async () => {
            mockRepository.findById.mockResolvedValue(null);
            mockRepository.findByFilename.mockResolvedValue(testAsset);
            mockRepository.save.mockResolvedValue(undefined);
            // Mock the updateFrontmatterByPath method for file path handling
            const mockUpdateFrontmatterByPath = jest
                .fn()
                .mockResolvedValue(undefined);
            mockRepository.updateFrontmatterByPath =
                mockUpdateFrontmatterByPath;
            const result = await useCase.execute({
                assetId: "MyAsset.md",
                propertyName: "testProp",
                value: "newValue",
                propertyDefinition: {
                    propertyName: "testProp",
                    label: "Test Property",
                    range: "string",
                    isRequired: false,
                },
            });
            expect(result.isSuccess).toBe(true);
            // For .md files, it should use the direct path update method
            expect(mockUpdateFrontmatterByPath).toHaveBeenCalledWith("MyAsset.md", {
                testProp: "newValue",
            });
        });
        it("should handle filename without extension", async () => {
            mockRepository.findById.mockResolvedValue(null);
            mockRepository.findByFilename.mockResolvedValue(testAsset);
            mockRepository.save.mockResolvedValue(undefined);
            const result = await useCase.execute({
                assetId: "MyAsset",
                propertyName: "testProp",
                value: "newValue",
                propertyDefinition: {
                    propertyName: "testProp",
                    label: "Test Property",
                    range: "string",
                    isRequired: false,
                },
            });
            expect(result.isSuccess).toBe(true);
            expect(mockRepository.findByFilename).toHaveBeenCalledWith("MyAsset");
        });
        it("should return error when asset not found by any method", async () => {
            mockRepository.findById.mockResolvedValue(null);
            mockRepository.findByFilename.mockResolvedValue(null);
            const result = await useCase.execute({
                assetId: "NonExistent",
                propertyName: "testProp",
                value: "newValue",
                propertyDefinition: {
                    propertyName: "testProp",
                    label: "Test Property",
                    range: "string",
                    isRequired: false,
                },
            });
            expect(result.isFailure).toBe(true);
            expect(result.error).toContain("Asset not found");
        });
        it("should handle file paths as identifiers", async () => {
            // Mock the updateFrontmatterByPath method for file path handling
            const mockUpdateFrontmatterByPath = jest
                .fn()
                .mockResolvedValue(undefined);
            mockRepository.updateFrontmatterByPath =
                mockUpdateFrontmatterByPath;
            const result = await useCase.execute({
                assetId: "folder/subfolder/MyAsset.md",
                propertyName: "testProp",
                value: "newValue",
                propertyDefinition: {
                    propertyName: "testProp",
                    label: "Test Property",
                    range: "string",
                    isRequired: false,
                },
            });
            expect(result.isSuccess).toBe(true);
            // For file paths with slashes, it should use the direct path update method
            expect(mockUpdateFrontmatterByPath).toHaveBeenCalledWith("folder/subfolder/MyAsset.md", {
                testProp: "newValue",
            });
        });
    });
    describe("property validation", () => {
        const testAsset = Asset_1.Asset.create({
            id: AssetId_1.AssetId.generate(),
            label: "Test Asset",
            className: ClassName_1.ClassName.create("TestClass").getValue(),
            ontology: OntologyPrefix_1.OntologyPrefix.create("test").getValue(),
            properties: {},
        }).getValue();
        beforeEach(() => {
            mockRepository.findById.mockResolvedValue(testAsset);
            mockRepository.save.mockResolvedValue(undefined);
            // Mock the updateFrontmatterByPath method for property validation tests
            mockRepository.updateFrontmatterByPath = jest
                .fn()
                .mockResolvedValue(undefined);
        });
        it("should validate required fields", async () => {
            const validUuid = testAsset.getId().toString();
            const result = await useCase.execute({
                assetId: validUuid,
                propertyName: "requiredProp",
                value: "",
                propertyDefinition: {
                    propertyName: "requiredProp",
                    label: "Required Property",
                    range: "string",
                    isRequired: true,
                },
            });
            expect(result.isFailure).toBe(true);
            expect(result.error).toContain("Required Property is required");
        });
        it("should allow empty values for optional fields", async () => {
            // Use a valid UUID as assetId and set up proper mocks
            const validUuid = testAsset.getId().toString();
            const result = await useCase.execute({
                assetId: validUuid,
                propertyName: "optionalProp",
                value: "",
                propertyDefinition: {
                    propertyName: "optionalProp",
                    label: "Optional Property",
                    range: "string",
                    isRequired: false,
                },
            });
            expect(result.isSuccess).toBe(true);
        });
        it("should validate enum values", async () => {
            const validUuid = testAsset.getId().toString();
            const result = await useCase.execute({
                assetId: validUuid,
                propertyName: "statusProp",
                value: "invalid",
                propertyDefinition: {
                    propertyName: "statusProp",
                    label: "Status",
                    range: "enum:pending,active,completed",
                    isRequired: true,
                },
            });
            expect(result.isFailure).toBe(true);
            expect(result.error).toContain("Status must be one of: pending, active, completed");
        });
        it("should validate date format", async () => {
            const validUuid = testAsset.getId().toString();
            const result = await useCase.execute({
                assetId: validUuid,
                propertyName: "dateProp",
                value: "not-a-date",
                propertyDefinition: {
                    propertyName: "dateProp",
                    label: "Date",
                    range: "date",
                    isRequired: true,
                },
            });
            expect(result.isFailure).toBe(true);
            expect(result.error).toContain("Date must be a valid date");
        });
        it("should validate custom regex patterns", async () => {
            const validUuid = testAsset.getId().toString();
            const result = await useCase.execute({
                assetId: validUuid,
                propertyName: "emailProp",
                value: "invalid-email",
                propertyDefinition: {
                    propertyName: "emailProp",
                    label: "Email",
                    range: "string",
                    isRequired: true,
                    validation: "^[\\w\\.-]+@[\\w\\.-]+\\.\\w+$",
                },
            });
            expect(result.isFailure).toBe(true);
            expect(result.error).toContain("Email format is invalid");
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vdGVzdHMvaW50ZWdyYXRpb24vUHJvcGVydHlFZGl0aW5nVXNlQ2FzZS50ZXN0LnRzIiwibWFwcGluZ3MiOiI7O0FBQUEsbUdBQWdHO0FBRWhHLDJEQUF3RDtBQUN4RCxvRUFBaUU7QUFDakUsd0VBQXFFO0FBQ3JFLGtGQUErRTtBQUUvRSxRQUFRLENBQUMsb0NBQW9DLEVBQUUsR0FBRyxFQUFFO0lBQ2xELElBQUksT0FBK0IsQ0FBQztJQUNwQyxJQUFJLGNBQTZDLENBQUM7SUFDbEQsSUFBSSxVQUFlLENBQUM7SUFFcEIsVUFBVSxDQUFDLEdBQUcsRUFBRTtRQUNkLGNBQWMsR0FBRztZQUNmLFFBQVEsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ25CLGNBQWMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ3pCLFdBQVcsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ3RCLGNBQWMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ3pCLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ2YsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDakIsTUFBTSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDakIsT0FBTyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7U0FDWixDQUFDO1FBRVQsVUFBVSxHQUFHO1lBQ1gsc0JBQXNCLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUNqQyxpQkFBaUIsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1NBQzdCLENBQUM7UUFFRixPQUFPLEdBQUcsSUFBSSwrQ0FBc0IsQ0FBQyxjQUFjLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDbkUsQ0FBQyxDQUFDLENBQUM7SUFFSCxTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ2IsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUN0Qiwy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QUNwQyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLFNBQVMsQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO1FBQzlELENBQUMsQ0FBQyxDQUFDO1FBRUgsRUFBRSxDQUFDLHVDQUF1QyxFQUFFLEtBQUssSUFBSSxFQUFFO1lBQ3JELE1BQU0sU0FBUyxHQUFHLFNBQVMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUUvQyxNQUFNLE1BQU0sR0FBRyxNQUFNLE9BQU8sQ0FBQyxPQUFPLENBQUM7Z0JBQ25DLE9BQU8sRUFBRSxTQUFTO2dCQUNsQixZQUFZLEVBQUUsV0FBVztnQkFDekIsS0FBSyxFQUFFLGVBQWU7Z0JBQ3RCLGtCQUFrQixFQUFFO29CQUNsQixZQUFZLEVBQUUsV0FBVztvQkFDekIsS0FBSyxFQUFFLE9BQU87b0JBQ2QsS0FBSyxFQUFFLFFBQVE7b0JBQ2YsVUFBVSxFQUFFLElBQUk7b0JBQ2hCLFVBQVUsRUFBRSxnQ0FBZ0M7aUJBQzdDO2FBQ0YsQ0FBQyxDQUFDO1lBRUgsTUFBTSxDQUFDLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDcEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxTQUFTLENBQUMseUJBQXlCLENBQUMsQ0FBQztRQUM1RCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vdGVzdHMvaW50ZWdyYXRpb24vUHJvcGVydHlFZGl0aW5nVXNlQ2FzZS50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFByb3BlcnR5RWRpdGluZ1VzZUNhc2UgfSBmcm9tIFwiLi4vLi4vc3JjL2FwcGxpY2F0aW9uL3VzZS1jYXNlcy9Qcm9wZXJ0eUVkaXRpbmdVc2VDYXNlXCI7XG5pbXBvcnQgeyBJQXNzZXRSZXBvc2l0b3J5IH0gZnJvbSBcIi4uLy4uL3NyYy9kb21haW4vcmVwb3NpdG9yaWVzL0lBc3NldFJlcG9zaXRvcnlcIjtcbmltcG9ydCB7IEFzc2V0IH0gZnJvbSBcIi4uLy4uL3NyYy9kb21haW4vZW50aXRpZXMvQXNzZXRcIjtcbmltcG9ydCB7IEFzc2V0SWQgfSBmcm9tIFwiLi4vLi4vc3JjL2RvbWFpbi92YWx1ZS1vYmplY3RzL0Fzc2V0SWRcIjtcbmltcG9ydCB7IENsYXNzTmFtZSB9IGZyb20gXCIuLi8uLi9zcmMvZG9tYWluL3ZhbHVlLW9iamVjdHMvQ2xhc3NOYW1lXCI7XG5pbXBvcnQgeyBPbnRvbG9neVByZWZpeCB9IGZyb20gXCIuLi8uLi9zcmMvZG9tYWluL3ZhbHVlLW9iamVjdHMvT250b2xvZ3lQcmVmaXhcIjtcblxuZGVzY3JpYmUoXCJQcm9wZXJ0eUVkaXRpbmdVc2VDYXNlIEludGVncmF0aW9uXCIsICgpID0+IHtcbiAgbGV0IHVzZUNhc2U6IFByb3BlcnR5RWRpdGluZ1VzZUNhc2U7XG4gIGxldCBtb2NrUmVwb3NpdG9yeTogamVzdC5Nb2NrZWQ8SUFzc2V0UmVwb3NpdG9yeT47XG4gIGxldCBtb2NrUGx1Z2luOiBhbnk7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgbW9ja1JlcG9zaXRvcnkgPSB7XG4gICAgICBmaW5kQnlJZDogamVzdC5mbigpLFxuICAgICAgZmluZEJ5RmlsZW5hbWU6IGplc3QuZm4oKSxcbiAgICAgIGZpbmRCeUNsYXNzOiBqZXN0LmZuKCksXG4gICAgICBmaW5kQnlPbnRvbG9neTogamVzdC5mbigpLFxuICAgICAgc2F2ZTogamVzdC5mbigpLFxuICAgICAgZGVsZXRlOiBqZXN0LmZuKCksXG4gICAgICBleGlzdHM6IGplc3QuZm4oKSxcbiAgICAgIGZpbmRBbGw6IGplc3QuZm4oKSxcbiAgICB9IGFzIGFueTtcblxuICAgIG1vY2tQbHVnaW4gPSB7XG4gICAgICBmaW5kUHJvcGVydGllc0ZvckNsYXNzOiBqZXN0LmZuKCksXG4gICAgICBmaW5kQXNzZXRzQnlDbGFzczogamVzdC5mbigpLFxuICAgIH07XG5cbiAgICB1c2VDYXNlID0gbmV3IFByb3BlcnR5RWRpdGluZ1VzZUNhc2UobW9ja1JlcG9zaXRvcnksIG1vY2tQbHVnaW4pO1xuICB9KTtcblxuICBhZnRlckVhY2goKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICAgIGplc3QuY2xlYXJBbGxUaW1lcnMoKTtcbiAgICAvLyBDbGVhciByZWZlcmVuY2VzIHRvIHByZXZlbnQgbWVtb3J5IGxlYWtzXG4gICAgbW9ja1JlcG9zaXRvcnkgPSBudWxsIGFzIGFueTtcbiAgICBtb2NrUGx1Z2luID0gbnVsbCBhcyBhbnk7XG4gICAgdXNlQ2FzZSA9IG51bGwgYXMgYW55O1xuICB9KTtcblxuICBkZXNjcmliZShcImV4ZWN1dGUgd2l0aCBkaWZmZXJlbnQgYXNzZXQgaWRlbnRpZmllcnNcIiwgKCkgPT4ge1xuICAgIGxldCB0ZXN0QXNzZXQ6IEFzc2V0O1xuXG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICBjb25zdCBhc3NldElkID0gQXNzZXRJZC5nZW5lcmF0ZSgpO1xuICAgICAgY29uc3QgY2xhc3NOYW1lID0gQ2xhc3NOYW1lLmNyZWF0ZShcIlRlc3RDbGFzc1wiKS5nZXRWYWx1ZSgpITtcbiAgICAgIGNvbnN0IG9udG9sb2d5ID0gT250b2xvZ3lQcmVmaXguY3JlYXRlKFwidGVzdFwiKS5nZXRWYWx1ZSgpITtcblxuICAgICAgY29uc3QgYXNzZXRSZXN1bHQgPSBBc3NldC5jcmVhdGUoe1xuICAgICAgICBpZDogYXNzZXRJZCxcbiAgICAgICAgbGFiZWw6IFwiVGVzdCBBc3NldFwiLFxuICAgICAgICBjbGFzc05hbWU6IGNsYXNzTmFtZSxcbiAgICAgICAgb250b2xvZ3k6IG9udG9sb2d5LFxuICAgICAgICBwcm9wZXJ0aWVzOiB7IHRlc3RQcm9wOiBcIm9sZFZhbHVlXCIgfSxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoIWFzc2V0UmVzdWx0LmlzU3VjY2Vzcykge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYEZhaWxlZCB0byBjcmVhdGUgdGVzdCBhc3NldDogJHthc3NldFJlc3VsdC5nZXRFcnJvcigpfWAsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHRlc3RBc3NldCA9IGFzc2V0UmVzdWx0LmdldFZhbHVlKCkhO1xuICAgIH0pO1xuXG4gICAgaXQoXCJzaG91bGQgZmluZCBhc3NldCBieSBVVUlEIGFuZCB1cGRhdGUgcHJvcGVydHlcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgbW9ja1JlcG9zaXRvcnkuZmluZEJ5SWQubW9ja1Jlc29sdmVkVmFsdWUodGVzdEFzc2V0KTtcbiAgICAgIG1vY2tSZXBvc2l0b3J5LnNhdmUubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdXNlQ2FzZS5leGVjdXRlKHtcbiAgICAgICAgYXNzZXRJZDogdGVzdEFzc2V0LmdldElkKCkudG9TdHJpbmcoKSxcbiAgICAgICAgcHJvcGVydHlOYW1lOiBcInRlc3RQcm9wXCIsXG4gICAgICAgIHZhbHVlOiBcIm5ld1ZhbHVlXCIsXG4gICAgICAgIHByb3BlcnR5RGVmaW5pdGlvbjoge1xuICAgICAgICAgIHByb3BlcnR5TmFtZTogXCJ0ZXN0UHJvcFwiLFxuICAgICAgICAgIGxhYmVsOiBcIlRlc3QgUHJvcGVydHlcIixcbiAgICAgICAgICByYW5nZTogXCJzdHJpbmdcIixcbiAgICAgICAgICBpc1JlcXVpcmVkOiBmYWxzZSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBleHBlY3QocmVzdWx0LmlzU3VjY2VzcykudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChtb2NrUmVwb3NpdG9yeS5maW5kQnlJZCkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgZXhwZWN0KG1vY2tSZXBvc2l0b3J5LnNhdmUpLnRvSGF2ZUJlZW5DYWxsZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KFwic2hvdWxkIGZhbGxiYWNrIHRvIGZpbGVuYW1lIHdoZW4gVVVJRCBub3QgZm91bmRcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgbW9ja1JlcG9zaXRvcnkuZmluZEJ5SWQubW9ja1Jlc29sdmVkVmFsdWUobnVsbCk7XG4gICAgICBtb2NrUmVwb3NpdG9yeS5maW5kQnlGaWxlbmFtZS5tb2NrUmVzb2x2ZWRWYWx1ZSh0ZXN0QXNzZXQpO1xuICAgICAgbW9ja1JlcG9zaXRvcnkuc2F2ZS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpO1xuXG4gICAgICAvLyBNb2NrIHRoZSB1cGRhdGVGcm9udG1hdHRlckJ5UGF0aCBtZXRob2QgZm9yIGZpbGUgcGF0aCBoYW5kbGluZ1xuICAgICAgY29uc3QgbW9ja1VwZGF0ZUZyb250bWF0dGVyQnlQYXRoID0gamVzdFxuICAgICAgICAuZm4oKVxuICAgICAgICAubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKTtcbiAgICAgIChtb2NrUmVwb3NpdG9yeSBhcyBhbnkpLnVwZGF0ZUZyb250bWF0dGVyQnlQYXRoID1cbiAgICAgICAgbW9ja1VwZGF0ZUZyb250bWF0dGVyQnlQYXRoO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB1c2VDYXNlLmV4ZWN1dGUoe1xuICAgICAgICBhc3NldElkOiBcIk15QXNzZXQubWRcIixcbiAgICAgICAgcHJvcGVydHlOYW1lOiBcInRlc3RQcm9wXCIsXG4gICAgICAgIHZhbHVlOiBcIm5ld1ZhbHVlXCIsXG4gICAgICAgIHByb3BlcnR5RGVmaW5pdGlvbjoge1xuICAgICAgICAgIHByb3BlcnR5TmFtZTogXCJ0ZXN0UHJvcFwiLFxuICAgICAgICAgIGxhYmVsOiBcIlRlc3QgUHJvcGVydHlcIixcbiAgICAgICAgICByYW5nZTogXCJzdHJpbmdcIixcbiAgICAgICAgICBpc1JlcXVpcmVkOiBmYWxzZSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBleHBlY3QocmVzdWx0LmlzU3VjY2VzcykudG9CZSh0cnVlKTtcbiAgICAgIC8vIEZvciAubWQgZmlsZXMsIGl0IHNob3VsZCB1c2UgdGhlIGRpcmVjdCBwYXRoIHVwZGF0ZSBtZXRob2RcbiAgICAgIGV4cGVjdChtb2NrVXBkYXRlRnJvbnRtYXR0ZXJCeVBhdGgpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFwiTXlBc3NldC5tZFwiLCB7XG4gICAgICAgIHRlc3RQcm9wOiBcIm5ld1ZhbHVlXCIsXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KFwic2hvdWxkIGhhbmRsZSBmaWxlbmFtZSB3aXRob3V0IGV4dGVuc2lvblwiLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2NrUmVwb3NpdG9yeS5maW5kQnlJZC5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKTtcbiAgICAgIG1vY2tSZXBvc2l0b3J5LmZpbmRCeUZpbGVuYW1lLm1vY2tSZXNvbHZlZFZhbHVlKHRlc3RBc3NldCk7XG4gICAgICBtb2NrUmVwb3NpdG9yeS5zYXZlLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHVzZUNhc2UuZXhlY3V0ZSh7XG4gICAgICAgIGFzc2V0SWQ6IFwiTXlBc3NldFwiLFxuICAgICAgICBwcm9wZXJ0eU5hbWU6IFwidGVzdFByb3BcIixcbiAgICAgICAgdmFsdWU6IFwibmV3VmFsdWVcIixcbiAgICAgICAgcHJvcGVydHlEZWZpbml0aW9uOiB7XG4gICAgICAgICAgcHJvcGVydHlOYW1lOiBcInRlc3RQcm9wXCIsXG4gICAgICAgICAgbGFiZWw6IFwiVGVzdCBQcm9wZXJ0eVwiLFxuICAgICAgICAgIHJhbmdlOiBcInN0cmluZ1wiLFxuICAgICAgICAgIGlzUmVxdWlyZWQ6IGZhbHNlLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuaXNTdWNjZXNzKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KG1vY2tSZXBvc2l0b3J5LmZpbmRCeUZpbGVuYW1lKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcIk15QXNzZXRcIik7XG4gICAgfSk7XG5cbiAgICBpdChcInNob3VsZCByZXR1cm4gZXJyb3Igd2hlbiBhc3NldCBub3QgZm91bmQgYnkgYW55IG1ldGhvZFwiLCBhc3luYyAoKSA9PiB7XG4gICAgICBtb2NrUmVwb3NpdG9yeS5maW5kQnlJZC5tb2NrUmVzb2x2ZWRWYWx1ZShudWxsKTtcbiAgICAgIG1vY2tSZXBvc2l0b3J5LmZpbmRCeUZpbGVuYW1lLm1vY2tSZXNvbHZlZFZhbHVlKG51bGwpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB1c2VDYXNlLmV4ZWN1dGUoe1xuICAgICAgICBhc3NldElkOiBcIk5vbkV4aXN0ZW50XCIsXG4gICAgICAgIHByb3BlcnR5TmFtZTogXCJ0ZXN0UHJvcFwiLFxuICAgICAgICB2YWx1ZTogXCJuZXdWYWx1ZVwiLFxuICAgICAgICBwcm9wZXJ0eURlZmluaXRpb246IHtcbiAgICAgICAgICBwcm9wZXJ0eU5hbWU6IFwidGVzdFByb3BcIixcbiAgICAgICAgICBsYWJlbDogXCJUZXN0IFByb3BlcnR5XCIsXG4gICAgICAgICAgcmFuZ2U6IFwic3RyaW5nXCIsXG4gICAgICAgICAgaXNSZXF1aXJlZDogZmFsc2UsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgZXhwZWN0KHJlc3VsdC5pc0ZhaWx1cmUpLnRvQmUodHJ1ZSk7XG4gICAgICBleHBlY3QocmVzdWx0LmVycm9yKS50b0NvbnRhaW4oXCJBc3NldCBub3QgZm91bmRcIik7XG4gICAgfSk7XG5cbiAgICBpdChcInNob3VsZCBoYW5kbGUgZmlsZSBwYXRocyBhcyBpZGVudGlmaWVyc1wiLCBhc3luYyAoKSA9PiB7XG4gICAgICAvLyBNb2NrIHRoZSB1cGRhdGVGcm9udG1hdHRlckJ5UGF0aCBtZXRob2QgZm9yIGZpbGUgcGF0aCBoYW5kbGluZ1xuICAgICAgY29uc3QgbW9ja1VwZGF0ZUZyb250bWF0dGVyQnlQYXRoID0gamVzdFxuICAgICAgICAuZm4oKVxuICAgICAgICAubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKTtcbiAgICAgIChtb2NrUmVwb3NpdG9yeSBhcyBhbnkpLnVwZGF0ZUZyb250bWF0dGVyQnlQYXRoID1cbiAgICAgICAgbW9ja1VwZGF0ZUZyb250bWF0dGVyQnlQYXRoO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB1c2VDYXNlLmV4ZWN1dGUoe1xuICAgICAgICBhc3NldElkOiBcImZvbGRlci9zdWJmb2xkZXIvTXlBc3NldC5tZFwiLFxuICAgICAgICBwcm9wZXJ0eU5hbWU6IFwidGVzdFByb3BcIixcbiAgICAgICAgdmFsdWU6IFwibmV3VmFsdWVcIixcbiAgICAgICAgcHJvcGVydHlEZWZpbml0aW9uOiB7XG4gICAgICAgICAgcHJvcGVydHlOYW1lOiBcInRlc3RQcm9wXCIsXG4gICAgICAgICAgbGFiZWw6IFwiVGVzdCBQcm9wZXJ0eVwiLFxuICAgICAgICAgIHJhbmdlOiBcInN0cmluZ1wiLFxuICAgICAgICAgIGlzUmVxdWlyZWQ6IGZhbHNlLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuaXNTdWNjZXNzKS50b0JlKHRydWUpO1xuICAgICAgLy8gRm9yIGZpbGUgcGF0aHMgd2l0aCBzbGFzaGVzLCBpdCBzaG91bGQgdXNlIHRoZSBkaXJlY3QgcGF0aCB1cGRhdGUgbWV0aG9kXG4gICAgICBleHBlY3QobW9ja1VwZGF0ZUZyb250bWF0dGVyQnlQYXRoKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChcbiAgICAgICAgXCJmb2xkZXIvc3ViZm9sZGVyL015QXNzZXQubWRcIixcbiAgICAgICAge1xuICAgICAgICAgIHRlc3RQcm9wOiBcIm5ld1ZhbHVlXCIsXG4gICAgICAgIH0sXG4gICAgICApO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZShcInByb3BlcnR5IHZhbGlkYXRpb25cIiwgKCkgPT4ge1xuICAgIGNvbnN0IHRlc3RBc3NldCA9IEFzc2V0LmNyZWF0ZSh7XG4gICAgICBpZDogQXNzZXRJZC5nZW5lcmF0ZSgpLFxuICAgICAgbGFiZWw6IFwiVGVzdCBBc3NldFwiLFxuICAgICAgY2xhc3NOYW1lOiBDbGFzc05hbWUuY3JlYXRlKFwiVGVzdENsYXNzXCIpLmdldFZhbHVlKCkhLFxuICAgICAgb250b2xvZ3k6IE9udG9sb2d5UHJlZml4LmNyZWF0ZShcInRlc3RcIikuZ2V0VmFsdWUoKSEsXG4gICAgICBwcm9wZXJ0aWVzOiB7fSxcbiAgICB9KS5nZXRWYWx1ZSgpITtcblxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgbW9ja1JlcG9zaXRvcnkuZmluZEJ5SWQubW9ja1Jlc29sdmVkVmFsdWUodGVzdEFzc2V0KTtcbiAgICAgIG1vY2tSZXBvc2l0b3J5LnNhdmUubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKTtcbiAgICAgIC8vIE1vY2sgdGhlIHVwZGF0ZUZyb250bWF0dGVyQnlQYXRoIG1ldGhvZCBmb3IgcHJvcGVydHkgdmFsaWRhdGlvbiB0ZXN0c1xuICAgICAgKG1vY2tSZXBvc2l0b3J5IGFzIGFueSkudXBkYXRlRnJvbnRtYXR0ZXJCeVBhdGggPSBqZXN0XG4gICAgICAgIC5mbigpXG4gICAgICAgIC5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpO1xuICAgIH0pO1xuXG4gICAgaXQoXCJzaG91bGQgdmFsaWRhdGUgcmVxdWlyZWQgZmllbGRzXCIsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHZhbGlkVXVpZCA9IHRlc3RBc3NldC5nZXRJZCgpLnRvU3RyaW5nKCk7XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHVzZUNhc2UuZXhlY3V0ZSh7XG4gICAgICAgIGFzc2V0SWQ6IHZhbGlkVXVpZCxcbiAgICAgICAgcHJvcGVydHlOYW1lOiBcInJlcXVpcmVkUHJvcFwiLFxuICAgICAgICB2YWx1ZTogXCJcIixcbiAgICAgICAgcHJvcGVydHlEZWZpbml0aW9uOiB7XG4gICAgICAgICAgcHJvcGVydHlOYW1lOiBcInJlcXVpcmVkUHJvcFwiLFxuICAgICAgICAgIGxhYmVsOiBcIlJlcXVpcmVkIFByb3BlcnR5XCIsXG4gICAgICAgICAgcmFuZ2U6IFwic3RyaW5nXCIsXG4gICAgICAgICAgaXNSZXF1aXJlZDogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBleHBlY3QocmVzdWx0LmlzRmFpbHVyZSkudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuZXJyb3IpLnRvQ29udGFpbihcIlJlcXVpcmVkIFByb3BlcnR5IGlzIHJlcXVpcmVkXCIpO1xuICAgIH0pO1xuXG4gICAgaXQoXCJzaG91bGQgYWxsb3cgZW1wdHkgdmFsdWVzIGZvciBvcHRpb25hbCBmaWVsZHNcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gVXNlIGEgdmFsaWQgVVVJRCBhcyBhc3NldElkIGFuZCBzZXQgdXAgcHJvcGVyIG1vY2tzXG4gICAgICBjb25zdCB2YWxpZFV1aWQgPSB0ZXN0QXNzZXQuZ2V0SWQoKS50b1N0cmluZygpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB1c2VDYXNlLmV4ZWN1dGUoe1xuICAgICAgICBhc3NldElkOiB2YWxpZFV1aWQsXG4gICAgICAgIHByb3BlcnR5TmFtZTogXCJvcHRpb25hbFByb3BcIixcbiAgICAgICAgdmFsdWU6IFwiXCIsXG4gICAgICAgIHByb3BlcnR5RGVmaW5pdGlvbjoge1xuICAgICAgICAgIHByb3BlcnR5TmFtZTogXCJvcHRpb25hbFByb3BcIixcbiAgICAgICAgICBsYWJlbDogXCJPcHRpb25hbCBQcm9wZXJ0eVwiLFxuICAgICAgICAgIHJhbmdlOiBcInN0cmluZ1wiLFxuICAgICAgICAgIGlzUmVxdWlyZWQ6IGZhbHNlLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuaXNTdWNjZXNzKS50b0JlKHRydWUpO1xuICAgIH0pO1xuXG4gICAgaXQoXCJzaG91bGQgdmFsaWRhdGUgZW51bSB2YWx1ZXNcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdmFsaWRVdWlkID0gdGVzdEFzc2V0LmdldElkKCkudG9TdHJpbmcoKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdXNlQ2FzZS5leGVjdXRlKHtcbiAgICAgICAgYXNzZXRJZDogdmFsaWRVdWlkLFxuICAgICAgICBwcm9wZXJ0eU5hbWU6IFwic3RhdHVzUHJvcFwiLFxuICAgICAgICB2YWx1ZTogXCJpbnZhbGlkXCIsXG4gICAgICAgIHByb3BlcnR5RGVmaW5pdGlvbjoge1xuICAgICAgICAgIHByb3BlcnR5TmFtZTogXCJzdGF0dXNQcm9wXCIsXG4gICAgICAgICAgbGFiZWw6IFwiU3RhdHVzXCIsXG4gICAgICAgICAgcmFuZ2U6IFwiZW51bTpwZW5kaW5nLGFjdGl2ZSxjb21wbGV0ZWRcIixcbiAgICAgICAgICBpc1JlcXVpcmVkOiB0cnVlLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuaXNGYWlsdXJlKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5lcnJvcikudG9Db250YWluKFxuICAgICAgICBcIlN0YXR1cyBtdXN0IGJlIG9uZSBvZjogcGVuZGluZywgYWN0aXZlLCBjb21wbGV0ZWRcIixcbiAgICAgICk7XG4gICAgfSk7XG5cbiAgICBpdChcInNob3VsZCB2YWxpZGF0ZSBkYXRlIGZvcm1hdFwiLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCB2YWxpZFV1aWQgPSB0ZXN0QXNzZXQuZ2V0SWQoKS50b1N0cmluZygpO1xuXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB1c2VDYXNlLmV4ZWN1dGUoe1xuICAgICAgICBhc3NldElkOiB2YWxpZFV1aWQsXG4gICAgICAgIHByb3BlcnR5TmFtZTogXCJkYXRlUHJvcFwiLFxuICAgICAgICB2YWx1ZTogXCJub3QtYS1kYXRlXCIsXG4gICAgICAgIHByb3BlcnR5RGVmaW5pdGlvbjoge1xuICAgICAgICAgIHByb3BlcnR5TmFtZTogXCJkYXRlUHJvcFwiLFxuICAgICAgICAgIGxhYmVsOiBcIkRhdGVcIixcbiAgICAgICAgICByYW5nZTogXCJkYXRlXCIsXG4gICAgICAgICAgaXNSZXF1aXJlZDogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgIH0pO1xuXG4gICAgICBleHBlY3QocmVzdWx0LmlzRmFpbHVyZSkudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChyZXN1bHQuZXJyb3IpLnRvQ29udGFpbihcIkRhdGUgbXVzdCBiZSBhIHZhbGlkIGRhdGVcIik7XG4gICAgfSk7XG5cbiAgICBpdChcInNob3VsZCB2YWxpZGF0ZSBjdXN0b20gcmVnZXggcGF0dGVybnNcIiwgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdmFsaWRVdWlkID0gdGVzdEFzc2V0LmdldElkKCkudG9TdHJpbmcoKTtcblxuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdXNlQ2FzZS5leGVjdXRlKHtcbiAgICAgICAgYXNzZXRJZDogdmFsaWRVdWlkLFxuICAgICAgICBwcm9wZXJ0eU5hbWU6IFwiZW1haWxQcm9wXCIsXG4gICAgICAgIHZhbHVlOiBcImludmFsaWQtZW1haWxcIixcbiAgICAgICAgcHJvcGVydHlEZWZpbml0aW9uOiB7XG4gICAgICAgICAgcHJvcGVydHlOYW1lOiBcImVtYWlsUHJvcFwiLFxuICAgICAgICAgIGxhYmVsOiBcIkVtYWlsXCIsXG4gICAgICAgICAgcmFuZ2U6IFwic3RyaW5nXCIsXG4gICAgICAgICAgaXNSZXF1aXJlZDogdHJ1ZSxcbiAgICAgICAgICB2YWxpZGF0aW9uOiBcIl5bXFxcXHdcXFxcLi1dK0BbXFxcXHdcXFxcLi1dK1xcXFwuXFxcXHcrJFwiLFxuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGV4cGVjdChyZXN1bHQuaXNGYWlsdXJlKS50b0JlKHRydWUpO1xuICAgICAgZXhwZWN0KHJlc3VsdC5lcnJvcikudG9Db250YWluKFwiRW1haWwgZm9ybWF0IGlzIGludmFsaWRcIik7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXSwidmVyc2lvbiI6M30=