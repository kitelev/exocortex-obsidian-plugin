31b8ca14d4ac21f12a5d0ec900797bd8
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.DatacoreQueryEngine = void 0;
const Result_1 = require("../../domain/core/Result");
/**
 * Datacore Query Engine Implementation
 * Adapts the Datacore plugin API to our generic query engine interface
 */
class DatacoreQueryEngine {
    constructor(datacoreApi) {
        this.datacoreApi = datacoreApi;
    }
    getType() {
        return "datacore";
    }
    isAvailable() {
        return !!this.datacoreApi && typeof this.datacoreApi.query === "function";
    }
    async executeQuery(query, context) {
        if (!this.isAvailable()) {
            return Result_1.Result.fail("Datacore is not available");
        }
        try {
            const result = await this.parseAndExecuteQuery(query, context);
            return Result_1.Result.ok(result);
        }
        catch (error) {
            return Result_1.Result.fail(`Datacore query error: ${error}`);
        }
    }
    async renderQuery(container, query, context) {
        if (!this.isAvailable()) {
            return Result_1.Result.fail("Datacore is not available");
        }
        try {
            await this.renderDatacoreQuery(container, query, context);
            return Result_1.Result.ok();
        }
        catch (error) {
            return Result_1.Result.fail(`Datacore render error: ${error}`);
        }
    }
    async getPages(source) {
        if (!this.isAvailable()) {
            return Result_1.Result.fail("Datacore is not available");
        }
        try {
            // Datacore uses different syntax - convert from Dataview format if needed
            const datacoreSource = this.convertDataviewSource(source);
            const result = await this.datacoreApi.query(datacoreSource);
            return Result_1.Result.ok(result ? Array.from(result) : []);
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to get pages: ${error}`);
        }
    }
    async getPageMetadata(path) {
        if (!this.isAvailable()) {
            return Result_1.Result.fail("Datacore is not available");
        }
        try {
            const page = await this.datacoreApi.page(path);
            return Result_1.Result.ok(page || {});
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to get page metadata: ${error}`);
        }
    }
    validateQuery(query) {
        if (!query || query.trim().length === 0) {
            return Result_1.Result.fail("Query cannot be empty");
        }
        // Basic validation for Datacore query syntax
        const trimmedQuery = query.trim().toLowerCase();
        // Datacore supports both Dataview-style queries and its own query language
        const validDataviewStart = ["table", "list", "task", "calendar"];
        const hasValidDataviewStart = validDataviewStart.some((keyword) => trimmedQuery.startsWith(keyword));
        // Datacore also supports SQL-like queries and JavaScript
        const hasDatacorePattern = trimmedQuery.includes("from") ||
            trimmedQuery.includes("select") ||
            trimmedQuery.includes("dc.") ||
            trimmedQuery.includes("datacore.");
        if (!hasValidDataviewStart && !hasDatacorePattern) {
            return Result_1.Result.fail("Query must be valid Dataview or Datacore syntax");
        }
        return Result_1.Result.ok(true);
    }
    async parseAndExecuteQuery(query, context) {
        const trimmedQuery = query.trim();
        const firstLine = trimmedQuery.split("\n")[0].toLowerCase();
        // Check if it's a Dataview-style query that needs conversion
        if (firstLine.startsWith("table")) {
            return await this.executeTableQuery(query, context);
        }
        else if (firstLine.startsWith("list")) {
            return await this.executeListQuery(query, context);
        }
        else if (firstLine.startsWith("task")) {
            return await this.executeTaskQuery(query, context);
        }
        else if (firstLine.startsWith("calendar")) {
            return await this.executeCalendarQuery(query, context);
        }
        else {
            // Execute as native Datacore query or JavaScript
            return await this.executeNativeQuery(query, context);
        }
    }
    async executeTableQuery(query, context) {
        // Convert Dataview table query to Datacore format
        const datacoreQuery = this.convertDataviewTableQuery(query);
        const result = await this.datacoreApi.query(datacoreQuery);
        return {
            type: "table",
            data: Array.from(result),
            columns: this.extractColumnsFromResult(result),
            metadata: {
                originalQuery: query,
                convertedQuery: datacoreQuery,
                engine: "datacore",
            },
        };
    }
    async executeListQuery(query, context) {
        // Convert Dataview list query to Datacore format
        const datacoreQuery = this.convertDataviewListQuery(query);
        const result = await this.datacoreApi.query(datacoreQuery);
        return {
            type: "list",
            data: Array.from(result),
            metadata: {
                originalQuery: query,
                convertedQuery: datacoreQuery,
                engine: "datacore",
            },
        };
    }
    async executeTaskQuery(query, context) {
        // Datacore has different task handling - adapt as needed
        const datacoreQuery = this.convertDataviewTaskQuery(query);
        const result = await this.datacoreApi.query(datacoreQuery);
        return {
            type: "task",
            data: Array.from(result),
            metadata: {
                originalQuery: query,
                convertedQuery: datacoreQuery,
                engine: "datacore",
            },
        };
    }
    async executeCalendarQuery(query, context) {
        // Calendar functionality would need to be implemented based on Datacore capabilities
        return {
            type: "calendar",
            data: [],
            metadata: {
                queryType: "calendar",
                engine: "datacore",
                note: "Calendar queries not yet implemented for Datacore",
            },
        };
    }
    async executeNativeQuery(query, context) {
        // Execute as native Datacore query
        const result = await this.datacoreApi.query(query, context);
        return {
            type: "raw",
            data: Array.isArray(result) ? result : [result],
            metadata: {
                queryType: "native",
                engine: "datacore",
            },
        };
    }
    async renderDatacoreQuery(container, query, context) {
        const dcContainer = container.createDiv({
            cls: "exocortex-datacore-container",
        });
        try {
            const result = await this.parseAndExecuteQuery(query, context);
            switch (result.type) {
                case "table":
                    this.renderTable(dcContainer, result);
                    break;
                case "list":
                    this.renderList(dcContainer, result);
                    break;
                case "task":
                    this.renderTasks(dcContainer, result);
                    break;
                case "calendar":
                    this.renderCalendar(dcContainer, result);
                    break;
                default:
                    this.renderRaw(dcContainer, result);
            }
        }
        catch (error) {
            dcContainer.createEl("p", {
                text: `Datacore execution error: ${error}`,
                cls: "exocortex-error",
            });
        }
    }
    renderTable(container, result) {
        if (!result.data.length) {
            container.createEl("p", {
                text: "No results found",
                cls: "exocortex-empty",
            });
            return;
        }
        const table = container.createEl("table", { cls: "exocortex-table" });
        // Create header
        if (result.columns) {
            const thead = table.createEl("thead");
            const headerRow = thead.createEl("tr");
            result.columns.forEach((col) => {
                headerRow.createEl("th", { text: col });
            });
        }
        // Create body
        const tbody = table.createEl("tbody");
        result.data.forEach((row) => {
            const tr = tbody.createEl("tr");
            if (result.columns) {
                result.columns.forEach((col) => {
                    tr.createEl("td", { text: this.formatCellValue(row[col]) });
                });
            }
            else {
                // Fallback if no columns defined
                Object.values(row).forEach((value) => {
                    tr.createEl("td", { text: this.formatCellValue(value) });
                });
            }
        });
    }
    renderList(container, result) {
        if (!result.data.length) {
            container.createEl("p", {
                text: "No results found",
                cls: "exocortex-empty",
            });
            return;
        }
        const list = container.createEl("ul", { cls: "exocortex-list" });
        result.data.forEach((item) => {
            const li = list.createEl("li");
            li.textContent = this.formatCellValue(item);
        });
    }
    renderTasks(container, result) {
        if (!result.data.length) {
            container.createEl("p", {
                text: "No tasks found",
                cls: "exocortex-empty",
            });
            return;
        }
        const taskList = container.createEl("ul", { cls: "exocortex-task-list" });
        result.data.forEach((task) => {
            const li = taskList.createEl("li");
            const checkbox = li.createEl("input", { type: "checkbox" });
            checkbox.checked = task.completed || false;
            li.appendText(` ${task.text || task.description || "Untitled task"}`);
        });
    }
    renderCalendar(container, result) {
        container.createEl("p", {
            text: "Calendar view not yet implemented for Datacore",
            cls: "exocortex-info",
        });
    }
    renderRaw(container, result) {
        const pre = container.createEl("pre", { cls: "exocortex-raw-result" });
        pre.textContent = JSON.stringify(result.data, null, 2);
    }
    convertDataviewSource(source) {
        // Convert Dataview source format to Datacore format
        // This would need to be implemented based on actual Datacore syntax
        // For now, return as-is and let Datacore handle it
        return source;
    }
    convertDataviewTableQuery(query) {
        // Convert Dataview table query to Datacore equivalent
        // This is a simplified conversion - real implementation would be more sophisticated
        const tableMatch = query.match(/table\s+(.+?)\s+from\s+(.+?)(?:\s+where\s+(.+?))?$/s);
        if (!tableMatch) {
            return query; // Return original if can't parse
        }
        const [, fields, source, where] = tableMatch;
        let datacoreQuery = `SELECT ${fields.trim()} FROM ${source.trim()}`;
        if (where) {
            datacoreQuery += ` WHERE ${where.trim()}`;
        }
        return datacoreQuery;
    }
    convertDataviewListQuery(query) {
        // Convert Dataview list query to Datacore equivalent
        const fromMatch = query.match(/from\s+(.+?)(?:\s+where\s+(.+?))?$/s);
        if (!fromMatch) {
            return query;
        }
        const [, source, where] = fromMatch;
        let datacoreQuery = `SELECT file FROM ${source.trim()}`;
        if (where) {
            datacoreQuery += ` WHERE ${where.trim()}`;
        }
        return datacoreQuery;
    }
    convertDataviewTaskQuery(query) {
        // Convert Dataview task query to Datacore equivalent
        // This would need to be implemented based on how Datacore handles tasks
        return query; // Placeholder
    }
    extractColumnsFromResult(result) {
        if (!result || !Array.isArray(result) || result.length === 0) {
            return undefined;
        }
        const firstRow = result[0];
        if (typeof firstRow === "object" && firstRow !== null) {
            return Object.keys(firstRow);
        }
        return undefined;
    }
    formatCellValue(value) {
        if (value === null || value === undefined) {
            return "";
        }
        if (Array.isArray(value)) {
            return value.map((v) => this.formatCellValue(v)).join(", ");
        }
        if (typeof value === "object") {
            // Handle links, dates, and other objects
            if (value.path) {
                return `[[${value.path}]]`;
            }
            return JSON.stringify(value);
        }
        return String(value);
    }
}
exports.DatacoreQueryEngine = DatacoreQueryEngine;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2luZnJhc3RydWN0dXJlL3F1ZXJ5LWVuZ2luZXMvRGF0YWNvcmVRdWVyeUVuZ2luZS50cyIsIm1hcHBpbmdzIjoiOzs7QUFNQSxxREFBa0Q7QUFFbEQ7OztHQUdHO0FBQ0gsTUFBYSxtQkFBbUI7SUFDOUIsWUFBb0IsV0FBaUI7UUFBakIsZ0JBQVcsR0FBWCxXQUFXLENBQU07SUFBRyxDQUFDO0lBRWxDLE9BQU87UUFDWixPQUFPLFVBQVUsQ0FBQztJQUNwQixDQUFDO0lBRU0sV0FBVztRQUNoQixPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxJQUFJLE9BQU8sSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEtBQUssVUFBVSxDQUFDO0lBQzVFLENBQUM7SUFFTSxLQUFLLENBQUMsWUFBWSxDQUN2QixLQUFhLEVBQ2IsT0FBc0I7UUFFdEIsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsRUFBRTtZQUN2QixPQUFPLGVBQU0sQ0FBQyxJQUFJLENBQWMsMkJBQTJCLENBQUMsQ0FBQztTQUM5RDtRQUVELElBQUk7WUFDRixNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDL0QsT0FBTyxlQUFNLENBQUMsRUFBRSxDQUFjLE1BQU0sQ0FBQyxDQUFDO1NBQ3ZDO1FBQUMsT0FBTyxLQUFLLEVBQUU7WUFDZCxPQUFPLGVBQU0sQ0FBQyxJQUFJLENBQWMseUJBQXlCLEtBQUssRUFBRSxDQUFDLENBQUM7U0FDbkU7SUFDSCxDQUFDO0lBRU0sS0FBSyxDQUFDLFdBQVcsQ0FDdEIsU0FBc0IsRUFDdEIsS0FBYSxFQUNiLE9BQXNCO1FBRXRCLElBQUksQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLEVBQUU7WUFDdkIsT0FBTyxlQUFNLENBQUMsSUFBSSxDQUFPLDJCQUEyQixDQUFDLENBQUM7U0FDdkQ7UUFFRCxJQUFJ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QUFFO1lBQ3JELE9BQU8sTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUM5QjtRQUVELE9BQU8sU0FBUyxDQUFDO0lBQ25CLENBQUM7SUFFTyxlQUFlLENBQUMsS0FBVTtRQUNoQyxJQUFJLEtBQUssS0FBSyxJQUFJLElBQUksS0FBSyxLQUFLLFNBQVMsRUFBRTtZQUN6QyxPQUFPLEVBQUUsQ0FBQztTQUNYO1FBRUQsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFO1lBQ3hCLE9BQU8sS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM3RDtRQUVELElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxFQUFFO1lBQzdCLHlDQUF5QztZQUN6QyxJQUFJLEtBQUssQ0FBQyxJQUFJLEVBQUU7Z0JBQ2QsT0FBTyxLQUFLLEtBQUssQ0FBQyxJQUFJLElBQUksQ0FBQzthQUM1QjtZQUNELE9BQU8sSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUM5QjtRQUVELE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7Q0FDRjtBQTVhRCxrREE0YUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2luZnJhc3RydWN0dXJlL3F1ZXJ5LWVuZ2luZXMvRGF0YWNvcmVRdWVyeUVuZ2luZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBJUXVlcnlFbmdpbmUsXG4gIFF1ZXJ5RW5naW5lVHlwZSxcbiAgUXVlcnlSZXN1bHQsXG4gIFF1ZXJ5Q29udGV4dCxcbn0gZnJvbSBcIi4uLy4uL2RvbWFpbi9wb3J0cy9JUXVlcnlFbmdpbmVcIjtcbmltcG9ydCB7IFJlc3VsdCB9IGZyb20gXCIuLi8uLi9kb21haW4vY29yZS9SZXN1bHRcIjtcblxuLyoqXG4gKiBEYXRhY29yZSBRdWVyeSBFbmdpbmUgSW1wbGVtZW50YXRpb25cbiAqIEFkYXB0cyB0aGUgRGF0YWNvcmUgcGx1Z2luIEFQSSB0byBvdXIgZ2VuZXJpYyBxdWVyeSBlbmdpbmUgaW50ZXJmYWNlXG4gKi9cbmV4cG9ydCBjbGFzcyBEYXRhY29yZVF1ZXJ5RW5naW5lIGltcGxlbWVudHMgSVF1ZXJ5RW5naW5lIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBkYXRhY29yZUFwaT86IGFueSkge31cblxuICBwdWJsaWMgZ2V0VHlwZSgpOiBRdWVyeUVuZ2luZVR5cGUge1xuICAgIHJldHVybiBcImRhdGFjb3JlXCI7XG4gIH1cblxuICBwdWJsaWMgaXNBdmFpbGFibGUoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICEhdGhpcy5kYXRhY29yZUFwaSAmJiB0eXBlb2YgdGhpcy5kYXRhY29yZUFwaS5xdWVyeSA9PT0gXCJmdW5jdGlvblwiO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGV4ZWN1dGVRdWVyeShcbiAgICBxdWVyeTogc3RyaW5nLFxuICAgIGNvbnRleHQ/OiBRdWVyeUNvbnRleHQsXG4gICk6IFByb21pc2U8UmVzdWx0PFF1ZXJ5UmVzdWx0Pj4ge1xuICAgIGlmICghdGhpcy5pc0F2YWlsYWJsZSgpKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8UXVlcnlSZXN1bHQ+KFwiRGF0YWNvcmUgaXMgbm90IGF2YWlsYWJsZVwiKTtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5wYXJzZUFuZEV4ZWN1dGVRdWVyeShxdWVyeSwgY29udGV4dCk7XG4gICAgICByZXR1cm4gUmVzdWx0Lm9rPFF1ZXJ5UmVzdWx0PihyZXN1bHQpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8UXVlcnlSZXN1bHQ+KGBEYXRhY29yZSBxdWVyeSBlcnJvcjogJHtlcnJvcn1gKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgcmVuZGVyUXVlcnkoXG4gICAgY29udGFpbmVyOiBIVE1MRWxlbWVudCxcbiAgICBxdWVyeTogc3RyaW5nLFxuICAgIGNvbnRleHQ/OiBRdWVyeUNvbnRleHQsXG4gICk6IFByb21pc2U8UmVzdWx0PHZvaWQ+PiB7XG4gICAgaWYgKCF0aGlzLmlzQXZhaWxhYmxlKCkpIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDx2b2lkPihcIkRhdGFjb3JlIGlzIG5vdCBhdmFpbGFibGVcIik7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMucmVuZGVyRGF0YWNvcmVRdWVyeShjb250YWluZXIsIHF1ZXJ5LCBjb250ZXh0KTtcbiAgICAgIHJldHVybiBSZXN1bHQub2s8dm9pZD4oKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPHZvaWQ+KGBEYXRhY29yZSByZW5kZXIgZXJyb3I6ICR7ZXJyb3J9YCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldFBhZ2VzKHNvdXJjZTogc3RyaW5nKTogUHJvbWlzZTxSZXN1bHQ8YW55W10+PiB7XG4gICAgaWYgKCF0aGlzLmlzQXZhaWxhYmxlKCkpIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxhbnlbXT4oXCJEYXRhY29yZSBpcyBub3QgYXZhaWxhYmxlXCIpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICAvLyBEYXRhY29yZSB1c2VzIGRpZmZlcmVudCBzeW50YXggLSBjb252ZXJ0IGZyb20gRGF0YXZpZXcgZm9ybWF0IGlmIG5lZWRlZFxuICAgICAgY29uc3QgZGF0YWNvcmVTb3VyY2UgPSB0aGlzLmNvbnZlcnREYXRhdmlld1NvdXJjZShzb3VyY2UpO1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5kYXRhY29yZUFwaS5xdWVyeShkYXRhY29yZVNvdXJjZSk7XG4gICAgICByZXR1cm4gUmVzdWx0Lm9rPGFueVtdPihyZXN1bHQgPyBBcnJheS5mcm9tKHJlc3VsdCkgOiBbXSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxhbnlbXT4oYEZhaWxlZCB0byBnZXQgcGFnZXM6ICR7ZXJyb3J9YCk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIGdldFBhZ2VNZXRhZGF0YShcbiAgICBwYXRoOiBzdHJpbmcsXG4gICk6IFByb21pc2U8UmVzdWx0PFJlY29yZDxzdHJpbmcsIGFueT4+PiB7XG4gICAgaWYgKCF0aGlzLmlzQXZhaWxhYmxlKCkpIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxSZWNvcmQ8c3RyaW5nLCBhbnk+PihcIkRhdGFjb3JlIGlzIG5vdCBhdmFpbGFibGVcIik7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHBhZ2UgPSBhd2FpdCB0aGlzLmRhdGFjb3JlQXBpLnBhZ2UocGF0aCk7XG4gICAgICByZXR1cm4gUmVzdWx0Lm9rPFJlY29yZDxzdHJpbmcsIGFueT4+KHBhZ2UgfHwge30pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8UmVjb3JkPHN0cmluZywgYW55Pj4oXG4gICAgICAgIGBGYWlsZWQgdG8gZ2V0IHBhZ2UgbWV0YWRhdGE6ICR7ZXJyb3J9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIHZhbGlkYXRlUXVlcnkocXVlcnk6IHN0cmluZyk6IFJlc3VsdDxib29sZWFuPiB7XG4gICAgaWYgKCFxdWVyeSB8fCBxdWVyeS50cmltKCkubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8Ym9vbGVhbj4oXCJRdWVyeSBjYW5ub3QgYmUgZW1wdHlcIik7XG4gICAgfVxuXG4gICAgLy8gQmFzaWMgdmFsaWRhdGlvbiBmb3IgRGF0YWNvcmUgcXVlcnkgc3ludGF4XG4gICAgY29uc3QgdHJpbW1lZFF1ZXJ5ID0gcXVlcnkudHJpbSgpLnRvTG93ZXJDYXNlKCk7XG5cbiAgICAvLyBEYXRhY29yZSBzdXBwb3J0cyBib3RoIERhdGF2aWV3LXN0eWxlIHF1ZXJpZXMgYW5kIGl0cyBvd24gcXVlcnkgbGFuZ3VhZ2VcbiAgICBjb25zdCB2YWxpZERhdGF2aWV3U3RhcnQgPSBbXCJ0YWJsZVwiLCBcImxpc3RcIiwgXCJ0YXNrXCIsIFwiY2FsZW5kYXJcIl07XG4gICAgY29uc3QgaGFzVmFsaWREYXRhdmlld1N0YXJ0ID0gdmFsaWREYXRhdmlld1N0YXJ0LnNvbWUoKGtleXdvcmQpID0+XG4gICAgICB0cmltbWVkUXVlcnkuc3RhcnRzV2l0aChrZXl3b3JkKSxcbiAgICApO1xuXG4gICAgLy8gRGF0YWNvcmUgYWxzbyBzdXBwb3J0cyBTUUwtbGlrZSBxdWVyaWVzIGFuZCBKYXZhU2NyaXB0XG4gICAgY29uc3QgaGFzRGF0YWNvcmVQYXR0ZXJuID1cbiAgICAgIHRyaW1tZWRRdWVyeS5pbmNsdWRlcyhcImZyb21cIikgfHxcbiAgICAgIHRyaW1tZWRRdWVyeS5pbmNsdWRlcyhcInNlbGVjdFwiKSB8fFxuICAgICAgdHJpbW1lZFF1ZXJ5LmluY2x1ZGVzKFwiZGMuXCIpIHx8XG4gICAgICB0cmltbWVkUXVlcnkuaW5jbHVkZXMoXCJkYXRhY29yZS5cIik7XG5cbiAgICBpZiAoIWhhc1ZhbGlkRGF0YXZpZXdTdGFydCAmJiAhaGFzRGF0YWNvcmVQYXR0ZXJuKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8Ym9vbGVhbj4oXG4gICAgICAgIFwiUXVlcnkgbXVzdCBiZSB2YWxpZCBEYXRhdmlldyBvciBEYXRhY29yZSBzeW50YXhcIixcbiAgICAgICk7XG4gICAgfVxuXG4gICAgcmV0dXJuIFJlc3VsdC5vazxib29sZWFuPih0cnVlKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcGFyc2VBbmRFeGVjdXRlUXVlcnkoXG4gICAgcXVlcnk6IHN0cmluZyxcbiAgICBjb250ZXh0PzogUXVlcnlDb250ZXh0LFxuICApOiBQcm9taXNlPFF1ZXJ5UmVzdWx0PiB7XG4gICAgY29uc3QgdHJpbW1lZFF1ZXJ5ID0gcXVlcnkudHJpbSgpO1xuICAgIGNvbnN0IGZpcnN0TGluZSA9IHRyaW1tZWRRdWVyeS5zcGxpdChcIlxcblwiKVswXS50b0xvd2VyQ2FzZSgpO1xuXG4gICAgLy8gQ2hlY2sgaWYgaXQncyBhIERhdGF2aWV3LXN0eWxlIHF1ZXJ5IHRoYXQgbmVlZHMgY29udmVyc2lvblxuICAgIGlmIChmaXJzdExpbmUuc3RhcnRzV2l0aChcInRhYmxlXCIpKSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlVGFibGVRdWVyeShxdWVyeSwgY29udGV4dCk7XG4gICAgfSBlbHNlIGlmIChmaXJzdExpbmUuc3RhcnRzV2l0aChcImxpc3RcIikpIHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVMaXN0UXVlcnkocXVlcnksIGNvbnRleHQpO1xuICAgIH0gZWxzZSBpZiAoZmlyc3RMaW5lLnN0YXJ0c1dpdGgoXCJ0YXNrXCIpKSB7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlVGFza1F1ZXJ5KHF1ZXJ5LCBjb250ZXh0KTtcbiAgICB9IGVsc2UgaWYgKGZpcnN0TGluZS5zdGFydHNXaXRoKFwiY2FsZW5kYXJcIikpIHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLmV4ZWN1dGVDYWxlbmRhclF1ZXJ5KHF1ZXJ5LCBjb250ZXh0KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gRXhlY3V0ZSBhcyBuYXRpdmUgRGF0YWNvcmUgcXVlcnkgb3IgSmF2YVNjcmlwdFxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZU5hdGl2ZVF1ZXJ5KHF1ZXJ5LCBjb250ZXh0KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGV4ZWN1dGVUYWJsZVF1ZXJ5KFxuICAgIHF1ZXJ5OiBzdHJpbmcsXG4gICAgY29udGV4dD86IFF1ZXJ5Q29udGV4dCxcbiAgKTogUHJvbWlzZTxRdWVyeVJlc3VsdD4ge1xuICAgIC8vIENvbnZlcnQgRGF0YXZpZXcgdGFibGUgcXVlcnkgdG8gRGF0YWNvcmUgZm9ybWF0XG4gICAgY29uc3QgZGF0YWNvcmVRdWVyeSA9IHRoaXMuY29udmVydERhdGF2aWV3VGFibGVRdWVyeShxdWVyeSk7XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmRhdGFjb3JlQXBpLnF1ZXJ5KGRhdGFjb3JlUXVlcnkpO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6IFwidGFibGVcIixcbiAgICAgIGRhdGE6IEFycmF5LmZyb20ocmVzdWx0KSxcbiAgICAgIGNvbHVtbnM6IHRoaXMuZXh0cmFjdENvbHVtbnNGcm9tUmVzdWx0KHJlc3VsdCksXG4gICAgICBtZXRhZGF0YToge1xuICAgICAgICBvcmlnaW5hbFF1ZXJ5OiBxdWVyeSxcbiAgICAgICAgY29udmVydGVkUXVlcnk6IGRhdGFjb3JlUXVlcnksXG4gICAgICAgIGVuZ2luZTogXCJkYXRhY29yZVwiLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBleGVjdXRlTGlzdFF1ZXJ5KFxuICAgIHF1ZXJ5OiBzdHJpbmcsXG4gICAgY29udGV4dD86IFF1ZXJ5Q29udGV4dCxcbiAgKTogUHJvbWlzZTxRdWVyeVJlc3VsdD4ge1xuICAgIC8vIENvbnZlcnQgRGF0YXZpZXcgbGlzdCBxdWVyeSB0byBEYXRhY29yZSBmb3JtYXRcbiAgICBjb25zdCBkYXRhY29yZVF1ZXJ5ID0gdGhpcy5jb252ZXJ0RGF0YXZpZXdMaXN0UXVlcnkocXVlcnkpO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5kYXRhY29yZUFwaS5xdWVyeShkYXRhY29yZVF1ZXJ5KTtcblxuICAgIHJldHVybiB7XG4gICAgICB0eXBlOiBcImxpc3RcIixcbiAgICAgIGRhdGE6IEFycmF5LmZyb20ocmVzdWx0KSxcbiAgICAgIG1ldGFkYXRhOiB7XG4gICAgICAgIG9yaWdpbmFsUXVlcnk6IHF1ZXJ5LFxuICAgICAgICBjb252ZXJ0ZWRRdWVyeTogZGF0YWNvcmVRdWVyeSxcbiAgICAgICAgZW5naW5lOiBcImRhdGFjb3JlXCIsXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGV4ZWN1dGVUYXNrUXVlcnkoXG4gICAgcXVlcnk6IHN0cmluZyxcbiAgICBjb250ZXh0PzogUXVlcnlDb250ZXh0LFxuICApOiBQcm9taXNlPFF1ZXJ5UmVzdWx0PiB7XG4gICAgLy8gRGF0YWNvcmUgaGFzIGRpZmZlcmVudCB0YXNrIGhhbmRsaW5nIC0gYWRhcHQgYXMgbmVlZGVkXG4gICAgY29uc3QgZGF0YWNvcmVRdWVyeSA9IHRoaXMuY29udmVydERhdGF2aWV3VGFza1F1ZXJ5KHF1ZXJ5KTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuZGF0YWNvcmVBcGkucXVlcnkoZGF0YWNvcmVRdWVyeSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogXCJ0YXNrXCIsXG4gICAgICBkYXRhOiBBcnJheS5mcm9tKHJlc3VsdCksXG4gICAgICBtZXRhZGF0YToge1xuICAgICAgICBvcmlnaW5hbFF1ZXJ5OiBxdWVyeSxcbiAgICAgICAgY29udmVydGVkUXVlcnk6IGRhdGFjb3JlUXVlcnksXG4gICAgICAgIGVuZ2luZTogXCJkYXRhY29yZVwiLFxuICAgICAgfSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBleGVjdXRlQ2FsZW5kYXJRdWVyeShcbiAgICBxdWVyeTogc3RyaW5nLFxuICAgIGNvbnRleHQ/OiBRdWVyeUNvbnRleHQsXG4gICk6IFByb21pc2U8UXVlcnlSZXN1bHQ+IHtcbiAgICAvLyBDYWxlbmRhciBmdW5jdGlvbmFsaXR5IHdvdWxkIG5lZWQgdG8gYmUgaW1wbGVtZW50ZWQgYmFzZWQgb24gRGF0YWNvcmUgY2FwYWJpbGl0aWVzXG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6IFwiY2FsZW5kYXJcIixcbiAgICAgIGRhdGE6IFtdLFxuICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgcXVlcnlUeXBlOiBcImNhbGVuZGFyXCIsXG4gICAgICAgIGVuZ2luZTogXCJkYXRhY29yZVwiLFxuICAgICAgICBub3RlOiBcIkNhbGVuZGFyIHF1ZXJpZXMgbm90IHlldCBpbXBsZW1lbnRlZCBmb3IgRGF0YWNvcmVcIixcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZXhlY3V0ZU5hdGl2ZVF1ZXJ5KFxuICAgIHF1ZXJ5OiBzdHJpbmcsXG4gICAgY29udGV4dD86IFF1ZXJ5Q29udGV4dCxcbiAgKTogUHJvbWlzZTxRdWVyeVJlc3VsdD4ge1xuICAgIC8vIEV4ZWN1dGUgYXMgbmF0aXZlIERhdGFjb3JlIHF1ZXJ5XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5kYXRhY29yZUFwaS5xdWVyeShxdWVyeSwgY29udGV4dCk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgdHlwZTogXCJyYXdcIixcbiAgICAgIGRhdGE6IEFycmF5LmlzQXJyYXkocmVzdWx0KSA/IHJlc3VsdCA6IFtyZXN1bHRdLFxuICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgcXVlcnlUeXBlOiBcIm5hdGl2ZVwiLFxuICAgICAgICBlbmdpbmU6IFwiZGF0YWNvcmVcIixcbiAgICAgIH0sXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgcmVuZGVyRGF0YWNvcmVRdWVyeShcbiAgICBjb250YWluZXI6IEhUTUxFbGVtZW50LFxuICAgIHF1ZXJ5OiBzdHJpbmcsXG4gICAgY29udGV4dD86IFF1ZXJ5Q29udGV4dCxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZGNDb250YWluZXIgPSBjb250YWluZXIuY3JlYXRlRGl2KHtcbiAgICAgIGNsczogXCJleG9jb3J0ZXgtZGF0YWNvcmUtY29udGFpbmVyXCIsXG4gICAgfSk7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5wYXJzZUFuZEV4ZWN1dGVRdWVyeShxdWVyeSwgY29udGV4dCk7XG5cbiAgICAgIHN3aXRjaCAocmVzdWx0LnR5cGUpIHtcbiAgICAgICAgY2FzZSBcInRhYmxlXCI6XG4gICAgICAgICAgdGhpcy5yZW5kZXJUYWJsZShkY0NvbnRhaW5lciwgcmVzdWx0KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBcImxpc3RcIjpcbiAgICAgICAgICB0aGlzLnJlbmRlckxpc3QoZGNDb250YWluZXIsIHJlc3VsdCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgXCJ0YXNrXCI6XG4gICAgICAgICAgdGhpcy5yZW5kZXJUYXNrcyhkY0NvbnRhaW5lciwgcmVzdWx0KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBcImNhbGVuZGFyXCI6XG4gICAgICAgICAgdGhpcy5yZW5kZXJDYWxlbmRhcihkY0NvbnRhaW5lciwgcmVzdWx0KTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICB0aGlzLnJlbmRlclJhdyhkY0NvbnRhaW5lciwgcmVzdWx0KTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgZGNDb250YWluZXIuY3JlYXRlRWwoXCJwXCIsIHtcbiAgICAgICAgdGV4dDogYERhdGFjb3JlIGV4ZWN1dGlvbiBlcnJvcjogJHtlcnJvcn1gLFxuICAgICAgICBjbHM6IFwiZXhvY29ydGV4LWVycm9yXCIsXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHJlbmRlclRhYmxlKGNvbnRhaW5lcjogSFRNTEVsZW1lbnQsIHJlc3VsdDogUXVlcnlSZXN1bHQpOiB2b2lkIHtcbiAgICBpZiAoIXJlc3VsdC5kYXRhLmxlbmd0aCkge1xuICAgICAgY29udGFpbmVyLmNyZWF0ZUVsKFwicFwiLCB7XG4gICAgICAgIHRleHQ6IFwiTm8gcmVzdWx0cyBmb3VuZFwiLFxuICAgICAgICBjbHM6IFwiZXhvY29ydGV4LWVtcHR5XCIsXG4gICAgICB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB0YWJsZSA9IGNvbnRhaW5lci5jcmVhdGVFbChcInRhYmxlXCIsIHsgY2xzOiBcImV4b2NvcnRleC10YWJsZVwiIH0pO1xuXG4gICAgLy8gQ3JlYXRlIGhlYWRlclxuICAgIGlmIChyZXN1bHQuY29sdW1ucykge1xuICAgICAgY29uc3QgdGhlYWQgPSB0YWJsZS5jcmVhdGVFbChcInRoZWFkXCIpO1xuICAgICAgY29uc3QgaGVhZGVyUm93ID0gdGhlYWQuY3JlYXRlRWwoXCJ0clwiKTtcbiAgICAgIHJlc3VsdC5jb2x1bW5zLmZvckVhY2goKGNvbCkgPT4ge1xuICAgICAgICBoZWFkZXJSb3cuY3JlYXRlRWwoXCJ0aFwiLCB7IHRleHQ6IGNvbCB9KTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIENyZWF0ZSBib2R5XG4gICAgY29uc3QgdGJvZHkgPSB0YWJsZS5jcmVhdGVFbChcInRib2R5XCIpO1xuICAgIHJlc3VsdC5kYXRhLmZvckVhY2goKHJvdzogYW55KSA9PiB7XG4gICAgICBjb25zdCB0ciA9IHRib2R5LmNyZWF0ZUVsKFwidHJcIik7XG4gICAgICBpZiAocmVzdWx0LmNvbHVtbnMpIHtcbiAgICAgICAgcmVzdWx0LmNvbHVtbnMuZm9yRWFjaCgoY29sKSA9PiB7XG4gICAgICAgICAgdHIuY3JlYXRlRWwoXCJ0ZFwiLCB7IHRleHQ6IHRoaXMuZm9ybWF0Q2VsbFZhbHVlKHJvd1tjb2xdKSB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBGYWxsYmFjayBpZiBubyBjb2x1bW5zIGRlZmluZWRcbiAgICAgICAgT2JqZWN0LnZhbHVlcyhyb3cpLmZvckVhY2goKHZhbHVlKSA9PiB7XG4gICAgICAgICAgdHIuY3JlYXRlRWwoXCJ0ZFwiLCB7IHRleHQ6IHRoaXMuZm9ybWF0Q2VsbFZhbHVlKHZhbHVlKSB9KTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHJlbmRlckxpc3QoY29udGFpbmVyOiBIVE1MRWxlbWVudCwgcmVzdWx0OiBRdWVyeVJlc3VsdCk6IHZvaWQge1xuICAgIGlmICghcmVzdWx0LmRhdGEubGVuZ3RoKSB7XG4gICAgICBjb250YWluZXIuY3JlYXRlRWwoXCJwXCIsIHtcbiAgICAgICAgdGV4dDogXCJObyByZXN1bHRzIGZvdW5kXCIsXG4gICAgICAgIGNsczogXCJleG9jb3J0ZXgtZW1wdHlcIixcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGxpc3QgPSBjb250YWluZXIuY3JlYXRlRWwoXCJ1bFwiLCB7IGNsczogXCJleG9jb3J0ZXgtbGlzdFwiIH0pO1xuICAgIHJlc3VsdC5kYXRhLmZvckVhY2goKGl0ZW06IGFueSkgPT4ge1xuICAgICAgY29uc3QgbGkgPSBsaXN0LmNyZWF0ZUVsKFwibGlcIik7XG4gICAgICBsaS50ZXh0Q29udGVudCA9IHRoaXMuZm9ybWF0Q2VsbFZhbHVlKGl0ZW0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSByZW5kZXJUYXNrcyhjb250YWluZXI6IEhUTUxFbGVtZW50LCByZXN1bHQ6IFF1ZXJ5UmVzdWx0KTogdm9pZCB7XG4gICAgaWYgKCFyZXN1bHQuZGF0YS5sZW5ndGgpIHtcbiAgICAgIGNvbnRhaW5lci5jcmVhdGVFbChcInBcIiwge1xuICAgICAgICB0ZXh0OiBcIk5vIHRhc2tzIGZvdW5kXCIsXG4gICAgICAgIGNsczogXCJleG9jb3J0ZXgtZW1wdHlcIixcbiAgICAgIH0pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHRhc2tMaXN0ID0gY29udGFpbmVyLmNyZWF0ZUVsKFwidWxcIiwgeyBjbHM6IFwiZXhvY29ydGV4LXRhc2stbGlzdFwiIH0pO1xuICAgIHJlc3VsdC5kYXRhLmZvckVhY2goKHRhc2s6IGFueSkgPT4ge1xuICAgICAgY29uc3QgbGkgPSB0YXNrTGlzdC5jcmVhdGVFbChcImxpXCIpO1xuICAgICAgY29uc3QgY2hlY2tib3ggPSBsaS5jcmVhdGVFbChcImlucHV0XCIsIHsgdHlwZTogXCJjaGVja2JveFwiIH0pO1xuICAgICAgY2hlY2tib3guY2hlY2tlZCA9IHRhc2suY29tcGxldGVkIHx8IGZhbHNlO1xuICAgICAgbGkuYXBwZW5kVGV4dChgICR7dGFzay50ZXh0IHx8IHRhc2suZGVzY3JpcHRpb24gfHwgXCJVbnRpdGxlZCB0YXNrXCJ9YCk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHJlbmRlckNhbGVuZGFyKGNvbnRhaW5lcjogSFRNTEVsZW1lbnQsIHJlc3VsdDogUXVlcnlSZXN1bHQpOiB2b2lkIHtcbiAgICBjb250YWluZXIuY3JlYXRlRWwoXCJwXCIsIHtcbiAgICAgIHRleHQ6IFwiQ2FsZW5kYXIgdmlldyBub3QgeWV0IGltcGxlbWVudGVkIGZvciBEYXRhY29yZVwiLFxuICAgICAgY2xzOiBcImV4b2NvcnRleC1pbmZvXCIsXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIHJlbmRlclJhdyhjb250YWluZXI6IEhUTUxFbGVtZW50LCByZXN1bHQ6IFF1ZXJ5UmVzdWx0KTogdm9pZCB7XG4gICAgY29uc3QgcHJlID0gY29udGFpbmVyLmNyZWF0ZUVsKFwicHJlXCIsIHsgY2xzOiBcImV4b2NvcnRleC1yYXctcmVzdWx0XCIgfSk7XG4gICAgcHJlLnRleHRDb250ZW50ID0gSlNPTi5zdHJpbmdpZnkocmVzdWx0LmRhdGEsIG51bGwsIDIpO1xuICB9XG5cbiAgcHJpdmF0ZSBjb252ZXJ0RGF0YXZpZXdTb3VyY2Uoc291cmNlOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIC8vIENvbnZlcnQgRGF0YXZpZXcgc291cmNlIGZvcm1hdCB0byBEYXRhY29yZSBmb3JtYXRcbiAgICAvLyBUaGlzIHdvdWxkIG5lZWQgdG8gYmUgaW1wbGVtZW50ZWQgYmFzZWQgb24gYWN0dWFsIERhdGFjb3JlIHN5bnRheFxuICAgIC8vIEZvciBub3csIHJldHVybiBhcy1pcyBhbmQgbGV0IERhdGFjb3JlIGhhbmRsZSBpdFxuICAgIHJldHVybiBzb3VyY2U7XG4gIH1cblxuICBwcml2YXRlIGNvbnZlcnREYXRhdmlld1RhYmxlUXVlcnkocXVlcnk6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgLy8gQ29udmVydCBEYXRhdmlldyB0YWJsZSBxdWVyeSB0byBEYXRhY29yZSBlcXVpdmFsZW50XG4gICAgLy8gVGhpcyBpcyBhIHNpbXBsaWZpZWQgY29udmVyc2lvbiAtIHJlYWwgaW1wbGVtZW50YXRpb24gd291bGQgYmUgbW9yZSBzb3BoaXN0aWNhdGVkXG5cbiAgICBjb25zdCB0YWJsZU1hdGNoID0gcXVlcnkubWF0Y2goXG4gICAgICAvdGFibGVcXHMrKC4rPylcXHMrZnJvbVxccysoLis/KSg/Olxccyt3aGVyZVxccysoLis/KSk/JC9zLFxuICAgICk7XG5cbiAgICBpZiAoIXRhYmxlTWF0Y2gpIHtcbiAgICAgIHJldHVybiBxdWVyeTsgLy8gUmV0dXJuIG9yaWdpbmFsIGlmIGNhbid0IHBhcnNlXG4gICAgfVxuXG4gICAgY29uc3QgWywgZmllbGRzLCBzb3VyY2UsIHdoZXJlXSA9IHRhYmxlTWF0Y2g7XG5cbiAgICBsZXQgZGF0YWNvcmVRdWVyeSA9IGBTRUxFQ1QgJHtmaWVsZHMudHJpbSgpfSBGUk9NICR7c291cmNlLnRyaW0oKX1gO1xuXG4gICAgaWYgKHdoZXJlKSB7XG4gICAgICBkYXRhY29yZVF1ZXJ5ICs9IGAgV0hFUkUgJHt3aGVyZS50cmltKCl9YDtcbiAgICB9XG5cbiAgICByZXR1cm4gZGF0YWNvcmVRdWVyeTtcbiAgfVxuXG4gIHByaXZhdGUgY29udmVydERhdGF2aWV3TGlzdFF1ZXJ5KHF1ZXJ5OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIC8vIENvbnZlcnQgRGF0YXZpZXcgbGlzdCBxdWVyeSB0byBEYXRhY29yZSBlcXVpdmFsZW50XG4gICAgY29uc3QgZnJvbU1hdGNoID0gcXVlcnkubWF0Y2goL2Zyb21cXHMrKC4rPykoPzpcXHMrd2hlcmVcXHMrKC4rPykpPyQvcyk7XG5cbiAgICBpZiAoIWZyb21NYXRjaCkge1xuICAgICAgcmV0dXJuIHF1ZXJ5O1xuICAgIH1cblxuICAgIGNvbnN0IFssIHNvdXJjZSwgd2hlcmVdID0gZnJvbU1hdGNoO1xuXG4gICAgbGV0IGRhdGFjb3JlUXVlcnkgPSBgU0VMRUNUIGZpbGUgRlJPTSAke3NvdXJjZS50cmltKCl9YDtcblxuICAgIGlmICh3aGVyZSkge1xuICAgICAgZGF0YWNvcmVRdWVyeSArPSBgIFdIRVJFICR7d2hlcmUudHJpbSgpfWA7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRhdGFjb3JlUXVlcnk7XG4gIH1cblxuICBwcml2YXRlIGNvbnZlcnREYXRhdmlld1Rhc2tRdWVyeShxdWVyeTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAvLyBDb252ZXJ0IERhdGF2aWV3IHRhc2sgcXVlcnkgdG8gRGF0YWNvcmUgZXF1aXZhbGVudFxuICAgIC8vIFRoaXMgd291bGQgbmVlZCB0byBiZSBpbXBsZW1lbnRlZCBiYXNlZCBvbiBob3cgRGF0YWNvcmUgaGFuZGxlcyB0YXNrc1xuICAgIHJldHVybiBxdWVyeTsgLy8gUGxhY2Vob2xkZXJcbiAgfVxuXG4gIHByaXZhdGUgZXh0cmFjdENvbHVtbnNGcm9tUmVzdWx0KHJlc3VsdDogYW55KTogc3RyaW5nW10gfCB1bmRlZmluZWQge1xuICAgIGlmICghcmVzdWx0IHx8ICFBcnJheS5pc0FycmF5KHJlc3VsdCkgfHwgcmVzdWx0Lmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBjb25zdCBmaXJzdFJvdyA9IHJlc3VsdFswXTtcbiAgICBpZiAodHlwZW9mIGZpcnN0Um93ID09PSBcIm9iamVjdFwiICYmIGZpcnN0Um93ICE9PSBudWxsKSB7XG4gICAgICByZXR1cm4gT2JqZWN0LmtleXMoZmlyc3RSb3cpO1xuICAgIH1cblxuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIGZvcm1hdENlbGxWYWx1ZSh2YWx1ZTogYW55KTogc3RyaW5nIHtcbiAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkge1xuICAgICAgcmV0dXJuIFwiXCI7XG4gICAgfVxuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICByZXR1cm4gdmFsdWUubWFwKCh2KSA9PiB0aGlzLmZvcm1hdENlbGxWYWx1ZSh2KSkuam9pbihcIiwgXCIpO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgdmFsdWUgPT09IFwib2JqZWN0XCIpIHtcbiAgICAgIC8vIEhhbmRsZSBsaW5rcywgZGF0ZXMsIGFuZCBvdGhlciBvYmplY3RzXG4gICAgICBpZiAodmFsdWUucGF0aCkge1xuICAgICAgICByZXR1cm4gYFtbJHt2YWx1ZS5wYXRofV1dYDtcbiAgICAgIH1cbiAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIFN0cmluZyh2YWx1ZSk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==