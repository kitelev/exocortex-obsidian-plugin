e618e55e6da008ad7c5cef7a9140e3eb
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ObsidianButtonRepository = void 0;
const obsidian_1 = require("obsidian");
const UIButton_1 = require("../../domain/entities/UIButton");
const ButtonCommand_1 = require("../../domain/entities/ButtonCommand");
const AssetId_1 = require("../../domain/value-objects/AssetId");
const Result_1 = require("../../domain/core/Result");
/**
 * Obsidian implementation of Button repository
 */
class ObsidianButtonRepository {
    constructor(app) {
        this.app = app;
    }
    async findButtonById(id) {
        try {
            const file = this.app.vault.getAbstractFileByPath(id.toString() + ".md");
            if (!file || !(file instanceof obsidian_1.TFile)) {
                return Result_1.Result.ok(null);
            }
            return this.buildButtonFromFile(file);
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to find button: ${error.message}`);
        }
    }
    async findCommandById(id) {
        try {
            const file = this.app.vault.getAbstractFileByPath(id.toString() + ".md");
            if (!file || !(file instanceof obsidian_1.TFile)) {
                return Result_1.Result.ok(null);
            }
            return this.buildCommandFromFile(file);
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to find command: ${error.message}`);
        }
    }
    async findAllButtons() {
        try {
            const buttons = [];
            const files = this.app.vault.getMarkdownFiles();
            for (const file of files) {
                const metadata = this.app.metadataCache.getFileCache(file);
                if (!metadata?.frontmatter)
                    continue;
                const instanceClass = metadata.frontmatter["exo__Instance_class"];
                if (instanceClass !== "[[ui__Button]]")
                    continue;
                const buttonResult = await this.buildButtonFromFile(file);
                if (buttonResult.isSuccess && buttonResult.getValue()) {
                    buttons.push(buttonResult.getValue());
                }
            }
            return Result_1.Result.ok(buttons);
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to find buttons: ${error.message}`);
        }
    }
    async findAllCommands() {
        try {
            const commands = [];
            const files = this.app.vault.getMarkdownFiles();
            for (const file of files) {
                const metadata = this.app.metadataCache.getFileCache(file);
                if (!metadata?.frontmatter)
                    continue;
                const instanceClass = metadata.frontmatter["exo__Instance_class"];
                if (instanceClass !== "[[ui__ButtonCommand]]")
                    continue;
                const commandResult = await this.buildCommandFromFile(file);
                if (commandResult.isSuccess && commandResult.getValue()) {
                    commands.push(commandResult.getValue());
                }
            }
            return Result_1.Result.ok(commands);
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to find commands: ${error.message}`);
        }
    }
    async findButtonsByCommandId(commandId) {
        try {
            const buttons = [];
            const allButtonsResult = await this.findAllButtons();
            if (allButtonsResult.isFailure) {
                return Result_1.Result.fail(allButtonsResult.error);
            }
            const allButtons = allButtonsResult.getValue();
            for (const button of allButtons) {
                if (button.commandId.equals(commandId)) {
                    buttons.push(button);
                }
            }
            return Result_1.Result.ok(buttons);
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to find buttons by command: ${error.message}`);
        }
    }
    async saveButton(button) {
        try {
            const filePath = `${button.id.toString()}.md`;
            const content = this.serializeButton(button);
            const existingFile = this.app.vault.getAbstractFileByPath(filePath);
            if (existingFile instanceof obsidian_1.TFile) {
                await this.app.vault.modify(existingFile, content);
            }
            else {
                await this.app.vault.create(filePath, content);
            }
            return Result_1.Result.ok();
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to save button: ${error.message}`);
        }
    }
    async saveCommand(command) {
        try {
            const filePath = `${command.id.toString()}.md`;
            const content = this.serializeCommand(command);
            const existingFile = this.app.vault.getAbstractFileByPath(filePath);
            if (existingFile instanceof obsidian_1.TFile) {
                await this.app.vault.modify(existingFile, content);
            }
            else {
                await this.app.vault.create(filePath, content);
            }
            return Result_1.Result.ok();
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to save command: ${error.message}`);
        }
    }
    async deleteButton(id) {
        try {
            const file = this.app.vault.getAbstractFileByPath(id.toString() + ".md");
            if (file instanceof obsidian_1.TFile) {
                await this.app.vault.delete(file);
            }
            return Result_1.Result.ok();
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to delete button: ${error.message}`);
        }
    }
    async deleteCommand(id) {
        try {
            const file = this.app.vault.getAbstractFileByPath(id.toString() + ".md");
            if (file instanceof obsidian_1.TFile) {
                await this.app.vault.delete(file);
            }
            return Result_1.Result.ok();
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to delete command: ${error.message}`);
        }
    }
    async buildButtonFromFile(file) {
        try {
            const metadata = this.app.metadataCache.getFileCache(file);
            if (!metadata?.frontmatter) {
                return Result_1.Result.ok(null);
            }
            const fm = metadata.frontmatter;
            const idResult = AssetId_1.AssetId.create(file.basename);
            const commandIdResult = AssetId_1.AssetId.create(this.cleanAssetReference(fm["ui__Button_command"] || ""));
            if (idResult.isFailure || commandIdResult.isFailure) {
                return Result_1.Result.ok(null);
            }
            const buttonResult = UIButton_1.UIButton.create({
                id: idResult.getValue(),
                label: fm["ui__Button_label"] || file.basename,
                commandId: commandIdResult.getValue(),
                order: fm["ui__Button_order"] || 0,
                isEnabled: fm["ui__Button_enabled"] !== false,
                tooltip: fm["ui__Button_tooltip"],
            });
            if (buttonResult.isFailure) {
                return Result_1.Result.fail(buttonResult.error);
            }
            return Result_1.Result.ok(buttonResult.getValue());
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to build button: ${error.message}`);
        }
    }
    async buildCommandFromFile(file) {
        try {
            const metadata = this.app.metadataCache.getFileCache(file);
            if (!metadata?.frontmatter) {
                return Result_1.Result.ok(null);
            }
            const fm = metadata.frontmatter;
            const idResult = AssetId_1.AssetId.create(file.basename);
            if (idResult.isFailure) {
                return Result_1.Result.ok(null);
            }
            // Parse command type
            const typeString = fm["ui__Command_type"] || "CUSTOM";
            const type = this.parseCommandType(typeString);
            // Parse parameters
            const parameters = this.parseParameters(fm["ui__Command_parameters"]);
            const commandResult = ButtonCommand_1.ButtonCommand.create({
                id: idResult.getValue(),
                type: type,
                name: fm["ui__Command_name"] || file.basename,
                description: fm["ui__Command_description"],
                requiresInput: fm["ui__Command_requiresInput"] === true,
                parameters: parameters,
                targetClass: this.cleanAssetReference(fm["ui__Command_targetClass"]),
                template: fm["ui__Command_template"],
                script: fm["ui__Command_script"],
            });
            if (commandResult.isFailure) {
                return Result_1.Result.fail(commandResult.error);
            }
            return Result_1.Result.ok(commandResult.getValue());
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to build command: ${error.message}`);
        }
    }
    parseCommandType(typeString) {
        const upperType = typeString.toUpperCase();
        return (ButtonCommand_1.CommandType[upperType] || ButtonCommand_1.CommandType.CUSTOM);
    }
    parseParameters(paramsData) {
        if (!paramsData)
            return [];
        const params = [];
        const paramArray = this.ensureArray(paramsData);
        for (const param of paramArray) {
            if (typeof param === "object" && param.name) {
                params.push({
                    name: param.name,
                    type: param.type || "string",
                    required: param.required === true,
                    defaultValue: param.defaultValue,
                    label: param.label,
                    description: param.description,
                    validation: param.validation,
                });
            }
        }
        return params;
    }
    serializeButton(button) {
        const frontmatter = {
            exo__Instance_class: "[[ui__Button]]",
            ui__Button_label: button.label,
            ui__Button_command: `[[${button.commandId.toString()}]]`,
            ui__Button_order: button.order,
            ui__Button_enabled: button.isEnabled,
            ui__Button_tooltip: button.tooltip,
        };
        const yamlContent = this.toYaml(frontmatter);
        return `---\n${yamlContent}---\n\n# Button: ${button.label}\n`;
    }
    serializeCommand(command) {
        const frontmatter = {
            exo__Instance_class: "[[ui__ButtonCommand]]",
            ui__Command_type: command.type,
            ui__Command_name: command.name,
            ui__Command_description: command.description,
            ui__Command_requiresInput: command.requiresInput,
            ui__Command_parameters: command.parameters,
            ui__Command_targetClass: command.targetClass
                ? `[[${command.targetClass}]]`
                : null,
            ui__Command_template: command.template,
            ui__Command_script: command.script,
        };
        const yamlContent = this.toYaml(frontmatter);
        return `---\n${yamlContent}---\n\n# Command: ${command.name}\n`;
    }
    cleanAssetReference(ref) {
        if (typeof ref !== "string")
            return "";
        return ref.replace(/\[\[|\]\]/g, "").trim();
    }
    ensureArray(value) {
        if (Array.isArray(value))
            return value;
        if (value)
            return [value];
        return [];
    }
    toYaml(obj) {
        // Simple YAML serialization
        return (Object.entries(obj)
            .filter(([_, value]) => value !== null && value !== undefined)
            .map(([key, value]) => {
            if (Array.isArray(value)) {
                if (value.length === 0)
                    return `${key}: []`;
                return `${key}:\n${value.map((v) => `  - ${JSON.stringify(v)}`).join("\n")}`;
            }
            if (typeof value === "object") {
                return `${key}: ${JSON.stringify(value)}`;
            }
            return `${key}: ${value}`;
        })
            .join("\n") + "\n");
    }
}
exports.ObsidianButtonRepository = ObsidianButtonRepository;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2luZnJhc3RydWN0dXJlL3JlcG9zaXRvcmllcy9PYnNpZGlhbkJ1dHRvblJlcG9zaXRvcnkudHMiLCJtYXBwaW5ncyI6Ijs7O0FBQUEsdUNBQXNDO0FBRXRDLDZEQUEwRDtBQUMxRCx1RUFJNkM7QUFDN0MsZ0VBQTZEO0FBQzdELHFEQUFrRDtBQUVsRDs7R0FFRztBQUNILE1BQWEsd0JBQXdCO0lBQ25DLFlBQW9CLEdBQVE7UUFBUixRQUFHLEdBQUgsR0FBRyxDQUFLO0lBQUcsQ0FBQztJQUVoQyxLQUFLLENBQUMsY0FBYyxDQUFDLEVBQVc7UUFDOUIsSUFBSTtZQUNGLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLHFCQUFxQixDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsR0FBRyxLQUFLLENBQUMsQ0FBQztZQUN6RSxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxJQUFJLFlBQVksZ0JBQUssQ0FBQyxFQUFFO2dCQUNyQyxPQUFPLGVBQU0sQ0FBQyxFQUFFLENBQWtCLElBQUksQ0FBQyxDQUFDO2FBQ3pDO1lBRUQsT0FBTyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDdkM7UUFBQyxPQUFPLEtBQUssRUFBRTtZQUNkLE9BQU8sZUFBTSxDQUFDLElBQUksQ0FDaEIsMEJBQTBCLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FDMUMsQ0FBQztTQUNIO0lBQ0gsQ0FBQztJQUVELEtBQUssQ0FBQyxlQUFlLENBQUMsRUFBVztRQUMvQixJQUFJO1lBQ0YsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxHQUFHLEtBQUssQ0FBQyxDQUFDO1lBQ3pFLElBQUksQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLElBQUksWUFBWSxnQkFBSyxDQUFDLEVB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QUFFLENBQUMsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQzthQUM5RTtZQUNELElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxFQUFFO2dCQUM3QixPQUFPLEdBQUcsR0FBRyxLQUFLLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQzthQUMzQztZQUNELE9BQU8sR0FBRyxHQUFHLEtBQUssS0FBSyxFQUFFLENBQUM7UUFDNUIsQ0FBQyxDQUFDO2FBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FDckIsQ0FBQztJQUNKLENBQUM7Q0FDRjtBQS9WRCw0REErVkMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2luZnJhc3RydWN0dXJlL3JlcG9zaXRvcmllcy9PYnNpZGlhbkJ1dHRvblJlcG9zaXRvcnkudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwLCBURmlsZSB9IGZyb20gXCJvYnNpZGlhblwiO1xuaW1wb3J0IHsgSUJ1dHRvblJlcG9zaXRvcnkgfSBmcm9tIFwiLi4vLi4vZG9tYWluL3JlcG9zaXRvcmllcy9JQnV0dG9uUmVwb3NpdG9yeVwiO1xuaW1wb3J0IHsgVUlCdXR0b24gfSBmcm9tIFwiLi4vLi4vZG9tYWluL2VudGl0aWVzL1VJQnV0dG9uXCI7XG5pbXBvcnQge1xuICBCdXR0b25Db21tYW5kLFxuICBDb21tYW5kVHlwZSxcbiAgQ29tbWFuZFBhcmFtZXRlcixcbn0gZnJvbSBcIi4uLy4uL2RvbWFpbi9lbnRpdGllcy9CdXR0b25Db21tYW5kXCI7XG5pbXBvcnQgeyBBc3NldElkIH0gZnJvbSBcIi4uLy4uL2RvbWFpbi92YWx1ZS1vYmplY3RzL0Fzc2V0SWRcIjtcbmltcG9ydCB7IFJlc3VsdCB9IGZyb20gXCIuLi8uLi9kb21haW4vY29yZS9SZXN1bHRcIjtcblxuLyoqXG4gKiBPYnNpZGlhbiBpbXBsZW1lbnRhdGlvbiBvZiBCdXR0b24gcmVwb3NpdG9yeVxuICovXG5leHBvcnQgY2xhc3MgT2JzaWRpYW5CdXR0b25SZXBvc2l0b3J5IGltcGxlbWVudHMgSUJ1dHRvblJlcG9zaXRvcnkge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwcDogQXBwKSB7fVxuXG4gIGFzeW5jIGZpbmRCdXR0b25CeUlkKGlkOiBBc3NldElkKTogUHJvbWlzZTxSZXN1bHQ8VUlCdXR0b24gfCBudWxsPj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBmaWxlID0gdGhpcy5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKGlkLnRvU3RyaW5nKCkgKyBcIi5tZFwiKTtcbiAgICAgIGlmICghZmlsZSB8fCAhKGZpbGUgaW5zdGFuY2VvZiBURmlsZSkpIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5vazxVSUJ1dHRvbiB8IG51bGw+KG51bGwpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdGhpcy5idWlsZEJ1dHRvbkZyb21GaWxlKGZpbGUpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8VUlCdXR0b24gfCBudWxsPihcbiAgICAgICAgYEZhaWxlZCB0byBmaW5kIGJ1dHRvbjogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZpbmRDb21tYW5kQnlJZChpZDogQXNzZXRJZCk6IFByb21pc2U8UmVzdWx0PEJ1dHRvbkNvbW1hbmQgfCBudWxsPj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBmaWxlID0gdGhpcy5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKGlkLnRvU3RyaW5nKCkgKyBcIi5tZFwiKTtcbiAgICAgIGlmICghZmlsZSB8fCAhKGZpbGUgaW5zdGFuY2VvZiBURmlsZSkpIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5vazxCdXR0b25Db21tYW5kIHwgbnVsbD4obnVsbCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0aGlzLmJ1aWxkQ29tbWFuZEZyb21GaWxlKGZpbGUpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8QnV0dG9uQ29tbWFuZCB8IG51bGw+KFxuICAgICAgICBgRmFpbGVkIHRvIGZpbmQgY29tbWFuZDogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZpbmRBbGxCdXR0b25zKCk6IFByb21pc2U8UmVzdWx0PFVJQnV0dG9uW10+PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGJ1dHRvbnM6IFVJQnV0dG9uW10gPSBbXTtcbiAgICAgIGNvbnN0IGZpbGVzID0gdGhpcy5hcHAudmF1bHQuZ2V0TWFya2Rvd25GaWxlcygpO1xuXG4gICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZXMpIHtcbiAgICAgICAgY29uc3QgbWV0YWRhdGEgPSB0aGlzLmFwcC5tZXRhZGF0YUNhY2hlLmdldEZpbGVDYWNoZShmaWxlKTtcbiAgICAgICAgaWYgKCFtZXRhZGF0YT8uZnJvbnRtYXR0ZXIpIGNvbnRpbnVlO1xuXG4gICAgICAgIGNvbnN0IGluc3RhbmNlQ2xhc3MgPSBtZXRhZGF0YS5mcm9udG1hdHRlcltcImV4b19fSW5zdGFuY2VfY2xhc3NcIl07XG4gICAgICAgIGlmIChpbnN0YW5jZUNsYXNzICE9PSBcIltbdWlfX0J1dHRvbl1dXCIpIGNvbnRpbnVlO1xuXG4gICAgICAgIGNvbnN0IGJ1dHRvblJlc3VsdCA9IGF3YWl0IHRoaXMuYnVpbGRCdXR0b25Gcm9tRmlsZShmaWxlKTtcbiAgICAgICAgaWYgKGJ1dHRvblJlc3VsdC5pc1N1Y2Nlc3MgJiYgYnV0dG9uUmVzdWx0LmdldFZhbHVlKCkpIHtcbiAgICAgICAgICBidXR0b25zLnB1c2goYnV0dG9uUmVzdWx0LmdldFZhbHVlKCkhKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gUmVzdWx0Lm9rPFVJQnV0dG9uW10+KGJ1dHRvbnMpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8VUlCdXR0b25bXT4oXG4gICAgICAgIGBGYWlsZWQgdG8gZmluZCBidXR0b25zOiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZmluZEFsbENvbW1hbmRzKCk6IFByb21pc2U8UmVzdWx0PEJ1dHRvbkNvbW1hbmRbXT4+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgY29tbWFuZHM6IEJ1dHRvbkNvbW1hbmRbXSA9IFtdO1xuICAgICAgY29uc3QgZmlsZXMgPSB0aGlzLmFwcC52YXVsdC5nZXRNYXJrZG93bkZpbGVzKCk7XG5cbiAgICAgIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykge1xuICAgICAgICBjb25zdCBtZXRhZGF0YSA9IHRoaXMuYXBwLm1ldGFkYXRhQ2FjaGUuZ2V0RmlsZUNhY2hlKGZpbGUpO1xuICAgICAgICBpZiAoIW1ldGFkYXRhPy5mcm9udG1hdHRlcikgY29udGludWU7XG5cbiAgICAgICAgY29uc3QgaW5zdGFuY2VDbGFzcyA9IG1ldGFkYXRhLmZyb250bWF0dGVyW1wiZXhvX19JbnN0YW5jZV9jbGFzc1wiXTtcbiAgICAgICAgaWYgKGluc3RhbmNlQ2xhc3MgIT09IFwiW1t1aV9fQnV0dG9uQ29tbWFuZF1dXCIpIGNvbnRpbnVlO1xuXG4gICAgICAgIGNvbnN0IGNvbW1hbmRSZXN1bHQgPSBhd2FpdCB0aGlzLmJ1aWxkQ29tbWFuZEZyb21GaWxlKGZpbGUpO1xuICAgICAgICBpZiAoY29tbWFuZFJlc3VsdC5pc1N1Y2Nlc3MgJiYgY29tbWFuZFJlc3VsdC5nZXRWYWx1ZSgpKSB7XG4gICAgICAgICAgY29tbWFuZHMucHVzaChjb21tYW5kUmVzdWx0LmdldFZhbHVlKCkhKTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gUmVzdWx0Lm9rPEJ1dHRvbkNvbW1hbmRbXT4oY29tbWFuZHMpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8QnV0dG9uQ29tbWFuZFtdPihcbiAgICAgICAgYEZhaWxlZCB0byBmaW5kIGNvbW1hbmRzOiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZmluZEJ1dHRvbnNCeUNvbW1hbmRJZChcbiAgICBjb21tYW5kSWQ6IEFzc2V0SWQsXG4gICk6IFByb21pc2U8UmVzdWx0PFVJQnV0dG9uW10+PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGJ1dHRvbnM6IFVJQnV0dG9uW10gPSBbXTtcbiAgICAgIGNvbnN0IGFsbEJ1dHRvbnNSZXN1bHQgPSBhd2FpdCB0aGlzLmZpbmRBbGxCdXR0b25zKCk7XG5cbiAgICAgIGlmIChhbGxCdXR0b25zUmVzdWx0LmlzRmFpbHVyZSkge1xuICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8VUlCdXR0b25bXT4oYWxsQnV0dG9uc1Jlc3VsdC5lcnJvcik7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGFsbEJ1dHRvbnMgPSBhbGxCdXR0b25zUmVzdWx0LmdldFZhbHVlKCk7XG4gICAgICBmb3IgKGNvbnN0IGJ1dHRvbiBvZiBhbGxCdXR0b25zKSB7XG4gICAgICAgIGlmIChidXR0b24uY29tbWFuZElkLmVxdWFscyhjb21tYW5kSWQpKSB7XG4gICAgICAgICAgYnV0dG9ucy5wdXNoKGJ1dHRvbik7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgcmV0dXJuIFJlc3VsdC5vazxVSUJ1dHRvbltdPihidXR0b25zKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPFVJQnV0dG9uW10+KFxuICAgICAgICBgRmFpbGVkIHRvIGZpbmQgYnV0dG9ucyBieSBjb21tYW5kOiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2F2ZUJ1dHRvbihidXR0b246IFVJQnV0dG9uKTogUHJvbWlzZTxSZXN1bHQ8dm9pZD4+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgZmlsZVBhdGggPSBgJHtidXR0b24uaWQudG9TdHJpbmcoKX0ubWRgO1xuICAgICAgY29uc3QgY29udGVudCA9IHRoaXMuc2VyaWFsaXplQnV0dG9uKGJ1dHRvbik7XG5cbiAgICAgIGNvbnN0IGV4aXN0aW5nRmlsZSA9IHRoaXMuYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChmaWxlUGF0aCk7XG4gICAgICBpZiAoZXhpc3RpbmdGaWxlIGluc3RhbmNlb2YgVEZpbGUpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5hcHAudmF1bHQubW9kaWZ5KGV4aXN0aW5nRmlsZSwgY29udGVudCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBhd2FpdCB0aGlzLmFwcC52YXVsdC5jcmVhdGUoZmlsZVBhdGgsIGNvbnRlbnQpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gUmVzdWx0Lm9rPHZvaWQ+KCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDx2b2lkPihgRmFpbGVkIHRvIHNhdmUgYnV0dG9uOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgc2F2ZUNvbW1hbmQoY29tbWFuZDogQnV0dG9uQ29tbWFuZCk6IFByb21pc2U8UmVzdWx0PHZvaWQ+PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZpbGVQYXRoID0gYCR7Y29tbWFuZC5pZC50b1N0cmluZygpfS5tZGA7XG4gICAgICBjb25zdCBjb250ZW50ID0gdGhpcy5zZXJpYWxpemVDb21tYW5kKGNvbW1hbmQpO1xuXG4gICAgICBjb25zdCBleGlzdGluZ0ZpbGUgPSB0aGlzLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoZmlsZVBhdGgpO1xuICAgICAgaWYgKGV4aXN0aW5nRmlsZSBpbnN0YW5jZW9mIFRGaWxlKSB7XG4gICAgICAgIGF3YWl0IHRoaXMuYXBwLnZhdWx0Lm1vZGlmeShleGlzdGluZ0ZpbGUsIGNvbnRlbnQpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXdhaXQgdGhpcy5hcHAudmF1bHQuY3JlYXRlKGZpbGVQYXRoLCBjb250ZW50KTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIFJlc3VsdC5vazx2b2lkPigpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8dm9pZD4oYEZhaWxlZCB0byBzYXZlIGNvbW1hbmQ6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBkZWxldGVCdXR0b24oaWQ6IEFzc2V0SWQpOiBQcm9taXNlPFJlc3VsdDx2b2lkPj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBmaWxlID0gdGhpcy5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKGlkLnRvU3RyaW5nKCkgKyBcIi5tZFwiKTtcbiAgICAgIGlmIChmaWxlIGluc3RhbmNlb2YgVEZpbGUpIHtcbiAgICAgICAgYXdhaXQgdGhpcy5hcHAudmF1bHQuZGVsZXRlKGZpbGUpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIFJlc3VsdC5vazx2b2lkPigpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8dm9pZD4oYEZhaWxlZCB0byBkZWxldGUgYnV0dG9uOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZGVsZXRlQ29tbWFuZChpZDogQXNzZXRJZCk6IFByb21pc2U8UmVzdWx0PHZvaWQ+PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZpbGUgPSB0aGlzLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoaWQudG9TdHJpbmcoKSArIFwiLm1kXCIpO1xuICAgICAgaWYgKGZpbGUgaW5zdGFuY2VvZiBURmlsZSkge1xuICAgICAgICBhd2FpdCB0aGlzLmFwcC52YXVsdC5kZWxldGUoZmlsZSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gUmVzdWx0Lm9rPHZvaWQ+KCk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDx2b2lkPihgRmFpbGVkIHRvIGRlbGV0ZSBjb21tYW5kOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBidWlsZEJ1dHRvbkZyb21GaWxlKFxuICAgIGZpbGU6IFRGaWxlLFxuICApOiBQcm9taXNlPFJlc3VsdDxVSUJ1dHRvbiB8IG51bGw+PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG1ldGFkYXRhID0gdGhpcy5hcHAubWV0YWRhdGFDYWNoZS5nZXRGaWxlQ2FjaGUoZmlsZSk7XG4gICAgICBpZiAoIW1ldGFkYXRhPy5mcm9udG1hdHRlcikge1xuICAgICAgICByZXR1cm4gUmVzdWx0Lm9rPFVJQnV0dG9uIHwgbnVsbD4obnVsbCk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGZtID0gbWV0YWRhdGEuZnJvbnRtYXR0ZXI7XG5cbiAgICAgIGNvbnN0IGlkUmVzdWx0ID0gQXNzZXRJZC5jcmVhdGUoZmlsZS5iYXNlbmFtZSk7XG4gICAgICBjb25zdCBjb21tYW5kSWRSZXN1bHQgPSBBc3NldElkLmNyZWF0ZShcbiAgICAgICAgdGhpcy5jbGVhbkFzc2V0UmVmZXJlbmNlKGZtW1widWlfX0J1dHRvbl9jb21tYW5kXCJdIHx8IFwiXCIpLFxuICAgICAgKTtcblxuICAgICAgaWYgKGlkUmVzdWx0LmlzRmFpbHVyZSB8fCBjb21tYW5kSWRSZXN1bHQuaXNGYWlsdXJlKSB7XG4gICAgICAgIHJldHVybiBSZXN1bHQub2s8VUlCdXR0b24gfCBudWxsPihudWxsKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgYnV0dG9uUmVzdWx0ID0gVUlCdXR0b24uY3JlYXRlKHtcbiAgICAgICAgaWQ6IGlkUmVzdWx0LmdldFZhbHVlKCksXG4gICAgICAgIGxhYmVsOiBmbVtcInVpX19CdXR0b25fbGFiZWxcIl0gfHwgZmlsZS5iYXNlbmFtZSxcbiAgICAgICAgY29tbWFuZElkOiBjb21tYW5kSWRSZXN1bHQuZ2V0VmFsdWUoKSxcbiAgICAgICAgb3JkZXI6IGZtW1widWlfX0J1dHRvbl9vcmRlclwiXSB8fCAwLFxuICAgICAgICBpc0VuYWJsZWQ6IGZtW1widWlfX0J1dHRvbl9lbmFibGVkXCJdICE9PSBmYWxzZSxcbiAgICAgICAgdG9vbHRpcDogZm1bXCJ1aV9fQnV0dG9uX3Rvb2x0aXBcIl0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKGJ1dHRvblJlc3VsdC5pc0ZhaWx1cmUpIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPFVJQnV0dG9uIHwgbnVsbD4oYnV0dG9uUmVzdWx0LmVycm9yKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIFJlc3VsdC5vazxVSUJ1dHRvbiB8IG51bGw+KGJ1dHRvblJlc3VsdC5nZXRWYWx1ZSgpKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPFVJQnV0dG9uIHwgbnVsbD4oXG4gICAgICAgIGBGYWlsZWQgdG8gYnVpbGQgYnV0dG9uOiAke2Vycm9yLm1lc3NhZ2V9YCxcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBidWlsZENvbW1hbmRGcm9tRmlsZShcbiAgICBmaWxlOiBURmlsZSxcbiAgKTogUHJvbWlzZTxSZXN1bHQ8QnV0dG9uQ29tbWFuZCB8IG51bGw+PiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG1ldGFkYXRhID0gdGhpcy5hcHAubWV0YWRhdGFDYWNoZS5nZXRGaWxlQ2FjaGUoZmlsZSk7XG4gICAgICBpZiAoIW1ldGFkYXRhPy5mcm9udG1hdHRlcikge1xuICAgICAgICByZXR1cm4gUmVzdWx0Lm9rPEJ1dHRvbkNvbW1hbmQgfCBudWxsPihudWxsKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZm0gPSBtZXRhZGF0YS5mcm9udG1hdHRlcjtcblxuICAgICAgY29uc3QgaWRSZXN1bHQgPSBBc3NldElkLmNyZWF0ZShmaWxlLmJhc2VuYW1lKTtcbiAgICAgIGlmIChpZFJlc3VsdC5pc0ZhaWx1cmUpIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5vazxCdXR0b25Db21tYW5kIHwgbnVsbD4obnVsbCk7XG4gICAgICB9XG5cbiAgICAgIC8vIFBhcnNlIGNvbW1hbmQgdHlwZVxuICAgICAgY29uc3QgdHlwZVN0cmluZyA9IGZtW1widWlfX0NvbW1hbmRfdHlwZVwiXSB8fCBcIkNVU1RPTVwiO1xuICAgICAgY29uc3QgdHlwZSA9IHRoaXMucGFyc2VDb21tYW5kVHlwZSh0eXBlU3RyaW5nKTtcblxuICAgICAgLy8gUGFyc2UgcGFyYW1ldGVyc1xuICAgICAgY29uc3QgcGFyYW1ldGVycyA9IHRoaXMucGFyc2VQYXJhbWV0ZXJzKGZtW1widWlfX0NvbW1hbmRfcGFyYW1ldGVyc1wiXSk7XG5cbiAgICAgIGNvbnN0IGNvbW1hbmRSZXN1bHQgPSBCdXR0b25Db21tYW5kLmNyZWF0ZSh7XG4gICAgICAgIGlkOiBpZFJlc3VsdC5nZXRWYWx1ZSgpLFxuICAgICAgICB0eXBlOiB0eXBlLFxuICAgICAgICBuYW1lOiBmbVtcInVpX19Db21tYW5kX25hbWVcIl0gfHwgZmlsZS5iYXNlbmFtZSxcbiAgICAgICAgZGVzY3JpcHRpb246IGZtW1widWlfX0NvbW1hbmRfZGVzY3JpcHRpb25cIl0sXG4gICAgICAgIHJlcXVpcmVzSW5wdXQ6IGZtW1widWlfX0NvbW1hbmRfcmVxdWlyZXNJbnB1dFwiXSA9PT0gdHJ1ZSxcbiAgICAgICAgcGFyYW1ldGVyczogcGFyYW1ldGVycyxcbiAgICAgICAgdGFyZ2V0Q2xhc3M6IHRoaXMuY2xlYW5Bc3NldFJlZmVyZW5jZShmbVtcInVpX19Db21tYW5kX3RhcmdldENsYXNzXCJdKSxcbiAgICAgICAgdGVtcGxhdGU6IGZtW1widWlfX0NvbW1hbmRfdGVtcGxhdGVcIl0sXG4gICAgICAgIHNjcmlwdDogZm1bXCJ1aV9fQ29tbWFuZF9zY3JpcHRcIl0sXG4gICAgICB9KTtcblxuICAgICAgaWYgKGNvbW1hbmRSZXN1bHQuaXNGYWlsdXJlKSB7XG4gICAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxCdXR0b25Db21tYW5kIHwgbnVsbD4oY29tbWFuZFJlc3VsdC5lcnJvcik7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBSZXN1bHQub2s8QnV0dG9uQ29tbWFuZCB8IG51bGw+KGNvbW1hbmRSZXN1bHQuZ2V0VmFsdWUoKSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiBSZXN1bHQuZmFpbDxCdXR0b25Db21tYW5kIHwgbnVsbD4oXG4gICAgICAgIGBGYWlsZWQgdG8gYnVpbGQgY29tbWFuZDogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcGFyc2VDb21tYW5kVHlwZSh0eXBlU3RyaW5nOiBzdHJpbmcpOiBDb21tYW5kVHlwZSB7XG4gICAgY29uc3QgdXBwZXJUeXBlID0gdHlwZVN0cmluZy50b1VwcGVyQ2FzZSgpO1xuICAgIHJldHVybiAoXG4gICAgICBDb21tYW5kVHlwZVt1cHBlclR5cGUgYXMga2V5b2YgdHlwZW9mIENvbW1hbmRUeXBlXSB8fCBDb21tYW5kVHlwZS5DVVNUT01cbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBwYXJzZVBhcmFtZXRlcnMocGFyYW1zRGF0YTogYW55KTogQ29tbWFuZFBhcmFtZXRlcltdIHtcbiAgICBpZiAoIXBhcmFtc0RhdGEpIHJldHVybiBbXTtcblxuICAgIGNvbnN0IHBhcmFtczogQ29tbWFuZFBhcmFtZXRlcltdID0gW107XG4gICAgY29uc3QgcGFyYW1BcnJheSA9IHRoaXMuZW5zdXJlQXJyYXkocGFyYW1zRGF0YSk7XG5cbiAgICBmb3IgKGNvbnN0IHBhcmFtIG9mIHBhcmFtQXJyYXkpIHtcbiAgICAgIGlmICh0eXBlb2YgcGFyYW0gPT09IFwib2JqZWN0XCIgJiYgcGFyYW0ubmFtZSkge1xuICAgICAgICBwYXJhbXMucHVzaCh7XG4gICAgICAgICAgbmFtZTogcGFyYW0ubmFtZSxcbiAgICAgICAgICB0eXBlOiBwYXJhbS50eXBlIHx8IFwic3RyaW5nXCIsXG4gICAgICAgICAgcmVxdWlyZWQ6IHBhcmFtLnJlcXVpcmVkID09PSB0cnVlLFxuICAgICAgICAgIGRlZmF1bHRWYWx1ZTogcGFyYW0uZGVmYXVsdFZhbHVlLFxuICAgICAgICAgIGxhYmVsOiBwYXJhbS5sYWJlbCxcbiAgICAgICAgICBkZXNjcmlwdGlvbjogcGFyYW0uZGVzY3JpcHRpb24sXG4gICAgICAgICAgdmFsaWRhdGlvbjogcGFyYW0udmFsaWRhdGlvbixcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHBhcmFtcztcbiAgfVxuXG4gIHByaXZhdGUgc2VyaWFsaXplQnV0dG9uKGJ1dHRvbjogVUlCdXR0b24pOiBzdHJpbmcge1xuICAgIGNvbnN0IGZyb250bWF0dGVyID0ge1xuICAgICAgZXhvX19JbnN0YW5jZV9jbGFzczogXCJbW3VpX19CdXR0b25dXVwiLFxuICAgICAgdWlfX0J1dHRvbl9sYWJlbDogYnV0dG9uLmxhYmVsLFxuICAgICAgdWlfX0J1dHRvbl9jb21tYW5kOiBgW1ske2J1dHRvbi5jb21tYW5kSWQudG9TdHJpbmcoKX1dXWAsXG4gICAgICB1aV9fQnV0dG9uX29yZGVyOiBidXR0b24ub3JkZXIsXG4gICAgICB1aV9fQnV0dG9uX2VuYWJsZWQ6IGJ1dHRvbi5pc0VuYWJsZWQsXG4gICAgICB1aV9fQnV0dG9uX3Rvb2x0aXA6IGJ1dHRvbi50b29sdGlwLFxuICAgIH07XG5cbiAgICBjb25zdCB5YW1sQ29udGVudCA9IHRoaXMudG9ZYW1sKGZyb250bWF0dGVyKTtcbiAgICByZXR1cm4gYC0tLVxcbiR7eWFtbENvbnRlbnR9LS0tXFxuXFxuIyBCdXR0b246ICR7YnV0dG9uLmxhYmVsfVxcbmA7XG4gIH1cblxuICBwcml2YXRlIHNlcmlhbGl6ZUNvbW1hbmQoY29tbWFuZDogQnV0dG9uQ29tbWFuZCk6IHN0cmluZyB7XG4gICAgY29uc3QgZnJvbnRtYXR0ZXIgPSB7XG4gICAgICBleG9fX0luc3RhbmNlX2NsYXNzOiBcIltbdWlfX0J1dHRvbkNvbW1hbmRdXVwiLFxuICAgICAgdWlfX0NvbW1hbmRfdHlwZTogY29tbWFuZC50eXBlLFxuICAgICAgdWlfX0NvbW1hbmRfbmFtZTogY29tbWFuZC5uYW1lLFxuICAgICAgdWlfX0NvbW1hbmRfZGVzY3JpcHRpb246IGNvbW1hbmQuZGVzY3JpcHRpb24sXG4gICAgICB1aV9fQ29tbWFuZF9yZXF1aXJlc0lucHV0OiBjb21tYW5kLnJlcXVpcmVzSW5wdXQsXG4gICAgICB1aV9fQ29tbWFuZF9wYXJhbWV0ZXJzOiBjb21tYW5kLnBhcmFtZXRlcnMsXG4gICAgICB1aV9fQ29tbWFuZF90YXJnZXRDbGFzczogY29tbWFuZC50YXJnZXRDbGFzc1xuICAgICAgICA/IGBbWyR7Y29tbWFuZC50YXJnZXRDbGFzc31dXWBcbiAgICAgICAgOiBudWxsLFxuICAgICAgdWlfX0NvbW1hbmRfdGVtcGxhdGU6IGNvbW1hbmQudGVtcGxhdGUsXG4gICAgICB1aV9fQ29tbWFuZF9zY3JpcHQ6IGNvbW1hbmQuc2NyaXB0LFxuICAgIH07XG5cbiAgICBjb25zdCB5YW1sQ29udGVudCA9IHRoaXMudG9ZYW1sKGZyb250bWF0dGVyKTtcbiAgICByZXR1cm4gYC0tLVxcbiR7eWFtbENvbnRlbnR9LS0tXFxuXFxuIyBDb21tYW5kOiAke2NvbW1hbmQubmFtZX1cXG5gO1xuICB9XG5cbiAgcHJpdmF0ZSBjbGVhbkFzc2V0UmVmZXJlbmNlKHJlZjogc3RyaW5nKTogc3RyaW5nIHtcbiAgICBpZiAodHlwZW9mIHJlZiAhPT0gXCJzdHJpbmdcIikgcmV0dXJuIFwiXCI7XG4gICAgcmV0dXJuIHJlZi5yZXBsYWNlKC9cXFtcXFt8XFxdXFxdL2csIFwiXCIpLnRyaW0oKTtcbiAgfVxuXG4gIHByaXZhdGUgZW5zdXJlQXJyYXkodmFsdWU6IGFueSk6IGFueVtdIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHJldHVybiB2YWx1ZTtcbiAgICBpZiAodmFsdWUpIHJldHVybiBbdmFsdWVdO1xuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIHByaXZhdGUgdG9ZYW1sKG9iajogYW55KTogc3RyaW5nIHtcbiAgICAvLyBTaW1wbGUgWUFNTCBzZXJpYWxpemF0aW9uXG4gICAgcmV0dXJuIChcbiAgICAgIE9iamVjdC5lbnRyaWVzKG9iailcbiAgICAgICAgLmZpbHRlcigoW18sIHZhbHVlXSkgPT4gdmFsdWUgIT09IG51bGwgJiYgdmFsdWUgIT09IHVuZGVmaW5lZClcbiAgICAgICAgLm1hcCgoW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICAgICAgICBpZiAodmFsdWUubGVuZ3RoID09PSAwKSByZXR1cm4gYCR7a2V5fTogW11gO1xuICAgICAgICAgICAgcmV0dXJuIGAke2tleX06XFxuJHt2YWx1ZS5tYXAoKHYpID0+IGAgIC0gJHtKU09OLnN0cmluZ2lmeSh2KX1gKS5qb2luKFwiXFxuXCIpfWA7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmICh0eXBlb2YgdmFsdWUgPT09IFwib2JqZWN0XCIpIHtcbiAgICAgICAgICAgIHJldHVybiBgJHtrZXl9OiAke0pTT04uc3RyaW5naWZ5KHZhbHVlKX1gO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gYCR7a2V5fTogJHt2YWx1ZX1gO1xuICAgICAgICB9KVxuICAgICAgICAuam9pbihcIlxcblwiKSArIFwiXFxuXCJcbiAgICApO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=