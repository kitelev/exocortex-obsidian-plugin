9a6e39cef3eab403c4c8b996565558fc
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.QueryEngineFactory = void 0;
const Result_1 = require("../../domain/core/Result");
const DataviewQueryEngine_1 = require("./DataviewQueryEngine");
const DatacoreQueryEngine_1 = require("./DatacoreQueryEngine");
const NativeQueryEngine_1 = require("./NativeQueryEngine");
const PlatformDetector_1 = require("../utils/PlatformDetector");
const MobilePerformanceOptimizer_1 = require("../optimizers/MobilePerformanceOptimizer");
/**
 * Query Engine Factory Implementation
 * Creates and manages query engine instances based on availability and preference
 */
class QueryEngineFactory {
    constructor(app) {
        this.app = app;
        this.dataviewApi = null;
        this.datacoreApi = null;
        this.cachedEngines = new Map();
        this.platformInfo = PlatformDetector_1.PlatformDetector.getPlatformInfo();
        this.detectAvailableEngines();
        this.initializeMobileOptimizations();
    }
    async createQueryEngine(preferred) {
        // If no preference specified, use auto-detection
        if (!preferred) {
            return this.createAutoDetectedEngine();
        }
        // Try to create the preferred engine
        const preferredResult = await this.createSpecificEngine(preferred);
        if (preferredResult.isSuccess) {
            return preferredResult;
        }
        // Fallback to any available engine
        console.warn(`Preferred query engine '${preferred}' not available, falling back to auto-detection`);
        return this.createAutoDetectedEngine();
    }
    getAvailableEngines() {
        const available = [];
        if (this.isEngineAvailable("dataview")) {
            available.push("dataview");
        }
        if (this.isEngineAvailable("datacore")) {
            available.push("datacore");
        }
        // Native engine is always available
        available.push("native");
        return available;
    }
    isEngineAvailable(type) {
        switch (type) {
            case "dataview":
                return this.dataviewApi != null;
            case "datacore":
                return this.datacoreApi != null;
            case "native":
                return true; // Native engine is always available
            default:
                return false;
        }
    }
    updateApis(dataviewApi, datacoreApi) {
        this.dataviewApi = dataviewApi;
        this.datacoreApi = datacoreApi;
        // Clear cached engines when APIs change
        this.cachedEngines.clear();
        console.log("Query Engine Factory: APIs updated", {
            dataview: !!this.dataviewApi,
            datacore: !!this.datacoreApi,
        });
    }
    async createAutoDetectedEngine() {
        const availableEngines = this.getAvailableEngines();
        if (availableEngines.length === 0) {
            return Result_1.Result.fail("No query engines available");
        }
        // Mobile-first engine selection for iOS/mobile devices
        let preferredOrder;
        if (this.platformInfo.isObsidianMobile || this.platformInfo.isMobile) {
            // On mobile, prefer native engine for better performance and compatibility
            preferredOrder = ["native", "dataview", "datacore"];
            console.log("Mobile platform detected, preferring native query engine");
        }
        else {
            // On desktop, prefer Dataview/Datacore for full feature support
            preferredOrder = ["dataview", "datacore", "native"];
        }
        for (const engineType of preferredOrder) {
            if (availableEngines.includes(engineType)) {
                const result = await this.createSpecificEngine(engineType);
                if (result.isSuccess) {
                    return result;
                }
            }
        }
        // Final fallback to native engine (always available)
        return this.createSpecificEngine("native");
    }
    async createSpecificEngine(type) {
        // Return cached instance if available
        if (this.cachedEngines.has(type)) {
            const cached = this.cachedEngines.get(type);
            if (cached.isAvailable()) {
                return Result_1.Result.ok(cached);
            }
            else {
                // Remove invalid cached engine
                this.cachedEngines.delete(type);
            }
        }
        let engine;
        switch (type) {
            case "dataview":
                if (!this.dataviewApi) {
                    return Result_1.Result.fail("Dataview API not available");
                }
                engine = new DataviewQueryEngine_1.DataviewQueryEngine(this.dataviewApi);
                break;
            case "datacore":
                if (!this.datacoreApi) {
                    return Result_1.Result.fail("Datacore API not available");
                }
                engine = new DatacoreQueryEngine_1.DatacoreQueryEngine(this.datacoreApi);
                break;
            case "native":
                engine = new NativeQueryEngine_1.NativeQueryEngine(this.app);
                break;
            default:
                return Result_1.Result.fail(`Unknown query engine type: ${type}`);
        }
        // Verify the engine is actually available
        if (!engine.isAvailable()) {
            return Result_1.Result.fail(`Query engine '${type}' is not available`);
        }
        // Cache the engine
        this.cachedEngines.set(type, engine);
        return Result_1.Result.ok(engine);
    }
    detectAvailableEngines() {
        // Try to detect and initialize available query engines
        this.detectDataview();
        this.detectDatacore();
    }
    detectDataview() {
        try {
            // Check if Dataview plugin is loaded
            const plugins = this.app.plugins;
            if (plugins && plugins.plugins && plugins.plugins.dataview) {
                const dataviewPlugin = plugins.plugins.dataview;
                if (dataviewPlugin && dataviewPlugin.api) {
                    this.dataviewApi = dataviewPlugin.api;
                    console.log("Query Engine Factory: Dataview API detected");
                }
            }
        }
        catch (error) {
            console.warn("Query Engine Factory: Failed to detect Dataview", error);
        }
    }
    detectDatacore() {
        try {
            // Check if Datacore plugin is loaded
            const plugins = this.app.plugins;
            if (plugins && plugins.plugins && plugins.plugins.datacore) {
                const datacorePlugin = plugins.plugins.datacore;
                if (datacorePlugin && datacorePlugin.api) {
                    this.datacoreApi = datacorePlugin.api;
                    console.log("Query Engine Factory: Datacore API detected");
                }
            }
        }
        catch (error) {
            console.warn("Query Engine Factory: Failed to detect Datacore", error);
        }
    }
    /**
     * Refresh engine detection - useful when plugins are loaded dynamically
     */
    refresh() {
        this.detectAvailableEngines();
    }
    /**
     * Clear all cached engines - forces recreation on next request
     */
    clearCache() {
        this.cachedEngines.clear();
    }
    /**
     * Get diagnostic information about available engines
     */
    getDiagnostics() {
        return {
            availableEngines: this.getAvailableEngines(),
            dataviewAvailable: this.isEngineAvailable("dataview"),
            datacoreAvailable: this.isEngineAvailable("datacore"),
            nativeAvailable: this.isEngineAvailable("native"),
            cachedEngines: Array.from(this.cachedEngines.keys()),
            dataviewApi: !!this.dataviewApi,
            datacoreApi: !!this.datacoreApi,
            platformInfo: this.platformInfo,
            performanceOptimizer: !!this.performanceOptimizer,
        };
    }
    /**
     * Initialize mobile-specific optimizations
     */
    initializeMobileOptimizations() {
        if (PlatformDetector_1.PlatformDetector.shouldUseMobileOptimizations()) {
            const config = {
                maxMemoryMB: PlatformDetector_1.PlatformDetector.hasLimitedMemory() ? 50 : 100,
                maxCacheEntries: PlatformDetector_1.PlatformDetector.getRecommendedCacheSize(),
                batchSize: PlatformDetector_1.PlatformDetector.getRecommendedBatchSize(),
                debounceMs: this.platformInfo.isMobile ? 500 : 300,
                enableGCHints: true,
                enableLazyLoading: true,
                virtualScrollThreshold: this.platformInfo.isMobile ? 50 : 100,
            };
            this.performanceOptimizer = new MobilePerformanceOptimizer_1.MobilePerformanceOptimizer(config);
            console.log("Mobile optimizations enabled:", {
                platform: this.platformInfo.os,
                isMobile: this.platformInfo.isMobile,
                isObsidianMobile: this.platformInfo.isObsidianMobile,
                batchSize: PlatformDetector_1.PlatformDetector.getRecommendedBatchSize(),
                cacheSize: PlatformDetector_1.PlatformDetector.getRecommendedCacheSize(),
            });
        }
    }
    /**
     * Get the performance optimizer (if mobile optimizations are enabled)
     */
    getPerformanceOptimizer() {
        return this.performanceOptimizer;
    }
    /**
     * Force refresh platform detection and reinitialize optimizations
     */
    refreshPlatformDetection() {
        PlatformDetector_1.PlatformDetector.refresh();
        this.platformInfo = PlatformDetector_1.PlatformDetector.getPlatformInfo();
        // Reinitialize mobile optimizations if needed
        if (PlatformDetector_1.PlatformDetector.shouldUseMobileOptimizations() &&
            !this.performanceOptimizer) {
            this.initializeMobileOptimizations();
        }
        else if (!PlatformDetector_1.PlatformDetector.shouldUseMobileOptimizations() &&
            this.performanceOptimizer) {
            this.performanceOptimizer.destroy();
            this.performanceOptimizer = undefined;
        }
    }
    /**
     * Clean up resources
     */
    destroy() {
        this.clearCache();
        if (this.performanceOptimizer) {
            this.performanceOptimizer.destroy();
            this.performanceOptimizer = undefined;
        }
    }
}
exports.QueryEngineFactory = QueryEngineFactory;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2luZnJhc3RydWN0dXJlL3F1ZXJ5LWVuZ2luZXMvUXVlcnlFbmdpbmVGYWN0b3J5LnRzIiwibWFwcGluZ3MiOiI7OztBQUtBLHFEQUFrRDtBQUNsRCwrREFBNEQ7QUFDNUQsK0RBQTREO0FBQzVELDJEQUF3RDtBQUN4RCxnRUFBNkQ7QUFDN0QseUZBR2tEO0FBR2xEOzs7R0FHRztBQUNILE1BQWEsa0JBQWtCO0lBTzdCLFlBQW9CLEdBQVE7UUFBUixRQUFHLEdBQUgsR0FBRyxDQUFLO1FBTnBCLGdCQUFXLEdBQVEsSUFBSSxDQUFDO1FBQ3hCLGdCQUFXLEdBQVEsSUFBSSxDQUFDO1FBQ3hCLGtCQUFhLEdBQXVDLElBQUksR0FBRyxFQUFFLENBQUM7UUFFOUQsaUJBQVksR0FBRyxtQ0FBZ0IsQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUd4RCxJQUFJLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztRQUM5QixJQUFJLENBQUMsNkJBQTZCLEVBQUUsQ0FBQztJQUN2QyxDQUFDO0lBRU0sS0FBSyxDQUFDLGlCQUFpQixDQUM1QixTQUEyQjtRQUUzQixpREFBaUQ7UUFDakQsSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNkLE9BQU8sSUFBSSxDQUFDLHdCQUF3QixFQUFFLENBQUM7U0FDeEM7UUFFRCxxQ0FBcUM7UUFDckMsTUFBTSxlQUFlLEdBQUcsTUFBTSxJQUFJLENBQUMsb0JBQW9CLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDbkUsSUFBSSxlQUFlLENBQUMsU0FBUyxFQUFFO1lBQzdCLE9BQU8sZUFBZSxDQUFDO1NBQ3hCO1FBRUQsbUNBQW1DO1FBQ25DLE9BQU8sQ0FBQyxJQUFJLENBQ1YsMkJBQTJCLFNBQVMsaURBQWlELENBQ3RGLENBQUM7UUFDRixPQUFPLElBQUksQ0FBQyx3QkFBd0IsRUFBRSxDQUFDO0lBQ3pDLENBQUM7SUFFTSxtQkFBbUI7UUFDeEIsTUFBTSxTQUFTLEdBQXNCLEVBQUUsQ0FB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SSxDQUFDLDZCQUE2QixFQUFFLENBQUM7U0FDdEM7YUFBTSxJQUNMLENBQUMsbUNBQWdCLENBQUMsNEJBQTRCLEVBQUU7WUFDaEQsSUFBSSxDQUFDLG9CQUFvQixFQUN6QjtZQUNBLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNwQyxJQUFJLENBQUMsb0JBQW9CLEdBQUcsU0FBUyxDQUFDO1NBQ3ZDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0ksT0FBTztRQUNaLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUNsQixJQUFJLElBQUksQ0FBQyxvQkFBb0IsRUFBRTtZQUM3QixJQUFJLENBQUMsb0JBQW9CLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDcEMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLFNBQVMsQ0FBQztTQUN2QztJQUNILENBQUM7Q0FDRjtBQXRTRCxnREFzU0MiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2luZnJhc3RydWN0dXJlL3F1ZXJ5LWVuZ2luZXMvUXVlcnlFbmdpbmVGYWN0b3J5LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIElRdWVyeUVuZ2luZSxcbiAgSVF1ZXJ5RW5naW5lRmFjdG9yeSxcbiAgUXVlcnlFbmdpbmVUeXBlLFxufSBmcm9tIFwiLi4vLi4vZG9tYWluL3BvcnRzL0lRdWVyeUVuZ2luZVwiO1xuaW1wb3J0IHsgUmVzdWx0IH0gZnJvbSBcIi4uLy4uL2RvbWFpbi9jb3JlL1Jlc3VsdFwiO1xuaW1wb3J0IHsgRGF0YXZpZXdRdWVyeUVuZ2luZSB9IGZyb20gXCIuL0RhdGF2aWV3UXVlcnlFbmdpbmVcIjtcbmltcG9ydCB7IERhdGFjb3JlUXVlcnlFbmdpbmUgfSBmcm9tIFwiLi9EYXRhY29yZVF1ZXJ5RW5naW5lXCI7XG5pbXBvcnQgeyBOYXRpdmVRdWVyeUVuZ2luZSB9IGZyb20gXCIuL05hdGl2ZVF1ZXJ5RW5naW5lXCI7XG5pbXBvcnQgeyBQbGF0Zm9ybURldGVjdG9yIH0gZnJvbSBcIi4uL3V0aWxzL1BsYXRmb3JtRGV0ZWN0b3JcIjtcbmltcG9ydCB7XG4gIE1vYmlsZVBlcmZvcm1hbmNlT3B0aW1pemVyLFxuICBNb2JpbGVQZXJmb3JtYW5jZU9wdGltaXplckNvbmZpZyxcbn0gZnJvbSBcIi4uL29wdGltaXplcnMvTW9iaWxlUGVyZm9ybWFuY2VPcHRpbWl6ZXJcIjtcbmltcG9ydCB7IEFwcCB9IGZyb20gXCJvYnNpZGlhblwiO1xuXG4vKipcbiAqIFF1ZXJ5IEVuZ2luZSBGYWN0b3J5IEltcGxlbWVudGF0aW9uXG4gKiBDcmVhdGVzIGFuZCBtYW5hZ2VzIHF1ZXJ5IGVuZ2luZSBpbnN0YW5jZXMgYmFzZWQgb24gYXZhaWxhYmlsaXR5IGFuZCBwcmVmZXJlbmNlXG4gKi9cbmV4cG9ydCBjbGFzcyBRdWVyeUVuZ2luZUZhY3RvcnkgaW1wbGVtZW50cyBJUXVlcnlFbmdpbmVGYWN0b3J5IHtcbiAgcHJpdmF0ZSBkYXRhdmlld0FwaTogYW55ID0gbnVsbDtcbiAgcHJpdmF0ZSBkYXRhY29yZUFwaTogYW55ID0gbnVsbDtcbiAgcHJpdmF0ZSBjYWNoZWRFbmdpbmVzOiBNYXA8UXVlcnlFbmdpbmVUeXBlLCBJUXVlcnlFbmdpbmU+ID0gbmV3IE1hcCgpO1xuICBwcml2YXRlIHBlcmZvcm1hbmNlT3B0aW1pemVyPzogTW9iaWxlUGVyZm9ybWFuY2VPcHRpbWl6ZXI7XG4gIHByaXZhdGUgcGxhdGZvcm1JbmZvID0gUGxhdGZvcm1EZXRlY3Rvci5nZXRQbGF0Zm9ybUluZm8oKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGFwcDogQXBwKSB7XG4gICAgdGhpcy5kZXRlY3RBdmFpbGFibGVFbmdpbmVzKCk7XG4gICAgdGhpcy5pbml0aWFsaXplTW9iaWxlT3B0aW1pemF0aW9ucygpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGNyZWF0ZVF1ZXJ5RW5naW5lKFxuICAgIHByZWZlcnJlZD86IFF1ZXJ5RW5naW5lVHlwZSxcbiAgKTogUHJvbWlzZTxSZXN1bHQ8SVF1ZXJ5RW5naW5lPj4ge1xuICAgIC8vIElmIG5vIHByZWZlcmVuY2Ugc3BlY2lmaWVkLCB1c2UgYXV0by1kZXRlY3Rpb25cbiAgICBpZiAoIXByZWZlcnJlZCkge1xuICAgICAgcmV0dXJuIHRoaXMuY3JlYXRlQXV0b0RldGVjdGVkRW5naW5lKCk7XG4gICAgfVxuXG4gICAgLy8gVHJ5IHRvIGNyZWF0ZSB0aGUgcHJlZmVycmVkIGVuZ2luZVxuICAgIGNvbnN0IHByZWZlcnJlZFJlc3VsdCA9IGF3YWl0IHRoaXMuY3JlYXRlU3BlY2lmaWNFbmdpbmUocHJlZmVycmVkKTtcbiAgICBpZiAocHJlZmVycmVkUmVzdWx0LmlzU3VjY2Vzcykge1xuICAgICAgcmV0dXJuIHByZWZlcnJlZFJlc3VsdDtcbiAgICB9XG5cbiAgICAvLyBGYWxsYmFjayB0byBhbnkgYXZhaWxhYmxlIGVuZ2luZVxuICAgIGNvbnNvbGUud2FybihcbiAgICAgIGBQcmVmZXJyZWQgcXVlcnkgZW5naW5lICcke3ByZWZlcnJlZH0nIG5vdCBhdmFpbGFibGUsIGZhbGxpbmcgYmFjayB0byBhdXRvLWRldGVjdGlvbmAsXG4gICAgKTtcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVBdXRvRGV0ZWN0ZWRFbmdpbmUoKTtcbiAgfVxuXG4gIHB1YmxpYyBnZXRBdmFpbGFibGVFbmdpbmVzKCk6IFF1ZXJ5RW5naW5lVHlwZVtdIHtcbiAgICBjb25zdCBhdmFpbGFibGU6IFF1ZXJ5RW5naW5lVHlwZVtdID0gW107XG5cbiAgICBpZiAodGhpcy5pc0VuZ2luZUF2YWlsYWJsZShcImRhdGF2aWV3XCIpKSB7XG4gICAgICBhdmFpbGFibGUucHVzaChcImRhdGF2aWV3XCIpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmlzRW5naW5lQXZhaWxhYmxlKFwiZGF0YWNvcmVcIikpIHtcbiAgICAgIGF2YWlsYWJsZS5wdXNoKFwiZGF0YWNvcmVcIik7XG4gICAgfVxuXG4gICAgLy8gTmF0aXZlIGVuZ2luZSBpcyBhbHdheXMgYXZhaWxhYmxlXG4gICAgYXZhaWxhYmxlLnB1c2goXCJuYXRpdmVcIik7XG5cbiAgICByZXR1cm4gYXZhaWxhYmxlO1xuICB9XG5cbiAgcHVibGljIGlzRW5naW5lQXZhaWxhYmxlKHR5cGU6IFF1ZXJ5RW5naW5lVHlwZSk6IGJvb2xlYW4ge1xuICAgIHN3aXRjaCAodHlwZSkge1xuICAgICAgY2FzZSBcImRhdGF2aWV3XCI6XG4gICAgICAgIHJldHVybiB0aGlzLmRhdGF2aWV3QXBpICE9IG51bGw7XG4gICAgICBjYXNlIFwiZGF0YWNvcmVcIjpcbiAgICAgICAgcmV0dXJuIHRoaXMuZGF0YWNvcmVBcGkgIT0gbnVsbDtcbiAgICAgIGNhc2UgXCJuYXRpdmVcIjpcbiAgICAgICAgcmV0dXJuIHRydWU7IC8vIE5hdGl2ZSBlbmdpbmUgaXMgYWx3YXlzIGF2YWlsYWJsZVxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGVBcGlzKGRhdGF2aWV3QXBpPzogYW55LCBkYXRhY29yZUFwaT86IGFueSk6IHZvaWQge1xuICAgIHRoaXMuZGF0YXZpZXdBcGkgPSBkYXRhdmlld0FwaTtcbiAgICB0aGlzLmRhdGFjb3JlQXBpID0gZGF0YWNvcmVBcGk7XG5cbiAgICAvLyBDbGVhciBjYWNoZWQgZW5naW5lcyB3aGVuIEFQSXMgY2hhbmdlXG4gICAgdGhpcy5jYWNoZWRFbmdpbmVzLmNsZWFyKCk7XG5cbiAgICBjb25zb2xlLmxvZyhcIlF1ZXJ5IEVuZ2luZSBGYWN0b3J5OiBBUElzIHVwZGF0ZWRcIiwge1xuICAgICAgZGF0YXZpZXc6ICEhdGhpcy5kYXRhdmlld0FwaSxcbiAgICAgIGRhdGFjb3JlOiAhIXRoaXMuZGF0YWNvcmVBcGksXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGNyZWF0ZUF1dG9EZXRlY3RlZEVuZ2luZSgpOiBQcm9taXNlPFJlc3VsdDxJUXVlcnlFbmdpbmU+PiB7XG4gICAgY29uc3QgYXZhaWxhYmxlRW5naW5lcyA9IHRoaXMuZ2V0QXZhaWxhYmxlRW5naW5lcygpO1xuXG4gICAgaWYgKGF2YWlsYWJsZUVuZ2luZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8SVF1ZXJ5RW5naW5lPihcIk5vIHF1ZXJ5IGVuZ2luZXMgYXZhaWxhYmxlXCIpO1xuICAgIH1cblxuICAgIC8vIE1vYmlsZS1maXJzdCBlbmdpbmUgc2VsZWN0aW9uIGZvciBpT1MvbW9iaWxlIGRldmljZXNcbiAgICBsZXQgcHJlZmVycmVkT3JkZXI6IFF1ZXJ5RW5naW5lVHlwZVtdO1xuXG4gICAgaWYgKHRoaXMucGxhdGZvcm1JbmZvLmlzT2JzaWRpYW5Nb2JpbGUgfHwgdGhpcy5wbGF0Zm9ybUluZm8uaXNNb2JpbGUpIHtcbiAgICAgIC8vIE9uIG1vYmlsZSwgcHJlZmVyIG5hdGl2ZSBlbmdpbmUgZm9yIGJldHRlciBwZXJmb3JtYW5jZSBhbmQgY29tcGF0aWJpbGl0eVxuICAgICAgcHJlZmVycmVkT3JkZXIgPSBbXCJuYXRpdmVcIiwgXCJkYXRhdmlld1wiLCBcImRhdGFjb3JlXCJdO1xuICAgICAgY29uc29sZS5sb2coXCJNb2JpbGUgcGxhdGZvcm0gZGV0ZWN0ZWQsIHByZWZlcnJpbmcgbmF0aXZlIHF1ZXJ5IGVuZ2luZVwiKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gT24gZGVza3RvcCwgcHJlZmVyIERhdGF2aWV3L0RhdGFjb3JlIGZvciBmdWxsIGZlYXR1cmUgc3VwcG9ydFxuICAgICAgcHJlZmVycmVkT3JkZXIgPSBbXCJkYXRhdmlld1wiLCBcImRhdGFjb3JlXCIsIFwibmF0aXZlXCJdO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgZW5naW5lVHlwZSBvZiBwcmVmZXJyZWRPcmRlcikge1xuICAgICAgaWYgKGF2YWlsYWJsZUVuZ2luZXMuaW5jbHVkZXMoZW5naW5lVHlwZSkpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5jcmVhdGVTcGVjaWZpY0VuZ2luZShlbmdpbmVUeXBlKTtcbiAgICAgICAgaWYgKHJlc3VsdC5pc1N1Y2Nlc3MpIHtcbiAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gRmluYWwgZmFsbGJhY2sgdG8gbmF0aXZlIGVuZ2luZSAoYWx3YXlzIGF2YWlsYWJsZSlcbiAgICByZXR1cm4gdGhpcy5jcmVhdGVTcGVjaWZpY0VuZ2luZShcIm5hdGl2ZVwiKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgY3JlYXRlU3BlY2lmaWNFbmdpbmUoXG4gICAgdHlwZTogUXVlcnlFbmdpbmVUeXBlLFxuICApOiBQcm9taXNlPFJlc3VsdDxJUXVlcnlFbmdpbmU+PiB7XG4gICAgLy8gUmV0dXJuIGNhY2hlZCBpbnN0YW5jZSBpZiBhdmFpbGFibGVcbiAgICBpZiAodGhpcy5jYWNoZWRFbmdpbmVzLmhhcyh0eXBlKSkge1xuICAgICAgY29uc3QgY2FjaGVkID0gdGhpcy5jYWNoZWRFbmdpbmVzLmdldCh0eXBlKSE7XG4gICAgICBpZiAoY2FjaGVkLmlzQXZhaWxhYmxlKCkpIHtcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5vazxJUXVlcnlFbmdpbmU+KGNhY2hlZCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBSZW1vdmUgaW52YWxpZCBjYWNoZWQgZW5naW5lXG4gICAgICAgIHRoaXMuY2FjaGVkRW5naW5lcy5kZWxldGUodHlwZSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgbGV0IGVuZ2luZTogSVF1ZXJ5RW5naW5lO1xuXG4gICAgc3dpdGNoICh0eXBlKSB7XG4gICAgICBjYXNlIFwiZGF0YXZpZXdcIjpcbiAgICAgICAgaWYgKCF0aGlzLmRhdGF2aWV3QXBpKSB7XG4gICAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPElRdWVyeUVuZ2luZT4oXCJEYXRhdmlldyBBUEkgbm90IGF2YWlsYWJsZVwiKTtcbiAgICAgICAgfVxuICAgICAgICBlbmdpbmUgPSBuZXcgRGF0YXZpZXdRdWVyeUVuZ2luZSh0aGlzLmRhdGF2aWV3QXBpKTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgXCJkYXRhY29yZVwiOlxuICAgICAgICBpZiAoIXRoaXMuZGF0YWNvcmVBcGkpIHtcbiAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWw8SVF1ZXJ5RW5naW5lPihcIkRhdGFjb3JlIEFQSSBub3QgYXZhaWxhYmxlXCIpO1xuICAgICAgICB9XG4gICAgICAgIGVuZ2luZSA9IG5ldyBEYXRhY29yZVF1ZXJ5RW5naW5lKHRoaXMuZGF0YWNvcmVBcGkpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSBcIm5hdGl2ZVwiOlxuICAgICAgICBlbmdpbmUgPSBuZXcgTmF0aXZlUXVlcnlFbmdpbmUodGhpcy5hcHApO1xuICAgICAgICBicmVhaztcblxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgcmV0dXJuIFJlc3VsdC5mYWlsPElRdWVyeUVuZ2luZT4oYFVua25vd24gcXVlcnkgZW5naW5lIHR5cGU6ICR7dHlwZX1gKTtcbiAgICB9XG5cbiAgICAvLyBWZXJpZnkgdGhlIGVuZ2luZSBpcyBhY3R1YWxseSBhdmFpbGFibGVcbiAgICBpZiAoIWVuZ2luZS5pc0F2YWlsYWJsZSgpKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8SVF1ZXJ5RW5naW5lPihcbiAgICAgICAgYFF1ZXJ5IGVuZ2luZSAnJHt0eXBlfScgaXMgbm90IGF2YWlsYWJsZWAsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIENhY2hlIHRoZSBlbmdpbmVcbiAgICB0aGlzLmNhY2hlZEVuZ2luZXMuc2V0KHR5cGUsIGVuZ2luZSk7XG5cbiAgICByZXR1cm4gUmVzdWx0Lm9rPElRdWVyeUVuZ2luZT4oZW5naW5lKTtcbiAgfVxuXG4gIHByaXZhdGUgZGV0ZWN0QXZhaWxhYmxlRW5naW5lcygpOiB2b2lkIHtcbiAgICAvLyBUcnkgdG8gZGV0ZWN0IGFuZCBpbml0aWFsaXplIGF2YWlsYWJsZSBxdWVyeSBlbmdpbmVzXG4gICAgdGhpcy5kZXRlY3REYXRhdmlldygpO1xuICAgIHRoaXMuZGV0ZWN0RGF0YWNvcmUoKTtcbiAgfVxuXG4gIHByaXZhdGUgZGV0ZWN0RGF0YXZpZXcoKTogdm9pZCB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIENoZWNrIGlmIERhdGF2aWV3IHBsdWdpbiBpcyBsb2FkZWRcbiAgICAgIGNvbnN0IHBsdWdpbnMgPSAodGhpcy5hcHAgYXMgYW55KS5wbHVnaW5zO1xuICAgICAgaWYgKHBsdWdpbnMgJiYgcGx1Z2lucy5wbHVnaW5zICYmIHBsdWdpbnMucGx1Z2lucy5kYXRhdmlldykge1xuICAgICAgICBjb25zdCBkYXRhdmlld1BsdWdpbiA9IHBsdWdpbnMucGx1Z2lucy5kYXRhdmlldztcbiAgICAgICAgaWYgKGRhdGF2aWV3UGx1Z2luICYmIGRhdGF2aWV3UGx1Z2luLmFwaSkge1xuICAgICAgICAgIHRoaXMuZGF0YXZpZXdBcGkgPSBkYXRhdmlld1BsdWdpbi5hcGk7XG4gICAgICAgICAgY29uc29sZS5sb2coXCJRdWVyeSBFbmdpbmUgRmFjdG9yeTogRGF0YXZpZXcgQVBJIGRldGVjdGVkXCIpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUud2FybihcIlF1ZXJ5IEVuZ2luZSBGYWN0b3J5OiBGYWlsZWQgdG8gZGV0ZWN0IERhdGF2aWV3XCIsIGVycm9yKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGRldGVjdERhdGFjb3JlKCk6IHZvaWQge1xuICAgIHRyeSB7XG4gICAgICAvLyBDaGVjayBpZiBEYXRhY29yZSBwbHVnaW4gaXMgbG9hZGVkXG4gICAgICBjb25zdCBwbHVnaW5zID0gKHRoaXMuYXBwIGFzIGFueSkucGx1Z2lucztcbiAgICAgIGlmIChwbHVnaW5zICYmIHBsdWdpbnMucGx1Z2lucyAmJiBwbHVnaW5zLnBsdWdpbnMuZGF0YWNvcmUpIHtcbiAgICAgICAgY29uc3QgZGF0YWNvcmVQbHVnaW4gPSBwbHVnaW5zLnBsdWdpbnMuZGF0YWNvcmU7XG4gICAgICAgIGlmIChkYXRhY29yZVBsdWdpbiAmJiBkYXRhY29yZVBsdWdpbi5hcGkpIHtcbiAgICAgICAgICB0aGlzLmRhdGFjb3JlQXBpID0gZGF0YWNvcmVQbHVnaW4uYXBpO1xuICAgICAgICAgIGNvbnNvbGUubG9nKFwiUXVlcnkgRW5naW5lIEZhY3Rvcnk6IERhdGFjb3JlIEFQSSBkZXRlY3RlZFwiKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLndhcm4oXCJRdWVyeSBFbmdpbmUgRmFjdG9yeTogRmFpbGVkIHRvIGRldGVjdCBEYXRhY29yZVwiLCBlcnJvcik7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFJlZnJlc2ggZW5naW5lIGRldGVjdGlvbiAtIHVzZWZ1bCB3aGVuIHBsdWdpbnMgYXJlIGxvYWRlZCBkeW5hbWljYWxseVxuICAgKi9cbiAgcHVibGljIHJlZnJlc2goKTogdm9pZCB7XG4gICAgdGhpcy5kZXRlY3RBdmFpbGFibGVFbmdpbmVzKCk7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYXIgYWxsIGNhY2hlZCBlbmdpbmVzIC0gZm9yY2VzIHJlY3JlYXRpb24gb24gbmV4dCByZXF1ZXN0XG4gICAqL1xuICBwdWJsaWMgY2xlYXJDYWNoZSgpOiB2b2lkIHtcbiAgICB0aGlzLmNhY2hlZEVuZ2luZXMuY2xlYXIoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgZGlhZ25vc3RpYyBpbmZvcm1hdGlvbiBhYm91dCBhdmFpbGFibGUgZW5naW5lc1xuICAgKi9cbiAgcHVibGljIGdldERpYWdub3N0aWNzKCk6IFJlY29yZDxzdHJpbmcsIGFueT4ge1xuICAgIHJldHVybiB7XG4gICAgICBhdmFpbGFibGVFbmdpbmVzOiB0aGlzLmdldEF2YWlsYWJsZUVuZ2luZXMoKSxcbiAgICAgIGRhdGF2aWV3QXZhaWxhYmxlOiB0aGlzLmlzRW5naW5lQXZhaWxhYmxlKFwiZGF0YXZpZXdcIiksXG4gICAgICBkYXRhY29yZUF2YWlsYWJsZTogdGhpcy5pc0VuZ2luZUF2YWlsYWJsZShcImRhdGFjb3JlXCIpLFxuICAgICAgbmF0aXZlQXZhaWxhYmxlOiB0aGlzLmlzRW5naW5lQXZhaWxhYmxlKFwibmF0aXZlXCIpLFxuICAgICAgY2FjaGVkRW5naW5lczogQXJyYXkuZnJvbSh0aGlzLmNhY2hlZEVuZ2luZXMua2V5cygpKSxcbiAgICAgIGRhdGF2aWV3QXBpOiAhIXRoaXMuZGF0YXZpZXdBcGksXG4gICAgICBkYXRhY29yZUFwaTogISF0aGlzLmRhdGFjb3JlQXBpLFxuICAgICAgcGxhdGZvcm1JbmZvOiB0aGlzLnBsYXRmb3JtSW5mbyxcbiAgICAgIHBlcmZvcm1hbmNlT3B0aW1pemVyOiAhIXRoaXMucGVyZm9ybWFuY2VPcHRpbWl6ZXIsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplIG1vYmlsZS1zcGVjaWZpYyBvcHRpbWl6YXRpb25zXG4gICAqL1xuICBwcml2YXRlIGluaXRpYWxpemVNb2JpbGVPcHRpbWl6YXRpb25zKCk6IHZvaWQge1xuICAgIGlmIChQbGF0Zm9ybURldGVjdG9yLnNob3VsZFVzZU1vYmlsZU9wdGltaXphdGlvbnMoKSkge1xuICAgICAgY29uc3QgY29uZmlnOiBNb2JpbGVQZXJmb3JtYW5jZU9wdGltaXplckNvbmZpZyA9IHtcbiAgICAgICAgbWF4TWVtb3J5TUI6IFBsYXRmb3JtRGV0ZWN0b3IuaGFzTGltaXRlZE1lbW9yeSgpID8gNTAgOiAxMDAsXG4gICAgICAgIG1heENhY2hlRW50cmllczogUGxhdGZvcm1EZXRlY3Rvci5nZXRSZWNvbW1lbmRlZENhY2hlU2l6ZSgpLFxuICAgICAgICBiYXRjaFNpemU6IFBsYXRmb3JtRGV0ZWN0b3IuZ2V0UmVjb21tZW5kZWRCYXRjaFNpemUoKSxcbiAgICAgICAgZGVib3VuY2VNczogdGhpcy5wbGF0Zm9ybUluZm8uaXNNb2JpbGUgPyA1MDAgOiAzMDAsXG4gICAgICAgIGVuYWJsZUdDSGludHM6IHRydWUsXG4gICAgICAgIGVuYWJsZUxhenlMb2FkaW5nOiB0cnVlLFxuICAgICAgICB2aXJ0dWFsU2Nyb2xsVGhyZXNob2xkOiB0aGlzLnBsYXRmb3JtSW5mby5pc01vYmlsZSA/IDUwIDogMTAwLFxuICAgICAgfTtcbiAgICAgIHRoaXMucGVyZm9ybWFuY2VPcHRpbWl6ZXIgPSBuZXcgTW9iaWxlUGVyZm9ybWFuY2VPcHRpbWl6ZXIoY29uZmlnKTtcblxuICAgICAgY29uc29sZS5sb2coXCJNb2JpbGUgb3B0aW1pemF0aW9ucyBlbmFibGVkOlwiLCB7XG4gICAgICAgIHBsYXRmb3JtOiB0aGlzLnBsYXRmb3JtSW5mby5vcyxcbiAgICAgICAgaXNNb2JpbGU6IHRoaXMucGxhdGZvcm1JbmZvLmlzTW9iaWxlLFxuICAgICAgICBpc09ic2lkaWFuTW9iaWxlOiB0aGlzLnBsYXRmb3JtSW5mby5pc09ic2lkaWFuTW9iaWxlLFxuICAgICAgICBiYXRjaFNpemU6IFBsYXRmb3JtRGV0ZWN0b3IuZ2V0UmVjb21tZW5kZWRCYXRjaFNpemUoKSxcbiAgICAgICAgY2FjaGVTaXplOiBQbGF0Zm9ybURldGVjdG9yLmdldFJlY29tbWVuZGVkQ2FjaGVTaXplKCksXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBwZXJmb3JtYW5jZSBvcHRpbWl6ZXIgKGlmIG1vYmlsZSBvcHRpbWl6YXRpb25zIGFyZSBlbmFibGVkKVxuICAgKi9cbiAgcHVibGljIGdldFBlcmZvcm1hbmNlT3B0aW1pemVyKCk6IE1vYmlsZVBlcmZvcm1hbmNlT3B0aW1pemVyIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5wZXJmb3JtYW5jZU9wdGltaXplcjtcbiAgfVxuXG4gIC8qKlxuICAgKiBGb3JjZSByZWZyZXNoIHBsYXRmb3JtIGRldGVjdGlvbiBhbmQgcmVpbml0aWFsaXplIG9wdGltaXphdGlvbnNcbiAgICovXG4gIHB1YmxpYyByZWZyZXNoUGxhdGZvcm1EZXRlY3Rpb24oKTogdm9pZCB7XG4gICAgUGxhdGZvcm1EZXRlY3Rvci5yZWZyZXNoKCk7XG4gICAgdGhpcy5wbGF0Zm9ybUluZm8gPSBQbGF0Zm9ybURldGVjdG9yLmdldFBsYXRmb3JtSW5mbygpO1xuXG4gICAgLy8gUmVpbml0aWFsaXplIG1vYmlsZSBvcHRpbWl6YXRpb25zIGlmIG5lZWRlZFxuICAgIGlmIChcbiAgICAgIFBsYXRmb3JtRGV0ZWN0b3Iuc2hvdWxkVXNlTW9iaWxlT3B0aW1pemF0aW9ucygpICYmXG4gICAgICAhdGhpcy5wZXJmb3JtYW5jZU9wdGltaXplclxuICAgICkge1xuICAgICAgdGhpcy5pbml0aWFsaXplTW9iaWxlT3B0aW1pemF0aW9ucygpO1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICAhUGxhdGZvcm1EZXRlY3Rvci5zaG91bGRVc2VNb2JpbGVPcHRpbWl6YXRpb25zKCkgJiZcbiAgICAgIHRoaXMucGVyZm9ybWFuY2VPcHRpbWl6ZXJcbiAgICApIHtcbiAgICAgIHRoaXMucGVyZm9ybWFuY2VPcHRpbWl6ZXIuZGVzdHJveSgpO1xuICAgICAgdGhpcy5wZXJmb3JtYW5jZU9wdGltaXplciA9IHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2xlYW4gdXAgcmVzb3VyY2VzXG4gICAqL1xuICBwdWJsaWMgZGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLmNsZWFyQ2FjaGUoKTtcbiAgICBpZiAodGhpcy5wZXJmb3JtYW5jZU9wdGltaXplcikge1xuICAgICAgdGhpcy5wZXJmb3JtYW5jZU9wdGltaXplci5kZXN0cm95KCk7XG4gICAgICB0aGlzLnBlcmZvcm1hbmNlT3B0aW1pemVyID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9