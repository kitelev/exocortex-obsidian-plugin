96188bc5ce7072883825bab8c55cc70b
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CreateAssetModal = void 0;
const obsidian_1 = require("obsidian");
const DIContainer_1 = require("../../infrastructure/container/DIContainer");
const Result_1 = require("../../domain/core/Result");
/**
 * Modal for creating new ExoAssets
 * Presentation layer component that delegates to use cases
 */
class CreateAssetModal extends obsidian_1.Modal {
    constructor(app) {
        super(app);
        this.assetTitle = "";
        this.assetClass = "exo__Asset";
        this.assetOntology = "";
        this.propertyValues = new Map();
        this.propertiesContainer = null;
        this.properties = []; // Store current properties for testing
        this.container = DIContainer_1.DIContainer.getInstance();
        this.createAssetUseCase = this.container.getCreateAssetUseCase();
        this.ontologyRepository = this.container.resolve("IOntologyRepository");
        this.classViewRepository = this.container.resolve("IClassViewRepository");
        this.propertyCache = this.container.resolve("PropertyCacheService");
        this.circuitBreaker = this.container.resolve("CircuitBreakerService");
    }
    async onOpen() {
        const { contentEl } = this;
        contentEl.createEl("h2", { text: "Create ExoAsset" });
        await this.setupTitleField(contentEl);
        await this.setupClassField(contentEl);
        await this.setupOntologyField(contentEl);
        await this.setupPropertiesSection(contentEl);
        this.setupActionButtons(contentEl);
    }
    async setupTitleField(containerEl) {
        new obsidian_1.Setting(containerEl)
            .setName("Title")
            .setDesc("Asset title")
            .addText((text) => text
            .setPlaceholder("Enter asset title")
            .setValue(this.assetTitle)
            .onChange((value) => (this.assetTitle = value)));
    }
    async setupClassField(containerEl) {
        // Get all class files from the vault
        const files = this.app.vault.getMarkdownFiles();
        const classes = [];
        // Find all class definitions (files with exo__Class frontmatter)
        for (const file of files) {
            const cache = this.app.metadataCache.getFileCache(file);
            if (cache?.frontmatter) {
                const instanceClass = cache.frontmatter["exo__Instance_class"];
                if (instanceClass === "[[exo__Class]]" ||
                    instanceClass === "exo__Class") {
                    const className = file.basename;
                    const displayName = cache.frontmatter["rdfs__label"] || className;
                    classes.push({ className, displayName });
                }
            }
        }
        // Add default classes if none found
        if (classes.length === 0) {
            classes.push({ className: "exo__Asset", displayName: "Asset" }, { className: "exo__Class", displayName: "Class" }, { className: "exo__Property", displayName: "Property" });
        }
        new obsidian_1.Setting(containerEl)
            .setName("Class")
            .setDesc("Select the type of asset")
            .addDropdown((dropdown) => {
            for (const classInfo of classes) {
                dropdown.addOption(classInfo.className, classInfo.displayName);
            }
            dropdown.setValue(this.assetClass);
            dropdown.onChange(async (value) => {
                this.assetClass = value;
                await this.updatePropertiesForClass(value);
            });
        });
    }
    async setupOntologyField(containerEl) {
        // Get all ontology files from the vault
        const files = this.app.vault.getMarkdownFiles();
        const ontologies = [];
        // Find all ontology definitions (files starting with ! or having exo__Ontology_prefix)
        for (const file of files) {
            if (file.name.startsWith("!")) {
                const cache = this.app.metadataCache.getFileCache(file);
                if (cache?.frontmatter) {
                    const prefix = cache.frontmatter["exo__Ontology_prefix"] ||
                        file.basename.substring(1);
                    const displayName = cache.frontmatter["rdfs__label"] || prefix;
                    ontologies.push({ prefix, displayName });
                }
            }
        }
        // Add default ontologies if none found
        if (ontologies.length === 0) {
            ontologies.push({ prefix: "exo", displayName: "Exocortex Core" }, { prefix: "ui", displayName: "User Interface" }, { prefix: "rdfs", displayName: "RDF Schema" });
        }
        const defaultOntology = "exo";
        // Set default ontology when no ontologies found in vault
        if (ontologies.length > 0 && !this.assetOntology) {
            this.assetOntology = defaultOntology;
        }
        new obsidian_1.Setting(containerEl)
            .setName("Ontology")
            .setDesc("Select which knowledge graph this asset belongs to")
            .addDropdown((dropdown) => {
            for (const ontology of ontologies) {
                dropdown.addOption(ontology.prefix, ontology.displayName);
            }
            // Set default ontology
            if (defaultOntology &&
                ontologies.some((o) => o.prefix === defaultOntology)) {
                this.assetOntology = defaultOntology;
                dropdown.setValue(defaultOntology);
            }
            else if (ontologies.length > 0) {
                this.assetOntology = ontologies[0].prefix;
                dropdown.setValue(ontologies[0].prefix);
            }
            dropdown.onChange((value) => {
                this.assetOntology = value;
            });
        });
    }
    async setupPropertiesSection(containerEl) {
        containerEl.createEl("h3", {
            text: "Properties",
            cls: "exocortex-properties-header",
        });
        this.propertiesContainer = containerEl.createDiv({
            cls: "exocortex-properties-container",
        });
        await this.updatePropertiesForClass(this.assetClass);
    }
    async updatePropertiesForClass(className) {
        if (!this.propertiesContainer)
            return;
        console.log(`Updating properties for class: ${className}`);
        // Clear the container - try Obsidian method first, fallback to DOM
        if ("empty" in this.propertiesContainer &&
            typeof this.propertiesContainer.empty === "function") {
            this.propertiesContainer.empty();
        }
        else {
            // Fallback to standard DOM method - use innerHTML for complete cleanup
            this.propertiesContainer.innerHTML = "";
        }
        this.propertyValues.clear();
        // Get properties for this class
        this.properties = [];
        const files = this.app.vault.getMarkdownFiles();
        console.log(`Scanning ${files.length} files for properties...`);
        // Find all property definitions related to this class
        for (const file of files) {
            const cache = this.app.metadataCache.getFileCache(file);
            if (cache?.frontmatter) {
                const instanceClass = cache.frontmatter["exo__Instance_class"];
                if (instanceClass === "[[exo__Property]]" ||
                    instanceClass === "exo__Property") {
                    const domain = cache.frontmatter["rdfs__domain"];
                    // Check if this property belongs to the current class
                    if (domain === `[[${className}]]` ||
                        domain === className ||
                        (Array.isArray(domain) &&
                            (domain.includes(className) ||
                                domain.includes(`[[${className}]]`)))) {
                        const propertyName = file.basename;
                        const label = cache.frontmatter["rdfs__label"] || propertyName;
                        const description = cache.frontmatter["rdfs__comment"] || "";
                        const range = cache.frontmatter["rdfs__range"] || "string";
                        const isRequired = cache.frontmatter["exo__Property_isRequired"] || false;
                        const options = cache.frontmatter["exo__Property_options"] || null;
                        console.log(`Found property ${propertyName} for class ${className}`);
                        // Determine property type based on range and options
                        let type = this.mapRangeToType(range);
                        if (options && Array.isArray(options)) {
                            type = "enum";
                        }
                        else if (range === "select" && options) {
                            type = "enum";
                        }
                        this.properties.push({
                            name: propertyName,
                            label: label,
                            description: description,
                            type: type,
                            isRequired: isRequired,
                            range: range,
                            options: options,
                        });
                    }
                }
            }
        }
        console.log(`Found ${this.properties.length} properties for class ${className}`);
        // Add some default properties for common classes
        if (this.properties.length === 0 && className === "exo__Asset") {
            this.properties.push({
                name: "description",
                label: "Description",
                description: "A brief description of the asset",
                type: "text",
                isRequired: false,
            }, {
                name: "tags",
                label: "Tags",
                description: "Tags for categorization",
                type: "array",
                isRequired: false,
            });
        }
        if (this.properties.length === 0) {
            this.propertiesContainer.createEl("p", {
                text: "No specific properties for this class",
                cls: "exocortex-no-properties",
            });
            return;
        }
        // Create fields for all properties (including defaults)
        for (const prop of this.properties) {
            this.createPropertyField(prop);
        }
    }
    mapRangeToType(range) {
        // Map RDF/OWL ranges to input types
        if (range === "select")
            return "enum";
        if (range.includes("boolean"))
            return "boolean";
        if (range.includes("date") || range.includes("Date"))
            return "date";
        if (range.includes("integer") ||
            range.includes("decimal") ||
            range.includes("float"))
            return "number";
        if (range.includes("string") && range.includes("[]"))
            return "array";
        if (range.includes("text") || range.includes("Text"))
            return "text";
        return "string"; // default
    }
    createPropertyField(property) {
        if (!this.propertiesContainer)
            return;
        const setting = new obsidian_1.Setting(this.propertiesContainer)
            .setName(property.label + (property.isRequired ? " *" : ""))
            .setDesc(property.description);
        // Create appropriate input based on property type
        switch (property.type) {
            case "enum":
                this.createEnumField(setting, property);
                break;
            case "boolean":
                this.createBooleanField(setting, property);
                break;
            case "date":
                this.createDateField(setting, property);
                break;
            case "number":
                this.createNumberField(setting, property);
                break;
            case "text":
                this.createTextAreaField(setting, property);
                break;
            case "array":
                this.createArrayField(setting, property);
                break;
            default:
                this.createTextField(setting, property);
        }
    }
    createEnumField(setting, property) {
        setting.addDropdown((dropdown) => {
            dropdown.addOption("", "-- Select --");
            for (const option of property.options) {
                dropdown.addOption(option, option);
            }
            dropdown.onChange((value) => {
                if (value) {
                    this.propertyValues.set(property.name, value);
                }
                else {
                    this.propertyValues.delete(property.name);
                }
            });
        });
    }
    createBooleanField(setting, property) {
        setting.addToggle((toggle) => {
            toggle.onChange((value) => {
                this.propertyValues.set(property.name, value);
            });
        });
    }
    createDateField(setting, property) {
        setting.addText((text) => {
            text.setPlaceholder("YYYY-MM-DD").onChange((value) => {
                if (value) {
                    this.propertyValues.set(property.name, value);
                }
                else {
                    this.propertyValues.delete(property.name);
                }
            });
            // Set the input type to date
            text.inputEl.type = "date";
        });
    }
    createNumberField(setting, property) {
        setting.addText((text) => {
            text.setPlaceholder("Enter number").onChange((value) => {
                if (value) {
                    const num = parseFloat(value);
                    if (!isNaN(num)) {
                        this.propertyValues.set(property.name, num);
                    }
                }
                else {
                    this.propertyValues.delete(property.name);
                }
            });
        });
    }
    createTextAreaField(setting, property) {
        setting.addTextArea((text) => {
            text
                .setPlaceholder("Enter " + property.label.toLowerCase())
                .onChange((value) => {
                if (value) {
                    this.propertyValues.set(property.name, value);
                }
                else {
                    this.propertyValues.delete(property.name);
                }
            });
        });
    }
    createArrayField(setting, property) {
        setting.addText((text) => {
            text
                .setPlaceholder("Comma-separated values or [[links]]")
                .onChange((value) => {
                if (value) {
                    if (value.includes("[[")) {
                        const links = value.match(/\[\[([^\]]+)\]\]/g) || [];
                        this.propertyValues.set(property.name, links);
                    }
                    else {
                        const items = value
                            .split(",")
                            .map((s) => s.trim())
                            .filter((s) => s);
                        this.propertyValues.set(property.name, items);
                    }
                }
                else {
                    this.propertyValues.delete(property.name);
                }
            });
        });
    }
    createTextField(setting, property) {
        setting.addText((text) => {
            text
                .setPlaceholder("Enter " + property.label.toLowerCase())
                .onChange((value) => {
                if (value) {
                    this.propertyValues.set(property.name, value);
                }
                else {
                    this.propertyValues.delete(property.name);
                }
            });
        });
    }
    setupActionButtons(containerEl) {
        new obsidian_1.Setting(containerEl).addButton((btn) => btn
            .setButtonText("Create")
            .setCta()
            .onClick(async () => {
            await this.createAsset();
        }));
    }
    async createAsset() {
        // Use circuit breaker for resilient asset creation
        const result = await this.circuitBreaker.execute("asset-creation", async () => {
            // Convert property values to plain object
            const properties = {};
            for (const [key, value] of this.propertyValues) {
                properties[key] = value;
            }
            // Execute use case
            const response = await this.createAssetUseCase.execute({
                title: this.assetTitle,
                className: this.assetClass,
                ontologyPrefix: this.assetOntology,
                properties,
            });
            if (response.success) {
                return Result_1.Result.ok(response);
            }
            else {
                return Result_1.Result.fail(response.error || "Asset creation failed");
            }
        }, {
            failureThreshold: 3,
            resetTimeout: 30000,
            halfOpenMaxCalls: 2,
        });
        if (result.isSuccess) {
            const response = result.getValue();
            new obsidian_1.Notice(response.message);
            this.close();
        }
        else {
            const error = result.getError();
            console.error("Asset creation failed:", error);
            // Provide user-friendly error messages
            if (error.includes("Circuit")) {
                new obsidian_1.Notice("Asset creation is temporarily unavailable. Please try again in a moment.", 5000);
            }
            else if (error.includes("ontology")) {
                new obsidian_1.Notice(`Ontology issue: ${error}`, 8000);
            }
            else if (error.includes("validation") || error.includes("Invalid")) {
                new obsidian_1.Notice(`Validation error: ${error}`, 6000);
            }
            else {
                new obsidian_1.Notice(`Error: ${error}`, 5000);
            }
        }
    }
    onClose() {
        // Clear content - try Obsidian method first, fallback to DOM
        if ("empty" in this.contentEl &&
            typeof this.contentEl.empty === "function") {
            this.contentEl.empty();
        }
        else {
            // Fallback to standard DOM method - use innerHTML for complete cleanup
            // Try both methods to ensure compatibility
            this.contentEl.innerHTML = "";
            // Also try removing children manually as additional fallback
            while (this.contentEl.firstChild) {
                this.contentEl.removeChild(this.contentEl.firstChild);
            }
        }
    }
}
exports.CreateAssetModal = CreateAssetModal;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL3ByZXNlbnRhdGlvbi9tb2RhbHMvQ3JlYXRlQXNzZXRNb2RhbC50cyIsIm1hcHBpbmdzIjoiOzs7QUFBQSx1Q0FBOEQ7QUFFOUQsNEVBQXlFO0FBS3pFLHFEQUFrRDtBQUdsRDs7O0dBR0c7QUFDSCxNQUFhLGdCQUFpQixTQUFRLGdCQUFLO0lBZXpDLFlBQVksR0FBUTtRQUNsQixLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFmTCxlQUFVLEdBQVcsRUFBRSxDQUFDO1FBQ3hCLGVBQVUsR0FBVyxZQUFZLENBQUM7UUFDbEMsa0JBQWEsR0FBVyxFQUFFLENBQUM7UUFDM0IsbUJBQWMsR0FBcUIsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUM3Qyx3QkFBbUIsR0FBdUIsSUFBSSxDQUFDO1FBQy9DLGVBQVUsR0FBVSxFQUFFLENBQUMsQ0FBQyx1Q0FBdUM7UUFXckUsSUFBSSxDQUFDLFNBQVMsR0FBRyx5QkFBVyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQzNDLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLHFCQUFxQixFQUFFLENBQUM7UUFDakUsSUFBSSxDQUFDLGtCQUFrQixHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUM5QyxxQkFBcUIsQ0FDdEIsQ0FBQztRQUNGLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FDL0Msc0JBQXNCLENBQ3ZCLENBQUM7UUFDRixJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUN6QyxzQkFBc0IsQ0FDdkIsQ0FBQztRQUNGLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQzFDLHVCQUF1QixDQUN4QixDQUFDO0lBQ0osQ0FBQztJQUVELEtBQUssQ0FBQyxNQUFNO1FBQ1YsTUFBTSxFQUFFLFNBQVMsRUFB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LENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLENBQUMsQ0FBQzthQUN2RDtTQUNGO0lBQ0gsQ0FBQztDQUNGO0FBNWdCRCw0Q0E0Z0JDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9raXRlbGV2L0RvY3VtZW50cy9leG9jb3J0ZXgtb2JzaWRpYW4tcGx1Z2luL3NyYy9wcmVzZW50YXRpb24vbW9kYWxzL0NyZWF0ZUFzc2V0TW9kYWwudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQXBwLCBNb2RhbCwgU2V0dGluZywgTm90aWNlLCBURmlsZSB9IGZyb20gXCJvYnNpZGlhblwiO1xuaW1wb3J0IHsgQ3JlYXRlQXNzZXRVc2VDYXNlIH0gZnJvbSBcIi4uLy4uL2FwcGxpY2F0aW9uL3VzZS1jYXNlcy9DcmVhdGVBc3NldFVzZUNhc2VcIjtcbmltcG9ydCB7IERJQ29udGFpbmVyIH0gZnJvbSBcIi4uLy4uL2luZnJhc3RydWN0dXJlL2NvbnRhaW5lci9ESUNvbnRhaW5lclwiO1xuaW1wb3J0IHsgSU9udG9sb2d5UmVwb3NpdG9yeSB9IGZyb20gXCIuLi8uLi9kb21haW4vcmVwb3NpdG9yaWVzL0lPbnRvbG9neVJlcG9zaXRvcnlcIjtcbmltcG9ydCB7IElDbGFzc1ZpZXdSZXBvc2l0b3J5IH0gZnJvbSBcIi4uLy4uL2RvbWFpbi9yZXBvc2l0b3JpZXMvSUNsYXNzVmlld1JlcG9zaXRvcnlcIjtcbmltcG9ydCB7IFByb3BlcnR5Q2FjaGVTZXJ2aWNlIH0gZnJvbSBcIi4uLy4uL2RvbWFpbi9zZXJ2aWNlcy9Qcm9wZXJ0eUNhY2hlU2VydmljZVwiO1xuaW1wb3J0IHsgQ2lyY3VpdEJyZWFrZXJTZXJ2aWNlIH0gZnJvbSBcIi4uLy4uL2luZnJhc3RydWN0dXJlL3Jlc2lsaWVuY2UvQ2lyY3VpdEJyZWFrZXJTZXJ2aWNlXCI7XG5pbXBvcnQgeyBSZXN1bHQgfSBmcm9tIFwiLi4vLi4vZG9tYWluL2NvcmUvUmVzdWx0XCI7XG5pbXBvcnQgeyBDcmVhdGVBc3NldFJlc3BvbnNlIH0gZnJvbSBcIi4uLy4uL2FwcGxpY2F0aW9uL3VzZS1jYXNlcy9DcmVhdGVBc3NldFVzZUNhc2VcIjtcblxuLyoqXG4gKiBNb2RhbCBmb3IgY3JlYXRpbmcgbmV3IEV4b0Fzc2V0c1xuICogUHJlc2VudGF0aW9uIGxheWVyIGNvbXBvbmVudCB0aGF0IGRlbGVnYXRlcyB0byB1c2UgY2FzZXNcbiAqL1xuZXhwb3J0IGNsYXNzIENyZWF0ZUFzc2V0TW9kYWwgZXh0ZW5kcyBNb2RhbCB7XG4gIHByaXZhdGUgYXNzZXRUaXRsZTogc3RyaW5nID0gXCJcIjtcbiAgcHJpdmF0ZSBhc3NldENsYXNzOiBzdHJpbmcgPSBcImV4b19fQXNzZXRcIjtcbiAgcHJpdmF0ZSBhc3NldE9udG9sb2d5OiBzdHJpbmcgPSBcIlwiO1xuICBwcml2YXRlIHByb3BlcnR5VmFsdWVzOiBNYXA8c3RyaW5nLCBhbnk+ID0gbmV3IE1hcCgpO1xuICBwcml2YXRlIHByb3BlcnRpZXNDb250YWluZXI6IEhUTUxFbGVtZW50IHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgcHJvcGVydGllczogYW55W10gPSBbXTsgLy8gU3RvcmUgY3VycmVudCBwcm9wZXJ0aWVzIGZvciB0ZXN0aW5nXG5cbiAgcHJpdmF0ZSBjcmVhdGVBc3NldFVzZUNhc2U6IENyZWF0ZUFzc2V0VXNlQ2FzZTtcbiAgcHJpdmF0ZSBjb250YWluZXI6IERJQ29udGFpbmVyO1xuICBwcml2YXRlIG9udG9sb2d5UmVwb3NpdG9yeTogSU9udG9sb2d5UmVwb3NpdG9yeTtcbiAgcHJpdmF0ZSBjbGFzc1ZpZXdSZXBvc2l0b3J5OiBJQ2xhc3NWaWV3UmVwb3NpdG9yeTtcbiAgcHJpdmF0ZSBwcm9wZXJ0eUNhY2hlOiBQcm9wZXJ0eUNhY2hlU2VydmljZTtcbiAgcHJpdmF0ZSBjaXJjdWl0QnJlYWtlcjogQ2lyY3VpdEJyZWFrZXJTZXJ2aWNlO1xuXG4gIGNvbnN0cnVjdG9yKGFwcDogQXBwKSB7XG4gICAgc3VwZXIoYXBwKTtcbiAgICB0aGlzLmNvbnRhaW5lciA9IERJQ29udGFpbmVyLmdldEluc3RhbmNlKCk7XG4gICAgdGhpcy5jcmVhdGVBc3NldFVzZUNhc2UgPSB0aGlzLmNvbnRhaW5lci5nZXRDcmVhdGVBc3NldFVzZUNhc2UoKTtcbiAgICB0aGlzLm9udG9sb2d5UmVwb3NpdG9yeSA9IHRoaXMuY29udGFpbmVyLnJlc29sdmU8SU9udG9sb2d5UmVwb3NpdG9yeT4oXG4gICAgICBcIklPbnRvbG9neVJlcG9zaXRvcnlcIixcbiAgICApO1xuICAgIHRoaXMuY2xhc3NWaWV3UmVwb3NpdG9yeSA9IHRoaXMuY29udGFpbmVyLnJlc29sdmU8SUNsYXNzVmlld1JlcG9zaXRvcnk+KFxuICAgICAgXCJJQ2xhc3NWaWV3UmVwb3NpdG9yeVwiLFxuICAgICk7XG4gICAgdGhpcy5wcm9wZXJ0eUNhY2hlID0gdGhpcy5jb250YWluZXIucmVzb2x2ZTxQcm9wZXJ0eUNhY2hlU2VydmljZT4oXG4gICAgICBcIlByb3BlcnR5Q2FjaGVTZXJ2aWNlXCIsXG4gICAgKTtcbiAgICB0aGlzLmNpcmN1aXRCcmVha2VyID0gdGhpcy5jb250YWluZXIucmVzb2x2ZTxDaXJjdWl0QnJlYWtlclNlcnZpY2U+KFxuICAgICAgXCJDaXJjdWl0QnJlYWtlclNlcnZpY2VcIixcbiAgICApO1xuICB9XG5cbiAgYXN5bmMgb25PcGVuKCkge1xuICAgIGNvbnN0IHsgY29udGVudEVsIH0gPSB0aGlzO1xuICAgIGNvbnRlbnRFbC5jcmVhdGVFbChcImgyXCIsIHsgdGV4dDogXCJDcmVhdGUgRXhvQXNzZXRcIiB9KTtcblxuICAgIGF3YWl0IHRoaXMuc2V0dXBUaXRsZUZpZWxkKGNvbnRlbnRFbCk7XG4gICAgYXdhaXQgdGhpcy5zZXR1cENsYXNzRmllbGQoY29udGVudEVsKTtcbiAgICBhd2FpdCB0aGlzLnNldHVwT250b2xvZ3lGaWVsZChjb250ZW50RWwpO1xuICAgIGF3YWl0IHRoaXMuc2V0dXBQcm9wZXJ0aWVzU2VjdGlvbihjb250ZW50RWwpO1xuICAgIHRoaXMuc2V0dXBBY3Rpb25CdXR0b25zKGNvbnRlbnRFbCk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHNldHVwVGl0bGVGaWVsZChjb250YWluZXJFbDogSFRNTEVsZW1lbnQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBuZXcgU2V0dGluZyhjb250YWluZXJFbClcbiAgICAgIC5zZXROYW1lKFwiVGl0bGVcIilcbiAgICAgIC5zZXREZXNjKFwiQXNzZXQgdGl0bGVcIilcbiAgICAgIC5hZGRUZXh0KCh0ZXh0KSA9PlxuICAgICAgICB0ZXh0XG4gICAgICAgICAgLnNldFBsYWNlaG9sZGVyKFwiRW50ZXIgYXNzZXQgdGl0bGVcIilcbiAgICAgICAgICAuc2V0VmFsdWUodGhpcy5hc3NldFRpdGxlKVxuICAgICAgICAgIC5vbkNoYW5nZSgodmFsdWUpID0+ICh0aGlzLmFzc2V0VGl0bGUgPSB2YWx1ZSkpLFxuICAgICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2V0dXBDbGFzc0ZpZWxkKGNvbnRhaW5lckVsOiBIVE1MRWxlbWVudCk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIEdldCBhbGwgY2xhc3MgZmlsZXMgZnJvbSB0aGUgdmF1bHRcbiAgICBjb25zdCBmaWxlcyA9IHRoaXMuYXBwLnZhdWx0LmdldE1hcmtkb3duRmlsZXMoKTtcbiAgICBjb25zdCBjbGFzc2VzOiB7IGNsYXNzTmFtZTogc3RyaW5nOyBkaXNwbGF5TmFtZTogc3RyaW5nIH1bXSA9IFtdO1xuXG4gICAgLy8gRmluZCBhbGwgY2xhc3MgZGVmaW5pdGlvbnMgKGZpbGVzIHdpdGggZXhvX19DbGFzcyBmcm9udG1hdHRlcilcbiAgICBmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZXMpIHtcbiAgICAgIGNvbnN0IGNhY2hlID0gdGhpcy5hcHAubWV0YWRhdGFDYWNoZS5nZXRGaWxlQ2FjaGUoZmlsZSk7XG4gICAgICBpZiAoY2FjaGU/LmZyb250bWF0dGVyKSB7XG4gICAgICAgIGNvbnN0IGluc3RhbmNlQ2xhc3MgPSBjYWNoZS5mcm9udG1hdHRlcltcImV4b19fSW5zdGFuY2VfY2xhc3NcIl07XG4gICAgICAgIGlmIChcbiAgICAgICAgICBpbnN0YW5jZUNsYXNzID09PSBcIltbZXhvX19DbGFzc11dXCIgfHxcbiAgICAgICAgICBpbnN0YW5jZUNsYXNzID09PSBcImV4b19fQ2xhc3NcIlxuICAgICAgICApIHtcbiAgICAgICAgICBjb25zdCBjbGFzc05hbWUgPSBmaWxlLmJhc2VuYW1lO1xuICAgICAgICAgIGNvbnN0IGRpc3BsYXlOYW1lID0gY2FjaGUuZnJvbnRtYXR0ZXJbXCJyZGZzX19sYWJlbFwiXSB8fCBjbGFzc05hbWU7XG4gICAgICAgICAgY2xhc3Nlcy5wdXNoKHsgY2xhc3NOYW1lLCBkaXNwbGF5TmFtZSB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEFkZCBkZWZhdWx0IGNsYXNzZXMgaWYgbm9uZSBmb3VuZFxuICAgIGlmIChjbGFzc2VzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgY2xhc3Nlcy5wdXNoKFxuICAgICAgICB7IGNsYXNzTmFtZTogXCJleG9fX0Fzc2V0XCIsIGRpc3BsYXlOYW1lOiBcIkFzc2V0XCIgfSxcbiAgICAgICAgeyBjbGFzc05hbWU6IFwiZXhvX19DbGFzc1wiLCBkaXNwbGF5TmFtZTogXCJDbGFzc1wiIH0sXG4gICAgICAgIHsgY2xhc3NOYW1lOiBcImV4b19fUHJvcGVydHlcIiwgZGlzcGxheU5hbWU6IFwiUHJvcGVydHlcIiB9LFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBuZXcgU2V0dGluZyhjb250YWluZXJFbClcbiAgICAgIC5zZXROYW1lKFwiQ2xhc3NcIilcbiAgICAgIC5zZXREZXNjKFwiU2VsZWN0IHRoZSB0eXBlIG9mIGFzc2V0XCIpXG4gICAgICAuYWRkRHJvcGRvd24oKGRyb3Bkb3duKSA9PiB7XG4gICAgICAgIGZvciAoY29uc3QgY2xhc3NJbmZvIG9mIGNsYXNzZXMpIHtcbiAgICAgICAgICBkcm9wZG93bi5hZGRPcHRpb24oY2xhc3NJbmZvLmNsYXNzTmFtZSwgY2xhc3NJbmZvLmRpc3BsYXlOYW1lKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGRyb3Bkb3duLnNldFZhbHVlKHRoaXMuYXNzZXRDbGFzcyk7XG4gICAgICAgIGRyb3Bkb3duLm9uQ2hhbmdlKGFzeW5jICh2YWx1ZSkgPT4ge1xuICAgICAgICAgIHRoaXMuYXNzZXRDbGFzcyA9IHZhbHVlO1xuICAgICAgICAgIGF3YWl0IHRoaXMudXBkYXRlUHJvcGVydGllc0ZvckNsYXNzKHZhbHVlKTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgc2V0dXBPbnRvbG9neUZpZWxkKGNvbnRhaW5lckVsOiBIVE1MRWxlbWVudCk6IFByb21pc2U8dm9pZD4ge1xuICAgIC8vIEdldCBhbGwgb250b2xvZ3kgZmlsZXMgZnJvbSB0aGUgdmF1bHRcbiAgICBjb25zdCBmaWxlcyA9IHRoaXMuYXBwLnZhdWx0LmdldE1hcmtkb3duRmlsZXMoKTtcbiAgICBjb25zdCBvbnRvbG9naWVzOiB7IHByZWZpeDogc3RyaW5nOyBkaXNwbGF5TmFtZTogc3RyaW5nIH1bXSA9IFtdO1xuXG4gICAgLy8gRmluZCBhbGwgb250b2xvZ3kgZGVmaW5pdGlvbnMgKGZpbGVzIHN0YXJ0aW5nIHdpdGggISBvciBoYXZpbmcgZXhvX19PbnRvbG9neV9wcmVmaXgpXG4gICAgZm9yIChjb25zdCBmaWxlIG9mIGZpbGVzKSB7XG4gICAgICBpZiAoZmlsZS5uYW1lLnN0YXJ0c1dpdGgoXCIhXCIpKSB7XG4gICAgICAgIGNvbnN0IGNhY2hlID0gdGhpcy5hcHAubWV0YWRhdGFDYWNoZS5nZXRGaWxlQ2FjaGUoZmlsZSk7XG4gICAgICAgIGlmIChjYWNoZT8uZnJvbnRtYXR0ZXIpIHtcbiAgICAgICAgICBjb25zdCBwcmVmaXggPVxuICAgICAgICAgICAgY2FjaGUuZnJvbnRtYXR0ZXJbXCJleG9fX09udG9sb2d5X3ByZWZpeFwiXSB8fFxuICAgICAgICAgICAgZmlsZS5iYXNlbmFtZS5zdWJzdHJpbmcoMSk7XG4gICAgICAgICAgY29uc3QgZGlzcGxheU5hbWUgPSBjYWNoZS5mcm9udG1hdHRlcltcInJkZnNfX2xhYmVsXCJdIHx8IHByZWZpeDtcbiAgICAgICAgICBvbnRvbG9naWVzLnB1c2goeyBwcmVmaXgsIGRpc3BsYXlOYW1lIH0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQWRkIGRlZmF1bHQgb250b2xvZ2llcyBpZiBub25lIGZvdW5kXG4gICAgaWYgKG9udG9sb2dpZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICBvbnRvbG9naWVzLnB1c2goXG4gICAgICAgIHsgcHJlZml4OiBcImV4b1wiLCBkaXNwbGF5TmFtZTogXCJFeG9jb3J0ZXggQ29yZVwiIH0sXG4gICAgICAgIHsgcHJlZml4OiBcInVpXCIsIGRpc3BsYXlOYW1lOiBcIlVzZXIgSW50ZXJmYWNlXCIgfSxcbiAgICAgICAgeyBwcmVmaXg6IFwicmRmc1wiLCBkaXNwbGF5TmFtZTogXCJSREYgU2NoZW1hXCIgfSxcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgZGVmYXVsdE9udG9sb2d5ID0gXCJleG9cIjtcblxuICAgIC8vIFNldCBkZWZhdWx0IG9udG9sb2d5IHdoZW4gbm8gb250b2xvZ2llcyBmb3VuZCBpbiB2YXVsdFxuICAgIGlmIChvbnRvbG9naWVzLmxlbmd0aCA+IDAgJiYgIXRoaXMuYXNzZXRPbnRvbG9neSkge1xuICAgICAgdGhpcy5hc3NldE9udG9sb2d5ID0gZGVmYXVsdE9udG9sb2d5O1xuICAgIH1cblxuICAgIG5ldyBTZXR0aW5nKGNvbnRhaW5lckVsKVxuICAgICAgLnNldE5hbWUoXCJPbnRvbG9neVwiKVxuICAgICAgLnNldERlc2MoXCJTZWxlY3Qgd2hpY2gga25vd2xlZGdlIGdyYXBoIHRoaXMgYXNzZXQgYmVsb25ncyB0b1wiKVxuICAgICAgLmFkZERyb3Bkb3duKChkcm9wZG93bikgPT4ge1xuICAgICAgICBmb3IgKGNvbnN0IG9udG9sb2d5IG9mIG9udG9sb2dpZXMpIHtcbiAgICAgICAgICBkcm9wZG93bi5hZGRPcHRpb24ob250b2xvZ3kucHJlZml4LCBvbnRvbG9neS5kaXNwbGF5TmFtZSk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBTZXQgZGVmYXVsdCBvbnRvbG9neVxuICAgICAgICBpZiAoXG4gICAgICAgICAgZGVmYXVsdE9udG9sb2d5ICYmXG4gICAgICAgICAgb250b2xvZ2llcy5zb21lKChvOiBhbnkpID0+IG8ucHJlZml4ID09PSBkZWZhdWx0T250b2xvZ3kpXG4gICAgICAgICkge1xuICAgICAgICAgIHRoaXMuYXNzZXRPbnRvbG9neSA9IGRlZmF1bHRPbnRvbG9neTtcbiAgICAgICAgICBkcm9wZG93bi5zZXRWYWx1ZShkZWZhdWx0T250b2xvZ3kpO1xuICAgICAgICB9IGVsc2UgaWYgKG9udG9sb2dpZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgIHRoaXMuYXNzZXRPbnRvbG9neSA9IG9udG9sb2dpZXNbMF0ucHJlZml4O1xuICAgICAgICAgIGRyb3Bkb3duLnNldFZhbHVlKG9udG9sb2dpZXNbMF0ucHJlZml4KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGRyb3Bkb3duLm9uQ2hhbmdlKCh2YWx1ZSkgPT4ge1xuICAgICAgICAgIHRoaXMuYXNzZXRPbnRvbG9neSA9IHZhbHVlO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBzZXR1cFByb3BlcnRpZXNTZWN0aW9uKFxuICAgIGNvbnRhaW5lckVsOiBIVE1MRWxlbWVudCxcbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29udGFpbmVyRWwuY3JlYXRlRWwoXCJoM1wiLCB7XG4gICAgICB0ZXh0OiBcIlByb3BlcnRpZXNcIixcbiAgICAgIGNsczogXCJleG9jb3J0ZXgtcHJvcGVydGllcy1oZWFkZXJcIixcbiAgICB9KTtcblxuICAgIHRoaXMucHJvcGVydGllc0NvbnRhaW5lciA9IGNvbnRhaW5lckVsLmNyZWF0ZURpdih7XG4gICAgICBjbHM6IFwiZXhvY29ydGV4LXByb3BlcnRpZXMtY29udGFpbmVyXCIsXG4gICAgfSk7XG5cbiAgICBhd2FpdCB0aGlzLnVwZGF0ZVByb3BlcnRpZXNGb3JDbGFzcyh0aGlzLmFzc2V0Q2xhc3MpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyB1cGRhdGVQcm9wZXJ0aWVzRm9yQ2xhc3MoY2xhc3NOYW1lOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIXRoaXMucHJvcGVydGllc0NvbnRhaW5lcikgcmV0dXJuO1xuXG4gICAgY29uc29sZS5sb2coYFVwZGF0aW5nIHByb3BlcnRpZXMgZm9yIGNsYXNzOiAke2NsYXNzTmFtZX1gKTtcblxuICAgIC8vIENsZWFyIHRoZSBjb250YWluZXIgLSB0cnkgT2JzaWRpYW4gbWV0aG9kIGZpcnN0LCBmYWxsYmFjayB0byBET01cbiAgICBpZiAoXG4gICAgICBcImVtcHR5XCIgaW4gdGhpcy5wcm9wZXJ0aWVzQ29udGFpbmVyICYmXG4gICAgICB0eXBlb2YgKHRoaXMucHJvcGVydGllc0NvbnRhaW5lciBhcyBhbnkpLmVtcHR5ID09PSBcImZ1bmN0aW9uXCJcbiAgICApIHtcbiAgICAgICh0aGlzLnByb3BlcnRpZXNDb250YWluZXIgYXMgYW55KS5lbXB0eSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBGYWxsYmFjayB0byBzdGFuZGFyZCBET00gbWV0aG9kIC0gdXNlIGlubmVySFRNTCBmb3IgY29tcGxldGUgY2xlYW51cFxuICAgICAgdGhpcy5wcm9wZXJ0aWVzQ29udGFpbmVyLmlubmVySFRNTCA9IFwiXCI7XG4gICAgfVxuICAgIHRoaXMucHJvcGVydHlWYWx1ZXMuY2xlYXIoKTtcblxuICAgIC8vIEdldCBwcm9wZXJ0aWVzIGZvciB0aGlzIGNsYXNzXG4gICAgdGhpcy5wcm9wZXJ0aWVzID0gW107XG4gICAgY29uc3QgZmlsZXMgPSB0aGlzLmFwcC52YXVsdC5nZXRNYXJrZG93bkZpbGVzKCk7XG5cbiAgICBjb25zb2xlLmxvZyhgU2Nhbm5pbmcgJHtmaWxlcy5sZW5ndGh9IGZpbGVzIGZvciBwcm9wZXJ0aWVzLi4uYCk7XG5cbiAgICAvLyBGaW5kIGFsbCBwcm9wZXJ0eSBkZWZpbml0aW9ucyByZWxhdGVkIHRvIHRoaXMgY2xhc3NcbiAgICBmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZXMpIHtcbiAgICAgIGNvbnN0IGNhY2hlID0gdGhpcy5hcHAubWV0YWRhdGFDYWNoZS5nZXRGaWxlQ2FjaGUoZmlsZSk7XG4gICAgICBpZiAoY2FjaGU/LmZyb250bWF0dGVyKSB7XG4gICAgICAgIGNvbnN0IGluc3RhbmNlQ2xhc3MgPSBjYWNoZS5mcm9udG1hdHRlcltcImV4b19fSW5zdGFuY2VfY2xhc3NcIl07XG4gICAgICAgIGlmIChcbiAgICAgICAgICBpbnN0YW5jZUNsYXNzID09PSBcIltbZXhvX19Qcm9wZXJ0eV1dXCIgfHxcbiAgICAgICAgICBpbnN0YW5jZUNsYXNzID09PSBcImV4b19fUHJvcGVydHlcIlxuICAgICAgICApIHtcbiAgICAgICAgICBjb25zdCBkb21haW4gPSBjYWNoZS5mcm9udG1hdHRlcltcInJkZnNfX2RvbWFpblwiXTtcbiAgICAgICAgICAvLyBDaGVjayBpZiB0aGlzIHByb3BlcnR5IGJlbG9uZ3MgdG8gdGhlIGN1cnJlbnQgY2xhc3NcbiAgICAgICAgICBpZiAoXG4gICAgICAgICAgICBkb21haW4gPT09IGBbWyR7Y2xhc3NOYW1lfV1dYCB8fFxuICAgICAgICAgICAgZG9tYWluID09PSBjbGFzc05hbWUgfHxcbiAgICAgICAgICAgIChBcnJheS5pc0FycmF5KGRvbWFpbikgJiZcbiAgICAgICAgICAgICAgKGRvbWFpbi5pbmNsdWRlcyhjbGFzc05hbWUpIHx8XG4gICAgICAgICAgICAgICAgZG9tYWluLmluY2x1ZGVzKGBbWyR7Y2xhc3NOYW1lfV1dYCkpKVxuICAgICAgICAgICkge1xuICAgICAgICAgICAgY29uc3QgcHJvcGVydHlOYW1lID0gZmlsZS5iYXNlbmFtZTtcbiAgICAgICAgICAgIGNvbnN0IGxhYmVsID0gY2FjaGUuZnJvbnRtYXR0ZXJbXCJyZGZzX19sYWJlbFwiXSB8fCBwcm9wZXJ0eU5hbWU7XG4gICAgICAgICAgICBjb25zdCBkZXNjcmlwdGlvbiA9IGNhY2hlLmZyb250bWF0dGVyW1wicmRmc19fY29tbWVudFwiXSB8fCBcIlwiO1xuICAgICAgICAgICAgY29uc3QgcmFuZ2UgPSBjYWNoZS5mcm9udG1hdHRlcltcInJkZnNfX3JhbmdlXCJdIHx8IFwic3RyaW5nXCI7XG4gICAgICAgICAgICBjb25zdCBpc1JlcXVpcmVkID1cbiAgICAgICAgICAgICAgY2FjaGUuZnJvbnRtYXR0ZXJbXCJleG9fX1Byb3BlcnR5X2lzUmVxdWlyZWRcIl0gfHwgZmFsc2U7XG4gICAgICAgICAgICBjb25zdCBvcHRpb25zID0gY2FjaGUuZnJvbnRtYXR0ZXJbXCJleG9fX1Byb3BlcnR5X29wdGlvbnNcIl0gfHwgbnVsbDtcblxuICAgICAgICAgICAgY29uc29sZS5sb2coXG4gICAgICAgICAgICAgIGBGb3VuZCBwcm9wZXJ0eSAke3Byb3BlcnR5TmFtZX0gZm9yIGNsYXNzICR7Y2xhc3NOYW1lfWAsXG4gICAgICAgICAgICApO1xuXG4gICAgICAgICAgICAvLyBEZXRlcm1pbmUgcHJvcGVydHkgdHlwZSBiYXNlZCBvbiByYW5nZSBhbmQgb3B0aW9uc1xuICAgICAgICAgICAgbGV0IHR5cGUgPSB0aGlzLm1hcFJhbmdlVG9UeXBlKHJhbmdlKTtcbiAgICAgICAgICAgIGlmIChvcHRpb25zICYmIEFycmF5LmlzQXJyYXkob3B0aW9ucykpIHtcbiAgICAgICAgICAgICAgdHlwZSA9IFwiZW51bVwiO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChyYW5nZSA9PT0gXCJzZWxlY3RcIiAmJiBvcHRpb25zKSB7XG4gICAgICAgICAgICAgIHR5cGUgPSBcImVudW1cIjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgdGhpcy5wcm9wZXJ0aWVzLnB1c2goe1xuICAgICAgICAgICAgICBuYW1lOiBwcm9wZXJ0eU5hbWUsXG4gICAgICAgICAgICAgIGxhYmVsOiBsYWJlbCxcbiAgICAgICAgICAgICAgZGVzY3JpcHRpb246IGRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgICB0eXBlOiB0eXBlLFxuICAgICAgICAgICAgICBpc1JlcXVpcmVkOiBpc1JlcXVpcmVkLFxuICAgICAgICAgICAgICByYW5nZTogcmFuZ2UsXG4gICAgICAgICAgICAgIG9wdGlvbnM6IG9wdGlvbnMsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zb2xlLmxvZyhcbiAgICAgIGBGb3VuZCAke3RoaXMucHJvcGVydGllcy5sZW5ndGh9IHByb3BlcnRpZXMgZm9yIGNsYXNzICR7Y2xhc3NOYW1lfWAsXG4gICAgKTtcblxuICAgIC8vIEFkZCBzb21lIGRlZmF1bHQgcHJvcGVydGllcyBmb3IgY29tbW9uIGNsYXNzZXNcbiAgICBpZiAodGhpcy5wcm9wZXJ0aWVzLmxlbmd0aCA9PT0gMCAmJiBjbGFzc05hbWUgPT09IFwiZXhvX19Bc3NldFwiKSB7XG4gICAgICB0aGlzLnByb3BlcnRpZXMucHVzaChcbiAgICAgICAge1xuICAgICAgICAgIG5hbWU6IFwiZGVzY3JpcHRpb25cIixcbiAgICAgICAgICBsYWJlbDogXCJEZXNjcmlwdGlvblwiLFxuICAgICAgICAgIGRlc2NyaXB0aW9uOiBcIkEgYnJpZWYgZGVzY3JpcHRpb24gb2YgdGhlIGFzc2V0XCIsXG4gICAgICAgICAgdHlwZTogXCJ0ZXh0XCIsXG4gICAgICAgICAgaXNSZXF1aXJlZDogZmFsc2UsXG4gICAgICAgIH0sXG4gICAgICAgIHtcbiAgICAgICAgICBuYW1lOiBcInRhZ3NcIixcbiAgICAgICAgICBsYWJlbDogXCJUYWdzXCIsXG4gICAgICAgICAgZGVzY3JpcHRpb246IFwiVGFncyBmb3IgY2F0ZWdvcml6YXRpb25cIixcbiAgICAgICAgICB0eXBlOiBcImFycmF5XCIsXG4gICAgICAgICAgaXNSZXF1aXJlZDogZmFsc2UsXG4gICAgICAgIH0sXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmICh0aGlzLnByb3BlcnRpZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICB0aGlzLnByb3BlcnRpZXNDb250YWluZXIuY3JlYXRlRWwoXCJwXCIsIHtcbiAgICAgICAgdGV4dDogXCJObyBzcGVjaWZpYyBwcm9wZXJ0aWVzIGZvciB0aGlzIGNsYXNzXCIsXG4gICAgICAgIGNsczogXCJleG9jb3J0ZXgtbm8tcHJvcGVydGllc1wiLFxuICAgICAgfSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIGZpZWxkcyBmb3IgYWxsIHByb3BlcnRpZXMgKGluY2x1ZGluZyBkZWZhdWx0cylcbiAgICBmb3IgKGNvbnN0IHByb3Agb2YgdGhpcy5wcm9wZXJ0aWVzKSB7XG4gICAgICB0aGlzLmNyZWF0ZVByb3BlcnR5RmllbGQocHJvcCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBtYXBSYW5nZVRvVHlwZShyYW5nZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAvLyBNYXAgUkRGL09XTCByYW5nZXMgdG8gaW5wdXQgdHlwZXNcbiAgICBpZiAocmFuZ2UgPT09IFwic2VsZWN0XCIpIHJldHVybiBcImVudW1cIjtcbiAgICBpZiAocmFuZ2UuaW5jbHVkZXMoXCJib29sZWFuXCIpKSByZXR1cm4gXCJib29sZWFuXCI7XG4gICAgaWYgKHJhbmdlLmluY2x1ZGVzKFwiZGF0ZVwiKSB8fCByYW5nZS5pbmNsdWRlcyhcIkRhdGVcIikpIHJldHVybiBcImRhdGVcIjtcbiAgICBpZiAoXG4gICAgICByYW5nZS5pbmNsdWRlcyhcImludGVnZXJcIikgfHxcbiAgICAgIHJhbmdlLmluY2x1ZGVzKFwiZGVjaW1hbFwiKSB8fFxuICAgICAgcmFuZ2UuaW5jbHVkZXMoXCJmbG9hdFwiKVxuICAgIClcbiAgICAgIHJldHVybiBcIm51bWJlclwiO1xuICAgIGlmIChyYW5nZS5pbmNsdWRlcyhcInN0cmluZ1wiKSAmJiByYW5nZS5pbmNsdWRlcyhcIltdXCIpKSByZXR1cm4gXCJhcnJheVwiO1xuICAgIGlmIChyYW5nZS5pbmNsdWRlcyhcInRleHRcIikgfHwgcmFuZ2UuaW5jbHVkZXMoXCJUZXh0XCIpKSByZXR1cm4gXCJ0ZXh0XCI7XG4gICAgcmV0dXJuIFwic3RyaW5nXCI7IC8vIGRlZmF1bHRcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlUHJvcGVydHlGaWVsZChwcm9wZXJ0eTogYW55KTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLnByb3BlcnRpZXNDb250YWluZXIpIHJldHVybjtcblxuICAgIGNvbnN0IHNldHRpbmcgPSBuZXcgU2V0dGluZyh0aGlzLnByb3BlcnRpZXNDb250YWluZXIpXG4gICAgICAuc2V0TmFtZShwcm9wZXJ0eS5sYWJlbCArIChwcm9wZXJ0eS5pc1JlcXVpcmVkID8gXCIgKlwiIDogXCJcIikpXG4gICAgICAuc2V0RGVzYyhwcm9wZXJ0eS5kZXNjcmlwdGlvbik7XG5cbiAgICAvLyBDcmVhdGUgYXBwcm9wcmlhdGUgaW5wdXQgYmFzZWQgb24gcHJvcGVydHkgdHlwZVxuICAgIHN3aXRjaCAocHJvcGVydHkudHlwZSkge1xuICAgICAgY2FzZSBcImVudW1cIjpcbiAgICAgICAgdGhpcy5jcmVhdGVFbnVtRmllbGQoc2V0dGluZywgcHJvcGVydHkpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCJib29sZWFuXCI6XG4gICAgICAgIHRoaXMuY3JlYXRlQm9vbGVhbkZpZWxkKHNldHRpbmcsIHByb3BlcnR5KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwiZGF0ZVwiOlxuICAgICAgICB0aGlzLmNyZWF0ZURhdGVGaWVsZChzZXR0aW5nLCBwcm9wZXJ0eSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBcIm51bWJlclwiOlxuICAgICAgICB0aGlzLmNyZWF0ZU51bWJlckZpZWxkKHNldHRpbmcsIHByb3BlcnR5KTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIFwidGV4dFwiOlxuICAgICAgICB0aGlzLmNyZWF0ZVRleHRBcmVhRmllbGQoc2V0dGluZywgcHJvcGVydHkpO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgXCJhcnJheVwiOlxuICAgICAgICB0aGlzLmNyZWF0ZUFycmF5RmllbGQoc2V0dGluZywgcHJvcGVydHkpO1xuICAgICAgICBicmVhaztcbiAgICAgIGRlZmF1bHQ6XG4gICAgICAgIHRoaXMuY3JlYXRlVGV4dEZpZWxkKHNldHRpbmcsIHByb3BlcnR5KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUVudW1GaWVsZChzZXR0aW5nOiBTZXR0aW5nLCBwcm9wZXJ0eTogYW55KTogdm9pZCB7XG4gICAgc2V0dGluZy5hZGREcm9wZG93bigoZHJvcGRvd24pID0+IHtcbiAgICAgIGRyb3Bkb3duLmFkZE9wdGlvbihcIlwiLCBcIi0tIFNlbGVjdCAtLVwiKTtcbiAgICAgIGZvciAoY29uc3Qgb3B0aW9uIG9mIHByb3BlcnR5Lm9wdGlvbnMpIHtcbiAgICAgICAgZHJvcGRvd24uYWRkT3B0aW9uKG9wdGlvbiwgb3B0aW9uKTtcbiAgICAgIH1cbiAgICAgIGRyb3Bkb3duLm9uQ2hhbmdlKCh2YWx1ZSkgPT4ge1xuICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICB0aGlzLnByb3BlcnR5VmFsdWVzLnNldChwcm9wZXJ0eS5uYW1lLCB2YWx1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5wcm9wZXJ0eVZhbHVlcy5kZWxldGUocHJvcGVydHkubmFtZSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVCb29sZWFuRmllbGQoc2V0dGluZzogU2V0dGluZywgcHJvcGVydHk6IGFueSk6IHZvaWQge1xuICAgIHNldHRpbmcuYWRkVG9nZ2xlKCh0b2dnbGUpID0+IHtcbiAgICAgIHRvZ2dsZS5vbkNoYW5nZSgodmFsdWUpID0+IHtcbiAgICAgICAgdGhpcy5wcm9wZXJ0eVZhbHVlcy5zZXQocHJvcGVydHkubmFtZSwgdmFsdWUpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZURhdGVGaWVsZChzZXR0aW5nOiBTZXR0aW5nLCBwcm9wZXJ0eTogYW55KTogdm9pZCB7XG4gICAgc2V0dGluZy5hZGRUZXh0KCh0ZXh0KSA9PiB7XG4gICAgICB0ZXh0LnNldFBsYWNlaG9sZGVyKFwiWVlZWS1NTS1ERFwiKS5vbkNoYW5nZSgodmFsdWUpID0+IHtcbiAgICAgICAgaWYgKHZhbHVlKSB7XG4gICAgICAgICAgdGhpcy5wcm9wZXJ0eVZhbHVlcy5zZXQocHJvcGVydHkubmFtZSwgdmFsdWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMucHJvcGVydHlWYWx1ZXMuZGVsZXRlKHByb3BlcnR5Lm5hbWUpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIC8vIFNldCB0aGUgaW5wdXQgdHlwZSB0byBkYXRlXG4gICAgICB0ZXh0LmlucHV0RWwudHlwZSA9IFwiZGF0ZVwiO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVOdW1iZXJGaWVsZChzZXR0aW5nOiBTZXR0aW5nLCBwcm9wZXJ0eTogYW55KTogdm9pZCB7XG4gICAgc2V0dGluZy5hZGRUZXh0KCh0ZXh0KSA9PiB7XG4gICAgICB0ZXh0LnNldFBsYWNlaG9sZGVyKFwiRW50ZXIgbnVtYmVyXCIpLm9uQ2hhbmdlKCh2YWx1ZSkgPT4ge1xuICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICBjb25zdCBudW0gPSBwYXJzZUZsb2F0KHZhbHVlKTtcbiAgICAgICAgICBpZiAoIWlzTmFOKG51bSkpIHtcbiAgICAgICAgICAgIHRoaXMucHJvcGVydHlWYWx1ZXMuc2V0KHByb3BlcnR5Lm5hbWUsIG51bSk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMucHJvcGVydHlWYWx1ZXMuZGVsZXRlKHByb3BlcnR5Lm5hbWUpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlVGV4dEFyZWFGaWVsZChzZXR0aW5nOiBTZXR0aW5nLCBwcm9wZXJ0eTogYW55KTogdm9pZCB7XG4gICAgc2V0dGluZy5hZGRUZXh0QXJlYSgodGV4dCkgPT4ge1xuICAgICAgdGV4dFxuICAgICAgICAuc2V0UGxhY2Vob2xkZXIoXCJFbnRlciBcIiArIHByb3BlcnR5LmxhYmVsLnRvTG93ZXJDYXNlKCkpXG4gICAgICAgIC5vbkNoYW5nZSgodmFsdWUpID0+IHtcbiAgICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgIHRoaXMucHJvcGVydHlWYWx1ZXMuc2V0KHByb3BlcnR5Lm5hbWUsIHZhbHVlKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5wcm9wZXJ0eVZhbHVlcy5kZWxldGUocHJvcGVydHkubmFtZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlQXJyYXlGaWVsZChzZXR0aW5nOiBTZXR0aW5nLCBwcm9wZXJ0eTogYW55KTogdm9pZCB7XG4gICAgc2V0dGluZy5hZGRUZXh0KCh0ZXh0KSA9PiB7XG4gICAgICB0ZXh0XG4gICAgICAgIC5zZXRQbGFjZWhvbGRlcihcIkNvbW1hLXNlcGFyYXRlZCB2YWx1ZXMgb3IgW1tsaW5rc11dXCIpXG4gICAgICAgIC5vbkNoYW5nZSgodmFsdWUpID0+IHtcbiAgICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgIGlmICh2YWx1ZS5pbmNsdWRlcyhcIltbXCIpKSB7XG4gICAgICAgICAgICAgIGNvbnN0IGxpbmtzID0gdmFsdWUubWF0Y2goL1xcW1xcWyhbXlxcXV0rKVxcXVxcXS9nKSB8fCBbXTtcbiAgICAgICAgICAgICAgdGhpcy5wcm9wZXJ0eVZhbHVlcy5zZXQocHJvcGVydHkubmFtZSwgbGlua3MpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgY29uc3QgaXRlbXMgPSB2YWx1ZVxuICAgICAgICAgICAgICAgIC5zcGxpdChcIixcIilcbiAgICAgICAgICAgICAgICAubWFwKChzKSA9PiBzLnRyaW0oKSlcbiAgICAgICAgICAgICAgICAuZmlsdGVyKChzKSA9PiBzKTtcbiAgICAgICAgICAgICAgdGhpcy5wcm9wZXJ0eVZhbHVlcy5zZXQocHJvcGVydHkubmFtZSwgaXRlbXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICB0aGlzLnByb3BlcnR5VmFsdWVzLmRlbGV0ZShwcm9wZXJ0eS5uYW1lKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVUZXh0RmllbGQoc2V0dGluZzogU2V0dGluZywgcHJvcGVydHk6IGFueSk6IHZvaWQge1xuICAgIHNldHRpbmcuYWRkVGV4dCgodGV4dCkgPT4ge1xuICAgICAgdGV4dFxuICAgICAgICAuc2V0UGxhY2Vob2xkZXIoXCJFbnRlciBcIiArIHByb3BlcnR5LmxhYmVsLnRvTG93ZXJDYXNlKCkpXG4gICAgICAgIC5vbkNoYW5nZSgodmFsdWUpID0+IHtcbiAgICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICAgIHRoaXMucHJvcGVydHlWYWx1ZXMuc2V0KHByb3BlcnR5Lm5hbWUsIHZhbHVlKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5wcm9wZXJ0eVZhbHVlcy5kZWxldGUocHJvcGVydHkubmFtZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0dXBBY3Rpb25CdXR0b25zKGNvbnRhaW5lckVsOiBIVE1MRWxlbWVudCk6IHZvaWQge1xuICAgIG5ldyBTZXR0aW5nKGNvbnRhaW5lckVsKS5hZGRCdXR0b24oKGJ0bikgPT5cbiAgICAgIGJ0blxuICAgICAgICAuc2V0QnV0dG9uVGV4dChcIkNyZWF0ZVwiKVxuICAgICAgICAuc2V0Q3RhKClcbiAgICAgICAgLm9uQ2xpY2soYXN5bmMgKCkgPT4ge1xuICAgICAgICAgIGF3YWl0IHRoaXMuY3JlYXRlQXNzZXQoKTtcbiAgICAgICAgfSksXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgY3JlYXRlQXNzZXQoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgLy8gVXNlIGNpcmN1aXQgYnJlYWtlciBmb3IgcmVzaWxpZW50IGFzc2V0IGNyZWF0aW9uXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5jaXJjdWl0QnJlYWtlci5leGVjdXRlPENyZWF0ZUFzc2V0UmVzcG9uc2U+KFxuICAgICAgXCJhc3NldC1jcmVhdGlvblwiLFxuICAgICAgYXN5bmMgKCk6IFByb21pc2U8UmVzdWx0PENyZWF0ZUFzc2V0UmVzcG9uc2U+PiA9PiB7XG4gICAgICAgIC8vIENvbnZlcnQgcHJvcGVydHkgdmFsdWVzIHRvIHBsYWluIG9iamVjdFxuICAgICAgICBjb25zdCBwcm9wZXJ0aWVzOiBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0ge307XG4gICAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIHRoaXMucHJvcGVydHlWYWx1ZXMpIHtcbiAgICAgICAgICBwcm9wZXJ0aWVzW2tleV0gPSB2YWx1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEV4ZWN1dGUgdXNlIGNhc2VcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmNyZWF0ZUFzc2V0VXNlQ2FzZS5leGVjdXRlKHtcbiAgICAgICAgICB0aXRsZTogdGhpcy5hc3NldFRpdGxlLFxuICAgICAgICAgIGNsYXNzTmFtZTogdGhpcy5hc3NldENsYXNzLFxuICAgICAgICAgIG9udG9sb2d5UHJlZml4OiB0aGlzLmFzc2V0T250b2xvZ3ksXG4gICAgICAgICAgcHJvcGVydGllcyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKHJlc3BvbnNlLnN1Y2Nlc3MpIHtcbiAgICAgICAgICByZXR1cm4gUmVzdWx0Lm9rKHJlc3BvbnNlKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4gUmVzdWx0LmZhaWwocmVzcG9uc2UuZXJyb3IgfHwgXCJBc3NldCBjcmVhdGlvbiBmYWlsZWRcIik7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICB7XG4gICAgICAgIGZhaWx1cmVUaHJlc2hvbGQ6IDMsXG4gICAgICAgIHJlc2V0VGltZW91dDogMzAwMDAsIC8vIDMwIHNlY29uZHNcbiAgICAgICAgaGFsZk9wZW5NYXhDYWxsczogMixcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIGlmIChyZXN1bHQuaXNTdWNjZXNzKSB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IHJlc3VsdC5nZXRWYWx1ZSgpITtcbiAgICAgIG5ldyBOb3RpY2UocmVzcG9uc2UubWVzc2FnZSk7XG4gICAgICB0aGlzLmNsb3NlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGVycm9yID0gcmVzdWx0LmdldEVycm9yKCk7XG4gICAgICBjb25zb2xlLmVycm9yKFwiQXNzZXQgY3JlYXRpb24gZmFpbGVkOlwiLCBlcnJvcik7XG4gICAgICBcbiAgICAgIC8vIFByb3ZpZGUgdXNlci1mcmllbmRseSBlcnJvciBtZXNzYWdlc1xuICAgICAgaWYgKGVycm9yLmluY2x1ZGVzKFwiQ2lyY3VpdFwiKSkge1xuICAgICAgICBuZXcgTm90aWNlKFwiQXNzZXQgY3JlYXRpb24gaXMgdGVtcG9yYXJpbHkgdW5hdmFpbGFibGUuIFBsZWFzZSB0cnkgYWdhaW4gaW4gYSBtb21lbnQuXCIsIDUwMDApO1xuICAgICAgfSBlbHNlIGlmIChlcnJvci5pbmNsdWRlcyhcIm9udG9sb2d5XCIpKSB7XG4gICAgICAgIG5ldyBOb3RpY2UoYE9udG9sb2d5IGlzc3VlOiAke2Vycm9yfWAsIDgwMDApO1xuICAgICAgfSBlbHNlIGlmIChlcnJvci5pbmNsdWRlcyhcInZhbGlkYXRpb25cIikgfHwgZXJyb3IuaW5jbHVkZXMoXCJJbnZhbGlkXCIpKSB7XG4gICAgICAgIG5ldyBOb3RpY2UoYFZhbGlkYXRpb24gZXJyb3I6ICR7ZXJyb3J9YCwgNjAwMCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBuZXcgTm90aWNlKGBFcnJvcjogJHtlcnJvcn1gLCA1MDAwKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBvbkNsb3NlKCkge1xuICAgIC8vIENsZWFyIGNvbnRlbnQgLSB0cnkgT2JzaWRpYW4gbWV0aG9kIGZpcnN0LCBmYWxsYmFjayB0byBET01cbiAgICBpZiAoXG4gICAgICBcImVtcHR5XCIgaW4gdGhpcy5jb250ZW50RWwgJiZcbiAgICAgIHR5cGVvZiAodGhpcy5jb250ZW50RWwgYXMgYW55KS5lbXB0eSA9PT0gXCJmdW5jdGlvblwiXG4gICAgKSB7XG4gICAgICAodGhpcy5jb250ZW50RWwgYXMgYW55KS5lbXB0eSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBGYWxsYmFjayB0byBzdGFuZGFyZCBET00gbWV0aG9kIC0gdXNlIGlubmVySFRNTCBmb3IgY29tcGxldGUgY2xlYW51cFxuICAgICAgLy8gVHJ5IGJvdGggbWV0aG9kcyB0byBlbnN1cmUgY29tcGF0aWJpbGl0eVxuICAgICAgdGhpcy5jb250ZW50RWwuaW5uZXJIVE1MID0gXCJcIjtcbiAgICAgIC8vIEFsc28gdHJ5IHJlbW92aW5nIGNoaWxkcmVuIG1hbnVhbGx5IGFzIGFkZGl0aW9uYWwgZmFsbGJhY2tcbiAgICAgIHdoaWxlICh0aGlzLmNvbnRlbnRFbC5maXJzdENoaWxkKSB7XG4gICAgICAgIHRoaXMuY29udGVudEVsLnJlbW92ZUNoaWxkKHRoaXMuY29udGVudEVsLmZpcnN0Q2hpbGQpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl0sInZlcnNpb24iOjN9