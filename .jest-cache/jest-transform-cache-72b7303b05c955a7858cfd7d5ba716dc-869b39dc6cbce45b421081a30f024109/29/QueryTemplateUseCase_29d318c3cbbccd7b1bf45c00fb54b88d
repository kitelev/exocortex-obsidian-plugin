bc8cd3be35f45196c1f74bc578f23ffb
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.QueryTemplateUseCase = void 0;
const tslib_1 = require("tslib");
const QueryTemplate_1 = require("../../domain/visual/QueryTemplate");
const VisualQueryNode_1 = require("../../domain/visual/VisualQueryNode");
const VisualQueryEdge_1 = require("../../domain/visual/VisualQueryEdge");
class QueryTemplateUseCase {
    constructor(templateRepository) {
        this.templateRepository = templateRepository;
    }
    getTemplateRepository() {
        return this.templateRepository;
    }
    getAllTemplates() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return yield this.templateRepository.findAll();
        });
    }
    getTemplateById(id) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return yield this.templateRepository.findById(id);
        });
    }
    searchTemplates(criteria) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return yield this.templateRepository.findByCriteria(criteria);
        });
    }
    getTemplatesByCategory(category) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return yield this.templateRepository.findByCategory(category);
        });
    }
    getBuiltInTemplates() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return yield this.templateRepository.getBuiltInTemplates();
        });
    }
    getCustomTemplates() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return yield this.templateRepository.getCustomTemplates();
        });
    }
    getRecentTemplates(limit) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return yield this.templateRepository.getRecentlyUsed(limit);
        });
    }
    saveTemplate(template) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (template.isBuiltInTemplate()) {
                throw new Error('Cannot save built-in templates');
            }
            return yield this.templateRepository.save(template);
        });
    }
    createCustomTemplate(nodes, edges, viewport, name, description, category = QueryTemplate_1.TemplateCategory.CUSTOM, tags = []) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const metadata = {
                name,
                description,
                category,
                tags: [...tags, 'custom'],
                difficulty: 'intermediate',
                createdAt: new Date(),
                updatedAt: new Date(),
                version: '1.0.0'
            };
            const template = QueryTemplate_1.QueryTemplate.fromCanvas(nodes, edges, viewport, {
                name,
                description,
                category,
                difficulty: QueryTemplate_1.TemplateDifficulty.INTERMEDIATE,
                tags
            });
            return yield this.templateRepository.create(template);
        });
    }
    cloneTemplate(templateId, newName) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const template = yield this.templateRepository.findById(templateId);
            if (!template) {
                throw new Error(`Template with ID ${templateId} not found`);
            }
            let cloned = template.clone();
            if (newName) {
                cloned = cloned.updateMetadata({
                    name: newName
                });
            }
            return yield this.templateRepository.create(cloned);
        });
    }
    deleteTemplate(id) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const template = yield this.templateRepository.findById(id);
            if (!template) {
                return false;
            }
            if (template.isBuiltInTemplate()) {
                throw new Error('Cannot delete built-in templates');
            }
            return yield this.templateRepository.delete(id);
        });
    }
    instantiateTemplate(template) {
        var _a, _b, _c, _d;
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const validation = template.validateParameters();
            if (!validation.isValid) {
                throw new Error(`Template parameters are invalid: ${validation.errors.join(', ')}`);
            }
            yield this.templateRepository.recordUsage(template.getId());
            const instantiated = template.instantiate({});
            return {
                nodes: ((_b = (_a = instantiated.layout) === null || _a === void 0 ? void 0 : _a.nodes) === null || _b === void 0 ? void 0 : _b.map(node => {
                    // Convert serialized nodes back to VisualQueryNode instances
                    return new VisualQueryNode_1.VisualQueryNode({
                        id: node.id,
                        type: node.type,
                        label: node.label,
                        position: node.position,
                        variableName: node.variableName,
                        uri: node.uri,
                        dimensions: node.dimensions
                    });
                })) || [],
                edges: ((_d = (_c = instantiated.layout) === null || _c === void 0 ? void 0 : _c.edges) === null || _d === void 0 ? void 0 : _d.map(edge => {
                    // Convert serialized edges back to VisualQueryEdge instances
                    return new VisualQueryEdge_1.VisualQueryEdge({
                        id: edge.id,
                        sourceNodeId: edge.sourceNodeId,
                        targetNodeId: edge.targetNodeId,
                        type: edge.type,
                        label: edge.label,
                        propertyUri: edge.propertyUri
                    });
                })) || []
            };
        });
    }
    exportTemplates(templateIds) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const templates = yield this.templateRepository.exportTemplates(templateIds);
            return JSON.stringify(templates, null, 2);
        });
    }
    importTemplates(jsonData) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            try {
                const templatesData = JSON.parse(jsonData);
                if (!Array.isArray(templatesData)) {
                    throw new Error('Invalid JSON format: expected array of templates');
                }
                return yield this.templateRepository.importTemplates(templatesData);
            }
            catch (error) {
                throw new Error(`Failed to import templates: ${error.message}`);
            }
        });
    }
    getUsageStatistics(templateId) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            return yield this.templateRepository.getUsageStats(templateId);
        });
    }
    updateTemplateMetadata(templateId, updates) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const template = yield this.templateRepository.findById(templateId);
            if (!template) {
                throw new Error(`Template with ID ${templateId} not found`);
            }
            if (template.isBuiltInTemplate()) {
                throw new Error('Cannot modify built-in templates');
            }
            const updatedTemplate = template.updateMetadata(updates);
            return yield this.templateRepository.update(updatedTemplate);
        });
    }
    validateTemplateParameters(template) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const validation = template.validateParameters();
            const parameters = template.getParameters();
            const parameterValues = template.getParameterValues();
            const missingParameters = [];
            const invalidParameters = [];
            parameters.forEach(param => {
                const paramId = param.id || `param_${param.name}`;
                if (param.required && !parameterValues.has(paramId)) {
                    missingParameters.push(param.name);
                }
                const value = parameterValues.get(paramId);
                if (value && param.constraints) {
                    // Additional validation could be added here
                }
            });
            return {
                isValid: validation.isValid,
                errors: validation.errors,
                missingParameters,
                invalidParameters
            };
        });
    }
    getTemplatePreview(templateId) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const template = yield this.templateRepository.findById(templateId);
            if (!template) {
                throw new Error(`Template with ID ${templateId} not found`);
            }
            const layout = template.getLayout();
            const parameters = template.getParameters();
            const nodeCount = layout.nodes.length;
            const edgeCount = layout.edges.length;
            // Determine complexity based on various factors
            let complexity = 'simple';
            const totalElements = nodeCount + edgeCount + parameters.length;
            if (totalElements <= 5) {
                complexity = 'simple';
            }
            else if (totalElements <= 10) {
                complexity = 'moderate';
            }
            else {
                complexity = 'complex';
            }
            // Generate example SPARQL if pattern is available
            let sparqlQuery = template.getMetadata().sparqlPattern || '';
            // Replace parameter placeholders with example values
            parameters.forEach(param => {
                const paramId = param.id || `param_${param.name}`;
                const placeholder = `{${paramId.toUpperCase()}}`;
                const exampleValue = param.defaultValue || `{${param.name}}`;
                sparqlQuery = sparqlQuery.replace(new RegExp(placeholder, 'g'), exampleValue);
            });
            return {
                sparqlQuery,
                nodeCount,
                edgeCount,
                parameterCount: parameters.length,
                complexity
            };
        });
    }
    refreshTemplateCache() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            yield this.templateRepository.refresh();
        });
    }
}
exports.QueryTemplateUseCase = QueryTemplateUseCase;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2FwcGxpY2F0aW9uL3VzZS1jYXNlcy9RdWVyeVRlbXBsYXRlVXNlQ2FzZS50cyIsIm1hcHBpbmdzIjoiOzs7O0FBQ0EscUVBQXdHO0FBQ3hHLHlFQUFnRjtBQUNoRix5RUFBZ0Y7QUFFaEYsTUFBYSxvQkFBb0I7SUFDN0IsWUFDcUIsa0JBQTRDO1FBQTVDLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBMEI7SUFDOUQsQ0FBQztJQUVKLHFCQUFxQjtRQUNqQixPQUFPLElBQUksQ0FBQyxrQkFBa0IsQ0FBQztJQUNuQyxDQUFDO0lBRUssZUFBZTs7WUFDakIsT0FBTyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNuRCxDQUFDO0tBQUE7SUFFSyxlQUFlLENBQUMsRUFBVTs7WUFDNUIsT0FBTyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDdEQsQ0FBQztLQUFBO0lBRUssZUFBZSxDQUFDLFFBQWdDOztZQUNsRCxPQUFPLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNsRSxDQUFDO0tBQUE7SUFFSyxzQkFBc0IsQ0FBQyxRQUEwQjs7WUFDbkQsT0FBTyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxjQUFjLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDbEUsQ0FBQztLQUFBO0lBRUssbUJBQW1COztZQUNyQixPQUFPLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDL0QsQ0FBQztLQUFBO0lBRUssa0JBQWtCOztZQUNwQixPQUFPLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLGtCQUFrQixFQUFFLENBQUM7UUFDOUQsQ0FBQztLQUFBO0lBRUssa0JBQWtCLENBQUMsS0FBYzs7WUFDbkMsT0FBTyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxlQUFlLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDaEUsQ0FBQztLQUFBO0lBRUssWUFBWSxDQUFDLFFBQXVCOztZQUN0QyxJQUFJLFFBQVEsQ0FBQyxpQkFBaUIsRUFBRSxFQUFFO2dCQUM5QixNQUFNLElBQUksS0FBSyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7YUFDckQ7WUFDRCxPQUFPLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN4RCxDQUFDO0tBQUE7SUFFSyxvQkFBb0IsQ0FDdEIsS0FBbUMsRUFDbkMsS0FBbUMsRUFDbkMsUUFBZ0QsRUFDaEQsSUFBWSxFQUNaLFdBQW1CLEVBQ25CLFdBQTZCLGdDQUFnQixDQUFDLE1BQU0sRUFDcEQsT0FBaUIsRUFBRTs7WUFFbkIsTUFBTSxRQUFRLEdBQUc7Z0JBQ2IsSUFBSTtnQkFDSixXQUFXO2dCQUNYLFFBQVE7Z0JBQ1IsSUFBSSxFQUFFLENBQUMsR0FBRyxJQUFJLEVBQUUsUUFBUSxDQUFDO2dCQUN6QixVQUFVLEVBQUUsY0FBdUI7Z0JBQ25DLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtnQkFDckIsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO2dCQUNyQixPQUFPLEVBQUUsT0FBTzthQUNuQixDQUFDO1lBRUYsTUFBTSxRQUFRLEdBQUcsNkJBQWEsQ0FBQyxVQUFVLENBQUMsS0FBSyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUU7Z0JBQzlELElBQUk7Z0JBQ0osV0FBVztnQkFDWCxRQUFRO2dCQUNSLFVBQVUsRUFBRSxrQ0FBa0IsQ0FBQyxZQUFZO2dCQUMzQyxJQUFJO2FBQ1AsQ0FBQyxDQUFDO1lBQ0gsT0FBTyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDMUQsQ0FBQztLQUFBO0lBRUssYUFBYSxDQUFDLFVBQWtCLEVBQUUsT0FBZ0I7O1lBQ3BELE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUNwRSxJQUFJLENBQUMsUUFBUSxFQUFFO2dCQUNYLE1BQU0sSUFBSSxLQUFLLENBQUMsb0JBQW9CLFVBQVUsWUFBWSxDQUFDLENBQUM7YUFDL0Q7WUFFRCxJQUFJLE1BQU0sR0FBRyxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDOUIsSUFBSSxPQUFPLEVBQUU7Z0JBQ1QsTUFBTSxHQUFHLE1BQU0sQ0FBQyxjQUFjLENBQUM7b0JBQzNCLElBQUksRUFBRSxPQUFPO2lCQUNoQixDQUFDLENBQUM7YUFDTjtZQUVELE9BQU8sTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3hELENBQUM7S0FBQTtJQUVLLGNBQWMsQ0FBQyxFQUFVOztZQUMzQixNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDNUQsSUFBSSxDQUFDLFFBQVEsRUFBRTtnQkFDWCxPQUFPLEtBQUssQ0FBQzthQUNoQjtZQUVELElBQUksUUFBUSxDQUFDLGlCQUFpQixFQUFFLEVBQUU7Z0JBQzlCLE1BQU0sSUFBSSxLQUFLLENBQUMsa0NBQWtDLENBQUMsQ0FBQzthQUN2RDtZQUVELE9BQU8sTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3BELENBQUM7S0FBQTtJQUVLLG1CQUFtQixDQUFDLFFBQXVCOzs7WUFJN0MsTUFBTSxVQUFVLEdBQUcsUUFBUSxDQUFDLGtCQUFrQixFQUFFLENBQUM7WUFDakQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUU7Z0JBQ3JCLE1BQU0sSUFBSSxLQUFLLENBQUMsb0NBQW9DLFVBQVUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQzthQUN2RjtZQUVELE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztZQUM1RCxNQUFNLFlBQVksR0FBRyxRQUFRLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQzlDLE9BQU87Z0JBQ0gsS0FBSyxFQUFFLENBQUEsTUFBQSxNQUFBLFlBQVksQ0FBQyxNQUFNLDBDQUFFLEtBQUssMENBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO29CQUMxQyw2REFBNkQ7b0JBQzdELE9BQU8sSUFBSSxpQ0FBZSxDQUFDO3dCQUN2QixFQUFFLEVBQUUsSUFBSSxDQUFDLEVBQUU7d0JBQ1gsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFnQjt3QkFDM0IsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLO3dCQUNqQixRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7d0JBQ3ZCLFlBQVksRUFBRSxJQUFJLENBQUMsWUFBWTt3QkFDL0IsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHO3dCQUNiLFVBQVUsRUFBRSxJQUFJLENBQUMsVUFBVTtxQkFDOUIsQ0FBQyxDQUFDO2dCQUNQLENBQUMsQ0FBQyxLQUFJLEVBQUU7Z0JBQ1IsS0FBSyxFQUFFLENBQUEsTUFBQSxNQUFBLFlBQVksQ0FBQyxNQUFNLDBDQUFFLEtBQUssMENBQUUsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFO29CQUMxQyw2REFBNkQ7b0JBQzdELE9BQU8sSUFBSSxpQ0FBZSxDQUFDO3dCQUN2QixFQUFFLEVBQUUsSUFBSSxDQUFDLEVBQUU7d0JBQ1gsWUFBWSxFQUFFLElBQUksQ0FBQyxZQUFZO3dCQUMvQixZQUFZLEVBQUUsSUFBSSxDQUFDLFlBQVk7d0JBQy9CLElBQUksRUFBRSxJQUFJLENBQUMsSUFBZ0I7d0JBQzNCLEtBQUssRUFBRSxJQUFJLENBQUMsS0FBSzt3QkFDakIsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXO3FCQUNoQyxDQUFDLENBQUM7Z0JBQ1AsQ0FBQyxDQUFDLEtBQUksRUFBRTthQUNYLENBQUM7O0tBQ0w7SUFFSyxlQUFlLENBQUMsV0FBc0I7O1lBQ3hDLE1BQU0sU0FBUyxHQUFHLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLGVBQWUsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUM3RSxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztRQUM5QyxDQUFDO0tBQUE7SUFFSyxlQUFlLENBQUMsUUFBZ0I7O1lBQ2xDLElBQUk7Z0JBQ0EsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFFM0MsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLEVBQUU7b0JBQy9CLE1BQU0sSUFBSSxLQUFLLENBQUMsa0RBQWtELENBQUMsQ0FBQztpQkFDdkU7Z0JBRUQsT0FBTyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxlQUFlLENBQUMsYUFBYSxDQUFDLENBQUM7YUFDdkU7WUFBQyxPQUFPLEtBQUssRUFBRTtnQkFDWixNQUFNLElBQUksS0FBSyxDQUFDLCtCQUErQixLQUFLLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQzthQUNuRTtRQUNMLENBQUM7S0FBQTtJQUVLLGtCQUFrQixDQUFDLFVBQWtCOztZQUt2QyxPQUFPLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNuRSxDQUFDO0tBQUE7SUFFSyxzQkFBc0IsQ0FDeEIsVUFBa0IsRUFDbEIsT0FNRTs7WUFFRixNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDcEUsSUFBSSxDQUFDLFFBQVEsRUFBRTtnQkFDWCxNQUFNLElBQUksS0FBSyxDQUFDLG9CQUFvQixVQUFVLFlBQVksQ0FBQyxDQUFDO2FBQy9EO1lBRUQsSUFBSSxRQUFRLENBQUMsaUJBQWlCLEVBQUUsRUFBRTtnQkFDOUIsTUFBTSxJQUFJLEtBQUssQ0FBQyxrQ0FBa0MsQ0FBQyxDQUFDO2FBQ3ZEO1lBRUQsTUFBTSxlQUFlLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUN6RCxPQUFPLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUNqRSxDQUFDO0tBQUE7SUFFSywwQkFBMEIsQ0FBQyxRQUF1Qjs7WUFNcEQsTUFBTSxVQUFVLEdBQUcsUUFBUSxDQUFDLGtCQUFrQixFQUFFLENBQUM7WUFDakQsTUFBTSxVQUFVLEdBQUcsUUFBUSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQzVDLE1BQU0sZUFBZSxHQUFHLFFBQVEsQ0FBQyxrQkFBa0IsRUFBRSxDQUFDO1lBRXRELE1BQU0saUJBQWlCLEdBQWEsRUFBRSxDQUFDO1lBQ3ZDLE1BQU0saUJBQWlCLEdBQWEsRUFBRSxDQUFDO1lBRXZDLFVBQVUsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUU7Z0JBQ3ZCLE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxFQUFFLElBQUksU0FBUyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ2xELElBQUksS0FBSyxDQUFDLFFBQVEsSUFBSSxDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLEVBQUU7b0JBQ2pELGlCQUFpQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7aUJBQ3RDO2dCQUVELE1BQU0sS0FBSyxHQUFHLGVBQWUsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQzNDLElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxXQUFXLEVBQUU7b0JBQzVCLDRDQUE0QztpQkFDL0M7WUFDTCxDQUFDLENBQUMsQ0FBQztZQUVILE9BQU87Z0JBQ0gsT0FBTyxFQUFFLFVBQVUsQ0FBQyxPQUFPO2dCQUMzQixNQUFNLEVBQUUsVUFBVSxDQUFDLE1BQU07Z0JBQ3pCLGlCQUFpQjtnQkFDakIsaUJBQWlCO2FBQ3BCLENBQUM7UUFDTixDQUFDO0tBQUE7SUFFSyxrQkFBa0IsQ0FBQyxVQUFrQjs7WUFPdkMsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxDQUFDO1lBQ3BFLElBQUksQ0FBQyxRQUFRLEVBQUU7Z0JBQ1gsTUFBTSxJQUFJLEtBQUssQ0FBQyxvQkFBb0IsVUFBVSxZQUFZLENBQUMsQ0FBQzthQUMvRDtZQUVELE1BQU0sTUFBTSxHQUFHLFFBQVEsQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUNwQyxNQUFNLFVBQVUsR0FBRyxRQUFRLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDNUMsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUM7WUFDdEMsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUM7WUFFdEMsZ0RBQWdEO1lBQ2hELElBQUksVUFBVSxHQUFzQyxRQUFRLENBQUM7WUFDN0QsTUFBTSxhQUFhLEdBQUcsU0FBUyxHQUFHLFNBQVMsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDO1lBRWhFLElBQUksYUFBYSxJQUFJLENBQUMsRUFBRTtnQkFDcEIsVUFBVSxHQUFHLFFBQVEsQ0FBQzthQUN6QjtpQkFBTSxJQUFJLGFBQWEsSUFBSSxFQUFFLEVBQUU7Z0JBQzVCLFVBQVUsR0FBRyxVQUFVLENBQUM7YUFDM0I7aUJBQU07Z0JBQ0gsVUFBVSxHQUFHLFNBQVMsQ0FBQzthQUMxQjtZQUVELGtEQUFrRDtZQUNsRCxJQUFJLFdBQVcsR0FBRyxRQUFRLENBQUMsV0FBVyxFQUFFLENBQUMsYUFBYSxJQUFJLEVBQUUsQ0FBQztZQUU3RCxxREFBcUQ7WUFDckQsVUFBVSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsRUFBRTtnQkFDdkIsTUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFDLEVBQUUsSUFBSSxTQUFTLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztnQkFDbEQsTUFBTSxXQUFXLEdBQUcsSUFBSSxPQUFPLENBQUMsV0FBVyxFQUFFLEdBQUcsQ0FBQztnQkFDakQsTUFBTSxZQUFZLEdBQUcsS0FBSyxDQUFDLFlBQVksSUFBSSxJQUFJLEtBQUssQ0FBQyxJQUFJLEdBQUcsQ0FBQztnQkFDN0QsV0FBVyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQUMsSUFBSSxNQUFNLENBQUMsV0FBVyxFQUFFLEdBQUcsQ0FBQyxFQUFFLFlBQVksQ0FBQyxDQUFDO1lBQ2xGLENBQUMsQ0FBQyxDQUFDO1lBRUgsT0FBTztnQkFDSCxXQUFXO2dCQUNYLFNBQVM7Z0JBQ1QsU0FBUztnQkFDVCxjQUFjLEVBQUUsVUFBVSxDQUFDLE1BQU07Z0JBQ2pDLFVBQVU7YUFDYixDQUFDO1FBQ04sQ0FBQztLQUFBO0lBRUssb0JBQW9COztZQUN0QixNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUM1QyxDQUFDO0tBQUE7Q0FDSjtBQXBSRCxvREFvUkMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2FwcGxpY2F0aW9uL3VzZS1jYXNlcy9RdWVyeVRlbXBsYXRlVXNlQ2FzZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJUXVlcnlUZW1wbGF0ZVJlcG9zaXRvcnksIFRlbXBsYXRlU2VhcmNoQ3JpdGVyaWEgfSBmcm9tICcuLi8uLi9kb21haW4vcmVwb3NpdG9yaWVzL0lRdWVyeVRlbXBsYXRlUmVwb3NpdG9yeSc7XG5pbXBvcnQgeyBRdWVyeVRlbXBsYXRlLCBUZW1wbGF0ZUNhdGVnb3J5LCBUZW1wbGF0ZURpZmZpY3VsdHkgfSBmcm9tICcuLi8uLi9kb21haW4vdmlzdWFsL1F1ZXJ5VGVtcGxhdGUnO1xuaW1wb3J0IHsgVmlzdWFsUXVlcnlOb2RlLCBOb2RlVHlwZSB9IGZyb20gJy4uLy4uL2RvbWFpbi92aXN1YWwvVmlzdWFsUXVlcnlOb2RlJztcbmltcG9ydCB7IFZpc3VhbFF1ZXJ5RWRnZSwgRWRnZVR5cGUgfSBmcm9tICcuLi8uLi9kb21haW4vdmlzdWFsL1Zpc3VhbFF1ZXJ5RWRnZSc7XG5cbmV4cG9ydCBjbGFzcyBRdWVyeVRlbXBsYXRlVXNlQ2FzZSB7XG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgcmVhZG9ubHkgdGVtcGxhdGVSZXBvc2l0b3J5OiBJUXVlcnlUZW1wbGF0ZVJlcG9zaXRvcnlcbiAgICApIHt9XG5cbiAgICBnZXRUZW1wbGF0ZVJlcG9zaXRvcnkoKTogSVF1ZXJ5VGVtcGxhdGVSZXBvc2l0b3J5IHtcbiAgICAgICAgcmV0dXJuIHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5O1xuICAgIH1cblxuICAgIGFzeW5jIGdldEFsbFRlbXBsYXRlcygpOiBQcm9taXNlPFF1ZXJ5VGVtcGxhdGVbXT4ge1xuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy50ZW1wbGF0ZVJlcG9zaXRvcnkuZmluZEFsbCgpO1xuICAgIH1cblxuICAgIGFzeW5jIGdldFRlbXBsYXRlQnlJZChpZDogc3RyaW5nKTogUHJvbWlzZTxRdWVyeVRlbXBsYXRlIHwgdW5kZWZpbmVkPiB7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRlbXBsYXRlUmVwb3NpdG9yeS5maW5kQnlJZChpZCk7XG4gICAgfVxuXG4gICAgYXN5bmMgc2VhcmNoVGVtcGxhdGVzKGNyaXRlcmlhOiBUZW1wbGF0ZVNlYXJjaENyaXRlcmlhKTogUHJvbWlzZTxRdWVyeVRlbXBsYXRlW10+IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LmZpbmRCeUNyaXRlcmlhKGNyaXRlcmlhKTtcbiAgICB9XG5cbiAgICBhc3luYyBnZXRUZW1wbGF0ZXNCeUNhdGVnb3J5KGNhdGVnb3J5OiBUZW1wbGF0ZUNhdGVnb3J5KTogUHJvbWlzZTxRdWVyeVRlbXBsYXRlW10+IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LmZpbmRCeUNhdGVnb3J5KGNhdGVnb3J5KTtcbiAgICB9XG5cbiAgICBhc3luYyBnZXRCdWlsdEluVGVtcGxhdGVzKCk6IFByb21pc2U8UXVlcnlUZW1wbGF0ZVtdPiB7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRlbXBsYXRlUmVwb3NpdG9yeS5nZXRCdWlsdEluVGVtcGxhdGVzKCk7XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0Q3VzdG9tVGVtcGxhdGVzKCk6IFByb21pc2U8UXVlcnlUZW1wbGF0ZVtdPiB7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRlbXBsYXRlUmVwb3NpdG9yeS5nZXRDdXN0b21UZW1wbGF0ZXMoKTtcbiAgICB9XG5cbiAgICBhc3luYyBnZXRSZWNlbnRUZW1wbGF0ZXMobGltaXQ/OiBudW1iZXIpOiBQcm9taXNlPFF1ZXJ5VGVtcGxhdGVbXT4ge1xuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy50ZW1wbGF0ZVJlcG9zaXRvcnkuZ2V0UmVjZW50bHlVc2VkKGxpbWl0KTtcbiAgICB9XG5cbiAgICBhc3luYyBzYXZlVGVtcGxhdGUodGVtcGxhdGU6IFF1ZXJ5VGVtcGxhdGUpOiBQcm9taXNlPFF1ZXJ5VGVtcGxhdGU+IHtcbiAgICAgICAgaWYgKHRlbXBsYXRlLmlzQnVpbHRJblRlbXBsYXRlKCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHNhdmUgYnVpbHQtaW4gdGVtcGxhdGVzJyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LnNhdmUodGVtcGxhdGUpO1xuICAgIH1cblxuICAgIGFzeW5jIGNyZWF0ZUN1c3RvbVRlbXBsYXRlKFxuICAgICAgICBub2RlczogTWFwPHN0cmluZywgVmlzdWFsUXVlcnlOb2RlPixcbiAgICAgICAgZWRnZXM6IE1hcDxzdHJpbmcsIFZpc3VhbFF1ZXJ5RWRnZT4sXG4gICAgICAgIHZpZXdwb3J0OiB7IHg6IG51bWJlcjsgeTogbnVtYmVyOyB6b29tOiBudW1iZXIgfSxcbiAgICAgICAgbmFtZTogc3RyaW5nLFxuICAgICAgICBkZXNjcmlwdGlvbjogc3RyaW5nLFxuICAgICAgICBjYXRlZ29yeTogVGVtcGxhdGVDYXRlZ29yeSA9IFRlbXBsYXRlQ2F0ZWdvcnkuQ1VTVE9NLFxuICAgICAgICB0YWdzOiBzdHJpbmdbXSA9IFtdXG4gICAgKTogUHJvbWlzZTxRdWVyeVRlbXBsYXRlPiB7XG4gICAgICAgIGNvbnN0IG1ldGFkYXRhID0ge1xuICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgY2F0ZWdvcnksXG4gICAgICAgICAgICB0YWdzOiBbLi4udGFncywgJ2N1c3RvbSddLFxuICAgICAgICAgICAgZGlmZmljdWx0eTogJ2ludGVybWVkaWF0ZScgYXMgY29uc3QsXG4gICAgICAgICAgICBjcmVhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgICB1cGRhdGVkQXQ6IG5ldyBEYXRlKCksXG4gICAgICAgICAgICB2ZXJzaW9uOiAnMS4wLjAnXG4gICAgICAgIH07XG5cbiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBRdWVyeVRlbXBsYXRlLmZyb21DYW52YXMobm9kZXMsIGVkZ2VzLCB2aWV3cG9ydCwge1xuICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgICAgICAgY2F0ZWdvcnksXG4gICAgICAgICAgICBkaWZmaWN1bHR5OiBUZW1wbGF0ZURpZmZpY3VsdHkuSU5URVJNRURJQVRFLFxuICAgICAgICAgICAgdGFnc1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LmNyZWF0ZSh0ZW1wbGF0ZSk7XG4gICAgfVxuXG4gICAgYXN5bmMgY2xvbmVUZW1wbGF0ZSh0ZW1wbGF0ZUlkOiBzdHJpbmcsIG5ld05hbWU/OiBzdHJpbmcpOiBQcm9taXNlPFF1ZXJ5VGVtcGxhdGU+IHtcbiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBhd2FpdCB0aGlzLnRlbXBsYXRlUmVwb3NpdG9yeS5maW5kQnlJZCh0ZW1wbGF0ZUlkKTtcbiAgICAgICAgaWYgKCF0ZW1wbGF0ZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUZW1wbGF0ZSB3aXRoIElEICR7dGVtcGxhdGVJZH0gbm90IGZvdW5kYCk7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgY2xvbmVkID0gdGVtcGxhdGUuY2xvbmUoKTtcbiAgICAgICAgaWYgKG5ld05hbWUpIHtcbiAgICAgICAgICAgIGNsb25lZCA9IGNsb25lZC51cGRhdGVNZXRhZGF0YSh7XG4gICAgICAgICAgICAgICAgbmFtZTogbmV3TmFtZVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy50ZW1wbGF0ZVJlcG9zaXRvcnkuY3JlYXRlKGNsb25lZCk7XG4gICAgfVxuXG4gICAgYXN5bmMgZGVsZXRlVGVtcGxhdGUoaWQ6IHN0cmluZyk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LmZpbmRCeUlkKGlkKTtcbiAgICAgICAgaWYgKCF0ZW1wbGF0ZSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRlbXBsYXRlLmlzQnVpbHRJblRlbXBsYXRlKCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGRlbGV0ZSBidWlsdC1pbiB0ZW1wbGF0ZXMnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRlbXBsYXRlUmVwb3NpdG9yeS5kZWxldGUoaWQpO1xuICAgIH1cblxuICAgIGFzeW5jIGluc3RhbnRpYXRlVGVtcGxhdGUodGVtcGxhdGU6IFF1ZXJ5VGVtcGxhdGUpOiBQcm9taXNlPHtcbiAgICAgICAgbm9kZXM6IFZpc3VhbFF1ZXJ5Tm9kZVtdO1xuICAgICAgICBlZGdlczogVmlzdWFsUXVlcnlFZGdlW107XG4gICAgfT4ge1xuICAgICAgICBjb25zdCB2YWxpZGF0aW9uID0gdGVtcGxhdGUudmFsaWRhdGVQYXJhbWV0ZXJzKCk7XG4gICAgICAgIGlmICghdmFsaWRhdGlvbi5pc1ZhbGlkKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRlbXBsYXRlIHBhcmFtZXRlcnMgYXJlIGludmFsaWQ6ICR7dmFsaWRhdGlvbi5lcnJvcnMuam9pbignLCAnKX1gKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LnJlY29yZFVzYWdlKHRlbXBsYXRlLmdldElkKCkpO1xuICAgICAgICBjb25zdCBpbnN0YW50aWF0ZWQgPSB0ZW1wbGF0ZS5pbnN0YW50aWF0ZSh7fSk7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBub2RlczogaW5zdGFudGlhdGVkLmxheW91dD8ubm9kZXM/Lm1hcChub2RlID0+IHtcbiAgICAgICAgICAgICAgICAvLyBDb252ZXJ0IHNlcmlhbGl6ZWQgbm9kZXMgYmFjayB0byBWaXN1YWxRdWVyeU5vZGUgaW5zdGFuY2VzXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBWaXN1YWxRdWVyeU5vZGUoe1xuICAgICAgICAgICAgICAgICAgICBpZDogbm9kZS5pZCxcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogbm9kZS50eXBlIGFzIE5vZGVUeXBlLFxuICAgICAgICAgICAgICAgICAgICBsYWJlbDogbm9kZS5sYWJlbCxcbiAgICAgICAgICAgICAgICAgICAgcG9zaXRpb246IG5vZGUucG9zaXRpb24sXG4gICAgICAgICAgICAgICAgICAgIHZhcmlhYmxlTmFtZTogbm9kZS52YXJpYWJsZU5hbWUsXG4gICAgICAgICAgICAgICAgICAgIHVyaTogbm9kZS51cmksXG4gICAgICAgICAgICAgICAgICAgIGRpbWVuc2lvbnM6IG5vZGUuZGltZW5zaW9uc1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSkgfHwgW10sXG4gICAgICAgICAgICBlZGdlczogaW5zdGFudGlhdGVkLmxheW91dD8uZWRnZXM/Lm1hcChlZGdlID0+IHtcbiAgICAgICAgICAgICAgICAvLyBDb252ZXJ0IHNlcmlhbGl6ZWQgZWRnZXMgYmFjayB0byBWaXN1YWxRdWVyeUVkZ2UgaW5zdGFuY2VzXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBWaXN1YWxRdWVyeUVkZ2Uoe1xuICAgICAgICAgICAgICAgICAgICBpZDogZWRnZS5pZCxcbiAgICAgICAgICAgICAgICAgICAgc291cmNlTm9kZUlkOiBlZGdlLnNvdXJjZU5vZGVJZCxcbiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0Tm9kZUlkOiBlZGdlLnRhcmdldE5vZGVJZCxcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogZWRnZS50eXBlIGFzIEVkZ2VUeXBlLFxuICAgICAgICAgICAgICAgICAgICBsYWJlbDogZWRnZS5sYWJlbCxcbiAgICAgICAgICAgICAgICAgICAgcHJvcGVydHlVcmk6IGVkZ2UucHJvcGVydHlVcmlcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pIHx8IFtdXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgYXN5bmMgZXhwb3J0VGVtcGxhdGVzKHRlbXBsYXRlSWRzPzogc3RyaW5nW10pOiBQcm9taXNlPHN0cmluZz4ge1xuICAgICAgICBjb25zdCB0ZW1wbGF0ZXMgPSBhd2FpdCB0aGlzLnRlbXBsYXRlUmVwb3NpdG9yeS5leHBvcnRUZW1wbGF0ZXModGVtcGxhdGVJZHMpO1xuICAgICAgICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodGVtcGxhdGVzLCBudWxsLCAyKTtcbiAgICB9XG5cbiAgICBhc3luYyBpbXBvcnRUZW1wbGF0ZXMoanNvbkRhdGE6IHN0cmluZyk6IFByb21pc2U8UXVlcnlUZW1wbGF0ZVtdPiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCB0ZW1wbGF0ZXNEYXRhID0gSlNPTi5wYXJzZShqc29uRGF0YSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheSh0ZW1wbGF0ZXNEYXRhKSkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBKU09OIGZvcm1hdDogZXhwZWN0ZWQgYXJyYXkgb2YgdGVtcGxhdGVzJyk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRlbXBsYXRlUmVwb3NpdG9yeS5pbXBvcnRUZW1wbGF0ZXModGVtcGxhdGVzRGF0YSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBpbXBvcnQgdGVtcGxhdGVzOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBnZXRVc2FnZVN0YXRpc3RpY3ModGVtcGxhdGVJZDogc3RyaW5nKTogUHJvbWlzZTx7XG4gICAgICAgIHVzYWdlQ291bnQ6IG51bWJlcjtcbiAgICAgICAgbGFzdFVzZWQ/OiBEYXRlO1xuICAgICAgICBhdmVyYWdlUGFyYW1ldGVyc0ZpbGxlZD86IG51bWJlcjtcbiAgICB9PiB7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRlbXBsYXRlUmVwb3NpdG9yeS5nZXRVc2FnZVN0YXRzKHRlbXBsYXRlSWQpO1xuICAgIH1cblxuICAgIGFzeW5jIHVwZGF0ZVRlbXBsYXRlTWV0YWRhdGEoXG4gICAgICAgIHRlbXBsYXRlSWQ6IHN0cmluZyxcbiAgICAgICAgdXBkYXRlczogUGFydGlhbDx7XG4gICAgICAgICAgICBuYW1lOiBzdHJpbmc7XG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogc3RyaW5nO1xuICAgICAgICAgICAgY2F0ZWdvcnk6IFRlbXBsYXRlQ2F0ZWdvcnk7XG4gICAgICAgICAgICB0YWdzOiBzdHJpbmdbXTtcbiAgICAgICAgICAgIGRpZmZpY3VsdHk6IFRlbXBsYXRlRGlmZmljdWx0eTtcbiAgICAgICAgfT5cbiAgICApOiBQcm9taXNlPFF1ZXJ5VGVtcGxhdGU+IHtcbiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBhd2FpdCB0aGlzLnRlbXBsYXRlUmVwb3NpdG9yeS5maW5kQnlJZCh0ZW1wbGF0ZUlkKTtcbiAgICAgICAgaWYgKCF0ZW1wbGF0ZSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUZW1wbGF0ZSB3aXRoIElEICR7dGVtcGxhdGVJZH0gbm90IGZvdW5kYCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGVtcGxhdGUuaXNCdWlsdEluVGVtcGxhdGUoKSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgbW9kaWZ5IGJ1aWx0LWluIHRlbXBsYXRlcycpO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgdXBkYXRlZFRlbXBsYXRlID0gdGVtcGxhdGUudXBkYXRlTWV0YWRhdGEodXBkYXRlcyk7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLnRlbXBsYXRlUmVwb3NpdG9yeS51cGRhdGUodXBkYXRlZFRlbXBsYXRlKTtcbiAgICB9XG5cbiAgICBhc3luYyB2YWxpZGF0ZVRlbXBsYXRlUGFyYW1ldGVycyh0ZW1wbGF0ZTogUXVlcnlUZW1wbGF0ZSk6IFByb21pc2U8e1xuICAgICAgICBpc1ZhbGlkOiBib29sZWFuO1xuICAgICAgICBlcnJvcnM6IHN0cmluZ1tdO1xuICAgICAgICBtaXNzaW5nUGFyYW1ldGVyczogc3RyaW5nW107XG4gICAgICAgIGludmFsaWRQYXJhbWV0ZXJzOiBzdHJpbmdbXTtcbiAgICB9PiB7XG4gICAgICAgIGNvbnN0IHZhbGlkYXRpb24gPSB0ZW1wbGF0ZS52YWxpZGF0ZVBhcmFtZXRlcnMoKTtcbiAgICAgICAgY29uc3QgcGFyYW1ldGVycyA9IHRlbXBsYXRlLmdldFBhcmFtZXRlcnMoKTtcbiAgICAgICAgY29uc3QgcGFyYW1ldGVyVmFsdWVzID0gdGVtcGxhdGUuZ2V0UGFyYW1ldGVyVmFsdWVzKCk7XG5cbiAgICAgICAgY29uc3QgbWlzc2luZ1BhcmFtZXRlcnM6IHN0cmluZ1tdID0gW107XG4gICAgICAgIGNvbnN0IGludmFsaWRQYXJhbWV0ZXJzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgICAgIHBhcmFtZXRlcnMuZm9yRWFjaChwYXJhbSA9PiB7XG4gICAgICAgICAgICBjb25zdCBwYXJhbUlkID0gcGFyYW0uaWQgfHwgYHBhcmFtXyR7cGFyYW0ubmFtZX1gO1xuICAgICAgICAgICAgaWYgKHBhcmFtLnJlcXVpcmVkICYmICFwYXJhbWV0ZXJWYWx1ZXMuaGFzKHBhcmFtSWQpKSB7XG4gICAgICAgICAgICAgICAgbWlzc2luZ1BhcmFtZXRlcnMucHVzaChwYXJhbS5uYW1lKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBwYXJhbWV0ZXJWYWx1ZXMuZ2V0KHBhcmFtSWQpO1xuICAgICAgICAgICAgaWYgKHZhbHVlICYmIHBhcmFtLmNvbnN0cmFpbnRzKSB7XG4gICAgICAgICAgICAgICAgLy8gQWRkaXRpb25hbCB2YWxpZGF0aW9uIGNvdWxkIGJlIGFkZGVkIGhlcmVcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIGlzVmFsaWQ6IHZhbGlkYXRpb24uaXNWYWxpZCxcbiAgICAgICAgICAgIGVycm9yczogdmFsaWRhdGlvbi5lcnJvcnMsXG4gICAgICAgICAgICBtaXNzaW5nUGFyYW1ldGVycyxcbiAgICAgICAgICAgIGludmFsaWRQYXJhbWV0ZXJzXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0VGVtcGxhdGVQcmV2aWV3KHRlbXBsYXRlSWQ6IHN0cmluZyk6IFByb21pc2U8e1xuICAgICAgICBzcGFycWxRdWVyeTogc3RyaW5nO1xuICAgICAgICBub2RlQ291bnQ6IG51bWJlcjtcbiAgICAgICAgZWRnZUNvdW50OiBudW1iZXI7XG4gICAgICAgIHBhcmFtZXRlckNvdW50OiBudW1iZXI7XG4gICAgICAgIGNvbXBsZXhpdHk6ICdzaW1wbGUnIHwgJ21vZGVyYXRlJyB8ICdjb21wbGV4JztcbiAgICB9PiB7XG4gICAgICAgIGNvbnN0IHRlbXBsYXRlID0gYXdhaXQgdGhpcy50ZW1wbGF0ZVJlcG9zaXRvcnkuZmluZEJ5SWQodGVtcGxhdGVJZCk7XG4gICAgICAgIGlmICghdGVtcGxhdGUpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVGVtcGxhdGUgd2l0aCBJRCAke3RlbXBsYXRlSWR9IG5vdCBmb3VuZGApO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgbGF5b3V0ID0gdGVtcGxhdGUuZ2V0TGF5b3V0KCk7XG4gICAgICAgIGNvbnN0IHBhcmFtZXRlcnMgPSB0ZW1wbGF0ZS5nZXRQYXJhbWV0ZXJzKCk7XG4gICAgICAgIGNvbnN0IG5vZGVDb3VudCA9IGxheW91dC5ub2Rlcy5sZW5ndGg7XG4gICAgICAgIGNvbnN0IGVkZ2VDb3VudCA9IGxheW91dC5lZGdlcy5sZW5ndGg7XG5cbiAgICAgICAgLy8gRGV0ZXJtaW5lIGNvbXBsZXhpdHkgYmFzZWQgb24gdmFyaW91cyBmYWN0b3JzXG4gICAgICAgIGxldCBjb21wbGV4aXR5OiAnc2ltcGxlJyB8ICdtb2RlcmF0ZScgfCAnY29tcGxleCcgPSAnc2ltcGxlJztcbiAgICAgICAgY29uc3QgdG90YWxFbGVtZW50cyA9IG5vZGVDb3VudCArIGVkZ2VDb3VudCArIHBhcmFtZXRlcnMubGVuZ3RoO1xuXG4gICAgICAgIGlmICh0b3RhbEVsZW1lbnRzIDw9IDUpIHtcbiAgICAgICAgICAgIGNvbXBsZXhpdHkgPSAnc2ltcGxlJztcbiAgICAgICAgfSBlbHNlIGlmICh0b3RhbEVsZW1lbnRzIDw9IDEwKSB7XG4gICAgICAgICAgICBjb21wbGV4aXR5ID0gJ21vZGVyYXRlJztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGNvbXBsZXhpdHkgPSAnY29tcGxleCc7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBHZW5lcmF0ZSBleGFtcGxlIFNQQVJRTCBpZiBwYXR0ZXJuIGlzIGF2YWlsYWJsZVxuICAgICAgICBsZXQgc3BhcnFsUXVlcnkgPSB0ZW1wbGF0ZS5nZXRNZXRhZGF0YSgpLnNwYXJxbFBhdHRlcm4gfHwgJyc7XG4gICAgICAgIFxuICAgICAgICAvLyBSZXBsYWNlIHBhcmFtZXRlciBwbGFjZWhvbGRlcnMgd2l0aCBleGFtcGxlIHZhbHVlc1xuICAgICAgICBwYXJhbWV0ZXJzLmZvckVhY2gocGFyYW0gPT4ge1xuICAgICAgICAgICAgY29uc3QgcGFyYW1JZCA9IHBhcmFtLmlkIHx8IGBwYXJhbV8ke3BhcmFtLm5hbWV9YDtcbiAgICAgICAgICAgIGNvbnN0IHBsYWNlaG9sZGVyID0gYHske3BhcmFtSWQudG9VcHBlckNhc2UoKX19YDtcbiAgICAgICAgICAgIGNvbnN0IGV4YW1wbGVWYWx1ZSA9IHBhcmFtLmRlZmF1bHRWYWx1ZSB8fCBgeyR7cGFyYW0ubmFtZX19YDtcbiAgICAgICAgICAgIHNwYXJxbFF1ZXJ5ID0gc3BhcnFsUXVlcnkucmVwbGFjZShuZXcgUmVnRXhwKHBsYWNlaG9sZGVyLCAnZycpLCBleGFtcGxlVmFsdWUpO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc3BhcnFsUXVlcnksXG4gICAgICAgICAgICBub2RlQ291bnQsXG4gICAgICAgICAgICBlZGdlQ291bnQsXG4gICAgICAgICAgICBwYXJhbWV0ZXJDb3VudDogcGFyYW1ldGVycy5sZW5ndGgsXG4gICAgICAgICAgICBjb21wbGV4aXR5XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgYXN5bmMgcmVmcmVzaFRlbXBsYXRlQ2FjaGUoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgICAgIGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LnJlZnJlc2goKTtcbiAgICB9XG59Il0sInZlcnNpb24iOjN9