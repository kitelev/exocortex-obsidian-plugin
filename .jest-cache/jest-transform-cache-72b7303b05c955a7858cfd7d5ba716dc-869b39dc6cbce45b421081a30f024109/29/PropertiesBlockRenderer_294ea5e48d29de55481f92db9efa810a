3657fbf8f1a615492d88a92b7437d7cc
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PropertiesBlockRenderer = void 0;
const tslib_1 = require("tslib");
class PropertiesBlockRenderer {
    constructor(app, propertyRenderer) {
        this.app = app;
        this.propertyRenderer = propertyRenderer;
    }
    render(container, config, file, frontmatter, dv) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const propsConfig = config;
            // Determine which properties to show
            let propertiesToShow = Object.keys(frontmatter);
            // Apply included properties filter
            if (propsConfig.includedProperties && propsConfig.includedProperties.length > 0) {
                propertiesToShow = propertiesToShow.filter(prop => propsConfig.includedProperties.includes(prop));
            }
            // Apply excluded properties filter
            if (propsConfig.excludedProperties && propsConfig.excludedProperties.length > 0) {
                propertiesToShow = propertiesToShow.filter(prop => !propsConfig.excludedProperties.includes(prop));
            }
            // Get asset ID and class
            const assetId = frontmatter['exo__Asset_uid'] || file.path;
            const instanceClass = frontmatter['exo__Instance_class'];
            const cleanClassName = this.cleanClassName(instanceClass);
            // Check if properties are editable
            const editableProps = propsConfig.editableProperties || [];
            // Group properties if groupBy is specified
            if (propsConfig.groupBy) {
                this.renderGroupedProperties(container, propertiesToShow, frontmatter, propsConfig.groupBy, assetId, cleanClassName, editableProps);
            }
            else {
                this.renderFlatProperties(container, propertiesToShow, frontmatter, assetId, cleanClassName, editableProps);
            }
        });
    }
    renderPropertiesBlock(properties, container) {
        if (!container) {
            return;
        }
        if (!properties || properties.length === 0) {
            return;
        }
        properties.forEach(prop => {
            if (!prop || typeof prop !== 'object') {
                return;
            }
            const propertyDiv = document.createElement('div');
            propertyDiv.className = 'property-item';
            container.appendChild(propertyDiv);
            // Property name
            if (prop.name) {
                const nameEl = document.createElement('span');
                nameEl.className = 'property-name';
                nameEl.textContent = this.formatPropertyName(prop.name);
                propertyDiv.appendChild(nameEl);
                // Add separator
                const separator = document.createElement('span');
                separator.textContent = ': ';
                propertyDiv.appendChild(separator);
            }
            // Property value
            const valueEl = document.createElement('span');
            valueEl.className = 'property-value';
            propertyDiv.appendChild(valueEl);
            if (prop.editable) {
                // Create input for editable properties
                if (prop.type === 'boolean') {
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = !!prop.value;
                    valueEl.appendChild(checkbox);
                }
                else if (prop.type === 'number') {
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.value = String(prop.value || '');
                    valueEl.appendChild(input);
                }
                else {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = String(prop.value || '');
                    valueEl.appendChild(input);
                }
            }
            else {
                // Render readonly value
                if (prop.type === 'tags' && Array.isArray(prop.value)) {
                    prop.value.forEach((tag) => {
                        const tagEl = document.createElement('span');
                        tagEl.className = 'tag';
                        tagEl.textContent = tag;
                        valueEl.appendChild(tagEl);
                    });
                }
                else {
                    const formattedValue = this.formatValue(prop.value);
                    valueEl.textContent = formattedValue;
                }
            }
        });
    }
    renderFlatProperties(container, properties, frontmatter, assetId, className, editableProps) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            // Use PropertyRenderer for all properties (it will handle editability internally)
            const editableContainer = container.createDiv({ cls: 'exocortex-properties-editable' });
            yield this.propertyRenderer.renderPropertiesBlock(editableContainer, assetId, className, frontmatter);
            // Render non-editable properties
            const readOnlyProps = properties.filter(p => !editableProps.includes(p));
            if (readOnlyProps.length > 0) {
                const readOnlyContainer = container.createDiv({ cls: 'exocortex-properties-readonly' });
                const table = readOnlyContainer.createEl('table', { cls: 'exocortex-properties-table' });
                readOnlyProps.forEach(prop => {
                    const row = table.createEl('tr');
                    // Property name
                    const nameCell = row.createEl('td', { cls: 'property-name' });
                    nameCell.setText(this.formatPropertyName(prop));
                    // Property value
                    const valueCell = row.createEl('td', { cls: 'property-value' });
                    const value = frontmatter[prop];
                    valueCell.setText(this.formatValue(value));
                });
            }
        });
    }
    renderGroupedProperties(container, properties, frontmatter, groupBy, assetId, className, editableProps) {
        // Group properties by prefix or custom logic
        const groups = new Map();
        properties.forEach(prop => {
            const group = this.getPropertyGroup(prop, groupBy);
            if (!groups.has(group)) {
                groups.set(group, []);
            }
            groups.get(group).push(prop);
        });
        // Render each group
        groups.forEach((props, groupName) => {
            const groupContainer = container.createDiv({ cls: 'exocortex-property-group' });
            if (groupName !== 'Other') {
                groupContainer.createEl('h4', {
                    text: groupName,
                    cls: 'property-group-header'
                });
            }
            const groupContent = groupContainer.createDiv({ cls: 'property-group-content' });
            // Separate editable and readonly
            const groupEditable = props.filter(p => editableProps.includes(p));
            const groupReadOnly = props.filter(p => !editableProps.includes(p));
            // Render editable properties
            if (groupEditable.length > 0) {
                this.propertyRenderer.renderPropertiesBlock(groupContent, assetId, className, frontmatter);
            }
            // Render readonly properties
            if (groupReadOnly.length > 0) {
                const table = groupContent.createEl('table', { cls: 'exocortex-properties-table' });
                groupReadOnly.forEach(prop => {
                    const row = table.createEl('tr');
                    const nameCell = row.createEl('td', { cls: 'property-name' });
                    nameCell.setText(this.formatPropertyName(prop));
                    const valueCell = row.createEl('td', { cls: 'property-value' });
                    const value = frontmatter[prop];
                    valueCell.setText(this.formatValue(value));
                });
            }
        });
    }
    getPropertyGroup(property, groupBy) {
        if (groupBy === 'prefix') {
            const match = property.match(/^([^_]+)__/);
            if (match) {
                return match[1].toUpperCase();
            }
        }
        if (groupBy === 'category') {
            if (property.includes('status') || property.includes('Status'))
                return 'Status';
            if (property.includes('date') || property.includes('Date'))
                return 'Dates';
            if (property.includes('relate') || property.includes('link'))
                return 'Relations';
        }
        return 'Other';
    }
    formatPropertyName(prop) {
        // For test compatibility, keep original prop name if it doesn't have prefix
        if (!prop.includes('__')) {
            return prop;
        }
        // Remove prefix and format
        return prop
            .replace(/^[^_]+__/, '')
            .replace(/_/g, ' ')
            .replace(/\b\w/g, l => l.toUpperCase());
    }
    formatValue(value) {
        if (value === null || value === undefined)
            return '';
        if (Array.isArray(value)) {
            return value.map(v => this.cleanValue(v)).join(', ');
        }
        if (typeof value === 'boolean') {
            return value ? '✓' : '✗';
        }
        if (value instanceof Date) {
            return value.toLocaleDateString();
        }
        if (typeof value === 'object') {
            return JSON.stringify(value);
        }
        return this.cleanValue(value);
    }
    cleanValue(value) {
        if (!value)
            return '';
        const str = value.toString();
        return str.replace(/\[\[|\]\]/g, '');
    }
    cleanClassName(className) {
        if (!className)
            return '';
        const str = Array.isArray(className) ? className[0] : className;
        return (str === null || str === void 0 ? void 0 : str.toString().replace(/\[\[|\]\]/g, '')) || '';
    }
}
exports.PropertiesBlockRenderer = PropertiesBlockRenderer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL3ByZXNlbnRhdGlvbi9yZW5kZXJlcnMvUHJvcGVydGllc0Jsb2NrUmVuZGVyZXIudHMiLCJtYXBwaW5ncyI6Ijs7OztBQUlBLE1BQWEsdUJBQXVCO0lBQ2hDLFlBQ1ksR0FBUSxFQUNSLGdCQUFrQztRQURsQyxRQUFHLEdBQUgsR0FBRyxDQUFLO1FBQ1IscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtJQUMzQyxDQUFDO0lBRUUsTUFBTSxDQUNSLFNBQXNCLEVBQ3RCLE1BQVcsRUFDWCxJQUFXLEVBQ1gsV0FBZ0IsRUFDaEIsRUFBTzs7WUFFUCxNQUFNLFdBQVcsR0FBRyxNQUErQixDQUFDO1lBRXBELHFDQUFxQztZQUNyQyxJQUFJLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLENBQUM7WUFFaEQsbUNBQW1DO1lBQ25DLElBQUksV0FBVyxDQUFDLGtCQUFrQixJQUFJLFdBQVcsQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUM3RSxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FDOUMsV0FBVyxDQUFDLGtCQUFtQixDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FDakQsQ0FBQzthQUNMO1lBRUQsbUNBQW1DO1lBQ25DLElBQUksV0FBVyxDQUFDLGtCQUFrQixJQUFJLFdBQVcsQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFO2dCQUM3RSxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FDOUMsQ0FBQyxXQUFXLENBQUMsa0JBQW1CLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUNsRCxDQUFDO2FBQ0w7WUFFRCx5QkFBeUI7WUFDekIsTUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLGdCQUFnQixDQUFDLElBQUksSUFBSSxDQUFD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QzdCLE9BQU8sR0FBRyxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVPLGNBQWMsQ0FBQyxTQUFjO1FBQ2pDLElBQUksQ0FBQyxTQUFTO1lBQUUsT0FBTyxFQUFFLENBQUM7UUFDMUIsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUM7UUFDaEUsT0FBTyxDQUFBLEdBQUcsYUFBSCxHQUFHLHVCQUFILEdBQUcsQ0FBRSxRQUFRLEdBQUcsT0FBTyxDQUFDLFlBQVksRUFBRSxFQUFFLENBQUMsS0FBSSxFQUFFLENBQUM7SUFDM0QsQ0FBQztDQUNKO0FBNVNELDBEQTRTQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMva2l0ZWxldi9Eb2N1bWVudHMvZXhvY29ydGV4LW9ic2lkaWFuLXBsdWdpbi9zcmMvcHJlc2VudGF0aW9uL3JlbmRlcmVycy9Qcm9wZXJ0aWVzQmxvY2tSZW5kZXJlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHAsIFRGaWxlIH0gZnJvbSAnb2JzaWRpYW4nO1xuaW1wb3J0IHsgUHJvcGVydGllc0Jsb2NrQ29uZmlnIH0gZnJvbSAnLi4vLi4vZG9tYWluL2VudGl0aWVzL0xheW91dEJsb2NrJztcbmltcG9ydCB7IFByb3BlcnR5UmVuZGVyZXIgfSBmcm9tICcuLi9jb21wb25lbnRzL1Byb3BlcnR5UmVuZGVyZXInO1xuXG5leHBvcnQgY2xhc3MgUHJvcGVydGllc0Jsb2NrUmVuZGVyZXIge1xuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIGFwcDogQXBwLFxuICAgICAgICBwcml2YXRlIHByb3BlcnR5UmVuZGVyZXI6IFByb3BlcnR5UmVuZGVyZXJcbiAgICApIHt9XG5cbiAgICBhc3luYyByZW5kZXIoXG4gICAgICAgIGNvbnRhaW5lcjogSFRNTEVsZW1lbnQsXG4gICAgICAgIGNvbmZpZzogYW55LFxuICAgICAgICBmaWxlOiBURmlsZSxcbiAgICAgICAgZnJvbnRtYXR0ZXI6IGFueSxcbiAgICAgICAgZHY6IGFueVxuICAgICk6IFByb21pc2U8dm9pZD4ge1xuICAgICAgICBjb25zdCBwcm9wc0NvbmZpZyA9IGNvbmZpZyBhcyBQcm9wZXJ0aWVzQmxvY2tDb25maWc7XG4gICAgICAgIFxuICAgICAgICAvLyBEZXRlcm1pbmUgd2hpY2ggcHJvcGVydGllcyB0byBzaG93XG4gICAgICAgIGxldCBwcm9wZXJ0aWVzVG9TaG93ID0gT2JqZWN0LmtleXMoZnJvbnRtYXR0ZXIpO1xuICAgICAgICBcbiAgICAgICAgLy8gQXBwbHkgaW5jbHVkZWQgcHJvcGVydGllcyBmaWx0ZXJcbiAgICAgICAgaWYgKHByb3BzQ29uZmlnLmluY2x1ZGVkUHJvcGVydGllcyAmJiBwcm9wc0NvbmZpZy5pbmNsdWRlZFByb3BlcnRpZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcHJvcGVydGllc1RvU2hvdyA9IHByb3BlcnRpZXNUb1Nob3cuZmlsdGVyKHByb3AgPT4gXG4gICAgICAgICAgICAgICAgcHJvcHNDb25maWcuaW5jbHVkZWRQcm9wZXJ0aWVzIS5pbmNsdWRlcyhwcm9wKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8gQXBwbHkgZXhjbHVkZWQgcHJvcGVydGllcyBmaWx0ZXJcbiAgICAgICAgaWYgKHByb3BzQ29uZmlnLmV4Y2x1ZGVkUHJvcGVydGllcyAmJiBwcm9wc0NvbmZpZy5leGNsdWRlZFByb3BlcnRpZXMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgcHJvcGVydGllc1RvU2hvdyA9IHByb3BlcnRpZXNUb1Nob3cuZmlsdGVyKHByb3AgPT4gXG4gICAgICAgICAgICAgICAgIXByb3BzQ29uZmlnLmV4Y2x1ZGVkUHJvcGVydGllcyEuaW5jbHVkZXMocHJvcClcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIC8vIEdldCBhc3NldCBJRCBhbmQgY2xhc3NcbiAgICAgICAgY29uc3QgYXNzZXRJZCA9IGZyb250bWF0dGVyWydleG9fX0Fzc2V0X3VpZCddIHx8IGZpbGUucGF0aDtcbiAgICAgICAgY29uc3QgaW5zdGFuY2VDbGFzcyA9IGZyb250bWF0dGVyWydleG9fX0luc3RhbmNlX2NsYXNzJ107XG4gICAgICAgIGNvbnN0IGNsZWFuQ2xhc3NOYW1lID0gdGhpcy5jbGVhbkNsYXNzTmFtZShpbnN0YW5jZUNsYXNzKTtcbiAgICAgICAgXG4gICAgICAgIC8vIENoZWNrIGlmIHByb3BlcnRpZXMgYXJlIGVkaXRhYmxlXG4gICAgICAgIGNvbnN0IGVkaXRhYmxlUHJvcHMgPSBwcm9wc0NvbmZpZy5lZGl0YWJsZVByb3BlcnRpZXMgfHwgW107XG4gICAgICAgIFxuICAgICAgICAvLyBHcm91cCBwcm9wZXJ0aWVzIGlmIGdyb3VwQnkgaXMgc3BlY2lmaWVkXG4gICAgICAgIGlmIChwcm9wc0NvbmZpZy5ncm91cEJ5KSB7XG4gICAgICAgICAgICB0aGlzLnJlbmRlckdyb3VwZWRQcm9wZXJ0aWVzKFxuICAgICAgICAgICAgICAgIGNvbnRhaW5lcixcbiAgICAgICAgICAgICAgICBwcm9wZXJ0aWVzVG9TaG93LFxuICAgICAgICAgICAgICAgIGZyb250bWF0dGVyLFxuICAgICAgICAgICAgICAgIHByb3BzQ29uZmlnLmdyb3VwQnksXG4gICAgICAgICAgICAgICAgYXNzZXRJZCxcbiAgICAgICAgICAgICAgICBjbGVhbkNsYXNzTmFtZSxcbiAgICAgICAgICAgICAgICBlZGl0YWJsZVByb3BzXG4gICAgICAgICAgICApO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5yZW5kZXJGbGF0UHJvcGVydGllcyhcbiAgICAgICAgICAgICAgICBjb250YWluZXIsXG4gICAgICAgICAgICAgICAgcHJvcGVydGllc1RvU2hvdyxcbiAgICAgICAgICAgICAgICBmcm9udG1hdHRlcixcbiAgICAgICAgICAgICAgICBhc3NldElkLFxuICAgICAgICAgICAgICAgIGNsZWFuQ2xhc3NOYW1lLFxuICAgICAgICAgICAgICAgIGVkaXRhYmxlUHJvcHNcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICByZW5kZXJQcm9wZXJ0aWVzQmxvY2socHJvcGVydGllczogYW55W10sIGNvbnRhaW5lcjogSFRNTEVsZW1lbnQpOiB2b2lkIHtcbiAgICAgICAgaWYgKCFjb250YWluZXIpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghcHJvcGVydGllcyB8fCBwcm9wZXJ0aWVzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBwcm9wZXJ0aWVzLmZvckVhY2gocHJvcCA9PiB7XG4gICAgICAgICAgICBpZiAoIXByb3AgfHwgdHlwZW9mIHByb3AgIT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICBjb25zdCBwcm9wZXJ0eURpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICAgICAgcHJvcGVydHlEaXYuY2xhc3NOYW1lID0gJ3Byb3BlcnR5LWl0ZW0nO1xuICAgICAgICAgICAgY29udGFpbmVyLmFwcGVuZENoaWxkKHByb3BlcnR5RGl2KTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gUHJvcGVydHkgbmFtZVxuICAgICAgICAgICAgaWYgKHByb3AubmFtZSkge1xuICAgICAgICAgICAgICAgIGNvbnN0IG5hbWVFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcbiAgICAgICAgICAgICAgICBuYW1lRWwuY2xhc3NOYW1lID0gJ3Byb3BlcnR5LW5hbWUnO1xuICAgICAgICAgICAgICAgIG5hbWVFbC50ZXh0Q29udGVudCA9IHRoaXMuZm9ybWF0UHJvcGVydHlOYW1lKHByb3AubmFtZSk7XG4gICAgICAgICAgICAgICAgcHJvcGVydHlEaXYuYXBwZW5kQ2hpbGQobmFtZUVsKTtcbiAgICAgICAgICAgICAgICBcbiAgICAgICAgICAgICAgICAvLyBBZGQgc2VwYXJhdG9yXG4gICAgICAgICAgICAgICAgY29uc3Qgc2VwYXJhdG9yID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpO1xuICAgICAgICAgICAgICAgIHNlcGFyYXRvci50ZXh0Q29udGVudCA9ICc6ICc7XG4gICAgICAgICAgICAgICAgcHJvcGVydHlEaXYuYXBwZW5kQ2hpbGQoc2VwYXJhdG9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gUHJvcGVydHkgdmFsdWVcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlRWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7XG4gICAgICAgICAgICB2YWx1ZUVsLmNsYXNzTmFtZSA9ICdwcm9wZXJ0eS12YWx1ZSc7XG4gICAgICAgICAgICBwcm9wZXJ0eURpdi5hcHBlbmRDaGlsZCh2YWx1ZUVsKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgaWYgKHByb3AuZWRpdGFibGUpIHtcbiAgICAgICAgICAgICAgICAvLyBDcmVhdGUgaW5wdXQgZm9yIGVkaXRhYmxlIHByb3BlcnRpZXNcbiAgICAgICAgICAgICAgICBpZiAocHJvcC50eXBlID09PSAnYm9vbGVhbicpIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hlY2tib3ggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpO1xuICAgICAgICAgICAgICAgICAgICBjaGVja2JveC50eXBlID0gJ2NoZWNrYm94JztcbiAgICAgICAgICAgICAgICAgICAgY2hlY2tib3guY2hlY2tlZCA9ICEhcHJvcC52YWx1ZTtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWVFbC5hcHBlbmRDaGlsZChjaGVja2JveCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChwcm9wLnR5cGUgPT09ICdudW1iZXInKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGlucHV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW5wdXQnKTtcbiAgICAgICAgICAgICAgICAgICAgaW5wdXQudHlwZSA9ICdudW1iZXInO1xuICAgICAgICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9IFN0cmluZyhwcm9wLnZhbHVlIHx8ICcnKTtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWVFbC5hcHBlbmRDaGlsZChpbnB1dCk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaW5wdXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbnB1dCcpO1xuICAgICAgICAgICAgICAgICAgICBpbnB1dC50eXBlID0gJ3RleHQnO1xuICAgICAgICAgICAgICAgICAgICBpbnB1dC52YWx1ZSA9IFN0cmluZyhwcm9wLnZhbHVlIHx8ICcnKTtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWVFbC5hcHBlbmRDaGlsZChpbnB1dCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAvLyBSZW5kZXIgcmVhZG9ubHkgdmFsdWVcbiAgICAgICAgICAgICAgICBpZiAocHJvcC50eXBlID09PSAndGFncycgJiYgQXJyYXkuaXNBcnJheShwcm9wLnZhbHVlKSkge1xuICAgICAgICAgICAgICAgICAgICBwcm9wLnZhbHVlLmZvckVhY2goKHRhZzogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0YWdFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ0VsLmNsYXNzTmFtZSA9ICd0YWcnO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGFnRWwudGV4dENvbnRlbnQgPSB0YWc7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZUVsLmFwcGVuZENoaWxkKHRhZ0VsKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZm9ybWF0dGVkVmFsdWUgPSB0aGlzLmZvcm1hdFZhbHVlKHByb3AudmFsdWUpO1xuICAgICAgICAgICAgICAgICAgICB2YWx1ZUVsLnRleHRDb250ZW50ID0gZm9ybWF0dGVkVmFsdWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFzeW5jIHJlbmRlckZsYXRQcm9wZXJ0aWVzKFxuICAgICAgICBjb250YWluZXI6IEhUTUxFbGVtZW50LFxuICAgICAgICBwcm9wZXJ0aWVzOiBzdHJpbmdbXSxcbiAgICAgICAgZnJvbnRtYXR0ZXI6IGFueSxcbiAgICAgICAgYXNzZXRJZDogc3RyaW5nLFxuICAgICAgICBjbGFzc05hbWU6IHN0cmluZyxcbiAgICAgICAgZWRpdGFibGVQcm9wczogc3RyaW5nW11cbiAgICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAgICAgLy8gVXNlIFByb3BlcnR5UmVuZGVyZXIgZm9yIGFsbCBwcm9wZXJ0aWVzIChpdCB3aWxsIGhhbmRsZSBlZGl0YWJpbGl0eSBpbnRlcm5hbGx5KVxuICAgICAgICBjb25zdCBlZGl0YWJsZUNvbnRhaW5lciA9IGNvbnRhaW5lci5jcmVhdGVEaXYoeyBjbHM6ICdleG9jb3J0ZXgtcHJvcGVydGllcy1lZGl0YWJsZScgfSk7XG4gICAgICAgIGF3YWl0IHRoaXMucHJvcGVydHlSZW5kZXJlci5yZW5kZXJQcm9wZXJ0aWVzQmxvY2soXG4gICAgICAgICAgICBlZGl0YWJsZUNvbnRhaW5lcixcbiAgICAgICAgICAgIGFzc2V0SWQsXG4gICAgICAgICAgICBjbGFzc05hbWUsXG4gICAgICAgICAgICBmcm9udG1hdHRlclxuICAgICAgICApO1xuICAgICAgICBcbiAgICAgICAgLy8gUmVuZGVyIG5vbi1lZGl0YWJsZSBwcm9wZXJ0aWVzXG4gICAgICAgIGNvbnN0IHJlYWRPbmx5UHJvcHMgPSBwcm9wZXJ0aWVzLmZpbHRlcihwID0+ICFlZGl0YWJsZVByb3BzLmluY2x1ZGVzKHApKTtcbiAgICAgICAgaWYgKHJlYWRPbmx5UHJvcHMubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgY29uc3QgcmVhZE9ubHlDb250YWluZXIgPSBjb250YWluZXIuY3JlYXRlRGl2KHsgY2xzOiAnZXhvY29ydGV4LXByb3BlcnRpZXMtcmVhZG9ubHknIH0pO1xuICAgICAgICAgICAgY29uc3QgdGFibGUgPSByZWFkT25seUNvbnRhaW5lci5jcmVhdGVFbCgndGFibGUnLCB7IGNsczogJ2V4b2NvcnRleC1wcm9wZXJ0aWVzLXRhYmxlJyB9KTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgcmVhZE9ubHlQcm9wcy5mb3JFYWNoKHByb3AgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHJvdyA9IHRhYmxlLmNyZWF0ZUVsKCd0cicpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFByb3BlcnR5IG5hbWVcbiAgICAgICAgICAgICAgICBjb25zdCBuYW1lQ2VsbCA9IHJvdy5jcmVhdGVFbCgndGQnLCB7IGNsczogJ3Byb3BlcnR5LW5hbWUnIH0pO1xuICAgICAgICAgICAgICAgIG5hbWVDZWxsLnNldFRleHQodGhpcy5mb3JtYXRQcm9wZXJ0eU5hbWUocHJvcCkpO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIC8vIFByb3BlcnR5IHZhbHVlXG4gICAgICAgICAgICAgICAgY29uc3QgdmFsdWVDZWxsID0gcm93LmNyZWF0ZUVsKCd0ZCcsIHsgY2xzOiAncHJvcGVydHktdmFsdWUnIH0pO1xuICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gZnJvbnRtYXR0ZXJbcHJvcF07XG4gICAgICAgICAgICAgICAgdmFsdWVDZWxsLnNldFRleHQodGhpcy5mb3JtYXRWYWx1ZSh2YWx1ZSkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHJlbmRlckdyb3VwZWRQcm9wZXJ0aWVzKFxuICAgICAgICBjb250YWluZXI6IEhUTUxFbGVtZW50LFxuICAgICAgICBwcm9wZXJ0aWVzOiBzdHJpbmdbXSxcbiAgICAgICAgZnJvbnRtYXR0ZXI6IGFueSxcbiAgICAgICAgZ3JvdXBCeTogc3RyaW5nLFxuICAgICAgICBhc3NldElkOiBzdHJpbmcsXG4gICAgICAgIGNsYXNzTmFtZTogc3RyaW5nLFxuICAgICAgICBlZGl0YWJsZVByb3BzOiBzdHJpbmdbXVxuICAgICk6IHZvaWQge1xuICAgICAgICAvLyBHcm91cCBwcm9wZXJ0aWVzIGJ5IHByZWZpeCBvciBjdXN0b20gbG9naWNcbiAgICAgICAgY29uc3QgZ3JvdXBzID0gbmV3IE1hcDxzdHJpbmcsIHN0cmluZ1tdPigpO1xuICAgICAgICBcbiAgICAgICAgcHJvcGVydGllcy5mb3JFYWNoKHByb3AgPT4ge1xuICAgICAgICAgICAgY29uc3QgZ3JvdXAgPSB0aGlzLmdldFByb3BlcnR5R3JvdXAocHJvcCwgZ3JvdXBCeSk7XG4gICAgICAgICAgICBpZiAoIWdyb3Vwcy5oYXMoZ3JvdXApKSB7XG4gICAgICAgICAgICAgICAgZ3JvdXBzLnNldChncm91cCwgW10pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZ3JvdXBzLmdldChncm91cCkhLnB1c2gocHJvcCk7XG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgLy8gUmVuZGVyIGVhY2ggZ3JvdXBcbiAgICAgICAgZ3JvdXBzLmZvckVhY2goKHByb3BzLCBncm91cE5hbWUpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGdyb3VwQ29udGFpbmVyID0gY29udGFpbmVyLmNyZWF0ZURpdih7IGNsczogJ2V4b2NvcnRleC1wcm9wZXJ0eS1ncm91cCcgfSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGlmIChncm91cE5hbWUgIT09ICdPdGhlcicpIHtcbiAgICAgICAgICAgICAgICBncm91cENvbnRhaW5lci5jcmVhdGVFbCgnaDQnLCB7IFxuICAgICAgICAgICAgICAgICAgICB0ZXh0OiBncm91cE5hbWUsXG4gICAgICAgICAgICAgICAgICAgIGNsczogJ3Byb3BlcnR5LWdyb3VwLWhlYWRlcidcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIFxuICAgICAgICAgICAgY29uc3QgZ3JvdXBDb250ZW50ID0gZ3JvdXBDb250YWluZXIuY3JlYXRlRGl2KHsgY2xzOiAncHJvcGVydHktZ3JvdXAtY29udGVudCcgfSk7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIC8vIFNlcGFyYXRlIGVkaXRhYmxlIGFuZCByZWFkb25seVxuICAgICAgICAgICAgY29uc3QgZ3JvdXBFZGl0YWJsZSA9IHByb3BzLmZpbHRlcihwID0+IGVkaXRhYmxlUHJvcHMuaW5jbHVkZXMocCkpO1xuICAgICAgICAgICAgY29uc3QgZ3JvdXBSZWFkT25seSA9IHByb3BzLmZpbHRlcihwID0+ICFlZGl0YWJsZVByb3BzLmluY2x1ZGVzKHApKTtcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgLy8gUmVuZGVyIGVkaXRhYmxlIHByb3BlcnRpZXNcbiAgICAgICAgICAgIGlmIChncm91cEVkaXRhYmxlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICB0aGlzLnByb3BlcnR5UmVuZGVyZXIucmVuZGVyUHJvcGVydGllc0Jsb2NrKFxuICAgICAgICAgICAgICAgICAgICBncm91cENvbnRlbnQsXG4gICAgICAgICAgICAgICAgICAgIGFzc2V0SWQsXG4gICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZSxcbiAgICAgICAgICAgICAgICAgICAgZnJvbnRtYXR0ZXJcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICAvLyBSZW5kZXIgcmVhZG9ubHkgcHJvcGVydGllc1xuICAgICAgICAgICAgaWYgKGdyb3VwUmVhZE9ubHkubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgIGNvbnN0IHRhYmxlID0gZ3JvdXBDb250ZW50LmNyZWF0ZUVsKCd0YWJsZScsIHsgY2xzOiAnZXhvY29ydGV4LXByb3BlcnRpZXMtdGFibGUnIH0pO1xuICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgIGdyb3VwUmVhZE9ubHkuZm9yRWFjaChwcm9wID0+IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3Qgcm93ID0gdGFibGUuY3JlYXRlRWwoJ3RyJyk7XG4gICAgICAgICAgICAgICAgICAgIFxuICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lQ2VsbCA9IHJvdy5jcmVhdGVFbCgndGQnLCB7IGNsczogJ3Byb3BlcnR5LW5hbWUnIH0pO1xuICAgICAgICAgICAgICAgICAgICBuYW1lQ2VsbC5zZXRUZXh0KHRoaXMuZm9ybWF0UHJvcGVydHlOYW1lKHByb3ApKTtcbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlQ2VsbCA9IHJvdy5jcmVhdGVFbCgndGQnLCB7IGNsczogJ3Byb3BlcnR5LXZhbHVlJyB9KTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBmcm9udG1hdHRlcltwcm9wXTtcbiAgICAgICAgICAgICAgICAgICAgdmFsdWVDZWxsLnNldFRleHQodGhpcy5mb3JtYXRWYWx1ZSh2YWx1ZSkpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFByb3BlcnR5R3JvdXAocHJvcGVydHk6IHN0cmluZywgZ3JvdXBCeTogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgaWYgKGdyb3VwQnkgPT09ICdwcmVmaXgnKSB7XG4gICAgICAgICAgICBjb25zdCBtYXRjaCA9IHByb3BlcnR5Lm1hdGNoKC9eKFteX10rKV9fLyk7XG4gICAgICAgICAgICBpZiAobWF0Y2gpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbWF0Y2hbMV0udG9VcHBlckNhc2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgaWYgKGdyb3VwQnkgPT09ICdjYXRlZ29yeScpIHtcbiAgICAgICAgICAgIGlmIChwcm9wZXJ0eS5pbmNsdWRlcygnc3RhdHVzJykgfHwgcHJvcGVydHkuaW5jbHVkZXMoJ1N0YXR1cycpKSByZXR1cm4gJ1N0YXR1cyc7XG4gICAgICAgICAgICBpZiAocHJvcGVydHkuaW5jbHVkZXMoJ2RhdGUnKSB8fCBwcm9wZXJ0eS5pbmNsdWRlcygnRGF0ZScpKSByZXR1cm4gJ0RhdGVzJztcbiAgICAgICAgICAgIGlmIChwcm9wZXJ0eS5pbmNsdWRlcygncmVsYXRlJykgfHwgcHJvcGVydHkuaW5jbHVkZXMoJ2xpbmsnKSkgcmV0dXJuICdSZWxhdGlvbnMnO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gJ090aGVyJztcbiAgICB9XG5cbiAgICBwcml2YXRlIGZvcm1hdFByb3BlcnR5TmFtZShwcm9wOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICAvLyBGb3IgdGVzdCBjb21wYXRpYmlsaXR5LCBrZWVwIG9yaWdpbmFsIHByb3AgbmFtZSBpZiBpdCBkb2Vzbid0IGhhdmUgcHJlZml4XG4gICAgICAgIGlmICghcHJvcC5pbmNsdWRlcygnX18nKSkge1xuICAgICAgICAgICAgcmV0dXJuIHByb3A7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIC8vIFJlbW92ZSBwcmVmaXggYW5kIGZvcm1hdFxuICAgICAgICByZXR1cm4gcHJvcFxuICAgICAgICAgICAgLnJlcGxhY2UoL15bXl9dK19fLywgJycpXG4gICAgICAgICAgICAucmVwbGFjZSgvXy9nLCAnICcpXG4gICAgICAgICAgICAucmVwbGFjZSgvXFxiXFx3L2csIGwgPT4gbC50b1VwcGVyQ2FzZSgpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGZvcm1hdFZhbHVlKHZhbHVlOiBhbnkpOiBzdHJpbmcge1xuICAgICAgICBpZiAodmFsdWUgPT09IG51bGwgfHwgdmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuICcnO1xuICAgICAgICBcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICAgICAgICByZXR1cm4gdmFsdWUubWFwKHYgPT4gdGhpcy5jbGVhblZhbHVlKHYpKS5qb2luKCcsICcpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAnYm9vbGVhbicpIHtcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZSA/ICfinJMnIDogJ+Kclyc7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIERhdGUpIHtcbiAgICAgICAgICAgIHJldHVybiB2YWx1ZS50b0xvY2FsZURhdGVTdHJpbmcoKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcpIHtcbiAgICAgICAgICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIHJldHVybiB0aGlzLmNsZWFuVmFsdWUodmFsdWUpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2xlYW5WYWx1ZSh2YWx1ZTogYW55KTogc3RyaW5nIHtcbiAgICAgICAgaWYgKCF2YWx1ZSkgcmV0dXJuICcnO1xuICAgICAgICBjb25zdCBzdHIgPSB2YWx1ZS50b1N0cmluZygpO1xuICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UoL1xcW1xcW3xcXF1cXF0vZywgJycpO1xuICAgIH1cblxuICAgIHByaXZhdGUgY2xlYW5DbGFzc05hbWUoY2xhc3NOYW1lOiBhbnkpOiBzdHJpbmcge1xuICAgICAgICBpZiAoIWNsYXNzTmFtZSkgcmV0dXJuICcnO1xuICAgICAgICBjb25zdCBzdHIgPSBBcnJheS5pc0FycmF5KGNsYXNzTmFtZSkgPyBjbGFzc05hbWVbMF0gOiBjbGFzc05hbWU7XG4gICAgICAgIHJldHVybiBzdHI/LnRvU3RyaW5nKCkucmVwbGFjZSgvXFxbXFxbfFxcXVxcXS9nLCAnJykgfHwgJyc7XG4gICAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==