c7f4c7ecdb0f92ca3039bd456d122e26
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.QueryTemplateUseCase = void 0;
const QueryTemplate_1 = require("../../domain/visual/QueryTemplate");
const VisualQueryNode_1 = require("../../domain/visual/VisualQueryNode");
const VisualQueryEdge_1 = require("../../domain/visual/VisualQueryEdge");
class QueryTemplateUseCase {
    constructor(templateRepository) {
        this.templateRepository = templateRepository;
    }
    getTemplateRepository() {
        return this.templateRepository;
    }
    async getAllTemplates() {
        return await this.templateRepository.findAll();
    }
    async getTemplateById(id) {
        return await this.templateRepository.findById(id);
    }
    async searchTemplates(criteria) {
        return await this.templateRepository.findByCriteria(criteria);
    }
    async getTemplatesByCategory(category) {
        return await this.templateRepository.findByCategory(category);
    }
    async getBuiltInTemplates() {
        return await this.templateRepository.getBuiltInTemplates();
    }
    async getCustomTemplates() {
        return await this.templateRepository.getCustomTemplates();
    }
    async getRecentTemplates(limit) {
        return await this.templateRepository.getRecentlyUsed(limit);
    }
    async saveTemplate(template) {
        if (template.isBuiltInTemplate()) {
            throw new Error("Cannot save built-in templates");
        }
        return await this.templateRepository.save(template);
    }
    async createCustomTemplate(nodes, edges, viewport, name, description, category = QueryTemplate_1.TemplateCategory.CUSTOM, tags = []) {
        const metadata = {
            name,
            description,
            category,
            tags: [...tags, "custom"],
            difficulty: "intermediate",
            createdAt: new Date(),
            updatedAt: new Date(),
            version: "1.0.0",
        };
        const template = QueryTemplate_1.QueryTemplate.fromCanvas(nodes, edges, viewport, {
            name,
            description,
            category,
            difficulty: QueryTemplate_1.TemplateDifficulty.INTERMEDIATE,
            tags,
        });
        return await this.templateRepository.create(template);
    }
    async cloneTemplate(templateId, newName) {
        const template = await this.templateRepository.findById(templateId);
        if (!template) {
            throw new Error(`Template with ID ${templateId} not found`);
        }
        let cloned = template.clone();
        if (newName) {
            cloned = cloned.updateMetadata({
                name: newName,
            });
        }
        return await this.templateRepository.create(cloned);
    }
    async deleteTemplate(id) {
        const template = await this.templateRepository.findById(id);
        if (!template) {
            return false;
        }
        if (template.isBuiltInTemplate()) {
            throw new Error("Cannot delete built-in templates");
        }
        return await this.templateRepository.delete(id);
    }
    async instantiateTemplate(template) {
        const validation = template.validateParameters();
        if (!validation.isValid) {
            throw new Error(`Template parameters are invalid: ${validation.errors.join(", ")}`);
        }
        await this.templateRepository.recordUsage(template.getId());
        const instantiated = template.instantiate({});
        return {
            nodes: instantiated.layout?.nodes?.map((node) => {
                // Convert serialized nodes back to VisualQueryNode instances
                return new VisualQueryNode_1.VisualQueryNode({
                    id: node.id,
                    type: node.type,
                    label: node.label,
                    position: node.position,
                    variableName: node.variableName,
                    uri: node.uri,
                    dimensions: node.dimensions,
                });
            }) || [],
            edges: instantiated.layout?.edges?.map((edge) => {
                // Convert serialized edges back to VisualQueryEdge instances
                return new VisualQueryEdge_1.VisualQueryEdge({
                    id: edge.id,
                    sourceNodeId: edge.sourceNodeId,
                    targetNodeId: edge.targetNodeId,
                    type: edge.type,
                    label: edge.label,
                    propertyUri: edge.propertyUri,
                });
            }) || [],
        };
    }
    async exportTemplates(templateIds) {
        const templates = await this.templateRepository.exportTemplates(templateIds);
        return JSON.stringify(templates, null, 2);
    }
    async importTemplates(jsonData) {
        try {
            const templatesData = JSON.parse(jsonData);
            if (!Array.isArray(templatesData)) {
                throw new Error("Invalid JSON format: expected array of templates");
            }
            return await this.templateRepository.importTemplates(templatesData);
        }
        catch (error) {
            throw new Error(`Failed to import templates: ${error.message}`);
        }
    }
    async getUsageStatistics(templateId) {
        return await this.templateRepository.getUsageStats(templateId);
    }
    async updateTemplateMetadata(templateId, updates) {
        const template = await this.templateRepository.findById(templateId);
        if (!template) {
            throw new Error(`Template with ID ${templateId} not found`);
        }
        if (template.isBuiltInTemplate()) {
            throw new Error("Cannot modify built-in templates");
        }
        const updatedTemplate = template.updateMetadata(updates);
        return await this.templateRepository.update(updatedTemplate);
    }
    async validateTemplateParameters(template) {
        const validation = template.validateParameters();
        const parameters = template.getParameters();
        const parameterValues = template.getParameterValues();
        const missingParameters = [];
        const invalidParameters = [];
        parameters.forEach((param) => {
            const paramId = param.id || `param_${param.name}`;
            if (param.required && !parameterValues.has(paramId)) {
                missingParameters.push(param.name);
            }
            const value = parameterValues.get(paramId);
            if (value && param.constraints) {
                // Additional validation could be added here
            }
        });
        return {
            isValid: validation.isValid,
            errors: validation.errors,
            missingParameters,
            invalidParameters,
        };
    }
    async getTemplatePreview(templateId) {
        const template = await this.templateRepository.findById(templateId);
        if (!template) {
            throw new Error(`Template with ID ${templateId} not found`);
        }
        const layout = template.getLayout();
        const parameters = template.getParameters();
        const nodeCount = layout.nodes.length;
        const edgeCount = layout.edges.length;
        // Determine complexity based on various factors
        let complexity = "simple";
        const totalElements = nodeCount + edgeCount + parameters.length;
        if (totalElements <= 5) {
            complexity = "simple";
        }
        else if (totalElements <= 10) {
            complexity = "moderate";
        }
        else {
            complexity = "complex";
        }
        // Generate example SPARQL if pattern is available
        let sparqlQuery = template.getMetadata().sparqlPattern || "";
        // Replace parameter placeholders with example values
        parameters.forEach((param) => {
            const paramId = param.id || `param_${param.name}`;
            const placeholder = `{${paramId.toUpperCase()}}`;
            const exampleValue = param.defaultValue || `{${param.name}}`;
            sparqlQuery = sparqlQuery.replace(new RegExp(placeholder, "g"), exampleValue);
        });
        return {
            sparqlQuery,
            nodeCount,
            edgeCount,
            parameterCount: parameters.length,
            complexity,
        };
    }
    async refreshTemplateCache() {
        await this.templateRepository.refresh();
    }
}
exports.QueryTemplateUseCase = QueryTemplateUseCase;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2FwcGxpY2F0aW9uL3VzZS1jYXNlcy9RdWVyeVRlbXBsYXRlVXNlQ2FzZS50cyIsIm1hcHBpbmdzIjoiOzs7QUFJQSxxRUFJMkM7QUFDM0MseUVBQWdGO0FBQ2hGLHlFQUFnRjtBQUVoRixNQUFhLG9CQUFvQjtJQUMvQixZQUE2QixrQkFBNEM7UUFBNUMsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUEwQjtJQUFHLENBQUM7SUFFN0UscUJBQXFCO1FBQ25CLE9BQU8sSUFBSSxDQUFDLGtCQUFrQixDQUFDO0lBQ2pDLENBQUM7SUFFRCxLQUFLLENBQUMsZUFBZTtRQUNuQixPQUFPLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ2pELENBQUM7SUFFRCxLQUFLLENBQUMsZUFBZSxDQUFDLEVBQVU7UUFDOUIsT0FBTyxNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDcEQsQ0FBQztJQUVELEtBQUssQ0FBQyxlQUFlLENBQ25CLFFBQWdDO1FBRWhDLE9BQU8sTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ2hFLENBQUM7SUFFRCxLQUFLLENBQUMsc0JBQXNCLENBQzFCLFFBQTBCO1FBRTFCLE9BQU8sTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ2hFLENBQUM7SUFFRCxLQUFLLENBQUMsbUJBQW1CO1FBQ3ZCLE9BQU8sTUFBTSxJQUFJLENBQUMsa0JBQWtCLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztJQUM3RCxDQUFDO0lBRUQsS0FBSyxDQUFDLGtCQUFrQjtRQUN0QixPQUFPLE1BQU0sSUFBSSxDQUFDLGtCQUFrQixDQUFDLGtCQUFrQixFQUFFLENBQUM7SUFDNUQsQ0FBQztJQUVELEtBQUssQ0FBQyxrQkFBa0Is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QUFDO1lBQ2pELE1BQU0sWUFBWSxHQUFHLEtBQUssQ0FBQyxZQUFZLElBQUksSUFBSSxLQUFLLENBQUMsSUFBSSxHQUFHLENBQUM7WUFDN0QsV0FBVyxHQUFHLFdBQVcsQ0FBQyxPQUFPLENBQy9CLElBQUksTUFBTSxDQUFDLFdBQVcsRUFBRSxHQUFHLENBQUMsRUFDNUIsWUFBWSxDQUNiLENBQUM7UUFDSixDQUFDLENBQUMsQ0FBQztRQUVILE9BQU87WUFDTCxXQUFXO1lBQ1gsU0FBUztZQUNULFNBQVM7WUFDVCxjQUFjLEVBQUUsVUFBVSxDQUFDLE1BQU07WUFDakMsVUFBVTtTQUNYLENBQUM7SUFDSixDQUFDO0lBRUQsS0FBSyxDQUFDLG9CQUFvQjtRQUN4QixNQUFNLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUMxQyxDQUFDO0NBQ0Y7QUFqU0Qsb0RBaVNDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9raXRlbGV2L0RvY3VtZW50cy9leG9jb3J0ZXgtb2JzaWRpYW4tcGx1Z2luL3NyYy9hcHBsaWNhdGlvbi91c2UtY2FzZXMvUXVlcnlUZW1wbGF0ZVVzZUNhc2UudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgSVF1ZXJ5VGVtcGxhdGVSZXBvc2l0b3J5LFxuICBUZW1wbGF0ZVNlYXJjaENyaXRlcmlhLFxufSBmcm9tIFwiLi4vLi4vZG9tYWluL3JlcG9zaXRvcmllcy9JUXVlcnlUZW1wbGF0ZVJlcG9zaXRvcnlcIjtcbmltcG9ydCB7XG4gIFF1ZXJ5VGVtcGxhdGUsXG4gIFRlbXBsYXRlQ2F0ZWdvcnksXG4gIFRlbXBsYXRlRGlmZmljdWx0eSxcbn0gZnJvbSBcIi4uLy4uL2RvbWFpbi92aXN1YWwvUXVlcnlUZW1wbGF0ZVwiO1xuaW1wb3J0IHsgVmlzdWFsUXVlcnlOb2RlLCBOb2RlVHlwZSB9IGZyb20gXCIuLi8uLi9kb21haW4vdmlzdWFsL1Zpc3VhbFF1ZXJ5Tm9kZVwiO1xuaW1wb3J0IHsgVmlzdWFsUXVlcnlFZGdlLCBFZGdlVHlwZSB9IGZyb20gXCIuLi8uLi9kb21haW4vdmlzdWFsL1Zpc3VhbFF1ZXJ5RWRnZVwiO1xuXG5leHBvcnQgY2xhc3MgUXVlcnlUZW1wbGF0ZVVzZUNhc2Uge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IHRlbXBsYXRlUmVwb3NpdG9yeTogSVF1ZXJ5VGVtcGxhdGVSZXBvc2l0b3J5KSB7fVxuXG4gIGdldFRlbXBsYXRlUmVwb3NpdG9yeSgpOiBJUXVlcnlUZW1wbGF0ZVJlcG9zaXRvcnkge1xuICAgIHJldHVybiB0aGlzLnRlbXBsYXRlUmVwb3NpdG9yeTtcbiAgfVxuXG4gIGFzeW5jIGdldEFsbFRlbXBsYXRlcygpOiBQcm9taXNlPFF1ZXJ5VGVtcGxhdGVbXT4ge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnRlbXBsYXRlUmVwb3NpdG9yeS5maW5kQWxsKCk7XG4gIH1cblxuICBhc3luYyBnZXRUZW1wbGF0ZUJ5SWQoaWQ6IHN0cmluZyk6IFByb21pc2U8UXVlcnlUZW1wbGF0ZSB8IHVuZGVmaW5lZD4ge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnRlbXBsYXRlUmVwb3NpdG9yeS5maW5kQnlJZChpZCk7XG4gIH1cblxuICBhc3luYyBzZWFyY2hUZW1wbGF0ZXMoXG4gICAgY3JpdGVyaWE6IFRlbXBsYXRlU2VhcmNoQ3JpdGVyaWEsXG4gICk6IFByb21pc2U8UXVlcnlUZW1wbGF0ZVtdPiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LmZpbmRCeUNyaXRlcmlhKGNyaXRlcmlhKTtcbiAgfVxuXG4gIGFzeW5jIGdldFRlbXBsYXRlc0J5Q2F0ZWdvcnkoXG4gICAgY2F0ZWdvcnk6IFRlbXBsYXRlQ2F0ZWdvcnksXG4gICk6IFByb21pc2U8UXVlcnlUZW1wbGF0ZVtdPiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LmZpbmRCeUNhdGVnb3J5KGNhdGVnb3J5KTtcbiAgfVxuXG4gIGFzeW5jIGdldEJ1aWx0SW5UZW1wbGF0ZXMoKTogUHJvbWlzZTxRdWVyeVRlbXBsYXRlW10+IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy50ZW1wbGF0ZVJlcG9zaXRvcnkuZ2V0QnVpbHRJblRlbXBsYXRlcygpO1xuICB9XG5cbiAgYXN5bmMgZ2V0Q3VzdG9tVGVtcGxhdGVzKCk6IFByb21pc2U8UXVlcnlUZW1wbGF0ZVtdPiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LmdldEN1c3RvbVRlbXBsYXRlcygpO1xuICB9XG5cbiAgYXN5bmMgZ2V0UmVjZW50VGVtcGxhdGVzKGxpbWl0PzogbnVtYmVyKTogUHJvbWlzZTxRdWVyeVRlbXBsYXRlW10+IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy50ZW1wbGF0ZVJlcG9zaXRvcnkuZ2V0UmVjZW50bHlVc2VkKGxpbWl0KTtcbiAgfVxuXG4gIGFzeW5jIHNhdmVUZW1wbGF0ZSh0ZW1wbGF0ZTogUXVlcnlUZW1wbGF0ZSk6IFByb21pc2U8UXVlcnlUZW1wbGF0ZT4ge1xuICAgIGlmICh0ZW1wbGF0ZS5pc0J1aWx0SW5UZW1wbGF0ZSgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3Qgc2F2ZSBidWlsdC1pbiB0ZW1wbGF0ZXNcIik7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCB0aGlzLnRlbXBsYXRlUmVwb3NpdG9yeS5zYXZlKHRlbXBsYXRlKTtcbiAgfVxuXG4gIGFzeW5jIGNyZWF0ZUN1c3RvbVRlbXBsYXRlKFxuICAgIG5vZGVzOiBNYXA8c3RyaW5nLCBWaXN1YWxRdWVyeU5vZGU+LFxuICAgIGVkZ2VzOiBNYXA8c3RyaW5nLCBWaXN1YWxRdWVyeUVkZ2U+LFxuICAgIHZpZXdwb3J0OiB7IHg6IG51bWJlcjsgeTogbnVtYmVyOyB6b29tOiBudW1iZXIgfSxcbiAgICBuYW1lOiBzdHJpbmcsXG4gICAgZGVzY3JpcHRpb246IHN0cmluZyxcbiAgICBjYXRlZ29yeTogVGVtcGxhdGVDYXRlZ29yeSA9IFRlbXBsYXRlQ2F0ZWdvcnkuQ1VTVE9NLFxuICAgIHRhZ3M6IHN0cmluZ1tdID0gW10sXG4gICk6IFByb21pc2U8UXVlcnlUZW1wbGF0ZT4ge1xuICAgIGNvbnN0IG1ldGFkYXRhID0ge1xuICAgICAgbmFtZSxcbiAgICAgIGRlc2NyaXB0aW9uLFxuICAgICAgY2F0ZWdvcnksXG4gICAgICB0YWdzOiBbLi4udGFncywgXCJjdXN0b21cIl0sXG4gICAgICBkaWZmaWN1bHR5OiBcImludGVybWVkaWF0ZVwiIGFzIGNvbnN0LFxuICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgdmVyc2lvbjogXCIxLjAuMFwiLFxuICAgIH07XG5cbiAgICBjb25zdCB0ZW1wbGF0ZSA9IFF1ZXJ5VGVtcGxhdGUuZnJvbUNhbnZhcyhub2RlcywgZWRnZXMsIHZpZXdwb3J0LCB7XG4gICAgICBuYW1lLFxuICAgICAgZGVzY3JpcHRpb24sXG4gICAgICBjYXRlZ29yeSxcbiAgICAgIGRpZmZpY3VsdHk6IFRlbXBsYXRlRGlmZmljdWx0eS5JTlRFUk1FRElBVEUsXG4gICAgICB0YWdzLFxuICAgIH0pO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnRlbXBsYXRlUmVwb3NpdG9yeS5jcmVhdGUodGVtcGxhdGUpO1xuICB9XG5cbiAgYXN5bmMgY2xvbmVUZW1wbGF0ZShcbiAgICB0ZW1wbGF0ZUlkOiBzdHJpbmcsXG4gICAgbmV3TmFtZT86IHN0cmluZyxcbiAgKTogUHJvbWlzZTxRdWVyeVRlbXBsYXRlPiB7XG4gICAgY29uc3QgdGVtcGxhdGUgPSBhd2FpdCB0aGlzLnRlbXBsYXRlUmVwb3NpdG9yeS5maW5kQnlJZCh0ZW1wbGF0ZUlkKTtcbiAgICBpZiAoIXRlbXBsYXRlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRlbXBsYXRlIHdpdGggSUQgJHt0ZW1wbGF0ZUlkfSBub3QgZm91bmRgKTtcbiAgICB9XG5cbiAgICBsZXQgY2xvbmVkID0gdGVtcGxhdGUuY2xvbmUoKTtcbiAgICBpZiAobmV3TmFtZSkge1xuICAgICAgY2xvbmVkID0gY2xvbmVkLnVwZGF0ZU1ldGFkYXRhKHtcbiAgICAgICAgbmFtZTogbmV3TmFtZSxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBhd2FpdCB0aGlzLnRlbXBsYXRlUmVwb3NpdG9yeS5jcmVhdGUoY2xvbmVkKTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVRlbXBsYXRlKGlkOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCB0ZW1wbGF0ZSA9IGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LmZpbmRCeUlkKGlkKTtcbiAgICBpZiAoIXRlbXBsYXRlKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKHRlbXBsYXRlLmlzQnVpbHRJblRlbXBsYXRlKCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBkZWxldGUgYnVpbHQtaW4gdGVtcGxhdGVzXCIpO1xuICAgIH1cblxuICAgIHJldHVybiBhd2FpdCB0aGlzLnRlbXBsYXRlUmVwb3NpdG9yeS5kZWxldGUoaWQpO1xuICB9XG5cbiAgYXN5bmMgaW5zdGFudGlhdGVUZW1wbGF0ZSh0ZW1wbGF0ZTogUXVlcnlUZW1wbGF0ZSk6IFByb21pc2U8e1xuICAgIG5vZGVzOiBWaXN1YWxRdWVyeU5vZGVbXTtcbiAgICBlZGdlczogVmlzdWFsUXVlcnlFZGdlW107XG4gIH0+IHtcbiAgICBjb25zdCB2YWxpZGF0aW9uID0gdGVtcGxhdGUudmFsaWRhdGVQYXJhbWV0ZXJzKCk7XG4gICAgaWYgKCF2YWxpZGF0aW9uLmlzVmFsaWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFRlbXBsYXRlIHBhcmFtZXRlcnMgYXJlIGludmFsaWQ6ICR7dmFsaWRhdGlvbi5lcnJvcnMuam9pbihcIiwgXCIpfWAsXG4gICAgICApO1xuICAgIH1cblxuICAgIGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LnJlY29yZFVzYWdlKHRlbXBsYXRlLmdldElkKCkpO1xuICAgIGNvbnN0IGluc3RhbnRpYXRlZCA9IHRlbXBsYXRlLmluc3RhbnRpYXRlKHt9KTtcbiAgICByZXR1cm4ge1xuICAgICAgbm9kZXM6XG4gICAgICAgIGluc3RhbnRpYXRlZC5sYXlvdXQ/Lm5vZGVzPy5tYXAoKG5vZGUpID0+IHtcbiAgICAgICAgICAvLyBDb252ZXJ0IHNlcmlhbGl6ZWQgbm9kZXMgYmFjayB0byBWaXN1YWxRdWVyeU5vZGUgaW5zdGFuY2VzXG4gICAgICAgICAgcmV0dXJuIG5ldyBWaXN1YWxRdWVyeU5vZGUoe1xuICAgICAgICAgICAgaWQ6IG5vZGUuaWQsXG4gICAgICAgICAgICB0eXBlOiBub2RlLnR5cGUgYXMgTm9kZVR5cGUsXG4gICAgICAgICAgICBsYWJlbDogbm9kZS5sYWJlbCxcbiAgICAgICAgICAgIHBvc2l0aW9uOiBub2RlLnBvc2l0aW9uLFxuICAgICAgICAgICAgdmFyaWFibGVOYW1lOiBub2RlLnZhcmlhYmxlTmFtZSxcbiAgICAgICAgICAgIHVyaTogbm9kZS51cmksXG4gICAgICAgICAgICBkaW1lbnNpb25zOiBub2RlLmRpbWVuc2lvbnMsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pIHx8IFtdLFxuICAgICAgZWRnZXM6XG4gICAgICAgIGluc3RhbnRpYXRlZC5sYXlvdXQ/LmVkZ2VzPy5tYXAoKGVkZ2UpID0+IHtcbiAgICAgICAgICAvLyBDb252ZXJ0IHNlcmlhbGl6ZWQgZWRnZXMgYmFjayB0byBWaXN1YWxRdWVyeUVkZ2UgaW5zdGFuY2VzXG4gICAgICAgICAgcmV0dXJuIG5ldyBWaXN1YWxRdWVyeUVkZ2Uoe1xuICAgICAgICAgICAgaWQ6IGVkZ2UuaWQsXG4gICAgICAgICAgICBzb3VyY2VOb2RlSWQ6IGVkZ2Uuc291cmNlTm9kZUlkLFxuICAgICAgICAgICAgdGFyZ2V0Tm9kZUlkOiBlZGdlLnRhcmdldE5vZGVJZCxcbiAgICAgICAgICAgIHR5cGU6IGVkZ2UudHlwZSBhcyBFZGdlVHlwZSxcbiAgICAgICAgICAgIGxhYmVsOiBlZGdlLmxhYmVsLFxuICAgICAgICAgICAgcHJvcGVydHlVcmk6IGVkZ2UucHJvcGVydHlVcmksXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pIHx8IFtdLFxuICAgIH07XG4gIH1cblxuICBhc3luYyBleHBvcnRUZW1wbGF0ZXModGVtcGxhdGVJZHM/OiBzdHJpbmdbXSk6IFByb21pc2U8c3RyaW5nPiB7XG4gICAgY29uc3QgdGVtcGxhdGVzID1cbiAgICAgIGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LmV4cG9ydFRlbXBsYXRlcyh0ZW1wbGF0ZUlkcyk7XG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHRlbXBsYXRlcywgbnVsbCwgMik7XG4gIH1cblxuICBhc3luYyBpbXBvcnRUZW1wbGF0ZXMoanNvbkRhdGE6IHN0cmluZyk6IFByb21pc2U8UXVlcnlUZW1wbGF0ZVtdPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHRlbXBsYXRlc0RhdGEgPSBKU09OLnBhcnNlKGpzb25EYXRhKTtcblxuICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHRlbXBsYXRlc0RhdGEpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIkludmFsaWQgSlNPTiBmb3JtYXQ6IGV4cGVjdGVkIGFycmF5IG9mIHRlbXBsYXRlc1wiKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LmltcG9ydFRlbXBsYXRlcyh0ZW1wbGF0ZXNEYXRhKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gaW1wb3J0IHRlbXBsYXRlczogJHtlcnJvci5tZXNzYWdlfWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldFVzYWdlU3RhdGlzdGljcyh0ZW1wbGF0ZUlkOiBzdHJpbmcpOiBQcm9taXNlPHtcbiAgICB1c2FnZUNvdW50OiBudW1iZXI7XG4gICAgbGFzdFVzZWQ/OiBEYXRlO1xuICAgIGF2ZXJhZ2VQYXJhbWV0ZXJzRmlsbGVkPzogbnVtYmVyO1xuICB9PiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LmdldFVzYWdlU3RhdHModGVtcGxhdGVJZCk7XG4gIH1cblxuICBhc3luYyB1cGRhdGVUZW1wbGF0ZU1ldGFkYXRhKFxuICAgIHRlbXBsYXRlSWQ6IHN0cmluZyxcbiAgICB1cGRhdGVzOiBQYXJ0aWFsPHtcbiAgICAgIG5hbWU6IHN0cmluZztcbiAgICAgIGRlc2NyaXB0aW9uOiBzdHJpbmc7XG4gICAgICBjYXRlZ29yeTogVGVtcGxhdGVDYXRlZ29yeTtcbiAgICAgIHRhZ3M6IHN0cmluZ1tdO1xuICAgICAgZGlmZmljdWx0eTogVGVtcGxhdGVEaWZmaWN1bHR5O1xuICAgIH0+LFxuICApOiBQcm9taXNlPFF1ZXJ5VGVtcGxhdGU+IHtcbiAgICBjb25zdCB0ZW1wbGF0ZSA9IGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LmZpbmRCeUlkKHRlbXBsYXRlSWQpO1xuICAgIGlmICghdGVtcGxhdGUpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGVtcGxhdGUgd2l0aCBJRCAke3RlbXBsYXRlSWR9IG5vdCBmb3VuZGApO1xuICAgIH1cblxuICAgIGlmICh0ZW1wbGF0ZS5pc0J1aWx0SW5UZW1wbGF0ZSgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgbW9kaWZ5IGJ1aWx0LWluIHRlbXBsYXRlc1wiKTtcbiAgICB9XG5cbiAgICBjb25zdCB1cGRhdGVkVGVtcGxhdGUgPSB0ZW1wbGF0ZS51cGRhdGVNZXRhZGF0YSh1cGRhdGVzKTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy50ZW1wbGF0ZVJlcG9zaXRvcnkudXBkYXRlKHVwZGF0ZWRUZW1wbGF0ZSk7XG4gIH1cblxuICBhc3luYyB2YWxpZGF0ZVRlbXBsYXRlUGFyYW1ldGVycyh0ZW1wbGF0ZTogUXVlcnlUZW1wbGF0ZSk6IFByb21pc2U8e1xuICAgIGlzVmFsaWQ6IGJvb2xlYW47XG4gICAgZXJyb3JzOiBzdHJpbmdbXTtcbiAgICBtaXNzaW5nUGFyYW1ldGVyczogc3RyaW5nW107XG4gICAgaW52YWxpZFBhcmFtZXRlcnM6IHN0cmluZ1tdO1xuICB9PiB7XG4gICAgY29uc3QgdmFsaWRhdGlvbiA9IHRlbXBsYXRlLnZhbGlkYXRlUGFyYW1ldGVycygpO1xuICAgIGNvbnN0IHBhcmFtZXRlcnMgPSB0ZW1wbGF0ZS5nZXRQYXJhbWV0ZXJzKCk7XG4gICAgY29uc3QgcGFyYW1ldGVyVmFsdWVzID0gdGVtcGxhdGUuZ2V0UGFyYW1ldGVyVmFsdWVzKCk7XG5cbiAgICBjb25zdCBtaXNzaW5nUGFyYW1ldGVyczogc3RyaW5nW10gPSBbXTtcbiAgICBjb25zdCBpbnZhbGlkUGFyYW1ldGVyczogc3RyaW5nW10gPSBbXTtcblxuICAgIHBhcmFtZXRlcnMuZm9yRWFjaCgocGFyYW0pID0+IHtcbiAgICAgIGNvbnN0IHBhcmFtSWQgPSBwYXJhbS5pZCB8fCBgcGFyYW1fJHtwYXJhbS5uYW1lfWA7XG4gICAgICBpZiAocGFyYW0ucmVxdWlyZWQgJiYgIXBhcmFtZXRlclZhbHVlcy5oYXMocGFyYW1JZCkpIHtcbiAgICAgICAgbWlzc2luZ1BhcmFtZXRlcnMucHVzaChwYXJhbS5uYW1lKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgdmFsdWUgPSBwYXJhbWV0ZXJWYWx1ZXMuZ2V0KHBhcmFtSWQpO1xuICAgICAgaWYgKHZhbHVlICYmIHBhcmFtLmNvbnN0cmFpbnRzKSB7XG4gICAgICAgIC8vIEFkZGl0aW9uYWwgdmFsaWRhdGlvbiBjb3VsZCBiZSBhZGRlZCBoZXJlXG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgaXNWYWxpZDogdmFsaWRhdGlvbi5pc1ZhbGlkLFxuICAgICAgZXJyb3JzOiB2YWxpZGF0aW9uLmVycm9ycyxcbiAgICAgIG1pc3NpbmdQYXJhbWV0ZXJzLFxuICAgICAgaW52YWxpZFBhcmFtZXRlcnMsXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIGdldFRlbXBsYXRlUHJldmlldyh0ZW1wbGF0ZUlkOiBzdHJpbmcpOiBQcm9taXNlPHtcbiAgICBzcGFycWxRdWVyeTogc3RyaW5nO1xuICAgIG5vZGVDb3VudDogbnVtYmVyO1xuICAgIGVkZ2VDb3VudDogbnVtYmVyO1xuICAgIHBhcmFtZXRlckNvdW50OiBudW1iZXI7XG4gICAgY29tcGxleGl0eTogXCJzaW1wbGVcIiB8IFwibW9kZXJhdGVcIiB8IFwiY29tcGxleFwiO1xuICB9PiB7XG4gICAgY29uc3QgdGVtcGxhdGUgPSBhd2FpdCB0aGlzLnRlbXBsYXRlUmVwb3NpdG9yeS5maW5kQnlJZCh0ZW1wbGF0ZUlkKTtcbiAgICBpZiAoIXRlbXBsYXRlKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFRlbXBsYXRlIHdpdGggSUQgJHt0ZW1wbGF0ZUlkfSBub3QgZm91bmRgKTtcbiAgICB9XG5cbiAgICBjb25zdCBsYXlvdXQgPSB0ZW1wbGF0ZS5nZXRMYXlvdXQoKTtcbiAgICBjb25zdCBwYXJhbWV0ZXJzID0gdGVtcGxhdGUuZ2V0UGFyYW1ldGVycygpO1xuICAgIGNvbnN0IG5vZGVDb3VudCA9IGxheW91dC5ub2Rlcy5sZW5ndGg7XG4gICAgY29uc3QgZWRnZUNvdW50ID0gbGF5b3V0LmVkZ2VzLmxlbmd0aDtcblxuICAgIC8vIERldGVybWluZSBjb21wbGV4aXR5IGJhc2VkIG9uIHZhcmlvdXMgZmFjdG9yc1xuICAgIGxldCBjb21wbGV4aXR5OiBcInNpbXBsZVwiIHwgXCJtb2RlcmF0ZVwiIHwgXCJjb21wbGV4XCIgPSBcInNpbXBsZVwiO1xuICAgIGNvbnN0IHRvdGFsRWxlbWVudHMgPSBub2RlQ291bnQgKyBlZGdlQ291bnQgKyBwYXJhbWV0ZXJzLmxlbmd0aDtcblxuICAgIGlmICh0b3RhbEVsZW1lbnRzIDw9IDUpIHtcbiAgICAgIGNvbXBsZXhpdHkgPSBcInNpbXBsZVwiO1xuICAgIH0gZWxzZSBpZiAodG90YWxFbGVtZW50cyA8PSAxMCkge1xuICAgICAgY29tcGxleGl0eSA9IFwibW9kZXJhdGVcIjtcbiAgICB9IGVsc2Uge1xuICAgICAgY29tcGxleGl0eSA9IFwiY29tcGxleFwiO1xuICAgIH1cblxuICAgIC8vIEdlbmVyYXRlIGV4YW1wbGUgU1BBUlFMIGlmIHBhdHRlcm4gaXMgYXZhaWxhYmxlXG4gICAgbGV0IHNwYXJxbFF1ZXJ5ID0gdGVtcGxhdGUuZ2V0TWV0YWRhdGEoKS5zcGFycWxQYXR0ZXJuIHx8IFwiXCI7XG5cbiAgICAvLyBSZXBsYWNlIHBhcmFtZXRlciBwbGFjZWhvbGRlcnMgd2l0aCBleGFtcGxlIHZhbHVlc1xuICAgIHBhcmFtZXRlcnMuZm9yRWFjaCgocGFyYW0pID0+IHtcbiAgICAgIGNvbnN0IHBhcmFtSWQgPSBwYXJhbS5pZCB8fCBgcGFyYW1fJHtwYXJhbS5uYW1lfWA7XG4gICAgICBjb25zdCBwbGFjZWhvbGRlciA9IGB7JHtwYXJhbUlkLnRvVXBwZXJDYXNlKCl9fWA7XG4gICAgICBjb25zdCBleGFtcGxlVmFsdWUgPSBwYXJhbS5kZWZhdWx0VmFsdWUgfHwgYHske3BhcmFtLm5hbWV9fWA7XG4gICAgICBzcGFycWxRdWVyeSA9IHNwYXJxbFF1ZXJ5LnJlcGxhY2UoXG4gICAgICAgIG5ldyBSZWdFeHAocGxhY2Vob2xkZXIsIFwiZ1wiKSxcbiAgICAgICAgZXhhbXBsZVZhbHVlLFxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIHJldHVybiB7XG4gICAgICBzcGFycWxRdWVyeSxcbiAgICAgIG5vZGVDb3VudCxcbiAgICAgIGVkZ2VDb3VudCxcbiAgICAgIHBhcmFtZXRlckNvdW50OiBwYXJhbWV0ZXJzLmxlbmd0aCxcbiAgICAgIGNvbXBsZXhpdHksXG4gICAgfTtcbiAgfVxuXG4gIGFzeW5jIHJlZnJlc2hUZW1wbGF0ZUNhY2hlKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHRoaXMudGVtcGxhdGVSZXBvc2l0b3J5LnJlZnJlc2goKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9