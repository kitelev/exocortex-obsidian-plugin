445ea0be2de7a805eef9294e20cc7af9
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ExecuteQueryBlockUseCase = void 0;
const Result_1 = require("../../domain/core/Result");
class ExecuteQueryBlockUseCase {
    constructor(app) {
        this.app = app;
    }
    async execute(request) {
        const startTime = Date.now();
        try {
            // Get all files
            let files = this.app.vault.getFiles();
            // Filter by class if specified
            if (request.blockConfig.className) {
                files = this.filterByClass(files, request.blockConfig.className);
            }
            // Apply property filters
            if (request.blockConfig.propertyFilters &&
                request.blockConfig.propertyFilters.length > 0) {
                files = this.applyPropertyFilters(files, request.blockConfig.propertyFilters, request.currentAssetPath, request.currentAssetFrontmatter);
            }
            // Apply relation filter if specified
            if (request.blockConfig.relationProperty) {
                files = this.filterByRelation(files, request.blockConfig.relationProperty, request.currentAssetPath);
            }
            const totalCount = files.length;
            // Sort results
            if (request.blockConfig.sortBy) {
                files = this.sortFiles(files, request.blockConfig.sortBy, request.blockConfig.sortOrder || "asc");
            }
            // Limit results
            if (request.blockConfig.maxResults &&
                request.blockConfig.maxResults > 0) {
                files = files.slice(0, request.blockConfig.maxResults);
            }
            const executionTime = Date.now() - startTime;
            return Result_1.Result.ok({
                results: files,
                totalCount,
                executionTime,
            });
        }
        catch (error) {
            return Result_1.Result.fail(`Failed to execute query block: ${error}`);
        }
    }
    filterByClass(files, className) {
        const cleanClassName = this.cleanClassName(className);
        return files.filter((file) => {
            const metadata = this.app.metadataCache.getFileCache(file);
            if (!metadata?.frontmatter)
                return false;
            const instanceClass = metadata.frontmatter["exo__Instance_class"];
            const fileClassName = this.cleanClassName(instanceClass);
            return fileClassName === cleanClassName;
        });
    }
    applyPropertyFilters(files, filters, currentAssetPath, currentAssetFrontmatter) {
        return files.filter((file) => {
            const metadata = this.app.metadataCache.getFileCache(file);
            if (!metadata?.frontmatter)
                return false;
            // Check all filters
            for (const filter of filters) {
                if (!this.evaluateFilter(metadata.frontmatter, filter, currentAssetPath, currentAssetFrontmatter, file)) {
                    return false;
                }
            }
            return true;
        });
    }
    evaluateFilter(frontmatter, filter, currentAssetPath, currentAssetFrontmatter, file) {
        const propertyValue = frontmatter[filter.property];
        let filterValue = filter.value;
        // Replace template variables
        if (typeof filterValue === "string") {
            filterValue = filterValue
                .replace("{{current_asset}}", `[[${currentAssetPath}]]`)
                .replace("{{current_file}}", `[[${currentAssetPath}]]`);
            // Replace frontmatter variables
            const varMatch = filterValue.match(/\{\{fm\.(.+?)\}\}/g);
            if (varMatch) {
                varMatch.forEach((match) => {
                    const prop = match.replace(/\{\{fm\.|}\}/g, "");
                    const value = currentAssetFrontmatter[prop];
                    if (value) {
                        filterValue = filterValue.replace(match, value);
                    }
                });
            }
        }
        // Clean values for comparison
        const cleanPropValue = this.cleanValue(propertyValue);
        const cleanFilterValue = this.cleanValue(filterValue);
        switch (filter.operator) {
            case "equals":
                return this.valuesEqual(cleanPropValue, cleanFilterValue);
            case "notEquals":
                return !this.valuesEqual(cleanPropValue, cleanFilterValue);
            case "contains":
                return this.valueContains(cleanPropValue, cleanFilterValue);
            case "startsWith":
                return this.valueStartsWith(cleanPropValue, cleanFilterValue);
            case "endsWith":
                return this.valueEndsWith(cleanPropValue, cleanFilterValue);
            case "exists":
                return propertyValue !== undefined && propertyValue !== null;
            case "notExists":
                return propertyValue === undefined || propertyValue === null;
            default:
                return false;
        }
    }
    valuesEqual(value1, value2) {
        // Handle arrays
        if (Array.isArray(value1)) {
            return value1.some((v) => this.valuesEqual(v, value2));
        }
        // Handle wikilinks
        const clean1 = this.cleanClassName(value1);
        const clean2 = this.cleanClassName(value2);
        return clean1 === clean2;
    }
    valueContains(value, searchValue) {
        if (Array.isArray(value)) {
            return value.some((v) => this.valueContains(v, searchValue));
        }
        const str = this.cleanClassName(value).toLowerCase();
        const search = this.cleanClassName(searchValue).toLowerCase();
        return str.includes(search);
    }
    valueStartsWith(value, searchValue) {
        if (Array.isArray(value)) {
            return value.some((v) => this.valueStartsWith(v, searchValue));
        }
        const str = this.cleanClassName(value).toLowerCase();
        const search = this.cleanClassName(searchValue).toLowerCase();
        return str.startsWith(search);
    }
    valueEndsWith(value, searchValue) {
        if (Array.isArray(value)) {
            return value.some((v) => this.valueEndsWith(v, searchValue));
        }
        const str = this.cleanClassName(value).toLowerCase();
        const search = this.cleanClassName(searchValue).toLowerCase();
        return str.endsWith(search);
    }
    filterByRelation(files, relationProperty, currentAssetPath) {
        const currentLink = `[[${currentAssetPath}]]`;
        return files.filter((file) => {
            const metadata = this.app.metadataCache.getFileCache(file);
            if (!metadata?.frontmatter)
                return false;
            const relationValue = metadata.frontmatter[relationProperty];
            if (!relationValue)
                return false;
            if (Array.isArray(relationValue)) {
                return relationValue.some((v) => this.cleanClassName(v) === this.cleanClassName(currentLink));
            }
            return (this.cleanClassName(relationValue) === this.cleanClassName(currentLink));
        });
    }
    sortFiles(files, sortBy, order) {
        return files.sort((a, b) => {
            const aMetadata = this.app.metadataCache.getFileCache(a);
            const bMetadata = this.app.metadataCache.getFileCache(b);
            const aValue = aMetadata?.frontmatter?.[sortBy] || "";
            const bValue = bMetadata?.frontmatter?.[sortBy] || "";
            let comparison = 0;
            if (aValue < bValue)
                comparison = -1;
            if (aValue > bValue)
                comparison = 1;
            return order === "asc" ? comparison : -comparison;
        });
    }
    cleanClassName(value) {
        if (!value)
            return "";
        const str = Array.isArray(value) ? value[0] : value;
        return (str
            ?.toString()
            .replace(/\[\[|\]\]/g, "")
            .trim() || "");
    }
    cleanValue(value) {
        if (Array.isArray(value)) {
            return value.map((v) => this.cleanValue(v));
        }
        if (typeof value === "string") {
            return value.replace(/\[\[|\]\]/g, "").trim();
        }
        return value;
    }
}
exports.ExecuteQueryBlockUseCase = ExecuteQueryBlockUseCase;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpdGVsZXYvRG9jdW1lbnRzL2V4b2NvcnRleC1vYnNpZGlhbi1wbHVnaW4vc3JjL2FwcGxpY2F0aW9uL3VzZS1jYXNlcy9FeGVjdXRlUXVlcnlCbG9ja1VzZUNhc2UudHMiLCJtYXBwaW5ncyI6Ijs7O0FBRUEscURBQWtEO0FBY2xELE1BQWEsd0JBQXdCO0lBQ25DLFlBQW9CLEdBQVE7UUFBUixRQUFHLEdBQUgsR0FBRyxDQUFLO0lBQUcsQ0FBQztJQUVoQyxLQUFLLENBQUMsT0FBTyxDQUNYLE9BQWlDO1FBRWpDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUU3QixJQUFJO1lBQ0YsZ0JBQWdCO1lBQ2hCLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBRXRDLCtCQUErQjtZQUMvQixJQUFJLE9BQU8sQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFO2dCQUNqQyxLQUFLLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsQ0FBQzthQUNsRTtZQUVELHlCQUF5QjtZQUN6QixJQUNFLE9BQU8sQ0FBQyxXQUFXLENBQUMsZUFBZTtnQkFDbkMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUMsTUFBTSxHQUFHLENBQUMsRUFDOUM7Z0JBQ0EsS0FBSyxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FDL0IsS0FBSyxFQUNMLE9BQU8sQ0FBQyxXQUFXLENBQUMsZUFBZSxFQUNuQyxPQUFPLENBQUMsZ0JBQWdCLEVBQ3hCLE9BQU8sQ0FBQyx1QkFBdUIsQ0FDaEMsQ0FBQzthQUNIO1lBRUQscUNBQXFDO1lBQ3JDLElBQUksT0FBTyxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsRUFBRTtnQkFDeEMsS0FBSyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FDM0IsS0FBSyxFQUNMLE9BQU8sQ0FBQyxXQUFXLENBQUMsZ0JBQWdCLEVBQ3BD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QUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDN0M7UUFFRCxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRTtZQUM3QixPQUFPLEtBQUssQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1NBQy9DO1FBRUQsT0FBTyxLQUFLLENBQUM7SUFDZixDQUFDO0NBQ0Y7QUFsU0QsNERBa1NDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9raXRlbGV2L0RvY3VtZW50cy9leG9jb3J0ZXgtb2JzaWRpYW4tcGx1Z2luL3NyYy9hcHBsaWNhdGlvbi91c2UtY2FzZXMvRXhlY3V0ZVF1ZXJ5QmxvY2tVc2VDYXNlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFwcCwgVEZpbGUgfSBmcm9tIFwib2JzaWRpYW5cIjtcbmltcG9ydCB7IFF1ZXJ5QmxvY2tDb25maWcgfSBmcm9tIFwiLi4vLi4vZG9tYWluL2VudGl0aWVzL0xheW91dEJsb2NrU3R1YnNcIjtcbmltcG9ydCB7IFJlc3VsdCB9IGZyb20gXCIuLi8uLi9kb21haW4vY29yZS9SZXN1bHRcIjtcblxuZXhwb3J0IGludGVyZmFjZSBFeGVjdXRlUXVlcnlCbG9ja1JlcXVlc3Qge1xuICBibG9ja0NvbmZpZzogUXVlcnlCbG9ja0NvbmZpZztcbiAgY3VycmVudEFzc2V0UGF0aDogc3RyaW5nO1xuICBjdXJyZW50QXNzZXRGcm9udG1hdHRlcjogYW55O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEV4ZWN1dGVRdWVyeUJsb2NrUmVzcG9uc2Uge1xuICByZXN1bHRzOiBURmlsZVtdO1xuICB0b3RhbENvdW50OiBudW1iZXI7XG4gIGV4ZWN1dGlvblRpbWU6IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIEV4ZWN1dGVRdWVyeUJsb2NrVXNlQ2FzZSB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgYXBwOiBBcHApIHt9XG5cbiAgYXN5bmMgZXhlY3V0ZShcbiAgICByZXF1ZXN0OiBFeGVjdXRlUXVlcnlCbG9ja1JlcXVlc3QsXG4gICk6IFByb21pc2U8UmVzdWx0PEV4ZWN1dGVRdWVyeUJsb2NrUmVzcG9uc2U+PiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcblxuICAgIHRyeSB7XG4gICAgICAvLyBHZXQgYWxsIGZpbGVzXG4gICAgICBsZXQgZmlsZXMgPSB0aGlzLmFwcC52YXVsdC5nZXRGaWxlcygpO1xuXG4gICAgICAvLyBGaWx0ZXIgYnkgY2xhc3MgaWYgc3BlY2lmaWVkXG4gICAgICBpZiAocmVxdWVzdC5ibG9ja0NvbmZpZy5jbGFzc05hbWUpIHtcbiAgICAgICAgZmlsZXMgPSB0aGlzLmZpbHRlckJ5Q2xhc3MoZmlsZXMsIHJlcXVlc3QuYmxvY2tDb25maWcuY2xhc3NOYW1lKTtcbiAgICAgIH1cblxuICAgICAgLy8gQXBwbHkgcHJvcGVydHkgZmlsdGVyc1xuICAgICAgaWYgKFxuICAgICAgICByZXF1ZXN0LmJsb2NrQ29uZmlnLnByb3BlcnR5RmlsdGVycyAmJlxuICAgICAgICByZXF1ZXN0LmJsb2NrQ29uZmlnLnByb3BlcnR5RmlsdGVycy5sZW5ndGggPiAwXG4gICAgICApIHtcbiAgICAgICAgZmlsZXMgPSB0aGlzLmFwcGx5UHJvcGVydHlGaWx0ZXJzKFxuICAgICAgICAgIGZpbGVzLFxuICAgICAgICAgIHJlcXVlc3QuYmxvY2tDb25maWcucHJvcGVydHlGaWx0ZXJzLFxuICAgICAgICAgIHJlcXVlc3QuY3VycmVudEFzc2V0UGF0aCxcbiAgICAgICAgICByZXF1ZXN0LmN1cnJlbnRBc3NldEZyb250bWF0dGVyLFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICAvLyBBcHBseSByZWxhdGlvbiBmaWx0ZXIgaWYgc3BlY2lmaWVkXG4gICAgICBpZiAocmVxdWVzdC5ibG9ja0NvbmZpZy5yZWxhdGlvblByb3BlcnR5KSB7XG4gICAgICAgIGZpbGVzID0gdGhpcy5maWx0ZXJCeVJlbGF0aW9uKFxuICAgICAgICAgIGZpbGVzLFxuICAgICAgICAgIHJlcXVlc3QuYmxvY2tDb25maWcucmVsYXRpb25Qcm9wZXJ0eSxcbiAgICAgICAgICByZXF1ZXN0LmN1cnJlbnRBc3NldFBhdGgsXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHRvdGFsQ291bnQgPSBmaWxlcy5sZW5ndGg7XG5cbiAgICAgIC8vIFNvcnQgcmVzdWx0c1xuICAgICAgaWYgKHJlcXVlc3QuYmxvY2tDb25maWcuc29ydEJ5KSB7XG4gICAgICAgIGZpbGVzID0gdGhpcy5zb3J0RmlsZXMoXG4gICAgICAgICAgZmlsZXMsXG4gICAgICAgICAgcmVxdWVzdC5ibG9ja0NvbmZpZy5zb3J0QnksXG4gICAgICAgICAgcmVxdWVzdC5ibG9ja0NvbmZpZy5zb3J0T3JkZXIgfHwgXCJhc2NcIixcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgLy8gTGltaXQgcmVzdWx0c1xuICAgICAgaWYgKFxuICAgICAgICByZXF1ZXN0LmJsb2NrQ29uZmlnLm1heFJlc3VsdHMgJiZcbiAgICAgICAgcmVxdWVzdC5ibG9ja0NvbmZpZy5tYXhSZXN1bHRzID4gMFxuICAgICAgKSB7XG4gICAgICAgIGZpbGVzID0gZmlsZXMuc2xpY2UoMCwgcmVxdWVzdC5ibG9ja0NvbmZpZy5tYXhSZXN1bHRzKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZXhlY3V0aW9uVGltZSA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG5cbiAgICAgIHJldHVybiBSZXN1bHQub2s8RXhlY3V0ZVF1ZXJ5QmxvY2tSZXNwb25zZT4oe1xuICAgICAgICByZXN1bHRzOiBmaWxlcyxcbiAgICAgICAgdG90YWxDb3VudCxcbiAgICAgICAgZXhlY3V0aW9uVGltZSxcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4gUmVzdWx0LmZhaWw8RXhlY3V0ZVF1ZXJ5QmxvY2tSZXNwb25zZT4oXG4gICAgICAgIGBGYWlsZWQgdG8gZXhlY3V0ZSBxdWVyeSBibG9jazogJHtlcnJvcn1gLFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGZpbHRlckJ5Q2xhc3MoZmlsZXM6IFRGaWxlW10sIGNsYXNzTmFtZTogc3RyaW5nKTogVEZpbGVbXSB7XG4gICAgY29uc3QgY2xlYW5DbGFzc05hbWUgPSB0aGlzLmNsZWFuQ2xhc3NOYW1lKGNsYXNzTmFtZSk7XG5cbiAgICByZXR1cm4gZmlsZXMuZmlsdGVyKChmaWxlKSA9PiB7XG4gICAgICBjb25zdCBtZXRhZGF0YSA9IHRoaXMuYXBwLm1ldGFkYXRhQ2FjaGUuZ2V0RmlsZUNhY2hlKGZpbGUpO1xuICAgICAgaWYgKCFtZXRhZGF0YT8uZnJvbnRtYXR0ZXIpIHJldHVybiBmYWxzZTtcblxuICAgICAgY29uc3QgaW5zdGFuY2VDbGFzcyA9IG1ldGFkYXRhLmZyb250bWF0dGVyW1wiZXhvX19JbnN0YW5jZV9jbGFzc1wiXTtcbiAgICAgIGNvbnN0IGZpbGVDbGFzc05hbWUgPSB0aGlzLmNsZWFuQ2xhc3NOYW1lKGluc3RhbmNlQ2xhc3MpO1xuXG4gICAgICByZXR1cm4gZmlsZUNsYXNzTmFtZSA9PT0gY2xlYW5DbGFzc05hbWU7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGFwcGx5UHJvcGVydHlGaWx0ZXJzKFxuICAgIGZpbGVzOiBURmlsZVtdLFxuICAgIGZpbHRlcnM6IGFueVtdLFxuICAgIGN1cnJlbnRBc3NldFBhdGg6IHN0cmluZyxcbiAgICBjdXJyZW50QXNzZXRGcm9udG1hdHRlcjogYW55LFxuICApOiBURmlsZVtdIHtcbiAgICByZXR1cm4gZmlsZXMuZmlsdGVyKChmaWxlKSA9PiB7XG4gICAgICBjb25zdCBtZXRhZGF0YSA9IHRoaXMuYXBwLm1ldGFkYXRhQ2FjaGUuZ2V0RmlsZUNhY2hlKGZpbGUpO1xuICAgICAgaWYgKCFtZXRhZGF0YT8uZnJvbnRtYXR0ZXIpIHJldHVybiBmYWxzZTtcblxuICAgICAgLy8gQ2hlY2sgYWxsIGZpbHRlcnNcbiAgICAgIGZvciAoY29uc3QgZmlsdGVyIG9mIGZpbHRlcnMpIHtcbiAgICAgICAgaWYgKFxuICAgICAgICAgICF0aGlzLmV2YWx1YXRlRmlsdGVyKFxuICAgICAgICAgICAgbWV0YWRhdGEuZnJvbnRtYXR0ZXIsXG4gICAgICAgICAgICBmaWx0ZXIsXG4gICAgICAgICAgICBjdXJyZW50QXNzZXRQYXRoLFxuICAgICAgICAgICAgY3VycmVudEFzc2V0RnJvbnRtYXR0ZXIsXG4gICAgICAgICAgICBmaWxlLFxuICAgICAgICAgIClcbiAgICAgICAgKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBldmFsdWF0ZUZpbHRlcihcbiAgICBmcm9udG1hdHRlcjogYW55LFxuICAgIGZpbHRlcjogYW55LFxuICAgIGN1cnJlbnRBc3NldFBhdGg6IHN0cmluZyxcbiAgICBjdXJyZW50QXNzZXRGcm9udG1hdHRlcjogYW55LFxuICAgIGZpbGU6IFRGaWxlLFxuICApOiBib29sZWFuIHtcbiAgICBjb25zdCBwcm9wZXJ0eVZhbHVlID0gZnJvbnRtYXR0ZXJbZmlsdGVyLnByb3BlcnR5XTtcbiAgICBsZXQgZmlsdGVyVmFsdWUgPSBmaWx0ZXIudmFsdWU7XG5cbiAgICAvLyBSZXBsYWNlIHRlbXBsYXRlIHZhcmlhYmxlc1xuICAgIGlmICh0eXBlb2YgZmlsdGVyVmFsdWUgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIGZpbHRlclZhbHVlID0gZmlsdGVyVmFsdWVcbiAgICAgICAgLnJlcGxhY2UoXCJ7e2N1cnJlbnRfYXNzZXR9fVwiLCBgW1ske2N1cnJlbnRBc3NldFBhdGh9XV1gKVxuICAgICAgICAucmVwbGFjZShcInt7Y3VycmVudF9maWxlfX1cIiwgYFtbJHtjdXJyZW50QXNzZXRQYXRofV1dYCk7XG5cbiAgICAgIC8vIFJlcGxhY2UgZnJvbnRtYXR0ZXIgdmFyaWFibGVzXG4gICAgICBjb25zdCB2YXJNYXRjaCA9IGZpbHRlclZhbHVlLm1hdGNoKC9cXHtcXHtmbVxcLiguKz8pXFx9XFx9L2cpO1xuICAgICAgaWYgKHZhck1hdGNoKSB7XG4gICAgICAgIHZhck1hdGNoLmZvckVhY2goKG1hdGNoOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICBjb25zdCBwcm9wID0gbWF0Y2gucmVwbGFjZSgvXFx7XFx7Zm1cXC58fVxcfS9nLCBcIlwiKTtcbiAgICAgICAgICBjb25zdCB2YWx1ZSA9IGN1cnJlbnRBc3NldEZyb250bWF0dGVyW3Byb3BdO1xuICAgICAgICAgIGlmICh2YWx1ZSkge1xuICAgICAgICAgICAgZmlsdGVyVmFsdWUgPSBmaWx0ZXJWYWx1ZS5yZXBsYWNlKG1hdGNoLCB2YWx1ZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBDbGVhbiB2YWx1ZXMgZm9yIGNvbXBhcmlzb25cbiAgICBjb25zdCBjbGVhblByb3BWYWx1ZSA9IHRoaXMuY2xlYW5WYWx1ZShwcm9wZXJ0eVZhbHVlKTtcbiAgICBjb25zdCBjbGVhbkZpbHRlclZhbHVlID0gdGhpcy5jbGVhblZhbHVlKGZpbHRlclZhbHVlKTtcblxuICAgIHN3aXRjaCAoZmlsdGVyLm9wZXJhdG9yKSB7XG4gICAgICBjYXNlIFwiZXF1YWxzXCI6XG4gICAgICAgIHJldHVybiB0aGlzLnZhbHVlc0VxdWFsKGNsZWFuUHJvcFZhbHVlLCBjbGVhbkZpbHRlclZhbHVlKTtcblxuICAgICAgY2FzZSBcIm5vdEVxdWFsc1wiOlxuICAgICAgICByZXR1cm4gIXRoaXMudmFsdWVzRXF1YWwoY2xlYW5Qcm9wVmFsdWUsIGNsZWFuRmlsdGVyVmFsdWUpO1xuXG4gICAgICBjYXNlIFwiY29udGFpbnNcIjpcbiAgICAgICAgcmV0dXJuIHRoaXMudmFsdWVDb250YWlucyhjbGVhblByb3BWYWx1ZSwgY2xlYW5GaWx0ZXJWYWx1ZSk7XG5cbiAgICAgIGNhc2UgXCJzdGFydHNXaXRoXCI6XG4gICAgICAgIHJldHVybiB0aGlzLnZhbHVlU3RhcnRzV2l0aChjbGVhblByb3BWYWx1ZSwgY2xlYW5GaWx0ZXJWYWx1ZSk7XG5cbiAgICAgIGNhc2UgXCJlbmRzV2l0aFwiOlxuICAgICAgICByZXR1cm4gdGhpcy52YWx1ZUVuZHNXaXRoKGNsZWFuUHJvcFZhbHVlLCBjbGVhbkZpbHRlclZhbHVlKTtcblxuICAgICAgY2FzZSBcImV4aXN0c1wiOlxuICAgICAgICByZXR1cm4gcHJvcGVydHlWYWx1ZSAhPT0gdW5kZWZpbmVkICYmIHByb3BlcnR5VmFsdWUgIT09IG51bGw7XG5cbiAgICAgIGNhc2UgXCJub3RFeGlzdHNcIjpcbiAgICAgICAgcmV0dXJuIHByb3BlcnR5VmFsdWUgPT09IHVuZGVmaW5lZCB8fCBwcm9wZXJ0eVZhbHVlID09PSBudWxsO1xuXG4gICAgICBkZWZhdWx0OlxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB2YWx1ZXNFcXVhbCh2YWx1ZTE6IGFueSwgdmFsdWUyOiBhbnkpOiBib29sZWFuIHtcbiAgICAvLyBIYW5kbGUgYXJyYXlzXG4gICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUxKSkge1xuICAgICAgcmV0dXJuIHZhbHVlMS5zb21lKCh2KSA9PiB0aGlzLnZhbHVlc0VxdWFsKHYsIHZhbHVlMikpO1xuICAgIH1cblxuICAgIC8vIEhhbmRsZSB3aWtpbGlua3NcbiAgICBjb25zdCBjbGVhbjEgPSB0aGlzLmNsZWFuQ2xhc3NOYW1lKHZhbHVlMSk7XG4gICAgY29uc3QgY2xlYW4yID0gdGhpcy5jbGVhbkNsYXNzTmFtZSh2YWx1ZTIpO1xuXG4gICAgcmV0dXJuIGNsZWFuMSA9PT0gY2xlYW4yO1xuICB9XG5cbiAgcHJpdmF0ZSB2YWx1ZUNvbnRhaW5zKHZhbHVlOiBhbnksIHNlYXJjaFZhbHVlOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWx1ZSkpIHtcbiAgICAgIHJldHVybiB2YWx1ZS5zb21lKCh2KSA9PiB0aGlzLnZhbHVlQ29udGFpbnModiwgc2VhcmNoVmFsdWUpKTtcbiAgICB9XG5cbiAgICBjb25zdCBzdHIgPSB0aGlzLmNsZWFuQ2xhc3NOYW1lKHZhbHVlKS50b0xvd2VyQ2FzZSgpO1xuICAgIGNvbnN0IHNlYXJjaCA9IHRoaXMuY2xlYW5DbGFzc05hbWUoc2VhcmNoVmFsdWUpLnRvTG93ZXJDYXNlKCk7XG5cbiAgICByZXR1cm4gc3RyLmluY2x1ZGVzKHNlYXJjaCk7XG4gIH1cblxuICBwcml2YXRlIHZhbHVlU3RhcnRzV2l0aCh2YWx1ZTogYW55LCBzZWFyY2hWYWx1ZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICByZXR1cm4gdmFsdWUuc29tZSgodikgPT4gdGhpcy52YWx1ZVN0YXJ0c1dpdGgodiwgc2VhcmNoVmFsdWUpKTtcbiAgICB9XG5cbiAgICBjb25zdCBzdHIgPSB0aGlzLmNsZWFuQ2xhc3NOYW1lKHZhbHVlKS50b0xvd2VyQ2FzZSgpO1xuICAgIGNvbnN0IHNlYXJjaCA9IHRoaXMuY2xlYW5DbGFzc05hbWUoc2VhcmNoVmFsdWUpLnRvTG93ZXJDYXNlKCk7XG5cbiAgICByZXR1cm4gc3RyLnN0YXJ0c1dpdGgoc2VhcmNoKTtcbiAgfVxuXG4gIHByaXZhdGUgdmFsdWVFbmRzV2l0aCh2YWx1ZTogYW55LCBzZWFyY2hWYWx1ZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpKSB7XG4gICAgICByZXR1cm4gdmFsdWUuc29tZSgodikgPT4gdGhpcy52YWx1ZUVuZHNXaXRoKHYsIHNlYXJjaFZhbHVlKSk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RyID0gdGhpcy5jbGVhbkNsYXNzTmFtZSh2YWx1ZSkudG9Mb3dlckNhc2UoKTtcbiAgICBjb25zdCBzZWFyY2ggPSB0aGlzLmNsZWFuQ2xhc3NOYW1lKHNlYXJjaFZhbHVlKS50b0xvd2VyQ2FzZSgpO1xuXG4gICAgcmV0dXJuIHN0ci5lbmRzV2l0aChzZWFyY2gpO1xuICB9XG5cbiAgcHJpdmF0ZSBmaWx0ZXJCeVJlbGF0aW9uKFxuICAgIGZpbGVzOiBURmlsZVtdLFxuICAgIHJlbGF0aW9uUHJvcGVydHk6IHN0cmluZyxcbiAgICBjdXJyZW50QXNzZXRQYXRoOiBzdHJpbmcsXG4gICk6IFRGaWxlW10ge1xuICAgIGNvbnN0IGN1cnJlbnRMaW5rID0gYFtbJHtjdXJyZW50QXNzZXRQYXRofV1dYDtcblxuICAgIHJldHVybiBmaWxlcy5maWx0ZXIoKGZpbGUpID0+IHtcbiAgICAgIGNvbnN0IG1ldGFkYXRhID0gdGhpcy5hcHAubWV0YWRhdGFDYWNoZS5nZXRGaWxlQ2FjaGUoZmlsZSk7XG4gICAgICBpZiAoIW1ldGFkYXRhPy5mcm9udG1hdHRlcikgcmV0dXJuIGZhbHNlO1xuXG4gICAgICBjb25zdCByZWxhdGlvblZhbHVlID0gbWV0YWRhdGEuZnJvbnRtYXR0ZXJbcmVsYXRpb25Qcm9wZXJ0eV07XG4gICAgICBpZiAoIXJlbGF0aW9uVmFsdWUpIHJldHVybiBmYWxzZTtcblxuICAgICAgaWYgKEFycmF5LmlzQXJyYXkocmVsYXRpb25WYWx1ZSkpIHtcbiAgICAgICAgcmV0dXJuIHJlbGF0aW9uVmFsdWUuc29tZShcbiAgICAgICAgICAodikgPT4gdGhpcy5jbGVhbkNsYXNzTmFtZSh2KSA9PT0gdGhpcy5jbGVhbkNsYXNzTmFtZShjdXJyZW50TGluayksXG4gICAgICAgICk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiAoXG4gICAgICAgIHRoaXMuY2xlYW5DbGFzc05hbWUocmVsYXRpb25WYWx1ZSkgPT09IHRoaXMuY2xlYW5DbGFzc05hbWUoY3VycmVudExpbmspXG4gICAgICApO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzb3J0RmlsZXMoXG4gICAgZmlsZXM6IFRGaWxlW10sXG4gICAgc29ydEJ5OiBzdHJpbmcsXG4gICAgb3JkZXI6IFwiYXNjXCIgfCBcImRlc2NcIixcbiAgKTogVEZpbGVbXSB7XG4gICAgcmV0dXJuIGZpbGVzLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgIGNvbnN0IGFNZXRhZGF0YSA9IHRoaXMuYXBwLm1ldGFkYXRhQ2FjaGUuZ2V0RmlsZUNhY2hlKGEpO1xuICAgICAgY29uc3QgYk1ldGFkYXRhID0gdGhpcy5hcHAubWV0YWRhdGFDYWNoZS5nZXRGaWxlQ2FjaGUoYik7XG5cbiAgICAgIGNvbnN0IGFWYWx1ZSA9IGFNZXRhZGF0YT8uZnJvbnRtYXR0ZXI/Lltzb3J0QnldIHx8IFwiXCI7XG4gICAgICBjb25zdCBiVmFsdWUgPSBiTWV0YWRhdGE/LmZyb250bWF0dGVyPy5bc29ydEJ5XSB8fCBcIlwiO1xuXG4gICAgICBsZXQgY29tcGFyaXNvbiA9IDA7XG5cbiAgICAgIGlmIChhVmFsdWUgPCBiVmFsdWUpIGNvbXBhcmlzb24gPSAtMTtcbiAgICAgIGlmIChhVmFsdWUgPiBiVmFsdWUpIGNvbXBhcmlzb24gPSAxO1xuXG4gICAgICByZXR1cm4gb3JkZXIgPT09IFwiYXNjXCIgPyBjb21wYXJpc29uIDogLWNvbXBhcmlzb247XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGNsZWFuQ2xhc3NOYW1lKHZhbHVlOiBhbnkpOiBzdHJpbmcge1xuICAgIGlmICghdmFsdWUpIHJldHVybiBcIlwiO1xuICAgIGNvbnN0IHN0ciA9IEFycmF5LmlzQXJyYXkodmFsdWUpID8gdmFsdWVbMF0gOiB2YWx1ZTtcbiAgICByZXR1cm4gKFxuICAgICAgc3RyXG4gICAgICAgID8udG9TdHJpbmcoKVxuICAgICAgICAucmVwbGFjZSgvXFxbXFxbfFxcXVxcXS9nLCBcIlwiKVxuICAgICAgICAudHJpbSgpIHx8IFwiXCJcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBjbGVhblZhbHVlKHZhbHVlOiBhbnkpOiBhbnkge1xuICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgcmV0dXJuIHZhbHVlLm1hcCgodikgPT4gdGhpcy5jbGVhblZhbHVlKHYpKTtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIHZhbHVlID09PSBcInN0cmluZ1wiKSB7XG4gICAgICByZXR1cm4gdmFsdWUucmVwbGFjZSgvXFxbXFxbfFxcXVxcXS9nLCBcIlwiKS50cmltKCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHZhbHVlO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=