name: CI

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches:
      - main

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Upload built plugin
        uses: actions/upload-artifact@v4
        with:
          name: plugin-build
          path: |
            packages/obsidian-plugin/main.js
            packages/obsidian-plugin/manifest.json
          retention-days: 1

  typecheck:
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run check:types

  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 2

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint
        continue-on-error: true

  test-unit:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    container:
      image: mcr.microsoft.com/playwright:v1.56.1-jammy

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run unit and UI tests only (component tests have separate job)
        run: |
          export NODE_OPTIONS="--max-old-space-size=4096"
          npm run test:unit && npm run test:ui

      - name: Track Flaky Tests
        if: always()
        run: |
          # Check if flaky report was generated
          if [ -f "flaky-report.json" ]; then
            echo "üìä Flaky Test Report Generated"
            cat flaky-report.json

            # Check if any flaky tests were detected
            FLAKY_COUNT=$(cat flaky-report.json | grep -o '"totalFlaky":[0-9]*' | grep -o '[0-9]*' || echo "0")
            if [ "$FLAKY_COUNT" -gt 0 ]; then
              echo ""
              echo "‚ö†Ô∏è WARNING: $FLAKY_COUNT flaky test(s) detected!"
              echo "Flaky tests indicate race conditions or timing issues."
              echo "Please investigate and fix these tests."
            fi
          else
            echo "No flaky report generated (no retries occurred)"
          fi

      - name: Upload Flaky Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flaky-test-report-unit
          path: flaky-report.json
          retention-days: 30
          if-no-files-found: ignore

  test-coverage:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    container:
      image: mcr.microsoft.com/playwright:v1.56.1-jammy

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install jq for coverage parsing
        run: apt-get update && apt-get install -y jq

      - name: Run unit tests with coverage
        run: |
          export NODE_OPTIONS="--max-old-space-size=4096"
          export COVERAGE=true
          ./scripts/test-ci-batched.sh || exit 1

      - name: Check coverage thresholds (obsidian-plugin)
        run: |
          echo "=============================================="
          echo "Verifying obsidian-plugin coverage thresholds"
          echo "=============================================="

          # Check if coverage report exists
          COVERAGE_FILE="packages/obsidian-plugin/coverage/coverage-summary.json"
          if [ ! -f "$COVERAGE_FILE" ]; then
            echo "‚ùå Coverage report not found at $COVERAGE_FILE"
            echo "This means the test-ci-batched.sh script did not collect coverage."
            exit 1
          fi

          # Extract coverage percentages from JSON
          STATEMENTS=$(cat "$COVERAGE_FILE" | jq -r '.total.statements.pct')
          BRANCHES=$(cat "$COVERAGE_FILE" | jq -r '.total.branches.pct')
          FUNCTIONS=$(cat "$COVERAGE_FILE" | jq -r '.total.functions.pct')
          LINES=$(cat "$COVERAGE_FILE" | jq -r '.total.lines.pct')

          echo "üìä obsidian-plugin Coverage Report:"
          echo "  Statements: ${STATEMENTS}% (required: 75%)"
          echo "  Branches:   ${BRANCHES}% (required: 67%)"
          echo "  Functions:  ${FUNCTIONS}% (required: 70%)"
          echo "  Lines:      ${LINES}% (required: 75%)"

          # Check if coverage meets thresholds using awk for floating point comparison
          FAILED=0
          if [ $(echo "$STATEMENTS < 75" | awk '{print ($1 < $3) ? 1 : 0}') -eq 1 ]; then
            echo "‚ùå Statement coverage ${STATEMENTS}% is below 75% threshold"
            FAILED=1
          fi

          if [ $(echo "$BRANCHES < 67" | awk '{print ($1 < $3) ? 1 : 0}') -eq 1 ]; then
            echo "‚ùå Branch coverage ${BRANCHES}% is below 67% threshold"
            FAILED=1
          fi

          if [ $(echo "$FUNCTIONS < 70" | awk '{print ($1 < $3) ? 1 : 0}') -eq 1 ]; then
            echo "‚ùå Function coverage ${FUNCTIONS}% is below 70% threshold"
            FAILED=1
          fi

          if [ $(echo "$LINES < 75" | awk '{print ($1 < $3) ? 1 : 0}') -eq 1 ]; then
            echo "‚ùå Line coverage ${LINES}% is below 75% threshold"
            FAILED=1
          fi

          if [ $FAILED -eq 1 ]; then
            exit 1
          fi

          echo "‚úÖ obsidian-plugin coverage thresholds met!"

      - name: Check coverage thresholds (cli)
        run: |
          echo "=============================================="
          echo "Verifying CLI package coverage thresholds"
          echo "=============================================="

          # Check if CLI coverage report exists
          CLI_COVERAGE_FILE="packages/cli/coverage/coverage-summary.json"
          if [ ! -f "$CLI_COVERAGE_FILE" ]; then
            echo "‚ö†Ô∏è CLI coverage report not found at $CLI_COVERAGE_FILE"
            echo "CLI coverage collection may not be enabled."
            exit 0
          fi

          # Extract coverage percentages from JSON
          STATEMENTS=$(cat "$CLI_COVERAGE_FILE" | jq -r '.total.statements.pct')
          BRANCHES=$(cat "$CLI_COVERAGE_FILE" | jq -r '.total.branches.pct')
          FUNCTIONS=$(cat "$CLI_COVERAGE_FILE" | jq -r '.total.functions.pct')
          LINES=$(cat "$CLI_COVERAGE_FILE" | jq -r '.total.lines.pct')

          echo "üìä CLI Coverage Report:"
          echo "  Statements: ${STATEMENTS}% (required: 65%)"
          echo "  Branches:   ${BRANCHES}% (required: 60%)"
          echo "  Functions:  ${FUNCTIONS}% (required: 70%)"
          echo "  Lines:      ${LINES}% (required: 65%)"

          # Check if coverage meets thresholds
          FAILED=0
          if [ $(echo "$STATEMENTS < 65" | awk '{print ($1 < $3) ? 1 : 0}') -eq 1 ]; then
            echo "‚ùå CLI Statement coverage ${STATEMENTS}% is below 65% threshold"
            FAILED=1
          fi

          if [ $(echo "$BRANCHES < 60" | awk '{print ($1 < $3) ? 1 : 0}') -eq 1 ]; then
            echo "‚ùå CLI Branch coverage ${BRANCHES}% is below 60% threshold"
            FAILED=1
          fi

          if [ $(echo "$FUNCTIONS < 70" | awk '{print ($1 < $3) ? 1 : 0}') -eq 1 ]; then
            echo "‚ùå CLI Function coverage ${FUNCTIONS}% is below 70% threshold"
            FAILED=1
          fi

          if [ $(echo "$LINES < 65" | awk '{print ($1 < $3) ? 1 : 0}') -eq 1 ]; then
            echo "‚ùå CLI Line coverage ${LINES}% is below 65% threshold"
            FAILED=1
          fi

          if [ $FAILED -eq 1 ]; then
            exit 1
          fi

          echo "‚úÖ CLI coverage thresholds met!"
          echo "=============================================="
          echo "‚úÖ All package coverage thresholds passed!"
          echo "=============================================="

      - name: Generate coverage summary
        if: always()
        run: |
          COVERAGE_DIR="packages/obsidian-plugin/coverage"
          if [ -f "$COVERAGE_DIR/lcov.info" ]; then
            echo "## Code Coverage Report" > coverage-summary.md
            echo "" >> coverage-summary.md
            cat "$COVERAGE_DIR/lcov-report/index.html" | grep -A 5 "class='fraction'" | head -20 >> coverage-summary.md || true
            echo "" >> coverage-summary.md
            echo "Full report available in coverage artifacts" >> coverage-summary.md
          fi

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            packages/obsidian-plugin/coverage/
            coverage-summary.md
          retention-days: 30
          if-no-files-found: ignore

  test-bdd:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run BDD Tests
        run: npm run bdd:test
        continue-on-error: true

      - name: Check BDD Coverage
        run: npm run bdd:check
        continue-on-error: false

      - name: Generate BDD Coverage Report
        if: always()
        run: npm run bdd:report

      - name: Upload BDD Coverage Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bdd-coverage-report
          path: bdd-coverage-report.md
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload BDD Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bdd-test-report
          path: packages/obsidian-plugin/reports/
          retention-days: 30
          if-no-files-found: ignore

  test-component:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    container:
      image: mcr.microsoft.com/playwright:v1.56.1-jammy

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build packages
        run: npm run build

      - name: Run component tests (excluding visual)
        run: |
          export NODE_OPTIONS="--max-old-space-size=4096"
          # Run component tests excluding visual regression tests
          # Visual tests run separately with --update-snapshots for CI
          npx playwright test -c packages/obsidian-plugin/playwright-ct.config.ts --grep-invert visual

      - name: Run visual regression tests (update snapshots if missing)
        run: |
          export NODE_OPTIONS="--max-old-space-size=4096"
          # Check if Linux snapshots exist, if not generate them
          if ! ls packages/obsidian-plugin/tests/component/__snapshots__/**/*-linux.png 2>/dev/null | head -1; then
            echo "Linux snapshots not found, generating baseline snapshots..."
            npx playwright test -c packages/obsidian-plugin/playwright-ct.config.ts --grep visual --update-snapshots || true
          else
            echo "Running visual regression tests against existing snapshots..."
            npx playwright test -c packages/obsidian-plugin/playwright-ct.config.ts --grep visual
          fi
        continue-on-error: true

      - name: Upload component test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: component-test-report
          path: playwright-report-ct/
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload component test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: component-test-results
          path: test-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload visual diff artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: visual-diff
          path: |
            packages/obsidian-plugin/tests/component/__snapshots__/**/*-diff.png
            packages/obsidian-plugin/tests/component/__snapshots__/**/*-actual.png
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload Linux baseline snapshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linux-visual-snapshots
          path: packages/obsidian-plugin/tests/component/__snapshots__/**/*-linux.png
          retention-days: 30
          if-no-files-found: ignore

      - name: Track Flaky Tests (Component)
        if: always()
        run: |
          cd packages/obsidian-plugin
          # Check if flaky report was generated
          if [ -f "flaky-report-playwright.json" ]; then
            echo "üìä Playwright Flaky Test Report Generated"
            cat flaky-report-playwright.json

            # Check if any flaky tests were detected
            FLAKY_COUNT=$(cat flaky-report-playwright.json | grep -o '"totalFlaky":[0-9]*' | grep -o '[0-9]*' || echo "0")
            if [ "$FLAKY_COUNT" -gt 0 ]; then
              echo ""
              echo "‚ö†Ô∏è WARNING: $FLAKY_COUNT flaky component test(s) detected!"
              echo "Flaky tests indicate race conditions or timing issues."
              echo "Please investigate and fix these tests."
            fi
          else
            echo "No flaky report generated (no retries occurred)"
          fi

      - name: Upload Flaky Test Report (Component)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flaky-test-report-component
          path: packages/obsidian-plugin/flaky-report-playwright.json
          retention-days: 30
          if-no-files-found: ignore

  test-pyramid:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    needs: [test-unit, test-coverage]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Download coverage reports
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports
          path: packages/obsidian-plugin/coverage/
        continue-on-error: true

      - name: Run Test Pyramid Health Check
        run: npm run test:pyramid

      - name: Validate Test Pyramid (Strict)
        run: npm run test:pyramid:strict
        continue-on-error: false

      - name: Generate Pyramid Report
        if: always()
        run: |
          npm run test:pyramid -- --json > test-pyramid-report.json
          echo "## Test Pyramid Report" > test-pyramid-summary.md
          echo "" >> test-pyramid-summary.md
          echo "Generated: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> test-pyramid-summary.md
          echo "" >> test-pyramid-summary.md
          npm run test:pyramid >> test-pyramid-summary.md

      - name: Upload Pyramid Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-pyramid-report
          path: |
            test-pyramid-report.json
            test-pyramid-summary.md
          retention-days: 30
          if-no-files-found: ignore

  # E2E tests with sharding for faster execution
  # Target: 5 minutes (down from 15 minutes)
  # Note: Named e2e-shard-* to avoid conflict with branch protection rule for "e2e-tests"
  e2e-shard:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: build
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download built plugin
        uses: actions/download-artifact@v4
        with:
          name: plugin-build
          path: .

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build E2E Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: packages/obsidian-plugin/Dockerfile.e2e
          load: true
          tags: exocortex-e2e:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run E2E tests (shard ${{ matrix.shard }}/4)
        run: |
          mkdir -p test-results-e2e playwright-report-e2e blob-report
          docker run --init --rm \
            -v $PWD/test-results-e2e:/app/test-results \
            -v $PWD/playwright-report-e2e:/app/playwright-report-e2e \
            -v $PWD/blob-report:/app/packages/obsidian-plugin/blob-report \
            -e CI=true \
            exocortex-e2e npx playwright test -c packages/obsidian-plugin/playwright-e2e.config.ts --shard=${{ matrix.shard }}/4

      - name: Upload blob report for shard ${{ matrix.shard }}
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-blob-report-${{ matrix.shard }}
          path: blob-report/
          retention-days: 1
          if-no-files-found: ignore

      - name: Upload E2E test artifacts (videos, screenshots, traces) for shard ${{ matrix.shard }}
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-artifacts-${{ matrix.shard }}
          path: test-results-e2e/
          retention-days: 7
          if-no-files-found: ignore

  # Merge E2E test reports from all shards
  # Named "e2e-tests" to satisfy branch protection rule
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    needs: e2e-shard
    if: always()

    steps:
      - name: Check shard results
        run: |
          # Fail if any shard failed (needs.e2e-shard.result will be 'failure' or 'success')
          if [ "${{ needs.e2e-shard.result }}" != "success" ]; then
            echo "‚ùå One or more E2E shards failed"
            exit 1
          fi
          echo "‚úÖ All E2E shards passed"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install Playwright
        run: npm install -D @playwright/test

      - name: Download all blob reports
        uses: actions/download-artifact@v4
        with:
          pattern: e2e-blob-report-*
          path: all-blob-reports
          merge-multiple: true

      - name: Download all test artifacts (videos, screenshots, traces)
        if: always()
        uses: actions/download-artifact@v4
        with:
          pattern: e2e-test-artifacts-*
          path: all-test-artifacts
          merge-multiple: true

      - name: Merge E2E reports
        run: |
          npx playwright merge-reports --reporter html ./all-blob-reports
        continue-on-error: true

      - name: Upload merged E2E test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-report
          path: playwright-report/
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload merged test artifacts (videos, screenshots, traces)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-artifacts
          path: all-test-artifacts/
          retention-days: 7
          if-no-files-found: ignore

  performance-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    container:
      image: mcr.microsoft.com/playwright:v1.56.1-jammy

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run unit-level performance tests
        run: |
          export NODE_OPTIONS="--max-old-space-size=4096"
          npm run test:perf

      - name: Build packages (required for component tests)
        run: npm run build

      - name: Run component rendering performance tests
        run: |
          export NODE_OPTIONS="--max-old-space-size=4096"
          npm run test:perf:component
        continue-on-error: true

      - name: Generate Performance Report Summary
        if: always()
        run: |
          echo "## Performance Test Results" > performance-summary.md
          echo "" >> performance-summary.md
          echo "**Run Date:** $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> performance-summary.md
          echo "" >> performance-summary.md
          echo "### Test Categories" >> performance-summary.md
          echo "" >> performance-summary.md
          echo "| Category | Status |" >> performance-summary.md
          echo "|----------|--------|" >> performance-summary.md
          echo "| SPARQL Query Performance | ‚úÖ |" >> performance-summary.md
          echo "| Triple Store Performance | ‚úÖ |" >> performance-summary.md
          echo "| RDF Mapping Performance | ‚úÖ |" >> performance-summary.md
          echo "| Rendering Helpers Performance | ‚úÖ |" >> performance-summary.md
          echo "| Component Rendering Performance | ‚úÖ |" >> performance-summary.md
          echo "" >> performance-summary.md
          echo "### Benchmark Targets" >> performance-summary.md
          echo "" >> performance-summary.md
          echo "| Operation | Target | Max Acceptable |" >> performance-summary.md
          echo "|-----------|--------|----------------|" >> performance-summary.md
          echo "| Simple SELECT (10k triples) | 100ms | 200ms |" >> performance-summary.md
          echo "| Complex JOIN | 500ms | 1000ms |" >> performance-summary.md
          echo "| FILTER with REGEX | 300ms | 600ms |" >> performance-summary.md
          echo "| Table render (100 rows) | 2000ms | 4000ms |" >> performance-summary.md
          echo "| Component re-render | 500ms | 1000ms |" >> performance-summary.md

      - name: Upload Performance Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-test-report
          path: performance-summary.md
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload Component Performance Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: component-performance-report
          path: playwright-report-ct/
          retention-days: 30
          if-no-files-found: ignore
